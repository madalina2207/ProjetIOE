"use strict";(self.webpackChunkbabylon=self.webpackChunkbabylon||[]).push([[179],{263:()=>{function Fi(r){return"function"==typeof r}function wd(r){const t=r(i=>{Error.call(i),i.stack=(new Error).stack});return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}const A_=wd(r=>function(t){r(this),this.message=t?`${t.length} errors occurred during unsubscription:\n${t.map((i,s)=>`${s+1}) ${i.toString()}`).join("\n  ")}`:"",this.name="UnsubscriptionError",this.errors=t});function Od(r,e){if(r){const t=r.indexOf(e);0<=t&&r.splice(t,1)}}class eo{constructor(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let e;if(!this.closed){this.closed=!0;const{_parentage:t}=this;if(t)if(this._parentage=null,Array.isArray(t))for(const n of t)n.remove(this);else t.remove(this);const{initialTeardown:i}=this;if(Fi(i))try{i()}catch(n){e=n instanceof A_?n.errors:[n]}const{_finalizers:s}=this;if(s){this._finalizers=null;for(const n of s)try{fA(n)}catch(o){e=e??[],o instanceof A_?e=[...e,...o.errors]:e.push(o)}}if(e)throw new A_(e)}}add(e){var t;if(e&&e!==this)if(this.closed)fA(e);else{if(e instanceof eo){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=null!==(t=this._finalizers)&&void 0!==t?t:[]).push(e)}}_hasParent(e){const{_parentage:t}=this;return t===e||Array.isArray(t)&&t.includes(e)}_addParent(e){const{_parentage:t}=this;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e}_removeParent(e){const{_parentage:t}=this;t===e?this._parentage=null:Array.isArray(t)&&Od(t,e)}remove(e){const{_finalizers:t}=this;t&&Od(t,e),e instanceof eo&&e._removeParent(this)}}eo.EMPTY=(()=>{const r=new eo;return r.closed=!0,r})();const uA=eo.EMPTY;function dA(r){return r instanceof eo||r&&"closed"in r&&Fi(r.remove)&&Fi(r.add)&&Fi(r.unsubscribe)}function fA(r){Fi(r)?r():r.unsubscribe()}const Rc={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},R_={setTimeout(r,e,...t){const{delegate:i}=R_;return i?.setTimeout?i.setTimeout(r,e,...t):setTimeout(r,e,...t)},clearTimeout(r){const{delegate:e}=R_;return(e?.clearTimeout||clearTimeout)(r)},delegate:void 0};function pA(r){R_.setTimeout(()=>{const{onUnhandledError:e}=Rc;if(!e)throw r;e(r)})}function _A(){}const f5=Vb("C",void 0,void 0);function Vb(r,e,t){return{kind:r,value:e,error:t}}let Ic=null;function I_(r){if(Rc.useDeprecatedSynchronousErrorHandling){const e=!Ic;if(e&&(Ic={errorThrown:!1,error:null}),r(),e){const{errorThrown:t,error:i}=Ic;if(Ic=null,t)throw i}}else r()}class Ub extends eo{constructor(e){super(),this.isStopped=!1,e?(this.destination=e,dA(e)&&e.add(this)):this.destination=y5}static create(e,t,i){return new Nd(e,t,i)}next(e){this.isStopped?Gb(function _5(r){return Vb("N",r,void 0)}(e),this):this._next(e)}error(e){this.isStopped?Gb(function p5(r){return Vb("E",void 0,r)}(e),this):(this.isStopped=!0,this._error(e))}complete(){this.isStopped?Gb(f5,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(e){this.destination.next(e)}_error(e){try{this.destination.error(e)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}}const g5=Function.prototype.bind;function kb(r,e){return g5.call(r,e)}class v5{constructor(e){this.partialObserver=e}next(e){const{partialObserver:t}=this;if(t.next)try{t.next(e)}catch(i){M_(i)}}error(e){const{partialObserver:t}=this;if(t.error)try{t.error(e)}catch(i){M_(i)}else M_(e)}complete(){const{partialObserver:e}=this;if(e.complete)try{e.complete()}catch(t){M_(t)}}}class Nd extends Ub{constructor(e,t,i){let s;if(super(),Fi(e)||!e)s={next:e??void 0,error:t??void 0,complete:i??void 0};else{let n;this&&Rc.useDeprecatedNextContext?(n=Object.create(e),n.unsubscribe=()=>this.unsubscribe(),s={next:e.next&&kb(e.next,n),error:e.error&&kb(e.error,n),complete:e.complete&&kb(e.complete,n)}):s=e}this.destination=new v5(s)}}function M_(r){Rc.useDeprecatedSynchronousErrorHandling?function m5(r){Rc.useDeprecatedSynchronousErrorHandling&&Ic&&(Ic.errorThrown=!0,Ic.error=r)}(r):pA(r)}function Gb(r,e){const{onStoppedNotification:t}=Rc;t&&R_.setTimeout(()=>t(r,e))}const y5={closed:!0,next:_A,error:function b5(r){throw r},complete:_A},zb="function"==typeof Symbol&&Symbol.observable||"@@observable";function Mc(r){return r}function mA(r){return 0===r.length?Mc:1===r.length?r[0]:function(t){return r.reduce((i,s)=>s(i),t)}}let Rs=(()=>{class r{constructor(t){t&&(this._subscribe=t)}lift(t){const i=new r;return i.source=this,i.operator=t,i}subscribe(t,i,s){const n=function S5(r){return r&&r instanceof Ub||function T5(r){return r&&Fi(r.next)&&Fi(r.error)&&Fi(r.complete)}(r)&&dA(r)}(t)?t:new Nd(t,i,s);return I_(()=>{const{operator:o,source:a}=this;n.add(o?o.call(n,a):a?this._subscribe(n):this._trySubscribe(n))}),n}_trySubscribe(t){try{return this._subscribe(t)}catch(i){t.error(i)}}forEach(t,i){return new(i=gA(i))((s,n)=>{const o=new Nd({next:a=>{try{t(a)}catch(l){n(l),o.unsubscribe()}},error:n,complete:s});this.subscribe(o)})}_subscribe(t){var i;return null===(i=this.source)||void 0===i?void 0:i.subscribe(t)}[zb](){return this}pipe(...t){return mA(t)(this)}toPromise(t){return new(t=gA(t))((i,s)=>{let n;this.subscribe(o=>n=o,o=>s(o),()=>i(n))})}}return r.create=e=>new r(e),r})();function gA(r){var e;return null!==(e=r??Rc.Promise)&&void 0!==e?e:Promise}const E5=wd(r=>function(){r(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"});let Qo=(()=>{class r extends Rs{constructor(){super(),this.closed=!1,this.currentObservers=null,this.observers=[],this.isStopped=!1,this.hasError=!1,this.thrownError=null}lift(t){const i=new vA(this,this);return i.operator=t,i}_throwIfClosed(){if(this.closed)throw new E5}next(t){I_(()=>{if(this._throwIfClosed(),!this.isStopped){this.currentObservers||(this.currentObservers=Array.from(this.observers));for(const i of this.currentObservers)i.next(t)}})}error(t){I_(()=>{if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=t;const{observers:i}=this;for(;i.length;)i.shift().error(t)}})}complete(){I_(()=>{if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;const{observers:t}=this;for(;t.length;)t.shift().complete()}})}unsubscribe(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null}get observed(){var t;return(null===(t=this.observers)||void 0===t?void 0:t.length)>0}_trySubscribe(t){return this._throwIfClosed(),super._trySubscribe(t)}_subscribe(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)}_innerSubscribe(t){const{hasError:i,isStopped:s,observers:n}=this;return i||s?uA:(this.currentObservers=null,n.push(t),new eo(()=>{this.currentObservers=null,Od(n,t)}))}_checkFinalizedStatuses(t){const{hasError:i,thrownError:s,isStopped:n}=this;i?t.error(s):n&&t.complete()}asObservable(){const t=new Rs;return t.source=this,t}}return r.create=(e,t)=>new vA(e,t),r})();class vA extends Qo{constructor(e,t){super(),this.destination=e,this.source=t}next(e){var t,i;null===(i=null===(t=this.destination)||void 0===t?void 0:t.next)||void 0===i||i.call(t,e)}error(e){var t,i;null===(i=null===(t=this.destination)||void 0===t?void 0:t.error)||void 0===i||i.call(t,e)}complete(){var e,t;null===(t=null===(e=this.destination)||void 0===e?void 0:e.complete)||void 0===t||t.call(e)}_subscribe(e){var t,i;return null!==(i=null===(t=this.source)||void 0===t?void 0:t.subscribe(e))&&void 0!==i?i:uA}}function bA(r){return Fi(r?.lift)}function ur(r){return e=>{if(bA(e))return e.lift(function(t){try{return r(t,this)}catch(i){this.error(i)}});throw new TypeError("Unable to lift unknown Observable type")}}function Ks(r,e,t,i,s){return new C5(r,e,t,i,s)}class C5 extends Ub{constructor(e,t,i,s,n,o){super(e),this.onFinalize=n,this.shouldUnsubscribe=o,this._next=t?function(a){try{t(a)}catch(l){e.error(l)}}:super._next,this._error=s?function(a){try{s(a)}catch(l){e.error(l)}finally{this.unsubscribe()}}:super._error,this._complete=i?function(){try{i()}catch(a){e.error(a)}finally{this.unsubscribe()}}:super._complete}unsubscribe(){var e;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){const{closed:t}=this;super.unsubscribe(),!t&&(null===(e=this.onFinalize)||void 0===e||e.call(this))}}}function Wt(r,e){return ur((t,i)=>{let s=0;t.subscribe(Ks(i,n=>{i.next(r.call(e,n,s++))}))})}function Pc(r){return this instanceof Pc?(this.v=r,this):new Pc(r)}function I5(r,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,i=t.apply(r,e||[]),n=[];return s={},o("next"),o("throw"),o("return"),s[Symbol.asyncIterator]=function(){return this},s;function o(d){i[d]&&(s[d]=function(f){return new Promise(function(p,_){n.push([d,f,p,_])>1||a(d,f)})})}function a(d,f){try{!function l(d){d.value instanceof Pc?Promise.resolve(d.value.v).then(c,h):u(n[0][2],d)}(i[d](f))}catch(p){u(n[0][3],p)}}function c(d){a("next",d)}function h(d){a("throw",d)}function u(d,f){d(f),n.shift(),n.length&&a(n[0][0],n[0][1])}}function M5(r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,e=r[Symbol.asyncIterator];return e?e.call(r):(r=function TA(r){var e="function"==typeof Symbol&&Symbol.iterator,t=e&&r[e],i=0;if(t)return t.call(r);if(r&&"number"==typeof r.length)return{next:function(){return r&&i>=r.length&&(r=void 0),{value:r&&r[i++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}(r),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(n){t[n]=r[n]&&function(o){return new Promise(function(a,l){!function s(n,o,a,l){Promise.resolve(l).then(function(c){n({value:c,done:a})},o)}(a,l,(o=r[n](o)).done,o.value)})}}}const SA=r=>r&&"number"==typeof r.length&&"function"!=typeof r;function EA(r){return Fi(r?.then)}function CA(r){return Fi(r[zb])}function AA(r){return Symbol.asyncIterator&&Fi(r?.[Symbol.asyncIterator])}function RA(r){return new TypeError(`You provided ${null!==r&&"object"==typeof r?"an invalid object":`'${r}'`} where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.`)}const IA=function D5(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}();function MA(r){return Fi(r?.[IA])}function PA(r){return I5(this,arguments,function*(){const t=r.getReader();try{for(;;){const{value:i,done:s}=yield Pc(t.read());if(s)return yield Pc(void 0);yield yield Pc(i)}}finally{t.releaseLock()}})}function DA(r){return Fi(r?.getReader)}function yo(r){if(r instanceof Rs)return r;if(null!=r){if(CA(r))return function w5(r){return new Rs(e=>{const t=r[zb]();if(Fi(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}(r);if(SA(r))return function O5(r){return new Rs(e=>{for(let t=0;t<r.length&&!e.closed;t++)e.next(r[t]);e.complete()})}(r);if(EA(r))return function N5(r){return new Rs(e=>{r.then(t=>{e.closed||(e.next(t),e.complete())},t=>e.error(t)).then(null,pA)})}(r);if(AA(r))return wA(r);if(MA(r))return function F5(r){return new Rs(e=>{for(const t of r)if(e.next(t),e.closed)return;e.complete()})}(r);if(DA(r))return function L5(r){return wA(PA(r))}(r)}throw RA(r)}function wA(r){return new Rs(e=>{(function B5(r,e){var t,i,s,n;return function A5(r,e,t,i){return new(t||(t=Promise))(function(n,o){function a(h){try{c(i.next(h))}catch(u){o(u)}}function l(h){try{c(i.throw(h))}catch(u){o(u)}}function c(h){h.done?n(h.value):function s(n){return n instanceof t?n:new t(function(o){o(n)})}(h.value).then(a,l)}c((i=i.apply(r,e||[])).next())})}(this,void 0,void 0,function*(){try{for(t=M5(r);!(i=yield t.next()).done;)if(e.next(i.value),e.closed)return}catch(o){s={error:o}}finally{try{i&&!i.done&&(n=t.return)&&(yield n.call(t))}finally{if(s)throw s.error}}e.complete()})})(r,e).catch(t=>e.error(t))})}function Ra(r,e,t,i=0,s=!1){const n=e.schedule(function(){t(),s?r.add(this.schedule(null,i)):this.unsubscribe()},i);if(r.add(n),!s)return n}function vr(r,e,t=1/0){return Fi(e)?vr((i,s)=>Wt((n,o)=>e(i,n,s,o))(yo(r(i,s))),t):("number"==typeof e&&(t=e),ur((i,s)=>function V5(r,e,t,i,s,n,o,a){const l=[];let c=0,h=0,u=!1;const d=()=>{u&&!l.length&&!c&&e.complete()},f=_=>c<i?p(_):l.push(_),p=_=>{n&&e.next(_),c++;let m=!1;yo(t(_,h++)).subscribe(Ks(e,g=>{s?.(g),n?f(g):e.next(g)},()=>{m=!0},void 0,()=>{if(m)try{for(c--;l.length&&c<i;){const g=l.shift();o?Ra(e,o,()=>p(g)):p(g)}d()}catch(g){e.error(g)}}))};return r.subscribe(Ks(e,f,()=>{u=!0,d()})),()=>{a?.()}}(i,s,r,t)))}function Uh(r=1/0){return vr(Mc,r)}const Ia=new Rs(r=>r.complete());function Wb(r){return r[r.length-1]}function OA(r){return Fi(Wb(r))?r.pop():void 0}function Fd(r){return function k5(r){return r&&Fi(r.schedule)}(Wb(r))?r.pop():void 0}function NA(r,e=0){return ur((t,i)=>{t.subscribe(Ks(i,s=>Ra(i,r,()=>i.next(s),e),()=>Ra(i,r,()=>i.complete(),e),s=>Ra(i,r,()=>i.error(s),e)))})}function FA(r,e=0){return ur((t,i)=>{i.add(r.schedule(()=>t.subscribe(i),e))})}function LA(r,e){if(!r)throw new Error("Iterable cannot be null");return new Rs(t=>{Ra(t,e,()=>{const i=r[Symbol.asyncIterator]();Ra(t,e,()=>{i.next().then(s=>{s.done?t.complete():t.next(s.value)})},0,!0)})})}function Vs(r,e){return e?function Y5(r,e){if(null!=r){if(CA(r))return function z5(r,e){return yo(r).pipe(FA(e),NA(e))}(r,e);if(SA(r))return function W5(r,e){return new Rs(t=>{let i=0;return e.schedule(function(){i===r.length?t.complete():(t.next(r[i++]),t.closed||this.schedule())})})}(r,e);if(EA(r))return function H5(r,e){return yo(r).pipe(FA(e),NA(e))}(r,e);if(AA(r))return LA(r,e);if(MA(r))return function X5(r,e){return new Rs(t=>{let i;return Ra(t,e,()=>{i=r[IA](),Ra(t,e,()=>{let s,n;try{({value:s,done:n}=i.next())}catch(o){return void t.error(o)}n?t.complete():t.next(s)},0,!0)}),()=>Fi(i?.return)&&i.return()})}(r,e);if(DA(r))return function j5(r,e){return LA(PA(r),e)}(r,e)}throw RA(r)}(r,e):yo(r)}function Xb(r,e,...t){if(!0===e)return void r();if(!1===e)return;const i=new Nd({next:()=>{i.unsubscribe(),r()}});return e(...t).subscribe(i)}function Di(r){for(let e in r)if(r[e]===Di)return e;throw Error("Could not find renamed property on target object.")}function jb(r,e){for(const t in e)e.hasOwnProperty(t)&&!r.hasOwnProperty(t)&&(r[t]=e[t])}function wi(r){if("string"==typeof r)return r;if(Array.isArray(r))return"["+r.map(wi).join(", ")+"]";if(null==r)return""+r;if(r.overriddenName)return`${r.overriddenName}`;if(r.name)return`${r.name}`;const e=r.toString();if(null==e)return""+e;const t=e.indexOf("\n");return-1===t?e:e.substring(0,t)}function Yb(r,e){return null==r||""===r?null===e?"":e:null==e||""===e?r:r+" "+e}const K5=Di({__forward_ref__:Di});function Li(r){return r.__forward_ref__=Li,r.toString=function(){return wi(this())},r}function xt(r){return qb(r)?r():r}function qb(r){return"function"==typeof r&&r.hasOwnProperty(K5)&&r.__forward_ref__===Li}class Ne extends Error{constructor(e,t){super(function P_(r,e){return`NG0${Math.abs(r)}${e?": "+e.trim():""}`}(e,t)),this.code=e}}function Pt(r){return"string"==typeof r?r:null==r?"":String(r)}function D_(r,e){throw new Ne(-201,!1)}function An(r,e){null==r&&function mi(r,e,t,i){throw new Error(`ASSERTION ERROR: ${r}`+(null==i?"":` [Expected=> ${t} ${i} ${e} <=Actual]`))}(e,r,null,"!=")}function Tt(r){return{token:r.token,providedIn:r.providedIn||null,factory:r.factory,value:void 0}}function Rn(r){return{providers:r.providers||[],imports:r.imports||[]}}function w_(r){return BA(r,O_)||BA(r,UA)}function BA(r,e){return r.hasOwnProperty(e)?r[e]:null}function VA(r){return r&&(r.hasOwnProperty($b)||r.hasOwnProperty(nX))?r[$b]:null}const O_=Di({\u0275prov:Di}),$b=Di({\u0275inj:Di}),UA=Di({ngInjectableDef:Di}),nX=Di({ngInjectorDef:Di});var gt=(()=>((gt=gt||{})[gt.Default=0]="Default",gt[gt.Host=1]="Host",gt[gt.Self=2]="Self",gt[gt.SkipSelf=4]="SkipSelf",gt[gt.Optional=8]="Optional",gt))();let Kb;function to(r){const e=Kb;return Kb=r,e}function kA(r,e,t){const i=w_(r);return i&&"root"==i.providedIn?void 0===i.value?i.value=i.factory():i.value:t&gt.Optional?null:void 0!==e?e:void D_(wi(r))}function Rl(r){return{toString:r}.toString()}var xo=(()=>((xo=xo||{})[xo.OnPush=0]="OnPush",xo[xo.Default=1]="Default",xo))(),Zo=(()=>{return(r=Zo||(Zo={}))[r.Emulated=0]="Emulated",r[r.None=2]="None",r[r.ShadowDom=3]="ShadowDom",Zo;var r})();const Bi=(()=>typeof globalThis<"u"&&globalThis||typeof global<"u"&&global||typeof window<"u"&&window||typeof self<"u"&&typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&self)(),kh={},fi=[],N_=Di({\u0275cmp:Di}),Qb=Di({\u0275dir:Di}),Zb=Di({\u0275pipe:Di}),GA=Di({\u0275mod:Di}),Pa=Di({\u0275fac:Di}),Ld=Di({__NG_ELEMENT_ID__:Di});let aX=0;function Il(r){return Rl(()=>{const t=!0===r.standalone,i={},s={type:r.type,providersResolver:null,decls:r.decls,vars:r.vars,factory:null,template:r.template||null,consts:r.consts||null,ngContentSelectors:r.ngContentSelectors,hostBindings:r.hostBindings||null,hostVars:r.hostVars||0,hostAttrs:r.hostAttrs||null,contentQueries:r.contentQueries||null,declaredInputs:i,inputs:null,outputs:null,exportAs:r.exportAs||null,onPush:r.changeDetection===xo.OnPush,directiveDefs:null,pipeDefs:null,standalone:t,dependencies:t&&r.dependencies||null,getStandaloneInjector:null,selectors:r.selectors||fi,viewQuery:r.viewQuery||null,features:r.features||null,data:r.data||{},encapsulation:r.encapsulation||Zo.Emulated,id:"c"+aX++,styles:r.styles||fi,_:null,setInput:null,schemas:r.schemas||null,tView:null},n=r.dependencies,o=r.features;return s.inputs=WA(r.inputs,i),s.outputs=WA(r.outputs),o&&o.forEach(a=>a(s)),s.directiveDefs=n?()=>("function"==typeof n?n():n).map(zA).filter(HA):null,s.pipeDefs=n?()=>("function"==typeof n?n():n).map(Ur).filter(HA):null,s})}function zA(r){return xi(r)||Vr(r)}function HA(r){return null!==r}function io(r){return Rl(()=>({type:r.type,bootstrap:r.bootstrap||fi,declarations:r.declarations||fi,imports:r.imports||fi,exports:r.exports||fi,transitiveCompileScopes:null,schemas:r.schemas||null,id:r.id||null}))}function WA(r,e){if(null==r)return kh;const t={};for(const i in r)if(r.hasOwnProperty(i)){let s=r[i],n=s;Array.isArray(s)&&(n=s[1],s=s[0]),t[s]=i,e&&(e[s]=n)}return t}const St=Il;function xi(r){return r[N_]||null}function Vr(r){return r[Qb]||null}function Ur(r){return r[Zb]||null}function In(r,e){const t=r[GA]||null;if(!t&&!0===e)throw new Error(`Type ${wi(r)} does not have '\u0275mod' property.`);return t}function un(r){return Array.isArray(r)&&"object"==typeof r[1]}function So(r){return Array.isArray(r)&&!0===r[1]}function ty(r){return 0!=(8&r.flags)}function V_(r){return 2==(2&r.flags)}function U_(r){return 1==(1&r.flags)}function Eo(r){return null!==r.template}function fX(r){return 0!=(256&r[2])}function Fc(r,e){return r.hasOwnProperty(Pa)?r[Pa]:null}class mX{constructor(e,t,i){this.previousValue=e,this.currentValue=t,this.firstChange=i}isFirstChange(){return this.firstChange}}function ro(){return YA}function YA(r){return r.type.prototype.ngOnChanges&&(r.setInput=vX),gX}function gX(){const r=$A(this),e=r?.current;if(e){const t=r.previous;if(t===kh)r.previous=e;else for(let i in e)t[i]=e[i];r.current=null,this.ngOnChanges(e)}}function vX(r,e,t,i){const s=$A(r)||function bX(r,e){return r[qA]=e}(r,{previous:kh,current:null}),n=s.current||(s.current={}),o=s.previous,a=this.declaredInputs[t],l=o[a];n[a]=new mX(l&&l.currentValue,e,o===kh),r[i]=e}ro.ngInherit=!0;const qA="__ngSimpleChanges__";function $A(r){return r[qA]||null}function Us(r){for(;Array.isArray(r);)r=r[0];return r}function Pn(r,e){return Us(e[r.index])}function oy(r,e){return r.data[e]}function Dn(r,e){const t=e[r];return un(t)?t:t[0]}function G_(r){return 64==(64&r[2])}function Ml(r,e){return null==e?null:r[e]}function KA(r){r[18]=0}function ay(r,e){r[5]+=e;let t=r,i=r[3];for(;null!==i&&(1===e&&1===t[5]||-1===e&&0===t[5]);)i[5]+=e,t=i,i=i[3]}const At={lFrame:oR(null),bindingsEnabled:!0};function ZA(){return At.bindingsEnabled}function ye(){return At.lFrame.lView}function ti(){return At.lFrame.tView}function Qs(){let r=JA();for(;null!==r&&64===r.type;)r=r.parent;return r}function JA(){return At.lFrame.currentTNode}function Jo(r,e){const t=At.lFrame;t.currentTNode=r,t.isParent=e}function ly(){return At.lFrame.isParent}function jh(){return At.lFrame.bindingIndex++}function LX(r,e){const t=At.lFrame;t.bindingIndex=t.bindingRootIndex=r,hy(e)}function hy(r){At.lFrame.currentDirectiveIndex=r}function dy(r){At.lFrame.currentQueryIndex=r}function VX(r){const e=r[1];return 2===e.type?e.declTNode:1===e.type?r[6]:null}function rR(r,e,t){if(t&gt.SkipSelf){let s=e,n=r;for(;!(s=s.parent,null!==s||t&gt.Host||(s=VX(n),null===s||(n=n[15],10&s.type))););if(null===s)return!1;e=s,r=n}const i=At.lFrame=nR();return i.currentTNode=e,i.lView=r,!0}function fy(r){const e=nR(),t=r[1];At.lFrame=e,e.currentTNode=t.firstChild,e.lView=r,e.tView=t,e.contextLView=r,e.bindingIndex=t.bindingStartIndex,e.inI18n=!1}function nR(){const r=At.lFrame,e=null===r?null:r.child;return null===e?oR(r):e}function oR(r){const e={currentTNode:null,isParent:!0,lView:null,tView:null,selectedIndex:-1,contextLView:null,elementDepthCount:0,currentNamespace:null,currentDirectiveIndex:-1,bindingRootIndex:-1,bindingIndex:-1,currentQueryIndex:0,parent:r,child:null,inI18n:!1};return null!==r&&(r.child=e),e}function aR(){const r=At.lFrame;return At.lFrame=r.parent,r.currentTNode=null,r.lView=null,r}const lR=aR;function py(){const r=aR();r.isParent=!0,r.tView=null,r.selectedIndex=-1,r.contextLView=null,r.elementDepthCount=0,r.currentDirectiveIndex=-1,r.currentNamespace=null,r.bindingRootIndex=-1,r.bindingIndex=-1,r.currentQueryIndex=0}function Gr(){return At.lFrame.selectedIndex}function Pl(r){At.lFrame.selectedIndex=r}function ls(){const r=At.lFrame;return oy(r.tView,r.selectedIndex)}function z_(r,e){for(let t=e.directiveStart,i=e.directiveEnd;t<i;t++){const n=r.data[t].type.prototype,{ngAfterContentInit:o,ngAfterContentChecked:a,ngAfterViewInit:l,ngAfterViewChecked:c,ngOnDestroy:h}=n;o&&(r.contentHooks||(r.contentHooks=[])).push(-t,o),a&&((r.contentHooks||(r.contentHooks=[])).push(t,a),(r.contentCheckHooks||(r.contentCheckHooks=[])).push(t,a)),l&&(r.viewHooks||(r.viewHooks=[])).push(-t,l),c&&((r.viewHooks||(r.viewHooks=[])).push(t,c),(r.viewCheckHooks||(r.viewCheckHooks=[])).push(t,c)),null!=h&&(r.destroyHooks||(r.destroyHooks=[])).push(t,h)}}function H_(r,e,t){cR(r,e,3,t)}function W_(r,e,t,i){(3&r[2])===t&&cR(r,e,t,i)}function _y(r,e){let t=r[2];(3&t)===e&&(t&=2047,t+=1,r[2]=t)}function cR(r,e,t,i){const n=i??-1,o=e.length-1;let a=0;for(let l=void 0!==i?65535&r[18]:0;l<o;l++)if("number"==typeof e[l+1]){if(a=e[l],null!=i&&a>=i)break}else e[l]<0&&(r[18]+=65536),(a<n||-1==n)&&(YX(r,t,e,l),r[18]=(4294901760&r[18])+l+2),l++}function YX(r,e,t,i){const s=t[i]<0,n=t[i+1],a=r[s?-t[i]:t[i]];if(s){if(r[2]>>11<r[18]>>16&&(3&r[2])===e){r[2]+=2048;try{n.call(a)}finally{}}}else try{n.call(a)}finally{}}class zd{constructor(e,t,i){this.factory=e,this.resolving=!1,this.canSeeViewProviders=t,this.injectImpl=i}}function X_(r,e,t){let i=0;for(;i<t.length;){const s=t[i];if("number"==typeof s){if(0!==s)break;i++;const n=t[i++],o=t[i++],a=t[i++];r.setAttribute(e,o,a,n)}else{const n=s,o=t[++i];uR(n)?r.setProperty(e,n,o):r.setAttribute(e,n,o),i++}}return i}function hR(r){return 3===r||4===r||6===r}function uR(r){return 64===r.charCodeAt(0)}function j_(r,e){if(null!==e&&0!==e.length)if(null===r||0===r.length)r=e.slice();else{let t=-1;for(let i=0;i<e.length;i++){const s=e[i];"number"==typeof s?t=s:0===t||dR(r,t,s,null,-1===t||2===t?e[++i]:null)}}return r}function dR(r,e,t,i,s){let n=0,o=r.length;if(-1===e)o=-1;else for(;n<r.length;){const a=r[n++];if("number"==typeof a){if(a===e){o=-1;break}if(a>e){o=n-1;break}}}for(;n<r.length;){const a=r[n];if("number"==typeof a)break;if(a===t){if(null===i)return void(null!==s&&(r[n+1]=s));if(i===r[n+1])return void(r[n+2]=s)}n++,null!==i&&n++,null!==s&&n++}-1!==o&&(r.splice(o,0,e),n=o+1),r.splice(n++,0,t),null!==i&&r.splice(n++,0,i),null!==s&&r.splice(n++,0,s)}function fR(r){return-1!==r}function Yh(r){return 32767&r}function qh(r,e){let t=function ZX(r){return r>>16}(r),i=e;for(;t>0;)i=i[15],t--;return i}let gy=!0;function Y_(r){const e=gy;return gy=r,e}let JX=0;const ea={};function Wd(r,e){const t=by(r,e);if(-1!==t)return t;const i=e[1];i.firstCreatePass&&(r.injectorIndex=e.length,vy(i.data,r),vy(e,null),vy(i.blueprint,null));const s=q_(r,e),n=r.injectorIndex;if(fR(s)){const o=Yh(s),a=qh(s,e),l=a[1].data;for(let c=0;c<8;c++)e[n+c]=a[o+c]|l[o+c]}return e[n+8]=s,n}function vy(r,e){r.push(0,0,0,0,0,0,0,0,e)}function by(r,e){return-1===r.injectorIndex||r.parent&&r.parent.injectorIndex===r.injectorIndex||null===e[r.injectorIndex+8]?-1:r.injectorIndex}function q_(r,e){if(r.parent&&-1!==r.parent.injectorIndex)return r.parent.injectorIndex;let t=0,i=null,s=e;for(;null!==s;){if(i=TR(s),null===i)return-1;if(t++,s=s[15],-1!==i.injectorIndex)return i.injectorIndex|t<<16}return-1}function $_(r,e,t){!function e6(r,e,t){let i;"string"==typeof t?i=t.charCodeAt(0)||0:t.hasOwnProperty(Ld)&&(i=t[Ld]),null==i&&(i=t[Ld]=JX++);const s=255&i;e.data[r+(s>>5)]|=1<<s}(r,e,t)}function mR(r,e,t){if(t&gt.Optional||void 0!==r)return r;D_()}function gR(r,e,t,i){if(t&gt.Optional&&void 0===i&&(i=null),0==(t&(gt.Self|gt.Host))){const s=r[9],n=to(void 0);try{return s?s.get(e,i,t&gt.Optional):kA(e,i,t&gt.Optional)}finally{to(n)}}return mR(i,0,t)}function vR(r,e,t,i=gt.Default,s){if(null!==r){if(1024&e[2]){const o=function n6(r,e,t,i,s){let n=r,o=e;for(;null!==n&&null!==o&&1024&o[2]&&!(256&o[2]);){const a=bR(n,o,t,i|gt.Self,ea);if(a!==ea)return a;let l=n.parent;if(!l){const c=o[21];if(c){const h=c.get(t,ea,i);if(h!==ea)return h}l=TR(o),o=o[15]}n=l}return s}(r,e,t,i,ea);if(o!==ea)return o}const n=bR(r,e,t,i,ea);if(n!==ea)return n}return gR(e,t,i,s)}function bR(r,e,t,i,s){const n=function s6(r){if("string"==typeof r)return r.charCodeAt(0)||0;const e=r.hasOwnProperty(Ld)?r[Ld]:void 0;return"number"==typeof e?e>=0?255&e:r6:e}(t);if("function"==typeof n){if(!rR(e,r,i))return i&gt.Host?mR(s,0,i):gR(e,t,i,s);try{const o=n(i);if(null!=o||i&gt.Optional)return o;D_()}finally{lR()}}else if("number"==typeof n){let o=null,a=by(r,e),l=-1,c=i&gt.Host?e[16][6]:null;for((-1===a||i&gt.SkipSelf)&&(l=-1===a?q_(r,e):e[a+8],-1!==l&&xR(i,!1)?(o=e[1],a=Yh(l),e=qh(l,e)):a=-1);-1!==a;){const h=e[1];if(yR(n,a,h.data)){const u=i6(a,e,t,o,i,c);if(u!==ea)return u}l=e[a+8],-1!==l&&xR(i,e[1].data[a+8]===c)&&yR(n,a,e)?(o=h,a=Yh(l),e=qh(l,e)):a=-1}}return s}function i6(r,e,t,i,s,n){const o=e[1],a=o.data[r+8],h=function K_(r,e,t,i,s){const n=r.providerIndexes,o=e.data,a=1048575&n,l=r.directiveStart,h=n>>20,d=s?a+h:r.directiveEnd;for(let f=i?a:a+h;f<d;f++){const p=o[f];if(f<l&&t===p||f>=l&&p.type===t)return f}if(s){const f=o[l];if(f&&Eo(f)&&f.type===t)return l}return null}(a,o,t,null==i?V_(a)&&gy:i!=o&&0!=(3&a.type),s&gt.Host&&n===a);return null!==h?Xd(e,o,h,a):ea}function Xd(r,e,t,i){let s=r[t];const n=e.data;if(function qX(r){return r instanceof zd}(s)){const o=s;o.resolving&&function Q5(r,e){const t=e?`. Dependency path: ${e.join(" > ")} > ${r}`:"";throw new Ne(-200,`Circular dependency in DI detected for ${r}${t}`)}(function di(r){return"function"==typeof r?r.name||r.toString():"object"==typeof r&&null!=r&&"function"==typeof r.type?r.type.name||r.type.toString():Pt(r)}(n[t]));const a=Y_(o.canSeeViewProviders);o.resolving=!0;const l=o.injectImpl?to(o.injectImpl):null;rR(r,i,gt.Default);try{s=r[t]=o.factory(void 0,n,r,i),e.firstCreatePass&&t>=i.directiveStart&&function jX(r,e,t){const{ngOnChanges:i,ngOnInit:s,ngDoCheck:n}=e.type.prototype;if(i){const o=YA(e);(t.preOrderHooks||(t.preOrderHooks=[])).push(r,o),(t.preOrderCheckHooks||(t.preOrderCheckHooks=[])).push(r,o)}s&&(t.preOrderHooks||(t.preOrderHooks=[])).push(0-r,s),n&&((t.preOrderHooks||(t.preOrderHooks=[])).push(r,n),(t.preOrderCheckHooks||(t.preOrderCheckHooks=[])).push(r,n))}(t,n[t],e)}finally{null!==l&&to(l),Y_(a),o.resolving=!1,lR()}}return s}function yR(r,e,t){return!!(t[e+(r>>5)]&1<<r)}function xR(r,e){return!(r&gt.Self||r&gt.Host&&e)}class $h{constructor(e,t){this._tNode=e,this._lView=t}get(e,t,i){return vR(this._tNode,this._lView,e,i,t)}}function r6(){return new $h(Qs(),ye())}function Cr(r){return Rl(()=>{const e=r.prototype.constructor,t=e[Pa]||yy(e),i=Object.prototype;let s=Object.getPrototypeOf(r.prototype).constructor;for(;s&&s!==i;){const n=s[Pa]||yy(s);if(n&&n!==t)return n;s=Object.getPrototypeOf(s)}return n=>new n})}function yy(r){return qb(r)?()=>{const e=yy(xt(r));return e&&e()}:Fc(r)}function TR(r){const e=r[1],t=e.type;return 2===t?e.declTNode:1===t?r[6]:null}const Qh="__parameters__";function Jh(r,e,t){return Rl(()=>{const i=function xy(r){return function(...t){if(r){const i=r(...t);for(const s in i)this[s]=i[s]}}}(e);function s(...n){if(this instanceof s)return i.apply(this,n),this;const o=new s(...n);return a.annotation=o,a;function a(l,c,h){const u=l.hasOwnProperty(Qh)?l[Qh]:Object.defineProperty(l,Qh,{value:[]})[Qh];for(;u.length<=h;)u.push(null);return(u[h]=u[h]||[]).push(o),l}}return t&&(s.prototype=Object.create(t.prototype)),s.prototype.ngMetadataName=r,s.annotationCls=s,s})}class nt{constructor(e,t){this._desc=e,this.ngMetadataName="InjectionToken",this.\u0275prov=void 0,"number"==typeof t?this.__NG_ELEMENT_ID__=t:void 0!==t&&(this.\u0275prov=Tt({token:this,providedIn:t.providedIn||"root",factory:t.factory}))}get multi(){return this}toString(){return`InjectionToken ${this._desc}`}}function Oa(r,e){r.forEach(t=>Array.isArray(t)?Oa(t,e):e(t))}function ER(r,e,t){e>=r.length?r.push(t):r.splice(e,0,t)}function Q_(r,e){return e>=r.length-1?r.pop():r.splice(e,1)[0]}function On(r,e,t){let i=eu(r,e);return i>=0?r[1|i]=t:(i=~i,function c6(r,e,t,i){let s=r.length;if(s==e)r.push(t,i);else if(1===s)r.push(i,r[0]),r[0]=t;else{for(s--,r.push(r[s-1],r[s]);s>e;)r[s]=r[s-2],s--;r[e]=t,r[e+1]=i}}(r,i,e,t)),i}function Sy(r,e){const t=eu(r,e);if(t>=0)return r[1|t]}function eu(r,e){return function RR(r,e,t){let i=0,s=r.length>>t;for(;s!==i;){const n=i+(s-i>>1),o=r[n<<t];if(e===o)return n<<t;o>e?s=n:i=n+1}return~(s<<t)}(r,e,1)}const Kd={},Cy="__NG_DI_FLAG__",J_="ngTempTokenPath",g6=/\n/gm,IR="__source";let Qd;function tu(r){const e=Qd;return Qd=r,e}function b6(r,e=gt.Default){if(void 0===Qd)throw new Ne(-203,!1);return null===Qd?kA(r,void 0,e):Qd.get(r,e&gt.Optional?null:void 0,e)}function tt(r,e=gt.Default){return(function oX(){return Kb}()||b6)(xt(r),e)}function Is(r,e=gt.Default){return"number"!=typeof e&&(e=0|(e.optional&&8)|(e.host&&1)|(e.self&&2)|(e.skipSelf&&4)),tt(r,e)}function Ay(r){const e=[];for(let t=0;t<r.length;t++){const i=xt(r[t]);if(Array.isArray(i)){if(0===i.length)throw new Ne(900,!1);let s,n=gt.Default;for(let o=0;o<i.length;o++){const a=i[o],l=y6(a);"number"==typeof l?-1===l?s=a.token:n|=l:s=a}e.push(tt(s,n))}else e.push(tt(i))}return e}function Zd(r,e){return r[Cy]=e,r.prototype[Cy]=e,r}function y6(r){return r[Cy]}const Jd=Zd(Jh("Optional"),8),ef=Zd(Jh("SkipSelf"),4);var dn=(()=>((dn=dn||{})[dn.Important=1]="Important",dn[dn.DashCase=2]="DashCase",dn))();const Dy=new Map;let V6=0;const Oy="__ngContext__";function Ar(r,e){un(e)?(r[Oy]=e[20],function k6(r){Dy.set(r[20],r)}(e)):r[Oy]=e}function Fy(r,e){return undefined(r,e)}function nf(r){const e=r[3];return So(e)?e[3]:e}function Ly(r){return $R(r[13])}function By(r){return $R(r[4])}function $R(r){for(;null!==r&&!So(r);)r=r[4];return r}function su(r,e,t,i,s){if(null!=i){let n,o=!1;So(i)?n=i:un(i)&&(o=!0,i=i[0]);const a=Us(i);0===r&&null!==t?null==s?tI(e,t,a):Lc(e,t,a,s||null,!0):1===r&&null!==t?Lc(e,t,a,s||null,!0):2===r?function Wy(r,e,t){const i=im(r,e);i&&function lj(r,e,t,i){r.removeChild(e,t,i)}(r,i,e,t)}(e,a,o):3===r&&e.destroyNode(a),null!=n&&function uj(r,e,t,i,s){const n=t[7];n!==Us(t)&&su(e,r,i,n,s);for(let a=10;a<t.length;a++){const l=t[a];af(l[1],l,r,e,i,n)}}(e,r,n,t,s)}}function Uy(r,e,t){return r.createElement(e,t)}function QR(r,e){const t=r[9],i=t.indexOf(e),s=e[3];512&e[2]&&(e[2]&=-513,ay(s,-1)),t.splice(i,1)}function ky(r,e){if(r.length<=10)return;const t=10+e,i=r[t];if(i){const s=i[17];null!==s&&s!==r&&QR(s,i),e>0&&(r[t-1][4]=i[4]);const n=Q_(r,10+e);!function ej(r,e){af(r,e,e[11],2,null,null),e[0]=null,e[6]=null}(i[1],i);const o=n[19];null!==o&&o.detachView(n[1]),i[3]=null,i[4]=null,i[2]&=-65}return i}function ZR(r,e){if(!(128&e[2])){const t=e[11];t.destroyNode&&af(r,e,t,3,null,null),function sj(r){let e=r[13];if(!e)return Gy(r[1],r);for(;e;){let t=null;if(un(e))t=e[13];else{const i=e[10];i&&(t=i)}if(!t){for(;e&&!e[4]&&e!==r;)un(e)&&Gy(e[1],e),e=e[3];null===e&&(e=r),un(e)&&Gy(e[1],e),t=e&&e[4]}e=t}}(e)}}function Gy(r,e){if(!(128&e[2])){e[2]&=-65,e[2]|=128,function aj(r,e){let t;if(null!=r&&null!=(t=r.destroyHooks))for(let i=0;i<t.length;i+=2){const s=e[t[i]];if(!(s instanceof zd)){const n=t[i+1];if(Array.isArray(n))for(let o=0;o<n.length;o+=2){const a=s[n[o]],l=n[o+1];try{l.call(a)}finally{}}else try{n.call(s)}finally{}}}}(r,e),function oj(r,e){const t=r.cleanup,i=e[7];let s=-1;if(null!==t)for(let n=0;n<t.length-1;n+=2)if("string"==typeof t[n]){const o=t[n+1],a="function"==typeof o?o(e):Us(e[o]),l=i[s=t[n+2]],c=t[n+3];"boolean"==typeof c?a.removeEventListener(t[n],l,c):c>=0?i[s=c]():i[s=-c].unsubscribe(),n+=2}else{const o=i[s=t[n+1]];t[n].call(o)}if(null!==i){for(let n=s+1;n<i.length;n++)(0,i[n])();e[7]=null}}(r,e),1===e[1].type&&e[11].destroy();const t=e[17];if(null!==t&&So(e[3])){t!==e[3]&&QR(t,e);const i=e[19];null!==i&&i.detachView(r)}!function G6(r){Dy.delete(r[20])}(e)}}function JR(r,e,t){return function eI(r,e,t){let i=e;for(;null!==i&&40&i.type;)i=(e=i).parent;if(null===i)return t[0];if(2&i.flags){const s=r.data[i.directiveStart].encapsulation;if(s===Zo.None||s===Zo.Emulated)return null}return Pn(i,t)}(r,e.parent,t)}function Lc(r,e,t,i,s){r.insertBefore(e,t,i,s)}function tI(r,e,t){r.appendChild(e,t)}function iI(r,e,t,i,s){null!==i?Lc(r,e,t,i,s):tI(r,e,t)}function im(r,e){return r.parentNode(e)}let qy,nI=function rI(r,e,t){return 40&r.type?Pn(r,t):null};function sm(r,e,t,i){const s=JR(r,i,e),n=e[11],a=function sI(r,e,t){return nI(r,e,t)}(i.parent||e[6],i,e);if(null!=s)if(Array.isArray(t))for(let l=0;l<t.length;l++)iI(n,s,t[l],a,!1);else iI(n,s,t,a,!1)}function rm(r,e){if(null!==e){const t=e.type;if(3&t)return Pn(e,r);if(4&t)return Hy(-1,r[e.index]);if(8&t){const i=e.child;if(null!==i)return rm(r,i);{const s=r[e.index];return So(s)?Hy(-1,s):Us(s)}}if(32&t)return Fy(e,r)()||Us(r[e.index]);{const i=aI(r,e);return null!==i?Array.isArray(i)?i[0]:rm(nf(r[16]),i):rm(r,e.next)}}return null}function aI(r,e){return null!==e?r[16][6].projection[e.projection]:null}function Hy(r,e){const t=10+r+1;if(t<e.length){const i=e[t],s=i[1].firstChild;if(null!==s)return rm(i,s)}return e[7]}function Xy(r,e,t,i,s,n,o){for(;null!=t;){const a=i[t.index],l=t.type;if(o&&0===e&&(a&&Ar(Us(a),i),t.flags|=4),64!=(64&t.flags))if(8&l)Xy(r,e,t.child,i,s,n,!1),su(e,r,s,a,n);else if(32&l){const c=Fy(t,i);let h;for(;h=c();)su(e,r,s,h,n);su(e,r,s,a,n)}else 16&l?lI(r,e,i,t,s,n):su(e,r,s,a,n);t=o?t.projectionNext:t.next}}function af(r,e,t,i,s,n){Xy(t,i,r.firstChild,e,s,n,!1)}function lI(r,e,t,i,s,n){const o=t[16],l=o[6].projection[i.projection];if(Array.isArray(l))for(let c=0;c<l.length;c++)su(e,r,s,l[c],n);else Xy(r,e,l,o[3],s,n,!0)}function cI(r,e,t){r.setAttribute(e,"style",t)}function jy(r,e,t){""===t?r.removeAttribute(e,"class"):r.setAttribute(e,"class",t)}const tx=new nt("ENVIRONMENT_INITIALIZER"),TI=new nt("INJECTOR",-1),SI=new nt("INJECTOR_DEF_TYPES");class EI{get(e,t=Kd){if(t===Kd){const i=new Error(`NullInjectorError: No provider for ${wi(e)}!`);throw i.name="NullInjectorError",i}return t}}function kj(...r){return{\u0275providers:CI(0,r)}}function CI(r,...e){const t=[],i=new Set;let s;return Oa(e,n=>{const o=n;ix(o,t,[],i)&&(s||(s=[]),s.push(o))}),void 0!==s&&AI(s,t),t}function AI(r,e){for(let t=0;t<r.length;t++){const{providers:s}=r[t];Oa(s,n=>{e.push(n)})}}function ix(r,e,t,i){if(!(r=xt(r)))return!1;let s=null,n=VA(r);const o=!n&&xi(r);if(n||o){if(o&&!o.standalone)return!1;s=r}else{const l=r.ngModule;if(n=VA(l),!n)return!1;s=l}const a=i.has(s);if(o){if(a)return!1;if(i.add(s),o.dependencies){const l="function"==typeof o.dependencies?o.dependencies():o.dependencies;for(const c of l)ix(c,e,t,i)}}else{if(!n)return!1;{if(null!=n.imports&&!a){let c;i.add(s);try{Oa(n.imports,h=>{ix(h,e,t,i)&&(c||(c=[]),c.push(h))})}finally{}void 0!==c&&AI(c,e)}if(!a){const c=Fc(s)||(()=>new s);e.push({provide:s,useFactory:c,deps:fi},{provide:SI,useValue:s,multi:!0},{provide:tx,useValue:()=>tt(s),multi:!0})}const l=n.providers;null==l||a||Oa(l,h=>{e.push(h)})}}return s!==r&&void 0!==r.providers}const Gj=Di({provide:String,useValue:Di});function sx(r){return null!==r&&"object"==typeof r&&Gj in r}function Vc(r){return"function"==typeof r}const rx=new nt("Set Injector scope."),lm={},Hj={};let nx;function cm(){return void 0===nx&&(nx=new EI),nx}class Ol{}class MI extends Ol{constructor(e,t,i,s){super(),this.parent=t,this.source=i,this.scopes=s,this.records=new Map,this._ngOnDestroyHooks=new Set,this._onDestroyHooks=[],this._destroyed=!1,ax(e,o=>this.processProvider(o)),this.records.set(TI,ru(void 0,this)),s.has("environment")&&this.records.set(Ol,ru(void 0,this));const n=this.records.get(rx);null!=n&&"string"==typeof n.value&&this.scopes.add(n.value),this.injectorDefTypes=new Set(this.get(SI.multi,fi,gt.Self))}get destroyed(){return this._destroyed}destroy(){this.assertNotDestroyed(),this._destroyed=!0;try{for(const e of this._ngOnDestroyHooks)e.ngOnDestroy();for(const e of this._onDestroyHooks)e()}finally{this.records.clear(),this._ngOnDestroyHooks.clear(),this.injectorDefTypes.clear(),this._onDestroyHooks.length=0}}onDestroy(e){this._onDestroyHooks.push(e)}runInContext(e){this.assertNotDestroyed();const t=tu(this),i=to(void 0);try{return e()}finally{tu(t),to(i)}}get(e,t=Kd,i=gt.Default){this.assertNotDestroyed();const s=tu(this),n=to(void 0);try{if(!(i&gt.SkipSelf)){let a=this.records.get(e);if(void 0===a){const l=function qj(r){return"function"==typeof r||"object"==typeof r&&r instanceof nt}(e)&&w_(e);a=l&&this.injectableDefInScope(l)?ru(ox(e),lm):null,this.records.set(e,a)}if(null!=a)return this.hydrate(e,a)}return(i&gt.Self?cm():this.parent).get(e,t=i&gt.Optional&&t===Kd?null:t)}catch(o){if("NullInjectorError"===o.name){if((o[J_]=o[J_]||[]).unshift(wi(e)),s)throw o;return function x6(r,e,t,i){const s=r[J_];throw e[IR]&&s.unshift(e[IR]),r.message=function T6(r,e,t,i=null){r=r&&"\n"===r.charAt(0)&&"\u0275"==r.charAt(1)?r.slice(2):r;let s=wi(e);if(Array.isArray(e))s=e.map(wi).join(" -> ");else if("object"==typeof e){let n=[];for(let o in e)if(e.hasOwnProperty(o)){let a=e[o];n.push(o+":"+("string"==typeof a?JSON.stringify(a):wi(a)))}s=`{${n.join(", ")}}`}return`${t}${i?"("+i+")":""}[${s}]: ${r.replace(g6,"\n  ")}`}("\n"+r.message,s,t,i),r.ngTokenPath=s,r[J_]=null,r}(o,e,"R3InjectorError",this.source)}throw o}finally{to(n),tu(s)}}resolveInjectorInitializers(){const e=tu(this),t=to(void 0);try{const i=this.get(tx.multi,fi,gt.Self);for(const s of i)s()}finally{tu(e),to(t)}}toString(){const e=[],t=this.records;for(const i of t.keys())e.push(wi(i));return`R3Injector[${e.join(", ")}]`}assertNotDestroyed(){if(this._destroyed)throw new Ne(205,!1)}processProvider(e){let t=Vc(e=xt(e))?e:xt(e&&e.provide);const i=function Xj(r){return sx(r)?ru(void 0,r.useValue):ru(PI(r),lm)}(e);if(Vc(e)||!0!==e.multi)this.records.get(t);else{let s=this.records.get(t);s||(s=ru(void 0,lm,!0),s.factory=()=>Ay(s.multi),this.records.set(t,s)),t=e,s.multi.push(e)}this.records.set(t,i)}hydrate(e,t){return t.value===lm&&(t.value=Hj,t.value=t.factory()),"object"==typeof t.value&&t.value&&function Yj(r){return null!==r&&"object"==typeof r&&"function"==typeof r.ngOnDestroy}(t.value)&&this._ngOnDestroyHooks.add(t.value),t.value}injectableDefInScope(e){if(!e.providedIn)return!1;const t=xt(e.providedIn);return"string"==typeof t?"any"===t||this.scopes.has(t):this.injectorDefTypes.has(t)}}function ox(r){const e=w_(r),t=null!==e?e.factory:Fc(r);if(null!==t)return t;if(r instanceof nt)throw new Ne(204,!1);if(r instanceof Function)return function Wj(r){const e=r.length;if(e>0)throw function $d(r,e){const t=[];for(let i=0;i<r;i++)t.push(e);return t}(e,"?"),new Ne(204,!1);const t=function sX(r){const e=r&&(r[O_]||r[UA]);if(e){const t=function rX(r){if(r.hasOwnProperty("name"))return r.name;const e=(""+r).match(/^function\s*([^\s(]+)/);return null===e?"":e[1]}(r);return console.warn(`DEPRECATED: DI is instantiating a token "${t}" that inherits its @Injectable decorator but does not provide one itself.\nThis will become an error in a future version of Angular. Please add @Injectable() to the "${t}" class.`),e}return null}(r);return null!==t?()=>t.factory(r):()=>new r}(r);throw new Ne(204,!1)}function PI(r,e,t){let i;if(Vc(r)){const s=xt(r);return Fc(s)||ox(s)}if(sx(r))i=()=>xt(r.useValue);else if(function II(r){return!(!r||!r.useFactory)}(r))i=()=>r.useFactory(...Ay(r.deps||[]));else if(function RI(r){return!(!r||!r.useExisting)}(r))i=()=>tt(xt(r.useExisting));else{const s=xt(r&&(r.useClass||r.provide));if(!function jj(r){return!!r.deps}(r))return Fc(s)||ox(s);i=()=>new s(...Ay(r.deps))}return i}function ru(r,e,t=!1){return{factory:r,value:e,multi:t?[]:void 0}}function $j(r){return!!r.\u0275providers}function ax(r,e){for(const t of r)Array.isArray(t)?ax(t,e):$j(t)?ax(t.\u0275providers,e):e(t)}class DI{}class Zj{resolveComponentFactory(e){throw function Qj(r){const e=Error(`No component factory found for ${wi(r)}. Did you add it to @NgModule.entryComponents?`);return e.ngComponent=r,e}(e)}}let uf=(()=>{class r{}return r.NULL=new Zj,r})();function Jj(){return nu(Qs(),ye())}function nu(r,e){return new Nn(Pn(r,e))}let Nn=(()=>{class r{constructor(t){this.nativeElement=t}}return r.__NG_ELEMENT_ID__=Jj,r})();class OI{}let Fa=(()=>{class r{}return r.__NG_ELEMENT_ID__=()=>function tY(){const r=ye(),t=Dn(Qs().index,r);return(un(t)?t:r)[11]}(),r})(),iY=(()=>{class r{}return r.\u0275prov=Tt({token:r,providedIn:"root",factory:()=>null}),r})();class df{constructor(e){this.full=e,this.major=e.split(".")[0],this.minor=e.split(".")[1],this.patch=e.split(".").slice(2).join(".")}}const sY=new df("14.3.0"),lx={};function hx(r){return r.ngOriginalError}class ou{constructor(){this._console=console}handleError(e){const t=this._findOriginalError(e);this._console.error("ERROR",e),t&&this._console.error("ORIGINAL ERROR",t)}_findOriginalError(e){let t=e&&hx(e);for(;t&&hx(t);)t=hx(t);return t||null}}function La(r){return r instanceof Function?r():r}function FI(r,e,t){let i=r.length;for(;;){const s=r.indexOf(e,t);if(-1===s)return s;if(0===s||r.charCodeAt(s-1)<=32){const n=e.length;if(s+n===i||r.charCodeAt(s+n)<=32)return s}t=s+1}}const LI="ng-template";function pY(r,e,t){let i=0;for(;i<r.length;){let s=r[i++];if(t&&"class"===s){if(s=r[i],-1!==FI(s.toLowerCase(),e,0))return!0}else if(1===s){for(;i<r.length&&"string"==typeof(s=r[i++]);)if(s.toLowerCase()===e)return!0;return!1}}return!1}function BI(r){return 4===r.type&&r.value!==LI}function _Y(r,e,t){return e===(4!==r.type||t?r.value:LI)}function mY(r,e,t){let i=4;const s=r.attrs||[],n=function bY(r){for(let e=0;e<r.length;e++)if(hR(r[e]))return e;return r.length}(s);let o=!1;for(let a=0;a<e.length;a++){const l=e[a];if("number"!=typeof l){if(!o)if(4&i){if(i=2|1&i,""!==l&&!_Y(r,l,t)||""===l&&1===e.length){if(Co(i))return!1;o=!0}}else{const c=8&i?l:e[++a];if(8&i&&null!==r.attrs){if(!pY(r.attrs,c,t)){if(Co(i))return!1;o=!0}continue}const u=gY(8&i?"class":l,s,BI(r),t);if(-1===u){if(Co(i))return!1;o=!0;continue}if(""!==c){let d;d=u>n?"":s[u+1].toLowerCase();const f=8&i?d:null;if(f&&-1!==FI(f,c,0)||2&i&&c!==d){if(Co(i))return!1;o=!0}}}}else{if(!o&&!Co(i)&&!Co(l))return!1;if(o&&Co(l))continue;o=!1,i=l|1&i}}return Co(i)||o}function Co(r){return 0==(1&r)}function gY(r,e,t,i){if(null===e)return-1;let s=0;if(i||!t){let n=!1;for(;s<e.length;){const o=e[s];if(o===r)return s;if(3===o||6===o)n=!0;else{if(1===o||2===o){let a=e[++s];for(;"string"==typeof a;)a=e[++s];continue}if(4===o)break;if(0===o){s+=4;continue}}s+=n?1:2}return-1}return function yY(r,e){let t=r.indexOf(4);if(t>-1)for(t++;t<r.length;){const i=r[t];if("number"==typeof i)return-1;if(i===e)return t;t++}return-1}(e,r)}function VI(r,e,t=!1){for(let i=0;i<e.length;i++)if(mY(r,e[i],t))return!0;return!1}function UI(r,e){return r?":not("+e.trim()+")":e}function TY(r){let e=r[0],t=1,i=2,s="",n=!1;for(;t<r.length;){let o=r[t];if("string"==typeof o)if(2&i){const a=r[++t];s+="["+o+(a.length>0?'="'+a+'"':"")+"]"}else 8&i?s+="."+o:4&i&&(s+=" "+o);else""!==s&&!Co(o)&&(e+=UI(n,s),s=""),i=o,n=n||!Co(i);t++}return""!==s&&(e+=UI(n,s)),e}const Dt={};function ux(r){kI(ti(),ye(),Gr()+r,!1)}function kI(r,e,t,i){if(!i)if(3==(3&e[2])){const n=r.preOrderCheckHooks;null!==n&&H_(e,n,t)}else{const n=r.preOrderHooks;null!==n&&W_(e,n,0,t)}Pl(t)}function WI(r,e=null,t=null,i){const s=XI(r,e,t,i);return s.resolveInjectorInitializers(),s}function XI(r,e=null,t=null,i,s=new Set){const n=[t||fi,kj(r)];return i=i||("object"==typeof r?void 0:wi(r)),new MI(n,e||cm(),i||null,s)}let Fn=(()=>{class r{static create(t,i){if(Array.isArray(t))return WI({name:""},i,t,"");{const s=t.name??"";return WI({name:s},t.parent,t.providers,s)}}}return r.THROW_IF_NOT_FOUND=Kd,r.NULL=new EI,r.\u0275prov=Tt({token:r,providedIn:"any",factory:()=>tt(TI)}),r.__NG_ELEMENT_ID__=-1,r})();function xe(r,e=gt.Default){const t=ye();return null===t?tt(r,e):vR(Qs(),t,xt(r),e)}function mx(){throw new Error("invalid")}function um(r,e){return r<<17|e<<2}function Ao(r){return r>>17&32767}function gx(r){return 2|r}function Ba(r){return(131068&r)>>2}function vx(r,e){return-131069&r|e<<2}function bx(r){return 1|r}function lM(r,e){const t=r.contentQueries;if(null!==t)for(let i=0;i<t.length;i+=2){const s=t[i],n=t[i+1];if(-1!==n){const o=r.data[n];dy(s),o.contentQueries(2,e[n],n)}}}function pm(r,e,t,i,s,n,o,a,l,c,h){const u=e.blueprint.slice();return u[0]=s,u[2]=76|i,(null!==h||r&&1024&r[2])&&(u[2]|=1024),KA(u),u[3]=u[15]=r,u[8]=t,u[10]=o||r&&r[10],u[11]=a||r&&r[11],u[12]=l||r&&r[12]||null,u[9]=c||r&&r[9]||null,u[6]=n,u[20]=function U6(){return V6++}(),u[21]=h,u[16]=2==e.type?r[16]:u,u}function cu(r,e,t,i,s){let n=r.data[e];if(null===n)n=function Rx(r,e,t,i,s){const n=JA(),o=ly(),l=r.data[e]=function r8(r,e,t,i,s,n){return{type:t,index:i,insertBeforeIndex:null,injectorIndex:e?e.injectorIndex:-1,directiveStart:-1,directiveEnd:-1,directiveStylingLast:-1,propertyBindings:null,flags:0,providerIndexes:0,value:s,attrs:n,mergedAttrs:null,localNames:null,initialInputs:void 0,inputs:null,outputs:null,tViews:null,next:null,projectionNext:null,child:null,parent:e,projection:null,styles:null,stylesWithoutHost:null,residualStyles:void 0,classes:null,classesWithoutHost:null,residualClasses:void 0,classBindings:0,styleBindings:0}}(0,o?n:n&&n.parent,t,e,i,s);return null===r.firstChild&&(r.firstChild=l),null!==n&&(o?null==n.child&&null!==l.parent&&(n.child=l):null===n.next&&(n.next=l)),l}(r,e,t,i,s),function FX(){return At.lFrame.inI18n}()&&(n.flags|=64);else if(64&n.type){n.type=t,n.value=i,n.attrs=s;const o=function Gd(){const r=At.lFrame,e=r.currentTNode;return r.isParent?e:e.parent}();n.injectorIndex=null===o?-1:o.injectorIndex}return Jo(n,!0),n}function hu(r,e,t,i){if(0===t)return-1;const s=e.length;for(let n=0;n<t;n++)e.push(i),r.blueprint.push(i),r.data.push(null);return s}function Ix(r,e,t){fy(e);try{const i=r.viewQuery;null!==i&&Lx(1,i,t);const s=r.template;null!==s&&cM(r,e,s,1,t),r.firstCreatePass&&(r.firstCreatePass=!1),r.staticContentQueries&&lM(r,e),r.staticViewQueries&&Lx(2,r.viewQuery,t);const n=r.components;null!==n&&function t8(r,e){for(let t=0;t<e.length;t++)y8(r,e[t])}(e,n)}catch(i){throw r.firstCreatePass&&(r.incompleteFirstPass=!0,r.firstCreatePass=!1),i}finally{e[2]&=-5,py()}}function _m(r,e,t,i){const s=e[2];if(128!=(128&s)){fy(e);try{KA(e),function tR(r){return At.lFrame.bindingIndex=r}(r.bindingStartIndex),null!==t&&cM(r,e,t,2,i);const o=3==(3&s);if(o){const c=r.preOrderCheckHooks;null!==c&&H_(e,c,null)}else{const c=r.preOrderHooks;null!==c&&W_(e,c,0,null),_y(e,0)}if(function v8(r){for(let e=Ly(r);null!==e;e=By(e)){if(!e[2])continue;const t=e[9];for(let i=0;i<t.length;i++){const s=t[i],n=s[3];0==(512&s[2])&&ay(n,1),s[2]|=512}}}(e),function g8(r){for(let e=Ly(r);null!==e;e=By(e))for(let t=10;t<e.length;t++){const i=e[t],s=i[1];G_(i)&&_m(s,i,s.template,i[8])}}(e),null!==r.contentQueries&&lM(r,e),o){const c=r.contentCheckHooks;null!==c&&H_(e,c)}else{const c=r.contentHooks;null!==c&&W_(e,c,1),_y(e,1)}!function JY(r,e){const t=r.hostBindingOpCodes;if(null!==t)try{for(let i=0;i<t.length;i++){const s=t[i];if(s<0)Pl(~s);else{const n=s,o=t[++i],a=t[++i];LX(o,n),a(2,e[n])}}}finally{Pl(-1)}}(r,e);const a=r.components;null!==a&&function e8(r,e){for(let t=0;t<e.length;t++)b8(r,e[t])}(e,a);const l=r.viewQuery;if(null!==l&&Lx(2,l,i),o){const c=r.viewCheckHooks;null!==c&&H_(e,c)}else{const c=r.viewHooks;null!==c&&W_(e,c,2),_y(e,2)}!0===r.firstUpdatePass&&(r.firstUpdatePass=!1),e[2]&=-41,512&e[2]&&(e[2]&=-513,ay(e[3],-1))}finally{py()}}}function cM(r,e,t,i,s){const n=Gr(),o=2&i;try{Pl(-1),o&&e.length>22&&kI(r,e,22,!1),t(i,s)}finally{Pl(n)}}function uM(r){const e=r.tView;return null===e||e.incompleteFirstPass?r.tView=Dx(1,null,r.template,r.decls,r.vars,r.directiveDefs,r.pipeDefs,r.viewQuery,r.schemas,r.consts):e}function Dx(r,e,t,i,s,n,o,a,l,c){const h=22+i,u=h+s,d=function i8(r,e){const t=[];for(let i=0;i<e;i++)t.push(i<r?null:Dt);return t}(h,u),f="function"==typeof c?c():c;return d[1]={type:r,blueprint:d,template:t,queries:null,viewQuery:a,declTNode:e,data:d.slice().fill(null,h),bindingStartIndex:h,expandoStartIndex:u,hostBindingOpCodes:null,firstCreatePass:!0,firstUpdatePass:!0,staticViewQueries:!1,staticContentQueries:!1,preOrderHooks:null,preOrderCheckHooks:null,contentHooks:null,contentCheckHooks:null,viewHooks:null,viewCheckHooks:null,destroyHooks:null,cleanup:null,contentQueries:null,components:null,directiveRegistry:"function"==typeof n?n():n,pipeRegistry:"function"==typeof o?o():o,firstChild:null,schemas:l,consts:f,incompleteFirstPass:!1}}function fM(r,e,t){for(let i in r)if(r.hasOwnProperty(i)){const s=r[i];(t=null===t?{}:t).hasOwnProperty(i)?t[i].push(e,s):t[i]=[e,s]}return t}function pM(r,e){const i=e.directiveEnd,s=r.data,n=e.attrs,o=[];let a=null,l=null;for(let c=e.directiveStart;c<i;c++){const h=s[c],u=h.inputs,d=null===n||BI(e)?null:m8(u,n);o.push(d),a=fM(u,c,a),l=fM(h.outputs,c,l)}null!==a&&(a.hasOwnProperty("class")&&(e.flags|=16),a.hasOwnProperty("style")&&(e.flags|=32)),e.initialInputs=o,e.inputs=a,e.outputs=l}function _M(r,e){const t=Dn(e,r);16&t[2]||(t[2]|=32)}function mM(r,e,t,i,s,n){const o=n.hostBindings;if(o){let a=r.hostBindingOpCodes;null===a&&(a=r.hostBindingOpCodes=[]);const l=~e.index;(function l8(r){let e=r.length;for(;e>0;){const t=r[--e];if("number"==typeof t&&t<0)return t}return 0})(a)!=l&&a.push(l),a.push(i,s,o)}}function gM(r,e){null!==r.hostBindings&&r.hostBindings(1,e)}function vM(r,e){e.flags|=2,(r.components||(r.components=[])).push(e.index)}function f8(r,e,t){if(t){if(e.exportAs)for(let i=0;i<e.exportAs.length;i++)t[e.exportAs[i]]=r;Eo(e)&&(t[""]=r)}}function bM(r,e,t){r.flags|=1,r.directiveStart=e,r.directiveEnd=e+t,r.providerIndexes=e}function yM(r,e,t,i,s){r.data[i]=s;const n=s.factory||(s.factory=Fc(s.type)),o=new zd(n,Eo(s),xe);r.blueprint[i]=o,t[i]=o,mM(r,e,0,i,hu(r,t,s.hostVars,Dt),s)}function p8(r,e,t){const i=Pn(e,r),s=uM(t),n=r[10],o=mm(r,pm(r,s,null,t.onPush?32:16,i,e,n,n.createRenderer(i,t),null,null,null));r[e.index]=o}function ta(r,e,t,i,s,n){const o=Pn(r,e);!function Ox(r,e,t,i,s,n,o){if(null==n)r.removeAttribute(e,s,t);else{const a=null==o?Pt(n):o(n,i||"",s);r.setAttribute(e,s,a,t)}}(e[11],o,n,r.value,t,i,s)}function _8(r,e,t,i,s,n){const o=n[e];if(null!==o){const a=i.setInput;for(let l=0;l<o.length;){const c=o[l++],h=o[l++],u=o[l++];null!==a?i.setInput(t,u,c,h):t[h]=u}}}function m8(r,e){let t=null,i=0;for(;i<e.length;){const s=e[i];if(0!==s)if(5!==s){if("number"==typeof s)break;r.hasOwnProperty(s)&&(null===t&&(t=[]),t.push(s,r[s],e[i+1])),i+=2}else i+=2;else i+=4}return t}function b8(r,e){const t=Dn(e,r);if(G_(t)){const i=t[1];48&t[2]?_m(i,t,i.template,t[8]):t[5]>0&&Nx(t)}}function Nx(r){for(let i=Ly(r);null!==i;i=By(i))for(let s=10;s<i.length;s++){const n=i[s];if(G_(n))if(512&n[2]){const o=n[1];_m(o,n,o.template,n[8])}else n[5]>0&&Nx(n)}const t=r[1].components;if(null!==t)for(let i=0;i<t.length;i++){const s=Dn(t[i],r);G_(s)&&s[5]>0&&Nx(s)}}function y8(r,e){const t=Dn(e,r),i=t[1];(function x8(r,e){for(let t=e.length;t<r.blueprint.length;t++)e.push(r.blueprint[t])})(i,t),Ix(i,t,t[8])}function mm(r,e){return r[13]?r[14][4]=e:r[13]=e,r[14]=e,e}function Fx(r){for(;r;){r[2]|=32;const e=nf(r);if(fX(r)&&!e)return r;r=e}return null}function gm(r,e,t,i=!0){const s=e[10];s.begin&&s.begin();try{_m(r,e,r.template,t)}catch(o){throw i&&CM(e,o),o}finally{s.end&&s.end()}}function Lx(r,e,t){dy(0),e(r,t)}function TM(r){return r[7]||(r[7]=[])}function SM(r){return r.cleanup||(r.cleanup=[])}function CM(r,e){const t=r[9],i=t?t.get(ou,null):null;i&&i.handleError(e)}function Bx(r,e,t,i,s){for(let n=0;n<t.length;){const o=t[n++],a=t[n++],l=e[o],c=r.data[o];null!==c.setInput?c.setInput(l,s,i,a):l[a]=s}}function vm(r,e,t){let i=t?r.styles:null,s=t?r.classes:null,n=0;if(null!==e)for(let o=0;o<e.length;o++){const a=e[o];"number"==typeof a?n=a:1==n?s=Yb(s,a):2==n&&(i=Yb(i,a+": "+e[++o]+";"))}t?r.styles=i:r.stylesWithoutHost=i,t?r.classes=s:r.classesWithoutHost=s}function bm(r,e,t,i,s=!1){for(;null!==t;){const n=e[t.index];if(null!==n&&i.push(Us(n)),So(n))for(let a=10;a<n.length;a++){const l=n[a],c=l[1].firstChild;null!==c&&bm(l[1],l,c,i)}const o=t.type;if(8&o)bm(r,e,t.child,i);else if(32&o){const a=Fy(t,e);let l;for(;l=a();)i.push(l)}else if(16&o){const a=aI(e,t);if(Array.isArray(a))i.push(...a);else{const l=nf(e[16]);bm(l[1],l,a,i,!0)}}t=s?t.projectionNext:t.next}return i}class ff{constructor(e,t){this._lView=e,this._cdRefInjectingView=t,this._appRef=null,this._attachedToViewContainer=!1}get rootNodes(){const e=this._lView,t=e[1];return bm(t,e,t.firstChild,[])}get context(){return this._lView[8]}set context(e){this._lView[8]=e}get destroyed(){return 128==(128&this._lView[2])}destroy(){if(this._appRef)this._appRef.detachView(this);else if(this._attachedToViewContainer){const e=this._lView[3];if(So(e)){const t=e[8],i=t?t.indexOf(this):-1;i>-1&&(ky(e,i),Q_(t,i))}this._attachedToViewContainer=!1}ZR(this._lView[1],this._lView)}onDestroy(e){!function dM(r,e,t,i){const s=TM(e);null===t?s.push(i):(s.push(t),r.firstCreatePass&&SM(r).push(i,s.length-1))}(this._lView[1],this._lView,null,e)}markForCheck(){Fx(this._cdRefInjectingView||this._lView)}detach(){this._lView[2]&=-65}reattach(){this._lView[2]|=64}detectChanges(){gm(this._lView[1],this._lView,this.context)}checkNoChanges(){}attachToViewContainerRef(){if(this._appRef)throw new Ne(902,!1);this._attachedToViewContainer=!0}detachFromAppRef(){this._appRef=null,function ij(r,e){af(r,e,e[11],2,null,null)}(this._lView[1],this._lView)}attachToAppRef(e){if(this._attachedToViewContainer)throw new Ne(902,!1);this._appRef=e}}class T8 extends ff{constructor(e){super(e),this._view=e}detectChanges(){const e=this._view;gm(e[1],e,e[8],!1)}checkNoChanges(){}get context(){return null}}class Vx extends uf{constructor(e){super(),this.ngModule=e}resolveComponentFactory(e){const t=xi(e);return new pf(t,this.ngModule)}}function AM(r){const e=[];for(let t in r)r.hasOwnProperty(t)&&e.push({propName:r[t],templateName:t});return e}class E8{constructor(e,t){this.injector=e,this.parentInjector=t}get(e,t,i){const s=this.injector.get(e,lx,i);return s!==lx||t===lx?s:this.parentInjector.get(e,t,i)}}class pf extends DI{constructor(e,t){super(),this.componentDef=e,this.ngModule=t,this.componentType=e.type,this.selector=function SY(r){return r.map(TY).join(",")}(e.selectors),this.ngContentSelectors=e.ngContentSelectors?e.ngContentSelectors:[],this.isBoundToModule=!!t}get inputs(){return AM(this.componentDef.inputs)}get outputs(){return AM(this.componentDef.outputs)}create(e,t,i,s){let n=(s=s||this.ngModule)instanceof Ol?s:s?.injector;n&&null!==this.componentDef.getStandaloneInjector&&(n=this.componentDef.getStandaloneInjector(n)||n);const o=n?new E8(e,n):e,a=o.get(OI,null);if(null===a)throw new Ne(407,!1);const l=o.get(iY,null),c=a.createRenderer(null,this.componentDef),h=this.componentDef.selectors[0][0]||"div",u=i?function s8(r,e,t){return r.selectRootElement(e,t===Zo.ShadowDom)}(c,i,this.componentDef.encapsulation):Uy(c,h,function S8(r){const e=r.toLowerCase();return"svg"===e?"svg":"math"===e?"math":null}(h)),d=this.componentDef.onPush?288:272,f=Dx(0,null,null,1,0,null,null,null,null,null),p=pm(null,f,null,d,null,null,a,c,l,o,null);let _,m;fy(p);try{const g=function R8(r,e,t,i,s,n){const o=t[1];t[22]=r;const l=cu(o,22,2,"#host",null),c=l.mergedAttrs=e.hostAttrs;null!==c&&(vm(l,c,!0),null!==r&&(X_(s,r,c),null!==l.classes&&jy(s,r,l.classes),null!==l.styles&&cI(s,r,l.styles)));const h=i.createRenderer(r,e),u=pm(t,uM(e),null,e.onPush?32:16,t[22],l,i,h,n||null,null,null);return o.firstCreatePass&&($_(Wd(l,t),o,e.type),vM(o,l),bM(l,t.length,1)),mm(t,u),t[22]=u}(u,this.componentDef,p,a,c);if(u)if(i)X_(c,u,["ng-version",sY.full]);else{const{attrs:b,classes:y}=function EY(r){const e=[],t=[];let i=1,s=2;for(;i<r.length;){let n=r[i];if("string"==typeof n)2===s?""!==n&&e.push(n,r[++i]):8===s&&t.push(n);else{if(!Co(s))break;s=n}i++}return{attrs:e,classes:t}}(this.componentDef.selectors[0]);b&&X_(c,u,b),y&&y.length>0&&jy(c,u,y.join(" "))}if(m=oy(f,22),void 0!==t){const b=m.projection=[];for(let y=0;y<this.ngContentSelectors.length;y++){const T=t[y];b.push(null!=T?Array.from(T):null)}}_=function I8(r,e,t,i){const s=t[1],n=function a8(r,e,t){const i=Qs();r.firstCreatePass&&(t.providersResolver&&t.providersResolver(t),yM(r,i,e,hu(r,e,1,null),t),pM(r,i));const s=Xd(e,r,i.directiveStart,i);Ar(s,e);const n=Pn(i,e);return n&&Ar(n,e),s}(s,t,e);if(r[8]=t[8]=n,null!==i)for(const a of i)a(n,e);if(e.contentQueries){const a=Qs();e.contentQueries(1,n,a.directiveStart)}const o=Qs();return!s.firstCreatePass||null===e.hostBindings&&null===e.hostAttrs||(Pl(o.index),mM(t[1],o,0,o.directiveStart,o.directiveEnd,e),gM(e,n)),n}(g,this.componentDef,p,[M8]),Ix(f,p,null)}finally{py()}return new A8(this.componentType,_,nu(m,p),p,m)}}class A8 extends class Kj{}{constructor(e,t,i,s,n){super(),this.location=i,this._rootLView=s,this._tNode=n,this.instance=t,this.hostView=this.changeDetectorRef=new T8(s),this.componentType=e}setInput(e,t){const i=this._tNode.inputs;let s;if(null!==i&&(s=i[e])){const n=this._rootLView;Bx(n[1],n,s,e,t),_M(n,this._tNode.index)}}get injector(){return new $h(this._tNode,this._rootLView)}destroy(){this.hostView.destroy()}onDestroy(e){this.hostView.onDestroy(e)}}function M8(){const r=Qs();z_(ye()[1],r)}function Ti(r){let e=function RM(r){return Object.getPrototypeOf(r.prototype).constructor}(r.type),t=!0;const i=[r];for(;e;){let s;if(Eo(r))s=e.\u0275cmp||e.\u0275dir;else{if(e.\u0275cmp)throw new Ne(903,!1);s=e.\u0275dir}if(s){if(t){i.push(s);const o=r;o.inputs=Ux(r.inputs),o.declaredInputs=Ux(r.declaredInputs),o.outputs=Ux(r.outputs);const a=s.hostBindings;a&&O8(r,a);const l=s.viewQuery,c=s.contentQueries;if(l&&D8(r,l),c&&w8(r,c),jb(r.inputs,s.inputs),jb(r.declaredInputs,s.declaredInputs),jb(r.outputs,s.outputs),Eo(s)&&s.data.animation){const h=r.data;h.animation=(h.animation||[]).concat(s.data.animation)}}const n=s.features;if(n)for(let o=0;o<n.length;o++){const a=n[o];a&&a.ngInherit&&a(r),a===Ti&&(t=!1)}}e=Object.getPrototypeOf(e)}!function P8(r){let e=0,t=null;for(let i=r.length-1;i>=0;i--){const s=r[i];s.hostVars=e+=s.hostVars,s.hostAttrs=j_(s.hostAttrs,t=j_(t,s.hostAttrs))}}(i)}function Ux(r){return r===kh?{}:r===fi?[]:r}function D8(r,e){const t=r.viewQuery;r.viewQuery=t?(i,s)=>{e(i,s),t(i,s)}:e}function w8(r,e){const t=r.contentQueries;r.contentQueries=t?(i,s,n)=>{e(i,s,n),t(i,s,n)}:e}function O8(r,e){const t=r.hostBindings;r.hostBindings=t?(i,s)=>{e(i,s),t(i,s)}:e}function Rr(r,e,t){return!Object.is(r[e],t)&&(r[e]=t,!0)}function sa(r,e,t,i){const s=ye();return Rr(s,jh(),e)&&(ti(),ta(ls(),s,r,e,t,i)),sa}function Tm(r,e,t){const i=ye();return Rr(i,jh(),e)&&function Ln(r,e,t,i,s,n,o,a){const l=Pn(e,t);let h,c=e.inputs;!a&&null!=c&&(h=c[i])?(Bx(r,t,h,i,s),V_(e)&&_M(t,e.index)):3&e.type&&(i=function n8(r){return"class"===r?"className":"for"===r?"htmlFor":"formaction"===r?"formAction":"innerHtml"===r?"innerHTML":"readonly"===r?"readOnly":"tabindex"===r?"tabIndex":r}(i),s=null!=o?o(s,e.value||"",i):s,n.setProperty(l,i,s))}(ti(),ls(),i,r,e,i[11],t,!1),Tm}function Gx(r,e,t,i,s){const o=s?"class":"style";Bx(r,t,e.inputs[o],o,i)}function ut(r,e,t,i){const s=ye(),n=ti(),o=22+r,a=s[11],l=s[o]=Uy(a,e,function XX(){return At.lFrame.currentNamespace}()),c=n.firstCreatePass?function X8(r,e,t,i,s,n,o){const a=e.consts,c=cu(e,r,2,s,Ml(a,n));return function wx(r,e,t,i){let s=!1;if(ZA()){const n=function u8(r,e,t){const i=r.directiveRegistry;let s=null;if(i)for(let n=0;n<i.length;n++){const o=i[n];VI(t,o.selectors,!1)&&(s||(s=[]),$_(Wd(t,e),r,o.type),Eo(o)?(vM(r,t),s.unshift(o)):s.push(o))}return s}(r,e,t),o=null===i?null:{"":-1};if(null!==n){s=!0,bM(t,r.data.length,n.length);for(let h=0;h<n.length;h++){const u=n[h];u.providersResolver&&u.providersResolver(u)}let a=!1,l=!1,c=hu(r,e,n.length,null);for(let h=0;h<n.length;h++){const u=n[h];t.mergedAttrs=j_(t.mergedAttrs,u.hostAttrs),yM(r,t,e,c,u),f8(c,u,o),null!==u.contentQueries&&(t.flags|=8),(null!==u.hostBindings||null!==u.hostAttrs||0!==u.hostVars)&&(t.flags|=128);const d=u.type.prototype;!a&&(d.ngOnChanges||d.ngOnInit||d.ngDoCheck)&&((r.preOrderHooks||(r.preOrderHooks=[])).push(t.index),a=!0),!l&&(d.ngOnChanges||d.ngDoCheck)&&((r.preOrderCheckHooks||(r.preOrderCheckHooks=[])).push(t.index),l=!0),c++}pM(r,t)}o&&function d8(r,e,t){if(e){const i=r.localNames=[];for(let s=0;s<e.length;s+=2){const n=t[e[s+1]];if(null==n)throw new Ne(-301,!1);i.push(e[s],n)}}}(t,i,o)}return t.mergedAttrs=j_(t.mergedAttrs,t.attrs),s}(e,t,c,Ml(a,o)),null!==c.attrs&&vm(c,c.attrs,!1),null!==c.mergedAttrs&&vm(c,c.mergedAttrs,!0),null!==e.queries&&e.queries.elementStart(e,c),c}(o,n,s,0,e,t,i):n.data[o];Jo(c,!0);const h=c.mergedAttrs;null!==h&&X_(a,l,h);const u=c.classes;null!==u&&jy(a,l,u);const d=c.styles;return null!==d&&cI(a,l,d),64!=(64&c.flags)&&sm(n,s,l,c),0===function RX(){return At.lFrame.elementDepthCount}()&&Ar(l,s),function IX(){At.lFrame.elementDepthCount++}(),U_(c)&&(function Mx(r,e,t){!ZA()||(function c8(r,e,t,i){const s=t.directiveStart,n=t.directiveEnd;r.firstCreatePass||Wd(t,e),Ar(i,e);const o=t.initialInputs;for(let a=s;a<n;a++){const l=r.data[a],c=Eo(l);c&&p8(e,t,l);const h=Xd(e,r,a,t);Ar(h,e),null!==o&&_8(0,a-s,h,l,0,o),c&&(Dn(t.index,e)[8]=h)}}(r,e,t,Pn(t,e)),128==(128&t.flags)&&function h8(r,e,t){const i=t.directiveStart,s=t.directiveEnd,n=t.index,o=function BX(){return At.lFrame.currentDirectiveIndex}();try{Pl(n);for(let a=i;a<s;a++){const l=r.data[a],c=e[a];hy(a),(null!==l.hostBindings||0!==l.hostVars||null!==l.hostAttrs)&&gM(l,c)}}finally{Pl(-1),hy(o)}}(r,e,t))}(n,s,c),function hM(r,e,t){if(ty(e)){const s=e.directiveEnd;for(let n=e.directiveStart;n<s;n++){const o=r.data[n];o.contentQueries&&o.contentQueries(1,t[n],n)}}}(n,c,s)),null!==i&&function Px(r,e,t=Pn){const i=e.localNames;if(null!==i){let s=e.index+1;for(let n=0;n<i.length;n+=2){const o=i[n+1],a=-1===o?t(e,r):r[o];r[s++]=a}}}(s,c),ut}function bt(){let r=Qs();ly()?function cy(){At.lFrame.isParent=!1}():(r=r.parent,Jo(r,!1));const e=r;!function MX(){At.lFrame.elementDepthCount--}();const t=ti();return t.firstCreatePass&&(z_(t,r),ty(r)&&t.queries.elementEnd(r)),null!=e.classesWithoutHost&&function KX(r){return 0!=(16&r.flags)}(e)&&Gx(t,e,ye(),e.classesWithoutHost,!0),null!=e.stylesWithoutHost&&function QX(r){return 0!=(32&r.flags)}(e)&&Gx(t,e,ye(),e.stylesWithoutHost,!1),bt}function oi(r,e,t,i){return ut(r,e,t,i),bt(),oi}function gf(r){return!!r&&"function"==typeof r.then}const Wx=function VM(r){return!!r&&"function"==typeof r.subscribe};function br(r,e,t,i){const s=ye(),n=ti(),o=Qs();return function kM(r,e,t,i,s,n,o,a){const l=U_(i),h=r.firstCreatePass&&SM(r),u=e[8],d=TM(e);let f=!0;if(3&i.type||a){const m=Pn(i,e),g=a?a(m):m,b=d.length,y=a?x=>a(Us(x[i.index])):i.index;let T=null;if(!a&&l&&(T=function q8(r,e,t,i){const s=r.cleanup;if(null!=s)for(let n=0;n<s.length-1;n+=2){const o=s[n];if(o===t&&s[n+1]===i){const a=e[7],l=s[n+2];return a.length>l?a[l]:null}"string"==typeof o&&(n+=2)}return null}(r,e,s,i.index)),null!==T)(T.__ngLastListenerFn__||T).__ngNextListenerFn__=n,T.__ngLastListenerFn__=n,f=!1;else{n=zM(i,e,u,n,!1);const x=t.listen(g,s,n);d.push(n,x),h&&h.push(s,y,b,b+1)}}else n=zM(i,e,u,n,!1);const p=i.outputs;let _;if(f&&null!==p&&(_=p[s])){const m=_.length;if(m)for(let g=0;g<m;g+=2){const S=e[_[g]][_[g+1]].subscribe(n),C=d.length;d.push(n,S),h&&h.push(s,i.index,C,-(C+1))}}}(n,s,s[11],o,r,e,0,i),br}function GM(r,e,t,i){try{return!1!==t(i)}catch(s){return CM(r,s),!1}}function zM(r,e,t,i,s){return function n(o){if(o===Function)return i;Fx(2&r.flags?Dn(r.index,e):e);let l=GM(e,0,i,o),c=n.__ngNextListenerFn__;for(;c;)l=GM(e,0,c,o)&&l,c=c.__ngNextListenerFn__;return s&&!1===l&&(o.preventDefault(),o.returnValue=!1),l}}function ZM(r,e,t,i,s){const n=r[t+1],o=null===e;let a=i?Ao(n):Ba(n),l=!1;for(;0!==a&&(!1===l||o);){const h=r[a+1];tq(r[a],e)&&(l=!0,r[a+1]=i?bx(h):gx(h)),a=i?Ao(h):Ba(h)}l&&(r[t+1]=i?gx(n):bx(n))}function tq(r,e){return null===r||null==e||(Array.isArray(r)?r[1]:r)===e||!(!Array.isArray(r)||"string"!=typeof e)&&eu(r,e)>=0}function Sm(r,e){return function Ro(r,e,t,i){const s=ye(),n=ti(),o=function wa(r){const e=At.lFrame,t=e.bindingIndex;return e.bindingIndex=e.bindingIndex+r,t}(2);n.firstUpdatePass&&function aP(r,e,t,i){const s=r.data;if(null===s[t+1]){const n=s[Gr()],o=function oP(r,e){return e>=r.expandoStartIndex}(r,t);(function uP(r,e){return 0!=(r.flags&(e?16:32))})(n,i)&&null===e&&!o&&(e=!1),e=function hq(r,e,t,i){const s=function uy(r){const e=At.lFrame.currentDirectiveIndex;return-1===e?null:r[e]}(r);let n=i?e.residualClasses:e.residualStyles;if(null===s)0===(i?e.classBindings:e.styleBindings)&&(t=vf(t=jx(null,r,e,t,i),e.attrs,i),n=null);else{const o=e.directiveStylingLast;if(-1===o||r[o]!==s)if(t=jx(s,r,e,t,i),null===n){let l=function uq(r,e,t){const i=t?e.classBindings:e.styleBindings;if(0!==Ba(i))return r[Ao(i)]}(r,e,i);void 0!==l&&Array.isArray(l)&&(l=jx(null,r,e,l[1],i),l=vf(l,e.attrs,i),function dq(r,e,t,i){r[Ao(t?e.classBindings:e.styleBindings)]=i}(r,e,i,l))}else n=function fq(r,e,t){let i;const s=e.directiveEnd;for(let n=1+e.directiveStylingLast;n<s;n++)i=vf(i,r[n].hostAttrs,t);return vf(i,e.attrs,t)}(r,e,i)}return void 0!==n&&(i?e.residualClasses=n:e.residualStyles=n),t}(s,n,e,i),function J8(r,e,t,i,s,n){let o=n?e.classBindings:e.styleBindings,a=Ao(o),l=Ba(o);r[i]=t;let h,c=!1;if(Array.isArray(t)){const u=t;h=u[1],(null===h||eu(u,h)>0)&&(c=!0)}else h=t;if(s)if(0!==l){const d=Ao(r[a+1]);r[i+1]=um(d,a),0!==d&&(r[d+1]=vx(r[d+1],i)),r[a+1]=function HY(r,e){return 131071&r|e<<17}(r[a+1],i)}else r[i+1]=um(a,0),0!==a&&(r[a+1]=vx(r[a+1],i)),a=i;else r[i+1]=um(l,0),0===a?a=i:r[l+1]=vx(r[l+1],i),l=i;c&&(r[i+1]=gx(r[i+1])),ZM(r,h,i,!0),ZM(r,h,i,!1),function eq(r,e,t,i,s){const n=s?r.residualClasses:r.residualStyles;null!=n&&"string"==typeof e&&eu(n,e)>=0&&(t[i+1]=bx(t[i+1]))}(e,h,r,i,n),o=um(a,l),n?e.classBindings=o:e.styleBindings=o}(s,n,e,t,o,i)}}(n,r,o,i),e!==Dt&&Rr(s,o,e)&&function cP(r,e,t,i,s,n,o,a){if(!(3&e.type))return;const l=r.data,c=l[a+1];Em(function eM(r){return 1==(1&r)}(c)?hP(l,e,t,s,Ba(c),o):void 0)||(Em(n)||function JI(r){return 2==(2&r)}(c)&&(n=hP(l,null,t,s,a,o)),function dj(r,e,t,i,s){if(e)s?r.addClass(t,i):r.removeClass(t,i);else{let n=-1===i.indexOf("-")?void 0:dn.DashCase;null==s?r.removeStyle(t,i,n):("string"==typeof s&&s.endsWith("!important")&&(s=s.slice(0,-10),n|=dn.Important),r.setStyle(t,i,s,n))}}(i,o,function k_(r,e){return Us(e[r])}(Gr(),t),s,n))}(n,n.data[Gr()],s,s[11],r,s[o+1]=function mq(r,e){return null==r||("string"==typeof e?r+=e:"object"==typeof r&&(r=wi(function wl(r){return r instanceof class pI{constructor(e){this.changingThisBreaksApplicationSecurity=e}toString(){return`SafeValue must use [property]=binding: ${this.changingThisBreaksApplicationSecurity} (see https://g.co/ng/security#xss)`}}?r.changingThisBreaksApplicationSecurity:r}(r)))),r}(e,t),i,o)}(r,e,null,!0),Sm}function jx(r,e,t,i,s){let n=null;const o=t.directiveEnd;let a=t.directiveStylingLast;for(-1===a?a=t.directiveStart:a++;a<o&&(n=e[a],i=vf(i,n.hostAttrs,s),n!==r);)a++;return null!==r&&(t.directiveStylingLast=a),i}function vf(r,e,t){const i=t?1:2;let s=-1;if(null!==e)for(let n=0;n<e.length;n++){const o=e[n];"number"==typeof o?s=o:s===i&&(Array.isArray(r)||(r=void 0===r?[]:["",r]),On(r,o,!!t||e[++n]))}return void 0===r?null:r}function hP(r,e,t,i,s,n){const o=null===e;let a;for(;s>0;){const l=r[s],c=Array.isArray(l),h=c?l[1]:l,u=null===h;let d=t[s+1];d===Dt&&(d=u?fi:void 0);let f=u?Sy(d,i):h===i?d:void 0;if(c&&!Em(f)&&(f=Sy(l,i)),Em(f)&&(a=f,o))return a;const p=r[s+1];s=o?Ao(p):Ba(p)}if(null!==e){let l=n?e.residualClasses:e.residualStyles;null!=l&&(a=Sy(l,i))}return a}function Em(r){return void 0!==r}function ii(r,e=""){const t=ye(),i=ti(),s=r+22,n=i.firstCreatePass?cu(i,s,1,e,null):i.data[s],o=t[s]=function Vy(r,e){return r.createText(e)}(t[11],e);sm(i,t,o,n),Jo(n,!1)}const Tu="en-US";let NP=Tu;function Kx(r,e,t,i,s){if(r=xt(r),Array.isArray(r))for(let n=0;n<r.length;n++)Kx(r[n],e,t,i,s);else{const n=ti(),o=ye();let a=Vc(r)?r:xt(r.provide),l=PI(r);const c=Qs(),h=1048575&c.providerIndexes,u=c.directiveStart,d=c.providerIndexes>>20;if(Vc(r)||!r.multi){const f=new zd(l,s,xe),p=Zx(a,e,s?h:h+d,u);-1===p?($_(Wd(c,o),n,a),Qx(n,r,e.length),e.push(a),c.directiveStart++,c.directiveEnd++,s&&(c.providerIndexes+=1048576),t.push(f),o.push(f)):(t[p]=f,o[p]=f)}else{const f=Zx(a,e,h+d,u),p=Zx(a,e,h,h+d),_=f>=0&&t[f],m=p>=0&&t[p];if(s&&!m||!s&&!_){$_(Wd(c,o),n,a);const g=function N$(r,e,t,i,s){const n=new zd(r,t,xe);return n.multi=[],n.index=e,n.componentProviders=0,nD(n,s,i&&!t),n}(s?O$:w$,t.length,s,i,l);!s&&m&&(t[p].providerFactory=g),Qx(n,r,e.length,0),e.push(a),c.directiveStart++,c.directiveEnd++,s&&(c.providerIndexes+=1048576),t.push(g),o.push(g)}else Qx(n,r,f>-1?f:p,nD(t[s?p:f],l,!s&&i));!s&&i&&m&&t[p].componentProviders++}}}function Qx(r,e,t,i){const s=Vc(e),n=function zj(r){return!!r.useClass}(e);if(s||n){const l=(n?xt(e.useClass):e).prototype.ngOnDestroy;if(l){const c=r.destroyHooks||(r.destroyHooks=[]);if(!s&&e.multi){const h=c.indexOf(t);-1===h?c.push(t,[i,l]):c[h+1].push(i,l)}else c.push(t,l)}}}function nD(r,e,t){return t&&r.componentProviders++,r.multi.push(e)-1}function Zx(r,e,t,i){for(let s=t;s<i;s++)if(e[s]===r)return s;return-1}function w$(r,e,t,i){return Jx(this.multi,[])}function O$(r,e,t,i){const s=this.multi;let n;if(this.providerFactory){const o=this.providerFactory.componentProviders,a=Xd(t,t[1],this.providerFactory.index,i);n=a.slice(0,o),Jx(s,n);for(let l=o;l<a.length;l++)n.push(a[l])}else n=[],Jx(s,n);return n}function Jx(r,e){for(let t=0;t<r.length;t++)e.push((0,r[t])());return e}function Ji(r,e=[]){return t=>{t.providersResolver=(i,s)=>function D$(r,e,t){const i=ti();if(i.firstCreatePass){const s=Eo(r);Kx(t,i.data,i.blueprint,s,!0),Kx(e,i.data,i.blueprint,s,!1)}}(i,s?s(r):r,e)}}class zc{}class oD{}class aD extends zc{constructor(e,t){super(),this._parent=t,this._bootstrapComponents=[],this.destroyCbs=[],this.componentFactoryResolver=new Vx(this);const i=In(e);this._bootstrapComponents=La(i.bootstrap),this._r3Injector=XI(e,t,[{provide:zc,useValue:this},{provide:uf,useValue:this.componentFactoryResolver}],wi(e),new Set(["environment"])),this._r3Injector.resolveInjectorInitializers(),this.instance=this._r3Injector.get(e)}get injector(){return this._r3Injector}destroy(){const e=this._r3Injector;!e.destroyed&&e.destroy(),this.destroyCbs.forEach(t=>t()),this.destroyCbs=null}onDestroy(e){this.destroyCbs.push(e)}}class eT extends oD{constructor(e){super(),this.moduleType=e}create(e){return new aD(this.moduleType,e)}}class L$ extends zc{constructor(e,t,i){super(),this.componentFactoryResolver=new Vx(this),this.instance=null;const s=new MI([...e,{provide:zc,useValue:this},{provide:uf,useValue:this.componentFactoryResolver}],t||cm(),i,new Set(["environment"]));this.injector=s,s.resolveInjectorInitializers()}destroy(){this.injector.destroy()}onDestroy(e){this.injector.onDestroy(e)}}function Mm(r,e,t=null){return new L$(r,e,t).injector}let B$=(()=>{class r{constructor(t){this._injector=t,this.cachedInjectors=new Map}getOrCreateStandaloneInjector(t){if(!t.standalone)return null;if(!this.cachedInjectors.has(t.id)){const i=CI(0,t.type),s=i.length>0?Mm([i],this._injector,`Standalone[${t.type.name}]`):null;this.cachedInjectors.set(t.id,s)}return this.cachedInjectors.get(t.id)}ngOnDestroy(){try{for(const t of this.cachedInjectors.values())null!==t&&t.destroy()}finally{this.cachedInjectors.clear()}}}return r.\u0275prov=Tt({token:r,providedIn:"environment",factory:()=>new r(tt(Ol))}),r})();function lD(r){r.getStandaloneInjector=e=>e.get(B$).getOrCreateStandaloneInjector(r)}function iT(r){return e=>{setTimeout(r,void 0,e)}}const Ts=class cK extends Qo{constructor(e=!1){super(),this.__isAsync=e}emit(e){super.next(e)}subscribe(e,t,i){let s=e,n=t||(()=>null),o=i;if(e&&"object"==typeof e){const l=e;s=l.next?.bind(l),n=l.error?.bind(l),o=l.complete?.bind(l)}this.__isAsync&&(n=iT(n),s&&(s=iT(s)),o&&(o=iT(o)));const a=super.subscribe({next:s,error:n,complete:o});return e instanceof eo&&e.add(a),a}};let Mo=(()=>{class r{}return r.__NG_ELEMENT_ID__=pK,r})();function pK(){return function TD(r,e){let t;const i=e[r.index];if(So(i))t=i;else{let s;if(8&r.type)s=Us(i);else{const n=e[11];s=n.createComment("");const o=Pn(r,e);Lc(n,im(n,o),s,function cj(r,e){return r.nextSibling(e)}(n,o),!1)}e[r.index]=t=function xM(r,e,t,i){return new Array(r,!0,!1,e,null,0,i,t,null,null)}(i,e,s,r),mm(e,t)}return new yD(t,r,e)}(Qs(),ye())}const _K=Mo,yD=class extends _K{constructor(e,t,i){super(),this._lContainer=e,this._hostTNode=t,this._hostLView=i}get element(){return nu(this._hostTNode,this._hostLView)}get injector(){return new $h(this._hostTNode,this._hostLView)}get parentInjector(){const e=q_(this._hostTNode,this._hostLView);if(fR(e)){const t=qh(e,this._hostLView),i=Yh(e);return new $h(t[1].data[i+8],t)}return new $h(null,this._hostLView)}clear(){for(;this.length>0;)this.remove(this.length-1)}get(e){const t=xD(this._lContainer);return null!==t&&t[e]||null}get length(){return this._lContainer.length-10}createEmbeddedView(e,t,i){let s,n;"number"==typeof i?s=i:null!=i&&(s=i.index,n=i.injector);const o=e.createEmbeddedView(t||{},n);return this.insert(o,s),o}createComponent(e,t,i,s,n){const o=e&&!function qd(r){return"function"==typeof r}(e);let a;if(o)a=t;else{const u=t||{};a=u.index,i=u.injector,s=u.projectableNodes,n=u.environmentInjector||u.ngModuleRef}const l=o?e:new pf(xi(e)),c=i||this.parentInjector;if(!n&&null==l.ngModule){const d=(o?c:this.parentInjector).get(Ol,null);d&&(n=d)}const h=l.create(c,s,void 0,n);return this.insert(h.hostView,a),h}insert(e,t){const i=e._lView,s=i[1];if(function AX(r){return So(r[3])}(i)){const h=this.indexOf(e);if(-1!==h)this.detach(h);else{const u=i[3],d=new yD(u,u[6],u[3]);d.detach(d.indexOf(e))}}const n=this._adjustIndex(t),o=this._lContainer;!function rj(r,e,t,i){const s=10+i,n=t.length;i>0&&(t[s-1][4]=e),i<n-10?(e[4]=t[s],ER(t,10+i,e)):(t.push(e),e[4]=null),e[3]=t;const o=e[17];null!==o&&t!==o&&function nj(r,e){const t=r[9];e[16]!==e[3][3][16]&&(r[2]=!0),null===t?r[9]=[e]:t.push(e)}(o,e);const a=e[19];null!==a&&a.insertView(r),e[2]|=64}(s,i,o,n);const a=Hy(n,o),l=i[11],c=im(l,o[7]);return null!==c&&function tj(r,e,t,i,s,n){i[0]=s,i[6]=e,af(r,i,t,1,s,n)}(s,o[6],l,i,c,a),e.attachToViewContainerRef(),ER(rT(o),n,e),e}move(e,t){return this.insert(e,t)}indexOf(e){const t=xD(this._lContainer);return null!==t?t.indexOf(e):-1}remove(e){const t=this._adjustIndex(e,-1),i=ky(this._lContainer,t);i&&(Q_(rT(this._lContainer),t),ZR(i[1],i))}detach(e){const t=this._adjustIndex(e,-1),i=ky(this._lContainer,t);return i&&null!=Q_(rT(this._lContainer),t)?new ff(i):null}_adjustIndex(e,t=0){return e??this.length+t}};function xD(r){return r[8]}function rT(r){return r[8]||(r[8]=[])}function wm(...r){}const Om=new nt("Application Initializer");let Nm=(()=>{class r{constructor(t){this.appInits=t,this.resolve=wm,this.reject=wm,this.initialized=!1,this.done=!1,this.donePromise=new Promise((i,s)=>{this.resolve=i,this.reject=s})}runInitializers(){if(this.initialized)return;const t=[],i=()=>{this.done=!0,this.resolve()};if(this.appInits)for(let s=0;s<this.appInits.length;s++){const n=this.appInits[s]();if(gf(n))t.push(n);else if(Wx(n)){const o=new Promise((a,l)=>{n.subscribe({complete:a,error:l})});t.push(o)}}Promise.all(t).then(()=>{i()}).catch(s=>{this.reject(s)}),0===t.length&&i(),this.initialized=!0}}return r.\u0275fac=function(t){return new(t||r)(tt(Om,8))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();const Rf=new nt("AppId",{providedIn:"root",factory:function jD(){return`${gT()}${gT()}${gT()}`}});function gT(){return String.fromCharCode(97+Math.floor(25*Math.random()))}const YD=new nt("Platform Initializer"),vT=new nt("Platform ID",{providedIn:"platform",factory:()=>"unknown"}),qD=new nt("appBootstrapListener");let XK=(()=>{class r{log(t){console.log(t)}warn(t){console.warn(t)}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=Tt({token:r,factory:r.\u0275fac,providedIn:"platform"}),r})();const ka=new nt("LocaleId",{providedIn:"root",factory:()=>Is(ka,gt.Optional|gt.SkipSelf)||function jK(){return typeof $localize<"u"&&$localize.locale||Tu}()});class qK{constructor(e,t){this.ngModuleFactory=e,this.componentFactories=t}}let bT=(()=>{class r{compileModuleSync(t){return new eT(t)}compileModuleAsync(t){return Promise.resolve(this.compileModuleSync(t))}compileModuleAndAllComponentsSync(t){const i=this.compileModuleSync(t),n=La(In(t).declarations).reduce((o,a)=>{const l=xi(a);return l&&o.push(new pf(l)),o},[]);return new qK(i,n)}compileModuleAndAllComponentsAsync(t){return Promise.resolve(this.compileModuleAndAllComponentsSync(t))}clearCache(){}clearCacheFor(t){}getModuleId(t){}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=Tt({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();const QK=(()=>Promise.resolve(0))();function yT(r){typeof Zone>"u"?QK.then(()=>{r&&r.apply(null,null)}):Zone.current.scheduleMicroTask("scheduleMicrotask",r)}class er{constructor({enableLongStackTrace:e=!1,shouldCoalesceEventChangeDetection:t=!1,shouldCoalesceRunChangeDetection:i=!1}){if(this.hasPendingMacrotasks=!1,this.hasPendingMicrotasks=!1,this.isStable=!0,this.onUnstable=new Ts(!1),this.onMicrotaskEmpty=new Ts(!1),this.onStable=new Ts(!1),this.onError=new Ts(!1),typeof Zone>"u")throw new Ne(908,!1);Zone.assertZonePatched();const s=this;if(s._nesting=0,s._outer=s._inner=Zone.current,Zone.AsyncStackTaggingZoneSpec){const n=Zone.AsyncStackTaggingZoneSpec;s._inner=s._inner.fork(new n("Angular"))}Zone.TaskTrackingZoneSpec&&(s._inner=s._inner.fork(new Zone.TaskTrackingZoneSpec)),e&&Zone.longStackTraceZoneSpec&&(s._inner=s._inner.fork(Zone.longStackTraceZoneSpec)),s.shouldCoalesceEventChangeDetection=!i&&t,s.shouldCoalesceRunChangeDetection=i,s.lastRequestAnimationFrameId=-1,s.nativeRequestAnimationFrame=function ZK(){let r=Bi.requestAnimationFrame,e=Bi.cancelAnimationFrame;if(typeof Zone<"u"&&r&&e){const t=r[Zone.__symbol__("OriginalDelegate")];t&&(r=t);const i=e[Zone.__symbol__("OriginalDelegate")];i&&(e=i)}return{nativeRequestAnimationFrame:r,nativeCancelAnimationFrame:e}}().nativeRequestAnimationFrame,function tQ(r){const e=()=>{!function eQ(r){r.isCheckStableRunning||-1!==r.lastRequestAnimationFrameId||(r.lastRequestAnimationFrameId=r.nativeRequestAnimationFrame.call(Bi,()=>{r.fakeTopEventTask||(r.fakeTopEventTask=Zone.root.scheduleEventTask("fakeTopEventTask",()=>{r.lastRequestAnimationFrameId=-1,TT(r),r.isCheckStableRunning=!0,xT(r),r.isCheckStableRunning=!1},void 0,()=>{},()=>{})),r.fakeTopEventTask.invoke()}),TT(r))}(r)};r._inner=r._inner.fork({name:"angular",properties:{isAngularZone:!0},onInvokeTask:(t,i,s,n,o,a)=>{try{return QD(r),t.invokeTask(s,n,o,a)}finally{(r.shouldCoalesceEventChangeDetection&&"eventTask"===n.type||r.shouldCoalesceRunChangeDetection)&&e(),ZD(r)}},onInvoke:(t,i,s,n,o,a,l)=>{try{return QD(r),t.invoke(s,n,o,a,l)}finally{r.shouldCoalesceRunChangeDetection&&e(),ZD(r)}},onHasTask:(t,i,s,n)=>{t.hasTask(s,n),i===s&&("microTask"==n.change?(r._hasPendingMicrotasks=n.microTask,TT(r),xT(r)):"macroTask"==n.change&&(r.hasPendingMacrotasks=n.macroTask))},onHandleError:(t,i,s,n)=>(t.handleError(s,n),r.runOutsideAngular(()=>r.onError.emit(n)),!1)})}(s)}static isInAngularZone(){return typeof Zone<"u"&&!0===Zone.current.get("isAngularZone")}static assertInAngularZone(){if(!er.isInAngularZone())throw new Ne(909,!1)}static assertNotInAngularZone(){if(er.isInAngularZone())throw new Ne(909,!1)}run(e,t,i){return this._inner.run(e,t,i)}runTask(e,t,i,s){const n=this._inner,o=n.scheduleEventTask("NgZoneEvent: "+s,e,JK,wm,wm);try{return n.runTask(o,t,i)}finally{n.cancelTask(o)}}runGuarded(e,t,i){return this._inner.runGuarded(e,t,i)}runOutsideAngular(e){return this._outer.run(e)}}const JK={};function xT(r){if(0==r._nesting&&!r.hasPendingMicrotasks&&!r.isStable)try{r._nesting++,r.onMicrotaskEmpty.emit(null)}finally{if(r._nesting--,!r.hasPendingMicrotasks)try{r.runOutsideAngular(()=>r.onStable.emit(null))}finally{r.isStable=!0}}}function TT(r){r.hasPendingMicrotasks=!!(r._hasPendingMicrotasks||(r.shouldCoalesceEventChangeDetection||r.shouldCoalesceRunChangeDetection)&&-1!==r.lastRequestAnimationFrameId)}function QD(r){r._nesting++,r.isStable&&(r.isStable=!1,r.onUnstable.emit(null))}function ZD(r){r._nesting--,xT(r)}class iQ{constructor(){this.hasPendingMicrotasks=!1,this.hasPendingMacrotasks=!1,this.isStable=!0,this.onUnstable=new Ts,this.onMicrotaskEmpty=new Ts,this.onStable=new Ts,this.onError=new Ts}run(e,t,i){return e.apply(t,i)}runGuarded(e,t,i){return e.apply(t,i)}runOutsideAngular(e){return e()}runTask(e,t,i,s){return e.apply(t,i)}}const JD=new nt(""),Fm=new nt("");let CT,ST=(()=>{class r{constructor(t,i,s){this._ngZone=t,this.registry=i,this._pendingCount=0,this._isZoneStable=!0,this._didWork=!1,this._callbacks=[],this.taskTrackingZone=null,CT||(function sQ(r){CT=r}(s),s.addToWindow(i)),this._watchAngularEvents(),t.run(()=>{this.taskTrackingZone=typeof Zone>"u"?null:Zone.current.get("TaskTrackingZone")})}_watchAngularEvents(){this._ngZone.onUnstable.subscribe({next:()=>{this._didWork=!0,this._isZoneStable=!1}}),this._ngZone.runOutsideAngular(()=>{this._ngZone.onStable.subscribe({next:()=>{er.assertNotInAngularZone(),yT(()=>{this._isZoneStable=!0,this._runCallbacksIfReady()})}})})}increasePendingRequestCount(){return this._pendingCount+=1,this._didWork=!0,this._pendingCount}decreasePendingRequestCount(){if(this._pendingCount-=1,this._pendingCount<0)throw new Error("pending async requests below zero");return this._runCallbacksIfReady(),this._pendingCount}isStable(){return this._isZoneStable&&0===this._pendingCount&&!this._ngZone.hasPendingMacrotasks}_runCallbacksIfReady(){if(this.isStable())yT(()=>{for(;0!==this._callbacks.length;){let t=this._callbacks.pop();clearTimeout(t.timeoutId),t.doneCb(this._didWork)}this._didWork=!1});else{let t=this.getPendingTasks();this._callbacks=this._callbacks.filter(i=>!i.updateCb||!i.updateCb(t)||(clearTimeout(i.timeoutId),!1)),this._didWork=!0}}getPendingTasks(){return this.taskTrackingZone?this.taskTrackingZone.macroTasks.map(t=>({source:t.source,creationLocation:t.creationLocation,data:t.data})):[]}addCallback(t,i,s){let n=-1;i&&i>0&&(n=setTimeout(()=>{this._callbacks=this._callbacks.filter(o=>o.timeoutId!==n),t(this._didWork,this.getPendingTasks())},i)),this._callbacks.push({doneCb:t,timeoutId:n,updateCb:s})}whenStable(t,i,s){if(s&&!this.taskTrackingZone)throw new Error('Task tracking zone is required when passing an update callback to whenStable(). Is "zone.js/plugins/task-tracking" loaded?');this.addCallback(t,i,s),this._runCallbacksIfReady()}getPendingRequestCount(){return this._pendingCount}registerApplication(t){this.registry.registerApplication(t,this)}unregisterApplication(t){this.registry.unregisterApplication(t)}findProviders(t,i,s){return[]}}return r.\u0275fac=function(t){return new(t||r)(tt(er),tt(ET),tt(Fm))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})(),ET=(()=>{class r{constructor(){this._applications=new Map}registerApplication(t,i){this._applications.set(t,i)}unregisterApplication(t){this._applications.delete(t)}unregisterAllApplications(){this._applications.clear()}getTestability(t){return this._applications.get(t)||null}getAllTestabilities(){return Array.from(this._applications.values())}getAllRootElements(){return Array.from(this._applications.keys())}findTestabilityInTree(t,i=!0){return CT?.findTestabilityInTree(this,t,i)??null}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=Tt({token:r,factory:r.\u0275fac,providedIn:"platform"}),r})(),Ll=null;const ew=new nt("AllowMultipleToken"),AT=new nt("PlatformDestroyListeners");class tw{constructor(e,t){this.name=e,this.token=t}}function sw(r,e,t=[]){const i=`Platform: ${e}`,s=new nt(i);return(n=[])=>{let o=RT();if(!o||o.injector.get(ew,!1)){const a=[...t,...n,{provide:s,useValue:!0}];r?r(a):function oQ(r){if(Ll&&!Ll.get(ew,!1))throw new Ne(400,!1);Ll=r;const e=r.get(nw);(function iw(r){const e=r.get(YD,null);e&&e.forEach(t=>t())})(r)}(function rw(r=[],e){return Fn.create({name:e,providers:[{provide:rx,useValue:"platform"},{provide:AT,useValue:new Set([()=>Ll=null])},...r]})}(a,i))}return function lQ(r){const e=RT();if(!e)throw new Ne(401,!1);return e}()}}function RT(){return Ll?.get(nw)??null}let nw=(()=>{class r{constructor(t){this._injector=t,this._modules=[],this._destroyListeners=[],this._destroyed=!1}bootstrapModuleFactory(t,i){const s=function aw(r,e){let t;return t="noop"===r?new iQ:("zone.js"===r?void 0:r)||new er(e),t}(i?.ngZone,function ow(r){return{enableLongStackTrace:!1,shouldCoalesceEventChangeDetection:!(!r||!r.ngZoneEventCoalescing)||!1,shouldCoalesceRunChangeDetection:!(!r||!r.ngZoneRunCoalescing)||!1}}(i)),n=[{provide:er,useValue:s}];return s.run(()=>{const o=Fn.create({providers:n,parent:this.injector,name:t.moduleType.name}),a=t.create(o),l=a.injector.get(ou,null);if(!l)throw new Ne(402,!1);return s.runOutsideAngular(()=>{const c=s.onError.subscribe({next:h=>{l.handleError(h)}});a.onDestroy(()=>{Bm(this._modules,a),c.unsubscribe()})}),function lw(r,e,t){try{const i=t();return gf(i)?i.catch(s=>{throw e.runOutsideAngular(()=>r.handleError(s)),s}):i}catch(i){throw e.runOutsideAngular(()=>r.handleError(i)),i}}(l,s,()=>{const c=a.injector.get(Nm);return c.runInitializers(),c.donePromise.then(()=>(function FP(r){An(r,"Expected localeId to be defined"),"string"==typeof r&&(NP=r.toLowerCase().replace(/_/g,"-"))}(a.injector.get(ka,Tu)||Tu),this._moduleDoBootstrap(a),a))})})}bootstrapModule(t,i=[]){const s=cw({},i);return function rQ(r,e,t){const i=new eT(t);return Promise.resolve(i)}(0,0,t).then(n=>this.bootstrapModuleFactory(n,s))}_moduleDoBootstrap(t){const i=t.injector.get(Lm);if(t._bootstrapComponents.length>0)t._bootstrapComponents.forEach(s=>i.bootstrap(s));else{if(!t.instance.ngDoBootstrap)throw new Ne(403,!1);t.instance.ngDoBootstrap(i)}this._modules.push(t)}onDestroy(t){this._destroyListeners.push(t)}get injector(){return this._injector}destroy(){if(this._destroyed)throw new Ne(404,!1);this._modules.slice().forEach(i=>i.destroy()),this._destroyListeners.forEach(i=>i());const t=this._injector.get(AT,null);t&&(t.forEach(i=>i()),t.clear()),this._destroyed=!0}get destroyed(){return this._destroyed}}return r.\u0275fac=function(t){return new(t||r)(tt(Fn))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac,providedIn:"platform"}),r})();function cw(r,e){return Array.isArray(e)?e.reduce(cw,r):{...r,...e}}let Lm=(()=>{class r{constructor(t,i,s){this._zone=t,this._injector=i,this._exceptionHandler=s,this._bootstrapListeners=[],this._views=[],this._runningTick=!1,this._stable=!0,this._destroyed=!1,this._destroyListeners=[],this.componentTypes=[],this.components=[],this._onMicrotaskEmptySubscription=this._zone.onMicrotaskEmpty.subscribe({next:()=>{this._zone.run(()=>{this.tick()})}});const n=new Rs(a=>{this._stable=this._zone.isStable&&!this._zone.hasPendingMacrotasks&&!this._zone.hasPendingMicrotasks,this._zone.runOutsideAngular(()=>{a.next(this._stable),a.complete()})}),o=new Rs(a=>{let l;this._zone.runOutsideAngular(()=>{l=this._zone.onStable.subscribe(()=>{er.assertNotInAngularZone(),yT(()=>{!this._stable&&!this._zone.hasPendingMacrotasks&&!this._zone.hasPendingMicrotasks&&(this._stable=!0,a.next(!0))})})});const c=this._zone.onUnstable.subscribe(()=>{er.assertInAngularZone(),this._stable&&(this._stable=!1,this._zone.runOutsideAngular(()=>{a.next(!1)}))});return()=>{l.unsubscribe(),c.unsubscribe()}});this.isStable=function q5(...r){const e=Fd(r),t=function G5(r,e){return"number"==typeof Wb(r)?r.pop():e}(r,1/0),i=r;return i.length?1===i.length?yo(i[0]):Uh(t)(Vs(i,e)):Ia}(n,o.pipe(function $5(r={}){const{connector:e=(()=>new Qo),resetOnError:t=!0,resetOnComplete:i=!0,resetOnRefCountZero:s=!0}=r;return n=>{let o,a,l,c=0,h=!1,u=!1;const d=()=>{a?.unsubscribe(),a=void 0},f=()=>{d(),o=l=void 0,h=u=!1},p=()=>{const _=o;f(),_?.unsubscribe()};return ur((_,m)=>{c++,!u&&!h&&d();const g=l=l??e();m.add(()=>{c--,0===c&&!u&&!h&&(a=Xb(p,s))}),g.subscribe(m),!o&&c>0&&(o=new Nd({next:b=>g.next(b),error:b=>{u=!0,d(),a=Xb(f,t,b),g.error(b)},complete:()=>{h=!0,d(),a=Xb(f,i),g.complete()}}),yo(_).subscribe(o))})(n)}}()))}get destroyed(){return this._destroyed}get injector(){return this._injector}bootstrap(t,i){const s=t instanceof DI;if(!this._injector.get(Nm).done)throw!s&&function Gh(r){const e=xi(r)||Vr(r)||Ur(r);return null!==e&&e.standalone}(t),new Ne(405,false);let o;o=s?t:this._injector.get(uf).resolveComponentFactory(t),this.componentTypes.push(o.componentType);const a=function nQ(r){return r.isBoundToModule}(o)?void 0:this._injector.get(zc),c=o.create(Fn.NULL,[],i||o.selector,a),h=c.location.nativeElement,u=c.injector.get(JD,null);return u?.registerApplication(h),c.onDestroy(()=>{this.detachView(c.hostView),Bm(this.components,c),u?.unregisterApplication(h)}),this._loadComponent(c),c}tick(){if(this._runningTick)throw new Ne(101,!1);try{this._runningTick=!0;for(let t of this._views)t.detectChanges()}catch(t){this._zone.runOutsideAngular(()=>this._exceptionHandler.handleError(t))}finally{this._runningTick=!1}}attachView(t){const i=t;this._views.push(i),i.attachToAppRef(this)}detachView(t){const i=t;Bm(this._views,i),i.detachFromAppRef()}_loadComponent(t){this.attachView(t.hostView),this.tick(),this.components.push(t),this._injector.get(qD,[]).concat(this._bootstrapListeners).forEach(s=>s(t))}ngOnDestroy(){if(!this._destroyed)try{this._destroyListeners.forEach(t=>t()),this._views.slice().forEach(t=>t.destroy()),this._onMicrotaskEmptySubscription.unsubscribe()}finally{this._destroyed=!0,this._views=[],this._bootstrapListeners=[],this._destroyListeners=[]}}onDestroy(t){return this._destroyListeners.push(t),()=>Bm(this._destroyListeners,t)}destroy(){if(this._destroyed)throw new Ne(406,!1);const t=this._injector;t.destroy&&!t.destroyed&&t.destroy()}get viewCount(){return this._views.length}warnIfDestroyed(){}}return r.\u0275fac=function(t){return new(t||r)(tt(er),tt(Ol),tt(ou))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();function Bm(r,e){const t=r.indexOf(e);t>-1&&r.splice(t,1)}let uw=!0,Vm=(()=>{class r{}return r.__NG_ELEMENT_ID__=uQ,r})();function uQ(r){return function dQ(r,e,t){if(V_(r)&&!t){const i=Dn(r.index,e);return new ff(i,i)}return 47&r.type?new ff(e[16],e):null}(Qs(),ye(),16==(16&r))}const CQ=sw(null,"core",[]);let AQ=(()=>{class r{constructor(t){}}return r.\u0275fac=function(t){return new(t||r)(tt(Lm))},r.\u0275mod=io({type:r}),r.\u0275inj=Rn({}),r})();function za(r){return"boolean"==typeof r?r:null!=r&&"false"!==r}let zm=null;function oa(){return zm}const Xr=new nt("DocumentToken");let wT=(()=>{class r{historyGo(t){throw new Error("Not implemented")}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=Tt({token:r,factory:function(){return function PQ(){return tt(Tw)}()},providedIn:"platform"}),r})();const DQ=new nt("Location Initialized");let Tw=(()=>{class r extends wT{constructor(t){super(),this._doc=t,this._init()}_init(){this.location=window.location,this._history=window.history}getBaseHrefFromDOM(){return oa().getBaseHref(this._doc)}onPopState(t){const i=oa().getGlobalEventTarget(this._doc,"window");return i.addEventListener("popstate",t,!1),()=>i.removeEventListener("popstate",t)}onHashChange(t){const i=oa().getGlobalEventTarget(this._doc,"window");return i.addEventListener("hashchange",t,!1),()=>i.removeEventListener("hashchange",t)}get href(){return this.location.href}get protocol(){return this.location.protocol}get hostname(){return this.location.hostname}get port(){return this.location.port}get pathname(){return this.location.pathname}get search(){return this.location.search}get hash(){return this.location.hash}set pathname(t){this.location.pathname=t}pushState(t,i,s){Sw()?this._history.pushState(t,i,s):this.location.hash=s}replaceState(t,i,s){Sw()?this._history.replaceState(t,i,s):this.location.hash=s}forward(){this._history.forward()}back(){this._history.back()}historyGo(t=0){this._history.go(t)}getState(){return this._history.state}}return r.\u0275fac=function(t){return new(t||r)(tt(Xr))},r.\u0275prov=Tt({token:r,factory:function(){return function wQ(){return new Tw(tt(Xr))}()},providedIn:"platform"}),r})();function Sw(){return!!window.history.pushState}function OT(r,e){if(0==r.length)return e;if(0==e.length)return r;let t=0;return r.endsWith("/")&&t++,e.startsWith("/")&&t++,2==t?r+e.substring(1):1==t?r+e:r+"/"+e}function Ew(r){const e=r.match(/#|\?|$/),t=e&&e.index||r.length;return r.slice(0,t-("/"===r[t-1]?1:0))+r.slice(t)}function Ha(r){return r&&"?"!==r[0]?"?"+r:r}let Wc=(()=>{class r{historyGo(t){throw new Error("Not implemented")}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=Tt({token:r,factory:function(){return Is(Aw)},providedIn:"root"}),r})();const Cw=new nt("appBaseHref");let Aw=(()=>{class r extends Wc{constructor(t,i){super(),this._platformLocation=t,this._removeListenerFns=[],this._baseHref=i??this._platformLocation.getBaseHrefFromDOM()??Is(Xr).location?.origin??""}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(t){this._removeListenerFns.push(this._platformLocation.onPopState(t),this._platformLocation.onHashChange(t))}getBaseHref(){return this._baseHref}prepareExternalUrl(t){return OT(this._baseHref,t)}path(t=!1){const i=this._platformLocation.pathname+Ha(this._platformLocation.search),s=this._platformLocation.hash;return s&&t?`${i}${s}`:i}pushState(t,i,s,n){const o=this.prepareExternalUrl(s+Ha(n));this._platformLocation.pushState(t,i,o)}replaceState(t,i,s,n){const o=this.prepareExternalUrl(s+Ha(n));this._platformLocation.replaceState(t,i,o)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(t=0){this._platformLocation.historyGo?.(t)}}return r.\u0275fac=function(t){return new(t||r)(tt(wT),tt(Cw,8))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac,providedIn:"root"}),r})(),OQ=(()=>{class r extends Wc{constructor(t,i){super(),this._platformLocation=t,this._baseHref="",this._removeListenerFns=[],null!=i&&(this._baseHref=i)}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(t){this._removeListenerFns.push(this._platformLocation.onPopState(t),this._platformLocation.onHashChange(t))}getBaseHref(){return this._baseHref}path(t=!1){let i=this._platformLocation.hash;return null==i&&(i="#"),i.length>0?i.substring(1):i}prepareExternalUrl(t){const i=OT(this._baseHref,t);return i.length>0?"#"+i:i}pushState(t,i,s,n){let o=this.prepareExternalUrl(s+Ha(n));0==o.length&&(o=this._platformLocation.pathname),this._platformLocation.pushState(t,i,o)}replaceState(t,i,s,n){let o=this.prepareExternalUrl(s+Ha(n));0==o.length&&(o=this._platformLocation.pathname),this._platformLocation.replaceState(t,i,o)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(t=0){this._platformLocation.historyGo?.(t)}}return r.\u0275fac=function(t){return new(t||r)(tt(wT),tt(Cw,8))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})(),NT=(()=>{class r{constructor(t){this._subject=new Ts,this._urlChangeListeners=[],this._urlChangeSubscription=null,this._locationStrategy=t;const i=this._locationStrategy.getBaseHref();this._baseHref=Ew(Rw(i)),this._locationStrategy.onPopState(s=>{this._subject.emit({url:this.path(!0),pop:!0,state:s.state,type:s.type})})}ngOnDestroy(){this._urlChangeSubscription?.unsubscribe(),this._urlChangeListeners=[]}path(t=!1){return this.normalize(this._locationStrategy.path(t))}getState(){return this._locationStrategy.getState()}isCurrentPathEqualTo(t,i=""){return this.path()==this.normalize(t+Ha(i))}normalize(t){return r.stripTrailingSlash(function FQ(r,e){return r&&e.startsWith(r)?e.substring(r.length):e}(this._baseHref,Rw(t)))}prepareExternalUrl(t){return t&&"/"!==t[0]&&(t="/"+t),this._locationStrategy.prepareExternalUrl(t)}go(t,i="",s=null){this._locationStrategy.pushState(s,"",t,i),this._notifyUrlChangeListeners(this.prepareExternalUrl(t+Ha(i)),s)}replaceState(t,i="",s=null){this._locationStrategy.replaceState(s,"",t,i),this._notifyUrlChangeListeners(this.prepareExternalUrl(t+Ha(i)),s)}forward(){this._locationStrategy.forward()}back(){this._locationStrategy.back()}historyGo(t=0){this._locationStrategy.historyGo?.(t)}onUrlChange(t){return this._urlChangeListeners.push(t),this._urlChangeSubscription||(this._urlChangeSubscription=this.subscribe(i=>{this._notifyUrlChangeListeners(i.url,i.state)})),()=>{const i=this._urlChangeListeners.indexOf(t);this._urlChangeListeners.splice(i,1),0===this._urlChangeListeners.length&&(this._urlChangeSubscription?.unsubscribe(),this._urlChangeSubscription=null)}}_notifyUrlChangeListeners(t="",i){this._urlChangeListeners.forEach(s=>s(t,i))}subscribe(t,i,s){return this._subject.subscribe({next:t,error:i,complete:s})}}return r.normalizeQueryParams=Ha,r.joinWithSlash=OT,r.stripTrailingSlash=Ew,r.\u0275fac=function(t){return new(t||r)(tt(Wc))},r.\u0275prov=Tt({token:r,factory:function(){return function NQ(){return new NT(tt(Wc))}()},providedIn:"root"}),r})();function Rw(r){return r.replace(/\/index.html$/,"")}function Lw(r,e){e=encodeURIComponent(e);for(const t of r.split(";")){const i=t.indexOf("="),[s,n]=-1==i?[t,""]:[t.slice(0,i),t.slice(i+1)];if(s.trim()===e)return decodeURIComponent(n)}return null}let Q7=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=io({type:r}),r.\u0275inj=Rn({}),r})();let t9=(()=>{class r{}return r.\u0275prov=Tt({token:r,providedIn:"root",factory:()=>new i9(tt(Xr),window)}),r})();class i9{constructor(e,t){this.document=e,this.window=t,this.offset=()=>[0,0]}setOffset(e){this.offset=Array.isArray(e)?()=>e:e}getScrollPosition(){return this.supportsScrolling()?[this.window.pageXOffset,this.window.pageYOffset]:[0,0]}scrollToPosition(e){this.supportsScrolling()&&this.window.scrollTo(e[0],e[1])}scrollToAnchor(e){if(!this.supportsScrolling())return;const t=function s9(r,e){const t=r.getElementById(e)||r.getElementsByName(e)[0];if(t)return t;if("function"==typeof r.createTreeWalker&&r.body&&(r.body.createShadowRoot||r.body.attachShadow)){const i=r.createTreeWalker(r.body,NodeFilter.SHOW_ELEMENT);let s=i.currentNode;for(;s;){const n=s.shadowRoot;if(n){const o=n.getElementById(e)||n.querySelector(`[name="${e}"]`);if(o)return o}s=i.nextNode()}}return null}(this.document,e);t&&(this.scrollToElement(t),t.focus())}setHistoryScrollRestoration(e){if(this.supportScrollRestoration()){const t=this.window.history;t&&t.scrollRestoration&&(t.scrollRestoration=e)}}scrollToElement(e){const t=e.getBoundingClientRect(),i=t.left+this.window.pageXOffset,s=t.top+this.window.pageYOffset,n=this.offset();this.window.scrollTo(i-n[0],s-n[1])}supportScrollRestoration(){try{if(!this.supportsScrolling())return!1;const e=Ww(this.window.history)||Ww(Object.getPrototypeOf(this.window.history));return!(!e||!e.writable&&!e.set)}catch{return!1}}supportsScrolling(){try{return!!this.window&&!!this.window.scrollTo&&"pageXOffset"in this.window}catch{return!1}}}function Ww(r){return Object.getOwnPropertyDescriptor(r,"scrollRestoration")}class Xw{}class KT extends class P9 extends class MQ{}{constructor(){super(...arguments),this.supportsDOMEvents=!0}}{static makeCurrent(){!function IQ(r){zm||(zm=r)}(new KT)}onAndCancel(e,t,i){return e.addEventListener(t,i,!1),()=>{e.removeEventListener(t,i,!1)}}dispatchEvent(e,t){e.dispatchEvent(t)}remove(e){e.parentNode&&e.parentNode.removeChild(e)}createElement(e,t){return(t=t||this.getDefaultDocument()).createElement(e)}createHtmlDocument(){return document.implementation.createHTMLDocument("fakeTitle")}getDefaultDocument(){return document}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}isShadowRoot(e){return e instanceof DocumentFragment}getGlobalEventTarget(e,t){return"window"===t?window:"document"===t?e:"body"===t?e.body:null}getBaseHref(e){const t=function D9(){return wf=wf||document.querySelector("base"),wf?wf.getAttribute("href"):null}();return null==t?null:function w9(r){eg=eg||document.createElement("a"),eg.setAttribute("href",r);const e=eg.pathname;return"/"===e.charAt(0)?e:`/${e}`}(t)}resetBaseElement(){wf=null}getUserAgent(){return window.navigator.userAgent}getCookie(e){return Lw(document.cookie,e)}}let eg,wf=null;const Kw=new nt("TRANSITION_ID"),N9=[{provide:Om,useFactory:function O9(r,e,t){return()=>{t.get(Nm).donePromise.then(()=>{const i=oa(),s=e.querySelectorAll(`style[ng-transition="${r}"]`);for(let n=0;n<s.length;n++)i.remove(s[n])})}},deps:[Kw,Xr,Fn],multi:!0}];let L9=(()=>{class r{build(){return new XMLHttpRequest}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})();const tg=new nt("EventManagerPlugins");let ig=(()=>{class r{constructor(t,i){this._zone=i,this._eventNameToPlugin=new Map,t.forEach(s=>s.manager=this),this._plugins=t.slice().reverse()}addEventListener(t,i,s){return this._findPluginFor(i).addEventListener(t,i,s)}addGlobalEventListener(t,i,s){return this._findPluginFor(i).addGlobalEventListener(t,i,s)}getZone(){return this._zone}_findPluginFor(t){const i=this._eventNameToPlugin.get(t);if(i)return i;const s=this._plugins;for(let n=0;n<s.length;n++){const o=s[n];if(o.supports(t))return this._eventNameToPlugin.set(t,o),o}throw new Error(`No event manager plugin found for event ${t}`)}}return r.\u0275fac=function(t){return new(t||r)(tt(tg),tt(er))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})();class Qw{constructor(e){this._doc=e}addGlobalEventListener(e,t,i){const s=oa().getGlobalEventTarget(this._doc,e);if(!s)throw new Error(`Unsupported event target ${s} for event ${t}`);return this.addEventListener(s,t,i)}}let Zw=(()=>{class r{constructor(){this._stylesSet=new Set}addStyles(t){const i=new Set;t.forEach(s=>{this._stylesSet.has(s)||(this._stylesSet.add(s),i.add(s))}),this.onStylesAdded(i)}onStylesAdded(t){}getAllStyles(){return Array.from(this._stylesSet)}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})(),Of=(()=>{class r extends Zw{constructor(t){super(),this._doc=t,this._hostNodes=new Map,this._hostNodes.set(t.head,[])}_addStylesToHost(t,i,s){t.forEach(n=>{const o=this._doc.createElement("style");o.textContent=n,s.push(i.appendChild(o))})}addHost(t){const i=[];this._addStylesToHost(this._stylesSet,t,i),this._hostNodes.set(t,i)}removeHost(t){const i=this._hostNodes.get(t);i&&i.forEach(Jw),this._hostNodes.delete(t)}onStylesAdded(t){this._hostNodes.forEach((i,s)=>{this._addStylesToHost(t,s,i)})}ngOnDestroy(){this._hostNodes.forEach(t=>t.forEach(Jw))}}return r.\u0275fac=function(t){return new(t||r)(tt(Xr))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})();function Jw(r){oa().remove(r)}const QT={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/",math:"http://www.w3.org/1998/MathML/"},ZT=/%COMP%/g;function sg(r,e,t){for(let i=0;i<e.length;i++){let s=e[i];Array.isArray(s)?sg(r,s,t):(s=s.replace(ZT,r),t.push(s))}return t}function iO(r){return e=>{if("__ngUnwrap__"===e)return r;!1===r(e)&&(e.preventDefault(),e.returnValue=!1)}}let JT=(()=>{class r{constructor(t,i,s){this.eventManager=t,this.sharedStylesHost=i,this.appId=s,this.rendererByCompId=new Map,this.defaultRenderer=new eS(t)}createRenderer(t,i){if(!t||!i)return this.defaultRenderer;switch(i.encapsulation){case Zo.Emulated:{let s=this.rendererByCompId.get(i.id);return s||(s=new z9(this.eventManager,this.sharedStylesHost,i,this.appId),this.rendererByCompId.set(i.id,s)),s.applyToHost(t),s}case 1:case Zo.ShadowDom:return new H9(this.eventManager,this.sharedStylesHost,t,i);default:if(!this.rendererByCompId.has(i.id)){const s=sg(i.id,i.styles,[]);this.sharedStylesHost.addStyles(s),this.rendererByCompId.set(i.id,this.defaultRenderer)}return this.defaultRenderer}}begin(){}end(){}}return r.\u0275fac=function(t){return new(t||r)(tt(ig),tt(Of),tt(Rf))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})();class eS{constructor(e){this.eventManager=e,this.data=Object.create(null),this.destroyNode=null}destroy(){}createElement(e,t){return t?document.createElementNS(QT[t]||t,e):document.createElement(e)}createComment(e){return document.createComment(e)}createText(e){return document.createTextNode(e)}appendChild(e,t){(rO(e)?e.content:e).appendChild(t)}insertBefore(e,t,i){e&&(rO(e)?e.content:e).insertBefore(t,i)}removeChild(e,t){e&&e.removeChild(t)}selectRootElement(e,t){let i="string"==typeof e?document.querySelector(e):e;if(!i)throw new Error(`The selector "${e}" did not match any elements`);return t||(i.textContent=""),i}parentNode(e){return e.parentNode}nextSibling(e){return e.nextSibling}setAttribute(e,t,i,s){if(s){t=s+":"+t;const n=QT[s];n?e.setAttributeNS(n,t,i):e.setAttribute(t,i)}else e.setAttribute(t,i)}removeAttribute(e,t,i){if(i){const s=QT[i];s?e.removeAttributeNS(s,t):e.removeAttribute(`${i}:${t}`)}else e.removeAttribute(t)}addClass(e,t){e.classList.add(t)}removeClass(e,t){e.classList.remove(t)}setStyle(e,t,i,s){s&(dn.DashCase|dn.Important)?e.style.setProperty(t,i,s&dn.Important?"important":""):e.style[t]=i}removeStyle(e,t,i){i&dn.DashCase?e.style.removeProperty(t):e.style[t]=""}setProperty(e,t,i){e[t]=i}setValue(e,t){e.nodeValue=t}listen(e,t,i){return"string"==typeof e?this.eventManager.addGlobalEventListener(e,t,iO(i)):this.eventManager.addEventListener(e,t,iO(i))}}function rO(r){return"TEMPLATE"===r.tagName&&void 0!==r.content}class z9 extends eS{constructor(e,t,i,s){super(e),this.component=i;const n=sg(s+"-"+i.id,i.styles,[]);t.addStyles(n),this.contentAttr=function U9(r){return"_ngcontent-%COMP%".replace(ZT,r)}(s+"-"+i.id),this.hostAttr=function k9(r){return"_nghost-%COMP%".replace(ZT,r)}(s+"-"+i.id)}applyToHost(e){super.setAttribute(e,this.hostAttr,"")}createElement(e,t){const i=super.createElement(e,t);return super.setAttribute(i,this.contentAttr,""),i}}class H9 extends eS{constructor(e,t,i,s){super(e),this.sharedStylesHost=t,this.hostEl=i,this.shadowRoot=i.attachShadow({mode:"open"}),this.sharedStylesHost.addHost(this.shadowRoot);const n=sg(s.id,s.styles,[]);for(let o=0;o<n.length;o++){const a=document.createElement("style");a.textContent=n[o],this.shadowRoot.appendChild(a)}}nodeOrShadowRoot(e){return e===this.hostEl?this.shadowRoot:e}destroy(){this.sharedStylesHost.removeHost(this.shadowRoot)}appendChild(e,t){return super.appendChild(this.nodeOrShadowRoot(e),t)}insertBefore(e,t,i){return super.insertBefore(this.nodeOrShadowRoot(e),t,i)}removeChild(e,t){return super.removeChild(this.nodeOrShadowRoot(e),t)}parentNode(e){return this.nodeOrShadowRoot(super.parentNode(this.nodeOrShadowRoot(e)))}}let W9=(()=>{class r extends Qw{constructor(t){super(t)}supports(t){return!0}addEventListener(t,i,s){return t.addEventListener(i,s,!1),()=>this.removeEventListener(t,i,s)}removeEventListener(t,i,s){return t.removeEventListener(i,s)}}return r.\u0275fac=function(t){return new(t||r)(tt(Xr))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})();const nO=["alt","control","meta","shift"],X9={"\b":"Backspace","\t":"Tab","\x7f":"Delete","\x1b":"Escape",Del:"Delete",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Down:"ArrowDown",Menu:"ContextMenu",Scroll:"ScrollLock",Win:"OS"},j9={alt:r=>r.altKey,control:r=>r.ctrlKey,meta:r=>r.metaKey,shift:r=>r.shiftKey};let Y9=(()=>{class r extends Qw{constructor(t){super(t)}supports(t){return null!=r.parseEventName(t)}addEventListener(t,i,s){const n=r.parseEventName(i),o=r.eventCallback(n.fullKey,s,this.manager.getZone());return this.manager.getZone().runOutsideAngular(()=>oa().onAndCancel(t,n.domEventName,o))}static parseEventName(t){const i=t.toLowerCase().split("."),s=i.shift();if(0===i.length||"keydown"!==s&&"keyup"!==s)return null;const n=r._normalizeKey(i.pop());let o="",a=i.indexOf("code");if(a>-1&&(i.splice(a,1),o="code."),nO.forEach(c=>{const h=i.indexOf(c);h>-1&&(i.splice(h,1),o+=c+".")}),o+=n,0!=i.length||0===n.length)return null;const l={};return l.domEventName=s,l.fullKey=o,l}static matchEventFullKeyCode(t,i){let s=X9[t.key]||t.key,n="";return i.indexOf("code.")>-1&&(s=t.code,n="code."),!(null==s||!s)&&(s=s.toLowerCase()," "===s?s="space":"."===s&&(s="dot"),nO.forEach(o=>{o!==s&&(0,j9[o])(t)&&(n+=o+".")}),n+=s,n===i)}static eventCallback(t,i,s){return n=>{r.matchEventFullKeyCode(n,t)&&s.runGuarded(()=>i(n))}}static _normalizeKey(t){return"esc"===t?"escape":t}}return r.\u0275fac=function(t){return new(t||r)(tt(Xr))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})();const Q9=sw(CQ,"browser",[{provide:vT,useValue:"browser"},{provide:YD,useValue:function q9(){KT.makeCurrent()},multi:!0},{provide:Xr,useFactory:function K9(){return function mj(r){qy=r}(document),document},deps:[]}]),lO=new nt(""),cO=[{provide:Fm,useClass:class F9{addToWindow(e){Bi.getAngularTestability=(i,s=!0)=>{const n=e.findTestabilityInTree(i,s);if(null==n)throw new Error("Could not find testability for element.");return n},Bi.getAllAngularTestabilities=()=>e.getAllTestabilities(),Bi.getAllAngularRootElements=()=>e.getAllRootElements(),Bi.frameworkStabilizers||(Bi.frameworkStabilizers=[]),Bi.frameworkStabilizers.push(i=>{const s=Bi.getAllAngularTestabilities();let n=s.length,o=!1;const a=function(l){o=o||l,n--,0==n&&i(o)};s.forEach(function(l){l.whenStable(a)})})}findTestabilityInTree(e,t,i){return null==t?null:e.getTestability(t)??(i?oa().isShadowRoot(t)?this.findTestabilityInTree(e,t.host,!0):this.findTestabilityInTree(e,t.parentElement,!0):null)}},deps:[]},{provide:JD,useClass:ST,deps:[er,ET,Fm]},{provide:ST,useClass:ST,deps:[er,ET,Fm]}],hO=[{provide:rx,useValue:"root"},{provide:ou,useFactory:function $9(){return new ou},deps:[]},{provide:tg,useClass:W9,multi:!0,deps:[Xr,er,vT]},{provide:tg,useClass:Y9,multi:!0,deps:[Xr]},{provide:JT,useClass:JT,deps:[ig,Of,Rf]},{provide:OI,useExisting:JT},{provide:Zw,useExisting:Of},{provide:Of,useClass:Of,deps:[Xr]},{provide:ig,useClass:ig,deps:[tg,er]},{provide:Xw,useClass:L9,deps:[]},[]];let Z9=(()=>{class r{constructor(t){}static withServerTransition(t){return{ngModule:r,providers:[{provide:Rf,useValue:t.appId},{provide:Kw,useExisting:Rf},N9]}}}return r.\u0275fac=function(t){return new(t||r)(tt(lO,12))},r.\u0275mod=io({type:r}),r.\u0275inj=Rn({providers:[...hO,...cO],imports:[Q7,AQ]}),r})(),uO=(()=>{class r{constructor(t){this._doc=t}getTitle(){return this._doc.title}setTitle(t){this._doc.title=t||""}}return r.\u0275fac=function(t){return new(t||r)(tt(Xr))},r.\u0275prov=Tt({token:r,factory:function(t){let i=null;return i=t?new t:function eZ(){return new uO(tt(Xr))}(),i},providedIn:"root"}),r})();function dt(...r){return Vs(r,Fd(r))}typeof window<"u"&&window;class Oo extends Qo{constructor(e){super(),this._value=e}get value(){return this.getValue()}_subscribe(e){const t=super._subscribe(e);return!t.closed&&e.next(this._value),t}getValue(){const{hasError:e,thrownError:t,_value:i}=this;if(e)throw t;return this._throwIfClosed(),i}next(e){super.next(this._value=e)}}const rg=wd(r=>function(){r(this),this.name="EmptyError",this.message="no elements in sequence"}),{isArray:lZ}=Array,{getPrototypeOf:cZ,prototype:hZ,keys:uZ}=Object;function pO(r){if(1===r.length){const e=r[0];if(lZ(e))return{args:e,keys:null};if(function dZ(r){return r&&"object"==typeof r&&cZ(r)===hZ}(e)){const t=uZ(e);return{args:t.map(i=>e[i]),keys:t}}}return{args:r,keys:null}}const{isArray:fZ}=Array;function _O(r){return Wt(e=>function pZ(r,e){return fZ(e)?r(...e):r(e)}(r,e))}function mO(r,e){return r.reduce((t,i,s)=>(t[i]=e[s],t),{})}function gO(...r){const e=Fd(r),t=OA(r),{args:i,keys:s}=pO(r);if(0===i.length)return Vs([],e);const n=new Rs(function _Z(r,e,t=Mc){return i=>{vO(e,()=>{const{length:s}=r,n=new Array(s);let o=s,a=s;for(let l=0;l<s;l++)vO(e,()=>{const c=Vs(r[l],e);let h=!1;c.subscribe(Ks(i,u=>{n[l]=u,h||(h=!0,a--),a||i.next(t(n.slice()))},()=>{--o||i.complete()}))},i)},i)}}(i,e,s?o=>mO(s,o):Mc));return t?n.pipe(_O(t)):n}function vO(r,e,t){r?Ra(t,r,e):e()}function sS(...r){return function mZ(){return Uh(1)}()(Vs(r,Fd(r)))}function bO(r){return new Rs(e=>{yo(r()).subscribe(e)})}function Nf(r,e){const t=Fi(r)?r:()=>r,i=s=>s.error(t());return new Rs(e?s=>e.schedule(i,0,s):i)}function rS(){return ur((r,e)=>{let t=null;r._refCount++;const i=Ks(e,void 0,void 0,void 0,()=>{if(!r||r._refCount<=0||0<--r._refCount)return void(t=null);const s=r._connection,n=t;t=null,s&&(!n||s===n)&&s.unsubscribe(),e.unsubscribe()});r.subscribe(i),i.closed||(t=r.connect())})}class yO extends Rs{constructor(e,t){super(),this.source=e,this.subjectFactory=t,this._subject=null,this._refCount=0,this._connection=null,bA(e)&&(this.lift=e.lift)}_subscribe(e){return this.getSubject().subscribe(e)}getSubject(){const e=this._subject;return(!e||e.isStopped)&&(this._subject=this.subjectFactory()),this._subject}_teardown(){this._refCount=0;const{_connection:e}=this;this._subject=this._connection=null,e?.unsubscribe()}connect(){let e=this._connection;if(!e){e=this._connection=new eo;const t=this.getSubject();e.add(this.source.subscribe(Ks(t,void 0,()=>{this._teardown(),t.complete()},i=>{this._teardown(),t.error(i)},()=>this._teardown()))),e.closed&&(this._connection=null,e=eo.EMPTY)}return e}refCount(){return rS()(this)}}function aa(r,e){return ur((t,i)=>{let s=null,n=0,o=!1;const a=()=>o&&!s&&i.complete();t.subscribe(Ks(i,l=>{s?.unsubscribe();let c=0;const h=n++;yo(r(l,h)).subscribe(s=Ks(i,u=>i.next(e?e(l,u,h,c++):u),()=>{s=null,a()}))},()=>{o=!0,a()}))})}function Ff(r){return r<=0?()=>Ia:ur((e,t)=>{let i=0;e.subscribe(Ks(t,s=>{++i<=r&&(t.next(s),r<=i&&t.complete())}))})}function Xa(r,e){return ur((t,i)=>{let s=0;t.subscribe(Ks(i,n=>r.call(e,n,s++)&&i.next(n)))})}function ng(r){return ur((e,t)=>{let i=!1;e.subscribe(Ks(t,s=>{i=!0,t.next(s)},()=>{i||t.next(r),t.complete()}))})}function xO(r=vZ){return ur((e,t)=>{let i=!1;e.subscribe(Ks(t,s=>{i=!0,t.next(s)},()=>i?t.complete():t.error(r())))})}function vZ(){return new rg}function Vl(r,e){const t=arguments.length>=2;return i=>i.pipe(r?Xa((s,n)=>r(s,n,i)):Mc,Ff(1),t?ng(e):xO(()=>new rg))}function Ul(r,e){return Fi(e)?vr(r,e,1):vr(r,1)}function Ir(r,e,t){const i=Fi(r)||e||t?{next:r,error:e,complete:t}:r;return i?ur((s,n)=>{var o;null===(o=i.subscribe)||void 0===o||o.call(i);let a=!0;s.subscribe(Ks(n,l=>{var c;null===(c=i.next)||void 0===c||c.call(i,l),n.next(l)},()=>{var l;a=!1,null===(l=i.complete)||void 0===l||l.call(i),n.complete()},l=>{var c;a=!1,null===(c=i.error)||void 0===c||c.call(i,l),n.error(l)},()=>{var l,c;a&&(null===(l=i.unsubscribe)||void 0===l||l.call(i)),null===(c=i.finalize)||void 0===c||c.call(i)}))}):Mc}function kl(r){return ur((e,t)=>{let n,i=null,s=!1;i=e.subscribe(Ks(t,void 0,void 0,o=>{n=yo(r(o,kl(r)(e))),i?(i.unsubscribe(),i=null,n.subscribe(t)):s=!0})),s&&(i.unsubscribe(),i=null,n.subscribe(t))})}function bZ(r,e,t,i,s){return(n,o)=>{let a=t,l=e,c=0;n.subscribe(Ks(o,h=>{const u=c++;l=a?r(l,h,u):(a=!0,h),i&&o.next(l)},s&&(()=>{a&&o.next(l),o.complete()})))}}function TO(r,e){return ur(bZ(r,e,arguments.length>=2,!0))}function nS(r){return r<=0?()=>Ia:ur((e,t)=>{let i=[];e.subscribe(Ks(t,s=>{i.push(s),r<i.length&&i.shift()},()=>{for(const s of i)t.next(s);t.complete()},void 0,()=>{i=null}))})}function SO(r,e){const t=arguments.length>=2;return i=>i.pipe(r?Xa((s,n)=>r(s,n,i)):Mc,nS(1),t?ng(e):xO(()=>new rg))}function oS(r){return ur((e,t)=>{try{e.subscribe(t)}finally{t.add(r)}})}const Gt="primary",Lf=Symbol("RouteTitle");class TZ{constructor(e){this.params=e||{}}has(e){return Object.prototype.hasOwnProperty.call(this.params,e)}get(e){if(this.has(e)){const t=this.params[e];return Array.isArray(t)?t[0]:t}return null}getAll(e){if(this.has(e)){const t=this.params[e];return Array.isArray(t)?t:[t]}return[]}get keys(){return Object.keys(this.params)}}function Cu(r){return new TZ(r)}function SZ(r,e,t){const i=t.path.split("/");if(i.length>r.length||"full"===t.pathMatch&&(e.hasChildren()||i.length<r.length))return null;const s={};for(let n=0;n<i.length;n++){const o=i[n],a=r[n];if(o.startsWith(":"))s[o.substring(1)]=a;else if(o!==a.path)return null}return{consumed:r.slice(0,i.length),posParams:s}}function la(r,e){const t=r?Object.keys(r):void 0,i=e?Object.keys(e):void 0;if(!t||!i||t.length!=i.length)return!1;let s;for(let n=0;n<t.length;n++)if(s=t[n],!EO(r[s],e[s]))return!1;return!0}function EO(r,e){if(Array.isArray(r)&&Array.isArray(e)){if(r.length!==e.length)return!1;const t=[...r].sort(),i=[...e].sort();return t.every((s,n)=>i[n]===s)}return r===e}function CO(r){return Array.prototype.concat.apply([],r)}function AO(r){return r.length>0?r[r.length-1]:null}function yr(r,e){for(const t in r)r.hasOwnProperty(t)&&e(r[t],t)}function Gl(r){return Wx(r)?r:gf(r)?Vs(Promise.resolve(r)):dt(r)}const AZ={exact:function MO(r,e,t){if(!jc(r.segments,e.segments)||!og(r.segments,e.segments,t)||r.numberOfChildren!==e.numberOfChildren)return!1;for(const i in e.children)if(!r.children[i]||!MO(r.children[i],e.children[i],t))return!1;return!0},subset:PO},RO={exact:function RZ(r,e){return la(r,e)},subset:function IZ(r,e){return Object.keys(e).length<=Object.keys(r).length&&Object.keys(e).every(t=>EO(r[t],e[t]))},ignored:()=>!0};function IO(r,e,t){return AZ[t.paths](r.root,e.root,t.matrixParams)&&RO[t.queryParams](r.queryParams,e.queryParams)&&!("exact"===t.fragment&&r.fragment!==e.fragment)}function PO(r,e,t){return DO(r,e,e.segments,t)}function DO(r,e,t,i){if(r.segments.length>t.length){const s=r.segments.slice(0,t.length);return!(!jc(s,t)||e.hasChildren()||!og(s,t,i))}if(r.segments.length===t.length){if(!jc(r.segments,t)||!og(r.segments,t,i))return!1;for(const s in e.children)if(!r.children[s]||!PO(r.children[s],e.children[s],i))return!1;return!0}{const s=t.slice(0,r.segments.length),n=t.slice(r.segments.length);return!!(jc(r.segments,s)&&og(r.segments,s,i)&&r.children[Gt])&&DO(r.children[Gt],e,n,i)}}function og(r,e,t){return e.every((i,s)=>RO[t](r[s].parameters,i.parameters))}class Xc{constructor(e,t,i){this.root=e,this.queryParams=t,this.fragment=i}get queryParamMap(){return this._queryParamMap||(this._queryParamMap=Cu(this.queryParams)),this._queryParamMap}toString(){return DZ.serialize(this)}}class Xt{constructor(e,t){this.segments=e,this.children=t,this.parent=null,yr(t,(i,s)=>i.parent=this)}hasChildren(){return this.numberOfChildren>0}get numberOfChildren(){return Object.keys(this.children).length}toString(){return ag(this)}}class Bf{constructor(e,t){this.path=e,this.parameters=t}get parameterMap(){return this._parameterMap||(this._parameterMap=Cu(this.parameters)),this._parameterMap}toString(){return FO(this)}}function jc(r,e){return r.length===e.length&&r.every((t,i)=>t.path===e[i].path)}let wO=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=Tt({token:r,factory:function(){return new lS},providedIn:"root"}),r})();class lS{parse(e){const t=new kZ(e);return new Xc(t.parseRootSegment(),t.parseQueryParams(),t.parseFragment())}serialize(e){const t=`/${Vf(e.root,!0)}`,i=function NZ(r){const e=Object.keys(r).map(t=>{const i=r[t];return Array.isArray(i)?i.map(s=>`${lg(t)}=${lg(s)}`).join("&"):`${lg(t)}=${lg(i)}`}).filter(t=>!!t);return e.length?`?${e.join("&")}`:""}(e.queryParams);return`${t}${i}${"string"==typeof e.fragment?`#${function wZ(r){return encodeURI(r)}(e.fragment)}`:""}`}}const DZ=new lS;function ag(r){return r.segments.map(e=>FO(e)).join("/")}function Vf(r,e){if(!r.hasChildren())return ag(r);if(e){const t=r.children[Gt]?Vf(r.children[Gt],!1):"",i=[];return yr(r.children,(s,n)=>{n!==Gt&&i.push(`${n}:${Vf(s,!1)}`)}),i.length>0?`${t}(${i.join("//")})`:t}{const t=function PZ(r,e){let t=[];return yr(r.children,(i,s)=>{s===Gt&&(t=t.concat(e(i,s)))}),yr(r.children,(i,s)=>{s!==Gt&&(t=t.concat(e(i,s)))}),t}(r,(i,s)=>s===Gt?[Vf(r.children[Gt],!1)]:[`${s}:${Vf(i,!1)}`]);return 1===Object.keys(r.children).length&&null!=r.children[Gt]?`${ag(r)}/${t[0]}`:`${ag(r)}/(${t.join("//")})`}}function OO(r){return encodeURIComponent(r).replace(/%40/g,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",")}function lg(r){return OO(r).replace(/%3B/gi,";")}function cS(r){return OO(r).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/%26/gi,"&")}function cg(r){return decodeURIComponent(r)}function NO(r){return cg(r.replace(/\+/g,"%20"))}function FO(r){return`${cS(r.path)}${function OZ(r){return Object.keys(r).map(e=>`;${cS(e)}=${cS(r[e])}`).join("")}(r.parameters)}`}const FZ=/^[^\/()?;=#]+/;function hg(r){const e=r.match(FZ);return e?e[0]:""}const LZ=/^[^=?&#]+/,VZ=/^[^&#]+/;class kZ{constructor(e){this.url=e,this.remaining=e}parseRootSegment(){return this.consumeOptional("/"),""===this.remaining||this.peekStartsWith("?")||this.peekStartsWith("#")?new Xt([],{}):new Xt([],this.parseChildren())}parseQueryParams(){const e={};if(this.consumeOptional("?"))do{this.parseQueryParam(e)}while(this.consumeOptional("&"));return e}parseFragment(){return this.consumeOptional("#")?decodeURIComponent(this.remaining):null}parseChildren(){if(""===this.remaining)return{};this.consumeOptional("/");const e=[];for(this.peekStartsWith("(")||e.push(this.parseSegment());this.peekStartsWith("/")&&!this.peekStartsWith("//")&&!this.peekStartsWith("/(");)this.capture("/"),e.push(this.parseSegment());let t={};this.peekStartsWith("/(")&&(this.capture("/"),t=this.parseParens(!0));let i={};return this.peekStartsWith("(")&&(i=this.parseParens(!1)),(e.length>0||Object.keys(t).length>0)&&(i[Gt]=new Xt(e,t)),i}parseSegment(){const e=hg(this.remaining);if(""===e&&this.peekStartsWith(";"))throw new Ne(4009,!1);return this.capture(e),new Bf(cg(e),this.parseMatrixParams())}parseMatrixParams(){const e={};for(;this.consumeOptional(";");)this.parseParam(e);return e}parseParam(e){const t=hg(this.remaining);if(!t)return;this.capture(t);let i="";if(this.consumeOptional("=")){const s=hg(this.remaining);s&&(i=s,this.capture(i))}e[cg(t)]=cg(i)}parseQueryParam(e){const t=function BZ(r){const e=r.match(LZ);return e?e[0]:""}(this.remaining);if(!t)return;this.capture(t);let i="";if(this.consumeOptional("=")){const o=function UZ(r){const e=r.match(VZ);return e?e[0]:""}(this.remaining);o&&(i=o,this.capture(i))}const s=NO(t),n=NO(i);if(e.hasOwnProperty(s)){let o=e[s];Array.isArray(o)||(o=[o],e[s]=o),o.push(n)}else e[s]=n}parseParens(e){const t={};for(this.capture("(");!this.consumeOptional(")")&&this.remaining.length>0;){const i=hg(this.remaining),s=this.remaining[i.length];if("/"!==s&&")"!==s&&";"!==s)throw new Ne(4010,!1);let n;i.indexOf(":")>-1?(n=i.slice(0,i.indexOf(":")),this.capture(n),this.capture(":")):e&&(n=Gt);const o=this.parseChildren();t[n]=1===Object.keys(o).length?o[Gt]:new Xt([],o),this.consumeOptional("//")}return t}peekStartsWith(e){return this.remaining.startsWith(e)}consumeOptional(e){return!!this.peekStartsWith(e)&&(this.remaining=this.remaining.substring(e.length),!0)}capture(e){if(!this.consumeOptional(e))throw new Ne(4011,!1)}}function hS(r){return r.segments.length>0?new Xt([],{[Gt]:r}):r}function ug(r){const e={};for(const i of Object.keys(r.children)){const n=ug(r.children[i]);(n.segments.length>0||n.hasChildren())&&(e[i]=n)}return function GZ(r){if(1===r.numberOfChildren&&r.children[Gt]){const e=r.children[Gt];return new Xt(r.segments.concat(e.segments),e.children)}return r}(new Xt(r.segments,e))}function Yc(r){return r instanceof Xc}function WZ(r,e,t,i,s){if(0===t.length)return Au(e.root,e.root,e.root,i,s);const n=function VO(r){if("string"==typeof r[0]&&1===r.length&&"/"===r[0])return new BO(!0,0,r);let e=0,t=!1;const i=r.reduce((s,n,o)=>{if("object"==typeof n&&null!=n){if(n.outlets){const a={};return yr(n.outlets,(l,c)=>{a[c]="string"==typeof l?l.split("/"):l}),[...s,{outlets:a}]}if(n.segmentPath)return[...s,n.segmentPath]}return"string"!=typeof n?[...s,n]:0===o?(n.split("/").forEach((a,l)=>{0==l&&"."===a||(0==l&&""===a?t=!0:".."===a?e++:""!=a&&s.push(a))}),s):[...s,n]},[]);return new BO(t,e,i)}(t);return n.toRoot()?Au(e.root,e.root,new Xt([],{}),i,s):function o(l){const c=function jZ(r,e,t,i){if(r.isAbsolute)return new Ru(e.root,!0,0);if(-1===i)return new Ru(t,t===e.root,0);return function UO(r,e,t){let i=r,s=e,n=t;for(;n>s;){if(n-=s,i=i.parent,!i)throw new Ne(4005,!1);s=i.segments.length}return new Ru(i,!1,s-n)}(t,i+(Uf(r.commands[0])?0:1),r.numberOfDoubleDots)}(n,e,r.snapshot?._urlSegment,l),h=c.processChildren?Gf(c.segmentGroup,c.index,n.commands):dS(c.segmentGroup,c.index,n.commands);return Au(e.root,c.segmentGroup,h,i,s)}(r.snapshot?._lastPathIndex)}function Uf(r){return"object"==typeof r&&null!=r&&!r.outlets&&!r.segmentPath}function kf(r){return"object"==typeof r&&null!=r&&r.outlets}function Au(r,e,t,i,s){let o,n={};i&&yr(i,(l,c)=>{n[c]=Array.isArray(l)?l.map(h=>`${h}`):`${l}`}),o=r===e?t:LO(r,e,t);const a=hS(ug(o));return new Xc(a,n,s)}function LO(r,e,t){const i={};return yr(r.children,(s,n)=>{i[n]=s===e?t:LO(s,e,t)}),new Xt(r.segments,i)}class BO{constructor(e,t,i){if(this.isAbsolute=e,this.numberOfDoubleDots=t,this.commands=i,e&&i.length>0&&Uf(i[0]))throw new Ne(4003,!1);const s=i.find(kf);if(s&&s!==AO(i))throw new Ne(4004,!1)}toRoot(){return this.isAbsolute&&1===this.commands.length&&"/"==this.commands[0]}}class Ru{constructor(e,t,i){this.segmentGroup=e,this.processChildren=t,this.index=i}}function dS(r,e,t){if(r||(r=new Xt([],{})),0===r.segments.length&&r.hasChildren())return Gf(r,e,t);const i=function qZ(r,e,t){let i=0,s=e;const n={match:!1,pathIndex:0,commandIndex:0};for(;s<r.segments.length;){if(i>=t.length)return n;const o=r.segments[s],a=t[i];if(kf(a))break;const l=`${a}`,c=i<t.length-1?t[i+1]:null;if(s>0&&void 0===l)break;if(l&&c&&"object"==typeof c&&void 0===c.outlets){if(!GO(l,c,o))return n;i+=2}else{if(!GO(l,{},o))return n;i++}s++}return{match:!0,pathIndex:s,commandIndex:i}}(r,e,t),s=t.slice(i.commandIndex);if(i.match&&i.pathIndex<r.segments.length){const n=new Xt(r.segments.slice(0,i.pathIndex),{});return n.children[Gt]=new Xt(r.segments.slice(i.pathIndex),r.children),Gf(n,0,s)}return i.match&&0===s.length?new Xt(r.segments,{}):i.match&&!r.hasChildren()?fS(r,e,t):i.match?Gf(r,0,s):fS(r,e,t)}function Gf(r,e,t){if(0===t.length)return new Xt(r.segments,{});{const i=function YZ(r){return kf(r[0])?r[0].outlets:{[Gt]:r}}(t),s={};return yr(i,(n,o)=>{"string"==typeof n&&(n=[n]),null!==n&&(s[o]=dS(r.children[o],e,n))}),yr(r.children,(n,o)=>{void 0===i[o]&&(s[o]=n)}),new Xt(r.segments,s)}}function fS(r,e,t){const i=r.segments.slice(0,e);let s=0;for(;s<t.length;){const n=t[s];if(kf(n)){const l=$Z(n.outlets);return new Xt(i,l)}if(0===s&&Uf(t[0])){i.push(new Bf(r.segments[e].path,kO(t[0]))),s++;continue}const o=kf(n)?n.outlets[Gt]:`${n}`,a=s<t.length-1?t[s+1]:null;o&&a&&Uf(a)?(i.push(new Bf(o,kO(a))),s+=2):(i.push(new Bf(o,{})),s++)}return new Xt(i,{})}function $Z(r){const e={};return yr(r,(t,i)=>{"string"==typeof t&&(t=[t]),null!==t&&(e[i]=fS(new Xt([],{}),0,t))}),e}function kO(r){const e={};return yr(r,(t,i)=>e[i]=`${t}`),e}function GO(r,e,t){return r==t.path&&la(e,t.parameters)}class ja{constructor(e,t){this.id=e,this.url=t}}class pS extends ja{constructor(e,t,i="imperative",s=null){super(e,t),this.type=0,this.navigationTrigger=i,this.restoredState=s}toString(){return`NavigationStart(id: ${this.id}, url: '${this.url}')`}}class qc extends ja{constructor(e,t,i){super(e,t),this.urlAfterRedirects=i,this.type=1}toString(){return`NavigationEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}')`}}class dg extends ja{constructor(e,t,i,s){super(e,t),this.reason=i,this.code=s,this.type=2}toString(){return`NavigationCancel(id: ${this.id}, url: '${this.url}')`}}class zO extends ja{constructor(e,t,i,s){super(e,t),this.error=i,this.target=s,this.type=3}toString(){return`NavigationError(id: ${this.id}, url: '${this.url}', error: ${this.error})`}}class KZ extends ja{constructor(e,t,i,s){super(e,t),this.urlAfterRedirects=i,this.state=s,this.type=4}toString(){return`RoutesRecognized(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}}class QZ extends ja{constructor(e,t,i,s){super(e,t),this.urlAfterRedirects=i,this.state=s,this.type=7}toString(){return`GuardsCheckStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}}class ZZ extends ja{constructor(e,t,i,s,n){super(e,t),this.urlAfterRedirects=i,this.state=s,this.shouldActivate=n,this.type=8}toString(){return`GuardsCheckEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state}, shouldActivate: ${this.shouldActivate})`}}class JZ extends ja{constructor(e,t,i,s){super(e,t),this.urlAfterRedirects=i,this.state=s,this.type=5}toString(){return`ResolveStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}}class eJ extends ja{constructor(e,t,i,s){super(e,t),this.urlAfterRedirects=i,this.state=s,this.type=6}toString(){return`ResolveEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}}class tJ{constructor(e){this.route=e,this.type=9}toString(){return`RouteConfigLoadStart(path: ${this.route.path})`}}class iJ{constructor(e){this.route=e,this.type=10}toString(){return`RouteConfigLoadEnd(path: ${this.route.path})`}}class sJ{constructor(e){this.snapshot=e,this.type=11}toString(){return`ChildActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}}class rJ{constructor(e){this.snapshot=e,this.type=12}toString(){return`ChildActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}}class nJ{constructor(e){this.snapshot=e,this.type=13}toString(){return`ActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}}class oJ{constructor(e){this.snapshot=e,this.type=14}toString(){return`ActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}}class HO{constructor(e,t,i){this.routerEvent=e,this.position=t,this.anchor=i,this.type=15}toString(){return`Scroll(anchor: '${this.anchor}', position: '${this.position?`${this.position[0]}, ${this.position[1]}`:null}')`}}class WO{constructor(e){this._root=e}get root(){return this._root.value}parent(e){const t=this.pathFromRoot(e);return t.length>1?t[t.length-2]:null}children(e){const t=_S(e,this._root);return t?t.children.map(i=>i.value):[]}firstChild(e){const t=_S(e,this._root);return t&&t.children.length>0?t.children[0].value:null}siblings(e){const t=mS(e,this._root);return t.length<2?[]:t[t.length-2].children.map(s=>s.value).filter(s=>s!==e)}pathFromRoot(e){return mS(e,this._root).map(t=>t.value)}}function _S(r,e){if(r===e.value)return e;for(const t of e.children){const i=_S(r,t);if(i)return i}return null}function mS(r,e){if(r===e.value)return[e];for(const t of e.children){const i=mS(r,t);if(i.length)return i.unshift(e),i}return[]}class Ya{constructor(e,t){this.value=e,this.children=t}toString(){return`TreeNode(${this.value})`}}function Iu(r){const e={};return r&&r.children.forEach(t=>e[t.value.outlet]=t),e}class XO extends WO{constructor(e,t){super(e),this.snapshot=t,gS(this,e)}toString(){return this.snapshot.toString()}}function jO(r,e){const t=function lJ(r,e){const o=new fg([],{},{},"",{},Gt,e,null,r.root,-1,{});return new qO("",new Ya(o,[]))}(r,e),i=new Oo([new Bf("",{})]),s=new Oo({}),n=new Oo({}),o=new Oo({}),a=new Oo(""),l=new zl(i,s,o,a,n,Gt,e,t.root);return l.snapshot=t.root,new XO(new Ya(l,[]),t)}class zl{constructor(e,t,i,s,n,o,a,l){this.url=e,this.params=t,this.queryParams=i,this.fragment=s,this.data=n,this.outlet=o,this.component=a,this.title=this.data?.pipe(Wt(c=>c[Lf]))??dt(void 0),this._futureSnapshot=l}get routeConfig(){return this._futureSnapshot.routeConfig}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap||(this._paramMap=this.params.pipe(Wt(e=>Cu(e)))),this._paramMap}get queryParamMap(){return this._queryParamMap||(this._queryParamMap=this.queryParams.pipe(Wt(e=>Cu(e)))),this._queryParamMap}toString(){return this.snapshot?this.snapshot.toString():`Future(${this._futureSnapshot})`}}function YO(r,e="emptyOnly"){const t=r.pathFromRoot;let i=0;if("always"!==e)for(i=t.length-1;i>=1;){const s=t[i],n=t[i-1];if(s.routeConfig&&""===s.routeConfig.path)i--;else{if(n.component)break;i--}}return function cJ(r){return r.reduce((e,t)=>({params:{...e.params,...t.params},data:{...e.data,...t.data},resolve:{...t.data,...e.resolve,...t.routeConfig?.data,...t._resolvedData}}),{params:{},data:{},resolve:{}})}(t.slice(i))}class fg{constructor(e,t,i,s,n,o,a,l,c,h,u,d){this.url=e,this.params=t,this.queryParams=i,this.fragment=s,this.data=n,this.outlet=o,this.component=a,this.title=this.data?.[Lf],this.routeConfig=l,this._urlSegment=c,this._lastPathIndex=h,this._correctedLastPathIndex=d??h,this._resolve=u}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap||(this._paramMap=Cu(this.params)),this._paramMap}get queryParamMap(){return this._queryParamMap||(this._queryParamMap=Cu(this.queryParams)),this._queryParamMap}toString(){return`Route(url:'${this.url.map(i=>i.toString()).join("/")}', path:'${this.routeConfig?this.routeConfig.path:""}')`}}class qO extends WO{constructor(e,t){super(t),this.url=e,gS(this,t)}toString(){return $O(this._root)}}function gS(r,e){e.value._routerState=r,e.children.forEach(t=>gS(r,t))}function $O(r){const e=r.children.length>0?` { ${r.children.map($O).join(", ")} } `:"";return`${r.value}${e}`}function vS(r){if(r.snapshot){const e=r.snapshot,t=r._futureSnapshot;r.snapshot=t,la(e.queryParams,t.queryParams)||r.queryParams.next(t.queryParams),e.fragment!==t.fragment&&r.fragment.next(t.fragment),la(e.params,t.params)||r.params.next(t.params),function EZ(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;++t)if(!la(r[t],e[t]))return!1;return!0}(e.url,t.url)||r.url.next(t.url),la(e.data,t.data)||r.data.next(t.data)}else r.snapshot=r._futureSnapshot,r.data.next(r._futureSnapshot.data)}function bS(r,e){const t=la(r.params,e.params)&&function MZ(r,e){return jc(r,e)&&r.every((t,i)=>la(t.parameters,e[i].parameters))}(r.url,e.url);return t&&!(!r.parent!=!e.parent)&&(!r.parent||bS(r.parent,e.parent))}function zf(r,e,t){if(t&&r.shouldReuseRoute(e.value,t.value.snapshot)){const i=t.value;i._futureSnapshot=e.value;const s=function uJ(r,e,t){return e.children.map(i=>{for(const s of t.children)if(r.shouldReuseRoute(i.value,s.value.snapshot))return zf(r,i,s);return zf(r,i)})}(r,e,t);return new Ya(i,s)}{if(r.shouldAttach(e.value)){const n=r.retrieve(e.value);if(null!==n){const o=n.route;return o.value._futureSnapshot=e.value,o.children=e.children.map(a=>zf(r,a)),o}}const i=function dJ(r){return new zl(new Oo(r.url),new Oo(r.params),new Oo(r.queryParams),new Oo(r.fragment),new Oo(r.data),r.outlet,r.component,r)}(e.value),s=e.children.map(n=>zf(r,n));return new Ya(i,s)}}const yS="ngNavigationCancelingError";function KO(r,e){const{redirectTo:t,navigationBehaviorOptions:i}=Yc(e)?{redirectTo:e,navigationBehaviorOptions:void 0}:e,s=QO(!1,0,e);return s.url=t,s.navigationBehaviorOptions=i,s}function QO(r,e,t){const i=new Error("NavigationCancelingError: "+(r||""));return i[yS]=!0,i.cancellationCode=e,t&&(i.url=t),i}function ZO(r){return JO(r)&&Yc(r.url)}function JO(r){return r&&r[yS]}class fJ{constructor(){this.outlet=null,this.route=null,this.resolver=null,this.injector=null,this.children=new Hf,this.attachRef=null}}let Hf=(()=>{class r{constructor(){this.contexts=new Map}onChildOutletCreated(t,i){const s=this.getOrCreateContext(t);s.outlet=i,this.contexts.set(t,s)}onChildOutletDestroyed(t){const i=this.getContext(t);i&&(i.outlet=null,i.attachRef=null)}onOutletDeactivated(){const t=this.contexts;return this.contexts=new Map,t}onOutletReAttached(t){this.contexts=t}getOrCreateContext(t){let i=this.getContext(t);return i||(i=new fJ,this.contexts.set(t,i)),i}getContext(t){return this.contexts.get(t)||null}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=Tt({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();const pg=!1;let xS=(()=>{class r{constructor(t,i,s,n,o){this.parentContexts=t,this.location=i,this.changeDetector=n,this.environmentInjector=o,this.activated=null,this._activatedRoute=null,this.activateEvents=new Ts,this.deactivateEvents=new Ts,this.attachEvents=new Ts,this.detachEvents=new Ts,this.name=s||Gt,t.onChildOutletCreated(this.name,this)}ngOnDestroy(){this.parentContexts.getContext(this.name)?.outlet===this&&this.parentContexts.onChildOutletDestroyed(this.name)}ngOnInit(){if(!this.activated){const t=this.parentContexts.getContext(this.name);t&&t.route&&(t.attachRef?this.attach(t.attachRef,t.route):this.activateWith(t.route,t.injector))}}get isActivated(){return!!this.activated}get component(){if(!this.activated)throw new Ne(4012,pg);return this.activated.instance}get activatedRoute(){if(!this.activated)throw new Ne(4012,pg);return this._activatedRoute}get activatedRouteData(){return this._activatedRoute?this._activatedRoute.snapshot.data:{}}detach(){if(!this.activated)throw new Ne(4012,pg);this.location.detach();const t=this.activated;return this.activated=null,this._activatedRoute=null,this.detachEvents.emit(t.instance),t}attach(t,i){this.activated=t,this._activatedRoute=i,this.location.insert(t.hostView),this.attachEvents.emit(t.instance)}deactivate(){if(this.activated){const t=this.component;this.activated.destroy(),this.activated=null,this._activatedRoute=null,this.deactivateEvents.emit(t)}}activateWith(t,i){if(this.isActivated)throw new Ne(4013,pg);this._activatedRoute=t;const s=this.location,o=t._futureSnapshot.component,a=this.parentContexts.getOrCreateContext(this.name).children,l=new pJ(t,a,s.injector);if(i&&function _J(r){return!!r.resolveComponentFactory}(i)){const c=i.resolveComponentFactory(o);this.activated=s.createComponent(c,s.length,l)}else this.activated=s.createComponent(o,{index:s.length,injector:l,environmentInjector:i??this.environmentInjector});this.changeDetector.markForCheck(),this.activateEvents.emit(this.activated.instance)}}return r.\u0275fac=function(t){return new(t||r)(xe(Hf),xe(Mo),function jd(r){return function t6(r,e){if("class"===e)return r.classes;if("style"===e)return r.styles;const t=r.attrs;if(t){const i=t.length;let s=0;for(;s<i;){const n=t[s];if(hR(n))break;if(0===n)s+=2;else if("number"==typeof n)for(s++;s<i&&"string"==typeof t[s];)s++;else{if(n===e)return t[s+1];s+=2}}}return null}(Qs(),r)}("name"),xe(Vm),xe(Ol))},r.\u0275dir=St({type:r,selectors:[["router-outlet"]],outputs:{activateEvents:"activate",deactivateEvents:"deactivate",attachEvents:"attach",detachEvents:"detach"},exportAs:["outlet"],standalone:!0}),r})();class pJ{constructor(e,t,i){this.route=e,this.childContexts=t,this.parent=i}get(e,t){return e===zl?this.route:e===Hf?this.childContexts:this.parent.get(e,t)}}let TS=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275cmp=Il({type:r,selectors:[["ng-component"]],standalone:!0,features:[lD],decls:1,vars:0,template:function(t,i){1&t&&oi(0,"router-outlet")},dependencies:[xS],encapsulation:2}),r})();function eN(r,e){return r.providers&&!r._injector&&(r._injector=Mm(r.providers,e,`Route: ${r.path}`)),r._injector??e}function ES(r){const e=r.children&&r.children.map(ES),t=e?{...r,children:e}:{...r};return!t.component&&!t.loadComponent&&(e||t.loadChildren)&&t.outlet&&t.outlet!==Gt&&(t.component=TS),t}function co(r){return r.outlet||Gt}function tN(r,e){const t=r.filter(i=>co(i)===e);return t.push(...r.filter(i=>co(i)!==e)),t}function Wf(r){if(!r)return null;if(r.routeConfig?._injector)return r.routeConfig._injector;for(let e=r.parent;e;e=e.parent){const t=e.routeConfig;if(t?._loadedInjector)return t._loadedInjector;if(t?._injector)return t._injector}return null}class yJ{constructor(e,t,i,s){this.routeReuseStrategy=e,this.futureState=t,this.currState=i,this.forwardEvent=s}activate(e){const t=this.futureState._root,i=this.currState?this.currState._root:null;this.deactivateChildRoutes(t,i,e),vS(this.futureState.root),this.activateChildRoutes(t,i,e)}deactivateChildRoutes(e,t,i){const s=Iu(t);e.children.forEach(n=>{const o=n.value.outlet;this.deactivateRoutes(n,s[o],i),delete s[o]}),yr(s,(n,o)=>{this.deactivateRouteAndItsChildren(n,i)})}deactivateRoutes(e,t,i){const s=e.value,n=t?t.value:null;if(s===n)if(s.component){const o=i.getContext(s.outlet);o&&this.deactivateChildRoutes(e,t,o.children)}else this.deactivateChildRoutes(e,t,i);else n&&this.deactivateRouteAndItsChildren(t,i)}deactivateRouteAndItsChildren(e,t){e.value.component&&this.routeReuseStrategy.shouldDetach(e.value.snapshot)?this.detachAndStoreRouteSubtree(e,t):this.deactivateRouteAndOutlet(e,t)}detachAndStoreRouteSubtree(e,t){const i=t.getContext(e.value.outlet),s=i&&e.value.component?i.children:t,n=Iu(e);for(const o of Object.keys(n))this.deactivateRouteAndItsChildren(n[o],s);if(i&&i.outlet){const o=i.outlet.detach(),a=i.children.onOutletDeactivated();this.routeReuseStrategy.store(e.value.snapshot,{componentRef:o,route:e,contexts:a})}}deactivateRouteAndOutlet(e,t){const i=t.getContext(e.value.outlet),s=i&&e.value.component?i.children:t,n=Iu(e);for(const o of Object.keys(n))this.deactivateRouteAndItsChildren(n[o],s);i&&i.outlet&&(i.outlet.deactivate(),i.children.onOutletDeactivated(),i.attachRef=null,i.resolver=null,i.route=null)}activateChildRoutes(e,t,i){const s=Iu(t);e.children.forEach(n=>{this.activateRoutes(n,s[n.value.outlet],i),this.forwardEvent(new oJ(n.value.snapshot))}),e.children.length&&this.forwardEvent(new rJ(e.value.snapshot))}activateRoutes(e,t,i){const s=e.value,n=t?t.value:null;if(vS(s),s===n)if(s.component){const o=i.getOrCreateContext(s.outlet);this.activateChildRoutes(e,t,o.children)}else this.activateChildRoutes(e,t,i);else if(s.component){const o=i.getOrCreateContext(s.outlet);if(this.routeReuseStrategy.shouldAttach(s.snapshot)){const a=this.routeReuseStrategy.retrieve(s.snapshot);this.routeReuseStrategy.store(s.snapshot,null),o.children.onOutletReAttached(a.contexts),o.attachRef=a.componentRef,o.route=a.route.value,o.outlet&&o.outlet.attach(a.componentRef,a.route.value),vS(a.route.value),this.activateChildRoutes(e,null,o.children)}else{const a=Wf(s.snapshot),l=a?.get(uf)??null;o.attachRef=null,o.route=s,o.resolver=l,o.injector=a,o.outlet&&o.outlet.activateWith(s,o.injector),this.activateChildRoutes(e,null,o.children)}}else this.activateChildRoutes(e,null,i)}}class iN{constructor(e){this.path=e,this.route=this.path[this.path.length-1]}}class _g{constructor(e,t){this.component=e,this.route=t}}function xJ(r,e,t){const i=r._root;return Xf(i,e?e._root:null,t,[i.value])}function Mu(r,e){const t=Symbol(),i=e.get(r,t);return i===t?"function"!=typeof r||function iX(r){return null!==w_(r)}(r)?e.get(r):r:i}function Xf(r,e,t,i,s={canDeactivateChecks:[],canActivateChecks:[]}){const n=Iu(e);return r.children.forEach(o=>{(function SJ(r,e,t,i,s={canDeactivateChecks:[],canActivateChecks:[]}){const n=r.value,o=e?e.value:null,a=t?t.getContext(r.value.outlet):null;if(o&&n.routeConfig===o.routeConfig){const l=function EJ(r,e,t){if("function"==typeof t)return t(r,e);switch(t){case"pathParamsChange":return!jc(r.url,e.url);case"pathParamsOrQueryParamsChange":return!jc(r.url,e.url)||!la(r.queryParams,e.queryParams);case"always":return!0;case"paramsOrQueryParamsChange":return!bS(r,e)||!la(r.queryParams,e.queryParams);default:return!bS(r,e)}}(o,n,n.routeConfig.runGuardsAndResolvers);l?s.canActivateChecks.push(new iN(i)):(n.data=o.data,n._resolvedData=o._resolvedData),Xf(r,e,n.component?a?a.children:null:t,i,s),l&&a&&a.outlet&&a.outlet.isActivated&&s.canDeactivateChecks.push(new _g(a.outlet.component,o))}else o&&jf(e,a,s),s.canActivateChecks.push(new iN(i)),Xf(r,null,n.component?a?a.children:null:t,i,s)})(o,n[o.value.outlet],t,i.concat([o.value]),s),delete n[o.value.outlet]}),yr(n,(o,a)=>jf(o,t.getContext(a),s)),s}function jf(r,e,t){const i=Iu(r),s=r.value;yr(i,(n,o)=>{jf(n,s.component?e?e.children.getContext(o):null:e,t)}),t.canDeactivateChecks.push(new _g(s.component&&e&&e.outlet&&e.outlet.isActivated?e.outlet.component:null,s))}function Yf(r){return"function"==typeof r}function CS(r){return r instanceof rg||"EmptyError"===r?.name}const mg=Symbol("INITIAL_VALUE");function Pu(){return aa(r=>gO(r.map(e=>e.pipe(Ff(1),function gZ(...r){const e=Fd(r);return ur((t,i)=>{(e?sS(r,t,e):sS(r,t)).subscribe(i)})}(mg)))).pipe(Wt(e=>{for(const t of e)if(!0!==t){if(t===mg)return mg;if(!1===t||t instanceof Xc)return t}return!0}),Xa(e=>e!==mg),Ff(1)))}function sN(r){return function x5(...r){return mA(r)}(Ir(e=>{if(Yc(e))throw KO(0,e)}),Wt(e=>!0===e))}const AS={matched:!1,consumedSegments:[],remainingSegments:[],parameters:{},positionalParamSegments:{}};function rN(r,e,t,i,s){const n=RS(r,e,t);return n.matched?function GJ(r,e,t,i){const s=e.canMatch;return s&&0!==s.length?dt(s.map(o=>{const a=Mu(o,r);return Gl(function PJ(r){return r&&Yf(r.canMatch)}(a)?a.canMatch(e,t):r.runInContext(()=>a(e,t)))})).pipe(Pu(),sN()):dt(!0)}(i=eN(e,i),e,t).pipe(Wt(o=>!0===o?n:{...AS})):dt(n)}function RS(r,e,t){if(""===e.path)return"full"===e.pathMatch&&(r.hasChildren()||t.length>0)?{...AS}:{matched:!0,consumedSegments:[],remainingSegments:t,parameters:{},positionalParamSegments:{}};const s=(e.matcher||SZ)(t,r,e);if(!s)return{...AS};const n={};yr(s.posParams,(a,l)=>{n[l]=a.path});const o=s.consumed.length>0?{...n,...s.consumed[s.consumed.length-1].parameters}:n;return{matched:!0,consumedSegments:s.consumed,remainingSegments:t.slice(s.consumed.length),parameters:o,positionalParamSegments:s.posParams??{}}}function gg(r,e,t,i,s="corrected"){if(t.length>0&&function WJ(r,e,t){return t.some(i=>vg(r,e,i)&&co(i)!==Gt)}(r,t,i)){const o=new Xt(e,function HJ(r,e,t,i){const s={};s[Gt]=i,i._sourceSegment=r,i._segmentIndexShift=e.length;for(const n of t)if(""===n.path&&co(n)!==Gt){const o=new Xt([],{});o._sourceSegment=r,o._segmentIndexShift=e.length,s[co(n)]=o}return s}(r,e,i,new Xt(t,r.children)));return o._sourceSegment=r,o._segmentIndexShift=e.length,{segmentGroup:o,slicedSegments:[]}}if(0===t.length&&function XJ(r,e,t){return t.some(i=>vg(r,e,i))}(r,t,i)){const o=new Xt(r.segments,function zJ(r,e,t,i,s,n){const o={};for(const a of i)if(vg(r,t,a)&&!s[co(a)]){const l=new Xt([],{});l._sourceSegment=r,l._segmentIndexShift="legacy"===n?r.segments.length:e.length,o[co(a)]=l}return{...s,...o}}(r,e,t,i,r.children,s));return o._sourceSegment=r,o._segmentIndexShift=e.length,{segmentGroup:o,slicedSegments:t}}const n=new Xt(r.segments,r.children);return n._sourceSegment=r,n._segmentIndexShift=e.length,{segmentGroup:n,slicedSegments:t}}function vg(r,e,t){return(!(r.hasChildren()||e.length>0)||"full"!==t.pathMatch)&&""===t.path}function nN(r,e,t,i){return!!(co(r)===i||i!==Gt&&vg(e,t,r))&&("**"===r.path||RS(e,r,t).matched)}function oN(r,e,t){return 0===e.length&&!r.children[t]}const bg=!1;class yg{constructor(e){this.segmentGroup=e||null}}class aN{constructor(e){this.urlTree=e}}function qf(r){return Nf(new yg(r))}function lN(r){return Nf(new aN(r))}class $J{constructor(e,t,i,s,n){this.injector=e,this.configLoader=t,this.urlSerializer=i,this.urlTree=s,this.config=n,this.allowRedirects=!0}apply(){const e=gg(this.urlTree.root,[],[],this.config).segmentGroup,t=new Xt(e.segments,e.children);return this.expandSegmentGroup(this.injector,this.config,t,Gt).pipe(Wt(n=>this.createUrlTree(ug(n),this.urlTree.queryParams,this.urlTree.fragment))).pipe(kl(n=>{if(n instanceof aN)return this.allowRedirects=!1,this.match(n.urlTree);throw n instanceof yg?this.noMatchError(n):n}))}match(e){return this.expandSegmentGroup(this.injector,this.config,e.root,Gt).pipe(Wt(s=>this.createUrlTree(ug(s),e.queryParams,e.fragment))).pipe(kl(s=>{throw s instanceof yg?this.noMatchError(s):s}))}noMatchError(e){return new Ne(4002,bg)}createUrlTree(e,t,i){const s=hS(e);return new Xc(s,t,i)}expandSegmentGroup(e,t,i,s){return 0===i.segments.length&&i.hasChildren()?this.expandChildren(e,t,i).pipe(Wt(n=>new Xt([],n))):this.expandSegment(e,i,t,i.segments,s,!0)}expandChildren(e,t,i){const s=[];for(const n of Object.keys(i.children))"primary"===n?s.unshift(n):s.push(n);return Vs(s).pipe(Ul(n=>{const o=i.children[n],a=tN(t,n);return this.expandSegmentGroup(e,a,o,n).pipe(Wt(l=>({segment:l,outlet:n})))}),TO((n,o)=>(n[o.outlet]=o.segment,n),{}),SO())}expandSegment(e,t,i,s,n,o){return Vs(i).pipe(Ul(a=>this.expandSegmentAgainstRoute(e,t,i,a,s,n,o).pipe(kl(c=>{if(c instanceof yg)return dt(null);throw c}))),Vl(a=>!!a),kl((a,l)=>{if(CS(a))return oN(t,s,n)?dt(new Xt([],{})):qf(t);throw a}))}expandSegmentAgainstRoute(e,t,i,s,n,o,a){return nN(s,t,n,o)?void 0===s.redirectTo?this.matchSegmentAgainstRoute(e,t,s,n,o):a&&this.allowRedirects?this.expandSegmentAgainstRouteUsingRedirect(e,t,i,s,n,o):qf(t):qf(t)}expandSegmentAgainstRouteUsingRedirect(e,t,i,s,n,o){return"**"===s.path?this.expandWildCardWithParamsAgainstRouteUsingRedirect(e,i,s,o):this.expandRegularSegmentAgainstRouteUsingRedirect(e,t,i,s,n,o)}expandWildCardWithParamsAgainstRouteUsingRedirect(e,t,i,s){const n=this.applyRedirectCommands([],i.redirectTo,{});return i.redirectTo.startsWith("/")?lN(n):this.lineralizeSegments(i,n).pipe(vr(o=>{const a=new Xt(o,{});return this.expandSegment(e,a,t,o,s,!1)}))}expandRegularSegmentAgainstRouteUsingRedirect(e,t,i,s,n,o){const{matched:a,consumedSegments:l,remainingSegments:c,positionalParamSegments:h}=RS(t,s,n);if(!a)return qf(t);const u=this.applyRedirectCommands(l,s.redirectTo,h);return s.redirectTo.startsWith("/")?lN(u):this.lineralizeSegments(s,u).pipe(vr(d=>this.expandSegment(e,t,i,d.concat(c),o,!1)))}matchSegmentAgainstRoute(e,t,i,s,n){return"**"===i.path?(e=eN(i,e),i.loadChildren?(i._loadedRoutes?dt({routes:i._loadedRoutes,injector:i._loadedInjector}):this.configLoader.loadChildren(e,i)).pipe(Wt(a=>(i._loadedRoutes=a.routes,i._loadedInjector=a.injector,new Xt(s,{})))):dt(new Xt(s,{}))):rN(t,i,s,e).pipe(aa(({matched:o,consumedSegments:a,remainingSegments:l})=>o?this.getChildConfig(e=i._injector??e,i,s).pipe(vr(h=>{const u=h.injector??e,d=h.routes,{segmentGroup:f,slicedSegments:p}=gg(t,a,l,d),_=new Xt(f.segments,f.children);if(0===p.length&&_.hasChildren())return this.expandChildren(u,d,_).pipe(Wt(y=>new Xt(a,y)));if(0===d.length&&0===p.length)return dt(new Xt(a,{}));const m=co(i)===n;return this.expandSegment(u,_,d,p,m?Gt:n,!0).pipe(Wt(b=>new Xt(a.concat(b.segments),b.children)))})):qf(t)))}getChildConfig(e,t,i){return t.children?dt({routes:t.children,injector:e}):t.loadChildren?void 0!==t._loadedRoutes?dt({routes:t._loadedRoutes,injector:t._loadedInjector}):function kJ(r,e,t,i){const s=e.canLoad;return void 0===s||0===s.length?dt(!0):dt(s.map(o=>{const a=Mu(o,r);return Gl(function AJ(r){return r&&Yf(r.canLoad)}(a)?a.canLoad(e,t):r.runInContext(()=>a(e,t)))})).pipe(Pu(),sN())}(e,t,i).pipe(vr(s=>s?this.configLoader.loadChildren(e,t).pipe(Ir(n=>{t._loadedRoutes=n.routes,t._loadedInjector=n.injector})):function YJ(r){return Nf(QO(bg,3))}())):dt({routes:[],injector:e})}lineralizeSegments(e,t){let i=[],s=t.root;for(;;){if(i=i.concat(s.segments),0===s.numberOfChildren)return dt(i);if(s.numberOfChildren>1||!s.children[Gt])return Nf(new Ne(4e3,bg));s=s.children[Gt]}}applyRedirectCommands(e,t,i){return this.applyRedirectCreateUrlTree(t,this.urlSerializer.parse(t),e,i)}applyRedirectCreateUrlTree(e,t,i,s){const n=this.createSegmentGroup(e,t.root,i,s);return new Xc(n,this.createQueryParams(t.queryParams,this.urlTree.queryParams),t.fragment)}createQueryParams(e,t){const i={};return yr(e,(s,n)=>{if("string"==typeof s&&s.startsWith(":")){const a=s.substring(1);i[n]=t[a]}else i[n]=s}),i}createSegmentGroup(e,t,i,s){const n=this.createSegments(e,t.segments,i,s);let o={};return yr(t.children,(a,l)=>{o[l]=this.createSegmentGroup(e,a,i,s)}),new Xt(n,o)}createSegments(e,t,i,s){return t.map(n=>n.path.startsWith(":")?this.findPosParam(e,n,s):this.findOrReturn(n,i))}findPosParam(e,t,i){const s=i[t.path.substring(1)];if(!s)throw new Ne(4001,bg);return s}findOrReturn(e,t){let i=0;for(const s of t){if(s.path===e.path)return t.splice(i),s;i++}return e}}class QJ{}class eee{constructor(e,t,i,s,n,o,a,l){this.injector=e,this.rootComponentType=t,this.config=i,this.urlTree=s,this.url=n,this.paramsInheritanceStrategy=o,this.relativeLinkResolution=a,this.urlSerializer=l}recognize(){const e=gg(this.urlTree.root,[],[],this.config.filter(t=>void 0===t.redirectTo),this.relativeLinkResolution).segmentGroup;return this.processSegmentGroup(this.injector,this.config,e,Gt).pipe(Wt(t=>{if(null===t)return null;const i=new fg([],Object.freeze({}),Object.freeze({...this.urlTree.queryParams}),this.urlTree.fragment,{},Gt,this.rootComponentType,null,this.urlTree.root,-1,{}),s=new Ya(i,t),n=new qO(this.url,s);return this.inheritParamsAndData(n._root),n}))}inheritParamsAndData(e){const t=e.value,i=YO(t,this.paramsInheritanceStrategy);t.params=Object.freeze(i.params),t.data=Object.freeze(i.data),e.children.forEach(s=>this.inheritParamsAndData(s))}processSegmentGroup(e,t,i,s){return 0===i.segments.length&&i.hasChildren()?this.processChildren(e,t,i):this.processSegment(e,t,i,i.segments,s)}processChildren(e,t,i){return Vs(Object.keys(i.children)).pipe(Ul(s=>{const n=i.children[s],o=tN(t,s);return this.processSegmentGroup(e,o,n,s)}),TO((s,n)=>s&&n?(s.push(...n),s):null),function yZ(r,e=!1){return ur((t,i)=>{let s=0;t.subscribe(Ks(i,n=>{const o=r(n,s++);(o||e)&&i.next(n),!o&&i.complete()}))})}(s=>null!==s),ng(null),SO(),Wt(s=>{if(null===s)return null;const n=cN(s);return function tee(r){r.sort((e,t)=>e.value.outlet===Gt?-1:t.value.outlet===Gt?1:e.value.outlet.localeCompare(t.value.outlet))}(n),n}))}processSegment(e,t,i,s,n){return Vs(t).pipe(Ul(o=>this.processSegmentAgainstRoute(o._injector??e,o,i,s,n)),Vl(o=>!!o),kl(o=>{if(CS(o))return oN(i,s,n)?dt([]):dt(null);throw o}))}processSegmentAgainstRoute(e,t,i,s,n){if(t.redirectTo||!nN(t,i,s,n))return dt(null);let o;if("**"===t.path){const a=s.length>0?AO(s).parameters:{},l=uN(i)+s.length;o=dt({snapshot:new fg(s,a,Object.freeze({...this.urlTree.queryParams}),this.urlTree.fragment,fN(t),co(t),t.component??t._loadedComponent??null,t,hN(i),l,pN(t),l),consumedSegments:[],remainingSegments:[]})}else o=rN(i,t,s,e).pipe(Wt(({matched:a,consumedSegments:l,remainingSegments:c,parameters:h})=>{if(!a)return null;const u=uN(i)+l.length;return{snapshot:new fg(l,h,Object.freeze({...this.urlTree.queryParams}),this.urlTree.fragment,fN(t),co(t),t.component??t._loadedComponent??null,t,hN(i),u,pN(t),u),consumedSegments:l,remainingSegments:c}}));return o.pipe(aa(a=>{if(null===a)return dt(null);const{snapshot:l,consumedSegments:c,remainingSegments:h}=a;e=t._injector??e;const u=t._loadedInjector??e,d=function iee(r){return r.children?r.children:r.loadChildren?r._loadedRoutes:[]}(t),{segmentGroup:f,slicedSegments:p}=gg(i,c,h,d.filter(m=>void 0===m.redirectTo),this.relativeLinkResolution);if(0===p.length&&f.hasChildren())return this.processChildren(u,d,f).pipe(Wt(m=>null===m?null:[new Ya(l,m)]));if(0===d.length&&0===p.length)return dt([new Ya(l,[])]);const _=co(t)===n;return this.processSegment(u,d,f,p,_?Gt:n).pipe(Wt(m=>null===m?null:[new Ya(l,m)]))}))}}function see(r){const e=r.value.routeConfig;return e&&""===e.path&&void 0===e.redirectTo}function cN(r){const e=[],t=new Set;for(const i of r){if(!see(i)){e.push(i);continue}const s=e.find(n=>i.value.routeConfig===n.value.routeConfig);void 0!==s?(s.children.push(...i.children),t.add(s)):e.push(i)}for(const i of t){const s=cN(i.children);e.push(new Ya(i.value,s))}return e.filter(i=>!t.has(i))}function hN(r){let e=r;for(;e._sourceSegment;)e=e._sourceSegment;return e}function uN(r){let e=r,t=e._segmentIndexShift??0;for(;e._sourceSegment;)e=e._sourceSegment,t+=e._segmentIndexShift??0;return t-1}function fN(r){return r.data||{}}function pN(r){return r.resolve||{}}function _N(r){return"string"==typeof r.title||null===r.title}function IS(r){return aa(e=>{const t=r(e);return t?Vs(t).pipe(Wt(()=>e)):dt(e)})}let mN=(()=>{class r{buildTitle(t){let i,s=t.root;for(;void 0!==s;)i=this.getResolvedTitleForRoute(s)??i,s=s.children.find(n=>n.outlet===Gt);return i}getResolvedTitleForRoute(t){return t.data[Lf]}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=Tt({token:r,factory:function(){return Is(gN)},providedIn:"root"}),r})(),gN=(()=>{class r extends mN{constructor(t){super(),this.title=t}updateTitle(t){const i=this.buildTitle(t);void 0!==i&&this.title.setTitle(i)}}return r.\u0275fac=function(t){return new(t||r)(tt(uO))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();class uee{}class fee extends class dee{shouldDetach(e){return!1}store(e,t){}shouldAttach(e){return!1}retrieve(e){return null}shouldReuseRoute(e,t){return e.routeConfig===t.routeConfig}}{}const Tg=new nt("",{providedIn:"root",factory:()=>({})}),MS=new nt("ROUTES");let PS=(()=>{class r{constructor(t,i){this.injector=t,this.compiler=i,this.componentLoaders=new WeakMap,this.childrenLoaders=new WeakMap}loadComponent(t){if(this.componentLoaders.get(t))return this.componentLoaders.get(t);if(t._loadedComponent)return dt(t._loadedComponent);this.onLoadStartListener&&this.onLoadStartListener(t);const i=Gl(t.loadComponent()).pipe(Ir(n=>{this.onLoadEndListener&&this.onLoadEndListener(t),t._loadedComponent=n}),oS(()=>{this.componentLoaders.delete(t)})),s=new yO(i,()=>new Qo).pipe(rS());return this.componentLoaders.set(t,s),s}loadChildren(t,i){if(this.childrenLoaders.get(i))return this.childrenLoaders.get(i);if(i._loadedRoutes)return dt({routes:i._loadedRoutes,injector:i._loadedInjector});this.onLoadStartListener&&this.onLoadStartListener(i);const n=this.loadModuleFactoryOrRoutes(i.loadChildren).pipe(Wt(a=>{this.onLoadEndListener&&this.onLoadEndListener(i);let l,c,h=!1;Array.isArray(a)?c=a:(l=a.create(t).injector,c=CO(l.get(MS,[],gt.Self|gt.Optional)));return{routes:c.map(ES),injector:l}}),oS(()=>{this.childrenLoaders.delete(i)})),o=new yO(n,()=>new Qo).pipe(rS());return this.childrenLoaders.set(i,o),o}loadModuleFactoryOrRoutes(t){return Gl(t()).pipe(vr(i=>i instanceof oD||Array.isArray(i)?dt(i):Vs(this.compiler.compileModuleAsync(i))))}}return r.\u0275fac=function(t){return new(t||r)(tt(Fn),tt(bT))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();class _ee{}class mee{shouldProcessUrl(e){return!0}extract(e){return e}merge(e,t){return e}}function gee(r){throw r}function vee(r,e,t){return e.parse("/")}const bee={paths:"exact",fragment:"ignored",matrixParams:"ignored",queryParams:"exact"},yee={paths:"subset",fragment:"ignored",matrixParams:"ignored",queryParams:"subset"};function bN(){const r=Is(wO),e=Is(Hf),t=Is(NT),i=Is(Fn),s=Is(bT),n=Is(MS,{optional:!0})??[],o=Is(Tg,{optional:!0})??{},a=Is(gN),l=Is(mN,{optional:!0}),c=Is(_ee,{optional:!0}),h=Is(uee,{optional:!0}),u=new Hs(null,r,e,t,i,s,CO(n));return c&&(u.urlHandlingStrategy=c),h&&(u.routeReuseStrategy=h),u.titleStrategy=l??a,function xee(r,e){r.errorHandler&&(e.errorHandler=r.errorHandler),r.malformedUriErrorHandler&&(e.malformedUriErrorHandler=r.malformedUriErrorHandler),r.onSameUrlNavigation&&(e.onSameUrlNavigation=r.onSameUrlNavigation),r.paramsInheritanceStrategy&&(e.paramsInheritanceStrategy=r.paramsInheritanceStrategy),r.relativeLinkResolution&&(e.relativeLinkResolution=r.relativeLinkResolution),r.urlUpdateStrategy&&(e.urlUpdateStrategy=r.urlUpdateStrategy),r.canceledNavigationResolution&&(e.canceledNavigationResolution=r.canceledNavigationResolution)}(o,u),u}let Hs=(()=>{class r{constructor(t,i,s,n,o,a,l){this.rootComponentType=t,this.urlSerializer=i,this.rootContexts=s,this.location=n,this.config=l,this.lastSuccessfulNavigation=null,this.currentNavigation=null,this.disposed=!1,this.navigationId=0,this.currentPageId=0,this.isNgZoneEnabled=!1,this.events=new Qo,this.errorHandler=gee,this.malformedUriErrorHandler=vee,this.navigated=!1,this.lastSuccessfulId=-1,this.afterPreactivation=()=>dt(void 0),this.urlHandlingStrategy=new mee,this.routeReuseStrategy=new fee,this.onSameUrlNavigation="ignore",this.paramsInheritanceStrategy="emptyOnly",this.urlUpdateStrategy="deferred",this.relativeLinkResolution="corrected",this.canceledNavigationResolution="replace",this.configLoader=o.get(PS),this.configLoader.onLoadEndListener=d=>this.triggerEvent(new iJ(d)),this.configLoader.onLoadStartListener=d=>this.triggerEvent(new tJ(d)),this.ngModule=o.get(zc),this.console=o.get(XK);const u=o.get(er);this.isNgZoneEnabled=u instanceof er&&er.isInAngularZone(),this.resetConfig(l),this.currentUrlTree=function CZ(){return new Xc(new Xt([],{}),{},null)}(),this.rawUrlTree=this.currentUrlTree,this.browserUrlTree=this.currentUrlTree,this.routerState=jO(this.currentUrlTree,this.rootComponentType),this.transitions=new Oo({id:0,targetPageId:0,currentUrlTree:this.currentUrlTree,currentRawUrl:this.currentUrlTree,extractedUrl:this.urlHandlingStrategy.extract(this.currentUrlTree),urlAfterRedirects:this.urlHandlingStrategy.extract(this.currentUrlTree),rawUrl:this.currentUrlTree,extras:{},resolve:null,reject:null,promise:Promise.resolve(!0),source:"imperative",restoredState:null,currentSnapshot:this.routerState.snapshot,targetSnapshot:null,currentRouterState:this.routerState,targetRouterState:null,guards:{canActivateChecks:[],canDeactivateChecks:[]},guardsResult:null}),this.navigations=this.setupNavigations(this.transitions),this.processNavigations()}get browserPageId(){return this.location.getState()?.\u0275routerPageId}setupNavigations(t){const i=this.events;return t.pipe(Xa(s=>0!==s.id),Wt(s=>({...s,extractedUrl:this.urlHandlingStrategy.extract(s.rawUrl)})),aa(s=>{let n=!1,o=!1;return dt(s).pipe(Ir(a=>{this.currentNavigation={id:a.id,initialUrl:a.rawUrl,extractedUrl:a.extractedUrl,trigger:a.source,extras:a.extras,previousNavigation:this.lastSuccessfulNavigation?{...this.lastSuccessfulNavigation,previousNavigation:null}:null}}),aa(a=>{const l=this.browserUrlTree.toString(),c=!this.navigated||a.extractedUrl.toString()!==l||l!==this.currentUrlTree.toString();if(("reload"===this.onSameUrlNavigation||c)&&this.urlHandlingStrategy.shouldProcessUrl(a.rawUrl))return yN(a.source)&&(this.browserUrlTree=a.extractedUrl),dt(a).pipe(aa(u=>{const d=this.transitions.getValue();return i.next(new pS(u.id,this.serializeUrl(u.extractedUrl),u.source,u.restoredState)),d!==this.transitions.getValue()?Ia:Promise.resolve(u)}),function KJ(r,e,t,i){return aa(s=>function qJ(r,e,t,i,s){return new $J(r,e,t,i,s).apply()}(r,e,t,s.extractedUrl,i).pipe(Wt(n=>({...s,urlAfterRedirects:n}))))}(this.ngModule.injector,this.configLoader,this.urlSerializer,this.config),Ir(u=>{this.currentNavigation={...this.currentNavigation,finalUrl:u.urlAfterRedirects},s.urlAfterRedirects=u.urlAfterRedirects}),function nee(r,e,t,i,s,n){return vr(o=>function JJ(r,e,t,i,s,n,o="emptyOnly",a="legacy"){return new eee(r,e,t,i,s,o,a,n).recognize().pipe(aa(l=>null===l?function ZJ(r){return new Rs(e=>e.error(r))}(new QJ):dt(l)))}(r,e,t,o.urlAfterRedirects,i.serialize(o.urlAfterRedirects),i,s,n).pipe(Wt(a=>({...o,targetSnapshot:a}))))}(this.ngModule.injector,this.rootComponentType,this.config,this.urlSerializer,this.paramsInheritanceStrategy,this.relativeLinkResolution),Ir(u=>{if(s.targetSnapshot=u.targetSnapshot,"eager"===this.urlUpdateStrategy){if(!u.extras.skipLocationChange){const f=this.urlHandlingStrategy.merge(u.urlAfterRedirects,u.rawUrl);this.setBrowserUrl(f,u)}this.browserUrlTree=u.urlAfterRedirects}const d=new KZ(u.id,this.serializeUrl(u.extractedUrl),this.serializeUrl(u.urlAfterRedirects),u.targetSnapshot);i.next(d)}));if(c&&this.rawUrlTree&&this.urlHandlingStrategy.shouldProcessUrl(this.rawUrlTree)){const{id:d,extractedUrl:f,source:p,restoredState:_,extras:m}=a,g=new pS(d,this.serializeUrl(f),p,_);i.next(g);const b=jO(f,this.rootComponentType).snapshot;return dt(s={...a,targetSnapshot:b,urlAfterRedirects:f,extras:{...m,skipLocationChange:!1,replaceUrl:!1}})}return this.rawUrlTree=a.rawUrl,a.resolve(null),Ia}),Ir(a=>{const l=new QZ(a.id,this.serializeUrl(a.extractedUrl),this.serializeUrl(a.urlAfterRedirects),a.targetSnapshot);this.triggerEvent(l)}),Wt(a=>s={...a,guards:xJ(a.targetSnapshot,a.currentSnapshot,this.rootContexts)}),function wJ(r,e){return vr(t=>{const{targetSnapshot:i,currentSnapshot:s,guards:{canActivateChecks:n,canDeactivateChecks:o}}=t;return 0===o.length&&0===n.length?dt({...t,guardsResult:!0}):function OJ(r,e,t,i){return Vs(r).pipe(vr(s=>function UJ(r,e,t,i,s){const n=e&&e.routeConfig?e.routeConfig.canDeactivate:null;return n&&0!==n.length?dt(n.map(a=>{const l=Wf(e)??s,c=Mu(a,l);return Gl(function MJ(r){return r&&Yf(r.canDeactivate)}(c)?c.canDeactivate(r,e,t,i):l.runInContext(()=>c(r,e,t,i))).pipe(Vl())})).pipe(Pu()):dt(!0)}(s.component,s.route,t,e,i)),Vl(s=>!0!==s,!0))}(o,i,s,r).pipe(vr(a=>a&&function CJ(r){return"boolean"==typeof r}(a)?function NJ(r,e,t,i){return Vs(e).pipe(Ul(s=>sS(function LJ(r,e){return null!==r&&e&&e(new sJ(r)),dt(!0)}(s.route.parent,i),function FJ(r,e){return null!==r&&e&&e(new nJ(r)),dt(!0)}(s.route,i),function VJ(r,e,t){const i=e[e.length-1],n=e.slice(0,e.length-1).reverse().map(o=>function TJ(r){const e=r.routeConfig?r.routeConfig.canActivateChild:null;return e&&0!==e.length?{node:r,guards:e}:null}(o)).filter(o=>null!==o).map(o=>bO(()=>dt(o.guards.map(l=>{const c=Wf(o.node)??t,h=Mu(l,c);return Gl(function IJ(r){return r&&Yf(r.canActivateChild)}(h)?h.canActivateChild(i,r):c.runInContext(()=>h(i,r))).pipe(Vl())})).pipe(Pu())));return dt(n).pipe(Pu())}(r,s.path,t),function BJ(r,e,t){const i=e.routeConfig?e.routeConfig.canActivate:null;if(!i||0===i.length)return dt(!0);const s=i.map(n=>bO(()=>{const o=Wf(e)??t,a=Mu(n,o);return Gl(function RJ(r){return r&&Yf(r.canActivate)}(a)?a.canActivate(e,r):o.runInContext(()=>a(e,r))).pipe(Vl())}));return dt(s).pipe(Pu())}(r,s.route,t))),Vl(s=>!0!==s,!0))}(i,n,r,e):dt(a)),Wt(a=>({...t,guardsResult:a})))})}(this.ngModule.injector,a=>this.triggerEvent(a)),Ir(a=>{if(s.guardsResult=a.guardsResult,Yc(a.guardsResult))throw KO(0,a.guardsResult);const l=new ZZ(a.id,this.serializeUrl(a.extractedUrl),this.serializeUrl(a.urlAfterRedirects),a.targetSnapshot,!!a.guardsResult);this.triggerEvent(l)}),Xa(a=>!!a.guardsResult||(this.restoreHistory(a),this.cancelNavigationTransition(a,"",3),!1)),IS(a=>{if(a.guards.canActivateChecks.length)return dt(a).pipe(Ir(l=>{const c=new JZ(l.id,this.serializeUrl(l.extractedUrl),this.serializeUrl(l.urlAfterRedirects),l.targetSnapshot);this.triggerEvent(c)}),aa(l=>{let c=!1;return dt(l).pipe(function oee(r,e){return vr(t=>{const{targetSnapshot:i,guards:{canActivateChecks:s}}=t;if(!s.length)return dt(t);let n=0;return Vs(s).pipe(Ul(o=>function aee(r,e,t,i){const s=r.routeConfig,n=r._resolve;return void 0!==s?.title&&!_N(s)&&(n[Lf]=s.title),function lee(r,e,t,i){const s=function cee(r){return[...Object.keys(r),...Object.getOwnPropertySymbols(r)]}(r);if(0===s.length)return dt({});const n={};return Vs(s).pipe(vr(o=>function hee(r,e,t,i){const s=Wf(e)??i,n=Mu(r,s);return Gl(n.resolve?n.resolve(e,t):s.runInContext(()=>n(e,t)))}(r[o],e,t,i).pipe(Vl(),Ir(a=>{n[o]=a}))),nS(1),function xZ(r){return Wt(()=>r)}(n),kl(o=>CS(o)?Ia:Nf(o)))}(n,r,e,i).pipe(Wt(o=>(r._resolvedData=o,r.data=YO(r,t).resolve,s&&_N(s)&&(r.data[Lf]=s.title),null)))}(o.route,i,r,e)),Ir(()=>n++),nS(1),vr(o=>n===s.length?dt(t):Ia))})}(this.paramsInheritanceStrategy,this.ngModule.injector),Ir({next:()=>c=!0,complete:()=>{c||(this.restoreHistory(l),this.cancelNavigationTransition(l,"",2))}}))}),Ir(l=>{const c=new eJ(l.id,this.serializeUrl(l.extractedUrl),this.serializeUrl(l.urlAfterRedirects),l.targetSnapshot);this.triggerEvent(c)}))}),IS(a=>{const l=c=>{const h=[];c.routeConfig?.loadComponent&&!c.routeConfig._loadedComponent&&h.push(this.configLoader.loadComponent(c.routeConfig).pipe(Ir(u=>{c.component=u}),Wt(()=>{})));for(const u of c.children)h.push(...l(u));return h};return gO(l(a.targetSnapshot.root)).pipe(ng(),Ff(1))}),IS(()=>this.afterPreactivation()),Wt(a=>{const l=function hJ(r,e,t){const i=zf(r,e._root,t?t._root:void 0);return new XO(i,e)}(this.routeReuseStrategy,a.targetSnapshot,a.currentRouterState);return s={...a,targetRouterState:l}}),Ir(a=>{this.currentUrlTree=a.urlAfterRedirects,this.rawUrlTree=this.urlHandlingStrategy.merge(a.urlAfterRedirects,a.rawUrl),this.routerState=a.targetRouterState,"deferred"===this.urlUpdateStrategy&&(a.extras.skipLocationChange||this.setBrowserUrl(this.rawUrlTree,a),this.browserUrlTree=a.urlAfterRedirects)}),((r,e,t)=>Wt(i=>(new yJ(e,i.targetRouterState,i.currentRouterState,t).activate(r),i)))(this.rootContexts,this.routeReuseStrategy,a=>this.triggerEvent(a)),Ir({next(){n=!0},complete(){n=!0}}),oS(()=>{n||o||this.cancelNavigationTransition(s,"",1),this.currentNavigation?.id===s.id&&(this.currentNavigation=null)}),kl(a=>{if(o=!0,JO(a)){ZO(a)||(this.navigated=!0,this.restoreHistory(s,!0));const l=new dg(s.id,this.serializeUrl(s.extractedUrl),a.message,a.cancellationCode);if(i.next(l),ZO(a)){const c=this.urlHandlingStrategy.merge(a.url,this.rawUrlTree),h={skipLocationChange:s.extras.skipLocationChange,replaceUrl:"eager"===this.urlUpdateStrategy||yN(s.source)};this.scheduleNavigation(c,"imperative",null,h,{resolve:s.resolve,reject:s.reject,promise:s.promise})}else s.resolve(!1)}else{this.restoreHistory(s,!0);const l=new zO(s.id,this.serializeUrl(s.extractedUrl),a,s.targetSnapshot??void 0);i.next(l);try{s.resolve(this.errorHandler(a))}catch(c){s.reject(c)}}return Ia}))}))}resetRootComponentType(t){this.rootComponentType=t,this.routerState.root.component=this.rootComponentType}setTransition(t){this.transitions.next({...this.transitions.value,...t})}initialNavigation(){this.setUpLocationChangeListener(),0===this.navigationId&&this.navigateByUrl(this.location.path(!0),{replaceUrl:!0})}setUpLocationChangeListener(){this.locationSubscription||(this.locationSubscription=this.location.subscribe(t=>{const i="popstate"===t.type?"popstate":"hashchange";"popstate"===i&&setTimeout(()=>{const s={replaceUrl:!0},n=t.state?.navigationId?t.state:null;if(n){const a={...n};delete a.navigationId,delete a.\u0275routerPageId,0!==Object.keys(a).length&&(s.state=a)}const o=this.parseUrl(t.url);this.scheduleNavigation(o,i,n,s)},0)}))}get url(){return this.serializeUrl(this.currentUrlTree)}getCurrentNavigation(){return this.currentNavigation}triggerEvent(t){this.events.next(t)}resetConfig(t){this.config=t.map(ES),this.navigated=!1,this.lastSuccessfulId=-1}ngOnDestroy(){this.dispose()}dispose(){this.transitions.complete(),this.locationSubscription&&(this.locationSubscription.unsubscribe(),this.locationSubscription=void 0),this.disposed=!0}createUrlTree(t,i={}){const{relativeTo:s,queryParams:n,fragment:o,queryParamsHandling:a,preserveFragment:l}=i,c=s||this.routerState.root,h=l?this.currentUrlTree.fragment:o;let u=null;switch(a){case"merge":u={...this.currentUrlTree.queryParams,...n};break;case"preserve":u=this.currentUrlTree.queryParams;break;default:u=n||null}return null!==u&&(u=this.removeEmptyProps(u)),WZ(c,this.currentUrlTree,t,u,h??null)}navigateByUrl(t,i={skipLocationChange:!1}){const s=Yc(t)?t:this.parseUrl(t),n=this.urlHandlingStrategy.merge(s,this.rawUrlTree);return this.scheduleNavigation(n,"imperative",null,i)}navigate(t,i={skipLocationChange:!1}){return function Tee(r){for(let e=0;e<r.length;e++){if(null==r[e])throw new Ne(4008,false)}}(t),this.navigateByUrl(this.createUrlTree(t,i),i)}serializeUrl(t){return this.urlSerializer.serialize(t)}parseUrl(t){let i;try{i=this.urlSerializer.parse(t)}catch(s){i=this.malformedUriErrorHandler(s,this.urlSerializer,t)}return i}isActive(t,i){let s;if(s=!0===i?{...bee}:!1===i?{...yee}:i,Yc(t))return IO(this.currentUrlTree,t,s);const n=this.parseUrl(t);return IO(this.currentUrlTree,n,s)}removeEmptyProps(t){return Object.keys(t).reduce((i,s)=>{const n=t[s];return null!=n&&(i[s]=n),i},{})}processNavigations(){this.navigations.subscribe(t=>{this.navigated=!0,this.lastSuccessfulId=t.id,this.currentPageId=t.targetPageId,this.events.next(new qc(t.id,this.serializeUrl(t.extractedUrl),this.serializeUrl(this.currentUrlTree))),this.lastSuccessfulNavigation=this.currentNavigation,this.titleStrategy?.updateTitle(this.routerState.snapshot),t.resolve(!0)},t=>{this.console.warn(`Unhandled Navigation Error: ${t}`)})}scheduleNavigation(t,i,s,n,o){if(this.disposed)return Promise.resolve(!1);let a,l,c;o?(a=o.resolve,l=o.reject,c=o.promise):c=new Promise((d,f)=>{a=d,l=f});const h=++this.navigationId;let u;return"computed"===this.canceledNavigationResolution?(0===this.currentPageId&&(s=this.location.getState()),u=s&&s.\u0275routerPageId?s.\u0275routerPageId:n.replaceUrl||n.skipLocationChange?this.browserPageId??0:(this.browserPageId??0)+1):u=0,this.setTransition({id:h,targetPageId:u,source:i,restoredState:s,currentUrlTree:this.currentUrlTree,currentRawUrl:this.rawUrlTree,rawUrl:t,extras:n,resolve:a,reject:l,promise:c,currentSnapshot:this.routerState.snapshot,currentRouterState:this.routerState}),c.catch(d=>Promise.reject(d))}setBrowserUrl(t,i){const s=this.urlSerializer.serialize(t),n={...i.extras.state,...this.generateNgRouterState(i.id,i.targetPageId)};this.location.isCurrentPathEqualTo(s)||i.extras.replaceUrl?this.location.replaceState(s,"",n):this.location.go(s,"",n)}restoreHistory(t,i=!1){if("computed"===this.canceledNavigationResolution){const s=this.currentPageId-t.targetPageId;"popstate"!==t.source&&"eager"!==this.urlUpdateStrategy&&this.currentUrlTree!==this.currentNavigation?.finalUrl||0===s?this.currentUrlTree===this.currentNavigation?.finalUrl&&0===s&&(this.resetState(t),this.browserUrlTree=t.currentUrlTree,this.resetUrlToCurrentUrlTree()):this.location.historyGo(s)}else"replace"===this.canceledNavigationResolution&&(i&&this.resetState(t),this.resetUrlToCurrentUrlTree())}resetState(t){this.routerState=t.currentRouterState,this.currentUrlTree=t.currentUrlTree,this.rawUrlTree=this.urlHandlingStrategy.merge(this.currentUrlTree,t.rawUrl)}resetUrlToCurrentUrlTree(){this.location.replaceState(this.urlSerializer.serialize(this.rawUrlTree),"",this.generateNgRouterState(this.lastSuccessfulId,this.currentPageId))}cancelNavigationTransition(t,i,s){const n=new dg(t.id,this.serializeUrl(t.extractedUrl),i,s);this.triggerEvent(n),t.resolve(!1)}generateNgRouterState(t,i){return"computed"===this.canceledNavigationResolution?{navigationId:t,\u0275routerPageId:i}:{navigationId:t}}}return r.\u0275fac=function(t){mx()},r.\u0275prov=Tt({token:r,factory:function(){return bN()},providedIn:"root"}),r})();function yN(r){return"imperative"!==r}class xN{}let Cee=(()=>{class r{constructor(t,i,s,n,o){this.router=t,this.injector=s,this.preloadingStrategy=n,this.loader=o}setUpPreloading(){this.subscription=this.router.events.pipe(Xa(t=>t instanceof qc),Ul(()=>this.preload())).subscribe(()=>{})}preload(){return this.processRoutes(this.injector,this.router.config)}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}processRoutes(t,i){const s=[];for(const n of i){n.providers&&!n._injector&&(n._injector=Mm(n.providers,t,`Route: ${n.path}`));const o=n._injector??t,a=n._loadedInjector??o;n.loadChildren&&!n._loadedRoutes&&void 0===n.canLoad||n.loadComponent&&!n._loadedComponent?s.push(this.preloadConfig(o,n)):(n.children||n._loadedRoutes)&&s.push(this.processRoutes(a,n.children??n._loadedRoutes))}return Vs(s).pipe(Uh())}preloadConfig(t,i){return this.preloadingStrategy.preload(i,()=>{let s;s=i.loadChildren&&void 0===i.canLoad?this.loader.loadChildren(t,i):dt(null);const n=s.pipe(vr(o=>null===o?dt(void 0):(i._loadedRoutes=o.routes,i._loadedInjector=o.injector,this.processRoutes(o.injector??t,o.routes))));return i.loadComponent&&!i._loadedComponent?Vs([n,this.loader.loadComponent(i)]).pipe(Uh()):n})}}return r.\u0275fac=function(t){return new(t||r)(tt(Hs),tt(bT),tt(Ol),tt(xN),tt(PS))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();const OS=new nt("");let TN=(()=>{class r{constructor(t,i,s={}){this.router=t,this.viewportScroller=i,this.options=s,this.lastId=0,this.lastSource="imperative",this.restoredId=0,this.store={},s.scrollPositionRestoration=s.scrollPositionRestoration||"disabled",s.anchorScrolling=s.anchorScrolling||"disabled"}init(){"disabled"!==this.options.scrollPositionRestoration&&this.viewportScroller.setHistoryScrollRestoration("manual"),this.routerEventsSubscription=this.createScrollEvents(),this.scrollEventsSubscription=this.consumeScrollEvents()}createScrollEvents(){return this.router.events.subscribe(t=>{t instanceof pS?(this.store[this.lastId]=this.viewportScroller.getScrollPosition(),this.lastSource=t.navigationTrigger,this.restoredId=t.restoredState?t.restoredState.navigationId:0):t instanceof qc&&(this.lastId=t.id,this.scheduleScrollEvent(t,this.router.parseUrl(t.urlAfterRedirects).fragment))})}consumeScrollEvents(){return this.router.events.subscribe(t=>{t instanceof HO&&(t.position?"top"===this.options.scrollPositionRestoration?this.viewportScroller.scrollToPosition([0,0]):"enabled"===this.options.scrollPositionRestoration&&this.viewportScroller.scrollToPosition(t.position):t.anchor&&"enabled"===this.options.anchorScrolling?this.viewportScroller.scrollToAnchor(t.anchor):"disabled"!==this.options.scrollPositionRestoration&&this.viewportScroller.scrollToPosition([0,0]))})}scheduleScrollEvent(t,i){this.router.triggerEvent(new HO(t,"popstate"===this.lastSource?this.store[this.restoredId]:null,i))}ngOnDestroy(){this.routerEventsSubscription&&this.routerEventsSubscription.unsubscribe(),this.scrollEventsSubscription&&this.scrollEventsSubscription.unsubscribe()}}return r.\u0275fac=function(t){mx()},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})();function Du(r,e){return{\u0275kind:r,\u0275providers:e}}function NS(r){return[{provide:MS,multi:!0,useValue:r}]}function EN(){const r=Is(Fn);return e=>{const t=r.get(Lm);if(e!==t.components[0])return;const i=r.get(Hs),s=r.get(CN);1===r.get(FS)&&i.initialNavigation(),r.get(AN,null,gt.Optional)?.setUpPreloading(),r.get(OS,null,gt.Optional)?.init(),i.resetRootComponentType(t.componentTypes[0]),s.closed||(s.next(),s.unsubscribe())}}const CN=new nt("",{factory:()=>new Qo}),FS=new nt("",{providedIn:"root",factory:()=>1});const AN=new nt("");function Mee(r){return Du(0,[{provide:AN,useExisting:Cee},{provide:xN,useExisting:r}])}const RN=new nt("ROUTER_FORROOT_GUARD"),Pee=[NT,{provide:wO,useClass:lS},{provide:Hs,useFactory:bN},Hf,{provide:zl,useFactory:function SN(r){return r.routerState.root},deps:[Hs]},PS];function Dee(){return new tw("Router",Hs)}let IN=(()=>{class r{constructor(t){}static forRoot(t,i){return{ngModule:r,providers:[Pee,[],NS(t),{provide:RN,useFactory:Fee,deps:[[Hs,new Jd,new ef]]},{provide:Tg,useValue:i||{}},i?.useHash?{provide:Wc,useClass:OQ}:{provide:Wc,useClass:Aw},{provide:OS,useFactory:()=>{const r=Is(Hs),e=Is(t9),t=Is(Tg);return t.scrollOffset&&e.setOffset(t.scrollOffset),new TN(r,e,t)}},i?.preloadingStrategy?Mee(i.preloadingStrategy).\u0275providers:[],{provide:tw,multi:!0,useFactory:Dee},i?.initialNavigation?Lee(i):[],[{provide:MN,useFactory:EN},{provide:qD,multi:!0,useExisting:MN}]]}}static forChild(t){return{ngModule:r,providers:[NS(t)]}}}return r.\u0275fac=function(t){return new(t||r)(tt(RN,8))},r.\u0275mod=io({type:r}),r.\u0275inj=Rn({imports:[TS]}),r})();function Fee(r){return"guarded"}function Lee(r){return["disabled"===r.initialNavigation?Du(3,[{provide:Om,multi:!0,useFactory:()=>{const e=Is(Hs);return()=>{e.setUpLocationChangeListener()}}},{provide:FS,useValue:2}]).\u0275providers:[],"enabledBlocking"===r.initialNavigation?Du(2,[{provide:FS,useValue:0},{provide:Om,multi:!0,deps:[Fn],useFactory:e=>{const t=e.get(DQ,Promise.resolve());let i=!1;return()=>t.then(()=>new Promise(n=>{const o=e.get(Hs),a=e.get(CN);(function s(n){e.get(Hs).events.pipe(Xa(a=>a instanceof qc||a instanceof dg||a instanceof zO),Wt(a=>a instanceof qc||a instanceof dg&&(0===a.code||1===a.code)&&null),Xa(a=>null!==a),Ff(1)).subscribe(()=>{n()})})(()=>{n(!0),i=!0}),o.afterPreactivation=()=>(n(!0),i||a.closed?dt(void 0):a),o.initialNavigation()}))}}]).\u0275providers:[]]}const MN=new nt("");let Vee=(()=>{class r{constructor(){this.title="babylon"}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275cmp=Il({type:r,selectors:[["app-root"]],decls:1,vars:0,template:function(t,i){1&t&&oi(0,"router-outlet")},dependencies:[xS]}),r})();const PN="*[_ngcontent-%COMP%]{margin:0;padding:0}body[_ngcontent-%COMP%]{margin:0;font-family:cursive;font-size:20px;color:#000;line-height:1.6;display:flex;height:100vh;flex-direction:column}#background[_ngcontent-%COMP%]{background-image:url(https://img.freepik.com/free-vector/copy-space-bokeh-spring-lights-background_52683-55649.jpg);background-size:cover;background-position:center;bottom:0}#showcase[_ngcontent-%COMP%]{height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:0 20px}#container[_ngcontent-%COMP%]{background-color:#fff;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:0 20px;margin:10%}#footer[_ngcontent-%COMP%]{margin-left:40px;margin-bottom:20px;justify-content:left;align-items:left;text-align:left}.input-group[_ngcontent-%COMP%]{margin-top:20px;display:flex;justify-content:center;align-items:center;gap:10px;width:200px}";let Uee=(()=>{class r{constructor(){}ngOnInit(){}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275cmp=Il({type:r,selectors:[["app-rules"]],decls:72,vars:0,consts:[["name","viewport","content","width=device-width, initial-scale=1.0"],["id","background"],["id","container"],[1,"row"],[1,"col"],["src","assets/player1.PNG","height","170","width","100","title","j1"],["src","assets/player2.PNG","height","180","width","100","title","j2"],["src","assets/niveau.PNG","height","150","width","150","title","niveau"],["src","assets/pl1.PNG","height","100","width","150","title","touchesp1"],["src","assets/pl2.PNG","height","100","width","150","title","touchesp2"],["src","assets/roue.PNG","height","200","width","200","title","roue"],["src","assets/aze.PNG","height","50","width","150","title","AZE"],["src","assets/iop.PNG","height","50","width","150","title","IOP"]],template:function(t,i){1&t&&(ut(0,"head"),oi(1,"meta",0),ut(2,"title"),ii(3,"Regles de jeu"),bt()(),ut(4,"body")(5,"div",1)(6,"div",2),oi(7,"br"),ut(8,"h1"),ii(9," Voici les regles du jeu"),bt(),oi(10,"br"),ut(11,"p"),ii(12,"2 joueurs sur un m\xeame ordinateur"),bt(),ut(13,"p"),ii(14,"Chaque joueur introduit son nom avant de demarrer la partie."),bt(),oi(15,"br"),ut(16,"p"),ii(17,"Une fois la partie d\xe9marr\xe9, vous allez voir plusieurs \xe9l\xe9ments appara\xeetre:"),bt(),oi(18,"br"),ut(19,"div",3)(20,"div",4)(21,"div",3)(22,"div")(23,"p"),ii(24,"Avatar Joueur 1 : "),bt(),oi(25,"img",5)(26,"br"),bt()()(),ut(27,"div",4),oi(28,"br"),bt(),ut(29,"div",4)(30,"div",3)(31,"div")(32,"p"),ii(33,"Avatar Joueur 2 : "),bt(),oi(34,"img",6)(35,"br"),bt()()(),ut(36,"div",4),oi(37,"br"),bt(),ut(38,"div",4)(39,"div",3)(40,"div")(41,"p"),ii(42,"5 Niveaux du jeu : "),bt(),oi(43,"img",7)(44,"br"),bt()()()(),oi(45,"br"),ut(46,"p"),ii(47,"Pour bouger le joueur 1 utilisez les touches:"),bt(),oi(48,"img",8)(49,"br"),ut(50,"p"),ii(51,"Pour bouger le joueur 2 utilisez les touches:"),bt(),oi(52,"img",9)(53,"br"),ut(54,"p"),ii(55,"Lors du d\xe9but d'un niveau, il faut tourner la roulette qui choisit une cat\xe9gorie et une question au hazard."),bt(),oi(56,"img",10)(57,"br"),ut(58,"p"),ii(59," Touches pour r\xe9pondre aux questions (en ordre: R\xe9ponse1 R\xe9ponse2 R\xe9ponse3) "),bt(),oi(60,"br"),ut(61,"p"),ii(62,"Joueur 1 : "),bt(),oi(63,"img",11)(64,"br"),ut(65,"p"),ii(66,"Joueur 2 : "),bt(),oi(67,"img",12)(68,"br"),ut(69,"p"),ii(70," A la fin de chaque niveau il y aura un gagnant. Apr\xe8s les 5 niveaux, celui avec le plus des niveaux gagn\xe9s est nom\xe9 le gagnant de la partie. "),bt(),oi(71,"br"),bt()()())},styles:[PN,PN]}),r})(),Ag=(()=>{class r{constructor(){this.names=[],this.gagnantBox=[]}addName(t){this.names.push(t)}getNames(){return this.names}getName(t){return this.names[t]}addGagnantBox(t){this.gagnantBox.push(t)}getGagnantBox(){return this.gagnantBox[0]}viderGagnantBox(){this.gagnantBox.splice(0,this.gagnantBox.length)}getP1(){return this.p1}setP1(){this.p1=this.p1+1}initializeP1(){this.p1=0}getP2(){return this.p2}setP2(){this.p2=this.p2+1}initializeP2(){this.p2=0}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=Tt({token:r,factory:r.\u0275fac,providedIn:"root"}),r})(),DN=(()=>{class r{constructor(t,i){this._renderer=t,this._elementRef=i,this.onChange=s=>{},this.onTouched=()=>{}}setProperty(t,i){this._renderer.setProperty(this._elementRef.nativeElement,t,i)}registerOnTouched(t){this.onTouched=t}registerOnChange(t){this.onChange=t}setDisabledState(t){this.setProperty("disabled",t)}}return r.\u0275fac=function(t){return new(t||r)(xe(Fa),xe(Nn))},r.\u0275dir=St({type:r}),r})(),$c=(()=>{class r extends DN{}return r.\u0275fac=function(){let e;return function(i){return(e||(e=Cr(r)))(i||r)}}(),r.\u0275dir=St({type:r,features:[Ti]}),r})();const ca=new nt("NgValueAccessor"),zee={provide:ca,useExisting:Li(()=>Rg),multi:!0},Wee=new nt("CompositionEventMode");let Rg=(()=>{class r extends DN{constructor(t,i,s){super(t,i),this._compositionMode=s,this._composing=!1,null==this._compositionMode&&(this._compositionMode=!function Hee(){const r=oa()?oa().getUserAgent():"";return/android (\d+)/.test(r.toLowerCase())}())}writeValue(t){this.setProperty("value",t??"")}_handleInput(t){(!this._compositionMode||this._compositionMode&&!this._composing)&&this.onChange(t)}_compositionStart(){this._composing=!0}_compositionEnd(t){this._composing=!1,this._compositionMode&&this.onChange(t)}}return r.\u0275fac=function(t){return new(t||r)(xe(Fa),xe(Nn),xe(Wee,8))},r.\u0275dir=St({type:r,selectors:[["input","formControlName","",3,"type","checkbox"],["textarea","formControlName",""],["input","formControl","",3,"type","checkbox"],["textarea","formControl",""],["input","ngModel","",3,"type","checkbox"],["textarea","ngModel",""],["","ngDefaultControl",""]],hostBindings:function(t,i){1&t&&br("input",function(n){return i._handleInput(n.target.value)})("blur",function(){return i.onTouched()})("compositionstart",function(){return i._compositionStart()})("compositionend",function(n){return i._compositionEnd(n.target.value)})},features:[Ji([zee]),Ti]}),r})();const Mr=new nt("NgValidators"),Wl=new nt("NgAsyncValidators");function LN(r){return function Hl(r){return null==r||("string"==typeof r||Array.isArray(r))&&0===r.length}(r.value)?{required:!0}:null}function Ig(r){return null}function zN(r){return null!=r}function HN(r){return gf(r)?Vs(r):r}function WN(r){let e={};return r.forEach(t=>{e=null!=t?{...e,...t}:e}),0===Object.keys(e).length?null:e}function XN(r,e){return e.map(t=>t(r))}function jN(r){return r.map(e=>function Yee(r){return!r.validate}(e)?e:t=>e.validate(t))}function LS(r){return null!=r?function YN(r){if(!r)return null;const e=r.filter(zN);return 0==e.length?null:function(t){return WN(XN(t,e))}}(jN(r)):null}function BS(r){return null!=r?function qN(r){if(!r)return null;const e=r.filter(zN);return 0==e.length?null:function(t){return function kee(...r){const e=OA(r),{args:t,keys:i}=pO(r),s=new Rs(n=>{const{length:o}=t;if(!o)return void n.complete();const a=new Array(o);let l=o,c=o;for(let h=0;h<o;h++){let u=!1;yo(t[h]).subscribe(Ks(n,d=>{u||(u=!0,c--),a[h]=d},()=>l--,void 0,()=>{(!l||!u)&&(c||n.next(i?mO(i,a):a),n.complete())}))}});return e?s.pipe(_O(e)):s}(XN(t,e).map(HN)).pipe(Wt(WN))}}(jN(r)):null}function $N(r,e){return null===r?[e]:Array.isArray(r)?[...r,e]:[r,e]}function VS(r){return r?Array.isArray(r)?r:[r]:[]}function Mg(r,e){return Array.isArray(r)?r.includes(e):r===e}function ZN(r,e){const t=VS(e);return VS(r).forEach(s=>{Mg(t,s)||t.push(s)}),t}function JN(r,e){return VS(e).filter(t=>!Mg(r,t))}class eF{constructor(){this._rawValidators=[],this._rawAsyncValidators=[],this._onDestroyCallbacks=[]}get value(){return this.control?this.control.value:null}get valid(){return this.control?this.control.valid:null}get invalid(){return this.control?this.control.invalid:null}get pending(){return this.control?this.control.pending:null}get disabled(){return this.control?this.control.disabled:null}get enabled(){return this.control?this.control.enabled:null}get errors(){return this.control?this.control.errors:null}get pristine(){return this.control?this.control.pristine:null}get dirty(){return this.control?this.control.dirty:null}get touched(){return this.control?this.control.touched:null}get status(){return this.control?this.control.status:null}get untouched(){return this.control?this.control.untouched:null}get statusChanges(){return this.control?this.control.statusChanges:null}get valueChanges(){return this.control?this.control.valueChanges:null}get path(){return null}_setValidators(e){this._rawValidators=e||[],this._composedValidatorFn=LS(this._rawValidators)}_setAsyncValidators(e){this._rawAsyncValidators=e||[],this._composedAsyncValidatorFn=BS(this._rawAsyncValidators)}get validator(){return this._composedValidatorFn||null}get asyncValidator(){return this._composedAsyncValidatorFn||null}_registerOnDestroy(e){this._onDestroyCallbacks.push(e)}_invokeOnDestroyCallbacks(){this._onDestroyCallbacks.forEach(e=>e()),this._onDestroyCallbacks=[]}reset(e){this.control&&this.control.reset(e)}hasError(e,t){return!!this.control&&this.control.hasError(e,t)}getError(e,t){return this.control?this.control.getError(e,t):null}}class jr extends eF{get formDirective(){return null}get path(){return null}}class Xl extends eF{constructor(){super(...arguments),this._parent=null,this.name=null,this.valueAccessor=null}}let iF=(()=>{class r extends class tF{constructor(e){this._cd=e}get isTouched(){return!!this._cd?.control?.touched}get isUntouched(){return!!this._cd?.control?.untouched}get isPristine(){return!!this._cd?.control?.pristine}get isDirty(){return!!this._cd?.control?.dirty}get isValid(){return!!this._cd?.control?.valid}get isInvalid(){return!!this._cd?.control?.invalid}get isPending(){return!!this._cd?.control?.pending}get isSubmitted(){return!!this._cd?.submitted}}{constructor(t){super(t)}}return r.\u0275fac=function(t){return new(t||r)(xe(Xl,2))},r.\u0275dir=St({type:r,selectors:[["","formControlName",""],["","ngModel",""],["","formControl",""]],hostVars:14,hostBindings:function(t,i){2&t&&Sm("ng-untouched",i.isUntouched)("ng-touched",i.isTouched)("ng-pristine",i.isPristine)("ng-dirty",i.isDirty)("ng-valid",i.isValid)("ng-invalid",i.isInvalid)("ng-pending",i.isPending)},features:[Ti]}),r})();const $f="VALID",Dg="INVALID",wu="PENDING",Kf="DISABLED";function rF(r){return Array.isArray(r)?LS(r):r||null}function nF(r){return Array.isArray(r)?BS(r):r||null}function wg(r){return null!=r&&!Array.isArray(r)&&"object"==typeof r}function Qf(r,e){(function XS(r,e){const t=function KN(r){return r._rawValidators}(r);null!==e.validator?r.setValidators($N(t,e.validator)):"function"==typeof t&&r.setValidators([t]);const i=function QN(r){return r._rawAsyncValidators}(r);null!==e.asyncValidator?r.setAsyncValidators($N(i,e.asyncValidator)):"function"==typeof i&&r.setAsyncValidators([i]);const s=()=>r.updateValueAndValidity();Fg(e._rawValidators,s),Fg(e._rawAsyncValidators,s)})(r,e),e.valueAccessor.writeValue(r.value),r.disabled&&e.valueAccessor.setDisabledState?.(!0),function ste(r,e){e.valueAccessor.registerOnChange(t=>{r._pendingValue=t,r._pendingChange=!0,r._pendingDirty=!0,"change"===r.updateOn&&cF(r,e)})}(r,e),function nte(r,e){const t=(i,s)=>{e.valueAccessor.writeValue(i),s&&e.viewToModelUpdate(i)};r.registerOnChange(t),e._registerOnDestroy(()=>{r._unregisterOnChange(t)})}(r,e),function rte(r,e){e.valueAccessor.registerOnTouched(()=>{r._pendingTouched=!0,"blur"===r.updateOn&&r._pendingChange&&cF(r,e),"submit"!==r.updateOn&&r.markAsTouched()})}(r,e),function ite(r,e){if(e.valueAccessor.setDisabledState){const t=i=>{e.valueAccessor.setDisabledState(i)};r.registerOnDisabledChange(t),e._registerOnDestroy(()=>{r._unregisterOnDisabledChange(t)})}}(r,e)}function Fg(r,e){r.forEach(t=>{t.registerOnValidatorChange&&t.registerOnValidatorChange(e)})}function cF(r,e){r._pendingDirty&&r.markAsDirty(),r.setValue(r._pendingValue,{emitModelToViewChange:!1}),e.viewToModelUpdate(r._pendingValue),r._pendingChange=!1}function fF(r,e){const t=r.indexOf(e);t>-1&&r.splice(t,1)}function pF(r){return"object"==typeof r&&null!==r&&2===Object.keys(r).length&&"value"in r&&"disabled"in r}const fte={provide:Xl,useExisting:Li(()=>$S)},vF=(()=>Promise.resolve())();let $S=(()=>{class r extends Xl{constructor(t,i,s,n,o){super(),this._changeDetectorRef=o,this.control=new class extends class lF{constructor(e,t){this._pendingDirty=!1,this._hasOwnPendingAsyncValidator=!1,this._pendingTouched=!1,this._onCollectionChange=()=>{},this._parent=null,this.pristine=!0,this.touched=!1,this._onDisabledChange=[],this._rawValidators=e,this._rawAsyncValidators=t,this._composedValidatorFn=rF(this._rawValidators),this._composedAsyncValidatorFn=nF(this._rawAsyncValidators)}get validator(){return this._composedValidatorFn}set validator(e){this._rawValidators=this._composedValidatorFn=e}get asyncValidator(){return this._composedAsyncValidatorFn}set asyncValidator(e){this._rawAsyncValidators=this._composedAsyncValidatorFn=e}get parent(){return this._parent}get valid(){return this.status===$f}get invalid(){return this.status===Dg}get pending(){return this.status==wu}get disabled(){return this.status===Kf}get enabled(){return this.status!==Kf}get dirty(){return!this.pristine}get untouched(){return!this.touched}get updateOn(){return this._updateOn?this._updateOn:this.parent?this.parent.updateOn:"change"}setValidators(e){this._rawValidators=e,this._composedValidatorFn=rF(e)}setAsyncValidators(e){this._rawAsyncValidators=e,this._composedAsyncValidatorFn=nF(e)}addValidators(e){this.setValidators(ZN(e,this._rawValidators))}addAsyncValidators(e){this.setAsyncValidators(ZN(e,this._rawAsyncValidators))}removeValidators(e){this.setValidators(JN(e,this._rawValidators))}removeAsyncValidators(e){this.setAsyncValidators(JN(e,this._rawAsyncValidators))}hasValidator(e){return Mg(this._rawValidators,e)}hasAsyncValidator(e){return Mg(this._rawAsyncValidators,e)}clearValidators(){this.validator=null}clearAsyncValidators(){this.asyncValidator=null}markAsTouched(e={}){this.touched=!0,this._parent&&!e.onlySelf&&this._parent.markAsTouched(e)}markAllAsTouched(){this.markAsTouched({onlySelf:!0}),this._forEachChild(e=>e.markAllAsTouched())}markAsUntouched(e={}){this.touched=!1,this._pendingTouched=!1,this._forEachChild(t=>{t.markAsUntouched({onlySelf:!0})}),this._parent&&!e.onlySelf&&this._parent._updateTouched(e)}markAsDirty(e={}){this.pristine=!1,this._parent&&!e.onlySelf&&this._parent.markAsDirty(e)}markAsPristine(e={}){this.pristine=!0,this._pendingDirty=!1,this._forEachChild(t=>{t.markAsPristine({onlySelf:!0})}),this._parent&&!e.onlySelf&&this._parent._updatePristine(e)}markAsPending(e={}){this.status=wu,!1!==e.emitEvent&&this.statusChanges.emit(this.status),this._parent&&!e.onlySelf&&this._parent.markAsPending(e)}disable(e={}){const t=this._parentMarkedDirty(e.onlySelf);this.status=Kf,this.errors=null,this._forEachChild(i=>{i.disable({...e,onlySelf:!0})}),this._updateValue(),!1!==e.emitEvent&&(this.valueChanges.emit(this.value),this.statusChanges.emit(this.status)),this._updateAncestors({...e,skipPristineCheck:t}),this._onDisabledChange.forEach(i=>i(!0))}enable(e={}){const t=this._parentMarkedDirty(e.onlySelf);this.status=$f,this._forEachChild(i=>{i.enable({...e,onlySelf:!0})}),this.updateValueAndValidity({onlySelf:!0,emitEvent:e.emitEvent}),this._updateAncestors({...e,skipPristineCheck:t}),this._onDisabledChange.forEach(i=>i(!1))}_updateAncestors(e){this._parent&&!e.onlySelf&&(this._parent.updateValueAndValidity(e),e.skipPristineCheck||this._parent._updatePristine(),this._parent._updateTouched())}setParent(e){this._parent=e}getRawValue(){return this.value}updateValueAndValidity(e={}){this._setInitialStatus(),this._updateValue(),this.enabled&&(this._cancelExistingSubscription(),this.errors=this._runValidator(),this.status=this._calculateStatus(),(this.status===$f||this.status===wu)&&this._runAsyncValidator(e.emitEvent)),!1!==e.emitEvent&&(this.valueChanges.emit(this.value),this.statusChanges.emit(this.status)),this._parent&&!e.onlySelf&&this._parent.updateValueAndValidity(e)}_updateTreeValidity(e={emitEvent:!0}){this._forEachChild(t=>t._updateTreeValidity(e)),this.updateValueAndValidity({onlySelf:!0,emitEvent:e.emitEvent})}_setInitialStatus(){this.status=this._allControlsDisabled()?Kf:$f}_runValidator(){return this.validator?this.validator(this):null}_runAsyncValidator(e){if(this.asyncValidator){this.status=wu,this._hasOwnPendingAsyncValidator=!0;const t=HN(this.asyncValidator(this));this._asyncValidationSubscription=t.subscribe(i=>{this._hasOwnPendingAsyncValidator=!1,this.setErrors(i,{emitEvent:e})})}}_cancelExistingSubscription(){this._asyncValidationSubscription&&(this._asyncValidationSubscription.unsubscribe(),this._hasOwnPendingAsyncValidator=!1)}setErrors(e,t={}){this.errors=e,this._updateControlsErrors(!1!==t.emitEvent)}get(e){let t=e;return null==t||(Array.isArray(t)||(t=t.split(".")),0===t.length)?null:t.reduce((i,s)=>i&&i._find(s),this)}getError(e,t){const i=t?this.get(t):this;return i&&i.errors?i.errors[e]:null}hasError(e,t){return!!this.getError(e,t)}get root(){let e=this;for(;e._parent;)e=e._parent;return e}_updateControlsErrors(e){this.status=this._calculateStatus(),e&&this.statusChanges.emit(this.status),this._parent&&this._parent._updateControlsErrors(e)}_initObservables(){this.valueChanges=new Ts,this.statusChanges=new Ts}_calculateStatus(){return this._allControlsDisabled()?Kf:this.errors?Dg:this._hasOwnPendingAsyncValidator||this._anyControlsHaveStatus(wu)?wu:this._anyControlsHaveStatus(Dg)?Dg:$f}_anyControlsHaveStatus(e){return this._anyControls(t=>t.status===e)}_anyControlsDirty(){return this._anyControls(e=>e.dirty)}_anyControlsTouched(){return this._anyControls(e=>e.touched)}_updatePristine(e={}){this.pristine=!this._anyControlsDirty(),this._parent&&!e.onlySelf&&this._parent._updatePristine(e)}_updateTouched(e={}){this.touched=this._anyControlsTouched(),this._parent&&!e.onlySelf&&this._parent._updateTouched(e)}_registerOnCollectionChange(e){this._onCollectionChange=e}_setUpdateStrategy(e){wg(e)&&null!=e.updateOn&&(this._updateOn=e.updateOn)}_parentMarkedDirty(e){return!e&&!(!this._parent||!this._parent.dirty)&&!this._parent._anyControlsDirty()}_find(e){return null}}{constructor(e=null,t,i){super(function zS(r){return(wg(r)?r.validators:r)||null}(t),function HS(r,e){return(wg(e)?e.asyncValidators:r)||null}(i,t)),this.defaultValue=null,this._onChange=[],this._pendingChange=!1,this._applyFormState(e),this._setUpdateStrategy(t),this._initObservables(),this.updateValueAndValidity({onlySelf:!0,emitEvent:!!this.asyncValidator}),wg(t)&&(t.nonNullable||t.initialValueIsDefault)&&(this.defaultValue=pF(e)?e.value:e)}setValue(e,t={}){this.value=this._pendingValue=e,this._onChange.length&&!1!==t.emitModelToViewChange&&this._onChange.forEach(i=>i(this.value,!1!==t.emitViewToModelChange)),this.updateValueAndValidity(t)}patchValue(e,t={}){this.setValue(e,t)}reset(e=this.defaultValue,t={}){this._applyFormState(e),this.markAsPristine(t),this.markAsUntouched(t),this.setValue(this.value,t),this._pendingChange=!1}_updateValue(){}_anyControls(e){return!1}_allControlsDisabled(){return this.disabled}registerOnChange(e){this._onChange.push(e)}_unregisterOnChange(e){fF(this._onChange,e)}registerOnDisabledChange(e){this._onDisabledChange.push(e)}_unregisterOnDisabledChange(e){fF(this._onDisabledChange,e)}_forEachChild(e){}_syncPendingControls(){return!("submit"!==this.updateOn||(this._pendingDirty&&this.markAsDirty(),this._pendingTouched&&this.markAsTouched(),!this._pendingChange)||(this.setValue(this._pendingValue,{onlySelf:!0,emitModelToViewChange:!1}),0))}_applyFormState(e){pF(e)?(this.value=this._pendingValue=e.value,e.disabled?this.disable({onlySelf:!0,emitEvent:!1}):this.enable({onlySelf:!0,emitEvent:!1})):this.value=this._pendingValue=e}},this._registered=!1,this.update=new Ts,this._parent=t,this._setValidators(i),this._setAsyncValidators(s),this.valueAccessor=function YS(r,e){if(!e)return null;let t,i,s;return Array.isArray(e),e.forEach(n=>{n.constructor===Rg?t=n:function lte(r){return Object.getPrototypeOf(r.constructor)===$c}(n)?i=n:s=n}),s||i||t||null}(0,n)}ngOnChanges(t){if(this._checkForErrors(),!this._registered||"name"in t){if(this._registered&&(this._checkName(),this.formDirective)){const i=t.name.previousValue;this.formDirective.removeControl({name:i,path:this._getPath(i)})}this._setUpControl()}"isDisabled"in t&&this._updateDisabled(t),function jS(r,e){if(!r.hasOwnProperty("model"))return!1;const t=r.model;return!!t.isFirstChange()||!Object.is(e,t.currentValue)}(t,this.viewModel)&&(this._updateValue(this.model),this.viewModel=this.model)}ngOnDestroy(){this.formDirective&&this.formDirective.removeControl(this)}get path(){return this._getPath(this.name)}get formDirective(){return this._parent?this._parent.formDirective:null}viewToModelUpdate(t){this.viewModel=t,this.update.emit(t)}_setUpControl(){this._setUpdateStrategy(),this._isStandalone()?this._setUpStandalone():this.formDirective.addControl(this),this._registered=!0}_setUpdateStrategy(){this.options&&null!=this.options.updateOn&&(this.control._updateOn=this.options.updateOn)}_isStandalone(){return!this._parent||!(!this.options||!this.options.standalone)}_setUpStandalone(){Qf(this.control,this),this.control.updateValueAndValidity({emitEvent:!1})}_checkForErrors(){this._isStandalone()||this._checkParentType(),this._checkName()}_checkParentType(){}_checkName(){this.options&&this.options.name&&(this.name=this.options.name),this._isStandalone()}_updateValue(t){vF.then(()=>{this.control.setValue(t,{emitViewToModelChange:!1}),this._changeDetectorRef?.markForCheck()})}_updateDisabled(t){const i=t.isDisabled.currentValue,s=0!==i&&za(i);vF.then(()=>{s&&!this.control.disabled?this.control.disable():!s&&this.control.disabled&&this.control.enable(),this._changeDetectorRef?.markForCheck()})}_getPath(t){return this._parent?function Og(r,e){return[...e.path,r]}(t,this._parent):[t]}}return r.\u0275fac=function(t){return new(t||r)(xe(jr,9),xe(Mr,10),xe(Wl,10),xe(ca,10),xe(Vm,8))},r.\u0275dir=St({type:r,selectors:[["","ngModel","",3,"formControlName","",3,"formControl",""]],inputs:{name:"name",isDisabled:["disabled","isDisabled"],model:["ngModel","model"],options:["ngModelOptions","options"]},outputs:{update:"ngModelChange"},exportAs:["ngModel"],features:[Ji([fte]),Ti,ro]}),r})(),yF=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=io({type:r}),r.\u0275inj=Rn({}),r})(),Kc=(()=>{class r{constructor(){this._validator=Ig}ngOnChanges(t){if(this.inputName in t){const i=this.normalizeInput(t[this.inputName].currentValue);this._enabled=this.enabled(i),this._validator=this._enabled?this.createValidator(i):Ig,this._onChange&&this._onChange()}}validate(t){return this._validator(t)}registerOnValidatorChange(t){this._onChange=t}enabled(t){return null!=t}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275dir=St({type:r,features:[ro]}),r})();const wte={provide:Mr,useExisting:Li(()=>Bg),multi:!0};let Bg=(()=>{class r extends Kc{constructor(){super(...arguments),this.inputName="required",this.normalizeInput=za,this.createValidator=t=>LN}enabled(t){return t}}return r.\u0275fac=function(){let e;return function(i){return(e||(e=Cr(r)))(i||r)}}(),r.\u0275dir=St({type:r,selectors:[["","required","","formControlName","",3,"type","checkbox"],["","required","","formControl","",3,"type","checkbox"],["","required","","ngModel","",3,"type","checkbox"]],hostVars:1,hostBindings:function(t,i){2&t&&sa("required",i._enabled?"":null)},inputs:{required:"required"},features:[Ji([wte]),Ti]}),r})(),Vte=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=io({type:r}),r.\u0275inj=Rn({imports:[yF]}),r})(),Ute=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=io({type:r}),r.\u0275inj=Rn({imports:[Vte]}),r})();const VF="*[_ngcontent-%COMP%]{margin:0;padding:0}body[_ngcontent-%COMP%]{margin:0;font-family:cursive;font-size:20px;color:#000;line-height:1.6;display:flex;height:100vh;flex-direction:column}#background[_ngcontent-%COMP%]{background-image:url(https://img.freepik.com/free-vector/copy-space-bokeh-spring-lights-background_52683-55649.jpg);background-size:cover;background-position:center}#showcase[_ngcontent-%COMP%]{height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:0 20px}#footer[_ngcontent-%COMP%]{margin-left:40px;margin-bottom:20px;justify-content:left;align-items:left;text-align:left}.input-group[_ngcontent-%COMP%]{margin-top:20px;display:flex;justify-content:center;align-items:center;gap:10px;width:200px}";let Gte=(()=>{class r{constructor(t,i){this.router=t,this.data=i,this.name=[]}ngOnInit(){}ChangePageRules(){this.router.navigate(["Rules"])}ChangePageModel(){this.data.addName(this.joueur1),this.data.addName(this.joueur2),this.data.initializeP1(),this.data.initializeP2(),this.router.navigate(["Model"])}onNameChange(t,i){this.data.addName(t)}}return r.\u0275fac=function(t){return new(t||r)(xe(Hs),xe(Ag))},r.\u0275cmp=Il({type:r,selectors:[["app-accueil"]],decls:19,vars:2,consts:[["name","viewport","content","width=device-width, initial-scale=1.0"],["id","background"],["id","showcase"],[1,"input-group","mb-3"],["type","text","id","joueur1","required","","placeholder","Joueur 1",1,"form-control",3,"ngModel","ngModelChange"],["type","text","id","joueur2","required","","placeholder","Joueur 2",1,"form-control",3,"ngModel","ngModelChange"],["src","assets/play.png","alt","Button Image","height","30","width","30",3,"click"],["id","footer"],["src","assets/question.png","alt","Tutoriel","height","30","width","30",2,"margin-left","40px",3,"click"]],template:function(t,i){1&t&&(ut(0,"html")(1,"head"),oi(2,"meta",0),ut(3,"title"),ii(4,"Questions popup"),bt()(),ut(5,"body",1)(6,"header",2)(7,"h1"),ii(8,"Bienvenue sur Quizzable"),bt(),ut(9,"div",3)(10,"input",4),br("ngModelChange",function(n){return i.joueur1=n}),bt(),ut(11,"input",5),br("ngModelChange",function(n){return i.joueur2=n}),bt()(),ut(12,"p"),ii(13,"Demarrer la partie"),bt(),ut(14,"img",6),br("click",function(){return i.ChangePageModel()}),bt()(),ut(15,"footer",7)(16,"p"),ii(17,"Comment jouer"),bt(),ut(18,"img",8),br("click",function(){return i.ChangePageRules()}),bt()()()()),2&t&&(ux(10),Tm("ngModel",i.joueur1),ux(1),Tm("ngModel",i.joueur2))},dependencies:[Rg,iF,Bg,$S],styles:[VF,VF]}),r})();const zte=JSON.parse('{"G":[{"id":1,"question":"Combien de temps faut-il pour que le CO2 soit \xe9limin\xe9 de l\'atmosph\xe8re?","categorie":"Air","responses":["Quelques ann\xe9es","Des d\xe9cennies","Des si\xe8cles"]},{"id":2,"question":"Comment appelle-t-on la couche de gaz qui entoure la Terre?","categorie":"Air","responses":["La stratosph\xe8re","L\'ionosph\xe8re","L\'atmosph\xe8re"]},{"id":3,"question":"Quelle est la couche de l\'atmosph\xe8re qui contient la plupart des gaz de l\'air","categorie":"Air","responses":["La stratosph\xe8re","La m\xe9sosph\xe8re\'","La troposph\xe8re"]},{"id":4,"question":"Quel est le gaz le plus abondant dans l\'atmosph\xe8re terrestre ?","categorie":"Air","responses":["L\'oxyg\xe8ne","L\'azote","Le dioxyde de carbone"]},{"id":5,"question":"Quel est le nom du ph\xe9nom\xe8ne qui se produit lorsqu\'\'une masse d\'\'air chaud rencontre une masse d\'air froid ?","categorie":"Air","responses":["Une d\xe9pression","Un anticyclone","Une fronti\xe8re"]},{"id":6,"question":"\xc0 quelle altitude l\'\'air devient-il techniquement consid\xe9r\xe9 comme \'air rare\' ?","categorie":"Air","responses":["2 500 m\xe8tres","3 500 m\xe8tres","5 000 m\xe8tres"]},{"id":7,"question":"De quelle couleur est le ciel \xe0 haute altitude ?","categorie":"Air","responses":["Noir","Bleu","Gris"]},{"id":8,"question":"Combien de temps peut-on survivre sans air ?","categorie":"Air","responses":["1 minute","5 minutes","10 minutes"]},{"id":9,"question":"Dans quelle ville a \xe9t\xe9 r\xe9alis\xe9 le premier vol en ballon captif en 1783 ?","categorie":"Air","responses":["Paris","Londres","New York"]},{"id":10,"question":"Quel est le principal gaz \xe0 effet de serre produit par les activit\xe9s humaines ?","categorie":"Air","responses":["Le m\xe9thane","Le dioxyde de carbone","L\'ozone"]},{"id":11,"question":"\xc0 quelle vitesse peut voyager un avion de ligne \xe0 haute altitude ?","categorie":"Air","responses":["500 km/h","800 km/h","1 000 km/h"]},{"id":12,"question":"Quel est le nom de l\'instrument utilis\xe9 pour mesurer la pression atmosph\xe9rique ?","categorie":"Air","responses":["Un barom\xe8tre","Un thermom\xe8tre","Un hygrom\xe8tre"]},{"id":13,"question":"Quel est le nom de la zone atmosph\xe9rique o\xf9 se produit la plupart des ph\xe9nom\xe8nes m\xe9t\xe9orologiques ?","categorie":"Air","responses":["La stratosph\xe8re","La m\xe9sosph\xe8re","La troposph\xe8re"]},{"id":14,"question":"Quel est le nom de l\'\'instrument utilis\xe9 pour mesurer la vitesse du vent ?","categorie":"Air","responses":["Un an\xe9mom\xe8tre","Un barom\xe8tre","Un thermom\xe8tre"]},{"id":15,"question":"Quelle est la vitesse de la lumi\xe8re dans l\'\'air ?","categorie":"Air","responses":["299 792 km/s","299 792 458 m/s","299 792 458 km/s"]},{"id":16,"question":"Quelle est la temp\xe9rature \xe0 laquelle l\'eau g\xe8le ?","categorie":"Air","responses":["0 degr\xe9 Celsius","32 degr\xe9s Fahrenheit","Les deux"]},{"id":17,"question":"\xc0 quelle altitude se trouve la couche d\'\'ozone dans l\'atmosph\xe8re ?","categorie":"Air","responses":["Dans la troposph\xe8re","Dans la stratosph\xe8re","Dans la m\xe9sosph\xe8re"]},{"id":18,"question":"Quel est le nom de l\'\'instrument utilis\xe9 pour mesurer l\'\'humidit\xe9 de l\'air ?","categorie":"Air","responses":["Un hygrom\xe8tre","Un barom\xe8tre","Un thermom\xe8tre"]},{"id":19,"question":"Quel est le nom de la zone atmosph\xe9rique o\xf9 se trouvent les aurores bor\xe9ales et australes ?","categorie":"Air","responses":["La troposph\xe8re","La m\xe9sosph\xe8re","L\'\'ionosph\xe8re"]},{"id":20,"question":"\xc0 quelle altitude se trouve la station spatiale internationale (ISS) ?","categorie":"Air","responses":["400 km","500 km","600 km"]},{"id":21,"question":"Quel est le nom du processus par lequel l\'air chaud monte et l\'air froid descend ?","categorie":"Air","responses":["La convection","La radiation","La conduction"]},{"id":22,"question":"Quel est le nom du ph\xe9nom\xe8ne atmosph\xe9rique qui se produit lorsqu\'un front froid rencontre un front chaud ?","categorie":"Air","responses":["Une temp\xeate","Un orage","Une d\xe9pression"]},{"id":23,"question":"Quel est le nom de l\'instrument utilis\xe9 pour mesurer la qualit\xe9 de l\'air ?","categorie":"Air","responses":["Un an\xe9mom\xe8tre","Un barom\xe8tre","Un d\xe9tecteur de particules fines "]},{"id":24,"question":"Quelle est la pression atmosph\xe9rique moyenne au niveau de la mer ?","categorie":"Air","responses":["1 013 hPa","101,3 kPa","Les deux"]},{"id":25,"question":"Quel est le nom du processus par lequel les nuages se forment \xe0 partir de la vapeur d\'eau dans l\'air ?","categorie":"Air","responses":["L\'\'\xe9vaporation","La condensation","La pr\xe9cipitation"]},{"id":26,"question":"Quelle est la temp\xe9rature moyenne annuelle en France mesur\xe9e en 2020?","categorie":"Climat","responses":["14.1\xb0C","15.6\xb0C","18.2\xb0C"]},{"id":27,"question":"Quelle est la principale cause de l\'augmentation du niveau de la mer ?","categorie":"Climat","responses":["La fonte des glaciers et des calottes glaciaires","L\'expansion thermique de l\'\'eau de mer","L\'activit\xe9 sismique"]},{"id":28,"question":"Qu\'est-ce qui peut causer le changement climatique ?","categorie":"Climat","responses":["Les activit\xe9s humaines","Les \xe9ruptions volcaniques","Les mouvements tectoniques"]},{"id":29,"question":"Quelle est la diff\xe9rence entre le climat et la m\xe9t\xe9o ?","categorie":"Climat","responses":["Le climat est \xe0 long terme et la m\xe9t\xe9o est \xe0 court terme","Le climat concerne la temp\xe9rature et la m\xe9t\xe9o concerne la pr\xe9cipitation","Le climat est affect\xe9 par l\'activit\xe9 humaine et la m\xe9t\xe9o ne l\'est pas"]},{"id":30,"question":"Quel est l\'effet des temp\xeates tropicales sur le climat ?","categorie":"Climat","responses":["Elles contribuent \xe0 la r\xe9gulation de la temp\xe9rature de l\'oc\xe9an","Elles perturbent le cycle de l\'eau dans l\'atmosph\xe8re","Elles provoquent des variations de pression atmosph\xe9rique"]},{"id":31,"question":"Qu\'est-ce que l\'acidification des oc\xe9ans ?","categorie":"Climat","responses":["L\'augmentation de la salinit\xe9 de l\'eau de mer","La diminution du pH de l\'eau de mer","L\'\xe9l\xe9vation de la temp\xe9rature de l\'eau de mer"]},{"id":32,"question":"Quel est le principal facteur qui influence le climat dans une r\xe9gion donn\xe9e ?","categorie":"Climat","responses":["L\'altitude","La latitude","La proximit\xe9 de la mer"]},{"id":33,"question":"Quelle est l\'importance des courants oc\xe9aniques dans la r\xe9gulation du climat ?","categorie":"Climat","responses":["Ils transportent des nutriments essentiels pour les \xe9cosyst\xe8mes marins","Ils redistribuent la chaleur \xe0 travers les oc\xe9ans","Ils augmentent la pression atmosph\xe9rique sur les c\xf4tes"]},{"id":34,"question":"Qu\'est-ce que la couche d\'ozone ?","categorie":"Climat","responses":["Une couche de gaz dans la haute atmosph\xe8re qui prot\xe8ge la Terre des rayons UV du soleil","Une couche de nuages qui r\xe9gule la temp\xe9rature de la Terre","Une couche de poussi\xe8re qui r\xe9duit la visibilit\xe9 dans l\'\'atmosph\xe8re"]},{"id":35,"question":"Quel est l\'impact du changement climatique sur la biodiversit\xe9 ?","categorie":"Climat","responses":["Il augmente la diversit\xe9 des \xe9cosyst\xe8mes","Il provoque l\'extinction de nombreuses esp\xe8ces animales et v\xe9g\xe9tales","Il favorise la migration des esp\xe8ces vers des zones plus adapt\xe9es"]},{"id":36,"question":"Qu\'est-ce que l\'effet albedo ?","categorie":"Climat","responses":["La capacit\xe9 d\'une surface \xe0 absorber la lumi\xe8re du soleil","La capacit\xe9 d\'une surface \xe0 stocker la chaleur","La capacit\xe9 d\'\'une surface \xe0 r\xe9fl\xe9chir la lumi\xe8re du soleil"]},{"id":37,"question":"Quel est l\'impact du r\xe9chauffement climatique sur les r\xe9gions polaires ?","categorie":"Climat","responses":["L\'augmentation de la densit\xe9 de l\'air froid","La diminution de la salinit\xe9 de l\'eau de mer","La fonte des glaciers et de la banquise"]},{"id":38,"question":"Qu\'est-ce que la d\xe9sertification ?","categorie":"Climat","responses":["La transformation d\'une r\xe9gion aride en une r\xe9gion fertile","La perte de v\xe9g\xe9tation et la d\xe9gradation des sols dans les r\xe9gions semi-arides","L\'expansion des d\xe9serts en dehors de leur zone d\'origine"]},{"id":39,"question":"Qu\'est-ce que l\'effet El Ni\xf1o ?","categorie":"Climat","responses":["Un ph\xe9nom\xe8ne m\xe9t\xe9orologique qui provoque des temp\xeates tropicales dans l\'oc\xe9an Atlantique","Un ph\xe9nom\xe8ne m\xe9t\xe9orologique qui provoque une \xe9l\xe9vation de la temp\xe9rature de l\'oc\xe9an Pacifique","Un ph\xe9nom\xe8ne m\xe9t\xe9orologique qui provoque une diminution de la pression atmosph\xe9rique dans l\'h\xe9misph\xe8re sud"]},{"id":40,"question":"Qu\'est-ce que la biomasse ?","categorie":"Climat","responses":["La quantit\xe9 totale de mati\xe8re organique pr\xe9sente dans un \xe9cosyst\xe8me","La quantit\xe9 d\'eau stock\xe9e dans les organismes vivants","La quantit\xe9 de lumi\xe8re solaire absorb\xe9e par les plantes"]},{"id":41,"question":"Quel est le plus grand \xe9metteur de gaz \xe0 effet de serre dans le monde?","categorie":"Climat","responses":["Les \xc9tats-Unis","La Chine","L\'Union Europ\xe9enne"]},{"id":42,"question":"\xc0 quelle distance se trouve la Terre du soleil?","categorie":"Climat","responses":["93 millions de miles","93 millions de kilom\xe8tres","930 millions de kilom\xe8tres"]},{"id":43,"question":"Quelle est la principale source d\'\xe9nergie renouvelable dans le monde?","categorie":"Climat","responses":["L\'\xe9nergie solaire","L\'\xe9nergie \xe9olienne","L\'\xe9nergie hydraulique"]},{"id":44,"question":"Qu\'est-ce que l\'indice de chaleur?","categorie":"Climat","responses":["Une mesure de la quantit\xe9 de chaleur produite par une source d\'\xe9nergie","Une mesure de la temp\xe9rature ressentie par le corps en raison de l\'humidit\xe9","Une mesure de la temp\xe9rature de l\'air dans un lieu donn\xe9"]},{"id":45,"question":"Quel est le plus grand glacier au monde?","categorie":"Climat","responses":["Le glacier Lambert en Antarctique","Le glacier Vatnaj\xf6kull en Islande","Le glacier Columbia en Colombie-Britannique,Canada"]},{"id":46,"question":"Quelle est la plus grande source de gaz \xe0 effet de serre dans l\'agriculture?","categorie":"Climat","responses":["Les engrais","Le b\xe9tail","Les machines agricoles"]},{"id":47,"question":"Quel est le plus grand d\xe9sert chaud du monde?","categorie":"Climat","responses":["58 degr\xe9s Celsius (136,4 degr\xe9s Fahrenheit) en Libye en 1922","56,7 degr\xe9s Celsius (134 degr\xe9s Fahrenheit) en Californie en 1913","55 degr\xe9s Celsius (131 degr\xe9s Fahrenheit) en Australie en 1960"]},{"id":48,"question":"Qu\'est-ce que le Gulf Stream ?","categorie":"Climat","responses":["Le d\xe9sert du Sahara en Afrique du Nord","Le d\xe9sert du Kalahari en Afrique australe","Le d\xe9sert d\'Arabie en Asie de l\'Ouest"]},{"id":49,"question":"Quelle est la temp\xe9rature la plus \xe9lev\xe9e jamais enregistr\xe9e sur Terre?","categorie":"Climat","responses":["Un courant d\'air chaud qui se d\xe9place dans l\'atmosph\xe8re","Un courant oc\xe9anique chaud qui transporte de l\'eau chaude de l\'\xe9quateur vers les r\xe9gions polaires","Une r\xe9gion chaude de l\'oc\xe9an Atlantique o\xf9 les ouragans se forment"]},{"id":50,"question":"Qu\'est-ce que la s\xe9questration du carbone?","categorie":"Climat","responses":["Le stockage du carbone dans l\'atmosph\xe8re","La transformation du carbone en un autre \xe9l\xe9ment","Le stockage du carbone dans des puits de carbone"]},{"id":51,"question":"Combien de temps faut-il pour qu\'une bouteille en plastique se d\xe9compose dans la nature?","categorie":"Dechets","responses":["50 ans","100 ans","500 ans"]},{"id":52,"question":"Quelle est la dur\xe9e de vie moyenne d\'une bouteille en plastique dans un d\xe9potoir ?","categorie":"Dechets","responses":["10 ans","100 ans","1000 ans"]},{"id":53,"question":"Combien de temps faut-il pour qu\'un chewing-gum se d\xe9compose dans la nature ?","categorie":"Dechets","responses":["2 jours","2 semaines","2 ans"]},{"id":54,"question":"Quel est le pourcentage de d\xe9chets plastiques qui ont \xe9t\xe9 recycl\xe9s depuis que le recyclage a \xe9t\xe9 introduit ?","categorie":"Dechets","responses":["5%","20%","50%"]},{"id":55,"question":"Quel est le principal mat\xe9riau utilis\xe9 pour fabriquer des sacs en plastique ?","categorie":"Dechets","responses":["Polypropyl\xe8ne","Poly\xe9thyl\xe8ne","Polycarbonate"]},{"id":56,"question":"Combien de tonnes de d\xe9chets \xe9lectroniques sont g\xe9n\xe9r\xe9es chaque ann\xe9e dans le monde ?","categorie":"Dechets","responses":["10 millions de tonnes","50 millions de tonnes","100 millions de tonnes"]},{"id":57,"question":"Quel est le gaz \xe0 effet de serre le plus \xe9mis par les d\xe9charges ?","categorie":"Dechets","responses":["Le m\xe9thane","Le dioxyde de carbone","L\'\'oxyde d\'\'azote"]},{"id":58,"question":"Quel est le principal type de d\xe9chet produit par les m\xe9nages aux \xc9tats-Unis ?","categorie":"Dechets","responses":["Les d\xe9chets alimentaires","Les d\xe9chets de jardin","Les d\xe9chets de papier"]},{"id":59,"question":"Combien de bouteilles en plastique sont vendues chaque minute dans le monde ?","categorie":"Dechets","responses":["1 million","10 millions","100 millions"]},{"id":60,"question":"Quelle est la quantit\xe9 de papier que les \xc9tats-Unis jettent chaque ann\xe9e ?","categorie":"Dechets","responses":["10 millions de tonnes","50 millions de tonnes","100 millions de tonnes"]},{"id":61,"question":"Combien de temps faut-il pour qu\'une canette en aluminium se d\xe9compose dans la nature ?","categorie":"Dechets","responses":["50 ans","100 ans","500 ans"]},{"id":62,"question":"Quelle est la quantit\xe9 de d\xe9chets \xe9lectroniques produite par personne chaque ann\xe9e dans le monde ?","categorie":"Dechets","responses":["1 kg","5 kg","10 kg\'"]},{"id":63,"question":"Quelle est la ville la plus peupl\xe9e des \xc9tats-Unis \xe0 interdire les pailles en plastique ?","categorie":"Dechets","responses":["New York","Los Angeles","Chicago"]},{"id":64,"question":"Quel est le pourcentage de d\xe9chets plastiques qui finissent dans l\'oc\xe9an ?","categorie":"Dechets","responses":["5%","10%","25%"]},{"id":65,"question":"Combien de temps faut-il pour qu\'un m\xe9got de cigarette se d\xe9compose dans la nature ?","categorie":"Dechets","responses":["1 an","5 ans","10 ans"]},{"id":66,"question":"Quel est le pourcentage de d\xe9chets alimentaires gaspill\xe9s chaque ann\xe9e dans le monde ?","categorie":"Dechets","responses":["10%","25%","30%"]},{"id":67,"question":"Quel est le principal produit plastique jetable utilis\xe9 dans le monde ?","categorie":"Dechets","responses":["Les gobelets en plastique","Les couverts en plastique","Les pailles en plastique"]},{"id":68,"question":"Combien de temps faut-il pour qu\'une bouteille en verre se d\xe9compose dans la nature ?","categorie":"Dechets","responses":["100 ans","500 ans","1000 ans"]},{"id":69,"question":"Quel est le principal type de d\xe9chet g\xe9n\xe9r\xe9 par l\'industrie de la construction ?","categorie":"Dechets","responses":["Les d\xe9chets de bois","Les d\xe9chets de b\xe9ton","Les d\xe9chets de m\xe9tal"]},{"id":70,"question":"Quel est le pourcentage de papier recycl\xe9 dans le monde en 2021 ?","categorie":"Dechets","responses":["25%","50%","75%"]},{"id":71,"question":"Quelle est la ville la plus verte des \xc9tats-Unis en termes de gestion des d\xe9chets ?\'","categorie":"Dechets","responses":["San Francisco","Seattle","Portland"]},{"id":72,"question":"Combien de tonnes de d\xe9chets alimentaires sont produits chaque ann\xe9e dans le monde ?","categorie":"Dechets","responses":["500 millions de tonnes","1 milliard de tonnes","2 milliards de tonnes"]},{"id":73,"question":"Quel est le principal mat\xe9riau utilis\xe9 pour fabriquer des bouteilles en verre ?","categorie":"Dechets","responses":["Le verre borosilicate","Le verre au plomb","Le verre de silice"]},{"id":74,"question":"Quelle est la ville la plus peupl\xe9e d\'Europe \xe0 interdire les voitures diesel ?","categorie":"Dechets","responses":["Madrid","Berlin","Paris"]},{"id":75,"question":"Quel est le pourcentage de d\xe9chets \xe9lectroniques export\xe9s vers les pays en d\xe9veloppement chaque ann\xe9e ?","categorie":"Dechets","responses":["10%","25%","50%"]},{"id":76,"question":"La biodiversit\xe9 peut \xeatre d\xe9finie de mani\xe8re suivante:","categorie":"Biologie","responses":["La pr\xe9sence d\'une esp\xe8ce prot\xe9g\xe9e dans une certaine zone","Le nombre d\'esp\xe8ces de familles et de genres diff\xe9rents pr\xe9sents dans un biotope","Le nombre d\'\'individus pr\xe9sents dans un biotope"]},{"id":77,"question":"Quel animal parmi les suivants ne fait pas partie des animaux prot\xe9g\xe9s en France?","categorie":"Biologie","responses":["L\'\'h\xe9risson","Le castor","Le lapin "]},{"id":78,"question":"Dans le cas des plantes vertes, la photosynth\xe8se est effectu\xe9e:","categorie":"Biologie","responses":["Uniquement le jour","Uniquement la nuit","Le jour et la nuit"]},{"id":79,"question":"Dans le cas des plantes vertes, le processus de photosynth\xe8se:","categorie":"Biologie","responses":["Produce du CO2","Produce de l\'\'O2","Ne produce rien"]},{"id":80,"question":"Qu\'est-ce qu\'une cellule?","categorie":"Biologie","responses":["La plus petite unit\xe9 de la vie","La plus grande unit\xe9 de la vie","La plus complexe unit\xe9 de la vie"]},{"id":81,"question":"Qu\'est-ce qu\'un organe?","categorie":"Biologie","responses":["Une structure unique du corps humain","Une collection de cellules du corps humain","Une partie du syst\xe8me nerveux"]},{"id":82,"question":"Quelle est la fonction de l\'ADN?","categorie":"Biologie","responses":["Stocke et transmet les informations g\xe9n\xe9tiques","Fabrique les prot\xe9ines","Transporte l\'\'oxyg\xe8ne dans le corps"]},{"id":83,"question":"Comment est form\xe9 un organisme multicellulaire?","categorie":"Biologie","responses":["Par fusion de plusieurs cellules","Par division de cellules","Par la croissance et la sp\xe9cialisation des cellules"]},{"id":84,"question":"Quel est le r\xf4le des mitochondries dans une cellule?","categorie":"Biologie","responses":["Stockage de l\'\'\xe9nergie","Production d\'\'\xe9nergie","Transport de l\'\'\xe9nergie"]},{"id":85,"question":"Qu\'est-ce que la respiration cellulaire?","categorie":"Biologie","responses":["Le processus par lequel les cellules produisent de l\'\'\xe9nergie","Le processus par lequel les cellules stockent de l\'\'\xe9nergie","Le processus par lequel les cellules utilisent de l\'\'\xe9nergie"]},{"id":86,"question":"Qu\'est-ce que la reproduction sexu\xe9e?","categorie":"Biologie","responses":["La reproduction par division de cellule","La reproduction par fusion de cellules","La reproduction par fusion de gam\xe8tes"]},{"id":87,"question":"Qu\'est-ce que la m\xe9iose?","categorie":"Biologie","responses":["La division cellulaire qui produit des cellules germinales","La division cellulaire qui produit des cellules somatiques","La division cellulaire qui produit des cellules souches"]},{"id":88,"question":"Qu\'est-ce que l\'\xe9volution?","categorie":"Biologie","responses":["Le processus par lequel les esp\xe8ces changent au fil du temps","Le processus par lequel les esp\xe8ces restent inchang\xe9es au fil du temps","Le processus par lequel les esp\xe8ces se d\xe9veloppent au fil du temps"]},{"id":89,"question":"Qu\'est-ce qu\'un reptile?","categorie":"Biologie","responses":["Un animal qui pond des \u0153ufs et a une peau s\xe8che","Un animal qui allaite ses petits et a une peau s\xe8che","Un animal qui a une peau humide et pond des \u0153ufs"]},{"id":90,"question":"Quel organe du corps humain produit l\'insuline","categorie":"Biologie","responses":["Le pancr\xe9as","Le foie","Les reins"]},{"id":91,"question":"Quel est le plus petit os du corps humain ?","categorie":"Biologie","responses":["Le marteau (dans l\'\'oreille)","Le petit orteil","La rotule"]},{"id":92,"question":"Dans quelle partie de la plante se produit la photosynth\xe8se ?","categorie":"Biologie","responses":["Les racines","Les feuilles","Les fleurs"]},{"id":93,"question":"Quel organe est responsable de la filtration du sang ?","categorie":"Biologie","responses":["Les reins","Le foie","Le c\u0153ur"]},{"id":94,"question":"Dans quelle partie de l\'\u0153il se trouve la r\xe9tine ?","categorie":"Biologie","responses":["L\'\'iris","La corn\xe9e","La scl\xe9rotique"]},{"id":95,"question":"Quel est le r\xf4le principal des globules rouges ?","categorie":"Biologie","responses":["Transporter l\'\'oxyg\xe8ne","Combattre les infections","R\xe9guler la temp\xe9rature corporelle"]},{"id":96,"question":"Quel organe est responsable de la production de la bile ?","categorie":"Biologie","responses":["Le foie","Le pancr\xe9as","Les reins"]},{"id":97,"question":"Quel est le nom de l\'enzyme qui dig\xe8re les prot\xe9ines dans l\'estomac ?","categorie":"Biologie","responses":["La pepsine","La lipase","L\'\'amylase"]},{"id":98,"question":"Quel est le nom de la maladie caus\xe9e par une carence en vitamine C ","categorie":"Biologie","responses":["Le scorbut","Le rachitisme","Le b\xe9rib\xe9ri"]},{"id":99,"question":"Quel est le nom de la mol\xe9cule qui stocke l\'\xe9nergie dans les cellules ?","categorie":"Biologie","responses":["L\'\'ATP","L\'\'ADP","L\'\'AMP"]},{"id":100,"question":"Quel est le nom du processus par lequel les plantes produisent de l\'\xe9nergie en l\'absence de lumi\xe8re ?","categorie":"Biologie","responses":["La respiration cellulaire","La fermentation","La photosynth\xe8se"]},{"id":101,"question":"Quelle est la principale source de pollution plastique dans les oc\xe9ans?","categorie":"Pollution","responses":["Les d\xe9chets provenant des bateaux de p\xeache","Les d\xe9chets provenant des centrales \xe9lectriques","Les d\xe9chets provenant des rivi\xe8res et des canaux d\'\xe9coulement"]},{"id":102,"question":"Quel est le type de plastique qui met le plus de temps \xe0 se d\xe9composer?","categorie":"Pollution","responses":["Le poly\xe9thyl\xe8ne\'","Le polypropyl\xe8ne","Le polychlorure de vinyle (PVC)"]},{"id":103,"question":"Quelle est la principale utilisation du plastique qui contribue \xe0 sa pollution?","categorie":"Pollution","responses":["Emballage alimentaire","Construction de b\xe2timents","Fabrication de jouets"]},{"id":104,"question":"Quelle est la proportion de plastique qui est r\xe9cup\xe9r\xe9e et recycl\xe9e dans le monde?","categorie":"Pollution","responses":["Plus de 50%","Entre 25% et 50%","Moins de 25%"]},{"id":105,"question":"Quel est l\'\'effet le plus n\xe9faste de la pollution plastique sur les oc\xe9ans?","categorie":"Pollution","responses":["La mortalit\xe9 des animaux marins","La perturbation de l\'\'\xe9cosyst\xe8me marin","Les deux r\xe9ponses A et B\'"]},{"id":106,"question":"Quel est le principal moyen de r\xe9duire la pollution plastique?","categorie":"Pollution","responses":["La r\xe9cup\xe9ration et le recyclage des d\xe9chets plastiques","La production de plastique biod\xe9gradable","La r\xe9duction de la consommation de plastique \xe0 usage unique"]},{"id":107,"question":"Quelle est la principale source de pollution de l\'\'air en ville?","categorie":"Pollution","responses":["Les v\xe9hicules \xe0 moteur","Les usines","Les parcs d\'\'attractions"]},{"id":108,"question":"Quelle est la principale source de pollution sonore?","categorie":"Pollution","responses":["Les voitures","Les avions ","Les concerts de musique"]},{"id":109,"question":"Quelle est la principale source de pollution lumineuse?","categorie":"Pollution","responses":["Les r\xe9verb\xe8res","Les panneaux publicitaires","Les \xe9toiles"]},{"id":110,"question":"Quelle est la principale source de pollution des sols?","categorie":"Pollution","responses":["Les d\xe9chets m\xe9nagers","Les d\xe9chets industriels","Les feux de for\xeat"]},{"id":111,"question":"Quel est le principal moyen de transport responsable de la pollution de l\'\'air en ville?","categorie":"Pollution","responses":["Les voitures","Les bus","Les avions"]},{"id":112,"question":"Quel est le principal gaz \xe0 effet de serre \xe9mis par les moyens de transport?","categorie":"Pollution","responses":["Le dioxyde de carbone","Le m\xe9thane","Le protoxyde d\'azote "]},{"id":113,"question":"Quel est le principal moyen de transport \xe9cologique?","categorie":"Pollution","responses":["La voiture \xe9lectrique","Le train","Le v\xe9lo"]},{"id":114,"question":"Quel est le principal moyen de transport qui contribue \xe0 la pollution sonore?","categorie":"Pollution","responses":["Les avions","Les voitures","Les trains"]},{"id":115,"question":"Quelle est la principale source de pollution des moyens de transport terrestres?","categorie":"Pollution","responses":["Les \xe9missions de gaz d\'\'\xe9chappement","Le bruit des moteurs","Les collisions"]},{"id":116,"question":"Quel est le meilleur remplacement pour les sacs en plastique \xe0 usage unique?","categorie":"Pollution","responses":["Les sacs en papier","Les sacs en tissu r\xe9utilisable","Les sacs en plastique biod\xe9gradable"]},{"id":117,"question":"Quel est le meilleur remplacement pour les gobelets en plastique \xe0 usage unique?","categorie":"Pollution","responses":["Les gobelets en papier","Les gobelets en verre r\xe9utilisable","Les gobelets en plastique biod\xe9gradable"]},{"id":118,"question":"Quel est le meilleur remplacement pour les bouteilles en plastique \xe0 usage unique?","categorie":"Pollution","responses":["Les bouteilles en verre r\xe9utilisable","Les bouteilles en m\xe9tal r\xe9utilisable","Les bouteilles en plastique biod\xe9gradable"]},{"id":119,"question":"Quelle est la principale mesure prise par le gouvernement pour r\xe9duire la pollution de l\'\'air?","categorie":"Pollution","responses":["La mise en place de taxes sur les carburants","L\'\'interdiction des v\xe9hicules \xe0 moteur","L\'\'augmentation des subventions pour l\'\'achat de v\xe9hicules \xe9lectriques"]},{"id":120,"question":"Quelle est la principale mesure prise par le gouvernement pour r\xe9duire la pollution des villes?","categorie":"Pollution","responses":["La mise en place de zones de circulation restreinte","L\'\'interdiction de la vente de v\xe9hicules \xe0 moteur","L\'\'encouragement de l\'\'utilisation des transports en commun"]},{"id":121,"question":"Quel est le principal impact de la pollution lumineuse sur l\'\'environnement?","categorie":"Pollution","responses":["L\'\'augmentation de la temp\xe9rature","La perturbation de la reproduction des animaux","La diminution de la qualit\xe9 de l\'\'observation des \xe9toiles"]},{"id":122,"question":"Quelle est la principale cause de la pollution sonore?","categorie":"Pollution","responses":["Les avions","Les voitures","Les usines"]},{"id":123,"question":"Quels sont les effets n\xe9gatifs de la pollution sonore sur la sant\xe9 humaine?","categorie":"Pollution","responses":["La perte auditive","Les troubles du sommeil","Les deux r\xe9ponses sont vraies"]},{"id":124,"question":"Quelle est la principale cause de la pollution des sols?","categorie":"Pollution","responses":["es d\xe9chets organiques","es pesticides","es d\xe9chets industriels"]},{"id":125,"question":"Quels sont les effets n\xe9gatifs de la pollution des sols sur l\'\'environnement?","categorie":"Pollution","responses":["La perte de la biodiversit\xe9","Baisse de la temp\xe9rature","L\'\'augmentation de la temp\xe9rature"]},{"id":126,"question":"Quelle est la principale source de pollution de l\'\'eau?","categorie":"Eau","responses":["Les rejets industriels","Les pesticides utilis\xe9s dans l\'\'agriculture","La pluie acide"]},{"id":127,"question":"Quelle est la principale source de pollution des oc\xe9ans?","categorie":"Eau","responses":["Les d\xe9chets m\xe9nagers","Les d\xe9chets industriels","Les rejets de navires"]},{"id":128,"question":"Quelle est la principale source d\'\'eau potable pour les humains?","categorie":"Eau","responses":["Les rivi\xe8res","Les lacs","Les nappes phr\xe9atiques"]},{"id":129,"question":"Quels sont les principaux polluants de l\'\'eau?","categorie":"Eau","responses":["Les d\xe9chets organiques","Les m\xe9taux lourds","Les deux r\xe9ponses sont vraies"]},{"id":130,"question":"Quelle est la quantit\xe9 d\'\'eau douce disponible sur terre?","categorie":"Eau","responses":["Moins de 5%","Entre 10 et 20%","Plus de 30%"]},{"id":131,"question":"Quelle est la principale utilisation de l\'\'eau douce sur terre?","categorie":"Eau","responses":["l\'\'agriculture","l\'\'industrie","les besoins domestiques"]},{"id":132,"question":"Quel est l\'\'impact de la surexploitation des ressources en eau sur les \xe9cosyst\xe8mes?","categorie":"Eau","responses":["La diminution des populations animales","L\'\'augmentation de la salinit\xe9 de l\'eau","Les deux r\xe9ponses sont vraies"]},{"id":133,"question":"Quelle est la formule chimique de l\'\'eau?","categorie":"Eau","responses":["H2O2","CO2","H2O"]},{"id":134,"question":"De quoi est constitu\xe9 un iceberg?","categorie":"Eau","responses":["de neige fondue","de roches","de glace de mer"]},{"id":135,"question":"Quel est le pourcentage d\'\'eau sur Terre?","categorie":"Eau","responses":["50%","75%","71%"]},{"id":136,"question":"Est-ce que l\'\'eau du robinet peut \xeatre utilis\xe9e pour boire et cuisiner?","categorie":"Eau","responses":["Non","Seulement pour cuisiner","Oui"]},{"id":137,"question":"L\u2019eau est le principal constituant du corps humain, en quelle quantit\xe9 est-il pr\xe9sent?","categorie":"Eau","responses":["pr\xe9s de 60%","pr\xe9s de 80%","pr\xe9s de 75%"]},{"id":138,"question":"Combien de jours une personne peut rester sans boire de l\u2019eau?","categorie":"Eau","responses":["10 jours","3 jours","7 jours"]},{"id":139,"question":"Combien de litres d\'\'eau utilise une personne en moyenne par jour pour ses besoins quotidiens ?","categorie":"Eau","responses":["50 litres","100 litres","150 litres"]},{"id":140,"question":"Quel est le plus grand contributeur mondial \xe0 la pollution des eaux ?","categorie":"Eau","responses":["Les activit\xe9s agricoles","Les activit\xe9s mini\xe8res","Les activit\xe9s industrielles"]},{"id":141,"question":"Quel est le facteur le plus important \xe0 prendre en compte pour \xe9valuer la qualit\xe9 de l\'\'eau ?","categorie":"Eau","responses":["La couleur de l\'\'eau","L\'\'odeur de l\'\'eau","Les concentrations de substances chimiques dans l\'\'eau"]},{"id":142,"question":"Combien de pourcentage de la Terre est couvert d\'\'eau ?","categorie":"Eau","responses":["50%","70%","30%"]},{"id":143,"question":"O\xf9 se trouvent la plupart des icebergs ?","categorie":"Eau","responses":["Oc\xe9an Arctique","Oc\xe9an Atlantique","Oc\xe9an Pacifique"]},{"id":144,"question":"Quel est l\'\'impact le plus courant de la pollution des eaux sur la faune aquatique ?","categorie":"Eau","responses":["La migration","La mortalit\xe9","La modification du comportement"]},{"id":145,"question":"Quel est le principal usage de l\'\'eau dans les foyers ?","categorie":"Eau","responses":["La toilette","La cuisine","L\'\'arrosage du jardin"]},{"id":146,"question":"Quel est le principal facteur qui d\xe9termine la consommation d\'\'eau dans les foyers ?","categorie":"Eau","responses":["Le nombre de personnes vivant dans le foyer","La r\xe9gion g\xe9ographique","Les habitudes de consommation d\'\'eau de chaque personne"]},{"id":147,"question":"Combien de personnes dans le monde n\'\'ont pas acc\xe8s \xe0 une source d\'\'eau potable s\xfbre ?","categorie":"Eau","responses":["100 millions","500 millions","1 milliard"]},{"id":148,"question":"Quel est le facteur qui affecte le plus la disponibilit\xe9 de l\'\'eau douce dans le monde ?","categorie":"Eau","responses":["La surconsommation","La pollution","Les variations climatiques"]},{"id":149,"question":"O\xf9 tombe le plus de pluie dans le monde ?","categorie":"Eau","responses":["Dans la for\xeat amazonienne","Dans le d\xe9sert de Atacama","Dans les montagnes de l\'Himalaya"]},{"id":150,"question":"Quelle est la couleur la plus courante d\'\'un iceberg ?","categorie":"Eau","responses":["Blanc","Bleu","Vert"]},{"id":151,"question":"Qu\'\'est-ce que les ressources naturelles ?","categorie":"Ressources naturelles","responses":["Des biens produits par l\'\'homme","Des biens produits par la nature","Des biens produits par les animaux"]},{"id":152,"question":"Les ressources naturelles peuvent \xeatre renouvelables ou non renouvelables, laquelle est consid\xe9r\xe9e comme une ressource non renouvelable ?","categorie":"Ressources naturelles","responses":["L\'\'eau","Le soleil","Le charbon"]},{"id":153,"question":"Quelle est la ressource la plus importante pour la vie sur Terre ?","categorie":"Ressources naturelles","responses":["Les min\xe9raux","Les v\xe9g\xe9taux","L\'\'eau"]},{"id":154,"question":"Quelle est la principale source d\'\'\xe9nergie renouvelable utilis\xe9e dans le monde ?","categorie":"Ressources naturelles","responses":["Le vent","Le charbon","Le p\xe9trole"]},{"id":155,"question":"Quel est le min\xe9ral le plus abondant sur Terre ?","categorie":"Ressources naturelles","responses":["Le fer","Le cuivre","L\'\'aluminium"]},{"id":156,"question":"Quel est le principal gaz \xe0 effet de serre responsable du r\xe9chauffement climatique ?","categorie":"Ressources naturelles","responses":["Le m\xe9thane","Le dioxyde de carbone","L\'\'ozone"]},{"id":157,"question":"Quel est le min\xe9ral le plus pr\xe9cieux sur Terre ?\'","categorie":"Ressources naturelles","responses":["Le diamant","Le platine","L\'\'or"]},{"id":158,"question":"Quelle est la principale source d\'\'\xe9nergie renouvelable dans le monde?","categorie":"Ressources naturelles","responses":["Eolienne","Hydro\xe9lectrique","Solaire"]},{"id":159,"question":"Quelle est la principale utilisation de l\'\'\xe9nergie \xe9olienne?","categorie":"Ressources naturelles","responses":["Production d\'\'\xe9lectricit\xe9","Chauffage des maisons","Traction animale"]},{"id":160,"question":"Lequel de ces produits est produit \xe0 partir d\'\'une source renouvelable?","categorie":"Ressources naturelles","responses":["Plastique","Biocarburant","M\xe9tal"]},{"id":161,"question":"Quelle est la source d\'\'\xe9nergie la plus utilis\xe9e en Europe?","categorie":"Ressources naturelles","responses":["Gaz naturel","Charbon","Eolienne"]},{"id":162,"question":"Quel est le nom de la technologie qui utilise la chaleur du soleil pour produire de l\'\'\xe9lectricit\xe9?","categorie":"Ressources naturelles","responses":["Photovolta\xefque","Hydro\xe9lectrique","Eolienne"]},{"id":163,"question":"Quel est l\'\'avantage des sources d\'\'\xe9nergie renouvelables par rapport aux sources d\'\'\xe9nergie non renouvelables?","categorie":"Ressources naturelles","responses":["\xc9puisement rapide","Durabilit\xe9","Co\xfbt \xe9lev\xe9"]},{"id":164,"question":"Quel est le plus grand producteur d\'\'\xe9nergie solaire au monde?","categorie":"Ressources naturelles","responses":["\xc9tats-Unis","Allemagne","Chine"]},{"id":165,"question":"Quelle est la principale utilisation des ressources min\xe9rales?","categorie":"Ressources naturelles","responses":["Alimentation","Construction","M\xe9decine"]},{"id":166,"question":"D\'\'o\xf9 provient le p\xe9trole ?","categorie":"Ressources naturelles","responses":["Des min\xe9raux","Des d\xe9bris v\xe9g\xe9taux et animaux accumul\xe9s","Du sable"]},{"id":167,"question":"Le p\xe9trole brut est souvent raffin\xe9 pour produire ","categorie":"Ressources naturelles","responses":["Du gaz naturel","De l\'\'essence et du diesel ","De la vapeur d\'\'eau"]},{"id":168,"question":"Comment le gaz naturel est-il form\xe9 ?","categorie":"Ressources naturelles","responses":["Par la d\xe9composition de la mati\xe8re v\xe9g\xe9tale","Par la d\xe9composition de la mati\xe8re animale","Par la d\xe9composition de la mati\xe8re organique s\xe9dimentaire"]},{"id":169,"question":"O\xf9 sont les plus grandes r\xe9serves de gaz naturel dans le monde ?","categorie":"Ressources naturelles","responses":["En Asie","En Am\xe9rique du Nord","En Europe"]},{"id":170,"question":"Quelle est la dur\xe9e de vie moyenne des panneaux solaires?","categorie":"Ressources naturelles","responses":["Entre 5 et 10 ans","Entre 20 et 25 ans","Entre 30 et 40 ans"]},{"id":171,"question":"Comment le charbon est-il extrait de la terre?","categorie":"Ressources naturelles","responses":["En creusant des puits","En creusant des mines \xe0 ciel ouvert","En utilisant des forages directionnels"]},{"id":172,"question":"Comment fonctionne l\'\'\xe9nergie g\xe9othermique?","categorie":"Ressources naturelles","responses":["En utilisant la chaleur produite par la Terre","En utilisant la force des mar\xe9es","En utilisant la force des vagues"]},{"id":173,"question":"O\xf9 se trouvent les centrales g\xe9othermiques?","categorie":"Ressources naturelles","responses":["En mer","En montagne","En zone volcanique"]},{"id":174,"question":"Quel pays est le plus grand producteur de p\xe9trole au monde?","categorie":"Ressources naturelles","responses":["Russie","Etats Unis","Arabie Saoudite"]},{"id":175,"question":"Quel m\xe9tal est utilis\xe9 dans la production de cellules photovolta\xefques pour les panneaux solaires ?","categorie":"Ressources naturelles","responses":["Silicium","Cuivre","Aluminium"]},{"id":176,"question":"Quelle est la principale cause d\'\'une \xe9ruption volcanique ?","categorie":"Catastrophes naturelles","responses":["Le magma atteint la surface de la Terre","Tremblements de terre","L\'\'impact d\'\'un m\xe9t\xe9ore"]},{"id":177,"question":"Quel est le plus grand volcan actif du monde ?","categorie":"Catastrophes naturelles","responses":["Le mont V\xe9suve","Le Mauna Loa","Le Mont Fuji"]},{"id":178,"question":"Quel est le terme utilis\xe9 pour d\xe9crire le point de la surface de la Terre situ\xe9 directement au-dessus du foyer d\'\'un tremblement de terre ?","categorie":"Catastrophes naturelles","responses":["\xc9picentre","Centre sismique","Hypocentre"]},{"id":179,"question":"Quel est le terme utilis\xe9 pour d\xe9crire la mesure de la magnitude d\'\'un tremblement de terre ?","categorie":"Catastrophes naturelles","responses":["\xc9chelle de Mercalli","\xc9chelle sismique","L\'\'\xe9chelle de Richter"]},{"id":180,"question":"Quel est le terme utilis\xe9 pour d\xe9crire le processus par lequel les plaques tectoniques de la Terre se d\xe9placent et interagissent, provoquant des tremblements de terre et la cr\xe9ation de montagnes et de fosses oc\xe9aniques ?","categorie":"Catastrophes naturelles","responses":["La tectonique des plaques","L\'\'activit\xe9 sismique","Mouvement de la Terre"]},{"id":181,"question":"Lequel de ces pays a un risque plus \xe9lev\xe9 de tremblements de terre?","categorie":"Catastrophes naturelles","responses":["Mexique","Japon","Italie"]},{"id":182,"question":"Quel autre \xe9v\xe9nement peut \xeatre d\xe9clench\xe9 par un tremblement de terre?","categorie":"Catastrophes naturelles","responses":["Eruption volcanique","Tsunami","Les deux"]},{"id":183,"question":"Quelle est la principale cause des tsunamis ?","categorie":"Catastrophes naturelles","responses":["Les tremblements de terre sous-marins","Les \xe9ruptions volcaniques","Les deux"]},{"id":184,"question":"Jusqu\'\'o\xf9 les tsunamis peuvent-ils aller \xe0 l\'\'int\xe9rieur des terres ?","categorie":"Catastrophes naturelles","responses":["10 km","100 km ","plus de 100 km"]},{"id":185,"question":"Quel oc\xe9an est le plus sujet aux tsunamis ?","categorie":"Catastrophes naturelles","responses":["L\'\'oc\xe9an Atlantique","L\'\'oc\xe9an Pacifique","L\'\'oc\xe9an Indien"]},{"id":186,"question":"Quel est le terme utilis\xe9 pour d\xe9crire une zone avec peu ou pas de pr\xe9cipitations ?","categorie":"Catastrophes naturelles","responses":["Aride","D\xe9sert","Humide"]},{"id":187,"question":"Quelle est la principale cause de s\xe9cheresse dans les r\xe9gions d\xe9sertiques ?","categorie":"Catastrophes naturelles","responses":["La haute pression","L\'\'altitude \xe9lev\xe9e","Le manque de pr\xe9cipitations"]},{"id":188,"question":"Laquelle des r\xe9gions suivantes est consid\xe9r\xe9e comme l\'\'un des endroits les plus secs de la plan\xe8te ?","categorie":"Catastrophes naturelles","responses":["Le d\xe9sert d\'\'Atacama en Am\xe9rique du Sud","Le d\xe9sert du Sahara en Afrique","Le d\xe9sert du Kalahari en Afrique"]},{"id":189,"question":"Qu\'\'est-ce qu\'\'un tsunami ?","categorie":"Catastrophes naturelles","responses":["Un type de temp\xeate avec des vents forts et de fortes pluies","Une vague oc\xe9anique g\xe9ante caus\xe9e par un tremblement de terre","Un type de requin que l\'\'on trouve dans l\'\'oc\xe9an Pacifique"]},{"id":190,"question":"Qu\'\'est-ce qu\'\'est la canicule ?","categorie":"Catastrophes naturelles","responses":["Un type de temp\xeate","Une p\xe9riode de chaleur excessive","Une maladie tropicale\'"]},{"id":191,"question":"Quelle est la catastrophe naturelle la plus fr\xe9quente aux \xc9tats-Unis ?","categorie":"Catastrophes naturelles","responses":["Les tornades","Les ouragans","Les tremblements de terre"]},{"id":192,"question":"Quelle est la principale cause d\'\'une tornade ?","categorie":"Catastrophes naturelles","responses":["Les tremblements de terre","Les ouragans","Les orages violents"]},{"id":193,"question":"Lequel des \xe9l\xe9ments suivants est un signe d\'\'alerte indiquant qu\'\'un volcan pourrait entrer en \xe9ruption prochainement ?","categorie":"Catastrophes naturelles","responses":["Une augmentation de l\'\'activit\xe9 sismique","Ciel d\xe9gag\xe9 et vents calmes","Diminution des \xe9missions de gaz"]},{"id":194,"question":"Quelle est la cause la plus fr\xe9quente des incendies de for\xeat ?","categorie":"Catastrophes naturelles","responses":["La foudre","L\'\'activit\xe9 humaine","Les \xe9ruptions volcaniques"]},{"id":195,"question":"Quelle est la diff\xe9rence entre un ouragan et un typhon ?","categorie":"Catastrophes naturelles","responses":["Les ouragans se produisent dans l\'\'oc\xe9an Atlantique, tandis que les typhons se produisent dans l\'\'oc\xe9an Pacifique","Les ouragans ont une vitesse de vent plus faible que les typhons","Il n\'\'y a pas de diff\xe9rence, il s\'\'agit du m\xeame type de temp\xeate"]},{"id":196,"question":"Quel est le type d\'\'\xe9ruption volcanique le plus courant ?","categorie":"Catastrophes naturelles","responses":["Stromboliene","Pliniene","Vulcaniene"]},{"id":197,"question":"Lequel des \xe9l\xe9ments suivants est un signe avant-coureur de la formation d\'\'une tornade ?","categorie":"Catastrophes naturelles","responses":["Un ciel clair et des vents calmes","Des pluies abondantes","Un fort grondement"]},{"id":198,"question":"Quel est le terme utilis\xe9 pour d\xe9signer une zone s\xe8che et aride qui re\xe7oit moins de 10 pouces de pluie par an ?","categorie":"Catastrophes naturelles","responses":["Oasis","Toundra","D\xe9sert"]},{"id":199,"question":"Quel est le nom d\'\'une colonne d\'\'air en rotation qui est en contact avec le sol et qui est capable de causer des dommages importants ?","categorie":"Catastrophes naturelles","responses":["Typhon","Tornade","Cyclone"]},{"id":200,"question":"Quel type de catastrophe naturelle s\'\'est produit en 79 apr\xe8s J.-C., ensevelissant les villes de Pomp\xe9i et Herculanum sous des cendres et des roches volcaniques ?","categorie":"Catastrophes naturelles","responses":["Un tremblement de terre","\xc9ruption volcanique","Tsunami"]}]}'),Hte=JSON.parse('{"d":[{"questionId":1,"responseIndex":2},{"questionId":2,"responseIndex":2},{"questionId":3,"responseIndex":2},{"questionId":4,"responseIndex":1},{"questionId":5,"responseIndex":2},{"questionId":6,"responseIndex":1},{"questionId":7,"responseIndex":0},{"questionId":8,"responseIndex":0},{"questionId":9,"responseIndex":0},{"questionId":10,"responseIndex":1},{"questionId":11,"responseIndex":1},{"questionId":12,"responseIndex":0},{"questionId":13,"responseIndex":2},{"questionId":14,"responseIndex":0},{"questionId":15,"responseIndex":1},{"questionId":16,"responseIndex":2},{"questionId":17,"responseIndex":1},{"questionId":18,"responseIndex":0},{"questionId":19,"responseIndex":2},{"questionId":20,"responseIndex":0},{"questionId":21,"responseIndex":0},{"questionId":22,"responseIndex":0},{"questionId":23,"responseIndex":2},{"questionId":24,"responseIndex":2},{"questionId":25,"responseIndex":1},{"questionId":26,"responseIndex":0},{"questionId":27,"responseIndex":0},{"questionId":28,"responseIndex":0},{"questionId":29,"responseIndex":0},{"questionId":30,"responseIndex":1},{"questionId":31,"responseIndex":1},{"questionId":32,"responseIndex":1},{"questionId":33,"responseIndex":1},{"questionId":34,"responseIndex":0},{"questionId":35,"responseIndex":1},{"questionId":36,"responseIndex":2},{"questionId":37,"responseIndex":2},{"questionId":38,"responseIndex":1},{"questionId":39,"responseIndex":1},{"questionId":40,"responseIndex":0},{"questionId":41,"responseIndex":1},{"questionId":42,"responseIndex":1},{"questionId":43,"responseIndex":2},{"questionId":44,"responseIndex":1},{"questionId":45,"responseIndex":0},{"questionId":46,"responseIndex":1},{"questionId":47,"responseIndex":1},{"questionId":48,"responseIndex":0},{"questionId":49,"responseIndex":1},{"questionId":50,"responseIndex":2},{"questionId":51,"responseIndex":2},{"questionId":52,"responseIndex":2},{"questionId":53,"responseIndex":2},{"questionId":54,"responseIndex":0},{"questionId":55,"responseIndex":1},{"questionId":56,"responseIndex":2},{"questionId":57,"responseIndex":0},{"questionId":58,"responseIndex":0},{"questionId":59,"responseIndex":2},{"questionId":60,"responseIndex":2},{"questionId":61,"responseIndex":1},{"questionId":62,"responseIndex":1},{"questionId":63,"responseIndex":1},{"questionId":64,"responseIndex":2},{"questionId":65,"responseIndex":1},{"questionId":66,"responseIndex":2},{"questionId":67,"responseIndex":2},{"questionId":68,"responseIndex":2},{"questionId":69,"responseIndex":1},{"questionId":70,"responseIndex":1},{"questionId":71,"responseIndex":0},{"questionId":72,"responseIndex":0},{"questionId":73,"responseIndex":2},{"questionId":74,"responseIndex":2},{"questionId":75,"responseIndex":2},{"questionId":76,"responseIndex":1},{"questionId":77,"responseIndex":2},{"questionId":78,"responseIndex":0},{"questionId":79,"responseIndex":1},{"questionId":80,"responseIndex":0},{"questionId":81,"responseIndex":1},{"questionId":82,"responseIndex":0},{"questionId":83,"responseIndex":2},{"questionId":84,"responseIndex":1},{"questionId":85,"responseIndex":0},{"questionId":86,"responseIndex":2},{"questionId":87,"responseIndex":0},{"questionId":88,"responseIndex":0},{"questionId":89,"responseIndex":0},{"questionId":90,"responseIndex":0},{"questionId":91,"responseIndex":0},{"questionId":92,"responseIndex":1},{"questionId":93,"responseIndex":0},{"questionId":94,"responseIndex":0},{"questionId":95,"responseIndex":0},{"questionId":96,"responseIndex":0},{"questionId":97,"responseIndex":0},{"questionId":98,"responseIndex":0},{"questionId":99,"responseIndex":0},{"questionId":100,"responseIndex":1},{"questionId":101,"responseIndex":2},{"questionId":102,"responseIndex":2},{"questionId":103,"responseIndex":0},{"questionId":104,"responseIndex":2},{"questionId":105,"responseIndex":2},{"questionId":106,"responseIndex":2},{"questionId":107,"responseIndex":0},{"questionId":108,"responseIndex":0},{"questionId":109,"responseIndex":0},{"questionId":110,"responseIndex":1},{"questionId":111,"responseIndex":0},{"questionId":112,"responseIndex":0},{"questionId":113,"responseIndex":2},{"questionId":114,"responseIndex":1},{"questionId":115,"responseIndex":0},{"questionId":116,"responseIndex":1},{"questionId":117,"responseIndex":1},{"questionId":118,"responseIndex":0},{"questionId":119,"responseIndex":2},{"questionId":120,"responseIndex":2},{"questionId":121,"responseIndex":1},{"questionId":122,"responseIndex":2},{"questionId":123,"responseIndex":2},{"questionId":124,"responseIndex":2},{"questionId":125,"responseIndex":0},{"questionId":126,"responseIndex":0},{"questionId":127,"responseIndex":0},{"questionId":128,"responseIndex":2},{"questionId":129,"responseIndex":2},{"questionId":130,"responseIndex":0},{"questionId":131,"responseIndex":2},{"questionId":132,"responseIndex":2},{"questionId":133,"responseIndex":2},{"questionId":134,"responseIndex":2},{"questionId":135,"responseIndex":2},{"questionId":136,"responseIndex":2},{"questionId":137,"responseIndex":0},{"questionId":138,"responseIndex":1},{"questionId":139,"responseIndex":2},{"questionId":140,"responseIndex":0},{"questionId":141,"responseIndex":2},{"questionId":142,"responseIndex":1},{"questionId":143,"responseIndex":1},{"questionId":144,"responseIndex":1},{"questionId":145,"responseIndex":0},{"questionId":146,"responseIndex":0},{"questionId":147,"responseIndex":2},{"questionId":148,"responseIndex":2},{"questionId":149,"responseIndex":0},{"questionId":150,"responseIndex":1},{"questionId":151,"responseIndex":1},{"questionId":152,"responseIndex":2},{"questionId":153,"responseIndex":2},{"questionId":154,"responseIndex":0},{"questionId":155,"responseIndex":0},{"questionId":156,"responseIndex":1},{"questionId":157,"responseIndex":0},{"questionId":158,"responseIndex":1},{"questionId":159,"responseIndex":0},{"questionId":160,"responseIndex":1},{"questionId":161,"responseIndex":0},{"questionId":162,"responseIndex":0},{"questionId":163,"responseIndex":1},{"questionId":164,"responseIndex":2},{"questionId":165,"responseIndex":1},{"questionId":166,"responseIndex":1},{"questionId":167,"responseIndex":1},{"questionId":168,"responseIndex":2},{"questionId":169,"responseIndex":0},{"questionId":170,"responseIndex":2},{"questionId":171,"responseIndex":1},{"questionId":172,"responseIndex":0},{"questionId":173,"responseIndex":2},{"questionId":174,"responseIndex":2},{"questionId":175,"responseIndex":0},{"questionId":176,"responseIndex":0},{"questionId":177,"responseIndex":1},{"questionId":178,"responseIndex":0},{"questionId":179,"responseIndex":2},{"questionId":180,"responseIndex":0},{"questionId":181,"responseIndex":1},{"questionId":182,"responseIndex":2},{"questionId":183,"responseIndex":2},{"questionId":184,"responseIndex":2},{"questionId":185,"responseIndex":1},{"questionId":186,"responseIndex":0},{"questionId":187,"responseIndex":0},{"questionId":188,"responseIndex":0},{"questionId":189,"responseIndex":0},{"questionId":190,"responseIndex":1},{"questionId":191,"responseIndex":0},{"questionId":192,"responseIndex":2},{"questionId":193,"responseIndex":0},{"questionId":194,"responseIndex":1},{"questionId":195,"responseIndex":0},{"questionId":196,"responseIndex":0},{"questionId":197,"responseIndex":2},{"questionId":198,"responseIndex":2},{"questionId":199,"responseIndex":1},{"questionId":200,"responseIndex":1}]}'),UF='*[_ngcontent-%COMP%]{box-sizing:border-box}body[_ngcontent-%COMP%]{margin:0;padding:0;background-color:#34495e;display:flex;align-items:center;justify-content:center;height:100vh;overflow:hidden}.principal[_ngcontent-%COMP%]{width:400px;height:400px}.container[_ngcontent-%COMP%]{width:400px;height:400px;background-color:#ccc;border-radius:50%;border:15px solid #dde;position:relative;overflow:hidden;transition:5s}.container[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]{height:50%;width:200px;position:absolute;clip-path:polygon(79% 0,50% 100%,0 0);transform:translate(-50%);transform-origin:bottom;text-align:center;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;font-family:sans-serif;color:#fff;left:85px;writing-mode:vertical-rl;text-orientation:mixed}.container[_ngcontent-%COMP%]   .one[_ngcontent-%COMP%]{background-color:#f41b1b;transform:rotate(-18deg)}.container[_ngcontent-%COMP%]   .two[_ngcontent-%COMP%]{background-color:#e6a53d;transform:rotate(27deg)}.container[_ngcontent-%COMP%]   .three[_ngcontent-%COMP%]{background-color:#e2ec2e;transform:rotate(72deg)}.container[_ngcontent-%COMP%]   .four[_ngcontent-%COMP%]{background-color:#22e549;transform:rotate(117deg)}.container[_ngcontent-%COMP%]   .five[_ngcontent-%COMP%]{background-color:#1ed7f0;transform:rotate(162deg)}.container[_ngcontent-%COMP%]   .six[_ngcontent-%COMP%]{background-color:#2d37ea;transform:rotate(207deg)}.container[_ngcontent-%COMP%]   .seven[_ngcontent-%COMP%]{background-color:#a315ce;transform:rotate(252deg)}.container[_ngcontent-%COMP%]   .eight[_ngcontent-%COMP%]{background-color:#e872c4;transform:rotate(297deg)}#spin[_ngcontent-%COMP%]{position:relative;top:69%;left:50%;transform:translate(-50%,-50%);z-index:10;background-color:#e2e2e2;text-transform:uppercase;border:8px solid #fff;font-weight:700;font-size:20px;color:#a2a2a2;width:80px;height:80px;font-family:sans-serif;border-radius:50%;cursor:pointer;outline:none;letter-spacing:1px}#spin[_ngcontent-%COMP%]:before{content:"";position:absolute;left:25%;top:-35px;width:30px;height:30px;background:#fff;clip-path:polygon(50% 0%,15% 100%,85% 100%)}*[_ngcontent-%COMP%]{margin:0;padding:0}body[_ngcontent-%COMP%]{margin:0;font-family:Josefine sans;font-size:20px;color:#000;line-height:1.6;display:flex;height:100vh;flex-direction:column}#background[_ngcontent-%COMP%]{background-image:url(https://img.freepik.com/free-vector/copy-space-bokeh-spring-lights-background_52683-55649.jpg);background-size:cover;background-position:center;bottom:0}#showcase[_ngcontent-%COMP%]{height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:0 20px}#container[_ngcontent-%COMP%]{background-color:#fff;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:0 20px}#footer[_ngcontent-%COMP%]{margin-left:40px;margin-bottom:20px;justify-content:left;align-items:left;text-align:left}.input-group[_ngcontent-%COMP%]{margin-top:20px;display:flex;justify-content:center;align-items:center;gap:10px;width:200px}.btn[_ngcontent-%COMP%]{padding:10px 60px;background:#fff;border:0;outline:none;cursor:pointer;font-size:22px;font-weight:500;border-radius:30px}.row[_ngcontent-%COMP%]{display:flex;margin:10%}.col[_ngcontent-%COMP%]{flex:1;background:#fff;text-align:center}.col[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:38px;font-weight:500;margin:30px 0 10px}.col[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%;margin-top:10%;padding:10px 0;background:#6fd649;color:#fff;border:0;outline:none;font-size:18px;border-radius:4px;cursor:pointer;box-shadow:0 5px 5px #000}#countdown[_ngcontent-%COMP%]{font-size:50px;font-weight:700;color:#fe0000;font-family:Josefine sans,serif;font-size:28px;display:flex}h5[_ngcontent-%COMP%]{font-family:Josefine sans,serif;font-weight:700;font-size:38px;text-shadow:4px 4px 4px #aaa}.modal[_ngcontent-%COMP%]{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:#0006}.modal-content[_ngcontent-%COMP%]{background-color:#fefefe;margin:15% auto;padding:20px;border:1px solid #888;width:80%;max-width:400px;text-align:center}.close[_ngcontent-%COMP%]{color:#aaa;float:right;font-size:28px;font-weight:700}.close[_ngcontent-%COMP%]:hover, .close[_ngcontent-%COMP%]:focus{color:#000;text-decoration:none;cursor:pointer}';let Wte=(()=>{class r{constructor(t,i){this.router=t,this.data=i,this.player1Keys=["a","z","e"],this.player2Keys=["i","o","p"],this.player1Choices=0,this.player2Choices=0,this.number=0,this.player1Points=0,this.player2Points=0,this.listeCategorie1=[],this.listeQuestions1=[],this.listeReponses1=[],this.listeRepCorrectes1=[],this.idRep=[],this.player1Nom=this.data.getName(0),this.player2Nom=this.data.getName(1)}ngOnInit(){const t=zte.G,i=Hte.d;t&&i&&(this.listeQuestions1=t.map(s=>({idQ:s.id,categorie:s.categorie,question:s.question})),this.listeReponses1=t.map(s=>({idQ:s.id,rep:s.responses})),this.listeRepCorrectes1=i.map(s=>({idQ:s.questionId,index:s.responseIndex}))),this.partie()}spin(){this.number+=100+Math.ceil(1e3*Math.random()),document.querySelector(".container").style.transform=`rotate(${this.number}deg)`;let i=this.number%360;i>=0&&i<=45?this.texteCat="Air":i>45&&i<=90?this.texteCat="Catastrophes naturelles":i>90&&i<=135?this.texteCat="Ressources naturelles":i>135&&i<=180?this.texteCat="Eau":i>180&&i<=225?this.texteCat="Pollution":i>225&&i<=270?this.texteCat="Biologie":i>270&&i<=315?this.texteCat="Dechets":(i>315&&i<360||(i=0))&&(this.texteCat="Climat"),this.q=this.selectionQuestion();let n,o,a,s=[];s=this.recupererReponses(),n=s[0],o=s[1],a=s[2];const l=document.getElementById("monDivCat"),c=document.getElementById("monDivQuest"),h=document.getElementById("r1"),u=document.getElementById("r2"),d=document.getElementById("r3"),f=document.getElementById("r1"),p=document.getElementById("r2"),_=document.getElementById("r3");setTimeout(()=>{l.innerHTML=this.texteCat.toString(),c.innerHTML=this.q.toString(),l.style.display="block",c.style.display="block",h.style.display="block",f.innerHTML=n.toString(),u.style.display="block",p.innerHTML=o.toString(),d.style.display="block",_.innerHTML=a.toString(),this.jeu()},5e3)}selectionQuestion(){const t=this.listeQuestions1.filter(s=>s.categorie===this.texteCat),i=Math.floor(Math.random()*t.length);return this.idQuest=t[i].idQ,t[i].question}recupererReponses(){const t=this.listeReponses1.find(i=>i.idQ===this.idQuest);return t?t.rep:[]}answerKey(){this.answerKey1="",this.answerKey2="";const t=this.listeRepCorrectes1.find(i=>i.idQ===this.idQuest);0==t.index?(this.answerKey1="a",this.answerKey2="i"):1==t.index?(this.answerKey1="z",this.answerKey2="o"):2==t.index&&(this.answerKey1="e",this.answerKey2="p"),console.log(this.answerKey1),console.log(this.answerKey2)}openPopupCd(){const t=document.getElementById("modal");t.style.display="block",window.onclick=function(i){i.target==t&&(t.style.display="none")}}checkAnswer(t,i){this.answerKey();const s=document.querySelector("#r1"),n=document.querySelector("#r2"),o=document.querySelector("#r3");return(i.toLowerCase()===this.answerKey1.toLowerCase()||i.toLowerCase()===this.answerKey2.toLowerCase())&&(console.log(`Le joueur ${t} a trouv\xe9 la bonne r\xe9ponse !`),"a"==this.answerKey1||"i"==this.answerKey2?s.style.backgroundColor="#328D2B":"z"==this.answerKey1||"o"==this.answerKey2?n.style.backgroundColor="#328D2B":("e"==this.answerKey1||"p"==this.answerKey2)&&(o.style.backgroundColor="#328D2B"),setTimeout(()=>{s.style.backgroundColor="#6fd649",n.style.backgroundColor="#6fd649",o.style.backgroundColor="#6fd649"},3e3),!0)}jeu(){const t=document.getElementById("countdown");t.style.display="block";const i=(new Date).getTime()+16e3,s=setInterval(()=>{const n=(new Date).getTime(),o=i-n,a=Math.floor(o%6e4/1e3)+1;t.innerHTML=a+"s ";const l=c=>{const h=c.key.toLowerCase();clearInterval(s),this.player1Choices<1&&this.player1Keys.includes(h)&&o>0?(this.player1Choices++,this.checkAnswer(1,h)?(clearInterval(s),console.log("(J1 a gagne n points)"),console.log("popup(bonne reponse j1 -> prochaine question)"),document.removeEventListener("keydown",l),t.innerHTML="",this.player1Points=this.player1Points+5,this.questionTermine(this.player1Nom+" \xe0 gagn\xe9 ce tour")):(console.log("Au tour du J2"),console.log("le J1 ne peux plus repondre"),this.checkAnswer(2,h)&&(clearInterval(s),document.removeEventListener("keydown",l),t.innerHTML="",this.player2Points=this.player2Points+5,this.questionTermine(this.player2Nom+" \xe0 gagn\xe9 ce tour")))):this.player2Choices<1&&this.player2Keys.includes(h)&&o>0?(this.player2Choices++,this.checkAnswer(2,h)?(clearInterval(s),console.log("(J2 a gagne n points)"),console.log("popup(bonne reponse j2 -> prochaine question)"),document.removeEventListener("keydown",l),t.innerHTML="",this.player2Points=this.player2Points+5,this.questionTermine(this.player2Nom+" \xe0 gagn\xe9 ce tour")):(console.log("Au tour du J1"),console.log("le J2 ne peux plus repondre"),this.checkAnswer(1,h)&&(clearInterval(s),document.removeEventListener("keydown",l),t.innerHTML="",this.player1Points=this.player1Points+5,this.questionTermine(this.player1Nom+" \xe0 gagn\xe9 ce tour")))):1==this.player1Choices&&1==this.player2Choices&&o>0&&!this.checkAnswer(1,h)&&!this.checkAnswer(2,h)&&(document.removeEventListener("keydown",l),clearInterval(s),t.innerHTML="",this.questionTermine("Aucun joueurs \xe0 bien repondu, cliquer pour le prochain tours"))};document.addEventListener("keydown",l),o<=0&&(clearInterval(s),t.innerHTML="",this.questionTermine("Temps ecoul\xe9, cliquer pour le prochain tours"))},1e3);this.player1Choices=0,this.player2Choices=0}questionTermine(t){const i=document.getElementById("countdown"),s=document.getElementById("monDivCat"),n=document.getElementById("monDivQuest"),o=document.getElementById("r1"),a=document.getElementById("r2"),l=document.getElementById("r3"),c=document.getElementById("r1"),h=document.getElementById("r2"),u=document.getElementById("r3"),d=document.getElementById("endQuest"),f=document.querySelector("#next");document.getElementById("phrase").innerHTML=t,d.style.display="block",f.addEventListener("click",_=>{_.target===f&&(d.style.display="none")}),f.addEventListener("click",()=>{setTimeout(()=>{i.style.display="none",s.style.display="none",n.style.display="none",o.style.display="none",c.style.display="none",a.style.display="none",h.style.display="none",l.style.display="none",u.style.display="none"},500)})}partie(){const t=document.querySelector("#spin");let i=0;t.addEventListener("click",()=>{if(i<5)this.spin(),i++;else if(t.disabled=!0,this.player1Points>this.player2Points)console.log(this.player1Points,this.player2Points),this.data.addGagnantBox(this.player1Nom),this.partieTermine("Fin de la partie "+this.player1Nom+" a gagne!");else if(this.player1Points<this.player2Points)console.log(this.player1Points,this.player2Points),this.data.addGagnantBox(this.player2Nom),this.partieTermine("Fin de la partie "+this.player2Nom+" a gagne!");else if(this.player1Points==this.player2Points){t.disabled=!1;let s=!1;for(console.log("Hello");!s;)console.log("avant spin"),this.spin(),console.log("apres spin"),this.player1Points>this.player2Points?(s=!0,console.log("J1 a gagne"),this.data.addGagnantBox(this.player1Nom),this.partieTermine("Fin de la partie "+this.player1Nom+" a gagne!")):this.player1Points<this.player2Points&&(s=!0,console.log("J2 a gagn\xe9"),this.data.addGagnantBox(this.player2Nom),this.partieTermine("Fin de la partie "+this.player2Nom+" a gagne!"))}}),this.player1Points=0,this.player2Points=0}partieTermine(t){const i=document.getElementById("endPartie"),s=document.querySelector("#acc");document.getElementById("phraseFin").innerHTML=t,i.style.display="block",s.addEventListener("click",()=>{this.router.navigate(["Model"])})}}return r.\u0275fac=function(t){return new(t||r)(xe(Hs),xe(Ag))},r.\u0275cmp=Il({type:r,selectors:[["app-dialogbox"]],decls:54,vars:0,consts:[["name","viewport","content","width=device-width, initial-scale=1.0"],["rel","preconnect","href","https://fonts.googleapis.com"],["rel","preconnect","href","https://fonts.gstatic.com","crossorigin",""],["href","https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;500&display=swap","rel","stylesheet"],["id","background"],[1,"row"],[1,"col"],[1,"container"],[1,"one"],[1,"two"],[1,"three"],[1,"four"],[1,"five"],[1,"six"],[1,"seven"],[1,"eight"],["id","spin",2,"top","-180pt","left","150pt"],["id","countdown"],["id","modal",1,"modal"],[1,"modal-content"],["id","monDivCat"],["id","monDivQuest"],["id","r1","type","button",2,"display","none"],["id","r2","type","button",2,"display","none"],["id","r3","type","button",2,"display","none"],["id","endQuest",1,"modal"],["id","phrase"],["id","next",2,"top","-180pt","left","150pt"],["id","endPartie",1,"modal"],["id","phraseFin"],["id","acc",2,"top","-180pt","left","150pt"]],template:function(t,i){1&t&&(ut(0,"html")(1,"head"),oi(2,"meta",0),ut(3,"title"),ii(4,"Questions popup"),bt(),oi(5,"link",1)(6,"link",2)(7,"link",3),bt(),ut(8,"body",4)(9,"div",5)(10,"div",6)(11,"div",5)(12,"div")(13,"div",7)(14,"div",8),ii(15,"Air"),bt(),ut(16,"div",9),ii(17,"Climat"),bt(),ut(18,"div",10),ii(19,"Dechets"),bt(),ut(20,"div",11),ii(21,"Biologie"),bt(),ut(22,"div",12),ii(23,"Pollution"),bt(),ut(24,"div",13),ii(25,"Eau"),bt(),ut(26,"div",14),ii(27,"Res. nat"),bt(),ut(28,"div",15),ii(29,"Cat. nat"),bt()()(),ut(30,"button",16),ii(31,"Spin"),bt()()(),ut(32,"div",6)(33,"div",5),oi(34,"div",17),ut(35,"div",18)(36,"div",19)(37,"p"),ii(38,"Le compte \xe0 rebours est termin\xe9 !"),bt()()(),oi(39,"h5",20)(40,"p",21)(41,"button",22)(42,"button",23)(43,"button",24),ut(44,"div",25)(45,"div",19),oi(46,"p",26),ut(47,"button",27),ii(48,"Prochaine tour"),bt()()(),ut(49,"div",28)(50,"div",19),oi(51,"p",29),ut(52,"button",30),ii(53,"Retour \xe0 la carte"),bt()()()()()()()())},styles:[UF,UF]}),r})();function kF(r,e,t,i,s,n,o){try{var a=r[n](o),l=a.value}catch(c){return void t(c)}a.done?e(l):Promise.resolve(l).then(i,s)}function Qt(r){return function(){var e=this,t=arguments;return new Promise(function(i,s){var n=r.apply(e,t);function o(l){kF(n,i,s,o,a,"next",l)}function a(l){kF(n,i,s,o,a,"throw",l)}o(void 0)})}}let es=(()=>{class r{constructor(){this.rootNodes=new Array,this.cameras=new Array,this.lights=new Array,this.meshes=new Array,this.skeletons=new Array,this.particleSystems=new Array,this.animations=[],this.animationGroups=new Array,this.multiMaterials=new Array,this.materials=new Array,this.morphTargetManagers=new Array,this.geometries=new Array,this.transformNodes=new Array,this.actionManagers=new Array,this.textures=new Array,this._environmentTexture=null,this.postProcesses=new Array}static AddParser(t,i){this._BabylonFileParsers[t]=i}static GetParser(t){return this._BabylonFileParsers[t]?this._BabylonFileParsers[t]:null}static AddIndividualParser(t,i){this._IndividualBabylonFileParsers[t]=i}static GetIndividualParser(t){return this._IndividualBabylonFileParsers[t]?this._IndividualBabylonFileParsers[t]:null}static Parse(t,i,s,n){for(const o in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,o)&&this._BabylonFileParsers[o](t,i,s,n)}get environmentTexture(){return this._environmentTexture}set environmentTexture(t){this._environmentTexture=t}getNodes(){let t=new Array;return t=t.concat(this.meshes),t=t.concat(this.lights),t=t.concat(this.cameras),t=t.concat(this.transformNodes),this.skeletons.forEach(i=>t=t.concat(i.bones)),t}}return r._BabylonFileParsers={},r._IndividualBabylonFileParsers={},r})(),Ou=(()=>{class r{constructor(){this.hoverCursor="",this.actions=new Array,this.isRecursive=!1}static get HasTriggers(){for(const t in r.Triggers)if(Object.prototype.hasOwnProperty.call(r.Triggers,t))return!0;return!1}static get HasPickTriggers(){for(const t in r.Triggers)if(Object.prototype.hasOwnProperty.call(r.Triggers,t)){const i=parseInt(t);if(i>=1&&i<=7)return!0}return!1}static HasSpecificTrigger(t){for(const i in r.Triggers)if(Object.prototype.hasOwnProperty.call(r.Triggers,i)&&parseInt(i)===t)return!0;return!1}}return r.Triggers={},r})();class GF{constructor(e,t=!1,i,s){this.initialize(e,t,i,s)}initialize(e,t=!1,i,s){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=s,this}}class Xte{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1}}class z{static FromPromise(e,t){const i=new z;return e.then(s=>{i.notifyObservers(s)}).catch(s=>{if(!t)throw s;t.notifyObservers(s)}),i}get observers(){return this._observers}constructor(e,t=!1){this.notifyIfTriggered=t,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new GF(0),e&&(this._onObserverAdded=e)}add(e,t=-1,i=!1,s=null,n=!1){if(!e)return null;const o=new Xte(e,t,s);return o.unregisterOnNextCall=n,i?this._observers.unshift(o):this._observers.push(o),this._onObserverAdded&&this._onObserverAdded(o),this._hasNotified&&this.notifyIfTriggered&&void 0!==this._lastNotifiedValue&&this.notifyObserver(o,this._lastNotifiedValue),o}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return!(!e||-1===this._observers.indexOf(e)||(this._deferUnregister(e),0))}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){const s=this._observers[i];if(!(s._willBeUnregistered||s.callback!==e||t&&t!==s.scope))return this._deferUnregister(s),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(()=>{this._remove(e)},0))}_remove(e,t=!0){if(!e)return!1;const i=this._observers.indexOf(e);return-1!==i&&(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(i,1),!0)}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,i,s,n){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;const o=this._eventState;o.mask=t,o.target=i,o.currentTarget=s,o.skipNextObservers=!1,o.lastReturnValue=e,o.userInfo=n;for(const a of this._observers)if(!a._willBeUnregistered&&(a.mask&t&&(a.unregisterOnNextCall&&this._deferUnregister(a),o.lastReturnValue=a.scope?a.callback.apply(a.scope,[e,o]):a.callback(e,o)),o.skipNextObservers))return!1;return!0}notifyObserver(e,t,i=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=t),e._willBeUnregistered)return;const s=this._eventState;s.mask=i,s.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,s)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){this._observers.length=0,this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){const e=new z;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}class oe{static WithinEpsilon(e,t,i=1401298e-51){return Math.abs(e-t)<=i}static ToHex(e){const t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()}static Sign(e){return 0==(e=+e)||isNaN(e)?e:e>0?1:-1}static Clamp(e,t=0,i=1){return Math.min(i,Math.max(t,e))}static Log2(e){return Math.log(e)*Math.LOG2E}static ILog2(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(0===e)return-1/0;let t=0;if(e<1){for(;e<1;)t++,e*=2;t=-t}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t}static Repeat(e,t){return e-Math.floor(e/t)*t}static Normalize(e,t,i){return(e-t)/(i-t)}static Denormalize(e,t,i){return e*(i-t)+t}static DeltaAngle(e,t){let i=oe.Repeat(t-e,360);return i>180&&(i-=360),i}static PingPong(e,t){const i=oe.Repeat(e,2*t);return t-Math.abs(i-t)}static SmoothStep(e,t,i){let s=oe.Clamp(i);return s=-2*s*s*s+3*s*s,t*s+e*(1-s)}static MoveTowards(e,t,i){let s=0;return s=Math.abs(t-e)<=i?t:e+oe.Sign(t-e)*i,s}static MoveTowardsAngle(e,t,i){const s=oe.DeltaAngle(e,t);let n=0;return n=-i<s&&s<i?t:oe.MoveTowards(e,t=e+s,i),n}static Lerp(e,t,i){return e+(t-e)*i}static LerpAngle(e,t,i){let s=oe.Repeat(t-e,360);return s>180&&(s-=360),e+s*oe.Clamp(i)}static InverseLerp(e,t,i){let s=0;return s=e!=t?oe.Clamp((i-e)/(t-e)):0,s}static Hermite(e,t,i,s,n){const o=n*n,a=n*o;return e*(2*a-3*o+1)+i*(-2*a+3*o)+t*(a-2*o+n)+s*(a-o)}static Hermite1stDerivative(e,t,i,s,n){const o=n*n;return 6*(o-n)*e+(3*o-4*n+1)*t+6*(-o+n)*i+(3*o-2*n)*s}static RandomRange(e,t){return e===t?e:Math.random()*(t-e)+e}static RangeToPercent(e,t,i){return(e-t)/(i-t)}static PercentToRange(e,t,i){return(i-t)*e+t}static NormalizeRadians(e){return e-oe.TwoPi*Math.floor((e+Math.PI)/oe.TwoPi)}static HCF(e,t){const i=e%t;return 0===i?t:oe.HCF(t,i)}}oe.TwoPi=2*Math.PI;const Jf=1/2.2,ts=(1+Math.sqrt(5))/2,ot=.001;class is{static BuildArray(e,t){const i=[];for(let s=0;s<e;++s)i.push(t());return i}static BuildTuple(e,t){return is.BuildArray(e,t)}}const Yte=["push","splice","pop","shift","unshift"];function zF(r,e){const t=Yte.map(i=>function jte(r,e,t){const i=r[e];if("function"!=typeof i)return null;const s=function(){const n=r.length,o=s.previous.apply(r,arguments);return t(e,n),o};return i.next=s,s.previous=i,r[e]=s,()=>{const n=s.previous;if(!n)return;const o=s.next;o?(n.next=o,o.previous=n):(n.next=void 0,r[e]=n),s.next=void 0,s.previous=void 0}}(r,i,e));return()=>{t.forEach(i=>{i?.()})}}const HF={};function le(r,e){HF[r]=e}function hs(r){return HF[r]}class Ds{static SetMatrixPrecision(e){if(Ds.MatrixTrackPrecisionChange=!1,e&&!Ds.MatrixUse64Bits&&Ds.MatrixTrackedMatrices)for(let t=0;t<Ds.MatrixTrackedMatrices.length;++t){const i=Ds.MatrixTrackedMatrices[t],s=i._m;i._m=new Array(16);for(let n=0;n<16;++n)i._m[n]=s[n]}Ds.MatrixUse64Bits=e,Ds.MatrixCurrentType=Ds.MatrixUse64Bits?Array:Float32Array,Ds.MatrixTrackedMatrices=null}}Ds.MatrixUse64Bits=!1,Ds.MatrixTrackPrecisionChange=!0,Ds.MatrixCurrentType=Float32Array,Ds.MatrixTrackedMatrices=[];class be{static get LastCreatedEngine(){return 0===this.Instances.length?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}be.Instances=new Array,be.OnEnginesDisposedObservable=new z,be._LastCreatedScene=null,be.UseFallbackTexture=!0,be.FallbackTexture="";const Yr=r=>parseInt(r.toString().replace(/\W/g,""));class de{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){let i=Yr(this.x);return i=397*i^Yr(this.y),i}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return de.FromArrayToRef(e,t,this),this}asArray(){const e=new Array;return this.toArray(e,0),e}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}add(e){return new this.constructor(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addVector3(e){return new this.constructor(this.x+e.x,this.y+e.y)}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new this.constructor(this.x*e,this.y*t)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.divideToRef(e,this)}negate(){return new this.constructor(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.copyFromFloats(-1*this.x,-1*this.y)}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){const t=new this.constructor(0,0);return this.scaleToRef(e,t),t}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=ot){return e&&oe.WithinEpsilon(this.x,e.x,t)&&oe.WithinEpsilon(this.y,e.y,t)}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}rotateToRef(e,t){const i=Math.cos(e),s=Math.sin(e);return t.x=i*this.x-s*this.y,t.y=s*this.x+i*this.y,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return de.NormalizeToRef(this,this),this}clone(){return new this.constructor(this.x,this.y)}static Zero(){return new de(0,0)}static One(){return new de(1,1)}static Random(e=0,t=1){return new de(oe.RandomRange(e,t),oe.RandomRange(e,t))}static get ZeroReadOnly(){return de._ZeroReadOnly}static FromArray(e,t=0){return new de(e[t],e[t+1])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i}static CatmullRom(e,t,i,s,n){const o=n*n,a=n*o;return new e.constructor(.5*(2*t.x+(-e.x+i.x)*n+(2*e.x-5*t.x+4*i.x-s.x)*o+(3*t.x-e.x-3*i.x+s.x)*a),.5*(2*t.y+(-e.y+i.y)*n+(2*e.y-5*t.y+4*i.y-s.y)*o+(3*t.y-e.y-3*i.y+s.y)*a))}static Clamp(e,t,i){let s=e.x;s=s>i.x?i.x:s,s=s<t.x?t.x:s;let n=e.y;return n=n>i.y?i.y:n,n=n<t.y?t.y:n,new e.constructor(s,n)}static Hermite(e,t,i,s,n){const o=n*n,a=n*o,l=2*a-3*o+1,c=-2*a+3*o,h=a-2*o+n,u=a-o;return new e.constructor(e.x*l+i.x*c+t.x*h+s.x*u,e.y*l+i.y*c+t.y*h+s.y*u)}static Hermite1stDerivative(e,t,i,s,n){const o=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,s,n,o),o}static Hermite1stDerivativeToRef(e,t,i,s,n,o){const a=n*n;return o.x=6*(a-n)*e.x+(3*a-4*n+1)*t.x+6*(-a+n)*i.x+(3*a-2*n)*s.x,o.y=6*(a-n)*e.y+(3*a-4*n+1)*t.y+6*(-a+n)*i.y+(3*a-2*n)*s.y,o}static Lerp(e,t,i){return new e.constructor(e.x+(t.x-e.x)*i,e.y+(t.y-e.y)*i)}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){const t=new e.constructor;return this.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){const i=e.length();return 0===i||(t.x=e.x/i,t.y=e.y/i),t}static Minimize(e,t){return new e.constructor(e.x<t.x?e.x:t.x,e.y<t.y?e.y:t.y)}static Maximize(e,t){return new e.constructor(e.x>t.x?e.x:t.x,e.y>t.y?e.y:t.y)}static Transform(e,t){const i=new e.constructor;return de.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){const s=t.m,o=e.x*s[1]+e.y*s[5]+s[13];return i.x=e.x*s[0]+e.y*s[4]+s[12],i.y=o,i}static PointInTriangle(e,t,i,s){const n=.5*(-i.y*s.x+t.y*(-i.x+s.x)+t.x*(i.y-s.y)+i.x*s.y),o=n<0?-1:1,a=(t.y*s.x-t.x*s.y+(s.y-t.y)*e.x+(t.x-s.x)*e.y)*o,l=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*o;return a>0&&l>0&&a+l<2*n*o}static Distance(e,t){return Math.sqrt(de.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y;return i*i+s*s}static Center(e,t){const i=new e.constructor;return de.CenterToRef(e,t,i)}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,i){const s=de.DistanceSquared(t,i);if(0===s)return de.Distance(e,t);const n=i.subtract(t),o=Math.max(0,Math.min(1,de.Dot(e.subtract(t),n)/s)),a=t.add(n.multiplyByFloats(o,o));return de.Distance(e,a)}}de._ZeroReadOnly=de.Zero();class v{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,t=0,i=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){let s=Yr(this._x);return s=397*s^Yr(this._y),s=397*s^Yr(this._z),s}asArray(){const e=[];return this.toArray(e,0),e}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return v.FromArrayToRef(e,t,this),this}toQuaternion(){return Z.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this.addInPlaceFromFloats(e._x,e._y,e._z)}addInPlaceFromFloats(e,t,i){return this._x+=e,this._y+=t,this._z+=i,this._isDirty=!0,this}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,i){return new this.constructor(this._x-e,this._y-t,this._z-i)}subtractFromFloatsToRef(e,t,i,s){return s.copyFromFloats(this._x-e,this._y-t,this._z-i)}negate(){return new this.constructor(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e.copyFromFloats(-1*this._x,-1*this._y,-1*this._z)}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t.copyFromFloats(this._x*e,this._y*e,this._z*e)}getNormalToRef(e){const t=this.length();let i=Math.acos(this.y/t);const s=Math.atan2(this.z,this.x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;const n=t*Math.sin(i)*Math.cos(s),o=t*Math.cos(i),a=t*Math.sin(i)*Math.sin(s);return e.set(n,o,a),e}applyRotationQuaternionToRef(e,t){const i=e._w*this._x+e._y*this._z-e._z*this._y,s=e._w*this._y+e._z*this._x-e._x*this._z,n=e._w*this._z+e._x*this._y-e._y*this._x,o=-e._x*this._x-e._y*this._y-e._z*this._z;return t._x=i*e._w+o*-e._x+s*-e._z-n*-e._y,t._y=s*e._w+o*-e._y+n*-e._x-i*-e._z,t._z=n*e._w+o*-e._z+i*-e._y-s*-e._x,t._isDirty=!0,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new this.constructor)}scaleAndAddToRef(e,t){return t.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)}projectOnPlane(e,t){const i=new this.constructor;return this.projectOnPlaneToRef(e,t,i),i}projectOnPlaneToRef(e,t,i){const s=e.normal,n=e.d,o=Ue.Vector3[0];this.subtractToRef(t,o),o.normalize();const a=v.Dot(o,s);if(Math.abs(a)<Math.pow(10,-10))i.setAll(1/0);else{const l=-(v.Dot(t,s)+n)/a,c=o.scaleInPlace(l);t.addToRef(c,i)}return i}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=ot){return e&&oe.WithinEpsilon(this._x,e._x,t)&&oe.WithinEpsilon(this._y,e._y,t)&&oe.WithinEpsilon(this._z,e._z,t)}equalsToFloats(e,t,i){return this._x===e&&this._y===t&&this._z===i}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)}multiplyByFloats(e,t,i){return new this.constructor(this._x*e,this._y*t,this._z*i)}divide(e){return new this.constructor(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(e){const t=Math.abs(this._x),i=Math.abs(this._y);if(!oe.WithinEpsilon(t,i,e))return!0;const s=Math.abs(this._z);return!oe.WithinEpsilon(t,s,e)||!oe.WithinEpsilon(i,s,e)}get isNonUniform(){const e=Math.abs(this._x);return e!==Math.abs(this._y)||e!==Math.abs(this._z)}floor(){return new this.constructor(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}fract(){return new this.constructor(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z==0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){return"xyz"===(e=e.toLowerCase())||(Ue.Vector3[0].copyFrom(this),["x","y","z"].forEach((t,i)=>{this[t]=Ue.Vector3[0][e[i]]})),this}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(Ue.Matrix[0]),v.TransformCoordinatesToRef(this,Ue.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,i){return this.subtractToRef(t,Ue.Vector3[0]),Ue.Vector3[0].rotateByQuaternionToRef(e,Ue.Vector3[0]),t.addToRef(Ue.Vector3[0],i),i}cross(e){const t=new this.constructor;return v.CrossToRef(this,e,t)}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t||1===t?e.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/t,e)}clone(){return new this.constructor(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,i){return this._x=e,this._y=t,this._z=i,this._isDirty=!0,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(e,t,i,s){const n=v.Dot(e,i)-s;return n/(n-(v.Dot(t,i)-s))}static GetAngleBetweenVectors(e,t,i){const s=e.normalizeToRef(Ue.Vector3[1]),n=t.normalizeToRef(Ue.Vector3[2]);let o=v.Dot(s,n);o=oe.Clamp(o,-1,1);const a=Math.acos(o),l=Ue.Vector3[3];return v.CrossToRef(s,n,l),v.Dot(l,i)>0?isNaN(a)?0:a:isNaN(a)?-Math.PI:-Math.acos(o)}static GetAngleBetweenVectorsOnPlane(e,t,i){Ue.Vector3[0].copyFrom(e);const s=Ue.Vector3[0];Ue.Vector3[1].copyFrom(t);const n=Ue.Vector3[1];Ue.Vector3[2].copyFrom(i);const o=Ue.Vector3[2],a=Ue.Vector3[3],l=Ue.Vector3[4];s.normalize(),n.normalize(),o.normalize(),v.CrossToRef(o,s,a),v.CrossToRef(a,o,l);const c=Math.atan2(v.Dot(n,a),v.Dot(n,l));return oe.NormalizeRadians(c)}static PitchYawRollToMoveBetweenPointsToRef(e,t,i){const s=L.Vector3[0];return t.subtractToRef(e,s),i._y=Math.atan2(s.x,s.z)||0,i._x=Math.atan2(Math.sqrt(s.x**2+s.z**2),s.y)||0,i._z=0,i._isDirty=!0,i}static PitchYawRollToMoveBetweenPoints(e,t){const i=v.Zero();return v.PitchYawRollToMoveBetweenPointsToRef(e,t,i)}static SlerpToRef(e,t,i,s){i=oe.Clamp(i,0,1);const n=Ue.Vector3[0],o=Ue.Vector3[1];n.copyFrom(e);const a=n.length();n.normalizeFromLength(a),o.copyFrom(t);const l=o.length();o.normalizeFromLength(l);const c=v.Dot(n,o);let h,u;if(c<1-ot){const d=Math.acos(c),f=1/Math.sin(d);h=Math.sin((1-i)*d)*f,u=Math.sin(i*d)*f}else h=1-i,u=i;return n.scaleInPlace(h),o.scaleInPlace(u),s.copyFrom(n).addInPlace(o),s.scaleInPlace(oe.Lerp(a,l,i)),s}static SmoothToRef(e,t,i,s,n){return v.SlerpToRef(e,t,0===s?1:i/s,n),n}static FromArray(e,t=0){return new v(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return v.FromArray(e,t)}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._isDirty=!0,i}static FromFloatArrayToRef(e,t,i){return v.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,s){return s.copyFromFloats(e,t,i),s}static Zero(){return new v(0,0,0)}static One(){return new v(1,1,1)}static Up(){return new v(0,1,0)}static get UpReadOnly(){return v._UpReadOnly}static get DownReadOnly(){return v._DownReadOnly}static get RightReadOnly(){return v._RightReadOnly}static get LeftReadOnly(){return v._LeftReadOnly}static get LeftHandedForwardReadOnly(){return v._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return v._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return v._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return v._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return v._ZeroReadOnly}static Down(){return new v(0,-1,0)}static Forward(e=!1){return new v(0,0,e?-1:1)}static Backward(e=!1){return new v(0,0,e?1:-1)}static Right(){return new v(1,0,0)}static Left(){return new v(-1,0,0)}static Random(e=0,t=1){return new v(oe.RandomRange(e,t),oe.RandomRange(e,t),oe.RandomRange(e,t))}static TransformCoordinates(e,t){const i=v.Zero();return v.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return v.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,s,n){const o=s.m,l=e*o[1]+t*o[5]+i*o[9]+o[13],c=e*o[2]+t*o[6]+i*o[10]+o[14],h=1/(e*o[3]+t*o[7]+i*o[11]+o[15]);return n._x=(e*o[0]+t*o[4]+i*o[8]+o[12])*h,n._y=l*h,n._z=c*h,n._isDirty=!0,n}static TransformNormal(e,t){const i=v.Zero();return v.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformNormalFromFloatsToRef(e,t,i,s,n){const o=s.m;return n._x=e*o[0]+t*o[4]+i*o[8],n._y=e*o[1]+t*o[5]+i*o[9],n._z=e*o[2]+t*o[6]+i*o[10],n._isDirty=!0,n}static CatmullRom(e,t,i,s,n){const o=n*n,a=n*o;return new e.constructor(.5*(2*t._x+(-e._x+i._x)*n+(2*e._x-5*t._x+4*i._x-s._x)*o+(3*t._x-e._x-3*i._x+s._x)*a),.5*(2*t._y+(-e._y+i._y)*n+(2*e._y-5*t._y+4*i._y-s._y)*o+(3*t._y-e._y-3*i._y+s._y)*a),.5*(2*t._z+(-e._z+i._z)*n+(2*e._z-5*t._z+4*i._z-s._z)*o+(3*t._z-e._z-3*i._z+s._z)*a))}static Clamp(e,t,i){const s=new e.constructor;return v.ClampToRef(e,t,i,s),s}static ClampToRef(e,t,i,s){let n=e._x;n=n>i._x?i._x:n,n=n<t._x?t._x:n;let o=e._y;o=o>i._y?i._y:o,o=o<t._y?t._y:o;let a=e._z;return a=a>i._z?i._z:a,a=a<t._z?t._z:a,s.copyFromFloats(n,o,a),s}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static Hermite(e,t,i,s,n){const o=n*n,a=n*o,l=2*a-3*o+1,c=-2*a+3*o,h=a-2*o+n,u=a-o;return new e.constructor(e._x*l+i._x*c+t._x*h+s._x*u,e._y*l+i._y*c+t._y*h+s._y*u,e._z*l+i._z*c+t._z*h+s._z*u)}static Hermite1stDerivative(e,t,i,s,n){const o=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,s,n,o),o}static Hermite1stDerivativeToRef(e,t,i,s,n,o){const a=n*n;return o._x=6*(a-n)*e._x+(3*a-4*n+1)*t._x+6*(-a+n)*i._x+(3*a-2*n)*s._x,o._y=6*(a-n)*e._y+(3*a-4*n+1)*t._y+6*(-a+n)*i._y+(3*a-2*n)*s._y,o._z=6*(a-n)*e._z+(3*a-4*n+1)*t._z+6*(-a+n)*i._z+(3*a-2*n)*s._z,o._isDirty=!0,o}static Lerp(e,t,i){const s=new e.constructor(0,0,0);return v.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){return s._x=e._x+(t._x-e._x)*i,s._y=e._y+(t._y-e._y)*i,s._z=e._z+(t._z-e._z)*i,s._isDirty=!0,s}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}static Cross(e,t){const i=new e.constructor;return v.CrossToRef(e,t,i),i}static CrossToRef(e,t,i){return i.copyFromFloats(e._y*t._z-e._z*t._y,e._z*t._x-e._x*t._z,e._x*t._y-e._y*t._x),i}static Normalize(e){const t=v.Zero();return v.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(e,t,i,s){const n=new e.constructor;return v.ProjectToRef(e,t,i,s,n),n}static ProjectToRef(e,t,i,s,n){const o=s.width,a=s.height,h=Ue.Matrix[1];F.FromValuesToRef(o/2,0,0,0,0,-a/2,0,0,0,0,.5,0,s.x+o/2,a/2+s.y,.5,1,h);const u=Ue.Matrix[0];return t.multiplyToRef(i,u),u.multiplyToRef(h,u),v.TransformCoordinatesToRef(e,u,n),n}static Reflect(e,t){return this.ReflectToRef(e,t,new v)}static ReflectToRef(e,t,i){const s=L.Vector3[0];return s.copyFrom(t).scaleInPlace(2*v.Dot(e,t)),i.copyFrom(e).subtractInPlace(s)}static _UnprojectFromInvertedMatrixToRef(e,t,i){v.TransformCoordinatesToRef(e,t,i);const s=t.m,n=e._x*s[3]+e._y*s[7]+e._z*s[11]+s[15];return oe.WithinEpsilon(n,1)&&i.scaleInPlace(1/n),i}static UnprojectFromTransform(e,t,i,s,n){return this.Unproject(e,t,i,s,n,F.IdentityReadOnly)}static Unproject(e,t,i,s,n,o){const a=new e.constructor;return v.UnprojectToRef(e,t,i,s,n,o,a),a}static UnprojectToRef(e,t,i,s,n,o,a){return v.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,s,n,o,a),a}static UnprojectFloatsToRef(e,t,i,s,n,o,a,l,c){var h;const u=Ue.Matrix[0];o.multiplyToRef(a,u),u.multiplyToRef(l,u),u.invert();const d=Ue.Vector3[0];return d.x=e/s*2-1,d.y=-(t/n*2-1),d.z=null!==(h=be.LastCreatedEngine)&&void 0!==h&&h.isNDCHalfZRange?i:2*i-1,v._UnprojectFromInvertedMatrixToRef(d,u,c),c}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(v.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e._x-t._x,s=e._y-t._y,n=e._z-t._z;return i*i+s*s+n*n}static ProjectOnTriangleToRef(e,t,i,s,n){const o=Ue.Vector3[0],a=Ue.Vector3[1],l=Ue.Vector3[2],c=Ue.Vector3[3],h=Ue.Vector3[4];i.subtractToRef(t,o),s.subtractToRef(t,a),s.subtractToRef(i,l);const u=o.length(),d=a.length(),f=l.length();if(u<ot||d<ot||f<ot)return n.copyFrom(t),v.Distance(e,t);e.subtractToRef(t,h),v.CrossToRef(o,a,c);const p=c.length();if(p<ot)return n.copyFrom(t),v.Distance(e,t);c.normalizeFromLength(p);let _=h.length();if(_<ot)return n.copyFrom(t),0;h.normalizeFromLength(_);const m=v.Dot(c,h),g=Ue.Vector3[5],b=Ue.Vector3[6];g.copyFrom(c).scaleInPlace(-_*m),b.copyFrom(e).addInPlace(g);const y=Ue.Vector3[4],T=Ue.Vector3[5],x=Ue.Vector3[7],S=Ue.Vector3[8];y.copyFrom(o).scaleInPlace(1/u),S.copyFrom(a).scaleInPlace(1/d),y.addInPlace(S).scaleInPlace(-1),T.copyFrom(o).scaleInPlace(-1/u),S.copyFrom(l).scaleInPlace(1/f),T.addInPlace(S).scaleInPlace(-1),x.copyFrom(l).scaleInPlace(-1/f),S.copyFrom(a).scaleInPlace(-1/d),x.addInPlace(S).scaleInPlace(-1);const C=Ue.Vector3[9];let D;C.copyFrom(b).subtractInPlace(t),v.CrossToRef(y,C,S),D=v.Dot(S,c);const P=D;C.copyFrom(b).subtractInPlace(i),v.CrossToRef(T,C,S),D=v.Dot(S,c);const M=D;C.copyFrom(b).subtractInPlace(s),v.CrossToRef(x,C,S),D=v.Dot(S,c);const w=D,k=Ue.Vector3[10];let X,te;P>0&&M<0?(k.copyFrom(o),X=t,te=i):M>0&&w<0?(k.copyFrom(l),X=i,te=s):(k.copyFrom(a).scaleInPlace(-1),X=s,te=t);const J=Ue.Vector3[9],Q=Ue.Vector3[4];if(X.subtractToRef(b,S),te.subtractToRef(b,J),v.CrossToRef(S,J,Q),!(v.Dot(Q,c)<0))return n.copyFrom(b),Math.abs(_*m);const ae=Ue.Vector3[5];v.CrossToRef(k,Q,ae),ae.normalize();const W=Ue.Vector3[9];W.copyFrom(X).subtractInPlace(b);const K=W.length();if(K<ot)return n.copyFrom(X),v.Distance(e,X);W.normalizeFromLength(K);const O=v.Dot(ae,W),H=Ue.Vector3[7];H.copyFrom(b).addInPlace(ae.scaleInPlace(K*O)),S.copyFrom(H).subtractInPlace(X),_=k.length(),k.normalizeFromLength(_);let Y=v.Dot(S,k)/Math.max(_,ot);return Y=oe.Clamp(Y,0,1),H.copyFrom(X).addInPlace(k.scaleInPlace(Y*_)),n.copyFrom(H),v.Distance(e,H)}static Center(e,t){return v.CenterToRef(e,t,v.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,i){const s=new e.constructor;return v.RotationFromAxisToRef(e,t,i,s),s}static RotationFromAxisToRef(e,t,i,s){const n=Ue.Quaternion[0];return Z.RotationQuaternionFromAxisToRef(e,t,i,n),n.toEulerAnglesToRef(s),s}}v._UpReadOnly=v.Up(),v._DownReadOnly=v.Down(),v._LeftHandedForwardReadOnly=v.Forward(!1),v._RightHandedForwardReadOnly=v.Forward(!0),v._LeftHandedBackwardReadOnly=v.Backward(!1),v._RightHandedBackwardReadOnly=v.Backward(!0),v._RightReadOnly=v.Right(),v._LeftReadOnly=v.Left(),v._ZeroReadOnly=v.Zero();class vt{constructor(e=0,t=0,i=0,s=0){this.x=e,this.y=t,this.z=i,this.w=s}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){let n=Yr(this.x);return n=397*n^Yr(this.y),n=397*n^Yr(this.z),n=397*n^Yr(this.w),n}asArray(){const e=new Array;return this.toArray(e,0),e}toArray(e,t){return void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}fromArray(e,t=0){return vt.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add(e){return new this.constructor(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,t}subtractFromFloats(e,t,i,s){return new this.constructor(this.x-e,this.y-t,this.z-i,this.w-s)}subtractFromFloatsToRef(e,t,i,s,n){return n.x=this.x-e,n.y=this.y-t,n.z=this.z-i,n.w=this.w-s,n}negate(){return new this.constructor(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.copyFromFloats(-1*this.x,-1*this.y,-1*this.z,-1*this.w)}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new this.constructor(this.x*e,this.y*e,this.z*e,this.w*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsWithEpsilon(e,t=ot){return e&&oe.WithinEpsilon(this.x,e.x,t)&&oe.WithinEpsilon(this.y,e.y,t)&&oe.WithinEpsilon(this.z,e.z,t)&&oe.WithinEpsilon(this.w,e.w,t)}equalsToFloats(e,t,i,s){return this.x===e&&this.y===t&&this.z===i&&this.w===s}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,t}multiplyByFloats(e,t,i,s){return new this.constructor(this.x*e,this.y*t,this.z*i,this.w*s)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){const e=this.length();return 0===e?this:this.scaleInPlace(1/e)}toVector3(){return new v(this.x,this.y,this.z)}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}setAll(e){return this.x=this.y=this.z=this.w=e,this}static FromArray(e,t){return t||(t=0),new vt(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}static FromFloatArrayToRef(e,t,i){return vt.FromArrayToRef(e,t,i),i}static FromFloatsToRef(e,t,i,s,n){return n.x=e,n.y=t,n.z=i,n.w=s,n}static Zero(){return new vt(0,0,0,0)}static One(){return new vt(1,1,1,1)}static Random(e=0,t=1){return new vt(oe.RandomRange(e,t),oe.RandomRange(e,t),oe.RandomRange(e,t),oe.RandomRange(e,t))}static get ZeroReadOnly(){return vt._ZeroReadOnly}static Normalize(e){const t=vt.Zero();return vt.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return t.copyFrom(e),t.normalize(),t}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(vt.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y,n=e.z-t.z,o=e.w-t.w;return i*i+s*s+n*n+o*o}static Center(e,t){return vt.CenterToRef(e,t,vt.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}static TransformCoordinates(e,t){const i=vt.Zero();return vt.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return vt.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,s,n){const o=s.m,l=e*o[1]+t*o[5]+i*o[9]+o[13],c=e*o[2]+t*o[6]+i*o[10]+o[14],h=e*o[3]+t*o[7]+i*o[11]+o[15];return n.x=e*o[0]+t*o[4]+i*o[8]+o[12],n.y=l,n.z=c,n.w=h,n}static TransformNormal(e,t){const i=new e.constructor;return vt.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){const s=t.m,o=e.x*s[1]+e.y*s[5]+e.z*s[9],a=e.x*s[2]+e.y*s[6]+e.z*s[10];return i.x=e.x*s[0]+e.y*s[4]+e.z*s[8],i.y=o,i.z=a,i.w=e.w,i}static TransformNormalFromFloatsToRef(e,t,i,s,n,o){const a=n.m;return o.x=e*a[0]+t*a[4]+i*a[8],o.y=e*a[1]+t*a[5]+i*a[9],o.z=e*a[2]+t*a[6]+i*a[10],o.w=s,o}static FromVector3(e,t=0){return new vt(e._x,e._y,e._z,t)}}vt._ZeroReadOnly=vt.Zero();class Z{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,i=0,s=1){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=s}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){let n=Yr(this._x);return n=397*n^Yr(this._y),n=397*n^Yr(this._z),n=397*n^Yr(this._w),n}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=ot){return e&&oe.WithinEpsilon(this._x,e._x,t)&&oe.WithinEpsilon(this._y,e._y,t)&&oe.WithinEpsilon(this._z,e._z,t)&&oe.WithinEpsilon(this._w,e._w,t)}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,t,i,s){return this._x=e,this._y=t,this._z=i,this._w=s,this._isDirty=!0,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=!0,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=!0,t}multiply(e){const t=new this.constructor(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){return t.copyFromFloats(this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w),t}multiplyInPlace(e){return this.multiplyToRef(e,this),this}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new this.constructor(-this._x,-this._y,-this._z,this._w)}invert(){const e=this.conjugate(),t=this.lengthSquared();return 0==t||1==t||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();const e=this.lengthSquared();return 0==e||1==e||this.scaleInPlace(1/e),this}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){const e=this.length();return 0===e||this.scaleInPlace(1/e),this}normalizeToNew(){const e=this.length();return 0===e?this.clone():this.scale(1/e)}toEulerAngles(){const e=v.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){const t=this._z,i=this._x,s=this._y,n=this._w,o=s*t-i*n,a=.4999999;if(o<-a)e._y=2*Math.atan2(s,n),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(o>a)e._y=2*Math.atan2(s,n),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{const l=n*n,c=t*t,h=i*i,u=s*s;e._z=Math.atan2(2*(i*s+t*n),-c-h+u+l),e._x=Math.asin(-2*o),e._y=Math.atan2(2*(t*i+s*n),c-h-u+l),e._isDirty=!0}return e}toRotationMatrix(e){return F.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return Z.FromRotationMatrixToRef(e,this),this}static FromRotationMatrix(e){const t=new Z;return Z.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){const i=e.m,s=i[0],n=i[4],o=i[8],a=i[1],l=i[5],c=i[9],h=i[2],u=i[6],d=i[10],f=s+l+d;let p;return f>0?(p=.5/Math.sqrt(f+1),t._w=.25/p,t._x=(u-c)*p,t._y=(o-h)*p,t._z=(a-n)*p,t._isDirty=!0):s>l&&s>d?(p=2*Math.sqrt(1+s-l-d),t._w=(u-c)/p,t._x=.25*p,t._y=(n+a)/p,t._z=(o+h)/p,t._isDirty=!0):l>d?(p=2*Math.sqrt(1+l-s-d),t._w=(o-h)/p,t._x=(n+a)/p,t._y=.25*p,t._z=(c+u)/p,t._isDirty=!0):(p=2*Math.sqrt(1+d-s-l),t._w=(a-n)/p,t._x=(o+h)/p,t._y=(c+u)/p,t._z=.25*p,t._isDirty=!0),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,i=.1){const s=Z.Dot(e,t);return 1-s*s<=i}static SmoothToRef(e,t,i,s,n){let o=0===s?1:i/s;return o=oe.Clamp(o,0,1),Z.SlerpToRef(e,t,o,n),n}static Zero(){return new Z(0,0,0,0)}static Inverse(e){return new e.constructor(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new Z(0,0,0,1)}static IsIdentity(e){return e&&0===e._x&&0===e._y&&0===e._z&&1===e._w}static RotationAxis(e,t){return Z.RotationAxisToRef(e,t,new Z)}static RotationAxisToRef(e,t,i){const s=Math.sin(t/2);return e.normalize(),i._w=Math.cos(t/2),i._x=e._x*s,i._y=e._y*s,i._z=e._z*s,i._isDirty=!0,i}static FromArray(e,t){return t||(t=0),new Z(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._w=e[t+3],i._isDirty=!0,i}static FromEulerAngles(e,t,i){const s=new Z;return Z.RotationYawPitchRollToRef(t,e,i,s),s}static FromEulerAnglesToRef(e,t,i,s){return Z.RotationYawPitchRollToRef(t,e,i,s),s}static FromEulerVector(e){const t=new Z;return Z.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return Z.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,i){const s=v.Dot(e,t)+1;return s<ot?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(v.CrossToRef(e,t,L.Vector3[0]),i.set(L.Vector3[0].x,L.Vector3[0].y,L.Vector3[0].z,s)),i.normalize()}static RotationYawPitchRoll(e,t,i){const s=new Z;return Z.RotationYawPitchRollToRef(e,t,i,s),s}static RotationYawPitchRollToRef(e,t,i,s){const n=.5*i,o=.5*t,a=.5*e,l=Math.sin(n),c=Math.cos(n),h=Math.sin(o),u=Math.cos(o),d=Math.sin(a),f=Math.cos(a);return s._x=f*h*c+d*u*l,s._y=d*u*c-f*h*l,s._z=f*u*l-d*h*c,s._w=f*u*c+d*h*l,s._isDirty=!0,s}static RotationAlphaBetaGamma(e,t,i){const s=new Z;return Z.RotationAlphaBetaGammaToRef(e,t,i,s),s}static RotationAlphaBetaGammaToRef(e,t,i,s){const n=.5*(i+e),o=.5*(i-e),a=.5*t;return s._x=Math.cos(o)*Math.sin(a),s._y=Math.sin(o)*Math.sin(a),s._z=Math.sin(n)*Math.cos(a),s._w=Math.cos(n)*Math.cos(a),s._isDirty=!0,s}static RotationQuaternionFromAxis(e,t,i){const s=new Z(0,0,0,0);return Z.RotationQuaternionFromAxisToRef(e,t,i,s),s}static RotationQuaternionFromAxisToRef(e,t,i,s){const n=Ue.Matrix[0];return F.FromXYZAxesToRef(e.normalize(),t.normalize(),i.normalize(),n),Z.FromRotationMatrixToRef(n,s),s}static FromLookDirectionLH(e,t){const i=new Z;return Z.FromLookDirectionLHToRef(e,t,i),i}static FromLookDirectionLHToRef(e,t,i){const s=Ue.Matrix[0];return F.LookDirectionLHToRef(e,t,s),Z.FromRotationMatrixToRef(s,i),i}static FromLookDirectionRH(e,t){const i=new Z;return Z.FromLookDirectionRHToRef(e,t,i),i}static FromLookDirectionRHToRef(e,t,i){const s=Ue.Matrix[0];return F.LookDirectionRHToRef(e,t,s),Z.FromRotationMatrixToRef(s,i)}static Slerp(e,t,i){const s=Z.Identity();return Z.SlerpToRef(e,t,i,s),s}static SlerpToRef(e,t,i,s){let n,o,a=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,l=!1;if(a<0&&(l=!0,a=-a),a>.999999)o=1-i,n=l?-i:i;else{const c=Math.acos(a),h=1/Math.sin(c);o=Math.sin((1-i)*c)*h,n=l?-Math.sin(i*c)*h:Math.sin(i*c)*h}return s._x=o*e._x+n*t._x,s._y=o*e._y+n*t._y,s._z=o*e._z+n*t._z,s._w=o*e._w+n*t._w,s._isDirty=!0,s}static Hermite(e,t,i,s,n){const o=n*n,a=n*o,l=2*a-3*o+1,c=-2*a+3*o,h=a-2*o+n,u=a-o;return new e.constructor(e._x*l+i._x*c+t._x*h+s._x*u,e._y*l+i._y*c+t._y*h+s._y*u,e._z*l+i._z*c+t._z*h+s._z*u,e._w*l+i._w*c+t._w*h+s._w*u)}static Hermite1stDerivative(e,t,i,s,n){const o=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,s,n,o),o}static Hermite1stDerivativeToRef(e,t,i,s,n,o){const a=n*n;return o._x=6*(a-n)*e._x+(3*a-4*n+1)*t._x+6*(-a+n)*i._x+(3*a-2*n)*s._x,o._y=6*(a-n)*e._y+(3*a-4*n+1)*t._y+6*(-a+n)*i._y+(3*a-2*n)*s._y,o._z=6*(a-n)*e._z+(3*a-4*n+1)*t._z+6*(-a+n)*i._z+(3*a-2*n)*s._z,o._w=6*(a-n)*e._w+(3*a-4*n+1)*t._w+6*(-a+n)*i._w+(3*a-2*n)*s._w,o._isDirty=!0,o}}class F{static get Use64Bits(){return Ds.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=F._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,i=!1,s=!0){this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=!this._isIdentity&&t,this._isIdentity3x2Dirty=!this._isIdentity3x2&&s}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,Ds.MatrixTrackPrecisionChange&&Ds.MatrixTrackedMatrices.push(this),this._m=new Ds.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;const e=this._m;this._isIdentity=1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._isIdentity3x2=1===this._m[0]&&1===this._m[5]&&1===this._m[15]&&0===this._m[1]&&0===this._m[2]&&0===this._m[3]&&0===this._m[4]&&0===this._m[6]&&0===this._m[7]&&0===this._m[8]&&0===this._m[9]&&0===this._m[10]&&0===this._m[11]&&0===this._m[12]&&0===this._m[13]&&0===this._m[14]),this._isIdentity3x2}determinant(){if(!0===this._isIdentity)return 1;const e=this._m,o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],u=e[9],d=e[10],f=e[11],p=e[12],_=e[13],m=e[14],g=e[15],b=d*g-m*f,y=u*g-_*f,T=u*m-_*d,x=h*g-p*f,S=h*m-d*p,C=h*_-p*u;return e[0]*+(a*b-l*y+c*T)+e[1]*-(o*b-l*x+c*S)+e[2]*+(o*y-a*x+c*C)+e[3]*-(o*T-a*S+l*C)}toArray(){return this._m}asArray(){return this._m}invert(){return this.invertToRef(this),this}reset(){return F.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){const t=new this.constructor;return this.addToRef(e,t),t}addToRef(e,t){const i=this._m,s=t._m,n=e.m;for(let o=0;o<16;o++)s[o]=i[o]+n[o];return t.markAsUpdated(),t}addToSelf(e){const t=this._m,i=e.m;for(let s=0;s<16;s++)t[s]+=i[s];return this.markAsUpdated(),this}invertToRef(e){if(!0===this._isIdentity)return F.IdentityToRef(e),e;const t=this._m,i=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],u=t[8],d=t[9],f=t[10],p=t[11],_=t[12],m=t[13],g=t[14],b=t[15],y=f*b-g*p,T=d*b-m*p,x=d*g-m*f,S=u*b-_*p,C=u*g-f*_,D=u*m-_*d,P=+(l*y-c*T+h*x),M=-(a*y-c*S+h*C),w=+(a*T-l*S+h*D),k=-(a*x-l*C+c*D),X=i*P+s*M+n*w+o*k;if(0===X)return e.copyFrom(this),e;const te=1/X,J=c*b-g*h,Q=l*b-m*h,me=l*g-m*c,ae=a*b-_*h,W=a*g-_*c,K=a*m-_*l,O=c*p-f*h,H=l*p-d*h,Y=l*f-d*c,he=a*p-u*h,Le=a*f-u*c,Fe=a*d-u*l;return F.FromValuesToRef(P*te,-(s*y-n*T+o*x)*te,+(s*J-n*Q+o*me)*te,-(s*O-n*H+o*Y)*te,M*te,+(i*y-n*S+o*C)*te,-(i*J-n*ae+o*W)*te,+(i*O-n*he+o*Le)*te,w*te,-(i*T-s*S+o*D)*te,+(i*Q-s*ae+o*K)*te,-(i*H-s*he+o*Fe)*te,k*te,+(i*x-s*C+n*D)*te,-(i*me-s*W+n*K)*te,+(i*Y-s*Le+n*Fe)*te,e),e}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new v(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){const e=this.m;return F.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]),this}multiply(e){const t=new this.constructor;return this.multiplyToRef(e,t),t}copyFrom(e){e.copyToArray(this._m);const t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){const i=this._m;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],this}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,i){const s=this._m,n=e.m,o=s[0],a=s[1],l=s[2],c=s[3],h=s[4],u=s[5],d=s[6],f=s[7],p=s[8],_=s[9],m=s[10],g=s[11],b=s[12],y=s[13],T=s[14],x=s[15],S=n[0],C=n[1],D=n[2],P=n[3],M=n[4],w=n[5],k=n[6],X=n[7],te=n[8],J=n[9],Q=n[10],me=n[11],ae=n[12],W=n[13],K=n[14],O=n[15];return t[i]=o*S+a*M+l*te+c*ae,t[i+1]=o*C+a*w+l*J+c*W,t[i+2]=o*D+a*k+l*Q+c*K,t[i+3]=o*P+a*X+l*me+c*O,t[i+4]=h*S+u*M+d*te+f*ae,t[i+5]=h*C+u*w+d*J+f*W,t[i+6]=h*D+u*k+d*Q+f*K,t[i+7]=h*P+u*X+d*me+f*O,t[i+8]=p*S+_*M+m*te+g*ae,t[i+9]=p*C+_*w+m*J+g*W,t[i+10]=p*D+_*k+m*Q+g*K,t[i+11]=p*P+_*X+m*me+g*O,t[i+12]=b*S+y*M+T*te+x*ae,t[i+13]=b*C+y*w+T*J+x*W,t[i+14]=b*D+y*k+T*Q+x*K,t[i+15]=b*P+y*X+T*me+x*O,this}equals(e){if(!e)return!1;if((this._isIdentity||e._isIdentity)&&!this._isIdentityDirty&&!e._isIdentityDirty)return this._isIdentity&&e._isIdentity;const i=this.m,s=e.m;return i[0]===s[0]&&i[1]===s[1]&&i[2]===s[2]&&i[3]===s[3]&&i[4]===s[4]&&i[5]===s[5]&&i[6]===s[6]&&i[7]===s[7]&&i[8]===s[8]&&i[9]===s[9]&&i[10]===s[10]&&i[11]===s[11]&&i[12]===s[12]&&i[13]===s[13]&&i[14]===s[14]&&i[15]===s[15]}clone(){const e=new this.constructor;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=Yr(this._m[0]);for(let t=1;t<16;t++)e=397*e^Yr(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new Z,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,i,s){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;const n=this._m;if(i&&i.copyFromFloats(n[12],n[13],n[14]),(e=e||Ue.Vector3[0]).x=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),e.y=Math.sqrt(n[4]*n[4]+n[5]*n[5]+n[6]*n[6]),e.z=Math.sqrt(n[8]*n[8]+n[9]*n[9]+n[10]*n[10]),s){const a=s.scaling.y<0?-1:1,l=s.scaling.z<0?-1:1;e.x*=s.scaling.x<0?-1:1,e.y*=a,e.z*=l}else this.determinant()<=0&&(e.y*=-1);if(0===e._x||0===e._y||0===e._z)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){const o=1/e._x,a=1/e._y,l=1/e._z;F.FromValuesToRef(n[0]*o,n[1]*o,n[2]*o,0,n[4]*a,n[5]*a,n[6]*a,0,n[8]*l,n[9]*l,n[10]*l,0,0,0,0,1,Ue.Matrix[0]),Z.FromRotationMatrixToRef(Ue.Matrix[0],t)}return!0}getRow(e){if(e<0||e>3)return null;const t=4*e;return new vt(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<3){const i=4*e;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3]}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){const e=new this.constructor;return F.TransposeToRef(this,e),e}transposeToRef(e){return F.TransposeToRef(this,e),e}setRowFromFloats(e,t,i,s,n){if(e<0||e>3)return this;const o=4*e;return this._m[o+0]=t,this._m[o+1]=i,this._m[o+2]=s,this._m[o+3]=n,this.markAsUpdated(),this}scale(e){const t=new this.constructor;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),t}toNormalMatrix(e){const t=Ue.Matrix[0];this.invertToRef(t),t.transposeToRef(e);const i=e._m;return F.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e),e}getRotationMatrix(){const e=new this.constructor;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){const t=Ue.Vector3[0];if(!this.decompose(t))return F.IdentityToRef(e),e;const i=this._m,s=1/t._x,n=1/t._y,o=1/t._z;return F.FromValuesToRef(i[0]*s,i[1]*s,i[2]*s,0,i[4]*n,i[5]*n,i[6]*n,0,i[8]*o,i[9]*o,i[10]*o,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){const e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){const e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,t=0){const i=new F;return F.FromArrayToRef(e,t,i),i}static FromArrayToRef(e,t,i){for(let s=0;s<16;s++)i._m[s]=e[s+t];return i.markAsUpdated(),i}static FromFloat32ArrayToRefScaled(e,t,i,s){for(let n=0;n<16;n++)s._m[n]=e[n+t]*i;return s.markAsUpdated(),s}static get IdentityReadOnly(){return F._IdentityReadOnly}static FromValuesToRef(e,t,i,s,n,o,a,l,c,h,u,d,f,p,_,m,g){const b=g._m;b[0]=e,b[1]=t,b[2]=i,b[3]=s,b[4]=n,b[5]=o,b[6]=a,b[7]=l,b[8]=c,b[9]=h,b[10]=u,b[11]=d,b[12]=f,b[13]=p,b[14]=_,b[15]=m,g.markAsUpdated()}static FromValues(e,t,i,s,n,o,a,l,c,h,u,d,f,p,_,m){const g=new F,b=g._m;return b[0]=e,b[1]=t,b[2]=i,b[3]=s,b[4]=n,b[5]=o,b[6]=a,b[7]=l,b[8]=c,b[9]=h,b[10]=u,b[11]=d,b[12]=f,b[13]=p,b[14]=_,b[15]=m,g.markAsUpdated(),g}static Compose(e,t,i){const s=new F;return F.ComposeToRef(e,t,i,s),s}static ComposeToRef(e,t,i,s){const n=s._m,o=t._x,a=t._y,l=t._z,c=t._w,h=o+o,u=a+a,d=l+l,f=o*h,p=o*u,_=o*d,m=a*u,g=a*d,b=l*d,y=c*h,T=c*u,x=c*d,S=e._x,C=e._y,D=e._z;return n[0]=(1-(m+b))*S,n[1]=(p+x)*S,n[2]=(_-T)*S,n[3]=0,n[4]=(p-x)*C,n[5]=(1-(f+b))*C,n[6]=(g+y)*C,n[7]=0,n[8]=(_+T)*D,n[9]=(g-y)*D,n[10]=(1-(f+m))*D,n[11]=0,n[12]=i._x,n[13]=i._y,n[14]=i._z,n[15]=1,s.markAsUpdated(),s}static Identity(){const e=F.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){return F.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0),e}static Zero(){const e=F.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){const t=new F;return F.RotationXToRef(e,t),t}static Invert(e){const t=new e.constructor;return e.invertToRef(t),t}static RotationXToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return F.FromValuesToRef(1,0,0,0,0,s,i,0,0,-i,s,0,0,0,0,1,t),t._updateIdentityStatus(1===s&&0===i),t}static RotationY(e){const t=new F;return F.RotationYToRef(e,t),t}static RotationYToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return F.FromValuesToRef(s,0,-i,0,0,1,0,0,i,0,s,0,0,0,0,1,t),t._updateIdentityStatus(1===s&&0===i),t}static RotationZ(e){const t=new F;return F.RotationZToRef(e,t),t}static RotationZToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return F.FromValuesToRef(s,i,0,0,-i,s,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(1===s&&0===i),t}static RotationAxis(e,t){const i=new F;return F.RotationAxisToRef(e,t,i),i}static RotationAxisToRef(e,t,i){const s=Math.sin(-t),n=Math.cos(-t),o=1-n;e.normalize();const a=i._m;return a[0]=e._x*e._x*o+n,a[1]=e._x*e._y*o-e._z*s,a[2]=e._x*e._z*o+e._y*s,a[3]=0,a[4]=e._y*e._x*o+e._z*s,a[5]=e._y*e._y*o+n,a[6]=e._y*e._z*o-e._x*s,a[7]=0,a[8]=e._z*e._x*o-e._y*s,a[9]=e._z*e._y*o+e._x*s,a[10]=e._z*e._z*o+n,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,i.markAsUpdated(),i}static RotationAlignToRef(e,t,i){const s=v.Dot(t,e),n=i._m;if(s<-1+ot)n[0]=-1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0;else{const o=v.Cross(t,e),a=1/(1+s);n[0]=o._x*o._x*a+s,n[1]=o._y*o._x*a-o._z,n[2]=o._z*o._x*a+o._y,n[3]=0,n[4]=o._x*o._y*a+o._z,n[5]=o._y*o._y*a+s,n[6]=o._z*o._y*a-o._x,n[7]=0,n[8]=o._x*o._z*a-o._y,n[9]=o._y*o._z*a+o._x,n[10]=o._z*o._z*a+s,n[11]=0}return n[12]=0,n[13]=0,n[14]=0,n[15]=1,i.markAsUpdated(),i}static RotationYawPitchRoll(e,t,i){const s=new F;return F.RotationYawPitchRollToRef(e,t,i,s),s}static RotationYawPitchRollToRef(e,t,i,s){return Z.RotationYawPitchRollToRef(e,t,i,Ue.Quaternion[0]),Ue.Quaternion[0].toRotationMatrix(s),s}static Scaling(e,t,i){const s=new F;return F.ScalingToRef(e,t,i,s),s}static ScalingToRef(e,t,i,s){return F.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,s),s._updateIdentityStatus(1===e&&1===t&&1===i),s}static Translation(e,t,i){const s=new F;return F.TranslationToRef(e,t,i,s),s}static TranslationToRef(e,t,i,s){return F.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,s),s._updateIdentityStatus(0===e&&0===t&&0===i),s}static Lerp(e,t,i){const s=new e.constructor;return F.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){const n=s._m,o=e.m,a=t.m;for(let l=0;l<16;l++)n[l]=o[l]*(1-i)+a[l]*i;return s.markAsUpdated(),s}static DecomposeLerp(e,t,i){const s=new e.constructor;return F.DecomposeLerpToRef(e,t,i,s),s}static DecomposeLerpToRef(e,t,i,s){const n=Ue.Vector3[0],o=Ue.Quaternion[0],a=Ue.Vector3[1];e.decompose(n,o,a);const l=Ue.Vector3[2],c=Ue.Quaternion[1],h=Ue.Vector3[3];t.decompose(l,c,h);const u=Ue.Vector3[4];v.LerpToRef(n,l,i,u);const d=Ue.Quaternion[2];Z.SlerpToRef(o,c,i,d);const f=Ue.Vector3[5];return v.LerpToRef(a,h,i,f),F.ComposeToRef(u,d,f,s),s}static LookAtLH(e,t,i){const s=new F;return F.LookAtLHToRef(e,t,i,s),s}static LookAtLHToRef(e,t,i,s){const n=Ue.Vector3[0],o=Ue.Vector3[1],a=Ue.Vector3[2];t.subtractToRef(e,a),a.normalize(),v.CrossToRef(i,a,n);const l=n.lengthSquared();0===l?n.x=1:n.normalizeFromLength(Math.sqrt(l)),v.CrossToRef(a,n,o),o.normalize();const c=-v.Dot(n,e),h=-v.Dot(o,e),u=-v.Dot(a,e);F.FromValuesToRef(n._x,o._x,a._x,0,n._y,o._y,a._y,0,n._z,o._z,a._z,0,c,h,u,1,s)}static LookAtRH(e,t,i){const s=new F;return F.LookAtRHToRef(e,t,i,s),s}static LookAtRHToRef(e,t,i,s){const n=Ue.Vector3[0],o=Ue.Vector3[1],a=Ue.Vector3[2];e.subtractToRef(t,a),a.normalize(),v.CrossToRef(i,a,n);const l=n.lengthSquared();0===l?n.x=1:n.normalizeFromLength(Math.sqrt(l)),v.CrossToRef(a,n,o),o.normalize();const c=-v.Dot(n,e),h=-v.Dot(o,e),u=-v.Dot(a,e);return F.FromValuesToRef(n._x,o._x,a._x,0,n._y,o._y,a._y,0,n._z,o._z,a._z,0,c,h,u,1,s),s}static LookDirectionLH(e,t){const i=new F;return F.LookDirectionLHToRef(e,t,i),i}static LookDirectionLHToRef(e,t,i){const s=Ue.Vector3[0];s.copyFrom(e),s.scaleInPlace(-1);const n=Ue.Vector3[1];return v.CrossToRef(t,s,n),F.FromValuesToRef(n._x,n._y,n._z,0,t._x,t._y,t._z,0,s._x,s._y,s._z,0,0,0,0,1,i),i}static LookDirectionRH(e,t){const i=new F;return F.LookDirectionRHToRef(e,t,i),i}static LookDirectionRHToRef(e,t,i){const s=Ue.Vector3[2];return v.CrossToRef(t,e,s),F.FromValuesToRef(s._x,s._y,s._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i),i}static OrthoLH(e,t,i,s,n){const o=new F;return F.OrthoLHToRef(e,t,i,s,o,n),o}static OrthoLHToRef(e,t,i,s,n,o){const c=2/e,h=2/t,u=2/(s-i),d=-(s+i)/(s-i);return F.FromValuesToRef(c,0,0,0,0,h,0,0,0,0,u,0,0,0,d,1,n),o&&n.multiplyToRef(jl,n),n._updateIdentityStatus(1===c&&1===h&&1===u&&0===d),n}static OrthoOffCenterLH(e,t,i,s,n,o,a){const l=new F;return F.OrthoOffCenterLHToRef(e,t,i,s,n,o,l,a),l}static OrthoOffCenterLHToRef(e,t,i,s,n,o,a,l){return F.FromValuesToRef(2/(t-e),0,0,0,0,2/(s-i),0,0,0,0,2/(o-n),0,(e+t)/(e-t),(s+i)/(i-s),-(o+n)/(o-n),1,a),l&&a.multiplyToRef(jl,a),a.markAsUpdated(),a}static OrthoOffCenterRH(e,t,i,s,n,o,a){const l=new F;return F.OrthoOffCenterRHToRef(e,t,i,s,n,o,l,a),l}static OrthoOffCenterRHToRef(e,t,i,s,n,o,a,l){return F.OrthoOffCenterLHToRef(e,t,i,s,n,o,a,l),a._m[10]*=-1,a}static PerspectiveLH(e,t,i,s,n,o=0){const a=new F,h=2*i/e,u=2*i/t,d=(s+i)/(s-i),f=-2*s*i/(s-i),p=Math.tan(o);return F.FromValuesToRef(h,0,0,0,0,u,0,p,0,0,d,1,0,0,f,0,a),n&&a.multiplyToRef(jl,a),a._updateIdentityStatus(!1),a}static PerspectiveFovLH(e,t,i,s,n,o=0,a=!1){const l=new F;return F.PerspectiveFovLHToRef(e,t,i,s,l,!0,n,o,a),l}static PerspectiveFovLHToRef(e,t,i,s,n,o=!0,a,l=0,c=!1){const h=i,u=s,d=1/Math.tan(.5*e),f=o?d/t:d,p=o?d:d*t,_=c&&0===h?-1:0!==u?(u+h)/(u-h):1,m=c&&0===h?2*u:0!==u?-2*u*h/(u-h):-2*h,g=Math.tan(l);return F.FromValuesToRef(f,0,0,0,0,p,0,g,0,0,_,1,0,0,m,0,n),a&&n.multiplyToRef(jl,n),n._updateIdentityStatus(!1),n}static PerspectiveFovReverseLHToRef(e,t,i,s,n,o=!0,a,l=0){const c=1/Math.tan(.5*e),h=o?c/t:c,u=o?c:c*t,d=Math.tan(l);return F.FromValuesToRef(h,0,0,0,0,u,0,d,0,0,-i,1,0,0,1,0,n),a&&n.multiplyToRef(jl,n),n._updateIdentityStatus(!1),n}static PerspectiveFovRH(e,t,i,s,n,o=0,a=!1){const l=new F;return F.PerspectiveFovRHToRef(e,t,i,s,l,!0,n,o,a),l}static PerspectiveFovRHToRef(e,t,i,s,n,o=!0,a,l=0,c=!1){const h=i,u=s,d=1/Math.tan(.5*e),f=o?d/t:d,p=o?d:d*t,_=c&&0===h?1:0!==u?-(u+h)/(u-h):-1,m=c&&0===h?2*u:0!==u?-2*u*h/(u-h):-2*h,g=Math.tan(l);return F.FromValuesToRef(f,0,0,0,0,p,0,g,0,0,_,-1,0,0,m,0,n),a&&n.multiplyToRef(jl,n),n._updateIdentityStatus(!1),n}static PerspectiveFovReverseRHToRef(e,t,i,s,n,o=!0,a,l=0){const c=1/Math.tan(.5*e),h=o?c/t:c,u=o?c:c*t,d=Math.tan(l);return F.FromValuesToRef(h,0,0,0,0,u,0,d,0,0,-i,-1,0,0,-1,0,n),a&&n.multiplyToRef(jl,n),n._updateIdentityStatus(!1),n}static PerspectiveFovWebVRToRef(e,t,i,s,n=!1,o,a=0){const l=n?-1:1,c=Math.tan(e.upDegrees*Math.PI/180),h=Math.tan(e.downDegrees*Math.PI/180),u=Math.tan(e.leftDegrees*Math.PI/180),d=Math.tan(e.rightDegrees*Math.PI/180),f=2/(u+d),p=2/(c+h),_=Math.tan(a),m=s._m;return m[0]=f,m[1]=m[2]=m[3]=m[4]=0,m[5]=p,m[6]=0,m[7]=_,m[8]=(u-d)*f*.5,m[9]=-(c-h)*p*.5,m[10]=-i/(t-i),m[11]=1*l,m[12]=m[13]=m[15]=0,m[14]=-2*i*t/(i-t),o&&s.multiplyToRef(jl,s),s.markAsUpdated(),s}static GetFinalMatrix(e,t,i,s,n,o){const a=e.width,l=e.height,u=F.FromValues(a/2,0,0,0,0,-l/2,0,0,0,0,o-n,0,e.x+a/2,l/2+e.y,n,1),d=new t.constructor;return t.multiplyToRef(i,d),d.multiplyToRef(s,d),d.multiplyToRef(u,d)}static GetAsMatrix2x2(e){const t=e.m,i=[t[0],t[1],t[4],t[5]];return Ds.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(e){const t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return Ds.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(e){const t=new e.constructor;return F.TransposeToRef(e,t),t}static TransposeToRef(e,t){const i=t._m,s=e.m;return i[0]=s[0],i[1]=s[4],i[2]=s[8],i[3]=s[12],i[4]=s[1],i[5]=s[5],i[6]=s[9],i[7]=s[13],i[8]=s[2],i[9]=s[6],i[10]=s[10],i[11]=s[14],i[12]=s[3],i[13]=s[7],i[14]=s[11],i[15]=s[15],t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(e){const t=new F;return F.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();const i=e.normal.x,s=e.normal.y,n=e.normal.z,o=-2*i,a=-2*s,l=-2*n;return F.FromValuesToRef(o*i+1,a*i,l*i,0,o*s,a*s+1,l*s,0,o*n,a*n,l*n+1,0,o*e.d,a*e.d,l*e.d,1,t),t}static FromXYZAxesToRef(e,t,i,s){return F.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,s),s}static FromQuaternionToRef(e,t){const i=e._x*e._x,s=e._y*e._y,n=e._z*e._z,o=e._x*e._y,a=e._z*e._w,l=e._z*e._x,c=e._y*e._w,h=e._y*e._z,u=e._x*e._w;return t._m[0]=1-2*(s+n),t._m[1]=2*(o+a),t._m[2]=2*(l-c),t._m[3]=0,t._m[4]=2*(o-a),t._m[5]=1-2*(n+i),t._m[6]=2*(h+u),t._m[7]=0,t._m[8]=2*(l+c),t._m[9]=2*(h-u),t._m[10]=1-2*(s+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}}F._UpdateFlagSeed=0,F._IdentityReadOnly=F.Identity();class Ue{}Ue.Vector3=is.BuildTuple(11,v.Zero),Ue.Matrix=is.BuildTuple(2,F.Identity),Ue.Quaternion=is.BuildTuple(3,Z.Zero);class L{}L.Vector2=is.BuildTuple(3,de.Zero),L.Vector3=is.BuildTuple(13,v.Zero),L.Vector4=is.BuildTuple(3,vt.Zero),L.Quaternion=is.BuildTuple(2,Z.Zero),L.Matrix=is.BuildTuple(8,F.Identity),le("BABYLON.Vector2",de),le("BABYLON.Vector3",v),le("BABYLON.Vector4",vt),le("BABYLON.Matrix",F);const jl=F.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);function Nu(r){return Math.pow(r,2.2)}function Fu(r){return r<=.04045?.0773993808*r:Math.pow(.947867299*(r+.055),2.4)}function Lu(r){return Math.pow(r,Jf)}function Bu(r){return r<=.0031308?12.92*r:1.055*Math.pow(r,.41666)-.055}class re{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=255*this.r|0;return e=397*e^(255*this.g|0),e=397*e^(255*this.b|0),e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return re.FromArrayToRef(e,t,this),this}toColor4(e=1){return new Te(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return.3*this.r+.59*this.g+.11*this.b}multiply(e){return new re(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}scale(e){return new re(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,this}clampToRef(e=0,t=1,i){return i.r=oe.Clamp(this.r,e,t),i.g=oe.Clamp(this.g,e,t),i.b=oe.Clamp(this.b,e,t),this}add(e){return new re(this.r+e.r,this.g+e.g,this.b+e.b)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,this}subtract(e){return new re(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,this}clone(){return new re(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}toHexString(){const e=Math.round(255*this.r),t=Math.round(255*this.g),i=Math.round(255*this.b);return"#"+oe.ToHex(e)+oe.ToHex(t)+oe.ToHex(i)}toHSV(){const e=new re;return this.toHSVToRef(e),e}toHSVToRef(e){const t=this.r,i=this.g,s=this.b,n=Math.max(t,i,s),o=Math.min(t,i,s);let a=0,l=0;const c=n,h=n-o;0!==n&&(l=h/n),n!=o&&(n==t?(a=(i-s)/h,i<s&&(a+=6)):n==i?a=(s-t)/h+2:n==s&&(a=(t-i)/h+4),a*=60),e.r=a,e.g=l,e.b=c}toLinearSpace(e=!1){const t=new re;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=Fu(this.r),e.g=Fu(this.g),e.b=Fu(this.b)):(e.r=Nu(this.r),e.g=Nu(this.g),e.b=Nu(this.b)),this}toGammaSpace(e=!1){const t=new re;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=Bu(this.r),e.g=Bu(this.g),e.b=Bu(this.b)):(e.r=Lu(this.r),e.g=Lu(this.g),e.b=Lu(this.b)),this}static HSVtoRGBToRef(e,t,i,s){const n=i*t,o=e/60,a=n*(1-Math.abs(o%2-1));let l=0,c=0,h=0;o>=0&&o<=1?(l=n,c=a):o>=1&&o<=2?(l=a,c=n):o>=2&&o<=3?(c=n,h=a):o>=3&&o<=4?(c=a,h=n):o>=4&&o<=5?(l=a,h=n):o>=5&&o<=6&&(l=n,h=a);const u=i-n;s.set(l+u,c+u,h+u)}static FromHSV(e,t,i){const s=new re(0,0,0);return re.HSVtoRGBToRef(e,t,i,s),s}static FromHexString(e){if("#"!==e.substring(0,1)||7!==e.length)return new re(0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),s=parseInt(e.substring(5,7),16);return re.FromInts(t,i,s)}static FromArray(e,t=0){return new re(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2]}static FromInts(e,t,i){return new re(e/255,t/255,i/255)}static Lerp(e,t,i){const s=new re(0,0,0);return re.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i}static Hermite(e,t,i,s,n){const o=n*n,a=n*o,l=2*a-3*o+1,c=-2*a+3*o,h=a-2*o+n,u=a-o;return new re(e.r*l+i.r*c+t.r*h+s.r*u,e.g*l+i.g*c+t.g*h+s.g*u,e.b*l+i.b*c+t.b*h+s.b*u)}static Hermite1stDerivative(e,t,i,s,n){const o=re.Black();return this.Hermite1stDerivativeToRef(e,t,i,s,n,o),o}static Hermite1stDerivativeToRef(e,t,i,s,n,o){const a=n*n;o.r=6*(a-n)*e.r+(3*a-4*n+1)*t.r+6*(-a+n)*i.r+(3*a-2*n)*s.r,o.g=6*(a-n)*e.g+(3*a-4*n+1)*t.g+6*(-a+n)*i.g+(3*a-2*n)*s.g,o.b=6*(a-n)*e.b+(3*a-4*n+1)*t.b+6*(-a+n)*i.b+(3*a-2*n)*s.b}static Red(){return new re(1,0,0)}static Green(){return new re(0,1,0)}static Blue(){return new re(0,0,1)}static Black(){return new re(0,0,0)}static get BlackReadOnly(){return re._BlackReadOnly}static White(){return new re(1,1,1)}static Purple(){return new re(.5,0,.5)}static Magenta(){return new re(1,0,1)}static Yellow(){return new re(1,1,0)}static Gray(){return new re(.5,.5,.5)}static Teal(){return new re(0,1,1)}static Random(){return new re(Math.random(),Math.random(),Math.random())}}re._BlackReadOnly=re.Black();class Te{constructor(e=0,t=0,i=0,s=1){this.r=e,this.g=t,this.b=i,this.a=s}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return Te.FromArrayToRef(e,t,this),this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new Te(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new Te(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,this}scale(e){return new Te(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,this}clampToRef(e=0,t=1,i){return i.r=oe.Clamp(this.r,e,t),i.g=oe.Clamp(this.g,e,t),i.b=oe.Clamp(this.b,e,t),i.a=oe.Clamp(this.a,e,t),this}multiply(e){return new Te(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=255*this.r|0;return e=397*e^(255*this.g|0),e=397*e^(255*this.b|0),e=397*e^(255*this.a|0),e}clone(){return new Te(this.r,this.g,this.b,this.a)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,s){return this.r=e,this.g=t,this.b=i,this.a=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}toHexString(e=!1){const t=Math.round(255*this.r),i=Math.round(255*this.g),s=Math.round(255*this.b);if(e)return"#"+oe.ToHex(t)+oe.ToHex(i)+oe.ToHex(s);const n=Math.round(255*this.a);return"#"+oe.ToHex(t)+oe.ToHex(i)+oe.ToHex(s)+oe.ToHex(n)}toLinearSpace(e=!1){const t=new Te;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=Fu(this.r),e.g=Fu(this.g),e.b=Fu(this.b)):(e.r=Nu(this.r),e.g=Nu(this.g),e.b=Nu(this.b)),e.a=this.a,this}toGammaSpace(e=!1){const t=new Te;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=Bu(this.r),e.g=Bu(this.g),e.b=Bu(this.b)):(e.r=Lu(this.r),e.g=Lu(this.g),e.b=Lu(this.b)),e.a=this.a,this}static FromHexString(e){if("#"!==e.substring(0,1)||9!==e.length&&7!==e.length)return new Te(0,0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),s=parseInt(e.substring(5,7),16),n=9===e.length?parseInt(e.substring(7,9),16):255;return Te.FromInts(t,i,s,n)}static Lerp(e,t,i){const s=new Te(0,0,0,0);return Te.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i,s.a=e.a+(t.a-e.a)*i}static Hermite(e,t,i,s,n){const o=n*n,a=n*o,l=2*a-3*o+1,c=-2*a+3*o,h=a-2*o+n,u=a-o;return new Te(e.r*l+i.r*c+t.r*h+s.r*u,e.g*l+i.g*c+t.g*h+s.g*u,e.b*l+i.b*c+t.b*h+s.b*u,e.a*l+i.a*c+t.a*h+s.a*u)}static Hermite1stDerivative(e,t,i,s,n){const o=new Te;return this.Hermite1stDerivativeToRef(e,t,i,s,n,o),o}static Hermite1stDerivativeToRef(e,t,i,s,n,o){const a=n*n;o.r=6*(a-n)*e.r+(3*a-4*n+1)*t.r+6*(-a+n)*i.r+(3*a-2*n)*s.r,o.g=6*(a-n)*e.g+(3*a-4*n+1)*t.g+6*(-a+n)*i.g+(3*a-2*n)*s.g,o.b=6*(a-n)*e.b+(3*a-4*n+1)*t.b+6*(-a+n)*i.b+(3*a-2*n)*s.b,o.a=6*(a-n)*e.a+(3*a-4*n+1)*t.a+6*(-a+n)*i.a+(3*a-2*n)*s.a}static FromColor3(e,t=1){return new Te(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new Te(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}static FromInts(e,t,i,s){return new Te(e/255,t/255,i/255,s/255)}static CheckColors4(e,t){if(e.length===3*t){const i=[];for(let s=0;s<e.length;s+=3){const n=s/3*4;i[n]=e[s],i[n+1]=e[s+1],i[n+2]=e[s+2],i[n+3]=1}return i}return e}}class wt{}wt.Color3=is.BuildArray(3,re.Black),wt.Color4=is.BuildArray(3,()=>new Te(0,0,0,0)),le("BABYLON.Color3",re),le("BABYLON.Color4",Te);let ai=(()=>{class r{constructor(t,i){this.triggerOptions=t,this.onBeforeExecuteObservable=new z,t.parameter?(this.trigger=t.trigger,this._triggerParameter=t.parameter):this.trigger=t.trigger?t.trigger:t,this._nextActiveAction=this,this._condition=i}_prepare(){}getTriggerParameter(){return this._triggerParameter}setTriggerParameter(t){this._triggerParameter=t}_evaluateConditionForCurrentFrame(){const t=this._condition;if(!t)return!0;const i=this._actionManager.getScene().getRenderId();return t._evaluationId!==i&&(t._evaluationId=i,t._currentResult=t.isValid()),t._currentResult}_executeCurrent(t){!this._evaluateConditionForCurrentFrame()||(this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(t),this.skipToNextActiveAction())}execute(t){}skipToNextActiveAction(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this}then(t){return this._child=t,t._actionManager=this._actionManager,t._prepare(),t}_getProperty(t){return this._actionManager._getProperty(t)}_getEffectiveTarget(t,i){return this._actionManager._getEffectiveTarget(t,i)}serialize(t){}_serialize(t,i){const s={type:1,children:[],name:t.name,properties:t.properties||[]};if(this._child&&this._child.serialize(s),this._condition){const n=this._condition.serialize();return n.children.push(s),i&&i.children.push(n),n}return i&&i.children.push(s),s}}return r._SerializeValueAsString=e=>"number"==typeof e?e.toString():"boolean"==typeof e?e?"true":"false":e instanceof de?e.x+", "+e.y:e instanceof v?e.x+", "+e.y+", "+e.z:e instanceof re?e.r+", "+e.g+", "+e.b:e instanceof Te?e.r+", "+e.g+", "+e.b+", "+e.a:e,r._GetTargetProperty=e=>({name:"target",targetType:e._isMesh?"MeshProperties":e._isLight?"LightProperties":e._isCamera?"CameraProperties":e._isMaterial?"MaterialProperties":"SceneProperties",value:e._isScene?"Scene":e.name}),r})();le("BABYLON.Action",ai);class gi{constructor(e,t,i,s,n,o){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=s,this.sourceEvent=n,this.additionalData=o}static CreateNew(e,t,i){const s=e.getScene();return new gi(e,s.pointerX,s.pointerY,s.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,s){return new gi(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,s)}static CreateNewFromScene(e,t){return new gi(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,s){return new gi(e,t.x,t.y,null,i,s)}}class ep{constructor(e){this._actionManager=e}isValid(){return!0}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(){}_serialize(e){return{type:2,children:[],name:e.name,properties:e.properties}}}let WF=(()=>{class r extends ep{static get IsEqual(){return r._IsEqual}static get IsDifferent(){return r._IsDifferent}static get IsGreater(){return r._IsGreater}static get IsLesser(){return r._IsLesser}constructor(t,i,s,n,o=r.IsEqual){super(t),this.propertyPath=s,this.value=n,this.operator=o,this._target=i,this._effectiveTarget=this._getEffectiveTarget(i,this.propertyPath),this._property=this._getProperty(this.propertyPath)}isValid(){switch(this.operator){case r.IsGreater:return this._effectiveTarget[this._property]>this.value;case r.IsLesser:return this._effectiveTarget[this._property]<this.value;case r.IsEqual:case r.IsDifferent:{let t;return t=this.value.equals?this.value.equals(this._effectiveTarget[this._property]):this.value===this._effectiveTarget[this._property],this.operator===r.IsEqual?t:!t}}return!1}serialize(){return this._serialize({name:"ValueCondition",properties:[ai._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:ai._SerializeValueAsString(this.value)},{name:"operator",value:r.GetOperatorName(this.operator)}]})}static GetOperatorName(t){switch(t){case r._IsEqual:return"IsEqual";case r._IsDifferent:return"IsDifferent";case r._IsGreater:return"IsGreater";case r._IsLesser:return"IsLesser";default:return""}}}return r._IsEqual=0,r._IsDifferent=1,r._IsGreater=2,r._IsLesser=3,r})();le("BABYLON.ValueCondition",WF),le("BABYLON.PredicateCondition",class qte extends ep{constructor(e,t){super(e),this.predicate=t}isValid(){return this.predicate()}}),le("BABYLON.StateCondition",class $te extends ep{constructor(e,t,i){super(e),this.value=i,this._target=t}isValid(){return this._target.state===this.value}serialize(){return this._serialize({name:"StateCondition",properties:[ai._GetTargetProperty(this._target),{name:"value",value:this.value}]})}});class V{static _CheckLimit(e,t){let i=V._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},V._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){var i;const s=V._LogLimitOutputs[e];if(!s||!V.MessageLimitReached)return;const n=this._Levels[t];s.current===s.limit&&V[n.name](V.MessageLimitReached.replace(/%LIMIT%/g,""+s.limit).replace(/%TYPE%/g,null!==(i=n.name)&&void 0!==i?i:""))}static _AddLogEntry(e){V._LogCache=e+V._LogCache,V.OnNewCacheEntry&&V.OnNewCacheEntry(e)}static _FormatMessage(e){const t=s=>s<10?"0"+s:""+s,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){if(void 0!==i&&!V._CheckLimit(t,i))return;const s=V._FormatMessage(t),n=this._Levels[e];n.logFunc&&n.logFunc("BJS - "+s),V._AddLogEntry(`<div style='color:${n.color}'>${s}</div><br>`),V._GenerateLimitMessage(t,e)}static get LogCache(){return V._LogCache}static ClearLogCache(){V._LogCache="",V._LogLimitOutputs={},V.errorsCount=0}static set LogLevels(e){V.Log=V._LogDisabled,V.Warn=V._LogDisabled,V.Error=V._LogDisabled,[V.MessageLogLevel,V.WarningLogLevel,V.ErrorLogLevel].forEach(t=>{(e&t)===t&&(V[this._Levels[t].name]=V._LogEnabled.bind(V,t))})}}V.NoneLogLevel=0,V.MessageLogLevel=1,V.WarningLogLevel=2,V.ErrorLogLevel=4,V.AllLogLevel=7,V.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.",V._LogCache="",V._LogLimitOutputs={},V._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}],V.errorsCount=0,V.Log=V._LogEnabled.bind(V,V.MessageLogLevel),V.Warn=V._LogEnabled.bind(V,V.WarningLogLevel),V.Error=V._LogEnabled.bind(V,V.ErrorLogLevel);class XF extends ai{constructor(e=0,t){super(e,t)}execute(){}serialize(e){return super._serialize({name:"DoNothingAction",properties:[]},e)}}class Ug extends ai{constructor(e,t,i){super(e,i),this.func=t}execute(e){this.func(e)}}class jF extends ai{constructor(e,t,i,s){super(e,s),this._target=t,this._parent=i}_prepare(){}execute(){if(this._target.parent===this._parent)return;const e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=v.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}serialize(e){return super._serialize({name:"SetParentAction",properties:[ai._GetTargetProperty(this._target),ai._GetTargetProperty(this._parent)]},e)}}le("BABYLON.SetParentAction",jF),le("BABYLON.ExecuteCodeAction",Ug),le("BABYLON.DoNothingAction",XF),le("BABYLON.StopAnimationAction",class tie extends ai{constructor(e,t,i){super(e,i),this._target=t}_prepare(){}execute(){this._actionManager.getScene().stopAnimation(this._target)}serialize(e){return super._serialize({name:"StopAnimationAction",properties:[ai._GetTargetProperty(this._target)]},e)}}),le("BABYLON.PlayAnimationAction",class eie extends ai{constructor(e,t,i,s,n,o){super(e,o),this.from=i,this.to=s,this.loop=n,this._target=t}_prepare(){}execute(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)}serialize(e){return super._serialize({name:"PlayAnimationAction",properties:[ai._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:ai._SerializeValueAsString(this.loop)||!1}]},e)}}),le("BABYLON.IncrementValueAction",class Jte extends ai{constructor(e,t,i,s,n){super(e,n),this.propertyPath=i,this.value=s,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),"number"!=typeof this._effectiveTarget[this._property]&&V.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"IncrementValueAction",properties:[ai._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:ai._SerializeValueAsString(this.value)}]},e)}}),le("BABYLON.SetValueAction",class Zte extends ai{constructor(e,t,i,s,n){super(e,n),this.propertyPath=i,this.value=s,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"SetValueAction",properties:[ai._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:ai._SerializeValueAsString(this.value)}]},e)}}),le("BABYLON.SetStateAction",class Qte extends ai{constructor(e,t,i,s){super(e,s),this.value=i,this._target=t}execute(){this._target.state=this.value}serialize(e){return super._serialize({name:"SetStateAction",properties:[ai._GetTargetProperty(this._target),{name:"value",value:this.value}]},e)}}),le("BABYLON.SetParentAction",jF),le("BABYLON.SwitchBooleanAction",class Kte extends ai{constructor(e,t,i,s){super(e,s),this.propertyPath=i,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]}serialize(e){return super._serialize({name:"SwitchBooleanAction",properties:[ai._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},e)}}),le("BABYLON.CombineAction",class iie extends ai{constructor(e,t,i,s=!0){super(e,i),this.children=t,this.enableChildrenConditions=s}_prepare(){for(let e=0;e<this.children.length;e++)this.children[e]._actionManager=this._actionManager,this.children[e]._prepare()}execute(e){for(const t of this.children)(!this.enableChildrenConditions||t._evaluateConditionForCurrentFrame())&&t.execute(e)}serialize(e){const t=super._serialize({name:"CombineAction",properties:[],combine:[]},e);for(let i=0;i<this.children.length;i++)t.combine.push(this.children[i].serialize(null));return t}});const YF=(r,e)=>!r||r.getClassName&&"Mesh"===r.getClassName()?null:r.getClassName&&"SubMesh"===r.getClassName()?r.clone(e):r.clone?r.clone():null;class Pr{static DeepCopy(e,t,i,s){const n=function sie(r){const e=[];do{Object.getOwnPropertyNames(r).forEach(function(t){-1===e.indexOf(t)&&e.push(t)})}while(r=Object.getPrototypeOf(r));return e}(e);for(const o of n){if("_"===o[0]&&(!s||-1===s.indexOf(o))||o.endsWith("Observable")||i&&-1!==i.indexOf(o))continue;const a=e[o],l=typeof a;if("function"!==l)try{if("object"===l)if(a instanceof Array){if(t[o]=[],a.length>0)if("object"==typeof a[0])for(let c=0;c<a.length;c++){const h=YF(a[c],t);-1===t[o].indexOf(h)&&t[o].push(h)}else t[o]=a.slice(0)}else t[o]=YF(a,t);else t[o]=a}catch(c){V.Warn(c.message)}}}}let Qc=(()=>{class r extends Ou{constructor(t){super(),(t=t||be.LastCreatedScene)&&(this._scene=t,t.actionManagers.push(this))}dispose(){const t=this._scene.actionManagers.indexOf(this);for(let i=0;i<this.actions.length;i++){const s=this.actions[i];r.Triggers[s.trigger]--,0===r.Triggers[s.trigger]&&delete r.Triggers[s.trigger]}t>-1&&this._scene.actionManagers.splice(t,1)}getScene(){return this._scene}hasSpecificTriggers(t){for(let i=0;i<this.actions.length;i++)if(t.indexOf(this.actions[i].trigger)>-1)return!0;return!1}hasSpecificTriggers2(t,i){for(let s=0;s<this.actions.length;s++){const n=this.actions[s];if(t==n.trigger||i==n.trigger)return!0}return!1}hasSpecificTrigger(t,i){for(let s=0;s<this.actions.length;s++){const n=this.actions[s];if(n.trigger===t){if(!i)return!0;if(i(n.getTriggerParameter()))return!0}}return!1}get hasPointerTriggers(){for(let t=0;t<this.actions.length;t++){const i=this.actions[t];if(i.trigger>=r.OnPickTrigger&&i.trigger<=r.OnPointerOutTrigger)return!0}return!1}get hasPickTriggers(){for(let t=0;t<this.actions.length;t++){const i=this.actions[t];if(i.trigger>=r.OnPickTrigger&&i.trigger<=r.OnPickUpTrigger)return!0}return!1}registerAction(t){return t.trigger===r.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(V.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(t),this.getScene()._registeredActions++,r.Triggers[t.trigger]?r.Triggers[t.trigger]++:r.Triggers[t.trigger]=1,t._actionManager=this,t._prepare(),t)}unregisterAction(t){const i=this.actions.indexOf(t);return-1!==i&&(this.actions.splice(i,1),r.Triggers[t.trigger]-=1,0===r.Triggers[t.trigger]&&delete r.Triggers[t.trigger],t._actionManager=null,this.getScene()._registeredActions--,!0)}processTrigger(t,i){for(let s=0;s<this.actions.length;s++){const n=this.actions[s];if(n.trigger===t){if(i&&(t===r.OnKeyUpTrigger||t===r.OnKeyDownTrigger)){const o=n.getTriggerParameter();if("function"==typeof o){if(!o(i))continue}else if(o&&o!==i.sourceEvent.keyCode){if(!o.toLowerCase)continue;const a=o.toLowerCase();if(a!==i.sourceEvent.key&&String.fromCharCode(i.sourceEvent.charCode?i.sourceEvent.charCode:i.sourceEvent.keyCode).toLowerCase()!==a)continue}}n._executeCurrent(i)}}}_getEffectiveTarget(t,i){const s=i.split(".");for(let n=0;n<s.length-1;n++)t=t[s[n]];return t}_getProperty(t){const i=t.split(".");return i[i.length-1]}serialize(t){const i={children:new Array,name:t,type:3,properties:new Array};for(let s=0;s<this.actions.length;s++){const n={type:0,children:new Array,name:r.GetTriggerName(this.actions[s].trigger),properties:new Array},o=this.actions[s].triggerOptions;if(o&&"number"!=typeof o)if(o.parameter instanceof Node)n.properties.push(ai._GetTargetProperty(o.parameter));else if("object"==typeof o.parameter){const a={};Pr.DeepCopy(o.parameter,a,["mesh"]),o.parameter&&o.parameter.mesh&&(a._meshId=o.parameter.mesh.id),n.properties.push({name:"parameter",targetType:null,value:a})}else n.properties.push({name:"parameter",targetType:null,value:o.parameter});this.actions[s].serialize(n),i.children.push(n)}return i}static Parse(t,i,s){const n=new r(s);null===i?s.actionManager=n:i.actionManager=n;const a=(c,h,u,d)=>{if(null===d){const m=parseFloat(h);return"true"===h||"false"===h?"true"===h:isNaN(m)?h:m}const f=d.split("."),p=h.split(",");for(let m=0;m<f.length;m++)u=u[f[m]];if("boolean"==typeof u)return"true"===p[0];if("string"==typeof u)return p[0];const _=new Array;for(let m=0;m<p.length;m++)_.push(parseFloat(p[m]));return u instanceof v?v.FromArray(_):u instanceof vt?vt.FromArray(_):u instanceof re?re.FromArray(_):u instanceof Te?Te.FromArray(_):parseFloat(p[0])},l=(c,h,u,d,f=null)=>{if(c.detached)return;const p=new Array;let _=null,m=null;const g=c.combine&&c.combine.length>0;if(p.push(2===c.type?n:h),g){const y=new Array;for(let T=0;T<c.combine.length;T++)l(c.combine[T],r.NothingTrigger,u,d,y);p.push(y)}else for(let y=0;y<c.properties.length;y++){let T=c.properties[y].value;const x=c.properties[y].name,S=c.properties[y].targetType;"target"===x?T=_="SceneProperties"===S?s:"MaterialProperties"===S?s.getMaterialByName(T):s.getNodeByName(T):"parent"===x?T=s.getNodeByName(T):"sound"===x?s.getSoundByName&&(T=s.getSoundByName(T)):"propertyPath"!==x?T=2===c.type&&"operator"===x?WF[T]:a(0,T,_,"value"===x?m:null):m=T,p.push(T)}p.push(null===f?u:null),"InterpolateValueAction"===c.name&&(p[p.length-1]=p[p.length-2],p[p.length-2]=u);let b=((c,h)=>{const u=hs("BABYLON."+c);return u&&new u(...h)})(c.name,p);if(b instanceof ep&&null!==u){const y=new XF(h,u);d?d.then(y):n.registerAction(y),d=y}null===f?b instanceof ep?(u=b,b=d):(u=null,d?d.then(b):n.registerAction(b)):f.push(b);for(let y=0;y<c.children.length;y++)l(c.children[y],h,u,b,null)};for(let c=0;c<t.children.length;c++){let h;const u=t.children[c];if(u.properties.length>0){const d=u.properties[0].value,f=null===u.properties[0].targetType?d:s.getMeshByName(d);f._meshId&&(f.mesh=s.getMeshById(f._meshId)),h={trigger:r[u.name],parameter:f}}else h=r[u.name];for(let d=0;d<u.children.length;d++)u.detached||l(u.children[d],h,null,null)}}static GetTriggerName(t){switch(t){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnDoublePickTrigger";case 7:return"OnPickUpTrigger";case 8:return"OnLongPressTrigger";case 9:return"OnPointerOverTrigger";case 10:return"OnPointerOutTrigger";case 11:return"OnEveryFrameTrigger";case 12:return"OnIntersectionEnterTrigger";case 13:return"OnIntersectionExitTrigger";case 14:return"OnKeyDownTrigger";case 15:return"OnKeyUpTrigger";case 16:return"OnPickOutTrigger";default:return""}}}return r.NothingTrigger=0,r.OnPickTrigger=1,r.OnLeftPickTrigger=2,r.OnRightPickTrigger=3,r.OnCenterPickTrigger=4,r.OnPickDownTrigger=5,r.OnDoublePickTrigger=6,r.OnPickUpTrigger=7,r.OnPickOutTrigger=16,r.OnLongPressTrigger=8,r.OnPointerOverTrigger=9,r.OnPointerOutTrigger=10,r.OnEveryFrameTrigger=11,r.OnIntersectionEnterTrigger=12,r.OnIntersectionExitTrigger=13,r.OnKeyDownTrigger=14,r.OnKeyUpTrigger=15,r})();le("BABYLON.PlaySoundAction",class rie extends ai{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){void 0!==this._sound&&this._sound.play()}serialize(e){return super._serialize({name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}),le("BABYLON.StopSoundAction",class nie extends ai{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){void 0!==this._sound&&this._sound.stop()}serialize(e){return super._serialize({name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}});class Zc{static Eval(e,t){return"true"===(e=e.match(/\([^()]*\)/g)?e.replace(/\([^()]*\)/g,i=>(i=i.slice(1,i.length-1),Zc._HandleParenthesisContent(i,t))):Zc._HandleParenthesisContent(e,t))||"false"!==e&&Zc.Eval(e,t)}static _HandleParenthesisContent(e,t){let i;t=t||(n=>"true"===n);const s=e.split("||");for(const n in s)if(Object.prototype.hasOwnProperty.call(s,n)){let o=Zc._SimplifyNegation(s[n].trim());const a=o.split("&&");if(a.length>1)for(let l=0;l<a.length;++l){const c=Zc._SimplifyNegation(a[l].trim());if(i="true"!==c&&"false"!==c?"!"===c[0]?!t(c.substring(1)):t(c):"true"===c,!i){o="false";break}}if(i||"true"===o){i=!0;break}i="true"!==o&&"false"!==o?"!"===o[0]?!t(o.substring(1)):t(o):"true"===o}return i?"true":"false"}static _SimplifyNegation(e){return"!true"===(e=(e=e.replace(/^[\s!]+/,t=>(t=t.replace(/[\s]/g,()=>"")).length%2?"!":"")).trim())?e="false":"!false"===e&&(e="true"),e}}class Et{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>Et.HasTags(e),e.addTags=t=>Et.AddTagsTo(e,t),e.removeTags=t=>Et.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>Et.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const t=e._tags;for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){const i=[];for(const s in e._tags)Object.prototype.hasOwnProperty.call(e._tags,s)&&!0===e._tags[s]&&i.push(s);return i.join(" ")}return e._tags}static AddTagsTo(e,t){t&&"string"==typeof t&&t.split(" ").forEach(function(s){Et._AddTagTo(e,s)})}static _AddTagTo(e,t){""!==(t=t.trim())&&"true"!==t&&"false"!==t&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(Et.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!Et.HasTags(e))return;const i=t.split(" ");for(const s in i)Et._RemoveTagFrom(e,i[s])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return void 0===t||(""===t?Et.HasTags(e):Zc.Eval(t,i=>Et.HasTags(e)&&e._tags[i]))}}function Ge(r){return`${r} needs to be imported before as it contains a side-effect required by your code.`}const kg={},Gg={},qF=function(r,e,t){const i=r();Et&&Et.HasTags(e)&&Et.AddTagsTo(i,Et.GetTags(e,!0));const s=tE(i);for(const n in s){const a=e[n],l=s[n].type;if(null!=a&&("uniqueId"!==n||Ce.AllowLoadingUniqueId))switch(l){case 0:case 6:case 11:i[n]=a;break;case 1:i[n]=t||a.isRenderTarget?a:a.clone();break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:i[n]=t?a:a.clone()}}return i};function tE(r){const e=r.getClassName();if(Gg[e])return Gg[e];Gg[e]={};const t=Gg[e];let i=r,s=e;for(;s;){const n=kg[s];for(const l in n)t[l]=n[l];let o,a=!1;do{if(o=Object.getPrototypeOf(i),!o.getClassName){a=!0;break}if(o.getClassName()!==s)break;i=o}while(o);if(a)break;s=o.getClassName(),i=o}return t}function Bn(r,e){return(t,i)=>{const s=function oie(r){const e=r.getClassName();return kg[e]||(kg[e]={}),kg[e]}(t);s[i]||(s[i]={type:r,sourceName:e})}}function ne(r,e=null){return function aie(r,e=null){return(t,i)=>{const s=e||"_"+i;Object.defineProperty(t,i,{get:function(){return this[s]},set:function(n){"function"==typeof this.equals&&this.equals(n)||this[s]!==n&&(this[s]=n,t[r].apply(this))},enumerable:!0,configurable:!0})}}(r,e)}function I(r){return Bn(0,r)}function ht(r){return Bn(1,r)}function us(r){return Bn(2,r)}function tp(r){return Bn(3,r)}function iE(r){return Bn(4,r)}function Ws(r){return Bn(5,r)}function ip(r){return Bn(6,r)}function sE(r){return Bn(8,r)}function $F(r){return Bn(9,r)}function KF(r){return Bn(12,r)}let Ce=(()=>{class r{static AppendSerializedAnimations(t,i){if(t.animations){i.animations=[];for(let s=0;s<t.animations.length;s++)i.animations.push(t.animations[s].serialize())}}static Serialize(t,i){i||(i={}),Et&&(i.tags=Et.GetTags(t));const s=tE(t);for(const n in s){const o=s[n],a=o.sourceName||n,l=o.type,c=t[n];if(null!=c&&("uniqueId"!==n||r.AllowLoadingUniqueId))switch(l){case 0:i[a]=c;break;case 1:case 3:case 7:case 9:i[a]=c.serialize();break;case 2:case 4:case 5:case 8:case 10:case 12:i[a]=c.asArray();break;case 6:case 11:i[a]=c.id}}return i}static ParseProperties(t,i,s,n){n||(n="");const o=tE(i);for(const a in o){const l=o[a],c=t[l.sourceName||a],h=l.type;if(null!=c&&("uniqueId"!==a||r.AllowLoadingUniqueId)){const u=i;switch(h){case 0:u[a]=c;break;case 1:s&&(u[a]=r._TextureParser(c,s,n));break;case 2:u[a]=re.FromArray(c);break;case 3:u[a]=r._FresnelParametersParser(c);break;case 4:u[a]=de.FromArray(c);break;case 5:u[a]=v.FromArray(c);break;case 6:s&&(u[a]=s.getLastMeshById(c));break;case 7:u[a]=r._ColorCurvesParser(c);break;case 8:u[a]=Te.FromArray(c);break;case 9:u[a]=r._ImageProcessingConfigurationParser(c);break;case 10:u[a]=Z.FromArray(c);break;case 11:s&&(u[a]=s.getCameraById(c));break;case 12:u[a]=F.FromArray(c)}}}}static Parse(t,i,s,n=null){const o=t();return Et&&Et.AddTagsTo(o,i.tags),r.ParseProperties(i,o,s,n),o}static Clone(t,i){return qF(t,i,!1)}static Instanciate(t,i){return qF(t,i,!0)}}return r.AllowLoadingUniqueId=!1,r._ImageProcessingConfigurationParser=e=>{throw Ge("ImageProcessingConfiguration")},r._FresnelParametersParser=e=>{throw Ge("FresnelParameters")},r._ColorCurvesParser=e=>{throw Ge("ColorCurves")},r._TextureParser=(e,t,i)=>{throw Ge("Texture")},r})();function Yl(r,e,t,i){const s=t.value;t.value=(...n)=>{let o=s;if(typeof _native<"u"&&_native[e]){const a=_native[e];o=i?(...l)=>i(...l)?a(...l):s(...l):a}return r[e]=o,o(...n)}}Yl.filter=function(r){return(e,t,i)=>Yl(e,t,i,r)};var sp=(()=>{return(r=sp||(sp={}))[r.NONE=0]="NONE",r[r.STEP=1]="STEP",sp;var r})();class Vu{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new Vu(this.name,this.from,this.to)}}function E(r,e,t,i){var o,s=arguments.length,n=s<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,t):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(r,e,t,i);else for(var a=r.length-1;a>=0;a--)(o=r[a])&&(n=(s<3?o(n):s>3?o(e,t,n):o(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n}class fie{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new z,this._onClonedObservable=new z}}class Rt{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,s){const n=this._NodeConstructors[e];return n?n(t,i,s):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return!!this._nodeDataStorage._doNotSerialize||!!this._parentNode&&this._parentNode.doNotSerialize}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const t=this._parentNode;if(this._parentNode&&null!=this._parentNode._children){const i=this._parentNode._children.indexOf(this);-1!==i&&this._parentNode._children.splice(i,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._parentNode&&(null==this._parentNode._children&&(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){-1===this._nodeDataStorage._sceneRootNodesIndex&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(-1!==this._nodeDataStorage._sceneRootNodesIndex){const e=this._scene.rootNodes;e[this._nodeDataStorage._sceneRootNodesIndex]=e[e.length-1],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null){this._isDirty=!1,this._nodeDataStorage=new fie,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new z,this._parentContainer=null,this.animations=new Array,this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=F.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new z,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||be.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return-1!==this._behaviors.indexOf(e)||(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(()=>{e.attach(this)}):e.attach(this),this._behaviors.push(e)),this}removeBehavior(e){const t=this._behaviors.indexOf(e);return-1===t||(this._behaviors[t].detach(),this._behaviors.splice(t,1)),this}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={},this._cache.parent=void 0}updateCache(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return!this._parentNode||!this._parentNode._isDirty&&this._parentUpdateId===this._parentNode._childUpdateId&&this._parentNode.isSynchronized()}isSynchronized(){return this._cache.parent!==this._parentNode?(this._cache.parent=this._parentNode,!1):!(this._parentNode&&!this.isSynchronizedWithParent())&&this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return!1===e?this._nodeDataStorage._isEnabled:!!this._nodeDataStorage._isEnabled&&this._nodeDataStorage._isParentEnabled}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=!this._parentNode||this._parentNode.isEnabled(),this._children&&this._children.forEach(e=>{e._syncParentEnabledState()})}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return!!this.parent&&(this.parent===e||this.parent.isDescendantOf(e))}_getDescendants(e,t=!1,i){if(this._children)for(let s=0;s<this._children.length;s++){const n=this._children[s];(!i||i(n))&&e.push(n),t||n._getDescendants(e,!1,i)}}getDescendants(e,t){const i=new Array;return this._getDescendants(i,e,t),i}getChildMeshes(e,t){const i=[];return this._getDescendants(i,e,s=>(!t||t(s))&&void 0!==s.cullingStrategy),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){if(e!==this._nodeDataStorage._isReady){if(!e)return void(this._nodeDataStorage._isReady=!1);this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){const i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=Rt._AnimationRangeFactory(e,t,i);for(let s=0,n=this.animations.length;s<n;s++)this.animations[s]&&this.animations[s].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,s=this.animations.length;i<s;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,s){const n=this.getAnimationRange(e);return n?this._scene.beginAnimation(this,n.from,n.to,t,i,s):null}serializeAnimationRanges(){const e=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const s={};s.name=t,s.from=i.from,s.to=i.to,e.push(s)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=F.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){const i=this.getDescendants(!0);for(const s of i)s.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const i of this._behaviors)i.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let s=0;s<t.ranges.length;s++){const n=t.ranges[s];e.createAnimationRange(n.name,n.from,n.to)}}getHierarchyBoundingVectors(e=!0,t=null){let i,s;this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);const n=this;if(n.getBoundingInfo&&n.subMeshes){const o=n.getBoundingInfo();i=o.boundingBox.minimumWorld.clone(),s=o.boundingBox.maximumWorld.clone()}else i=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new v(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const o=this.getDescendants(!1);for(const a of o){const l=a;if(l.computeWorldMatrix(!0),t&&!t(l)||!l.getBoundingInfo||0===l.getTotalVertices())continue;const h=l.getBoundingInfo().boundingBox,d=h.maximumWorld;v.CheckExtends(h.minimumWorld,i,s),v.CheckExtends(d,i,s)}}return{min:i,max:s}}}Rt._AnimationRangeFactory=(r,e,t)=>{throw Ge("AnimationRange")},Rt._NodeConstructors={},E([I()],Rt.prototype,"name",void 0),E([I()],Rt.prototype,"id",void 0),E([I()],Rt.prototype,"uniqueId",void 0),E([I()],Rt.prototype,"state",void 0),E([I()],Rt.prototype,"metadata",void 0);class Vn{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=0|this.width;return e=397*e^(0|this.height),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new Vn(this.width*e,this.height*t)}clone(){return new Vn(this.width,this.height)}equals(e){return!!e&&this.width===e.width&&this.height===e.height}get surface(){return this.width*this.height}static Zero(){return new Vn(0,0)}add(e){return new Vn(this.width+e.width,this.height+e.height)}subtract(e){return new Vn(this.width-e.width,this.height-e.height)}static Lerp(e,t,i){return new Vn(e.width+(t.width-e.width)*i,e.height+(t.height-e.height)*i)}}class Yi{constructor(){this._xhr=function pie(){return typeof _native<"u"&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}(),this._requestURL=""}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in Yi.CustomRequestHeaders){const t=Yi.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return Yi.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,i){this._xhr.addEventListener(e,t,i)}removeEventListener(e,t,i){this._xhr.removeEventListener(e,t,i)}abort(){this._xhr.abort()}send(e){Yi.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(const i of Yi.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;i(this._xhr,t)}return t=(t=t.replace("file:http:","http:")).replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}}Yi.CustomRequestHeaders={},Yi.CustomRequestModifiers=new Array,Yi.SkipRequestModificationForBabylonCDN=!0;class ${static _PrepareAnimation(e,t,i,s,n,o,a,l){let c;if(!isNaN(parseFloat(n))&&isFinite(n)?c=$.ANIMATIONTYPE_FLOAT:n instanceof Z?c=$.ANIMATIONTYPE_QUATERNION:n instanceof v?c=$.ANIMATIONTYPE_VECTOR3:n instanceof de?c=$.ANIMATIONTYPE_VECTOR2:n instanceof re?c=$.ANIMATIONTYPE_COLOR3:n instanceof Te?c=$.ANIMATIONTYPE_COLOR4:n instanceof Vn&&(c=$.ANIMATIONTYPE_SIZE),null==c)return null;const h=new $(e,t,i,c,a);return h.setKeys([{frame:0,value:n},{frame:s,value:o}]),void 0!==l&&h.setEasingFunction(l),h}static CreateAnimation(e,t,i,s){const n=new $(e+"Animation",e,i,t,$.ANIMATIONLOOPMODE_CONSTANT);return n.setEasingFunction(s),n}static CreateAndStartAnimation(e,t,i,s,n,o,a,l,c,h,u){const d=$._PrepareAnimation(e,i,s,n,o,a,l,c);return d&&(t.getScene&&(u=t.getScene()),u)?u.beginDirectAnimation(t,[d],0,n,1===d.loopMode,1,h):null}static CreateAndStartHierarchyAnimation(e,t,i,s,n,o,a,l,c,h,u){const d=$._PrepareAnimation(e,s,n,o,a,l,c,h);return d?t.getScene().beginDirectHierarchyAnimation(t,i,[d],0,o,1===d.loopMode,1,u):null}static CreateMergeAndStartAnimation(e,t,i,s,n,o,a,l,c,h){const u=$._PrepareAnimation(e,i,s,n,o,a,l,c);return u?(t.animations.push(u),t.getScene().beginAnimation(t,0,n,1===u.loopMode,1,h)):null}static MakeAnimationAdditive(e,t=0,i,s=!1,n){let o=e;if(s&&(o=e.clone(),o.name=n||o.name),!o._keys.length)return o;t=t>=0?t:0;let a=0;const l=o._keys[0];let c=o._keys.length-1;const h=o._keys[c],u={referenceValue:l.value,referencePosition:L.Vector3[0],referenceQuaternion:L.Quaternion[0],referenceScaling:L.Vector3[1],keyPosition:L.Vector3[2],keyQuaternion:L.Quaternion[1],keyScaling:L.Vector3[3]};let d=!1,f=l.frame,p=h.frame;if(i){const b=o.getRange(i);b&&(f=b.from,p=b.to)}let _=l.frame===f,m=h.frame===p;if(1===o._keys.length){const b=o._getKeyValue(o._keys[0]);u.referenceValue=b.clone?b.clone():b,d=!0}else if(t<=l.frame){const b=o._getKeyValue(l.value);u.referenceValue=b.clone?b.clone():b,d=!0}else if(t>=h.frame){const b=o._getKeyValue(h.value);u.referenceValue=b.clone?b.clone():b,d=!0}let g=0;for(;!d||!_||!m&&g<o._keys.length-1;){const b=o._keys[g],y=o._keys[g+1];if(!d&&t>=b.frame&&t<=y.frame){let T;T=t===b.frame?o._getKeyValue(b.value):t===y.frame?o._getKeyValue(y.value):o._interpolate(t,{key:g,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT}),u.referenceValue=T.clone?T.clone():T,d=!0}if(!_&&f>=b.frame&&f<=y.frame){if(f===b.frame)a=g;else if(f===y.frame)a=g+1;else{const x=o._interpolate(f,{key:g,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT}),S={frame:f,value:x.clone?x.clone():x};o._keys.splice(g+1,0,S),a=g+1}_=!0}if(!m&&p>=b.frame&&p<=y.frame){if(p===b.frame)c=g;else if(p===y.frame)c=g+1;else{const x=o._interpolate(p,{key:g,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT}),S={frame:p,value:x.clone?x.clone():x};o._keys.splice(g+1,0,S),c=g+1}m=!0}g++}for(o.dataType===$.ANIMATIONTYPE_QUATERNION?u.referenceValue.normalize().conjugateInPlace():o.dataType===$.ANIMATIONTYPE_MATRIX&&(u.referenceValue.decompose(u.referenceScaling,u.referenceQuaternion,u.referencePosition),u.referenceQuaternion.normalize().conjugateInPlace()),g=a;g<=c;g++){const b=o._keys[g];if(!g||o.dataType===$.ANIMATIONTYPE_FLOAT||b.value!==l.value)switch(o.dataType){case $.ANIMATIONTYPE_MATRIX:b.value.decompose(u.keyScaling,u.keyQuaternion,u.keyPosition),u.keyPosition.subtractInPlace(u.referencePosition),u.keyScaling.divideInPlace(u.referenceScaling),u.referenceQuaternion.multiplyToRef(u.keyQuaternion,u.keyQuaternion),F.ComposeToRef(u.keyScaling,u.keyQuaternion,u.keyPosition,b.value);break;case $.ANIMATIONTYPE_QUATERNION:u.referenceValue.multiplyToRef(b.value,b.value);break;case $.ANIMATIONTYPE_VECTOR2:case $.ANIMATIONTYPE_VECTOR3:case $.ANIMATIONTYPE_COLOR3:case $.ANIMATIONTYPE_COLOR4:b.value.subtractToRef(u.referenceValue,b.value);break;case $.ANIMATIONTYPE_SIZE:b.value.width-=u.referenceValue.width,b.value.height-=u.referenceValue.height;break;default:b.value-=u.referenceValue}}return o}static TransitionTo(e,t,i,s,n,o,a,l=null){if(a<=0)return i[e]=t,l&&l(),null;const c=n*(a/1e3);o.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:c,value:t}]),i.animations||(i.animations=[]),i.animations.push(o);const h=s.beginAnimation(i,0,c,!1);return h.onAnimationEnd=l,h}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,t,i,s,n,o){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=s,this.loopMode=n,this.enableBlending=o,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=s,this.loopMode=void 0===n?$.ANIMATIONLOOPMODE_CYCLE:n,this.uniqueId=$._UniqueIdGenerator++}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let i=!0;for(const s in this._ranges)i&&(t+=", ",i=!1),t+=s;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort((t,i)=>t.frame-i.frame)}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new Vu(e,t,i))}deleteRange(e,t=!0){const i=this._ranges[e];if(i){if(t){const s=i.from,n=i.to;for(let o=this._keys.length-1;o>=0;o--)this._keys[o].frame>=s&&this._keys[o].frame<=n&&this._keys.splice(o,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return oe.Lerp(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,s,n){return oe.Hermite(e,t,i,s,n)}quaternionInterpolateFunction(e,t,i){return Z.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,s,n){return Z.Hermite(e,t,i,s,n).normalize()}vector3InterpolateFunction(e,t,i){return v.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,s,n){return v.Hermite(e,t,i,s,n)}vector2InterpolateFunction(e,t,i){return de.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,s,n){return de.Hermite(e,t,i,s,n)}sizeInterpolateFunction(e,t,i){return Vn.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return re.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,s,n){return re.Hermite(e,t,i,s,n)}color4InterpolateFunction(e,t,i){return Te.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,s,n){return Te.Hermite(e,t,i,s,n)}_getKeyValue(e){return"function"==typeof e?e():e}evaluate(e){return this._interpolate(e,{key:0,repeatCount:0,loopMode:$.ANIMATIONLOOPMODE_CONSTANT})}_interpolate(e,t){if(t.loopMode===$.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const i=this._keys,s=i.length;let n=t.key;for(;n>=0&&e<i[n].frame;)--n;for(;n+1<=s-1&&e>=i[n+1].frame;)++n;if(t.key=n,n<0)return this._getKeyValue(i[0].value);if(n+1>s-1)return this._getKeyValue(i[s-1].value);const o=i[n],a=i[n+1],l=this._getKeyValue(o.value),c=this._getKeyValue(a.value);if(o.interpolation===sp.STEP)return a.frame>e?l:c;const h=void 0!==o.outTangent&&void 0!==a.inTangent,u=a.frame-o.frame;let d=(e-o.frame)/u;const f=this.getEasingFunction();switch(null!==f&&(d=f.ease(d)),this.dataType){case $.ANIMATIONTYPE_FLOAT:{const p=h?this.floatInterpolateFunctionWithTangents(l,o.outTangent*u,c,a.inTangent*u,d):this.floatInterpolateFunction(l,c,d);switch(t.loopMode){case $.ANIMATIONLOOPMODE_CYCLE:case $.ANIMATIONLOOPMODE_CONSTANT:return p;case $.ANIMATIONLOOPMODE_RELATIVE:return t.offsetValue*t.repeatCount+p}break}case $.ANIMATIONTYPE_QUATERNION:{const p=h?this.quaternionInterpolateFunctionWithTangents(l,o.outTangent.scale(u),c,a.inTangent.scale(u),d):this.quaternionInterpolateFunction(l,c,d);switch(t.loopMode){case $.ANIMATIONLOOPMODE_CYCLE:case $.ANIMATIONLOOPMODE_CONSTANT:return p;case $.ANIMATIONLOOPMODE_RELATIVE:return p.addInPlace(t.offsetValue.scale(t.repeatCount))}return p}case $.ANIMATIONTYPE_VECTOR3:{const p=h?this.vector3InterpolateFunctionWithTangents(l,o.outTangent.scale(u),c,a.inTangent.scale(u),d):this.vector3InterpolateFunction(l,c,d);switch(t.loopMode){case $.ANIMATIONLOOPMODE_CYCLE:case $.ANIMATIONLOOPMODE_CONSTANT:return p;case $.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case $.ANIMATIONTYPE_VECTOR2:{const p=h?this.vector2InterpolateFunctionWithTangents(l,o.outTangent.scale(u),c,a.inTangent.scale(u),d):this.vector2InterpolateFunction(l,c,d);switch(t.loopMode){case $.ANIMATIONLOOPMODE_CYCLE:case $.ANIMATIONLOOPMODE_CONSTANT:return p;case $.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case $.ANIMATIONTYPE_SIZE:switch(t.loopMode){case $.ANIMATIONLOOPMODE_CYCLE:case $.ANIMATIONLOOPMODE_CONSTANT:return this.sizeInterpolateFunction(l,c,d);case $.ANIMATIONLOOPMODE_RELATIVE:return this.sizeInterpolateFunction(l,c,d).add(t.offsetValue.scale(t.repeatCount))}break;case $.ANIMATIONTYPE_COLOR3:{const p=h?this.color3InterpolateFunctionWithTangents(l,o.outTangent.scale(u),c,a.inTangent.scale(u),d):this.color3InterpolateFunction(l,c,d);switch(t.loopMode){case $.ANIMATIONLOOPMODE_CYCLE:case $.ANIMATIONLOOPMODE_CONSTANT:return p;case $.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case $.ANIMATIONTYPE_COLOR4:{const p=h?this.color4InterpolateFunctionWithTangents(l,o.outTangent.scale(u),c,a.inTangent.scale(u),d):this.color4InterpolateFunction(l,c,d);switch(t.loopMode){case $.ANIMATIONLOOPMODE_CYCLE:case $.ANIMATIONLOOPMODE_CONSTANT:return p;case $.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case $.ANIMATIONTYPE_MATRIX:switch(t.loopMode){case $.ANIMATIONLOOPMODE_CYCLE:case $.ANIMATIONLOOPMODE_CONSTANT:return $.AllowMatricesInterpolation?this.matrixInterpolateFunction(l,c,d,t.workValue):l;case $.ANIMATIONLOOPMODE_RELATIVE:return l}}return 0}matrixInterpolateFunction(e,t,i,s){return $.AllowMatrixDecomposeForInterpolation?s?(F.DecomposeLerpToRef(e,t,i,s),s):F.DecomposeLerp(e,t,i):s?(F.LerpToRef(e,t,i,s),s):F.Lerp(e,t,i)}clone(){const e=new $(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const i=this._ranges[t];!i||(e._ranges[t]=i.clone())}}return e}setKeys(e){this._keys=e.slice(0)}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const t=this.dataType;e.keys=[];const i=this.getKeys();for(let s=0;s<i.length;s++){const n=i[s],o={};switch(o.frame=n.frame,t){case $.ANIMATIONTYPE_FLOAT:o.values=[n.value],void 0!==n.inTangent&&o.values.push(n.inTangent),void 0!==n.outTangent&&(void 0===n.inTangent&&o.values.push(void 0),o.values.push(n.outTangent)),void 0!==n.interpolation&&(void 0===n.inTangent&&o.values.push(void 0),void 0===n.outTangent&&o.values.push(void 0),o.values.push(n.interpolation));break;case $.ANIMATIONTYPE_QUATERNION:case $.ANIMATIONTYPE_MATRIX:case $.ANIMATIONTYPE_VECTOR3:case $.ANIMATIONTYPE_COLOR3:case $.ANIMATIONTYPE_COLOR4:o.values=n.value.asArray(),null!=n.inTangent&&o.values.push(n.inTangent.asArray()),null!=n.outTangent&&(void 0===n.inTangent&&o.values.push(void 0),o.values.push(n.outTangent.asArray())),void 0!==n.interpolation&&(void 0===n.inTangent&&o.values.push(void 0),void 0===n.outTangent&&o.values.push(void 0),o.values.push(n.interpolation))}e.keys.push(o)}e.ranges=[];for(const s in this._ranges){const n=this._ranges[s];if(!n)continue;const o={};o.name=s,o.from=n.from,o.to=n.to,e.ranges.push(o)}return e}static _UniversalLerp(e,t,i){const s=e.constructor;return s.Lerp?s.Lerp(e,t,i):s.Slerp?s.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){const t=new $(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,s=[];let n,o;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),o=0;o<e.keys.length;o++){const a=e.keys[o];let l,c,h;switch(i){case $.ANIMATIONTYPE_FLOAT:n=a.values[0],a.values.length>=2&&(l=a.values[1]),a.values.length>=3&&(c=a.values[2]),a.values.length>=4&&(h=a.values[3]);break;case $.ANIMATIONTYPE_QUATERNION:if(n=Z.FromArray(a.values),a.values.length>=8){const d=Z.FromArray(a.values.slice(4,8));d.equals(Z.Zero())||(l=d)}if(a.values.length>=12){const d=Z.FromArray(a.values.slice(8,12));d.equals(Z.Zero())||(c=d)}a.values.length>=13&&(h=a.values[12]);break;case $.ANIMATIONTYPE_MATRIX:n=F.FromArray(a.values),a.values.length>=17&&(h=a.values[16]);break;case $.ANIMATIONTYPE_COLOR3:n=re.FromArray(a.values),a.values[3]&&(l=re.FromArray(a.values[3])),a.values[4]&&(c=re.FromArray(a.values[4])),a.values[5]&&(h=a.values[5]);break;case $.ANIMATIONTYPE_COLOR4:n=Te.FromArray(a.values),a.values[4]&&(l=Te.FromArray(a.values[4])),a.values[5]&&(c=Te.FromArray(a.values[5])),a.values[6]&&(h=Te.FromArray(a.values[6]));break;default:n=v.FromArray(a.values),a.values[3]&&(l=v.FromArray(a.values[3])),a.values[4]&&(c=v.FromArray(a.values[4])),a.values[5]&&(h=a.values[5])}const u={};u.frame=a.frame,u.value=n,null!=l&&(u.inTangent=l),null!=c&&(u.outTangent=c),null!=h&&(u.interpolation=h),s.push(u)}if(t.setKeys(s),e.ranges)for(o=0;o<e.ranges.length;o++)n=e.ranges[o],t.createRange(n.name,n.from,n.to);return t}static AppendSerializedAnimations(e,t){Ce.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise((i,s)=>{const n=new Yi;n.addEventListener("readystatechange",()=>{if(4==n.readyState)if(200==n.status){let o=JSON.parse(n.responseText);if(o.animations&&(o=o.animations),o.length){const a=new Array;for(const l of o)a.push(this.Parse(l));i(a)}else{const a=this.Parse(o);e&&(a.name=e),i(a)}}else s("Unable to load the animation")}),n.open("GET",t),n.send()})}static ParseFromSnippetAsync(e){return new Promise((t,i)=>{const s=new Yi;s.addEventListener("readystatechange",()=>{if(4==s.readyState)if(200==s.status){const n=JSON.parse(JSON.parse(s.responseText).jsonPayload);if(n.animations){const o=JSON.parse(n.animations),a=new Array;for(const l of o.animations){const c=this.Parse(l);c.snippetId=e,a.push(c)}t(a)}else{const o=JSON.parse(n.animation),a=this.Parse(o);a.snippetId=e,t(a)}}else i("Unable to load the snippet "+e)}),s.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),s.send()})}}$._UniqueIdGenerator=0,$.AllowMatricesInterpolation=!1,$.AllowMatrixDecomposeForInterpolation=!0,$.SnippetUrl="https://snippet.babylonjs.com",$.ANIMATIONTYPE_FLOAT=0,$.ANIMATIONTYPE_VECTOR3=1,$.ANIMATIONTYPE_QUATERNION=2,$.ANIMATIONTYPE_MATRIX=3,$.ANIMATIONTYPE_COLOR3=4,$.ANIMATIONTYPE_COLOR4=7,$.ANIMATIONTYPE_VECTOR2=5,$.ANIMATIONTYPE_SIZE=6,$.ANIMATIONLOOPMODE_RELATIVE=0,$.ANIMATIONLOOPMODE_CYCLE=1,$.ANIMATIONLOOPMODE_CONSTANT=2,$.CreateFromSnippetAsync=$.ParseFromSnippetAsync,le("BABYLON.Animation",$),Rt._AnimationRangeFactory=(r,e,t)=>new Vu(r,e,t),le("BABYLON.InterpolateValueAction",class _ie extends ai{constructor(e,t,i,s,n=1e3,o,a,l){super(e,o),this.duration=1e3,this.onInterpolationDoneObservable=new z,this.propertyPath=i,this.value=s,this.duration=n,this.stopOtherAnimations=a,this.onInterpolationDone=l,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){const e=this._actionManager.getScene(),t=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}];let i;if("number"==typeof this.value)i=$.ANIMATIONTYPE_FLOAT;else if(this.value instanceof re)i=$.ANIMATIONTYPE_COLOR3;else if(this.value instanceof v)i=$.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof F)i=$.ANIMATIONTYPE_MATRIX;else{if(!(this.value instanceof Z))return void V.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");i=$.ANIMATIONTYPE_QUATERNION}const s=new $("InterpolateValueAction",this._property,1e3/this.duration*100,i,$.ANIMATIONLOOPMODE_CONSTANT);s.setKeys(t),this.stopOtherAnimations&&e.stopAnimation(this._effectiveTarget),e.beginDirectAnimation(this._effectiveTarget,[s],0,100,!1,1,()=>{this.onInterpolationDoneObservable.notifyObservers(this),this.onInterpolationDone&&this.onInterpolationDone()})}serialize(e){return super._serialize({name:"InterpolateValueAction",properties:[ai._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:ai._SerializeValueAsString(this.value)},{name:"duration",value:ai._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:ai._SerializeValueAsString(this.stopOtherAnimations)||!1}]},e)}});const mie=Object.freeze(new Z(0,0,0,0)),gie=Object.freeze(v.Zero()),vie=Object.freeze(de.Zero()),bie=Object.freeze(Vn.Zero()),yie=Object.freeze(re.Black());class xie{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,s){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._ratioOffset=0,this._previousDelay=0,this._previousRatio=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=s,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===$.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=F.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,0!==this._minFrame&&this._keys.splice(0,0,{frame:0,value:this._minValue}),this._target instanceof Array){let o=0;for(const a of this._target)this._preparePath(a,o),this._getOriginalValues(o),o++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const n=t.getEvents();n&&n.length>0&&n.forEach(o=>{this._events.push(o._clone())}),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){const i=this._animation.targetPropertyPath;if(i.length>1){let s=e[i[0]];for(let n=1;n<i.length-1;n++)s=s[i[n]];this._targetPath=i[i.length-1],this._activeTargets[t]=s}else this._targetPath=i[0],this._activeTargets[t]=e}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let t=0;for(const i of this._target)void 0!==this._originalValue[t]&&this._setValue(i,this._activeTargets[t],this._originalValue[t],-1,t),t++}else void 0!==this._originalValue[0]&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let t=0;t<this._events.length;t++)this._events[t].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray)for(let i=0;i<this._target.length;i++)this._setValue(this._target[i],this._activeTargets[i],e,t,i);else this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const i=this._activeTargets[e];t=i.getRestPose&&"_matrix"===this._targetPath?i.getRestPose():i[this._targetPath],this._originalValue[e]=t&&t.clone?t.clone():t}_setValue(e,t,i,s,n){if(this._currentActiveTarget=t,this._weight=s,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const a=t[this._targetPath];this._originalBlendValue=a.clone?a.clone():a}this._originalBlendValue.m?$.AllowMatrixDecomposeForInterpolation?this._currentValue?F.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=F.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?F.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=F.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=$._UniversalLerp(this._originalBlendValue,i,this._blendingFactor),this._blendingFactor+=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:this._currentValue=i?.clone?i.clone():i;-1!==s?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[n]):t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e){const t=this._animation.getKeys();e<t[0].frame?e=t[0].frame:e>t[t.length-1].frame&&(e=t[t.length-1].frame);const i=this._events;if(i.length)for(let n=0;n<i.length;n++)i[n].onlyOnce||(i[n].isDone=i[n].frame<e);this._currentFrame=e;const s=this._animation._interpolate(e,this._animationState);this.setValue(s,-1)}_prepareForSpeedRatioChange(e){this._ratioOffset=this._previousRatio-this._previousDelay*(this._animation.framePerSecond*e)/1e3}animate(e,t,i,s,n,o=-1){const a=this._animation,l=a.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let c=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);const h=i-t;let u;const d=e*(a.framePerSecond*n)/1e3+this._ratioOffset;let p,f=0;if(this._previousDelay=e,this._previousRatio=d,!s&&i>=t&&d>=h)c=!1,f=a._getKeyValue(this._maxValue);else if(!s&&t>=i&&d<=h)c=!1,f=a._getKeyValue(this._minValue);else if(this._animationState.loopMode!==$.ANIMATIONLOOPMODE_CYCLE){const g=i.toString()+t.toString();if(!this._offsetsCache[g]){this._animationState.repeatCount=0,this._animationState.loopMode=$.ANIMATIONLOOPMODE_CYCLE;const b=a._interpolate(t,this._animationState),y=a._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),a.dataType){case $.ANIMATIONTYPE_FLOAT:this._offsetsCache[g]=y-b;break;case $.ANIMATIONTYPE_QUATERNION:case $.ANIMATIONTYPE_VECTOR3:case $.ANIMATIONTYPE_VECTOR2:case $.ANIMATIONTYPE_SIZE:case $.ANIMATIONTYPE_COLOR3:this._offsetsCache[g]=y.subtract(b)}this._highLimitsCache[g]=y}f=this._highLimitsCache[g],u=this._offsetsCache[g]}if(void 0===u)switch(a.dataType){case $.ANIMATIONTYPE_FLOAT:u=0;break;case $.ANIMATIONTYPE_QUATERNION:u=mie;break;case $.ANIMATIONTYPE_VECTOR3:u=gie;break;case $.ANIMATIONTYPE_VECTOR2:u=vie;break;case $.ANIMATIONTYPE_SIZE:u=bie;break;case $.ANIMATIONTYPE_COLOR3:u=yie}if(this._host&&this._host.syncRoot){const g=this._host.syncRoot;p=t+(g.masterFrame-g.fromFrame)/(g.toFrame-g.fromFrame)*(i-t)}else p=d>0&&t>i||d<0&&t<i?c&&0!==h?i+d%h:t:c&&0!==h?t+d%h:i;const _=this._events;if(n>0&&this.currentFrame>p||n<0&&this.currentFrame<p){this._onLoop();for(let g=0;g<_.length;g++)_[g].onlyOnce||(_[g].isDone=!1);this._animationState.key=n>0?0:a.getKeys().length-1}this._currentFrame=p,this._animationState.repeatCount=0===h?0:d/h>>0,this._animationState.highLimitValue=f,this._animationState.offsetValue=u;const m=a._interpolate(p,this._animationState);if(this.setValue(m,o),_.length)for(let g=0;g<_.length;g++)if(h>0&&p>=_[g].frame&&_[g].frame>=t||h<0&&p<=_[g].frame&&_[g].frame<=t){const b=_[g];b.isDone||(b.onlyOnce&&(_.splice(g,1),g--),b.isDone=!0,b.action(p))}return c||(this._stopped=!0),c}}function qi(){return typeof window<"u"}function nE(){return typeof navigator<"u"}function rp(){return typeof document<"u"}function Hg(r){let e="",t=r.firstChild;for(;t;)3===t.nodeType&&(e+=t.textContent),t=t.nextSibling;return e}const oE={IsWindowObjectExist:qi,IsNavigatorAvailable:nE,IsDocumentAvailable:rp,GetDOMTextContent:Hg};class ir{static get Now(){return oE.IsWindowObjectExist()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}let Wg=(()=>{class r{}return r.FilesToLoad={},r})();class Uu extends Error{}Uu._setPrototypeOf=Object.setPrototypeOf||((r,e)=>(r.__proto__=e,r));class No extends Uu{constructor(e,t,i){super(e),this.errorCode=t,this.innerError=i,this.name="RuntimeError",Uu._setPrototypeOf(this,No.prototype)}}const aE=r=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let i,s,n,o,a,l,c,t="",h=0;const u=ArrayBuffer.isView(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):new Uint8Array(r);for(;h<u.length;)i=u[h++],s=h<u.length?u[h++]:Number.NaN,n=h<u.length?u[h++]:Number.NaN,o=i>>2,a=(3&i)<<4|s>>4,l=(15&s)<<2|n>>6,c=63&n,isNaN(s)?l=c=64:isNaN(n)&&(c=64),t+=e.charAt(o)+e.charAt(a)+e.charAt(l)+e.charAt(c);return t},lE=r=>atob(r);class np{constructor(){this.children=[]}isValid(e){return!0}process(e,t){var i,s,n,o,a,l;let c="";if(this.line){let h=this.line;const u=t.processor;if(u){u.lineProcessor&&(h=u.lineProcessor(h,t.isFragment,t.processingContext));const d=null!==(s=null===(i=t.processor)||void 0===i?void 0:i.attributeKeywordName)&&void 0!==s?s:"attribute",f=t.isFragment&&(null===(n=t.processor)||void 0===n?void 0:n.varyingFragmentKeywordName)?null===(o=t.processor)||void 0===o?void 0:o.varyingFragmentKeywordName:!t.isFragment&&(null===(a=t.processor)||void 0===a?void 0:a.varyingVertexKeywordName)?null===(l=t.processor)||void 0===l?void 0:l.varyingVertexKeywordName:"varying";!t.isFragment&&u.attributeProcessor&&this.line.startsWith(d)?h=u.attributeProcessor(this.line,e,t.processingContext):u.varyingProcessor&&this.line.startsWith(f)?h=u.varyingProcessor(this.line,t.isFragment,e,t.processingContext):u.uniformProcessor&&u.uniformRegexp&&u.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(h=u.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):u.uniformBufferProcessor&&u.uniformBufferRegexp&&u.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(h=u.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):u.textureProcessor&&u.textureRegexp&&u.textureRegexp.test(this.line)?h=u.textureProcessor(this.line,t.isFragment,e,t.processingContext):(u.uniformProcessor||u.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?u.uniformProcessor&&(h=u.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):u.uniformBufferProcessor&&(h=u.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&-1!==this.line.indexOf("}")&&(t.lookForClosingBracketForUniformBuffer=!1,u.endOfUniformBufferProcessor&&(h=u.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}c+=h+"\r\n"}return this.children.forEach(h=>{c+=h.process(e,t)}),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),c}}class Rie{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if("#"===t[0]){this._lines.push(t);continue}if(t.trim().startsWith("//")){this._lines.push(t);continue}const i=t.split(";");for(let s=0;s<i.length;s++){let n=i[s];n=n.trim(),n&&this._lines.push(n+(s!==i.length-1?";":""))}}}}class cE extends np{process(e,t){for(let i=0;i<this.children.length;i++){const s=this.children[i];if(s.isValid(e))return s.process(e,t)}return""}}class Iie extends np{isValid(e){return this.testExpression.isTrue(e)}}let op=(()=>{class r{isTrue(t){return!0}static postfixToInfix(t){const i=[];for(const s of t)if(void 0===r._OperatorPriority[s])i.push(s);else{const n=i[i.length-1],o=i[i.length-2];i.length-=2,i.push(`(${o}${s}${n})`)}return i[i.length-1]}static infixToPostfix(t){const i=[];let s=-1;const n=()=>{h=h.trim(),""!==h&&(i.push(h),h="")},o=u=>{s<r._Stack.length-1&&(r._Stack[++s]=u)},a=()=>r._Stack[s],l=()=>-1===s?"!!INVALID EXPRESSION!!":r._Stack[s--];let c=0,h="";for(;c<t.length;){const u=t.charAt(c),d=c<t.length-1?t.substr(c,2):"";if("("===u)h="",o(u);else if(")"===u){for(n();-1!==s&&"("!==a();)i.push(l());l()}else if(r._OperatorPriority[d]>1){for(n();-1!==s&&r._OperatorPriority[a()]>=r._OperatorPriority[d];)i.push(l());o(d),c++}else h+=u;c++}for(n();-1!==s;)"("===a()?l():i.push(l());return i}}return r._OperatorPriority={")":0,"(":1,"||":2,"&&":3},r._Stack=["","","","","","","","","","","","","","","","","","","",""],r})();class Xg extends op{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=void 0!==e[this.define];return this.not&&(t=!t),t}}class Mie extends op{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class Pie extends op{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class Die extends op{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}isTrue(e){let t=e[this.define];void 0===t&&(t=this.define);let i=!1;const s=parseInt(t),n=parseInt(this.testValue);switch(this.operand){case">":i=s>n;break;case"<":i=s<n;break;case"<=":i=s<=n;break;case">=":i=s>=n;break;case"==":i=s===n}return i}}var ui=(()=>{return(r=ui||(ui={}))[r.GLSL=0]="GLSL",r[r.WGSL=1]="WGSL",ui;var r})();const wie=/defined\s*?\((.+?)\)/g,hE=/defined\s*?\[(.+?)\]/g,i1=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g;class ha{static Initialize(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)}static Process(e,t,i,s){var n;!(null===(n=t.processor)||void 0===n)&&n.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,o=>{t.processCodeAfterIncludes&&(o=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",o));const a=this._ProcessShaderConversion(o,t,s);i(a,o)})}static PreProcess(e,t,i,s){var n;!(null===(n=t.processor)||void 0===n)&&n.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,o=>{t.processCodeAfterIncludes&&(o=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",o));const a=this._ApplyPreProcessing(o,t,s);i(a,o)})}static Finalize(e,t,i){return i.processor&&i.processor.finalizeShaders?i.processor.finalizeShaders(e,t,i.processingContext):{vertexCode:e,fragmentCode:t}}static _ProcessPrecision(e,t){var i;if(null!==(i=t.processor)&&void 0!==i&&i.noPrecision)return e;const s=t.shouldUseHighPrecisionShader;return-1===e.indexOf("precision highp float")?e=s?"precision highp float;\n"+e:"precision mediump float;\n"+e:s||(e=e.replace("precision highp float","precision mediump float")),e}static _ExtractOperation(e){const i=/defined\((.+)\)/.exec(e);if(i&&i.length)return new Xg(i[1].trim(),"!"===e[0]);const s=["==",">=","<=","<",">"];let n="",o=0;for(n of s)if(o=e.indexOf(n),o>-1)break;if(-1===o)return new Xg(e);const a=e.substring(0,o).trim(),l=e.substring(o+n.length).trim();return new Die(a,n,l)}static _BuildSubExpression(e){e=e.replace(wie,"defined[$1]");const t=op.infixToPostfix(e),i=[];for(const n of t)if("||"!==n&&"&&"!==n)i.push(n);else if(i.length>=2){let o=i[i.length-1],a=i[i.length-2];i.length-=2;const l="&&"==n?new Pie:new Mie;"string"==typeof o&&(o=o.replace(hE,"defined($1)")),"string"==typeof a&&(a=a.replace(hE,"defined($1)")),l.leftOperand="string"==typeof a?this._ExtractOperation(a):a,l.rightOperand="string"==typeof o?this._ExtractOperation(o):o,i.push(l)}let s=i[i.length-1];return"string"==typeof s&&(s=s.replace(hE,"defined($1)")),"string"==typeof s?this._ExtractOperation(s):s}static _BuildExpression(e,t){const i=new Iie,s=e.substring(0,t);let n=e.substring(t);return n=n.substring(0,(n.indexOf("//")+1||n.length+1)-1).trim(),i.testExpression="#ifdef"===s?new Xg(n):"#ifndef"===s?new Xg(n,!0):this._BuildSubExpression(n),i}static _MoveCursorWithinIf(e,t,i){let s=e.currentLine;for(;this._MoveCursor(e,i);){s=e.currentLine;const n=s.substring(0,5).toLowerCase();if("#else"===n){const o=new np;return t.children.push(o),void this._MoveCursor(e,o)}if("#elif"===n){const o=this._BuildExpression(s,5);t.children.push(o),i=o}}}static _MoveCursor(e,t){for(;e.canRead;){e.lineIndex++;const i=e.currentLine,n=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/.exec(i);if(n&&n.length)switch(n[0]){case"#ifdef":{const a=new cE;t.children.push(a);const l=this._BuildExpression(i,6);a.children.push(l),this._MoveCursorWithinIf(e,a,l);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const a=new cE;t.children.push(a);const l=this._BuildExpression(i,7);a.children.push(l),this._MoveCursorWithinIf(e,a,l);break}case"#if":{const a=new cE,l=this._BuildExpression(i,3);t.children.push(a),a.children.push(l),this._MoveCursorWithinIf(e,a,l);break}}else{const o=new np;if(o.line=i,t.children.push(o),"#"===i[0]&&"d"===i[1]){const a=i.replace(";","").split(" ");o.additionalDefineKey=a[1],3===a.length&&(o.additionalDefineValue=a[2])}}}return!1}static _EvaluatePreProcessors(e,t,i){const s=new np,n=new Rie;return n.lineIndex=-1,n.lines=e.split("\n"),this._MoveCursor(n,s),s.process(t,i)}static _PreparePreProcessors(e,t){var i;const s=e.defines,n={};for(const o of s){const l=o.replace("#define","").replace(";","").trim().split(" ");n[l[0]]=l.length>1?l[1]:""}return(null===(i=e.processor)||void 0===i?void 0:i.shaderLanguage)===ui.GLSL&&(n.GL_ES="true"),n.__VERSION__=e.version,n[e.platformName]="true",t._getGlobalDefines(n),n}static _ProcessShaderConversion(e,t,i){let s=this._ProcessPrecision(e,t);if(!t.processor||t.processor.shaderLanguage===ui.GLSL&&-1!==s.indexOf("#version 3")&&(s=s.replace("#version 300 es",""),!t.processor.parseGLES3))return s;const n=t.defines,o=this._PreparePreProcessors(t,i);return t.processor.preProcessor&&(s=t.processor.preProcessor(s,n,t.isFragment,t.processingContext)),s=this._EvaluatePreProcessors(s,o,t),t.processor.postProcessor&&(s=t.processor.postProcessor(s,n,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(s=i.inlineShaderCode(s)),s}static _ApplyPreProcessing(e,t,i){var s,n;let o=e;const a=t.defines,l=this._PreparePreProcessors(t,i);return!(null===(s=t.processor)||void 0===s)&&s.preProcessor&&(o=t.processor.preProcessor(o,a,t.isFragment,t.processingContext)),o=this._EvaluatePreProcessors(o,l,t),!(null===(n=t.processor)||void 0===n)&&n.postProcessor&&(o=t.processor.postProcessor(o,a,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(o=i.inlineShaderCode(o)),o}static _ProcessIncludes(e,t,i){let s=i1.exec(e),n=new String(e),o=!1;for(;null!=s;){let a=s[1];if(-1!==a.indexOf("__decl__")&&(a=a.replace(/__decl__/,""),t.supportsUniformBuffers&&(a=a.replace(/Vertex/,"Ubo"),a=a.replace(/Fragment/,"Ubo")),a+="Declaration"),!t.includesShadersStore[a])return void ha._FileToolsLoadFile(t.shadersRepository+"ShadersInclude/"+a+".fx",c=>{t.includesShadersStore[a]=c,this._ProcessIncludes(n,t,i)});{let l=t.includesShadersStore[a];if(s[2]){const c=s[3].split(",");for(let h=0;h<c.length;h+=2){const u=new RegExp(c[h],"g");l=l.replace(u,c[h+1])}}if(s[4]){const c=s[5];if(-1!==c.indexOf("..")){const h=c.split(".."),u=parseInt(h[0]);let d=parseInt(h[1]),f=l.slice(0);l="",isNaN(d)&&(d=t.indexParameters[h[1]]);for(let p=u;p<d;p++)t.supportsUniformBuffers||(f=f.replace(/light\{X\}.(\w*)/g,(_,m)=>m+"{X}")),l+=f.replace(/\{X\}/g,p.toString())+"\n"}else t.supportsUniformBuffers||(l=l.replace(/light\{X\}.(\w*)/g,(h,u)=>u+"{X}")),l=l.replace(/\{X\}/g,c)}n=n.replace(s[0],l),o=o||l.indexOf("#include<")>=0||l.indexOf("#include <")>=0}s=i1.exec(e)}o?this._ProcessIncludes(n.toString(),t,i):i(n)}static _FileToolsLoadFile(e,t,i,s,n,o){throw Ge("FileTools")}}let j=(()=>{class r{static GetShadersRepository(t=ui.GLSL){return t===ui.GLSL?r.ShadersRepository:r.ShadersRepositoryWGSL}static GetShadersStore(t=ui.GLSL){return t===ui.GLSL?r.ShadersStore:r.ShadersStoreWGSL}static GetIncludesShadersStore(t=ui.GLSL){return t===ui.GLSL?r.IncludesShadersStore:r.IncludesShadersStoreWGSL}}return r.ShadersRepository="src/Shaders/",r.ShadersStore={},r.IncludesShadersStore={},r.ShadersRepositoryWGSL="src/ShadersWGSL/",r.ShadersStoreWGSL={},r.IncludesShadersStoreWGSL={},r})();class Ot{static get ShadersRepository(){return j.ShadersRepository}static set ShadersRepository(e){j.ShadersRepository=e}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new z),this._onBindObservable}constructor(e,t,i,s=null,n,o=null,a=null,l=null,c=null,h,u="",d=ui.GLSL){var f,p,_;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new z,this.onErrorObservable=new z,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!1,this._wasPreviouslyUsingInstances=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this.name=e,this._key=u;let m,b,y,g=null;if(t.attributes){const P=t;if(this._engine=i,this._attributesNames=P.attributes,this._uniformsNames=P.uniformsNames.concat(P.samplers),this._samplerList=P.samplers.slice(),this.defines=P.defines,this.onError=P.onError,this.onCompiled=P.onCompiled,this._fallbacks=P.fallbacks,this._indexParameters=P.indexParameters,this._transformFeedbackVaryings=P.transformFeedbackVaryings||null,this._multiTarget=!!P.multiTarget,this._shaderLanguage=null!==(f=P.shaderLanguage)&&void 0!==f?f:ui.GLSL,P.uniformBuffersNames){this._uniformBuffersNamesList=P.uniformBuffersNames.slice();for(let M=0;M<P.uniformBuffersNames.length;M++)this._uniformBuffersNames[P.uniformBuffersNames[M]]=M}g=null!==(p=P.processFinalCode)&&void 0!==p?p:null,m=null!==(_=P.processCodeAfterIncludes)&&void 0!==_?_:void 0}else this._engine=n,this.defines=o??"",this._uniformsNames=i.concat(s),this._samplerList=s?s.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=d,this.onError=c,this.onCompiled=l,this._indexParameters=h,this._fallbacks=a;this._attributeLocationByName={},this.uniqueId=Ot._UniqueIdSeed++;const T=qi()?this._engine.getHostDocument():null;e.vertexSource?b="source:"+e.vertexSource:e.vertexElement?(b=T?T.getElementById(e.vertexElement):null,b||(b=e.vertexElement)):b=e.vertex||e,e.fragmentSource?y="source:"+e.fragmentSource:e.fragmentElement?(y=T?T.getElementById(e.fragmentElement):null,y||(y=e.fragmentElement)):y=e.fragment||e,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);let x={defines:this.defines.split("\n"),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:j.GetShadersRepository(this._shaderLanguage),includesShadersStore:j.GetIncludesShadersStore(this._shaderLanguage),version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:m};const S=[void 0,void 0],C=()=>{if(S[0]&&S[1]){x.isFragment=!0;const[P,M]=S;ha.Process(M,x,(w,k)=>{this._fragmentSourceCodeBeforeMigration=k,g&&(w=g("fragment",w));const X=ha.Finalize(P,w,x);x=null,this._useFinalCode(X.vertexCode,X.fragmentCode,e)},this._engine)}};this._loadShader(b,"Vertex","",P=>{ha.Initialize(x),ha.Process(P,x,(M,w)=>{this._rawVertexSourceCode=P,this._vertexSourceCodeBeforeMigration=w,g&&(M=g("vertex",M)),S[0]=M,C()},this._engine)}),this._loadShader(y,"Fragment","Pixel",P=>{this._rawFragmentSourceCode=P,S[1]=P,C()});const D=function(P){return function(){return this._pipelineContext&&this._pipelineContext[P].apply(this._pipelineContext,arguments),this}};["Int?","UInt?","IntArray?","UIntArray?","Array?","Color?","Vector?","Float?","Matrices","Matrix","Matrix3x3","Matrix2x2","Quaternion","DirectColor4"].forEach(P=>{const M=`set${P}`;M.endsWith("?")?["",2,3,4].forEach(w=>{this[M.slice(0,-1)+w]=this[M.slice(0,-1)+w]||D(M.slice(0,-1)+w).bind(this)}):this[M]=this[M]||D(M).bind(this)})}_useFinalCode(e,t,i){if(i){const n=i.fragmentElement||i.fragment||i.spectorName||i;this._vertexSourceCode=(this._shaderLanguage===ui.WGSL?"//":"")+"#define SHADER_NAME vertex:"+(i.vertexElement||i.vertex||i.spectorName||i)+"\n"+e,this._fragmentSourceCode=(this._shaderLanguage===ui.WGSL?"//":"")+"#define SHADER_NAME fragment:"+n+"\n"+t}else this._vertexSourceCode=e,this._fragmentSourceCode=t;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}executeWhenCompiled(e){this.isReady()?e(this):(this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16))}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){return void this._processCompilationErrors(t,e)}this._isDisposed||setTimeout(()=>{this._checkIsReady(e)},16)}_loadShader(e,t,i,s){if(typeof HTMLElement<"u"&&e instanceof HTMLElement)return void s(Hg(e));if("source:"===e.substr(0,7))return void s(e.substr(7));if("base64:"===e.substr(0,7))return void s(window.atob(e.substr(7)));const n=j.GetShadersStore(this._shaderLanguage);if(n[e+t+"Shader"])return void s(n[e+t+"Shader"]);if(i&&n[e+i+"Shader"])return void s(n[e+i+"Shader"]);let o;o="."===e[0]||"/"===e[0]||e.indexOf("http")>-1?e:j.GetShadersRepository(this._shaderLanguage)+e,this._engine._loadFile(o+"."+t.toLowerCase()+".fx",s)}get vertexSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:null!==(t=null===(e=this._pipelineContext)||void 0===e?void 0:e._getVertexShaderCode())&&void 0!==t?t:this._vertexSourceCode}get fragmentSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:null!==(t=null===(e=this._pipelineContext)||void 0===e?void 0:e._getFragmentShaderCode())&&void 0!==t?t:this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}_rebuildProgram(e,t,i,s){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(n,o)=>{s&&s(o)},this.onCompiled=()=>{const n=this.getEngine().scenes;if(n)for(let o=0;o<n.length;o++)n[o].markAllMaterialsAsDirty(63);this._pipelineContext._handlesSpectorRebuildCallback(i)},this._fallbacks=null,this._prepareEffect()}_prepareEffect(){const e=this._attributesNames,t=this.defines,i=this._pipelineContext;this._isReady=!1;try{const s=this._engine;this._pipelineContext=s.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key;const n=this._rebuildProgram.bind(this);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?s._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,n,null,this._transformFeedbackVaryings,this._key):s._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,n,t,this._transformFeedbackVaryings,this._key),s._executeWhenRenderingStateIsCompiled(this._pipelineContext,()=>{if(this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,e,this._attributes),e)for(let o=0;o<e.length;o++)this._attributeLocationByName[e[o]]=this._attributes[o];s.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),i&&this.getEngine()._deletePipelineContext(i)}),this._pipelineContext.isAsync&&this._checkIsReady(i)}catch(s){this._processCompilationErrors(s,i)}}_getShaderCodeAndErrorLine(e,t,i){let n=null;if(t&&e){const o=t.match(i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/);if(o&&2===o.length){const a=parseInt(o[1]),l=e.split("\n",-1);l.length>=a&&(n=`Offending line [${a}] in ${i?"fragment":"vertex"} code: ${l[a-1]}`)}}return[e,n]}_processCompilationErrors(e,t=null){var i,s,n;this._compilationError=e.message;const o=this._attributesNames,a=this._fallbacks;if(V.Error("Unable to compile effect:"),V.Error("Uniforms: "+this._uniformsNames.map(function(c){return" "+c})),V.Error("Attributes: "+o.map(function(c){return" "+c})),V.Error("Defines:\r\n"+this.defines),Ot.LogShaderCodeOnCompilationError){let c=null,h=null,u=null;!(null===(i=this._pipelineContext)||void 0===i)&&i._getVertexShaderCode()&&([u,c]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),u&&(V.Error("Vertex code:"),V.Error(u))),!(null===(s=this._pipelineContext)||void 0===s)&&s._getFragmentShaderCode()&&([u,h]=this._getShaderCodeAndErrorLine(null===(n=this._pipelineContext)||void 0===n?void 0:n._getFragmentShaderCode(),this._compilationError,!0),u&&(V.Error("Fragment code:"),V.Error(u))),c&&V.Error(c),h&&V.Error(h)}V.Error("Error: "+this._compilationError);const l=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)};t&&(this._pipelineContext=t,this._isReady=!0,l()),a?(this._pipelineContext=null,a.hasMoreFallbacks?(this._allFallbacksProcessed=!1,V.Error("Trying next fallback."),this.defines=a.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,l(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||l())}get isSupported(){return""===this._compilationError}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setDepthStencilTexture(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){const i=e+"Ex";if(-1===this._samplerList.indexOf(i+"0")){const s=this._samplerList.indexOf(e);for(let o=1;o<t.length;o++){const a=i+(o-1).toString();this._samplerList.splice(s+o,0,a)}let n=0;for(const o of this._samplerList)this._samplers[o]=n,n+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}setTextureFromPostProcess(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)}setTextureFromPostProcessOutput(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)}bindUniformBuffer(e,t){const i=this._uniformBuffersNames[t];void 0===i||Ot._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(Ot._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}dispose(){var e;null===(e=this._pipelineContext)||void 0===e||e.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0}static RegisterShader(e,t,i,s=ui.GLSL){t&&(j.GetShadersStore(s)[`${e}PixelShader`]=t),i&&(j.GetShadersStore(s)[`${e}VertexShader`]=i)}static ResetCache(){Ot._BaseCache={}}}Ot.LogShaderCodeOnCompilationError=!0,Ot._UniqueIdSeed=0,Ot._BaseCache={},Ot.ShadersStore=j.ShadersStore,Ot.IncludesShadersStore=j.IncludesShadersStore;class s1{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){!this.isDirty||(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}let Oie=(()=>{class r{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=r.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=r.KEEP,this.opDepthFail=r.KEEP,this.opStencilDepthPass=r.REPLACE}get stencilFunc(){return this.func}set stencilFunc(t){this.func=t}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(t){this.funcRef=t}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(t){this.funcMask=t}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(t){this.opStencilFail=t}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(t){this.opDepthFail=t}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(t){this.opStencilDepthPass=t}get stencilMask(){return this.mask}set stencilMask(t){this.mask=t}get stencilTest(){return this.enabled}set stencilTest(t){this.enabled=t}}return r.ALWAYS=519,r.KEEP=7680,r.REPLACE=7681,r})();class Nie{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,i,s){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===s||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=s,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,i,s){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===s||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=s,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){!this.isDirty||(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}}class r1{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,i=1,s=1,n=2,o=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=s,this.samplingMode=n,this._comparisonFunction=o,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}var Ye=(()=>{return(r=Ye||(Ye={}))[r.Unknown=0]="Unknown",r[r.Url=1]="Url",r[r.Temp=2]="Temp",r[r.Raw=3]="Raw",r[r.Dynamic=4]="Dynamic",r[r.RenderTarget=5]="RenderTarget",r[r.MultiRenderTarget=6]="MultiRenderTarget",r[r.Cube=7]="Cube",r[r.CubeRaw=8]="CubeRaw",r[r.CubePrefiltered=9]="CubePrefiltered",r[r.Raw3D=10]="Raw3D",r[r.Raw2DArray=11]="Raw2DArray",r[r.DepthStencil=12]="DepthStencil",r[r.CubeRawRGBD=13]="CubeRawRGBD",r[r.Depth=14]="Depth",Ye;var r})();let zt=(()=>{class r extends r1{get useMipMaps(){return this.generateMipMaps}set useMipMaps(t){this.generateMipMaps=t}get uniqueId(){return this._uniqueId}_setUniqueId(t){this._uniqueId=t}getEngine(){return this._engine}get source(){return this._source}constructor(t,i,s=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new z,this.onErrorObservable=new z,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=Ye.Unknown,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._engine=t,this._source=i,this._uniqueId=r._Counter++,s||(this._hardwareTexture=t._createHardwareTexture())}incrementReferences(){this._references++}updateSize(t,i,s=1){this._engine.updateTextureDimensions(this,t,i,s),this.width=t,this.height=i,this.depth=s,this.baseWidth=t,this.baseHeight=i,this.baseDepth=s,this._size=t*i*s}_rebuild(){var t;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const s=this.onRebuildCallback(this),n=o=>{o._swapAndDie(this,!1),this.isReady=s.isReady};return void(s.isAsync?s.proxy.then(n):n(s.proxy))}let i;switch(this.source){case Ye.Temp:break;case Ye.Url:return void(i=this._engine.createTexture(null!==(t=this._originalUrl)&&void 0!==t?t:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,s=>{s._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer));case Ye.Raw:i=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer),i._swapAndDie(this,!1),this.isReady=!0;break;case Ye.Raw3D:i=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),i._swapAndDie(this,!1),this.isReady=!0;break;case Ye.Raw2DArray:i=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),i._swapAndDie(this,!1),this.isReady=!0;break;case Ye.Dynamic:i=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),i._swapAndDie(this,!1),this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);break;case Ye.Cube:return void(i=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{i._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer));case Ye.CubeRaw:i=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),i._swapAndDie(this,!1),this.isReady=!0;break;case Ye.CubeRawRGBD:return;case Ye.CubePrefiltered:return i=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,s=>{s&&s._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),void(i._sphericalPolynomial=this._sphericalPolynomial)}}_swapAndDie(t,i=!0){var s;null===(s=this._hardwareTexture)||void 0===s||s.setUsage(t._source,this.generateMipMaps,this.isCube,this.width,this.height),t._hardwareTexture=this._hardwareTexture,i&&(t._isRGBD=this._isRGBD),this._lodTextureHigh&&(t._lodTextureHigh&&t._lodTextureHigh.dispose(),t._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(t._lodTextureMid&&t._lodTextureMid.dispose(),t._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(t._lodTextureLow&&t._lodTextureLow.dispose(),t._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(t._irradianceTexture&&t._irradianceTexture.dispose(),t._irradianceTexture=this._irradianceTexture);const n=this._engine.getLoadedTexturesCache();let o=n.indexOf(this);-1!==o&&n.splice(o,1),o=n.indexOf(t),-1===o&&n.push(t)}dispose(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),0===this._references&&(this._engine._releaseTexture(this),this._hardwareTexture=null)}}return r._Counter=0,r})();class Fie{constructor(){this.shaderLanguage=ui.GLSL}postProcessor(e,t,i,s,n){return n.getCaps().drawBuffersExtension||(e=e.replace(/#extension.+GL_EXT_draw_buffers.+(enable|require)/g,"")),e}}class n1{constructor(){this.shaderLanguage=ui.GLSL}attributeProcessor(e){return e.replace("attribute","in")}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const s=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i)e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(s?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(");else if(-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;return e}}let jg=(()=>{class r{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=r._Counter++}}return r._Counter=0,r})();class ap extends jg{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}const Lie=["Int","Int2","Int3","Int4","UInt","UInt2","UInt3","UInt4","Vector2","Vector3","Vector4","Float2","Float","Float3","Float4","Quaternion","Color3","Color4","DirectColor4"];class Bie{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null;const e=[],t=function(){e.length=0,Array.prototype.push.apply(e,arguments),e[0]=this._uniforms[e[0]]},i=s=>{const n=Lie.includes(s.substring(3))&&"FloatN";if(n){const o=this[`_cache${n}`];return function(){const a=this.engine[s];t.apply(this,arguments),o.apply(this,arguments)&&(a.apply(this.engine,e)||(this._valueCache[arguments[0]]=null))}}return function(){const o=this.engine[s];t.apply(this,arguments),void 0!==arguments[1]&&(this._valueCache[arguments[0]]=null,o.apply(this.engine,e))}};["Int?","UInt?","IntArray?","UIntArray?","Array?","Float?","Matrices","Matrix3x3","Matrix2x2"].forEach(s=>{const n=`set${s}`;this[n]||(n.endsWith("?")?["",2,3,4].forEach(o=>{this[n.slice(0,-1)+o]=this[n.slice(0,-1)+o]||i(n.slice(0,-1)+o).bind(this)}):this[n]=this[n]||i(n).bind(this))})}get isAsync(){return this.isParallelCompiled}get isReady(){return!!this.program&&(!this.isParallelCompiled||this.engine._isRenderingStateCompiled(this))}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}_fillEffectInformation(e,t,i,s,n,o,a,l){const c=this.engine;if(c.supportsUniformBuffers)for(const d in t)e.bindUniformBlock(d,t[d]);let u;for(this.engine.getUniforms(this,i).forEach((d,f)=>{s[i[f]]=d}),this._uniforms=s,u=0;u<n.length;u++)null==e.getUniform(n[u])&&(n.splice(u,1),u--);n.forEach((d,f)=>{o[d]=f});for(const d of c.getAttributes(this,a))l.push(d)}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],s=t.updateFlag;return(void 0===i||i!==s)&&(this._valueCache[e]=s,!0)}_cacheFloatN(e,t,i,s,n){let o=this._valueCache[arguments[0]];if(!o||o.length!==arguments.length-1)return o=Array.prototype.slice.call(arguments,1),this._valueCache[arguments[0]]=o,!0;let a=!1;for(let l=0;l<o.length;++l)o[l]!==arguments[l+1]&&(o[l]=arguments[l+1],a=!0);return a}_cacheFloat2(e,t,i){return this._cacheFloatN(e,t,i)}_cacheFloat3(e,t,i,s){return this._cacheFloatN(e,t,i,s)}_cacheFloat4(e,t,i,s,n){return this._cacheFloatN(e,t,i,s,n)}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}class lp{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffer=null,this._context=t,!e&&!(e=t.createTexture()))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffer=null}release(){this._MSAARenderBuffer&&(this._context.deleteRenderbuffer(this._MSAARenderBuffer),this._MSAARenderBuffer=null),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}class $i{static IsWrapper(e){return void 0===e.getPipelineContext}static GetEffect(e){return void 0===e.getPipelineContext?e.effect:e}constructor(e,t=!0){this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,i=!0){var s;this.effect=e,void 0!==t&&(this.defines=t),i&&(null===(s=this.drawContext)||void 0===s||s.reset())}dispose(){var e;null===(e=this.drawContext)||void 0===e||e.dispose()}}class o1{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){var e;this.stencilMaterial=void 0,null===(e=this.stencilGlobal)||void 0===e||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){var t;if(!e)return;const i=!this.useStencilGlobalOnly&&!(null===(t=this.stencilMaterial)||void 0===t||!t.enabled);this.enabled=i?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=i?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=i?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=i?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=i?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=i?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=i?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=i?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}}class Vie{}let we=(()=>{class r{static get NpmPackage(){return"babylonjs@5.52.0"}static get Version(){return"5.52.0"}get description(){let t=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(t+=" - Parallel shader compilation"),t}get name(){return this._name}set name(t){this._name=t}get version(){return this._webGLVersion}get isDisposed(){return this._isDisposed}static get ShadersRepository(){return Ot.ShadersRepository}static set ShadersRepository(t){Ot.ShadersRepository=t}_getShaderProcessor(t){return this._shaderProcessor}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(t){t!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=t,this._depthCullingState.depthFunc=t?518:515)}get frameId(){return this._frameId}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}getCreationOptions(){return this._creationOptions}get _shouldUseHighPrecisionShader(){return!(!this._caps.highPrecisionShaderSupported||!this._highPrecisionShadersAllowed)}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get activeRenderLoops(){return this._activeRenderLoops}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(t){this._doNotHandleContextLost=t}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(t){this._framebufferDimensionsObject=t}get currentViewport(){return this._cachedViewport}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const t=new Uint8Array(4);this._emptyCubeTexture=this.createRawCubeTexture([t,t,t,t,t,t],1,5,0,!1,!1,1)}return this._emptyCubeTexture}get isWebGPU(){return this._isWebGPU}get shaderPlatformName(){return this._shaderPlatformName}get snapshotRendering(){return!1}set snapshotRendering(t){}get snapshotRenderingMode(){return this._snapshotRenderingMode}set snapshotRenderingMode(t){this._snapshotRenderingMode=t}snapshotRenderingReset(){this.snapshotRendering=!1}static _CreateCanvas(t,i){if(typeof document>"u")return new OffscreenCanvas(t,i);const s=document.createElement("canvas");return s.width=t,s.height=i,s}createCanvas(t,i){return r._CreateCanvas(t,i)}createCanvasImage(){return document.createElement("img")}constructor(t,i,s,n){var o,a,l,c,h,u,d,f,p,_,m;this._name="WebGL",this._isDisposed=!1,this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new z,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new z,this.onContextRestoredObservable=new z,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new s1,this._stencilStateComposer=new o1,this._stencilState=new Oie,this._alphaState=new Nie,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=new Array,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new z,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},this.startTime=ir.Now;let g=null;this._creationOptions=s=s||{},this.adaptToDeviceRatio=n??!1,this._stencilStateComposer.stencilGlobal=this._stencilState,Ds.SetMatrixPrecision(!!s.useHighPrecisionMatrix),s.antialias=i??s.antialias,s.deterministicLockstep=null!==(o=s.deterministicLockstep)&&void 0!==o&&o,s.lockstepMaxSteps=null!==(a=s.lockstepMaxSteps)&&void 0!==a?a:4,s.timeStep=null!==(l=s.timeStep)&&void 0!==l?l:1/60,s.audioEngine=null===(c=s.audioEngine)||void 0===c||c,s.stencil=null===(h=s.stencil)||void 0===h||h,this._audioContext=null!==(d=null===(u=s.audioEngineOptions)||void 0===u?void 0:u.audioContext)&&void 0!==d?d:null,this._audioDestination=null!==(p=null===(f=s.audioEngineOptions)||void 0===f?void 0:f.audioDestination)&&void 0!==p?p:null,this.premultipliedAlpha=null===(_=s.premultipliedAlpha)||void 0===_||_,this.useExactSrgbConversions=null!==(m=s.useExactSrgbConversions)&&void 0!==m&&m,this._doNotHandleContextLost=!!s.doNotHandleContextLost,this._isStencilEnable=!!s.stencil,n=n||s.adaptToDeviceRatio||!1;const b=qi()&&window.devicePixelRatio||1;if(this._hardwareScalingLevel=n?1/Math.min(s.limitDeviceRatio||b,b):1,this._lastDevicePixelRatio=b,!t)return;if(t.getContext){if(g=t,this._renderingCanvas=g,void 0===s.preserveDrawingBuffer&&(s.preserveDrawingBuffer=!1),void 0===s.xrCompatible&&(s.xrCompatible=!0),navigator&&navigator.userAgent){this._setupMobileChecks();const x=navigator.userAgent;for(const S of r.ExceptionList){const D=S.targets;if(new RegExp(S.key).test(x)){if(S.capture&&S.captureConstraint){const w=S.captureConstraint,X=new RegExp(S.capture).exec(x);if(X&&X.length>0&&parseInt(X[X.length-1])>=w)continue}for(const M of D)switch(M){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":s.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost||(this._onContextLost=x=>{x.preventDefault(),this._contextWasLost=!0,V.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(this._initGLContext.bind(this))},g.addEventListener("webglcontextlost",this._onContextLost,!1),g.addEventListener("webglcontextrestored",this._onContextRestored,!1),s.powerPreference="high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(s.xrCompatible=!1),!s.disableWebGL2Support)try{this._gl=g.getContext("webgl2",s)||g.getContext("experimental-webgl2",s),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!g)throw new Error("The provided canvas is null or undefined.");try{this._gl=g.getContext("webgl",s)||g.getContext("experimental-webgl",s)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=t,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const x=this._gl.getContextAttributes();x&&(s.stencil=x.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==s.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=s.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let x=0;x<this._caps.maxVertexAttribs;x++)this._currentBufferPointers[x]=new Vie;this._shaderProcessor=this.webGLVersion>1?new n1:new Fie,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);const T=`Babylon.js v${r.Version}`;console.log(T+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",T)}_setupMobileChecks(){!navigator||!navigator.userAgent||(this._checkForMobile=()=>{const t=navigator.userAgent;this.hostInformation.isMobile=-1!==t.indexOf("Mobile")||-1!==t.indexOf("Mac")&&rp()&&"ontouchend"in document},this._checkForMobile(),qi()&&window.addEventListener("resize",this._checkForMobile))}_restoreEngineAfterContextLost(t){var i=this;setTimeout(Qt(function*(){var s;i._dummyFramebuffer=null;const n=i._depthCullingState.depthTest,o=i._depthCullingState.depthFunc,a=i._depthCullingState.depthMask,l=i._stencilState.stencilTest;yield t(),i.wipeCaches(!0),i._rebuildEffects(),null===(s=i._rebuildComputeEffects)||void 0===s||s.call(i),i._rebuildBuffers(),i._rebuildInternalTextures(),i._rebuildRenderTargetWrappers(),i.wipeCaches(!0),i._depthCullingState.depthTest=n,i._depthCullingState.depthFunc=o,i._depthCullingState.depthMask=a,i._stencilState.stencilTest=l,V.Warn(i.name+" context successfully restored."),i.onContextRestoredObservable.notifyObservers(i),i._contextWasLost=!1}),0)}_sharedInit(t){this._renderingCanvas=t}_getShaderProcessingContext(t){return null}_rebuildInternalTextures(){const t=this._internalTexturesCache.slice();for(const i of t)i._rebuild()}_rebuildRenderTargetWrappers(){const t=this._renderTargetWrapperCache.slice();for(const i of t)i._rebuild()}_rebuildEffects(){for(const t in this._compiledEffects){const i=this._compiledEffects[t];i._pipelineContext=null,i._wasPreviouslyReady=!1,i._prepareEffect()}Ot.ResetCache()}areAllEffectsReady(){for(const t in this._compiledEffects)if(!this._compiledEffects[t].isReady())return!1;return!0}_rebuildBuffers(){for(const t of this._uniformBuffers)t._rebuild();for(const t of this._storageBuffers)t._rebuild()}_initGLContext(){var t;this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128},this._glVersion=this._gl.getParameter(this._gl.VERSION);const i=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=i&&(this._glRenderer=this._gl.getParameter(i.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(i.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(null!==(t=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))&&void 0!==t?t:0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{const s=this._gl.getExtension("WEBGL_draw_buffers");if(null!==s){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=s.drawBuffersWEBGL.bind(s),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let n=0;n<16;n++)this._gl["COLOR_ATTACHMENT"+n+"_WEBGL"]=s["COLOR_ATTACHMENT"+n+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const s=this._gl.getExtension("WEBGL_depth_texture");null!=s&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=s.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const s=this._gl.getExtension("OES_vertex_array_object");null!=s&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=s.createVertexArrayOES.bind(s),this._gl.bindVertexArray=s.bindVertexArrayOES.bind(s),this._gl.deleteVertexArray=s.deleteVertexArrayOES.bind(s))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const s=this._gl.getExtension("ANGLE_instanced_arrays");null!=s?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=s.drawArraysInstancedANGLE.bind(s),this._gl.drawElementsInstanced=s.drawElementsInstancedANGLE.bind(s),this._gl.vertexAttribDivisor=s.vertexAttribDivisorANGLE.bind(s)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const s=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),n=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);s&&n&&(this._caps.highPrecisionShaderSupported=0!==s.precision&&0!==n.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const s=this._gl.getExtension("EXT_blend_minmax");null!=s&&(this._caps.blendMinMax=!0,this._gl.MAX=s.MAX_EXT,this._gl.MIN=s.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0;else{const s=this._gl.getExtension("EXT_sRGB");null!=s&&(this._caps.supportSRGBBuffers=!0,this._gl.SRGB=s.SRGB_EXT,this._gl.SRGB8=s.SRGB_ALPHA_EXT,this._gl.SRGB8_ALPHA8=s.SRGB_ALPHA_EXT)}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!(!this._creationOptions||!this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let s=0;s<this._maxSimultaneousTextures;s++)this._nextFreeTextureSlots.push(s)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}get isStencilEnable(){return this._isStencilEnable}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const t=this._workingCanvas.getContext("2d");t&&(this._workingContext=t)}resetTextureCache(){for(const t in this._boundTexturesCache)!Object.prototype.hasOwnProperty.call(this._boundTexturesCache,t)||(this._boundTexturesCache[t]=null);this._currentTextureChannel=-1}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}setHardwareScalingLevel(t){this._hardwareScalingLevel=t,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}getLoadedTexturesCache(){return this._internalTexturesCache}getCaps(){return this._caps}stopRenderLoop(t){if(!t)return void(this._activeRenderLoops.length=0);const i=this._activeRenderLoops.indexOf(t);i>=0&&this._activeRenderLoops.splice(i,1)}_renderLoop(){if(!this._contextWasLost){let t=!0;if((this._isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(t=!1),t){this.beginFrame();for(let i=0;i<this._activeRenderLoops.length;i++)(0,this._activeRenderLoops[i])();this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}getHostWindow(){return qi()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}getRenderWidth(t=!1){return!t&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(t=!1){return!t&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}_queueNewFrame(t,i){return r.QueueNewFrame(t,i)}runRenderLoop(t){-1===this._activeRenderLoops.indexOf(t)&&(this._activeRenderLoops.push(t),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}clear(t,i,s,n=!1){const o=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=o;let a=0;i&&t&&(this._gl.clearColor(t.r,t.g,t.b,void 0!==t.a?t.a:1),a|=this._gl.COLOR_BUFFER_BIT),s&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),a|=this._gl.DEPTH_BUFFER_BIT),n&&(this._gl.clearStencil(0),a|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(a)}_viewport(t,i,s,n){(t!==this._viewportCached.x||i!==this._viewportCached.y||s!==this._viewportCached.z||n!==this._viewportCached.w)&&(this._viewportCached.x=t,this._viewportCached.y=i,this._viewportCached.z=s,this._viewportCached.w=n,this._gl.viewport(t,i,s,n))}setViewport(t,i,s){const n=i||this.getRenderWidth(),o=s||this.getRenderHeight(),a=t.x||0,l=t.y||0;this._cachedViewport=t,this._viewport(a*n,l*o,n*t.width,o*t.height)}beginFrame(){}endFrame(){this._badOS&&this.flushFramebuffer(),this._frameId++}resize(t=!1){let i,s;if(this.adaptToDeviceRatio){const n=qi()&&window.devicePixelRatio||1,o=this._lastDevicePixelRatio/n;this._lastDevicePixelRatio=n,this._hardwareScalingLevel*=o}qi()?(i=this._renderingCanvas?this._renderingCanvas.clientWidth||this._renderingCanvas.width:window.innerWidth,s=this._renderingCanvas?this._renderingCanvas.clientHeight||this._renderingCanvas.height:window.innerHeight):(i=this._renderingCanvas?this._renderingCanvas.width:100,s=this._renderingCanvas?this._renderingCanvas.height:100),this.setSize(i/this._hardwareScalingLevel,s/this._hardwareScalingLevel,t)}setSize(t,i,s=!1){return!(!this._renderingCanvas||(t|=0,i|=0,!s&&this._renderingCanvas.width===t&&this._renderingCanvas.height===i)||(this._renderingCanvas.width=t,this._renderingCanvas.height=i,0))}bindFramebuffer(t,i=0,s,n,o,a=0,l=0){var c,h,u,d,f;const p=t;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=t,this._bindUnboundFramebuffer(p._MSAAFramebuffer?p._MSAAFramebuffer:p._framebuffer);const _=this._gl;t.is2DArray?_.framebufferTextureLayer(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,null===(c=t.texture._hardwareTexture)||void 0===c?void 0:c.underlyingResource,a,l):t.isCube&&_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+i,null===(h=t.texture._hardwareTexture)||void 0===h?void 0:h.underlyingResource,a);const m=t._depthStencilTexture;if(m){const g=t._depthStencilTextureWithStencil?_.DEPTH_STENCIL_ATTACHMENT:_.DEPTH_ATTACHMENT;t.is2DArray?_.framebufferTextureLayer(_.FRAMEBUFFER,g,null===(u=m._hardwareTexture)||void 0===u?void 0:u.underlyingResource,a,l):t.isCube?_.framebufferTexture2D(_.FRAMEBUFFER,g,_.TEXTURE_CUBE_MAP_POSITIVE_X+i,null===(d=m._hardwareTexture)||void 0===d?void 0:d.underlyingResource,a):_.framebufferTexture2D(_.FRAMEBUFFER,g,_.TEXTURE_2D,null===(f=m._hardwareTexture)||void 0===f?void 0:f.underlyingResource,a)}this._cachedViewport&&!o?this.setViewport(this._cachedViewport,s,n):(s||(s=t.width,a&&(s/=Math.pow(2,a))),n||(n=t.height,a&&(n/=Math.pow(2,a))),this._viewport(0,0,s,n)),this.wipeCaches()}setState(t,i=0,s,n=!1,o,a,l=0){var c,h;(this._depthCullingState.cull!==t||s)&&(this._depthCullingState.cull=t);const u=null===(h=null!==(c=this.cullBackFaces)&&void 0!==c?c:o)||void 0===h||h?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==u||s)&&(this._depthCullingState.cullFace=u),this.setZOffset(i),this.setZOffsetUnits(l);const d=n?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==d||s)&&(this._depthCullingState.frontFace=d),this._stencilStateComposer.stencilMaterial=a}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(t){this._depthCullingState.depthTest=t}setZOffset(t){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-t:t}getZOffset(){const t=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-t:t}setZOffsetUnits(t){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-t:t}getZOffsetUnits(){const t=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-t:t}_bindUnboundFramebuffer(t){this._currentFramebuffer!==t&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,t),this._currentFramebuffer=t)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(t){this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}unBindFramebuffer(t,i=!1,s){var n;const o=t;this._currentRenderTarget=null;const a=this._gl;if(o._MSAAFramebuffer){if(t.isMulti)return void this.unBindMultiColorAttachmentFramebuffer(t,i,s);a.bindFramebuffer(a.READ_FRAMEBUFFER,o._MSAAFramebuffer),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,o._framebuffer),a.blitFramebuffer(0,0,t.width,t.height,0,0,t.width,t.height,a.COLOR_BUFFER_BIT,a.NEAREST)}(null===(n=t.texture)||void 0===n?void 0:n.generateMipMaps)&&!i&&!t.isCube&&this.generateMipmaps(t.texture),s&&(o._MSAAFramebuffer&&this._bindUnboundFramebuffer(o._framebuffer),s()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(t){return this._createVertexBuffer(t,this._gl.STATIC_DRAW)}_createVertexBuffer(t,i){const s=this._gl.createBuffer();if(!s)throw new Error("Unable to create vertex buffer");const n=new ap(s);return this.bindArrayBuffer(n),this._gl.bufferData(this._gl.ARRAY_BUFFER,t instanceof Array?new Float32Array(t):t,i),this._resetVertexBufferBinding(),n.references=1,n}createDynamicVertexBuffer(t){return this._createVertexBuffer(t,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(t,i){const s=this._gl.createBuffer(),n=new ap(s);if(!s)throw new Error("Unable to create index buffer");this.bindIndexBuffer(n);const o=this._normalizeIndexData(t);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,o,i?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),n.references=1,n.is32Bits=4===o.BYTES_PER_ELEMENT,n}_normalizeIndexData(t){if(2===t.BYTES_PER_ELEMENT)return t;if(this._caps.uintIndices){if(t instanceof Uint32Array)return t;for(let s=0;s<t.length;s++)if(t[s]>=65535)return new Uint32Array(t);return new Uint16Array(t)}return new Uint16Array(t)}bindArrayBuffer(t){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(t,this._gl.ARRAY_BUFFER)}bindUniformBlock(t,i,s){const n=t.program,o=this._gl.getUniformBlockIndex(n,i);this._gl.uniformBlockBinding(n,o,s)}bindIndexBuffer(t){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(t,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(t,i){(this._vaoRecordInProgress||this._currentBoundBuffer[i]!==t)&&(this._gl.bindBuffer(i,t?t.underlyingResource:null),this._currentBoundBuffer[i]=t)}updateArrayBuffer(t){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)}_vertexAttribPointer(t,i,s,n,o,a,l){const c=this._currentBufferPointers[i];if(!c)return;let h=!1;c.active?(c.buffer!==t&&(c.buffer=t,h=!0),c.size!==s&&(c.size=s,h=!0),c.type!==n&&(c.type=n,h=!0),c.normalized!==o&&(c.normalized=o,h=!0),c.stride!==a&&(c.stride=a,h=!0),c.offset!==l&&(c.offset=l,h=!0)):(h=!0,c.active=!0,c.index=i,c.size=s,c.type=n,c.normalized=o,c.stride=a,c.offset=l,c.buffer=t),(h||this._vaoRecordInProgress)&&(this.bindArrayBuffer(t),n===this._gl.UNSIGNED_INT||n===this._gl.INT?this._gl.vertexAttribIPointer(i,s,n,a,l):this._gl.vertexAttribPointer(i,s,n,o,a,l))}_bindIndexBufferWithCache(t){null!=t&&this._cachedIndexBuffer!==t&&(this._cachedIndexBuffer=t,this.bindIndexBuffer(t),this._uintIndicesCurrentlySet=t.is32Bits)}_bindVertexBuffersAttributes(t,i,s){const n=i.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let o=0;o<n.length;o++){const a=i.getAttributeLocation(o);if(a>=0){const l=n[o];let c=null;if(s&&(c=s[l]),c||(c=t[l]),!c)continue;this._gl.enableVertexAttribArray(a),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[a]=!0);const h=c.getBuffer();h&&(this._vertexAttribPointer(h,a,c.getSize(),c.type,c.normalized,c.byteStride,c.byteOffset),c.getIsInstanced()&&(this._gl.vertexAttribDivisor(a,c.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(h))))}}}recordVertexArrayObject(t,i,s,n){const o=this._gl.createVertexArray();if(!o)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(o),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(t,s,n),this.bindIndexBuffer(i),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),o}bindVertexArrayObject(t,i){this._cachedVertexArrayObject!==t&&(this._cachedVertexArrayObject=t,this._gl.bindVertexArray(t),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=i&&i.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(t,i,s,n,o){if(this._cachedVertexBuffers!==t||this._cachedEffectForVertexBuffers!==o){this._cachedVertexBuffers=t,this._cachedEffectForVertexBuffers=o;const a=o.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let l=0;for(let c=0;c<a;c++)if(c<s.length){const h=o.getAttributeLocation(c);h>=0&&(this._gl.enableVertexAttribArray(h),this._vertexAttribArraysEnabled[h]=!0,this._vertexAttribPointer(t,h,s[c],this._gl.FLOAT,!1,n,l)),l+=4*s[c]}}this._bindIndexBufferWithCache(i)}_unbindVertexArrayObject(){!this._cachedVertexArrayObject||(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(t,i,s,n){(this._cachedVertexBuffers!==t||this._cachedEffectForVertexBuffers!==s)&&(this._cachedVertexBuffers=t,this._cachedEffectForVertexBuffers=s,this._bindVertexBuffersAttributes(t,s,n)),this._bindIndexBufferWithCache(i)}unbindInstanceAttributes(){let t;for(let i=0,s=this._currentInstanceLocations.length;i<s;i++){const n=this._currentInstanceBuffers[i];t!=n&&n.references&&(t=n,this.bindArrayBuffer(n)),this._gl.vertexAttribDivisor(this._currentInstanceLocations[i],0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(t){this._gl.deleteVertexArray(t)}_releaseBuffer(t){return t.references--,0===t.references&&(this._deleteBuffer(t),!0)}_deleteBuffer(t){this._gl.deleteBuffer(t.underlyingResource)}updateAndBindInstancesBuffer(t,i,s){if(this.bindArrayBuffer(t),i&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,i),void 0!==s[0].index)this.bindInstancesBuffer(t,s,!0);else for(let n=0;n<4;n++){const o=s[n];this._vertexAttribArraysEnabled[o]||(this._gl.enableVertexAttribArray(o),this._vertexAttribArraysEnabled[o]=!0),this._vertexAttribPointer(t,o,4,this._gl.FLOAT,!1,64,16*n),this._gl.vertexAttribDivisor(o,1),this._currentInstanceLocations.push(o),this._currentInstanceBuffers.push(t)}}bindInstancesBuffer(t,i,s=!0){this.bindArrayBuffer(t);let n=0;if(s)for(let o=0;o<i.length;o++)n+=4*i[o].attributeSize;for(let o=0;o<i.length;o++){const a=i[o];void 0===a.index&&(a.index=this._currentEffect.getAttributeLocationByName(a.attributeName)),!(a.index<0)&&(this._vertexAttribArraysEnabled[a.index]||(this._gl.enableVertexAttribArray(a.index),this._vertexAttribArraysEnabled[a.index]=!0),this._vertexAttribPointer(t,a.index,a.attributeSize,a.attributeType||this._gl.FLOAT,a.normalized||!1,n,a.offset),this._gl.vertexAttribDivisor(a.index,void 0===a.divisor?1:a.divisor),this._currentInstanceLocations.push(a.index),this._currentInstanceBuffers.push(t))}}disableInstanceAttributeByName(t){if(!this._currentEffect)return;const i=this._currentEffect.getAttributeLocationByName(t);this.disableInstanceAttribute(i)}disableInstanceAttribute(t){let s,i=!1;for(;-1!==(s=this._currentInstanceLocations.indexOf(t));)this._currentInstanceLocations.splice(s,1),this._currentInstanceBuffers.splice(s,1),i=!0,s=this._currentInstanceLocations.indexOf(t);i&&(this._gl.vertexAttribDivisor(t,0),this.disableAttributeByIndex(t))}disableAttributeByIndex(t){this._gl.disableVertexAttribArray(t),this._vertexAttribArraysEnabled[t]=!1,this._currentBufferPointers[t].active=!1}draw(t,i,s,n){this.drawElementsType(t?0:1,i,s,n)}drawPointClouds(t,i,s){this.drawArraysType(2,t,i,s)}drawUnIndexed(t,i,s,n){this.drawArraysType(t?0:1,i,s,n)}drawElementsType(t,i,s,n){this.applyStates(),this._reportDrawCall();const o=this._drawMode(t),a=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,l=this._uintIndicesCurrentlySet?4:2;n?this._gl.drawElementsInstanced(o,s,a,i*l,n):this._gl.drawElements(o,s,a,i*l)}drawArraysType(t,i,s,n){this.applyStates(),this._reportDrawCall();const o=this._drawMode(t);n?this._gl.drawArraysInstanced(o,i,s,n):this._gl.drawArrays(o,i,s)}_drawMode(t){switch(t){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_reportDrawCall(){}_releaseEffect(t){this._compiledEffects[t._key]&&delete this._compiledEffects[t._key];const i=t.getPipelineContext();i&&this._deletePipelineContext(i)}_deletePipelineContext(t){const i=t;i&&i.program&&(i.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(i.program))}_getGlobalDefines(t){if(t)return this.isNDCHalfZRange?t.IS_NDC_HALF_ZRANGE="":delete t.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?t.USE_REVERSE_DEPTHBUFFER="":delete t.USE_REVERSE_DEPTHBUFFER,void(this.useExactSrgbConversions?t.USE_EXACT_SRGB_CONVERSIONS="":delete t.USE_EXACT_SRGB_CONVERSIONS);{let i="";return this.isNDCHalfZRange&&(i+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(i&&(i+="\n"),i+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(i&&(i+="\n"),i+="#define USE_EXACT_SRGB_CONVERSIONS"),i}}createEffect(t,i,s,n,o,a,l,c,h,u=ui.GLSL){var d;const f=t.vertexElement||t.vertex||t.vertexToken||t.vertexSource||t,p=t.fragmentElement||t.fragment||t.fragmentToken||t.fragmentSource||t,_=this._getGlobalDefines();let m=null!==(d=o??i.defines)&&void 0!==d?d:"";_&&(m+=_);const g=f+"+"+p+"@"+m;if(this._compiledEffects[g]){const y=this._compiledEffects[g];return l&&y.isReady()&&l(y),y}const b=new Ot(t,i,s,n,this,o,a,l,c,h,g,u);return this._compiledEffects[g]=b,b}static _ConcatenateShader(t,i,s=""){return s+(i?i+"\n":"")+t}_compileShader(t,i,s,n){return this._compileRawShader(r._ConcatenateShader(t,s,n),i)}_compileRawShader(t,i){const s=this._gl,n=s.createShader("vertex"===i?s.VERTEX_SHADER:s.FRAGMENT_SHADER);if(!n){let o=s.NO_ERROR,a=s.NO_ERROR;for(;(a=s.getError())!==s.NO_ERROR;)o=a;throw new Error(`Something went wrong while creating a gl ${i} shader object. gl error=${o}, gl isContextLost=${s.isContextLost()}, _contextWasLost=${this._contextWasLost}`)}return s.shaderSource(n,t),s.compileShader(n),n}_getShaderSource(t){return this._gl.getShaderSource(t)}createRawShaderProgram(t,i,s,n,o=null){n=n||this._gl;const a=this._compileRawShader(i,"vertex"),l=this._compileRawShader(s,"fragment");return this._createShaderProgram(t,a,l,n,o)}createShaderProgram(t,i,s,n,o,a=null){o=o||this._gl;const l=this._webGLVersion>1?"#version 300 es\n#define WEBGL2 \n":"",c=this._compileShader(i,"vertex",n,l),h=this._compileShader(s,"fragment",n,l);return this._createShaderProgram(t,c,h,o,a)}inlineShaderCode(t){return t}createPipelineContext(t){const i=new Bie;return i.engine=this,this._caps.parallelShaderCompile&&(i.isParallelCompiled=!0),i}createMaterialContext(){}createDrawContext(){}_createShaderProgram(t,i,s,n,o=null){const a=n.createProgram();if(t.program=a,!a)throw new Error("Unable to create program");return n.attachShader(a,i),n.attachShader(a,s),n.linkProgram(a),t.context=n,t.vertexShader=i,t.fragmentShader=s,t.isParallelCompiled||this._finalizePipelineContext(t),a}_finalizePipelineContext(t){const i=t.context,s=t.vertexShader,n=t.fragmentShader,o=t.program;if(!i.getProgramParameter(o,i.LINK_STATUS)){if(!this._gl.getShaderParameter(s,this._gl.COMPILE_STATUS)){const c=this._gl.getShaderInfoLog(s);if(c)throw t.vertexCompilationError=c,new Error("VERTEX SHADER "+c)}if(!this._gl.getShaderParameter(n,this._gl.COMPILE_STATUS)){const c=this._gl.getShaderInfoLog(n);if(c)throw t.fragmentCompilationError=c,new Error("FRAGMENT SHADER "+c)}const l=i.getProgramInfoLog(o);if(l)throw t.programLinkError=l,new Error(l)}if(this.validateShaderPrograms&&(i.validateProgram(o),!i.getProgramParameter(o,i.VALIDATE_STATUS))){const c=i.getProgramInfoLog(o);if(c)throw t.programValidationError=c,new Error(c)}i.deleteShader(s),i.deleteShader(n),t.vertexShader=void 0,t.fragmentShader=void 0,t.onCompiled&&(t.onCompiled(),t.onCompiled=void 0)}_preparePipelineContext(t,i,s,n,o,a,l,c,h,u){const d=t;d.program=n?this.createRawShaderProgram(d,i,s,void 0,h):this.createShaderProgram(d,i,s,c,void 0,h),d.program.__SPECTOR_rebuildProgram=l}_isRenderingStateCompiled(t){const i=t;return!!this._gl.getProgramParameter(i.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)&&(this._finalizePipelineContext(i),!0)}_executeWhenRenderingStateIsCompiled(t,i){const s=t;if(!s.isParallelCompiled)return void i();const n=s.onCompiled;s.onCompiled=n?()=>{n(),i()}:i}getUniforms(t,i){const s=new Array,n=t;for(let o=0;o<i.length;o++)s.push(this._gl.getUniformLocation(n.program,i[o]));return s}getAttributes(t,i){const s=[],n=t;for(let o=0;o<i.length;o++)try{s.push(this._gl.getAttribLocation(n.program,i[o]))}catch{s.push(-1)}return s}enableEffect(t){(t=null!==t&&$i.IsWrapper(t)?t.effect:t)&&t!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(t),this._currentEffect=t,t.onBind&&t.onBind(t),t._onBindObservable&&t._onBindObservable.notifyObservers(t))}setInt(t,i){return!!t&&(this._gl.uniform1i(t,i),!0)}setInt2(t,i,s){return!!t&&(this._gl.uniform2i(t,i,s),!0)}setInt3(t,i,s,n){return!!t&&(this._gl.uniform3i(t,i,s,n),!0)}setInt4(t,i,s,n,o){return!!t&&(this._gl.uniform4i(t,i,s,n,o),!0)}setIntArray(t,i){return!!t&&(this._gl.uniform1iv(t,i),!0)}setIntArray2(t,i){return!(!t||i.length%2!=0||(this._gl.uniform2iv(t,i),0))}setIntArray3(t,i){return!(!t||i.length%3!=0||(this._gl.uniform3iv(t,i),0))}setIntArray4(t,i){return!(!t||i.length%4!=0||(this._gl.uniform4iv(t,i),0))}setUInt(t,i){return!!t&&(this._gl.uniform1ui(t,i),!0)}setUInt2(t,i,s){return!!t&&(this._gl.uniform2ui(t,i,s),!0)}setUInt3(t,i,s,n){return!!t&&(this._gl.uniform3ui(t,i,s,n),!0)}setUInt4(t,i,s,n,o){return!!t&&(this._gl.uniform4ui(t,i,s,n,o),!0)}setUIntArray(t,i){return!!t&&(this._gl.uniform1uiv(t,i),!0)}setUIntArray2(t,i){return!(!t||i.length%2!=0||(this._gl.uniform2uiv(t,i),0))}setUIntArray3(t,i){return!(!t||i.length%3!=0||(this._gl.uniform3uiv(t,i),0))}setUIntArray4(t,i){return!(!t||i.length%4!=0||(this._gl.uniform4uiv(t,i),0))}setArray(t,i){return!(!t||i.length<1||(this._gl.uniform1fv(t,i),0))}setArray2(t,i){return!(!t||i.length%2!=0||(this._gl.uniform2fv(t,i),0))}setArray3(t,i){return!(!t||i.length%3!=0||(this._gl.uniform3fv(t,i),0))}setArray4(t,i){return!(!t||i.length%4!=0||(this._gl.uniform4fv(t,i),0))}setMatrices(t,i){return!!t&&(this._gl.uniformMatrix4fv(t,!1,i),!0)}setMatrix3x3(t,i){return!!t&&(this._gl.uniformMatrix3fv(t,!1,i),!0)}setMatrix2x2(t,i){return!!t&&(this._gl.uniformMatrix2fv(t,!1,i),!0)}setFloat(t,i){return!!t&&(this._gl.uniform1f(t,i),!0)}setFloat2(t,i,s){return!!t&&(this._gl.uniform2f(t,i,s),!0)}setFloat3(t,i,s,n){return!!t&&(this._gl.uniform3f(t,i,s,n),!0)}setFloat4(t,i,s,n,o){return!!t&&(this._gl.uniform4f(t,i,s,n,o),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const t=this._colorWrite;this._gl.colorMask(t,t,t,t)}}setColorWrite(t){t!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=t)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}clearInternalTexturesCache(){this._internalTexturesCache.length=0}wipeCaches(t){this.preventCacheWipeBetweenFrames&&!t||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),t&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(t,i){const s=this._gl;let n=s.NEAREST,o=s.NEAREST;switch(t){case 11:n=s.LINEAR,o=i?s.LINEAR_MIPMAP_NEAREST:s.LINEAR;break;case 3:n=s.LINEAR,o=i?s.LINEAR_MIPMAP_LINEAR:s.LINEAR;break;case 8:n=s.NEAREST,o=i?s.NEAREST_MIPMAP_LINEAR:s.NEAREST;break;case 4:n=s.NEAREST,o=i?s.NEAREST_MIPMAP_NEAREST:s.NEAREST;break;case 5:n=s.NEAREST,o=i?s.LINEAR_MIPMAP_NEAREST:s.LINEAR;break;case 6:n=s.NEAREST,o=i?s.LINEAR_MIPMAP_LINEAR:s.LINEAR;break;case 7:n=s.NEAREST,o=s.LINEAR;break;case 1:n=s.NEAREST,o=s.NEAREST;break;case 9:n=s.LINEAR,o=i?s.NEAREST_MIPMAP_NEAREST:s.NEAREST;break;case 10:n=s.LINEAR,o=i?s.NEAREST_MIPMAP_LINEAR:s.NEAREST;break;case 2:n=s.LINEAR,o=s.LINEAR;break;case 12:n=s.LINEAR,o=s.NEAREST}return{min:o,mag:n}}_createTexture(){const t=this._gl.createTexture();if(!t)throw new Error("Unable to create texture");return t}_createHardwareTexture(){return new lp(this._createTexture(),this._gl)}_createInternalTexture(t,i,s=!0,n=Ye.Unknown){var o;let a=!1,l=0,c=3,h=5,u=!1,d=1;void 0!==i&&"object"==typeof i?(a=!!i.generateMipMaps,l=void 0===i.type?0:i.type,c=void 0===i.samplingMode?3:i.samplingMode,h=void 0===i.format?5:i.format,u=void 0!==i.useSRGBBuffer&&i.useSRGBBuffer,d=null!==(o=i.samples)&&void 0!==o?o:1):a=!!i,u&&(u=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1===l&&!this._caps.textureFloatLinearFiltering||2===l&&!this._caps.textureHalfFloatLinearFiltering)&&(c=1),1===l&&!this._caps.textureFloat&&(l=0,V.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const f=this._gl,p=new zt(this,n),_=t.width||t,m=t.height||t,g=t.layers||0,b=this._getSamplingParameters(c,a),y=0!==g?f.TEXTURE_2D_ARRAY:f.TEXTURE_2D,T=this._getRGBABufferInternalSizedFormat(l,h,u),x=this._getInternalFormat(h),S=this._getWebGLTextureType(l);return this._bindTextureDirectly(y,p),0!==g?(p.is2DArray=!0,f.texImage3D(y,0,T,_,m,g,0,x,S,null)):f.texImage2D(y,0,T,_,m,0,x,S,null),f.texParameteri(y,f.TEXTURE_MAG_FILTER,b.mag),f.texParameteri(y,f.TEXTURE_MIN_FILTER,b.min),f.texParameteri(y,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(y,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),a&&this._gl.generateMipmap(y),this._bindTextureDirectly(y,null),p._useSRGBBuffer=u,p.baseWidth=_,p.baseHeight=m,p.width=_,p.height=m,p.depth=g,p.isReady=!0,p.samples=d,p.generateMipMaps=a,p.samplingMode=c,p.type=l,p.format=h,this._internalTexturesCache.push(p),p}_getUseSRGBBuffer(t,i){return t&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||i)}_createTextureBase(t,i,s,n,o=3,a=null,l=null,c,h,u=null,d=null,f=null,p=null,_,m,g){const b="data:"===(t=t||"").substr(0,5),y="blob:"===t.substr(0,5),T=b&&-1!==t.indexOf(";base64,"),x=d||new zt(this,Ye.Url),S=t;this._transformTextureUrl&&!T&&!d&&!u&&(t=this._transformTextureUrl(t)),S!==t&&(x._originalUrl=S);const C=t.lastIndexOf(".");let D=p||(C>-1?t.substring(C).toLowerCase():""),P=null;D.indexOf("?")>-1&&(D=D.split("?")[0]);for(const X of r._TextureLoaders)if(X.canLoad(D,_)){P=X;break}n&&n.addPendingData(x),x.url=t,x.generateMipMaps=!i,x.samplingMode=o,x.invertY=s,x._useSRGBBuffer=this._getUseSRGBBuffer(!!g,i),this._doNotHandleContextLost||(x._buffer=u);let w=null;a&&!d&&(w=x.onLoadedObservable.add(a)),d||this._internalTexturesCache.push(x);const k=(X,te)=>{n&&n.removePendingData(x),t===S?(w&&x.onLoadedObservable.remove(w),be.UseFallbackTexture&&this._createTextureBase(be.FallbackTexture,i,x.invertY,n,o,null,l,c,h,u,x),x.onErrorObservable.notifyObservers({message:X=(X||"Unknown error")+(be.UseFallbackTexture?" - Fallback texture was used":""),exception:te}),l&&l(X,te)):(V.Warn(`Failed to load ${t}, falling back to ${S}`),this._createTextureBase(S,i,x.invertY,n,o,a,l,c,h,u,x,f,p,_,m,g))};if(P){const X=te=>{P.loadData(te,x,(J,Q,me,ae,W,K)=>{K?k("TextureLoader failed to load data"):c(x,D,n,{width:J,height:Q},x.invertY,!me,ae,()=>(W(),!1),o)},m)};u?u instanceof ArrayBuffer?X(new Uint8Array(u)):ArrayBuffer.isView(u)?X(u):l&&l("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(t,te=>X(new Uint8Array(te)),void 0,n?n.offlineProvider:void 0,!0,(te,J)=>{k("Unable to load "+J)})}else{const X=te=>{y&&!this._doNotHandleContextLost&&(x._buffer=te),c(x,D,n,te,x.invertY,i,!1,h,o)};!b||T?u&&("string"==typeof u.decoding||u.close)?X(u):r._FileToolsLoadImage(t,X,k,n?n.offlineProvider:null,_,x.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):"string"==typeof u||u instanceof ArrayBuffer||ArrayBuffer.isView(u)||u instanceof Blob?r._FileToolsLoadImage(u,X,k,n?n.offlineProvider:null,_,x.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):u&&X(u)}return x}createTexture(t,i,s,n,o=3,a=null,l=null,c=null,h=null,u=null,d=null,f,p,_,m){return this._createTextureBase(t,i,s,n,o,a,l,this._prepareWebGLTexture.bind(this),(g,b,y,T,x,S)=>{const C=this._gl,D=y.width===g&&y.height===b,P=u?this._getInternalFormat(u,x._useSRGBBuffer):".jpg"!==T||x._useSRGBBuffer?x._useSRGBBuffer?C.SRGB8_ALPHA8:C.RGBA:C.RGB;let M=u?this._getInternalFormat(u):".jpg"!==T||x._useSRGBBuffer?C.RGBA:C.RGB;if(x._useSRGBBuffer&&1===this.webGLVersion&&(M=P),D)return C.texImage2D(C.TEXTURE_2D,0,P,M,C.UNSIGNED_BYTE,y),!1;const w=this._caps.maxTextureSize;if(y.width>w||y.height>w||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=g,this._workingCanvas.height=b,this._workingContext.drawImage(y,0,0,y.width,y.height,0,0,g,b),C.texImage2D(C.TEXTURE_2D,0,P,M,C.UNSIGNED_BYTE,this._workingCanvas),x.width=g,x.height=b),!1;{const k=new zt(this,Ye.Temp);this._bindTextureDirectly(C.TEXTURE_2D,k,!0),C.texImage2D(C.TEXTURE_2D,0,P,M,C.UNSIGNED_BYTE,y),this._rescaleTexture(k,x,n,P,()=>{this._releaseTexture(k),this._bindTextureDirectly(C.TEXTURE_2D,x,!0),S()})}return!0},c,h,u,d,f,p,m)}static _FileToolsLoadImage(t,i,s,n,o,a){throw Ge("FileTools")}_rescaleTexture(t,i,s,n,o){}createRawTexture(t,i,s,n,o,a,l,c=null,h=0,u=0,d=!1){throw Ge("Engine.RawTexture")}createRawCubeTexture(t,i,s,n,o,a,l,c=null){throw Ge("Engine.RawTexture")}createRawTexture3D(t,i,s,n,o,a,l,c,h=null,u=0){throw Ge("Engine.RawTexture")}createRawTexture2DArray(t,i,s,n,o,a,l,c,h=null,u=0){throw Ge("Engine.RawTexture")}_unpackFlipY(t){this._unpackFlipYCached!==t&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,t?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=t))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(t){return t.isCube?this._gl.TEXTURE_CUBE_MAP:t.is3D?this._gl.TEXTURE_3D:t.is2DArray||t.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(t,i,s=!1){const n=this._getTextureTarget(i),o=this._getSamplingParameters(t,i.useMipMaps||s);this._setTextureParameterInteger(n,this._gl.TEXTURE_MAG_FILTER,o.mag,i),this._setTextureParameterInteger(n,this._gl.TEXTURE_MIN_FILTER,o.min),s&&(i.generateMipMaps=!0,this._gl.generateMipmap(n)),this._bindTextureDirectly(n,null),i.samplingMode=t}updateTextureDimensions(t,i,s,n=1){}updateTextureWrappingMode(t,i,s=null,n=null){const o=this._getTextureTarget(t);null!==i&&(this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(i),t),t._cachedWrapU=i),null!==s&&(this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(s),t),t._cachedWrapV=s),(t.is2DArray||t.is3D)&&null!==n&&(this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(n),t),t._cachedWrapR=n),this._bindTextureDirectly(o,null)}_setupDepthStencilTexture(t,i,s,n,o,a=1){const l=i.width||i,c=i.height||i,h=i.layers||0;t.baseWidth=l,t.baseHeight=c,t.width=l,t.height=c,t.is2DArray=h>0,t.depth=h,t.isReady=!0,t.samples=a,t.generateMipMaps=!1,t.samplingMode=n?2:1,t.type=0,t._comparisonFunction=o;const u=this._gl,d=this._getTextureTarget(t),f=this._getSamplingParameters(t.samplingMode,!1);u.texParameteri(d,u.TEXTURE_MAG_FILTER,f.mag),u.texParameteri(d,u.TEXTURE_MIN_FILTER,f.min),u.texParameteri(d,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(d,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===o?(u.texParameteri(d,u.TEXTURE_COMPARE_FUNC,515),u.texParameteri(d,u.TEXTURE_COMPARE_MODE,u.NONE)):(u.texParameteri(d,u.TEXTURE_COMPARE_FUNC,o),u.texParameteri(d,u.TEXTURE_COMPARE_MODE,u.COMPARE_REF_TO_TEXTURE)))}_uploadCompressedDataToTextureDirectly(t,i,s,n,o,a=0,l=0){const c=this._gl;let h=c.TEXTURE_2D;if(t.isCube&&(h=c.TEXTURE_CUBE_MAP_POSITIVE_X+a),t._useSRGBBuffer)switch(i){case 37492:case 36196:this._caps.etc2?i=c.COMPRESSED_SRGB8_ETC2:t._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?i=c.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:t._useSRGBBuffer=!1;break;case 36492:i=c.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:i=c.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?i=c.COMPRESSED_SRGB_S3TC_DXT1_EXT:t._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?i=c.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:t._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?i=c.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:t._useSRGBBuffer=!1;break;default:t._useSRGBBuffer=!1}this._gl.compressedTexImage2D(h,l,i,s,n,0,o)}_uploadDataToTextureDirectly(t,i,s=0,n=0,o,a=!1){const l=this._gl,c=this._getWebGLTextureType(t.type),h=this._getInternalFormat(t.format),u=void 0===o?this._getRGBABufferInternalSizedFormat(t.type,t.format,t._useSRGBBuffer):this._getInternalFormat(o,t._useSRGBBuffer);this._unpackFlipY(t.invertY);let d=l.TEXTURE_2D;t.isCube&&(d=l.TEXTURE_CUBE_MAP_POSITIVE_X+s);const f=Math.round(Math.log(t.width)*Math.LOG2E),p=Math.round(Math.log(t.height)*Math.LOG2E),_=a?t.width:Math.pow(2,Math.max(f-n,0)),m=a?t.height:Math.pow(2,Math.max(p-n,0));l.texImage2D(d,n,u,_,m,0,h,c,i)}updateTextureData(t,i,s,n,o,a,l=0,c=0,h=!1){const u=this._gl,d=this._getWebGLTextureType(t.type),f=this._getInternalFormat(t.format);this._unpackFlipY(t.invertY);let p=u.TEXTURE_2D,_=u.TEXTURE_2D;t.isCube&&(_=u.TEXTURE_CUBE_MAP_POSITIVE_X+l,p=u.TEXTURE_CUBE_MAP),this._bindTextureDirectly(p,t,!0),u.texSubImage2D(_,c,s,n,o,a,f,d,i),h&&this._gl.generateMipmap(_),this._bindTextureDirectly(p,null)}_uploadArrayBufferViewToTexture(t,i,s=0,n=0){const o=this._gl,a=t.isCube?o.TEXTURE_CUBE_MAP:o.TEXTURE_2D;this._bindTextureDirectly(a,t,!0),this._uploadDataToTextureDirectly(t,i,s,n),this._bindTextureDirectly(a,null,!0)}_prepareWebGLTextureContinuation(t,i,s,n,o){const a=this._gl;if(!a)return;const l=this._getSamplingParameters(o,!s);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,l.mag),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,l.min),!s&&!n&&a.generateMipmap(a.TEXTURE_2D),this._bindTextureDirectly(a.TEXTURE_2D,null),i&&i.removePendingData(t),t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear()}_prepareWebGLTexture(t,i,s,n,o,a,l,c,h=3){const u=this.getCaps().maxTextureSize,d=Math.min(u,this.needPOTTextures?r.GetExponentOfTwo(n.width,u):n.width),f=Math.min(u,this.needPOTTextures?r.GetExponentOfTwo(n.height,u):n.height),p=this._gl;if(p){if(!t._hardwareTexture)return void(s&&s.removePendingData(t));this._bindTextureDirectly(p.TEXTURE_2D,t,!0),this._unpackFlipY(void 0===o||!!o),t.baseWidth=n.width,t.baseHeight=n.height,t.width=d,t.height=f,t.isReady=!0,!c(d,f,n,i,t,()=>{this._prepareWebGLTextureContinuation(t,s,a,l,h)})&&this._prepareWebGLTextureContinuation(t,s,a,l,h)}}_setupFramebufferDepthAttachments(t,i,s,n,o=1){const a=this._gl;if(t&&i)return this._createRenderBuffer(s,n,o,a.DEPTH_STENCIL,a.DEPTH24_STENCIL8,a.DEPTH_STENCIL_ATTACHMENT);if(i){let l=a.DEPTH_COMPONENT16;return this._webGLVersion>1&&(l=a.DEPTH_COMPONENT32F),this._createRenderBuffer(s,n,o,l,l,a.DEPTH_ATTACHMENT)}return t?this._createRenderBuffer(s,n,o,a.STENCIL_INDEX8,a.STENCIL_INDEX8,a.STENCIL_ATTACHMENT):null}_createRenderBuffer(t,i,s,n,o,a,l=!0){const h=this._gl.createRenderbuffer();return this._updateRenderBuffer(h,t,i,s,n,o,a,l)}_updateRenderBuffer(t,i,s,n,o,a,l,c=!0){const h=this._gl;return h.bindRenderbuffer(h.RENDERBUFFER,t),n>1&&h.renderbufferStorageMultisample?h.renderbufferStorageMultisample(h.RENDERBUFFER,n,a,i,s):h.renderbufferStorage(h.RENDERBUFFER,o,i,s),h.framebufferRenderbuffer(h.FRAMEBUFFER,l,h.RENDERBUFFER,t),c&&h.bindRenderbuffer(h.RENDERBUFFER,null),t}_releaseTexture(t){var i;this._deleteTexture(null===(i=t._hardwareTexture)||void 0===i?void 0:i.underlyingResource),this.unbindAllTextures();const s=this._internalTexturesCache.indexOf(t);-1!==s&&this._internalTexturesCache.splice(s,1),t._lodTextureHigh&&t._lodTextureHigh.dispose(),t._lodTextureMid&&t._lodTextureMid.dispose(),t._lodTextureLow&&t._lodTextureLow.dispose(),t._irradianceTexture&&t._irradianceTexture.dispose()}_releaseRenderTargetWrapper(t){const i=this._renderTargetWrapperCache.indexOf(t);-1!==i&&this._renderTargetWrapperCache.splice(i,1)}_deleteTexture(t){t&&this._gl.deleteTexture(t)}_setProgram(t){this._currentProgram!==t&&(this._gl.useProgram(t),this._currentProgram=t)}bindSamplers(t){const i=t.getPipelineContext();this._setProgram(i.program);const s=t.getSamplers();for(let n=0;n<s.length;n++){const o=t.getUniform(s[n]);o&&(this._boundUniforms[n]=o)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(t,i,s=!1,n=!1){var o,a;let l=!1;const c=i&&i._associatedChannel>-1;if(s&&c&&(this._activeChannel=i._associatedChannel),this._boundTexturesCache[this._activeChannel]!==i||n){if(this._activateCurrentTexture(),i&&i.isMultiview)throw console.error(t,i),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(t,null!==(a=null===(o=i?._hardwareTexture)||void 0===o?void 0:o.underlyingResource)&&void 0!==a?a:null),this._boundTexturesCache[this._activeChannel]=i,i&&(i._associatedChannel=this._activeChannel)}else s&&(l=!0,this._activateCurrentTexture());return c&&!s&&this._bindSamplerUniformToChannel(i._associatedChannel,this._activeChannel),l}_bindTexture(t,i,s){if(void 0===t)return;i&&(i._associatedChannel=t),this._activeChannel=t;const n=i?this._getTextureTarget(i):this._gl.TEXTURE_2D;this._bindTextureDirectly(n,i)}unbindAllTextures(){for(let t=0;t<this._maxSimultaneousTextures;t++)this._activeChannel=t,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(t,i,s,n){void 0!==t&&(i&&(this._boundUniforms[t]=i),this._setTexture(t,s))}_bindSamplerUniformToChannel(t,i){const s=this._boundUniforms[t];!s||s._currentState===i||(this._gl.uniform1i(s,i),s._currentState=i)}_getTextureWrapMode(t){switch(t){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(t,i,s=!1,n=!1,o=""){if(!i)return null!=this._boundTexturesCache[t]&&(this._activeChannel=t,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(i.video)this._activeChannel=t,i.update();else if(4===i.delayLoadState)return i.delayLoad(),!1;let a;a=n?i.depthStencilTexture:i.isReady()?i.getInternalTexture():i.isCube?this.emptyCubeTexture:i.is3D?this.emptyTexture3D:i.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!s&&a&&(a._associatedChannel=t);let l=!0;this._boundTexturesCache[t]===a&&(s||this._bindSamplerUniformToChannel(a._associatedChannel,t),l=!1),this._activeChannel=t;const c=this._getTextureTarget(a);if(l&&this._bindTextureDirectly(c,a,s),a&&!a.isMultiview){if(a.isCube&&a._cachedCoordinatesMode!==i.coordinatesMode){a._cachedCoordinatesMode=i.coordinatesMode;const h=3!==i.coordinatesMode&&5!==i.coordinatesMode?1:0;i.wrapU=h,i.wrapV=h}a._cachedWrapU!==i.wrapU&&(a._cachedWrapU=i.wrapU,this._setTextureParameterInteger(c,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(i.wrapU),a)),a._cachedWrapV!==i.wrapV&&(a._cachedWrapV=i.wrapV,this._setTextureParameterInteger(c,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i.wrapV),a)),a.is3D&&a._cachedWrapR!==i.wrapR&&(a._cachedWrapR=i.wrapR,this._setTextureParameterInteger(c,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(i.wrapR),a)),this._setAnisotropicLevel(c,a,i.anisotropicFilteringLevel)}return!0}setTextureArray(t,i,s,n){if(void 0!==t&&i){(!this._textureUnits||this._textureUnits.length!==s.length)&&(this._textureUnits=new Int32Array(s.length));for(let o=0;o<s.length;o++){const a=s[o].getInternalTexture();a?(this._textureUnits[o]=t+o,a._associatedChannel=t+o):this._textureUnits[o]=-1}this._gl.uniform1iv(i,this._textureUnits);for(let o=0;o<s.length;o++)this._setTexture(this._textureUnits[o],s[o],!0)}}_setAnisotropicLevel(t,i,s){const n=this._caps.textureAnisotropicFilterExtension;11!==i.samplingMode&&3!==i.samplingMode&&2!==i.samplingMode&&(s=1),n&&i._cachedAnisotropicFilteringLevel!==s&&(this._setTextureParameterFloat(t,n.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s,this._caps.maxAnisotropy),i),i._cachedAnisotropicFilteringLevel=s)}_setTextureParameterFloat(t,i,s,n){this._bindTextureDirectly(t,n,!0,!0),this._gl.texParameterf(t,i,s)}_setTextureParameterInteger(t,i,s,n){n&&this._bindTextureDirectly(t,n,!0,!0),this._gl.texParameteri(t,i,s)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let t=0;t<this._caps.maxVertexAttribs;t++)this.disableAttributeByIndex(t)}else for(let t=0,i=this._vertexAttribArraysEnabled.length;t<i;t++)t>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[t]||this.disableAttributeByIndex(t)}releaseEffects(){for(const t in this._compiledEffects){const i=this._compiledEffects[t].getPipelineContext();this._deletePipelineContext(i)}this._compiledEffects={}}dispose(){var t;this._isDisposed=!0,this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),null===(t=this.releaseComputeEffects)||void 0===t||t.call(this),this.unbindAllAttributes(),this._boundUniforms={},qi()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,Ot.ResetCache();for(const i of this._activeRequests)i.abort();this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}attachContextLostEvent(t){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",t,!1)}attachContextRestoredEvent(t){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",t,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(t){const i=this._gl;for(;i.getError()!==i.NO_ERROR;);let s=!0;const n=i.createTexture();i.bindTexture(i.TEXTURE_2D,n),i.texImage2D(i.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(t),1,1,0,i.RGBA,this._getWebGLTextureType(t),null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST);const o=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,o),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,n,0);const a=i.checkFramebufferStatus(i.FRAMEBUFFER);if(s=s&&a===i.FRAMEBUFFER_COMPLETE,s=s&&i.getError()===i.NO_ERROR,s&&(i.clear(i.COLOR_BUFFER_BIT),s=s&&i.getError()===i.NO_ERROR),s){i.bindFramebuffer(i.FRAMEBUFFER,null);const l=i.RGBA,c=i.UNSIGNED_BYTE,h=new Uint8Array(4);i.readPixels(0,0,1,1,l,c,h),s=s&&i.getError()===i.NO_ERROR}for(i.deleteTexture(n),i.deleteFramebuffer(o),i.bindFramebuffer(i.FRAMEBUFFER,null);!s&&i.getError()!==i.NO_ERROR;);return s}_getWebGLTextureType(t){if(1===this._webGLVersion){switch(t){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(t){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(t,i=!1){let s=i?this._gl.SRGB8_ALPHA8:this._gl.RGBA;switch(t){case 0:s=this._gl.ALPHA;break;case 1:s=this._gl.LUMINANCE;break;case 2:s=this._gl.LUMINANCE_ALPHA;break;case 6:s=this._gl.RED;break;case 7:s=this._gl.RG;break;case 4:s=i?this._gl.SRGB:this._gl.RGB;break;case 5:s=i?this._gl.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(t){case 8:s=this._gl.RED_INTEGER;break;case 9:s=this._gl.RG_INTEGER;break;case 10:s=this._gl.RGB_INTEGER;break;case 11:s=this._gl.RGBA_INTEGER}return s}_getRGBABufferInternalSizedFormat(t,i,s=!1){if(1===this._webGLVersion){if(void 0!==i)switch(i){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return s?this._gl.SRGB:this._gl.RGB}return this._gl.RGBA}switch(t){case 3:switch(i){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(i){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return s?this._gl.SRGB8:this._gl.RGB8;case 5:return s?this._gl.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(i){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(i){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(i){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(i){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(i){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(i){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(i){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return s?this._gl.SRGB8_ALPHA8:this._gl.RGBA8}_getRGBAMultiSampleBufferFormat(t){return 1===t?this._gl.RGBA32F:2===t?this._gl.RGBA16F:this._gl.RGBA8}_loadFile(t,i,s,n,o,a){const l=r._FileToolsLoadFile(t,i,s,n,o,a);return this._activeRequests.push(l),l.onCompleteObservable.add(c=>{this._activeRequests.splice(this._activeRequests.indexOf(c),1)}),l}static _FileToolsLoadFile(t,i,s,n,o,a){throw Ge("FileTools")}readPixels(t,i,s,n,o=!0,a=!0){const c=o?this._gl.RGBA:this._gl.RGB,h=new Uint8Array(n*s*(o?4:3));return a&&this.flushFramebuffer(),this._gl.readPixels(t,i,s,n,c,this._gl.UNSIGNED_BYTE,h),Promise.resolve(h)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const t=this._CreateCanvas(1,1),i=t.getContext("webgl")||t.getContext("experimental-webgl");this._IsSupported=null!=i&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const t=this._CreateCanvas(1,1),i=t.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||t.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!i}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}static CeilingPOT(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}static FloorPOT(t){return t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,(t|=t>>16)-(t>>1)}static NearestPOT(t){const i=r.CeilingPOT(t),s=r.FloorPOT(t);return i-t>t-s?s:i}static GetExponentOfTwo(t,i,s=2){let n;switch(s){case 1:n=r.FloorPOT(t);break;case 2:n=r.NearestPOT(t);break;default:n=r.CeilingPOT(t)}return Math.min(n,i)}static QueueNewFrame(t,i){if(qi()){const{requestPostAnimationFrame:s,requestAnimationFrame:n}=i||window;if("function"==typeof s)return s(t);if("function"==typeof n)return n(t)}else if("function"==typeof requestAnimationFrame)return requestAnimationFrame(t);return setTimeout(t,16)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:rp()?document:null}}return r.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],r._TextureLoaders=[],r.CollisionsEpsilon=.001,r._IsSupported=null,r._HasMajorPerformanceCaveat=null,r})();class ku{static SetImmediate(e){qi()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)}}const a1=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class cp extends No{constructor(e,t){super(e,4e3),this.name="LoadFileError",Uu._setPrototypeOf(this,cp.prototype),t instanceof Yi?this.request=t:this.file=t}}class Yg extends No{constructor(e,t){super(e,4001),this.request=t,this.name="RequestFileError",Uu._setPrototypeOf(this,Yg.prototype)}}class uE extends No{constructor(e,t){super(e,4002),this.file=t,this.name="ReadFileError",Uu._setPrototypeOf(this,uE.prototype)}}const sr={DefaultRetryStrategy:class Tie{static ExponentialBackoff(e=3,t=500){return(i,s,n)=>0!==s.status||n>=e||-1!==i.indexOf("file:")?-1:Math.pow(2,n)*t}}.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:r=>r},l1=r=>r.replace(/#/gm,"%23"),dE=(r,e)=>{if((!r||0!==r.indexOf("data:"))&&sr.CorsBehavior)if("string"==typeof sr.CorsBehavior||sr.CorsBehavior instanceof String)e.crossOrigin=sr.CorsBehavior;else{const t=sr.CorsBehavior(r);t&&(e.crossOrigin=t)}},qg=(r,e,t,i,s="",n)=>{var o;let a,l=!1;r instanceof ArrayBuffer||ArrayBuffer.isView(r)?typeof Blob<"u"&&typeof URL<"u"?(a=URL.createObjectURL(new Blob([r],{type:s})),l=!0):a=`data:${s};base64,`+aE(r):r instanceof Blob?(a=URL.createObjectURL(r),l=!0):(a=l1(r),a=sr.PreprocessUrl(r));const c=be.LastCreatedEngine,h=S=>{if(t){const C=a||r.toString();t(`Error while trying to load image: ${0===C.indexOf("http")||C.length<=128?C:C.slice(0,128)+"..."}`,S)}};if(typeof Image>"u"||null!==(o=c?._features.forceBitmapOverHTMLImageElement)&&void 0!==o&&o)return ql(a,S=>{c.createImageBitmap(new Blob([S],{type:s}),{premultiplyAlpha:"none",...n}).then(C=>{e(C),l&&URL.revokeObjectURL(a)}).catch(C=>{t&&t("Error while trying to load image: "+r,C)})},void 0,i||void 0,!0,(S,C)=>{h(C)}),null;const u=new Image;dE(a,u);const d=[],p=()=>{d.forEach(S=>{S.target.removeEventListener(S.name,S.handler)}),d.length=0};d.push({target:u,name:"load",handler:()=>{p(),e(u),l&&u.src&&URL.revokeObjectURL(u.src)}}),d.push({target:u,name:"error",handler:S=>{p(),h(S),l&&u.src&&URL.revokeObjectURL(u.src)}}),d.push({target:document,name:"securitypolicyviolation",handler:S=>{if(S.blockedURI!==u.src)return;p();const C=new Error(`CSP violation of policy ${S.effectiveDirective} ${S.blockedURI}. Current policy is ${S.originalPolicy}`);be.UseFallbackTexture=!1,h(C),l&&u.src&&URL.revokeObjectURL(u.src),u.src=""}}),d.forEach(S=>{S.target.addEventListener(S.name,S.handler)});const b="blob:"===a.substring(0,5),y="data:"===a.substring(0,5),T=()=>{b||y?u.src=a:ql(a,(S,C,D)=>{const M=new Blob([S],{type:!s&&D?D:s}),w=URL.createObjectURL(M);l=!0,u.src=w},void 0,i||void 0,!0,(S,C)=>{h(C)})};if(!b&&!y&&i&&i.enableTexturesOffline)i.open(()=>{i&&i.loadImage(a,u)},T);else{if(-1!==a.indexOf("file:")){const S=decodeURIComponent(a.substring(5).toLowerCase());if(Wg.FilesToLoad[S]&&typeof URL<"u"){try{let C;try{C=URL.createObjectURL(Wg.FilesToLoad[S])}catch{C=URL.createObjectURL(Wg.FilesToLoad[S])}u.src=C,l=!0}catch{u.src=""}return u}}T()}return u},hp=(r,e,t,i,s)=>{const n=new FileReader,o={onCompleteObservable:new z,abort:()=>n.abort()};return n.onloadend=()=>o.onCompleteObservable.notifyObservers(o),s&&(n.onerror=()=>{s(new uE(`Unable to read ${r.name}`,r))}),n.onload=a=>{e(a.target.result)},t&&(n.onprogress=t),i?n.readAsArrayBuffer(r):n.readAsText(r),o},ql=(r,e,t,i,s,n,o)=>{if(r.name)return hp(r,e,t,s,n?h=>{n(void 0,h)}:void 0);const a=r;if(-1!==a.indexOf("file:")){let h=decodeURIComponent(a.substring(5).toLowerCase());0===h.indexOf("./")&&(h=h.substring(2));const u=Wg.FilesToLoad[h];if(u)return hp(u,e,t,s,n?d=>n(void 0,new cp(d.message,d.file)):void 0)}const{match:l,type:c}=Uie(a);if(l){const h={onCompleteObservable:new z,abort:()=>()=>{}};try{const u=s?up(a):h1(a);e(u,void 0,c)}catch(u){n?n(void 0,u):V.Error(u.message||"Failed to parse the Data URL")}return ku.SetImmediate(()=>{h.onCompleteObservable.notifyObservers(h)}),h}return fE(a,(h,u)=>{e(h,u?.responseURL,u?.getResponseHeader("content-type"))},t,i,s,n?h=>{n(h.request,new cp(h.message,h.request))}:void 0,o)},fE=(r,e,t,i,s,n,o)=>{r=l1(r),r=sr.PreprocessUrl(r);const a=sr.BaseUrl+r;let l=!1;const c={onCompleteObservable:new z,abort:()=>l=!0},h=()=>{let f,u=new Yi,d=null;const p=()=>{!u||(t&&u.removeEventListener("progress",t),f&&u.removeEventListener("readystatechange",f),u.removeEventListener("loadend",_))};let _=()=>{p(),c.onCompleteObservable.notifyObservers(c),c.onCompleteObservable.clear(),t=void 0,f=null,_=null,n=void 0,o=void 0,e=void 0};c.abort=()=>{l=!0,_&&_(),u&&u.readyState!==(XMLHttpRequest.DONE||4)&&u.abort(),null!==d&&(clearTimeout(d),d=null),u=null};const m=b=>{const y=b.message||"Unknown error";n&&u?n(new Yg(y,u)):V.Error(y)},g=b=>{if(u){if(u.open("GET",a),o)try{o(u)}catch(y){return void m(y)}s&&(u.responseType="arraybuffer"),t&&u.addEventListener("progress",t),_&&u.addEventListener("loadend",_),f=()=>{if(!l&&u&&u.readyState===(XMLHttpRequest.DONE||4)){if(f&&u.removeEventListener("readystatechange",f),u.status>=200&&u.status<300||0===u.status&&(!qi()||c1())){try{e&&e(s?u.response:u.responseText,u)}catch(x){m(x)}return}const y=sr.DefaultRetryStrategy;if(y){const x=y(a,u,b);if(-1!==x)return p(),u=new Yi,void(d=setTimeout(()=>g(b+1),x))}const T=new Yg("Error status: "+u.status+" "+u.statusText+" - Unable to load "+a,u);n&&n(T)}},u.addEventListener("readystatechange",f),u.send()}};g(0)};if(i&&i.enableSceneOffline){const u=f=>{f&&f.status>400?n&&n(f):h()},d=()=>{i&&i.loadFile(sr.BaseUrl+r,f=>{!l&&e&&e(f),c.onCompleteObservable.notifyObservers(c)},t?f=>{!l&&t&&t(f)}:void 0,u,s)};i.open(d,u)}else h();return c},c1=()=>typeof location<"u"&&"file:"===location.protocol,$g=r=>a1.test(r),Uie=r=>{const e=a1.exec(r);return null===e||0===e.length?{match:!1,type:""}:{match:!0,type:e[0].replace("data:","").replace("base64,","")}};function up(r){return(r=>{const e=lE(r),t=e.length,i=new Uint8Array(new ArrayBuffer(t));for(let s=0;s<t;s++)i[s]=e.charCodeAt(s);return i.buffer})(r.split(",")[1])}const h1=r=>lE(r.split(",")[1]);let dp;var t;we._FileToolsLoadImage=qg,we._FileToolsLoadFile=ql,ha._FileToolsLoadFile=ql,dp={DecodeBase64UrlToBinary:up,DecodeBase64UrlToString:h1,DefaultRetryStrategy:(t=sr).DefaultRetryStrategy,BaseUrl:t.BaseUrl,CorsBehavior:t.CorsBehavior,PreprocessUrl:t.PreprocessUrl,IsBase64DataUrl:$g,IsFileURL:c1,LoadFile:ql,LoadImage:qg,ReadFile:hp,RequestFile:fE,SetCorsBehavior:dE},Object.defineProperty(dp,"DefaultRetryStrategy",{get:function(){return t.DefaultRetryStrategy},set:function(h){t.DefaultRetryStrategy=h}}),Object.defineProperty(dp,"BaseUrl",{get:function(){return t.BaseUrl},set:function(h){t.BaseUrl=h}}),Object.defineProperty(dp,"PreprocessUrl",{get:function(){return t.PreprocessUrl},set:function(h){t.PreprocessUrl=h}}),Object.defineProperty(dp,"CorsBehavior",{get:function(){return t.CorsBehavior},set:function(h){t.CorsBehavior=h}});let Kg=(()=>{class r{static Instantiate(t){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[t])return this.RegisteredExternalClasses[t];const i=hs(t);if(i)return i;V.Warn(t+" not found, you may have missed an import.");const s=t.split(".");let n=window||this;for(let o=0,a=s.length;o<a;o++)n=n[s[o]];return"function"!=typeof n?null:n}}return r.RegisteredExternalClasses={},r})();function Qg(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{const e=16*Math.random()|0;return("x"===r?e:3&e|8).toString(16)})}class q{static get BaseUrl(){return sr.BaseUrl}static set BaseUrl(e){sr.BaseUrl=e}static get DefaultRetryStrategy(){return sr.DefaultRetryStrategy}static set DefaultRetryStrategy(e){sr.DefaultRetryStrategy=e}static get CorsBehavior(){return sr.CorsBehavior}static set CorsBehavior(e){sr.CorsBehavior=e}static get UseFallbackTexture(){return be.UseFallbackTexture}static set UseFallbackTexture(e){be.UseFallbackTexture=e}static get RegisteredExternalClasses(){return Kg.RegisteredExternalClasses}static set RegisteredExternalClasses(e){Kg.RegisteredExternalClasses=e}static get fallbackTexture(){return be.FallbackTexture}static set fallbackTexture(e){be.FallbackTexture=e}static FetchToRef(e,t,i,s,n,o){const c=4*((Math.abs(e)*i%i|0)+(Math.abs(t)*s%s|0)*i);o.r=n[c]/255,o.g=n[c+1]/255,o.b=n[c+2]/255,o.a=n[c+3]/255}static Mix(e,t,i){return e*(1-i)+t*i}static Instantiate(e){return Kg.Instantiate(e)}static SetImmediate(e){ku.SetImmediate(e)}static IsExponentOfTwo(e){let t=1;do{t*=2}while(t<e);return t===e}static FloatRound(e){return Math.fround?Math.fround(e):(q._TmpFloatArray[0]=e,q._TmpFloatArray[0])}static GetFilename(e){const t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){const i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}static ToDegrees(e){return 180*e/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,i=.9){const s=this.ToRadians(e),n=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(n)+i*Math.sin(s),(1-i)*Math.cos(n)+i*Math.cos(s)))}static MakeArray(e,t){return!0===t||void 0!==e&&null!=e?Array.isArray(e)?e:[e]:null}static GetPointerPrefix(e){let t="pointer";return qi()&&!window.PointerEvent&&(t="mouse"),e._badDesktopOS&&!e._badOS&&!(document&&"ontouchend"in document)&&(t="mouse"),t}static SetCorsBehavior(e,t){dE(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static CleanUrl(e){return e.replace(/#/gm,"%23")}static get PreprocessUrl(){return sr.PreprocessUrl}static set PreprocessUrl(e){sr.PreprocessUrl=e}static LoadImage(e,t,i,s,n,o){return qg(e,t,i,s,n,o)}static LoadFile(e,t,i,s,n,o){return ql(e,t,i,s,n,o)}static LoadFileAsync(e,t=!0){return new Promise((i,s)=>{ql(e,n=>{i(n)},void 0,void 0,t,(n,o)=>{s(o)})})}static LoadScript(e,t,i,s){if("function"==typeof importScripts){try{importScripts(e),t()}catch(a){i?.(`Unable to load script '${e}' in worker`,a)}return}if(!qi())return void i?.(`Cannot load script '${e}' outside of a window or a worker`);const n=document.getElementsByTagName("head")[0],o=document.createElement("script");o.setAttribute("type","text/javascript"),o.setAttribute("src",e),s&&(o.id=s),o.onload=()=>{t&&t()},o.onerror=a=>{i&&i(`Unable to load script '${e}'`,a)},n.appendChild(o)}static LoadScriptAsync(e){return new Promise((t,i)=>{this.LoadScript(e,()=>{t()},(s,n)=>{i(n||new Error(s))})})}static ReadFileAsDataURL(e,t,i){const s=new FileReader,n={onCompleteObservable:new z,abort:()=>s.abort()};return s.onloadend=()=>{n.onCompleteObservable.notifyObservers(n)},s.onload=o=>{t(o.target.result)},s.onprogress=i,s.readAsDataURL(e),n}static ReadFile(e,t,i,s,n){return hp(e,t,i,s,n)}static FileAsURL(e){const t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,i,s){Pr.DeepCopy(e,t,i,s)}static IsEmpty(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const s=t[i];e.addEventListener(s.name,s.handler,!1);try{window.parent&&window.parent.addEventListener(s.name,s.handler,!1)}catch{}}}static UnregisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const s=t[i];e.removeEventListener(s.name,s.handler);try{e.parent&&e.parent.removeEventListener(s.name,s.handler)}catch{}}}static DumpFramebuffer(e,t,i,s,n="image/png",o){return Qt(function*(){throw Ge("DumpTools")})()}static DumpData(e,t,i,s,n="image/png",o,a=!1,l=!1,c){throw Ge("DumpTools")}static DumpDataAsync(e,t,i,s="image/png",n,o=!1,a=!1,l){throw Ge("DumpTools")}static ToBlob(e,t,i="image/png",s){e.toBlob||(e.toBlob=function(n,o,a){setTimeout(()=>{const l=atob(this.toDataURL(o,a).split(",")[1]),c=l.length,h=new Uint8Array(c);for(let u=0;u<c;u++)h[u]=l.charCodeAt(u);n(new Blob([h]))})}),e.toBlob(function(n){t(n)},i,s)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){const i=new Date;t="screenshot_"+(i.getFullYear()+"-"+(i.getMonth()+1)).slice(2)+"-"+i.getDate()+"_"+i.getHours()+"-"+("0"+i.getMinutes()).slice(-2)+".png"}q.Download(e,t)}else if(e&&typeof URL<"u"){const i=URL.createObjectURL(e),s=window.open("");if(!s)return;const n=s.document.createElement("img");n.onload=function(){URL.revokeObjectURL(i)},n.src=i,s.document.body.appendChild(n)}}static EncodeScreenshotCanvasData(e,t,i="image/png",s,n){t?t(e.toDataURL(i,n)):this.ToBlob(e,function(o){o&&q.DownloadBlob(o,s)},i,n)}static Download(e,t){if(typeof URL>"u")return;const i=window.URL.createObjectURL(e),s=document.createElement("a");document.body.appendChild(s),s.style.display="none",s.href=i,s.download=t,s.addEventListener("click",()=>{s.parentElement&&s.parentElement.removeChild(s)}),s.click(),window.URL.revokeObjectURL(i)}static BackCompatCameraNoPreventDefault(e){return"boolean"==typeof e[0]?e[0]:"boolean"==typeof e[1]&&e[1]}static CreateScreenshot(e,t,i,s,n="image/png"){throw Ge("ScreenshotTools")}static CreateScreenshotAsync(e,t,i,s="image/png"){throw Ge("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,i,s,n="image/png",o=1,a=!1,l){throw Ge("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(e,t,i,s="image/png",n=1,o=!1,a){throw Ge("ScreenshotTools")}static RandomId(){return Qg()}static IsBase64(e){return $g(e)}static DecodeBase64(e){return up(e)}static get errorsCount(){return V.errorsCount}static Log(e){V.Log(e)}static Warn(e){V.Warn(e)}static Error(e){V.Error(e)}static get LogCache(){return V.LogCache}static ClearLogCache(){V.ClearLogCache()}static set LogLevels(e){V.LogLevels=e}static set PerformanceLogLevel(e){return(e&q.PerformanceUserMarkLogLevel)===q.PerformanceUserMarkLogLevel?(q.StartPerformanceCounter=q._StartUserMark,void(q.EndPerformanceCounter=q._EndUserMark)):(e&q.PerformanceConsoleLogLevel)===q.PerformanceConsoleLogLevel?(q.StartPerformanceCounter=q._StartPerformanceConsole,void(q.EndPerformanceCounter=q._EndPerformanceConsole)):(q.StartPerformanceCounter=q._StartPerformanceCounterDisabled,void(q.EndPerformanceCounter=q._EndPerformanceCounterDisabled))}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!q._Performance){if(!qi())return;q._Performance=window.performance}!t||!q._Performance.mark||q._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){!t||!q._Performance.mark||(q._Performance.mark(e+"-End"),q._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){!t||(q._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){!t||(q._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return ir.Now}static GetClassName(e,t=!1){let i=null;return!t&&e.getClassName?i=e.getClassName():(e instanceof Object&&(i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),i||(i=typeof e)),i}static First(e,t){for(const i of e)if(t(i))return i;return null}static getFullClassName(e,t=!1){let i=null,s=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){const n=t?e:Object.getPrototypeOf(e);i=n.constructor.__bjsclassName__,s=n.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(null!=s?s+".":"")+i:null}static DelayAsync(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}static IsSafari(){return!!nE()&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}}q.UseCustomRequestHeaders=!1,q.CustomRequestHeaders=Yi.CustomRequestHeaders,q._TmpFloatArray=new Float32Array(1),q.GetDOMTextContent=Hg,q.GetAbsoluteUrl="object"==typeof document?r=>{const e=document.createElement("a");return e.href=r,e.href}:"function"==typeof URL&&"object"==typeof location?r=>new URL(r,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")},q.NoneLogLevel=V.NoneLogLevel,q.MessageLogLevel=V.MessageLogLevel,q.WarningLogLevel=V.WarningLogLevel,q.ErrorLogLevel=V.ErrorLogLevel,q.AllLogLevel=V.AllLogLevel,q.IsWindowObjectExist=qi,q.PerformanceNoneLogLevel=0,q.PerformanceUserMarkLogLevel=1,q.PerformanceConsoleLogLevel=2,q.StartPerformanceCounter=q._StartPerformanceCounterDisabled,q.EndPerformanceCounter=q._EndPerformanceCounterDisabled;class ho{constructor(e,t,i,s=0){this.iterations=e,this.index=s-1,this._done=!1,this._fn=t,this._successCallback=i}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,t,i,s=0){const n=new ho(e,t,i,s);return n.executeNext(),n}static SyncAsyncForLoop(e,t,i,s,n,o=0){return ho.Run(Math.ceil(e/t),a=>{n&&n()?a.breakLoop():setTimeout(()=>{for(let l=0;l<t;++l){const c=a.index*t+l;if(c>=e)break;if(i(c),n&&n()){a.breakLoop();break}}a.executeNext()},o)},s)}}be.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";let ws=(()=>{class r{constructor(t){this.length=0,this.data=new Array(t),this._id=r._GlobalId++}push(t){this.data[this.length++]=t,this.length>this.data.length&&(this.data.length*=2)}forEach(t){for(let i=0;i<this.length;i++)t(this.data[i])}sort(t){this.data.sort(t)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(t){if(0!==t.length){this.length+t.length>this.data.length&&(this.data.length=2*(this.length+t.length));for(let i=0;i<t.length;i++)this.data[this.length++]=(t.data||t)[i]}}indexOf(t){const i=this.data.indexOf(t);return i>=this.length?-1:i}contains(t){return-1!==this.indexOf(t)}}return r._GlobalId=0,r})();class $l extends ws{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return!(e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId||(this.push(e),0))}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++)this.pushNoDuplicate((e.data||e)[t])}}}class pE{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach((t,i)=>this.add(t,i))}get(e){const t=this._data[e];if(void 0!==t)return t}getOrAddWithFactory(e,t){let i=this.get(e);return void 0!==i||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){const i=this.get(e);return void 0!==i?i:(this.add(e,t),t)}contains(e){return void 0!==this._data[e]}add(e,t){return void 0===this._data[e]&&(this._data[e]=t,++this._count,!0)}set(e,t){return void 0!==this._data[e]&&(this._data[e]=t,!0)}getAndRemove(e){const t=this.get(e);return void 0!==t?(delete this._data[e],--this._count,t):null}remove(e){return!!this.contains(e)&&(delete this._data[e],--this._count,!0)}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(const t in this._data)e(t,this._data[t])}first(e){for(const t in this._data){const s=e(t,this._data[t]);if(s)return s}return null}}class Un{constructor(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(const e of Object.keys(this))"_"!==e[0]&&this._keys.push(e);if(this._externalProperties)for(const e in this._externalProperties)-1===this._keys.indexOf(e)&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];if(this[i]!==e[i])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){const i=this._keys[t];e[i]=this[i]}}reset(){this._keys.forEach(e=>this._setDefaultValue(e))}_setDefaultValue(e){var t,i,s,n,o;const a=null!==(s=null===(i=null===(t=this._externalProperties)||void 0===t?void 0:t[e])||void 0===i?void 0:i.type)&&void 0!==s?s:typeof this[e],l=null===(o=null===(n=this._externalProperties)||void 0===n?void 0:n[e])||void 0===o?void 0:o.default;switch(a){case"number":this[e]=l??0;break;case"string":this[e]=l??"";break;default:this[e]=l??!1}}toString(){let e="";for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=this[i];switch(typeof s){case"number":case"string":e+="#define "+i+" "+s+"\n";break;default:s&&(e+="#define "+i+"\n")}}return e}}class Si{constructor(){this._dirty=!0,this._tempColor=new Te(0,0,0,0),this._globalCurve=new Te(0,0,0,0),this._highlightsCurve=new Te(0,0,0,0),this._midtonesCurve=new Te(0,0,0,0),this._shadowsCurve=new Te(0,0,0,0),this._positiveCurve=new Te(0,0,0,0),this._negativeCurve=new Te(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",s="vCameraColorCurveNeutral",n="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(s,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(n,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}static PrepareUniforms(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}_getColorGradingDataToRef(e,t,i,s,n){null!=e&&(e=Si._Clamp(e,0,360),t=Si._Clamp(t,-100,100),i=Si._Clamp(i,-100,100),s=Si._Clamp(s,-100,100),t=Si._ApplyColorGradingSliderNonlinear(t),t*=.5,s=Si._ApplyColorGradingSliderNonlinear(s),t<0&&(t*=-1,e=(e+180)%360),Si._FromHSBToRef(e,t,50+.25*s,n),n.scaleToRef(2,n),n.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,s){let n=Si._Clamp(e,0,360);const o=Si._Clamp(t/100,0,1),a=Si._Clamp(i/100,0,1);if(0===o)s.r=a,s.g=a,s.b=a;else{n/=60;const l=Math.floor(n),c=n-l,h=a*(1-o),u=a*(1-o*c),d=a*(1-o*(1-c));switch(l){case 0:s.r=a,s.g=d,s.b=h;break;case 1:s.r=u,s.g=a,s.b=h;break;case 2:s.r=h,s.g=a,s.b=d;break;case 3:s.r=h,s.g=u,s.b=a;break;case 4:s.r=d,s.g=h,s.b=a;break;default:s.r=a,s.g=h,s.b=u}}s.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return Ce.Clone(()=>new Si,this)}serialize(){return Ce.Serialize(this)}static Parse(e){return Ce.Parse(()=>new Si,e,null,null)}}E([I()],Si.prototype,"_globalHue",void 0),E([I()],Si.prototype,"_globalDensity",void 0),E([I()],Si.prototype,"_globalSaturation",void 0),E([I()],Si.prototype,"_globalExposure",void 0),E([I()],Si.prototype,"_highlightsHue",void 0),E([I()],Si.prototype,"_highlightsDensity",void 0),E([I()],Si.prototype,"_highlightsSaturation",void 0),E([I()],Si.prototype,"_highlightsExposure",void 0),E([I()],Si.prototype,"_midtonesHue",void 0),E([I()],Si.prototype,"_midtonesDensity",void 0),E([I()],Si.prototype,"_midtonesSaturation",void 0),E([I()],Si.prototype,"_midtonesExposure",void 0),Ce._ColorCurvesParser=Si.Parse;class kie extends Un{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class at{constructor(){this.colorCurves=new Si,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=at.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new Te(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=at.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new z}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}static PrepareUniforms(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),(t.VIGNETTE||t.DITHER)&&e.push("vInverseScreenSize"),t.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&Si.PrepareUniforms(e),t.DITHER&&e.push("ditherIntensity")}static PrepareSamplers(e,t){t.COLORGRADING&&e.push("txColorTransform")}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled)return e.VIGNETTE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,void(e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled);e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===at._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,e.TONEMAPPING=this.toneMappingEnabled,e.TONEMAPPING_ACES=this._toneMappingType===at.TONEMAPPING_ACES,e.CONTRAST=1!==this.contrast,e.EXPOSURE=1!==this.exposure,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING3D=!!e.COLORGRADING&&this.colorGradingTexture.is3D,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&Si.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const i=1/e.getEngine().getRenderWidth(),s=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",i,s),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const n=t??s/i;let o=Math.tan(.5*this.vignetteCameraFov),a=o*n;const l=Math.sqrt(a*o);a=q.Mix(a,l,this.vignetteStretch),o=q.Mix(o,l,this.vignetteStretch),e.setFloat4("vignetteSettings1",a,o,-a*this.vignetteCenterX,-o*this.vignetteCenterY),e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,-2*this.vignetteWeight)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const i=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(i-1)/i,.5/i,i,this.colorGradingTexture.level)}}clone(){return Ce.Clone(()=>new at,this)}serialize(){return Ce.Serialize(this)}static Parse(e){const t=Ce.Parse(()=>new at,e,null,null);return void 0!==e.vignetteCentreX&&(t.vignetteCenterX=e.vignetteCentreX),void 0!==e.vignetteCentreY&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}at.TONEMAPPING_STANDARD=0,at.TONEMAPPING_ACES=1,at._VIGNETTEMODE_MULTIPLY=0,at._VIGNETTEMODE_OPAQUE=1,E([function lie(r){return Bn(7,r)}()],at.prototype,"colorCurves",void 0),E([I()],at.prototype,"_colorCurvesEnabled",void 0),E([ht("colorGradingTexture")],at.prototype,"_colorGradingTexture",void 0),E([I()],at.prototype,"_colorGradingEnabled",void 0),E([I()],at.prototype,"_colorGradingWithGreenDepth",void 0),E([I()],at.prototype,"_colorGradingBGR",void 0),E([I()],at.prototype,"_exposure",void 0),E([I()],at.prototype,"_toneMappingEnabled",void 0),E([I()],at.prototype,"_toneMappingType",void 0),E([I()],at.prototype,"_contrast",void 0),E([I()],at.prototype,"vignetteStretch",void 0),E([I()],at.prototype,"vignetteCenterX",void 0),E([I()],at.prototype,"vignetteCenterY",void 0),E([I()],at.prototype,"vignetteWeight",void 0),E([sE()],at.prototype,"vignetteColor",void 0),E([I()],at.prototype,"vignetteCameraFov",void 0),E([I()],at.prototype,"_vignetteBlendMode",void 0),E([I()],at.prototype,"_vignetteEnabled",void 0),E([I()],at.prototype,"_ditheringEnabled",void 0),E([I()],at.prototype,"_ditheringIntensity",void 0),E([I()],at.prototype,"_skipFinalColorClamp",void 0),E([I()],at.prototype,"_applyByPostProcess",void 0),E([I()],at.prototype,"_isEnabled",void 0),Ce._ImageProcessingConfigurationParser=at.Parse,we.prototype.createUniformBuffer=function(r){const e=this._gl.createBuffer();if(!e)throw new Error("Unable to create uniform buffer");const t=new ap(e);return this.bindUniformBuffer(t),r instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,r,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(r),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),t.references=1,t},we.prototype.createDynamicUniformBuffer=function(r){const e=this._gl.createBuffer();if(!e)throw new Error("Unable to create dynamic uniform buffer");const t=new ap(e);return this.bindUniformBuffer(t),r instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,r,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(r),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),t.references=1,t},we.prototype.updateUniformBuffer=function(r,e,t,i){this.bindUniformBuffer(r),void 0===t&&(t=0),void 0===i?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+i)),this.bindUniformBuffer(null)},we.prototype.bindUniformBuffer=function(r){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,r?r.underlyingResource:null)},we.prototype.bindUniformBufferBase=function(r,e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,r?r.underlyingResource:null)},we.prototype.bindUniformBlock=function(r,e,t){const i=r.program,s=this._gl.getUniformBlockIndex(i,e);4294967295!==s&&this._gl.uniformBlockBinding(i,s,t)};class Se{constructor(e,t,i,s,n=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||n,this._dynamic=i,this._name=s??"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return void 0!==this._dynamic}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(t=e<=2?e:4,this._uniformLocationPointer%t!=0){const i=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const s=this._uniformLocationPointer-i;for(let n=0;n<s;n++)this._data.push(0)}}addUniform(e,t,i=0){if(this._noUBO||void 0!==this._uniformLocations[e])return;let s;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},16==t?t*=i:t=t*i+(4-t)*i,s=[];for(let n=0;n<t;n++)s.push(0)}else{if(t instanceof Array)s=t,t=s.length;else{s=[];for(let n=0;n<t;n++)s.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let n=0;n<t;n++)this._data.push(s[n]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))}addFloat2(e,t,i){this.addUniform(e,[t,i])}addFloat3(e,t,i,s){this.addUniform(e,[t,i,s])}addColor3(e,t){this.addUniform(e,[t.r,t.g,t.b])}addColor4(e,t,i){this.addUniform(e,[t.r,t.g,t.b,i])}addVector3(e,t){this.addUniform(e,[t.x,t.y,t.z])}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_rebuild(){this._noUBO||!this._bufferData||(this._buffer=this._dynamic?this._engine.createDynamicUniformBuffer(this._bufferData):this._engine.createUniformBuffer(this._bufferData),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer)return void this.create();if(!this._dynamic&&!this._needSync)return void(this._createBufferOnWrite=this._engine._features.trackUbosInFrame);if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1]){if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1]))return this._needSync=!1,void(this._createBufferOnWrite=this._engine._features.trackUbosInFrame);this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1])}this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(Se._UpdatedUbosInFrame[this._name]||(Se._UpdatedUbosInFrame[this._name]=0),Se._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=0!==this._bufferIndex,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let s=this._uniformLocations[e];if(void 0===s){if(this._buffer)return void V.Error("Cannot add an uniform after UBO has been created.");this.addUniform(e,i),s=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let n=0;n<i;n++)this._bufferData[s+n]=t[n];else{let n=!1;for(let o=0;o<i;o++)(16===i&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[s+o]!==q.FloatRound(t[o]))&&(n=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+o]=t[o]);this._needSync=this._needSync||n}}updateUniformArray(e,t,i){this._checkNewFrame();const s=this._uniformLocations[e];if(void 0===s)return void V.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");this._buffer||this.create();const n=this._uniformArraySizes[e];if(this._dynamic)for(let o=0;o<i;o++)this._bufferData[s+o]=t[o];else{let o=!1,a=0,l=0;for(let c=0;c<i;c++)if(this._bufferData[s+4*l+a]!==q.FloatRound(t[c])&&(o=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+4*l+a]=t[c]),a++,a===n.strideSize){for(;a<4;a++)this._bufferData[s+4*l+a]=0;a=0,l++}this._needSync=this._needSync||o}}_cacheMatrix(e,t){this._checkNewFrame();const i=this._valueCache[e],s=t.updateFlag;return(void 0===i||i!==s)&&(this._valueCache[e]=s,!0)}_updateMatrix3x3ForUniform(e,t){for(let i=0;i<3;i++)Se._TempBuffer[4*i]=t[3*i],Se._TempBuffer[4*i+1]=t[3*i+1],Se._TempBuffer[4*i+2]=t[3*i+2],Se._TempBuffer[4*i+3]=0;this.updateUniform(e,Se._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let i=0;i<2;i++)Se._TempBuffer[4*i]=t[2*i],Se._TempBuffer[4*i+1]=t[2*i+1],Se._TempBuffer[4*i+2]=0,Se._TempBuffer[4*i+3]=0;this.updateUniform(e,Se._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){Se._TempBuffer[0]=t,this.updateUniform(e,Se._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,s=""){this._currentEffect.setFloat2(e+s,t,i)}_updateFloat2ForUniform(e,t,i){Se._TempBuffer[0]=t,Se._TempBuffer[1]=i,this.updateUniform(e,Se._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,s,n=""){this._currentEffect.setFloat3(e+n,t,i,s)}_updateFloat3ForUniform(e,t,i,s){Se._TempBuffer[0]=t,Se._TempBuffer[1]=i,Se._TempBuffer[2]=s,this.updateUniform(e,Se._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,s,n,o=""){this._currentEffect.setFloat4(e+o,t,i,s,n)}_updateFloat4ForUniform(e,t,i,s,n){Se._TempBuffer[0]=t,Se._TempBuffer[1]=i,Se._TempBuffer[2]=s,Se._TempBuffer[3]=n,this.updateUniform(e,Se._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){Se._TempBufferInt32View.set(t),this.updateUniformArray(e,Se._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){Se._TempBufferUInt32View.set(t),this.updateUniformArray(e,Se._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.toArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){Se._TempBuffer[0]=t.x,Se._TempBuffer[1]=t.y,Se._TempBuffer[2]=t.z,this.updateUniform(e,Se._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){Se._TempBuffer[0]=t.x,Se._TempBuffer[1]=t.y,Se._TempBuffer[2]=t.z,Se._TempBuffer[3]=t.w,this.updateUniform(e,Se._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){Se._TempBuffer[0]=t.r,Se._TempBuffer[1]=t.g,Se._TempBuffer[2]=t.b,this.updateUniform(e,Se._TempBuffer,3)}_updateColor4ForEffect(e,t,i,s=""){this._currentEffect.setColor4(e+s,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){Se._TempBuffer[0]=t.r,Se._TempBuffer[1]=t.g,Se._TempBuffer[2]=t.b,Se._TempBuffer[3]=i,this.updateUniform(e,Se._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){Se._TempBuffer[0]=t.r,Se._TempBuffer[1]=t.g,Se._TempBuffer[2]=t.b,Se._TempBuffer[3]=t.a,this.updateUniform(e,Se._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){Se._TempBufferInt32View[0]=t,this.updateUniform(e,Se._TempBuffer,1)}_updateInt2ForEffect(e,t,i,s=""){this._currentEffect.setInt2(e+s,t,i)}_updateInt2ForUniform(e,t,i){Se._TempBufferInt32View[0]=t,Se._TempBufferInt32View[1]=i,this.updateUniform(e,Se._TempBuffer,2)}_updateInt3ForEffect(e,t,i,s,n=""){this._currentEffect.setInt3(e+n,t,i,s)}_updateInt3ForUniform(e,t,i,s){Se._TempBufferInt32View[0]=t,Se._TempBufferInt32View[1]=i,Se._TempBufferInt32View[2]=s,this.updateUniform(e,Se._TempBuffer,3)}_updateInt4ForEffect(e,t,i,s,n,o=""){this._currentEffect.setInt4(e+o,t,i,s,n)}_updateInt4ForUniform(e,t,i,s,n){Se._TempBufferInt32View[0]=t,Se._TempBufferInt32View[1]=i,Se._TempBufferInt32View[2]=s,Se._TempBufferInt32View[3]=n,this.updateUniform(e,Se._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){Se._TempBufferUInt32View[0]=t,this.updateUniform(e,Se._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,s=""){this._currentEffect.setUInt2(e+s,t,i)}_updateUInt2ForUniform(e,t,i){Se._TempBufferUInt32View[0]=t,Se._TempBufferUInt32View[1]=i,this.updateUniform(e,Se._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,s,n=""){this._currentEffect.setUInt3(e+n,t,i,s)}_updateUInt3ForUniform(e,t,i,s){Se._TempBufferUInt32View[0]=t,Se._TempBufferUInt32View[1]=i,Se._TempBufferUInt32View[2]=s,this.updateUniform(e,Se._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,s,n,o=""){this._currentEffect.setUInt4(e+o,t,i,s,n)}_updateUInt4ForUniform(e,t,i,s,n){Se._TempBufferUInt32View[0]=t,Se._TempBufferUInt32View[1]=i,Se._TempBufferUInt32View[2]=s,Se._TempBufferUInt32View[3]=n,this.updateUniform(e,Se._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(-1!==t&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let i=0;i<this._buffers.length;++i)this._engine._releaseBuffer(this._buffers[i][0]);else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}Se._UpdatedUbosInFrame={},Se._MAX_UNIFORM_SIZE=256,Se._TempBuffer=new Float32Array(Se._MAX_UNIFORM_SIZE),Se._TempBufferInt32View=new Int32Array(Se._TempBuffer.buffer),Se._TempBufferUInt32View=new Uint32Array(Se._TempBuffer.buffer);class kn{constructor(e,t,i,s=0,n=!1,o=!1,a=!1,l){this._isAlreadyOwned=!1,this._engine=e.getScene?e.getScene().getEngine():e,this._updatable=i,this._instanced=o,this._divisor=l||1,t instanceof jg?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=a?s:s*Float32Array.BYTES_PER_ELEMENT,n||this.create()}createVertexBuffer(e,t,i,s,n,o=!1,a){const l=o?t:t*Float32Array.BYTES_PER_ELEMENT,c=s?o?s:s*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new A(this._engine,this,e,this._updatable,!0,c,void 0===n?this._instanced:n,l,i,void 0,void 0,!0,this._divisor||a)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data)&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e),this._data=e):this._buffer=this._engine.createVertexBuffer(e))}_rebuild(){this._buffer=null,this.create(this._data)}update(e){this.create(e)}updateDirectly(e,t,i,s=!1){!this._buffer||this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,s?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),this._data=0===t&&void 0===i?e:null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned)return void(this._isAlreadyOwned=!0);this._buffer.references++}}dispose(){!this._buffer||this._engine._releaseBuffer(this._buffer)&&(this._buffer=null,this._data=null)}}let A=(()=>{class r{get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(t){const i=0!=t;this._instanceDivisor=t,i!==this._instanced&&(this._instanced=i,this._computeHashCode())}constructor(t,i,s,n,o,a,l,c,h,u,d=!1,f=!1,p=1,_=!1){if(i instanceof kn?(this._buffer=i,this._ownsBuffer=_):(this._buffer=new kn(t,i,n,a,o,l,f),this._ownsBuffer=!0),this.uniqueId=r._Counter++,this._kind=s,null==u){const g=this.getData();this.type=r.FLOAT,g instanceof Int8Array?this.type=r.BYTE:g instanceof Uint8Array?this.type=r.UNSIGNED_BYTE:g instanceof Int16Array?this.type=r.SHORT:g instanceof Uint16Array?this.type=r.UNSIGNED_SHORT:g instanceof Int32Array?this.type=r.INT:g instanceof Uint32Array&&(this.type=r.UNSIGNED_INT)}else this.type=u;const m=r.GetTypeByteLength(this.type);f?(this._size=h||(a?a/m:r.DeduceStride(s)),this.byteStride=a||this._buffer.byteStride||this._size*m,this.byteOffset=c||0):(this._size=h||a||r.DeduceStride(s),this.byteStride=a?a*m:this._buffer.byteStride||this._size*m,this.byteOffset=(c||0)*m),this.normalized=d,this._instanced=void 0!==l&&l,this._instanceDivisor=l?p:0,this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){!this._buffer||this._buffer._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(t,i){const s=this.getData();if(!s)return null;const n=this.getSize()*r.GetTypeByteLength(this.type),o=t*this.getSize();if(this.type!==r.FLOAT||this.byteStride!==n){const a=new Float32Array(o);return this.forEach(o,(l,c)=>a[c]=l),a}if(!(s instanceof Array||s instanceof Float32Array)||0!==this.byteOffset||s.length!==o){if(s instanceof Array){const a=this.byteOffset/4;return s.slice(a,a+o)}if(s instanceof ArrayBuffer)return new Float32Array(s,this.byteOffset,o);{let a=s.byteOffset+this.byteOffset;if(i){const c=new Float32Array(o),h=new Float32Array(s.buffer,a,o);return c.set(h),c}const l=a%4;return l&&(a=Math.max(0,a-l)),new Float32Array(s.buffer,a,o)}}return i?s.slice():s}getBuffer(){return this._buffer.getBuffer()}getStrideSize(){return this.byteStride/r.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/r.GetTypeByteLength(this.type)}getSize(t=!1){return t?this._size*r.GetTypeByteLength(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(t){this._buffer.create(t)}update(t){this._buffer.update(t)}updateDirectly(t,i,s=!1){this._buffer.updateDirectly(t,i,void 0,s)}dispose(){this._ownsBuffer&&this._buffer.dispose()}forEach(t,i){r.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,t,this.normalized,i)}static DeduceStride(t){switch(t){case r.UVKind:case r.UV2Kind:case r.UV3Kind:case r.UV4Kind:case r.UV5Kind:case r.UV6Kind:return 2;case r.NormalKind:case r.PositionKind:return 3;case r.ColorKind:case r.MatricesIndicesKind:case r.MatricesIndicesExtraKind:case r.MatricesWeightsKind:case r.MatricesWeightsExtraKind:case r.TangentKind:return 4;default:throw new Error("Invalid kind '"+t+"'")}}static GetTypeByteLength(t){switch(t){case r.BYTE:case r.UNSIGNED_BYTE:return 1;case r.SHORT:case r.UNSIGNED_SHORT:return 2;case r.INT:case r.UNSIGNED_INT:case r.FLOAT:return 4;default:throw new Error(`Invalid type '${t}'`)}}static ForEach(t,i,s,n,o,a,l,c){if(t instanceof Array){let h=i/4;const u=s/4;for(let d=0;d<a;d+=n){for(let f=0;f<n;f++)c(t[h+f],d+f);h+=u}}else{const h=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),u=r.GetTypeByteLength(o);for(let d=0;d<a;d+=n){let f=i;for(let p=0;p<n;p++)c(r._GetFloatValue(h,o,f,l),d+p),f+=u;i+=s}}}static _GetFloatValue(t,i,s,n){switch(i){case r.BYTE:{let o=t.getInt8(s);return n&&(o=Math.max(o/127,-1)),o}case r.UNSIGNED_BYTE:{let o=t.getUint8(s);return n&&(o/=255),o}case r.SHORT:{let o=t.getInt16(s,!0);return n&&(o=Math.max(o/32767,-1)),o}case r.UNSIGNED_SHORT:{let o=t.getUint16(s,!0);return n&&(o/=65535),o}case r.INT:return t.getInt32(s,!0);case r.UNSIGNED_INT:return t.getUint32(s,!0);case r.FLOAT:return t.getFloat32(s,!0);default:throw new Error(`Invalid component type ${i}`)}}}return r._Counter=0,r.BYTE=5120,r.UNSIGNED_BYTE=5121,r.SHORT=5122,r.UNSIGNED_SHORT=5123,r.INT=5124,r.UNSIGNED_INT=5125,r.FLOAT=5126,r.PositionKind="position",r.NormalKind="normal",r.TangentKind="tangent",r.UVKind="uv",r.UV2Kind="uv2",r.UV3Kind="uv3",r.UV4Kind="uv4",r.UV5Kind="uv5",r.UV6Kind="uv6",r.ColorKind="color",r.ColorInstanceKind="instanceColor",r.MatricesIndicesKind="matricesIndices",r.MatricesWeightsKind="matricesWeights",r.MatricesIndicesExtraKind="matricesIndicesExtra",r.MatricesWeightsExtraKind="matricesWeightsExtra",r})();class Os{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(A.NormalKind))return null;const i=this.pickedMesh.getIndices();if(!i)return null;let s;if(t){const o=this.pickedMesh.getVerticesData(A.NormalKind);let a=v.FromArray(o,3*i[3*this.faceId]),l=v.FromArray(o,3*i[3*this.faceId+1]),c=v.FromArray(o,3*i[3*this.faceId+2]);a=a.scale(this.bu),l=l.scale(this.bv),c=c.scale(1-this.bu-this.bv),s=new v(a.x+l.x+c.x,a.y+l.y+c.y,a.z+l.z+c.z)}else{const o=this.pickedMesh.getVerticesData(A.PositionKind),a=v.FromArray(o,3*i[3*this.faceId]),l=v.FromArray(o,3*i[3*this.faceId+1]),c=v.FromArray(o,3*i[3*this.faceId+2]),h=a.subtract(l),u=c.subtract(l);s=v.Cross(h,u)}const n=(o,a)=>{let l=o.getWorldMatrix();o.nonUniformScaling&&(L.Matrix[0].copyFrom(l),l=L.Matrix[0],l.setTranslationFromFloats(0,0,0),l.invert(),l.transposeToRef(L.Matrix[1]),l=L.Matrix[1]),v.TransformNormalToRef(a,l,a)};if(e&&n(this.pickedMesh,s),this.ray){const o=L.Vector3[0].copyFrom(s);e||n(this.pickedMesh,o),v.Dot(o,this.ray.direction)>0&&s.negateInPlace()}return s.normalize(),s}getTextureCoordinates(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(A.UVKind))return null;const e=this.pickedMesh.getIndices();if(!e)return null;const t=this.pickedMesh.getVerticesData(A.UVKind);if(!t)return null;let i=de.FromArray(t,2*e[3*this.faceId]),s=de.FromArray(t,2*e[3*this.faceId+1]),n=de.FromArray(t,2*e[3*this.faceId+2]);return i=i.scale(this.bu),s=s.scale(this.bv),n=n.scale(1-this.bu-this.bv),new de(i.x+s.x+n.x,i.y+s.y+n.y)}}class Zg{constructor(e){this._vertexBuffers={},this._scene=e}_prepareBuffers(){if(this._vertexBuffers[A.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[A.PositionKind]=new A(this._scene.getEngine(),e,A.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[A.PositionKind];!e||(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const i=this._scene.activeCamera;return!!(i&&(t=t||i._postProcesses.filter(s=>null!=s),t&&0!==t.length&&this._scene.postProcessesEnabled))&&(t[0].activate(i,e,null!=t),!0)}directRender(e,t=null,i=!1,s=0,n=0,o=!1){var a;const l=this._scene.getEngine();for(let c=0;c<e.length;c++){c<e.length-1?e[c+1].activate(this._scene.activeCamera,t?.texture):(t?l.bindFramebuffer(t,s,void 0,void 0,i,n):o||l.restoreDefaultFramebuffer(),null===(a=l._debugInsertMarker)||void 0===a||a.call(l,`post process ${e[c].name} output`));const h=e[c],u=h.apply();u&&(h.onBeforeRenderObservable.notifyObservers(u),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,u),l.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(u))}l.setDepthBuffer(!0),l.setDepthWrite(!0)}_finalizeFrame(e,t,i,s,n=!1){var o;const a=this._scene.activeCamera;if(!a||(0===(s=s||a._postProcesses.filter(c=>null!=c)).length||!this._scene.postProcessesEnabled))return;const l=this._scene.getEngine();for(let c=0,h=s.length;c<h;c++){const u=s[c];if(c<h-1?u._outputTexture=s[c+1].activate(a,t?.texture):(t?(l.bindFramebuffer(t,i,void 0,void 0,n),u._outputTexture=t):(l.restoreDefaultFramebuffer(),u._outputTexture=null),null===(o=l._debugInsertMarker)||void 0===o||o.call(l,`post process ${s[c].name} output`)),e)break;const d=u.apply();d&&(u.onBeforeRenderObservable.notifyObservers(d),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,d),l.drawElementsType(0,0,6),u.onAfterRenderObservable.notifyObservers(d))}l.setDepthBuffer(!0),l.setDepthWrite(!0),l.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[A.PositionKind];e&&(e.dispose(),this._vertexBuffers[A.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}class Fo{set opaqueSortCompareFn(e){this._opaqueSortCompareFn=e||Fo.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){this._alphaTestSortCompareFn=e||Fo.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){this._transparentSortCompareFn=e||Fo.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,i=null,s=null,n=null){this.index=e,this._opaqueSubMeshes=new ws(256),this._transparentSubMeshes=new ws(256),this._alphaTestSubMeshes=new ws(256),this._depthOnlySubMeshes=new ws(256),this._particleSystems=new ws(256),this._spriteManagers=new ws(256),this._empty=!0,this._edgesRenderers=new $l(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=s,this.transparentSortCompareFn=n}render(e,t,i,s){if(e)return void e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);const n=this._scene.getEngine();0!==this._depthOnlySubMeshes.length&&(n.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),n.setColorWrite(!0)),0!==this._opaqueSubMeshes.length&&this._renderOpaque(this._opaqueSubMeshes),0!==this._alphaTestSubMeshes.length&&this._renderAlphaTest(this._alphaTestSubMeshes);const o=n.getStencilBuffer();if(n.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(s),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),0!==this._transparentSubMeshes.length||this._scene.useOrderIndependentTransparency){if(n.setStencilBuffer(o),this._scene.useOrderIndependentTransparency){const a=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);a.length&&this._renderTransparent(a)}else this._renderTransparent(this._transparentSubMeshes);n.setAlphaMode(0)}if(n.setStencilBuffer(!1),this._edgesRenderers.length){for(let a=0;a<this._edgesRenderers.length;a++)this._edgesRenderers.data[a].render();n.setAlphaMode(0)}n.setStencilBuffer(o)}_renderOpaqueSorted(e){return Fo._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){return Fo._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){return Fo._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,i,s){let o,n=0;const a=i?i.globalPosition:Fo._ZeroVector;if(s)for(;n<e.length;n++)o=e.data[n],o._alphaIndex=o.getMesh().alphaIndex,o._distanceToCamera=v.Distance(o.getBoundingInfo().boundingSphere.centerWorld,a);const l=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&l.sort(t);const c=l[0].getMesh().getScene();for(n=0;n<l.length;n++)if(o=l[n],!c._activeMeshesFrozenButKeepClipping||o.isInFrustum(c._frustumPlanes)){if(s){const h=o.getMaterial();if(h&&h.needDepthPrePass){const u=h.getScene().getEngine();u.setColorWrite(!1),u.setAlphaMode(0),o.render(!1),u.setColorWrite(!0)}}o.render(s)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:Fo.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const i=e.getMesh(),s=t.getMesh();return i.material&&s.material?i.material.uniqueId-s.material.uniqueId:i.uniqueId-s.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,i){void 0===t&&(t=e.getMesh()),void 0===i&&(i=e.getMaterial()),null!=i&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(0===this._particleSystems.length)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){const s=this._particleSystems.data[i];if(0===(t&&t.layerMask&s.layerMask))continue;const n=s.emitter;(!n.position||!e||-1!==e.indexOf(n))&&this._scene._activeParticles.addCount(s.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||0===this._spriteManagers.length)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const i=this._spriteManagers.data[t];0!==(e&&e.layerMask&i.layerMask)&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}Fo._ZeroVector=v.Zero();class Gie{}let Jg=(()=>{class r{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(t){if(t!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=t,!this._maintainStateBetweenFrames)){for(const i of this._scene.meshes)if(i.subMeshes)for(const s of i.subMeshes)s._wasDispatched=!1;if(this._scene.spriteManagers)for(const i of this._scene.spriteManagers)i._wasDispatched=!1;for(const i of this._scene.particleSystems)i._wasDispatched=!1}}constructor(t){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new Gie,this._maintainStateBetweenFrames=!1,this._scene=t;for(let i=r.MIN_RENDERINGGROUPS;i<r.MAX_RENDERINGGROUPS;i++)this._autoClearDepthStencil[i]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(t){const i=t||0;return this._prepareRenderingGroup(i),this._renderingGroups[i]}_clearDepthStencilBuffer(t=!0,i=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,t,i),this._depthStencilBufferAlreadyCleaned=!0)}render(t,i,s,n){const o=this._renderingGroupInfo;if(o.scene=this._scene,o.camera=this._scene.activeCamera,this._scene.spriteManagers&&n)for(let a=0;a<this._scene.spriteManagers.length;a++)this.dispatchSprites(this._scene.spriteManagers[a]);for(let a=r.MIN_RENDERINGGROUPS;a<r.MAX_RENDERINGGROUPS;a++){this._depthStencilBufferAlreadyCleaned=a===r.MIN_RENDERINGGROUPS;const l=this._renderingGroups[a];if(!l||l._empty)continue;const c=Math.pow(2,a);if(o.renderingGroupId=a,this._scene.onBeforeRenderingGroupObservable.notifyObservers(o,c),r.AUTOCLEAR){const h=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(a):this._autoClearDepthStencil[a];h&&h.autoClear&&this._clearDepthStencilBuffer(h.depth,h.stencil)}for(const h of this._scene._beforeRenderingGroupDrawStage)h.action(a);l.render(t,n,s,i);for(const h of this._scene._afterRenderingGroupDrawStage)h.action(a);this._scene.onAfterRenderingGroupObservable.notifyObservers(o,c)}}reset(){if(!this.maintainStateBetweenFrames)for(let t=r.MIN_RENDERINGGROUPS;t<r.MAX_RENDERINGGROUPS;t++){const i=this._renderingGroups[t];i&&i.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let t=r.MIN_RENDERINGGROUPS;t<r.MAX_RENDERINGGROUPS;t++){const i=this._renderingGroups[t];i&&i.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let t=r.MIN_RENDERINGGROUPS;t<r.MAX_RENDERINGGROUPS;t++){const i=this._renderingGroups[t];i&&i.dispose()}}_prepareRenderingGroup(t){void 0===this._renderingGroups[t]&&(this._renderingGroups[t]=new Fo(t,this._scene,this._customOpaqueSortCompareFn[t],this._customAlphaTestSortCompareFn[t],this._customTransparentSortCompareFn[t]))}dispatchSprites(t){this.maintainStateBetweenFrames&&t._wasDispatched||(t._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatchSprites(t))}dispatchParticles(t){this.maintainStateBetweenFrames&&t._wasDispatched||(t._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatchParticles(t))}dispatch(t,i,s){void 0===i&&(i=t.getMesh()),(!this.maintainStateBetweenFrames||!t._wasDispatched)&&(t._wasDispatched=!0,this.getRenderingGroup(i.renderingGroupId).dispatch(t,i,s))}setRenderingOrder(t,i=null,s=null,n=null){if(this._customOpaqueSortCompareFn[t]=i,this._customAlphaTestSortCompareFn[t]=s,this._customTransparentSortCompareFn[t]=n,this._renderingGroups[t]){const o=this._renderingGroups[t];o.opaqueSortCompareFn=this._customOpaqueSortCompareFn[t],o.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[t],o.transparentSortCompareFn=this._customTransparentSortCompareFn[t]}}setRenderingAutoClearDepthStencil(t,i,s=!0,n=!0){this._autoClearDepthStencil[t]={autoClear:i,depth:s,stencil:n}}getAutoClearDepthStencilSetup(t){return this._autoClearDepthStencil[t]}}return r.MAX_RENDERINGGROUPS=4,r.MIN_RENDERINGGROUPS=0,r.AUTOCLEAR=!0,r})(),Me=(()=>{class r{}return r.NAME_EFFECTLAYER="EffectLayer",r.NAME_LAYER="Layer",r.NAME_LENSFLARESYSTEM="LensFlareSystem",r.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",r.NAME_PARTICLESYSTEM="ParticleSystem",r.NAME_GAMEPAD="Gamepad",r.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",r.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",r.NAME_PREPASSRENDERER="PrePassRenderer",r.NAME_DEPTHRENDERER="DepthRenderer",r.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",r.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",r.NAME_SPRITE="Sprite",r.NAME_SUBSURFACE="SubSurface",r.NAME_OUTLINERENDERER="Outline",r.NAME_PROCEDURALTEXTURE="ProceduralTexture",r.NAME_SHADOWGENERATOR="ShadowGenerator",r.NAME_OCTREE="Octree",r.NAME_PHYSICSENGINE="PhysicsEngine",r.NAME_AUDIO="Audio",r.NAME_FLUIDRENDERER="FluidRenderer",r.STEP_ISREADYFORMESH_EFFECTLAYER=0,r.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,r.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,r.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,r.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,r.STEP_BEFORECAMERADRAW_PREPASS=0,r.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,r.STEP_BEFORECAMERADRAW_LAYER=2,r.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,r.STEP_BEFORERENDERTARGETDRAW_LAYER=1,r.STEP_BEFORERENDERINGMESH_PREPASS=0,r.STEP_BEFORERENDERINGMESH_OUTLINE=1,r.STEP_AFTERRENDERINGMESH_PREPASS=0,r.STEP_AFTERRENDERINGMESH_OUTLINE=1,r.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,r.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,r.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,r.STEP_BEFORECAMERAUPDATE_GAMEPAD=1,r.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,r.STEP_BEFORECLEAR_PREPASS=1,r.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,r.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,r.STEP_AFTERRENDERTARGETDRAW_LAYER=1,r.STEP_AFTERCAMERADRAW_PREPASS=0,r.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,r.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,r.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,r.STEP_AFTERCAMERADRAW_LAYER=4,r.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,r.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,r.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,r.STEP_AFTERRENDER_AUDIO=0,r.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,r.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,r.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,r.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,r.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,r.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,r.STEP_POINTERMOVE_SPRITE=0,r.STEP_POINTERDOWN_SPRITE=0,r.STEP_POINTERUP_SPRITE=0,r})();class ki extends Array{constructor(e){super(...e)}static Create(){return Object.create(ki.prototype)}registerStep(e,t,i){let s=0,n=Number.MAX_VALUE;for(;s<this.length&&(n=this[s].index,!(e<n));s++);this.splice(s,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}let Re=(()=>{class r{}return r.POINTERDOWN=1,r.POINTERUP=2,r.POINTERMOVE=4,r.POINTERWHEEL=8,r.POINTERPICK=16,r.POINTERTAP=32,r.POINTERDOUBLETAP=64,r})();class u1{constructor(e,t){this.type=e,this.event=t}}class zie extends u1{constructor(e,t,i,s){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new de(i,s)}}class uo extends u1{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,s=null){super(e,t),this._pickInfo=i,this._inputManager=s}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}let Gu=(()=>{class r{}return r.KEYDOWN=1,r.KEYUP=2,r})();class _E{constructor(e,t){this.type=e,this.event=t}}class d1 extends _E{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}var Oe=(()=>{return(r=Oe||(Oe={}))[r.Generic=0]="Generic",r[r.Keyboard=1]="Keyboard",r[r.Mouse=2]="Mouse",r[r.Touch=3]="Touch",r[r.DualShock=4]="DualShock",r[r.Xbox=5]="Xbox",r[r.Switch=6]="Switch",r[r.DualSense=7]="DualSense",Oe;var r})(),qe=(()=>{return(r=qe||(qe={}))[r.Horizontal=0]="Horizontal",r[r.Vertical=1]="Vertical",r[r.LeftClick=2]="LeftClick",r[r.MiddleClick=3]="MiddleClick",r[r.RightClick=4]="RightClick",r[r.BrowserBack=5]="BrowserBack",r[r.BrowserForward=6]="BrowserForward",r[r.MouseWheelX=7]="MouseWheelX",r[r.MouseWheelY=8]="MouseWheelY",r[r.MouseWheelZ=9]="MouseWheelZ",r[r.Move=12]="Move",qe;var r})(),fp=(()=>{return(r=fp||(fp={}))[r.Horizontal=0]="Horizontal",r[r.Vertical=1]="Vertical",r[r.LeftClick=2]="LeftClick",r[r.MiddleClick=3]="MiddleClick",r[r.RightClick=4]="RightClick",r[r.BrowserBack=5]="BrowserBack",r[r.BrowserForward=6]="BrowserForward",r[r.MouseWheelX=7]="MouseWheelX",r[r.MouseWheelY=8]="MouseWheelY",r[r.MouseWheelZ=9]="MouseWheelZ",r[r.DeltaHorizontal=10]="DeltaHorizontal",r[r.DeltaVertical=11]="DeltaVertical",fp;var r})();let mE=(()=>{class r{}return r.DOM_DELTA_PIXEL=0,r.DOM_DELTA_LINE=1,r.DOM_DELTA_PAGE=2,r})();class Jc{static CreateDeviceEvent(e,t,i,s,n,o,a){switch(e){case Oe.Keyboard:return this._CreateKeyboardEvent(i,s,n,o);case Oe.Mouse:if(i===qe.MouseWheelX||i===qe.MouseWheelY||i===qe.MouseWheelZ)return this._CreateWheelEvent(e,t,i,s,n,o);case Oe.Touch:return this._CreatePointerEvent(e,t,i,s,n,o,a);default:throw`Unable to generate event for device ${Oe[e]}`}}static _CreatePointerEvent(e,t,i,s,n,o,a){const l=this._CreateMouseEvent(e,t,i,s,n,o);return e===Oe.Mouse?(l.deviceType=Oe.Mouse,l.pointerId=1,l.pointerType="mouse"):(l.deviceType=Oe.Touch,l.pointerId=a??t,l.pointerType="touch"),i===qe.Move?l.type="pointermove":i>=qe.LeftClick&&i<=qe.RightClick&&(l.type=1===s?"pointerdown":"pointerup",l.button=i-2),l}static _CreateWheelEvent(e,t,i,s,n,o){const a=this._CreateMouseEvent(e,t,i,s,n,o);switch(a.type="wheel",a.deltaMode=mE.DOM_DELTA_PIXEL,a.deltaX=0,a.deltaY=0,a.deltaZ=0,i){case qe.MouseWheelX:a.deltaX=s;break;case qe.MouseWheelY:a.deltaY=s;break;case qe.MouseWheelZ:a.deltaZ=s}return a}static _CreateMouseEvent(e,t,i,s,n,o){const a=this._CreateEvent(o),l=n.pollInput(e,t,qe.Horizontal),c=n.pollInput(e,t,qe.Vertical);return o?(a.movementX=0,a.movementY=0,a.offsetX=a.movementX-o.getBoundingClientRect().x,a.offsetY=a.movementY-o.getBoundingClientRect().y):(a.movementX=n.pollInput(e,t,fp.DeltaHorizontal),a.movementY=n.pollInput(e,t,fp.DeltaVertical),a.offsetX=0,a.offsetY=0),this._CheckNonCharacterKeys(a,n),a.clientX=l,a.clientY=c,a.x=l,a.y=c,a.deviceType=e,a.deviceSlot=t,a.inputIndex=i,a}static _CreateKeyboardEvent(e,t,i,s){const n=this._CreateEvent(s);return this._CheckNonCharacterKeys(n,i),n.deviceType=Oe.Keyboard,n.deviceSlot=0,n.inputIndex=e,n.type=1===t?"keydown":"keyup",n.key=String.fromCharCode(e),n.keyCode=e,n}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(Oe.Keyboard),s=i&&1===t.pollInput(Oe.Keyboard,0,18),n=i&&1===t.pollInput(Oe.Keyboard,0,17),o=i&&(1===t.pollInput(Oe.Keyboard,0,91)||1===t.pollInput(Oe.Keyboard,0,92)||1===t.pollInput(Oe.Keyboard,0,93)),a=i&&1===t.pollInput(Oe.Keyboard,0,16);e.altKey=s,e.ctrlKey=n,e.metaKey=o,e.shiftKey=a}static _CreateEvent(e){const t={preventDefault:()=>{}};return t.target=e,t}}class Hie{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(s,n,o,a)=>{const l=Jc.CreateDeviceEvent(s,n,o,a,this);i(s,n,l)}):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===Oe.Mouse||e===Oe.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}const p1=Object.keys(qe).length/2;class Wie{constructor(e,t,i,s){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=q.IsSafari(),this._usingMacOS=nE()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=n=>{},this._keyboardUpEvent=n=>{},this._keyboardBlurEvent=n=>{},this._pointerMoveEvent=n=>{},this._pointerDownEvent=n=>{},this._pointerUpEvent=n=>{},this._pointerCancelEvent=n=>{},this._pointerWheelEvent=n=>{},this._pointerBlurEvent=n=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=oE.IsNavigatorAvailable()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Firefox"),this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=n=>{},this._gamepadDisconnectedEvent=n=>{},this._eventPrefix=q.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=s,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){const s=this._inputs[e][t];if(!s)throw`Unable to find device ${Oe[e]}`;e>=Oe.DualShock&&e<=Oe.DualSense&&this._updateDevice(e,t,i);const n=s[i];if(void 0===n)throw`Unable to find input ${i} for device ${Oe[e]} in slot ${t}`;return i===qe.Move&&q.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),n}isDeviceAvailable(e){return void 0!==this._inputs[e]}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=null==this?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs)for(const t of this._inputs)if(t)for(const i in t){const n=t[+i];if(n)for(let o=0;o<n.length;o++)n[o]=0}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=-1!==this._elementToAttachTo.tabIndex?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}"function"==typeof matchMedia&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(Oe.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,s){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,p1);const n=this._inputs[e][t];n[0]=i,n[1]=s}_registerDevice(e,t,i){if(void 0===t)throw`Unable to register device ${Oe[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const s=new Array(i);s.fill(0),this._inputs[e][t]=s,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Oe.Keyboard,0,255));const t=this._inputs[Oe.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&"Meta"!==e.key&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(Oe.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Oe.Keyboard,0,255));const t=this._inputs[Oe.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOS&&"Meta"===e.key&&this._metaKeys.length>0){for(const s of this._metaKeys){const n=Jc.CreateDeviceEvent(Oe.Keyboard,0,s,0,this,this._elementToAttachTo);t[s]=0,this._onInputChanged(Oe.Keyboard,0,n)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(Oe.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[Oe.Keyboard][0];for(let t=0;t<e.length;t++)if(0!==e[t]){e[t]=0;const i=Jc.CreateDeviceEvent(Oe.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(Oe.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=oE.IsNavigatorAvailable()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let i=0;i<this._maxTouchPoints;i++)this._activeTouchIds[i]=-1;this._pointerMoveEvent=i=>{const s=this._getPointerType(i),n=s===Oe.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);this._inputs[s]||(this._inputs[s]={}),this._inputs[s][n]||this._addPointerDevice(s,n,i.clientX,i.clientY);const o=this._inputs[s][n];if(o){const a=i;a.inputIndex=qe.Move,o[qe.Horizontal]=i.clientX,o[qe.Vertical]=i.clientY,this._onInputChanged(s,n,a),!this._usingSafari&&-1!==i.button&&(a.inputIndex=i.button+2,o[i.button+2]=o[i.button+2]?0:1,this._onInputChanged(s,n,a))}},this._pointerDownEvent=i=>{const s=this._getPointerType(i);let n=s===Oe.Mouse?0:i.pointerId;if(s===Oe.Touch){const a=this._activeTouchIds.indexOf(-1);if(!(a>=0))return void q.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);n=a,this._activeTouchIds[a]=i.pointerId}this._inputs[s]||(this._inputs[s]={}),this._inputs[s][n]?s===Oe.Touch&&this._onDeviceConnected(s,n):this._addPointerDevice(s,n,i.clientX,i.clientY);const o=this._inputs[s][n];if(o){const a=o[qe.Horizontal],l=o[qe.Vertical];if(s===Oe.Mouse){if(-1===this._mouseId&&(this._mouseId=void 0===i.pointerId?this._isUsingFirefox?0:1:i.pointerId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch{}}else if(i.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(i.pointerId)}catch{}o[qe.Horizontal]=i.clientX,o[qe.Vertical]=i.clientY,o[i.button+2]=1;const c=i;c.inputIndex=i.button+2,this._onInputChanged(s,n,c),(a!==i.clientX||l!==i.clientY)&&(c.inputIndex=qe.Move,this._onInputChanged(s,n,c))}},this._pointerUpEvent=i=>{var s,n,o,a,l;const c=this._getPointerType(i),h=c===Oe.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(c===Oe.Touch){if(-1===h)return;this._activeTouchIds[h]=-1}const u=null===(s=this._inputs[c])||void 0===s?void 0:s[h];if(u&&0!==u[i.button+2]){const d=u[qe.Horizontal],f=u[qe.Vertical];u[qe.Horizontal]=i.clientX,u[qe.Vertical]=i.clientY,u[i.button+2]=0;const p=i;(d!==i.clientX||f!==i.clientY)&&(p.inputIndex=qe.Move,this._onInputChanged(c,h,p)),p.inputIndex=i.button+2,c===Oe.Mouse&&this._mouseId>=0&&(null===(o=(n=this._elementToAttachTo).hasPointerCapture)||void 0===o?void 0:o.call(n,this._mouseId))?this._elementToAttachTo.releasePointerCapture(this._mouseId):i.pointerId&&(null===(l=(a=this._elementToAttachTo).hasPointerCapture)||void 0===l?void 0:l.call(a,i.pointerId))&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._onInputChanged(c,h,p),c===Oe.Touch&&this._onDeviceDisconnected(c,h)}},this._pointerCancelEvent=i=>{var s,n,o,a;if("mouse"===i.pointerType){const l=this._inputs[Oe.Mouse][0];this._mouseId>=0&&(null===(n=(s=this._elementToAttachTo).hasPointerCapture)||void 0===n?void 0:n.call(s,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let c=qe.LeftClick;c<=qe.BrowserForward;c++)if(1===l[c]){l[c]=0;const h=Jc.CreateDeviceEvent(Oe.Mouse,0,c,0,this,this._elementToAttachTo);this._onInputChanged(Oe.Mouse,0,h)}}else{const l=this._activeTouchIds.indexOf(i.pointerId);!(null===(a=(o=this._elementToAttachTo).hasPointerCapture)||void 0===a)&&a.call(o,i.pointerId)&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._inputs[Oe.Touch][l][qe.LeftClick]=0;const c=Jc.CreateDeviceEvent(Oe.Touch,l,qe.LeftClick,0,this,this._elementToAttachTo,i.pointerId);this._onInputChanged(Oe.Touch,l,c),this._activeTouchIds[l]=-1,this._onDeviceDisconnected(Oe.Touch,l)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch{}this._pointerBlurEvent=()=>{var i,s,n,o,a;if(this.isDeviceAvailable(Oe.Mouse)){const l=this._inputs[Oe.Mouse][0];this._mouseId>=0&&(null===(s=(i=this._elementToAttachTo).hasPointerCapture)||void 0===s?void 0:s.call(i,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let c=qe.LeftClick;c<=qe.BrowserForward;c++)if(1===l[c]){l[c]=0;const h=Jc.CreateDeviceEvent(Oe.Mouse,0,c,0,this,this._elementToAttachTo);this._onInputChanged(Oe.Mouse,0,h)}}if(this.isDeviceAvailable(Oe.Touch)){const l=this._inputs[Oe.Touch];for(let c=0;c<this._activeTouchIds.length;c++){const h=this._activeTouchIds[c];if(!(null===(o=(n=this._elementToAttachTo).hasPointerCapture)||void 0===o)&&o.call(n,h)&&this._elementToAttachTo.releasePointerCapture(h),-1!==h&&1===(null===(a=l[c])||void 0===a?void 0:a[qe.LeftClick])){l[c][qe.LeftClick]=0;const u=Jc.CreateDeviceEvent(Oe.Touch,c,qe.LeftClick,0,this,this._elementToAttachTo,h);this._onInputChanged(Oe.Touch,c,u),this._activeTouchIds[c]=-1,this._onDeviceDisconnected(Oe.Touch,c)}}}},this._pointerWheelEvent=i=>{const s=Oe.Mouse;this._inputs[s]||(this._inputs[s]=[]),this._inputs[s][0]||(this._pointerActive=!0,this._registerDevice(s,0,p1));const o=this._inputs[s][0];if(o){o[qe.MouseWheelX]=i.deltaX||0,o[qe.MouseWheelY]=i.deltaY||i.wheelDelta||0,o[qe.MouseWheelZ]=i.deltaZ||0;const a=i;0!==o[qe.MouseWheelX]&&(a.inputIndex=qe.MouseWheelX,this._onInputChanged(s,0,a)),0!==o[qe.MouseWheelY]&&(a.inputIndex=qe.MouseWheelY,this._onInputChanged(s,0,a)),0!==o[qe.MouseWheelZ]&&(a.inputIndex=qe.MouseWheelZ,this._onInputChanged(s,0,a))}},this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,!!e&&{passive:!1}),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(Oe.Mouse)){const i=this._inputs[Oe.Mouse][0];i[qe.MouseWheelX]=0,i[qe.MouseWheelY]=0,i[qe.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){const s=navigator.getGamepads()[t];if(s&&e===this._gamepads[t]){this._inputs[e][t][i]=i>=s.buttons.length?s.axes[i-s.buttons.length].valueOf():s.buttons[i].value}}_getGamepadDeviceType(e){return-1!==e.indexOf("054c")?-1!==e.indexOf("0ce6")?Oe.DualSense:Oe.DualShock:-1!==e.indexOf("Xbox One")||-1!==e.search("Xbox 360")||-1!==e.search("xinput")?Oe.Xbox:-1!==e.indexOf("057e")?Oe.Switch:Oe.Generic}_getPointerType(e){let t=Oe.Mouse;return("touch"===e.pointerType||"pen"===e.pointerType||e.touches)&&(t=Oe.Touch),t}}class _1{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new z,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}class Xie{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=o=>{for(let a=0;a<this._devices.length;a++){const l=this._devices[a];for(const c in l)o._addDevice(new _1(this._deviceInputSystem,a,+c))}this._registeredManagers.push(o)},this.unregisterManager=o=>{const a=this._registeredManagers.indexOf(o);a>-1&&this._registeredManagers.splice(a,1)};const t=Object.keys(Oe).length/2;this._devices=new Array(t);const i=(o,a)=>{this._devices[o]||(this._devices[o]=new Array),this._devices[o][a]||(this._devices[o][a]=a);for(const l of this._registeredManagers){const c=new _1(this._deviceInputSystem,o,a);l._addDevice(c)}},s=(o,a)=>{var l;null!==(l=this._devices[o])&&void 0!==l&&l[a]&&delete this._devices[o][a];for(const c of this._registeredManagers)c._removeDevice(o,a)},n=(o,a,l)=>{if(l)for(const c of this._registeredManagers)c._onInputChanged(o,a,l)};this._deviceInputSystem=typeof _native<"u"?new Hie(i,s,n):new Wie(e,i,s,n)}dispose(){this._deviceInputSystem.dispose()}}class jie{getDeviceSource(e,t){if(void 0===t){if(void 0===this._firstDevice[e])return null;t=this._firstDevice[e]}return this._devices[e]&&void 0!==this._devices[e][t]?this._devices[e][t]:null}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(t=>!!t):[]}constructor(e){const t=Object.keys(Oe).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new Xie(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new z(i=>{for(const s of this._devices)if(s)for(const n of s)n&&this.onDeviceConnectedObservable.notifyObserver(i,n)}),this.onDeviceDisconnectedObservable=new z,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){var i,s;const n=null===(i=this._devices[e])||void 0===i?void 0:i[t];this.onDeviceDisconnectedObservable.notifyObservers(n),!(null===(s=this._devices[e])||void 0===s)&&s[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){var s,n;null===(n=null===(s=this._devices[e])||void 0===s?void 0:s[t])||void 0===n||n.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case Oe.Keyboard:case Oe.Mouse:this._firstDevice[e]=0;break;case Oe.Touch:case Oe.DualSense:case Oe.DualShock:case Oe.Xbox:case Oe.Switch:case Oe.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t)for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}break}}}}class m1{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}}let $a=(()=>{class r{constructor(t){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new de(0,0),this._previousStartingPointerPosition=new de(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=t||be.LastCreatedScene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(t){return this._meshUnderPointerId[t]||null}get unTranslatedPointer(){return new de(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(t){this._pointerX=t}get pointerY(){return this._pointerY}set pointerY(t){this._pointerY=t}_updatePointerPosition(t){const i=this._scene.getEngine().getInputElementClientRect();!i||(this._pointerX=t.clientX-i.left,this._pointerY=t.clientY-i.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(t,i){const s=this._scene,n=s.getEngine(),o=n.getInputElement();o&&(o.tabIndex=n.canvasTabIndex,s.doNotHandleCursors||(o.style.cursor=s.defaultCursor)),this._setCursorAndPointerOverMesh(t,i,s);for(const c of s._pointerMoveStage)t=c.action(this._unTranslatedPointerX,this._unTranslatedPointerY,t,!!t?.pickedMesh,o);const a=i.inputIndex>=qe.MouseWheelX&&i.inputIndex<=qe.MouseWheelZ?Re.POINTERWHEEL:Re.POINTERMOVE;let l;s.onPointerMove&&(t=t||this._pickMove(i),s.onPointerMove(i,t,a)),t?(l=new uo(a,i,t),this._setRayOnPointerInfo(t,i)):(l=new uo(a,i,null,this),this._movePointerInfo=l),s.onPointerObservable.hasObservers()&&s.onPointerObservable.notifyObservers(l,a)}_setRayOnPointerInfo(t,i){const s=this._scene;t&&s._pickingAvailable&&(t.ray||(t.ray=s.createPickingRay(i.offsetX,i.offsetY,F.Identity(),s.activeCamera)))}_addCameraPointerObserver(t,i){return this._cameraObserverCount++,this._scene.onPointerObservable.add(t,i)}_removeCameraPointerObserver(t){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(t)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(t,i,s){const n=this._scene,o=new zie(s,i,this._unTranslatedPointerX,this._unTranslatedPointerY);return t&&(o.originalPickingInfo=t,o.ray=t.ray,t.originMesh&&(o.nearInteractionPickingInfo=t)),n.onPrePointerObservable.notifyObservers(o,s),!!o.skipOnPointerObservable}_pickMove(t){const i=this._scene,s=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,i.pointerMovePredicate,!1,i.cameraToUseForPointers,i.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(s,t,i),s}_setCursorAndPointerOverMesh(t,i,s){const o=s.getEngine().getInputElement();if(t?.pickedMesh){if(this.setPointerOverMesh(t.pickedMesh,i.pointerId,t,i),!s.doNotHandleCursors&&o&&this._pointerOverMesh){const a=this._pointerOverMesh._getActionManagerForTrigger();a&&a.hasPointerTriggers&&(o.style.cursor=a.hoverCursor||s.hoverCursor)}}else this.setPointerOverMesh(null,i.pointerId,t,i)}simulatePointerMove(t,i){const s=new PointerEvent("pointermove",i);s.inputIndex=qe.Move,!this._checkPrePointerObservable(t,s,Re.POINTERMOVE)&&this._processPointerMove(t,s)}simulatePointerDown(t,i){const s=new PointerEvent("pointerdown",i);s.inputIndex=s.button+2,!this._checkPrePointerObservable(t,s,Re.POINTERDOWN)&&this._processPointerDown(t,s)}_processPointerDown(t,i){const s=this._scene;if(t?.pickedMesh){this._pickedDownMesh=t.pickedMesh;const a=t.pickedMesh._getActionManagerForTrigger();if(a){if(a.hasPickTriggers)switch(a.processTrigger(5,gi.CreateNew(t.pickedMesh,i)),i.button){case 0:a.processTrigger(2,gi.CreateNew(t.pickedMesh,i));break;case 1:a.processTrigger(4,gi.CreateNew(t.pickedMesh,i));break;case 2:a.processTrigger(3,gi.CreateNew(t.pickedMesh,i))}a.hasSpecificTrigger(8)&&window.setTimeout(()=>{const l=s.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,c=>c.isPickable&&c.isVisible&&c.isReady()&&c.actionManager&&c.actionManager.hasSpecificTrigger(8)&&c===this._pickedDownMesh,!1,s.cameraToUseForPointers);l?.pickedMesh&&a&&0!==this._totalPointersPressed&&Date.now()-this._startingPointerTime>r.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,a.processTrigger(8,gi.CreateNew(l.pickedMesh,i)))},r.LongPressDelay)}}else for(const a of s._pointerDownStage)t=a.action(this._unTranslatedPointerX,this._unTranslatedPointerY,t,i,!1);let n;const o=Re.POINTERDOWN;t?(s.onPointerDown&&s.onPointerDown(i,t,o),n=new uo(o,i,t),this._setRayOnPointerInfo(t,i)):n=new uo(o,i,null,this),s.onPointerObservable.hasObservers()&&s.onPointerObservable.notifyObservers(n,o)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(t,i,s){const n=new PointerEvent("pointerup",i);n.inputIndex=qe.Move;const o=new m1;s?o.doubleClick=!0:o.singleClick=!0,!this._checkPrePointerObservable(t,n,Re.POINTERUP)&&this._processPointerUp(t,n,o)}_processPointerUp(t,i,s){const n=this._scene;if(t?.pickedMesh){if(this._pickedUpMesh=t.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(n.onPointerPick&&n.onPointerPick(i,t),s.singleClick&&!s.ignore&&n.onPointerObservable.observers.length>this._cameraObserverCount)){const a=Re.POINTERPICK,l=new uo(a,i,t);this._setRayOnPointerInfo(t,i),n.onPointerObservable.notifyObservers(l,a)}const o=t.pickedMesh._getActionManagerForTrigger();if(o&&!s.ignore){o.processTrigger(7,gi.CreateNew(t.pickedMesh,i,t)),!s.hasSwiped&&s.singleClick&&o.processTrigger(1,gi.CreateNew(t.pickedMesh,i,t));const a=t.pickedMesh._getActionManagerForTrigger(6);s.doubleClick&&a&&a.processTrigger(6,gi.CreateNew(t.pickedMesh,i,t))}}else if(!s.ignore)for(const o of n._pointerUpStage)t=o.action(this._unTranslatedPointerX,this._unTranslatedPointerY,t,i,s.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const o=this._pickedDownMesh._getActionManagerForTrigger(16);o&&o.processTrigger(16,gi.CreateNew(this._pickedDownMesh,i))}if(!s.ignore){const o=new uo(Re.POINTERUP,i,t);if(this._setRayOnPointerInfo(t,i),n.onPointerObservable.notifyObservers(o,Re.POINTERUP),n.onPointerUp&&n.onPointerUp(i,t,Re.POINTERUP),!s.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let a=0;if(s.singleClick?a=Re.POINTERTAP:s.doubleClick&&(a=Re.POINTERDOUBLETAP),a){const l=new uo(a,i,t);n.onPointerObservable.hasObservers()&&n.onPointerObservable.hasSpecificMask(a)&&n.onPointerObservable.notifyObservers(l,a)}}}}isPointerCaptured(t=0){return this._pointerCaptures[t]}attachControl(t=!0,i=!0,s=!0,n=null){const o=this._scene,a=o.getEngine();n||(n=a.getInputElement()),this._alreadyAttached&&this.detachControl(),n&&(this._alreadyAttachedTo=n),this._deviceSourceManager=new jie(a),this._initActionManager=l=>{if(!this._meshPickProceed){const c=o.skipPointerUpPicking||0===o._registeredActions&&!this._checkForPicking()&&!o.onPointerUp?null:o.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,o.pointerUpPredicate,!1,o.cameraToUseForPointers);this._currentPickResult=c,c&&(l=c.hit&&c.pickedMesh?c.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return l},this._delayedSimpleClick=(l,c,h)=>{if((Date.now()-this._previousStartingPointerTime>r.DoubleClickDelay&&!this._doubleClickOccured||l!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,c.singleClick=!0,c.ignore=!1,this._delayedClicks[l])){const d=Re.POINTERTAP,f=new uo(d,this._delayedClicks[l].evt,this._currentPickResult);o.onPointerObservable.hasObservers()&&o.onPointerObservable.hasSpecificMask(d)&&o.onPointerObservable.notifyObservers(f,d),this._delayedClicks[l]=null}},this._initClickEvent=(l,c,h,u)=>{var d,f;const p=new m1;this._currentPickResult=null;let _=null,m=l.hasSpecificMask(Re.POINTERPICK)||c.hasSpecificMask(Re.POINTERPICK)||l.hasSpecificMask(Re.POINTERTAP)||c.hasSpecificMask(Re.POINTERTAP)||l.hasSpecificMask(Re.POINTERDOUBLETAP)||c.hasSpecificMask(Re.POINTERDOUBLETAP);!m&&Ou&&(_=this._initActionManager(_,p),_&&(m=_.hasPickTriggers));let g=!1;if(m){const b=h.button;if(p.hasSwiped=this._isPointerSwiping(),!p.hasSwiped){let y=!r.ExclusiveDoubleClickMode;if(y||(y=!l.hasSpecificMask(Re.POINTERDOUBLETAP)&&!c.hasSpecificMask(Re.POINTERDOUBLETAP),y&&!Ou.HasSpecificTrigger(6)&&(_=this._initActionManager(_,p),_&&(y=!_.hasSpecificTrigger(6)))),y)(Date.now()-this._previousStartingPointerTime>r.DoubleClickDelay||b!==this._previousButtonPressed)&&(p.singleClick=!0,u(p,this._currentPickResult),g=!0);else{const x={evt:h,clickInfo:p,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,b,p,u),r.DoubleClickDelay)};this._delayedClicks[b]=x}let T=l.hasSpecificMask(Re.POINTERDOUBLETAP)||c.hasSpecificMask(Re.POINTERDOUBLETAP);!T&&Ou.HasSpecificTrigger(6)&&(_=this._initActionManager(_,p),_&&(T=_.hasSpecificTrigger(6))),T&&(b===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<r.DoubleClickDelay&&!this._doubleClickOccured?(p.hasSwiped||this._isPointerSwiping()?(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=b,r.ExclusiveDoubleClickMode?(this._delayedClicks[b]&&(clearTimeout(null===(f=this._delayedClicks[b])||void 0===f?void 0:f.timeoutId),this._delayedClicks[b]=null),u(p,this._previousPickResult)):u(p,this._currentPickResult)):(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,p.doubleClick=!0,p.ignore=!1,r.ExclusiveDoubleClickMode&&this._delayedClicks[b]&&(clearTimeout(null===(d=this._delayedClicks[b])||void 0===d?void 0:d.timeoutId),this._delayedClicks[b]=null),u(p,this._currentPickResult)),g=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=b))}}g||u(p,this._currentPickResult)},this._onPointerMove=l=>{if(void 0===l.pointerId&&(l.pointerId=0),this._updatePointerPosition(l),!this._isSwiping&&-1!==this._swipeButtonPressed&&(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>r.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>r.DragMovementThreshold),this._checkPrePointerObservable(null,l,l.inputIndex>=qe.MouseWheelX&&l.inputIndex<=qe.MouseWheelZ?Re.POINTERWHEEL:Re.POINTERMOVE)||!o.cameraToUseForPointers&&!o.activeCamera)return;if(o.skipPointerMovePicking)return void this._processPointerMove(new Os,l);o.pointerMovePredicate||(o.pointerMovePredicate=h=>h.isPickable&&h.isVisible&&h.isReady()&&h.isEnabled()&&(h.enablePointerMoveEvents||o.constantlyUpdateMeshUnderPointer||null!==h._getActionManagerForTrigger())&&(!o.cameraToUseForPointers||0!=(o.cameraToUseForPointers.layerMask&h.layerMask)));const c=o._registeredActions>0?this._pickMove(l):null;this._processPointerMove(c,l)},this._onPointerDown=l=>{var c;if(this._totalPointersPressed++,this._pickedDownMesh=null,this._meshPickProceed=!1,void 0===l.pointerId&&(l.pointerId=0),r.ExclusiveDoubleClickMode)for(let u=0;u<this._delayedClicks.length;u++)if(this._delayedClicks[u])if(l.button===u)clearTimeout(null===(c=this._delayedClicks[u])||void 0===c?void 0:c.timeoutId);else{const d=this._delayedClicks[u].clickInfo;this._doubleClickOccured=!1,d.singleClick=!0,d.ignore=!1;const p=Re.POINTERTAP,_=new uo(p,this._delayedClicks[u].evt,this._currentPickResult);o.onPointerObservable.hasObservers()&&o.onPointerObservable.hasSpecificMask(p)&&o.onPointerObservable.notifyObservers(_,p),this._delayedClicks[u]=null}if(this._updatePointerPosition(l),-1===this._swipeButtonPressed&&(this._swipeButtonPressed=l.button),o.preventDefaultOnPointerDown&&n&&(l.preventDefault(),n.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,l,Re.POINTERDOWN)||!o.cameraToUseForPointers&&!o.activeCamera)return;let h;this._pointerCaptures[l.pointerId]=!0,o.pointerDownPredicate||(o.pointerDownPredicate=u=>u.isPickable&&u.isVisible&&u.isReady()&&u.isEnabled()&&(!o.cameraToUseForPointers||0!=(o.cameraToUseForPointers.layerMask&u.layerMask))),this._pickedDownMesh=null,h=o.skipPointerDownPicking||0===o._registeredActions&&!this._checkForPicking()&&!o.onPointerDown?new Os:o.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,o.pointerDownPredicate,!1,o.cameraToUseForPointers),this._processPointerDown(h,l)},this._onPointerUp=l=>{0!==this._totalPointersPressed&&(this._totalPointersPressed--,this._pickedUpMesh=null,this._meshPickProceed=!1,void 0===l.pointerId&&(l.pointerId=0),this._updatePointerPosition(l),o.preventDefaultOnPointerUp&&n&&(l.preventDefault(),n.focus()),this._initClickEvent(o.onPrePointerObservable,o.onPointerObservable,l,(c,h)=>{if(o.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!c.ignore)){if(this._checkPrePointerObservable(null,l,Re.POINTERUP))return void(this._swipeButtonPressed===l.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1));c.hasSwiped||(c.singleClick&&o.onPrePointerObservable.hasSpecificMask(Re.POINTERTAP)&&this._checkPrePointerObservable(null,l,Re.POINTERTAP)&&(this._skipPointerTap=!0),c.doubleClick&&o.onPrePointerObservable.hasSpecificMask(Re.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,l,Re.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}this._pointerCaptures[l.pointerId]?(0===l.buttons&&(this._pointerCaptures[l.pointerId]=!1),(o.cameraToUseForPointers||o.activeCamera)&&(o.pointerUpPredicate||(o.pointerUpPredicate=u=>u.isPickable&&u.isVisible&&u.isReady()&&u.isEnabled()&&(!o.cameraToUseForPointers||0!=(o.cameraToUseForPointers.layerMask&u.layerMask))),!this._meshPickProceed&&(Ou&&Ou.HasTriggers||this._checkForPicking()||o.onPointerUp)&&this._initActionManager(null,c),h||(h=this._currentPickResult),this._processPointerUp(h,l,c),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===l.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))):this._swipeButtonPressed===l.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1)}))},this._onKeyDown=l=>{const c=Gu.KEYDOWN;if(o.onPreKeyboardObservable.hasObservers()){const h=new d1(c,l);if(o.onPreKeyboardObservable.notifyObservers(h,c),h.skipOnKeyboardObservable)return}if(o.onKeyboardObservable.hasObservers()){const h=new _E(c,l);o.onKeyboardObservable.notifyObservers(h,c)}o.actionManager&&o.actionManager.processTrigger(14,gi.CreateNewFromScene(o,l))},this._onKeyUp=l=>{const c=Gu.KEYUP;if(o.onPreKeyboardObservable.hasObservers()){const h=new d1(c,l);if(o.onPreKeyboardObservable.notifyObservers(h,c),h.skipOnKeyboardObservable)return}if(o.onKeyboardObservable.hasObservers()){const h=new _E(c,l);o.onKeyboardObservable.notifyObservers(h,c)}o.actionManager&&o.actionManager.processTrigger(15,gi.CreateNewFromScene(o,l))},this._deviceSourceManager.onDeviceConnectedObservable.add(l=>{l.deviceType===Oe.Mouse?l.onInputChangedObservable.add(c=>{c.inputIndex===qe.LeftClick||c.inputIndex===qe.MiddleClick||c.inputIndex===qe.RightClick||c.inputIndex===qe.BrowserBack||c.inputIndex===qe.BrowserForward?i&&1===l.getInput(c.inputIndex)?this._onPointerDown(c):t&&0===l.getInput(c.inputIndex)&&this._onPointerUp(c):s&&(c.inputIndex===qe.Move||c.inputIndex===qe.MouseWheelX||c.inputIndex===qe.MouseWheelY||c.inputIndex===qe.MouseWheelZ)&&this._onPointerMove(c)}):l.deviceType===Oe.Touch?l.onInputChangedObservable.add(c=>{c.inputIndex===qe.LeftClick&&(i&&1===l.getInput(c.inputIndex)?(this._onPointerDown(c),this._totalPointersPressed>1&&(this._isMultiTouchGesture=!0)):t&&0===l.getInput(c.inputIndex)&&(this._onPointerUp(c),0===this._totalPointersPressed&&(this._isMultiTouchGesture=!1))),s&&c.inputIndex===qe.Move&&this._onPointerMove(c)}):l.deviceType===Oe.Keyboard&&l.onInputChangedObservable.add(c=>{"keydown"===c.type?this._onKeyDown(c):"keyup"===c.type&&this._onKeyUp(c)})}),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(t,i=0,s,n){if(!(this._meshUnderPointerId[i]!==t||t&&t._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const o=this._meshUnderPointerId[i];let a;o&&(a=o._getActionManagerForTrigger(10),a&&a.processTrigger(10,gi.CreateNew(o,n,{pointerId:i}))),t?(this._meshUnderPointerId[i]=t,this._pointerOverMesh=t,a=t._getActionManagerForTrigger(9),a&&a.processTrigger(9,gi.CreateNew(t,n,{pointerId:i,pickResult:s}))):(delete this._meshUnderPointerId[i],this._pointerOverMesh=null)}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(t){this._pointerOverMesh===t&&(this._pointerOverMesh=null),this._pickedDownMesh===t&&(this._pickedDownMesh=null),this._pickedUpMesh===t&&(this._pickedUpMesh=null);for(const i in this._meshUnderPointerId)this._meshUnderPointerId[i]===t&&delete this._meshUnderPointerId[i]}}return r.DragMovementThreshold=10,r.LongPressDelay=500,r.DoubleClickDelay=300,r.ExclusiveDoubleClickMode=!1,r})(),eh=(()=>{class r{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(t,i){!r.Enabled||(this._current+=t,i&&this._fetchResult())}beginMonitoring(){!r.Enabled||(this._startMonitoringTime=ir.Now)}endMonitoring(t=!0){r.Enabled&&(t&&this.fetchNewFrame(),this._current=ir.Now-this._startMonitoringTime,t&&this._fetchResult())}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const t=ir.Now;t-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=t,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}return r.Enabled=!0,r})();class Dr{constructor(e,t,i,s){this.normal=new v(e,t,i),this.d=s}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new Dr(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=397*e^(0|this.d),e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return 0!==e&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=Dr._TmpMatrix;e.invertToRef(t);const i=t.m,s=this.normal.x,n=this.normal.y,o=this.normal.z,a=this.d;return new Dr(s*i[0]+n*i[1]+o*i[2]+a*i[3],s*i[4]+n*i[5]+o*i[6]+a*i[7],s*i[8]+n*i[9]+o*i[10]+a*i[11],s*i[12]+n*i[13]+o*i[14]+a*i[15])}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){const s=t.x-e.x,n=t.y-e.y,o=t.z-e.z,a=i.x-e.x,l=i.y-e.y,c=i.z-e.z,h=n*c-o*l,u=o*a-s*c,d=s*l-n*a,f=Math.sqrt(h*h+u*u+d*d);let p;return p=0!==f?1/f:0,this.normal.x=h*p,this.normal.y=u*p,this.normal.z=d*p,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return v.Dot(this.normal,e)<=t}signedDistanceTo(e){return v.Dot(e,this.normal)+this.d}static FromArray(e){return new Dr(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){const s=new Dr(0,0,0,0);return s.copyFromPoints(e,t,i),s}static FromPositionAndNormal(e,t){const i=new Dr(0,0,0,0);return t.normalize(),i.normal=t,i.d=-(t.x*e.x+t.y*e.y+t.z*e.z),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){const s=-(t.x*e.x+t.y*e.y+t.z*e.z);return v.Dot(i,t)+s}}Dr._TmpMatrix=F.Identity();class Gn{static GetPlanes(e){const t=[];for(let i=0;i<6;i++)t.push(new Dr(0,0,0,0));return Gn.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}static GetFarPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}static GetLeftPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}static GetRightPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}static GetTopPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}static GetBottomPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}static GetPlanesToRef(e,t){Gn.GetNearPlaneToRef(e,t[0]),Gn.GetFarPlaneToRef(e,t[1]),Gn.GetLeftPlaneToRef(e,t[2]),Gn.GetRightPlaneToRef(e,t[3]),Gn.GetTopPlaneToRef(e,t[4]),Gn.GetBottomPlaneToRef(e,t[5])}}let gE=(()=>{class r{static get UniqueId(){const t=this._UniqueIdCounter;return this._UniqueIdCounter++,t}}return r._UniqueIdCounter=1,r})(),ds=(()=>{class r{static CompareLightsPriority(t,i){return t.shadowEnabled!==i.shadowEnabled?(i.shadowEnabled?1:0)-(t.shadowEnabled?1:0):i.renderPriority-t.renderPriority}}return r.FALLOFF_DEFAULT=0,r.FALLOFF_PHYSICAL=1,r.FALLOFF_GLTF=2,r.FALLOFF_STANDARD=3,r.LIGHTMAP_DEFAULT=0,r.LIGHTMAP_SPECULAR=1,r.LIGHTMAP_SHADOWSONLY=2,r.INTENSITYMODE_AUTOMATIC=0,r.INTENSITYMODE_LUMINOUSPOWER=1,r.INTENSITYMODE_LUMINOUSINTENSITY=2,r.INTENSITYMODE_ILLUMINANCE=3,r.INTENSITYMODE_LUMINANCE=4,r.LIGHTTYPEID_POINTLIGHT=0,r.LIGHTTYPEID_DIRECTIONALLIGHT=1,r.LIGHTTYPEID_SPOTLIGHT=2,r.LIGHTTYPEID_HEMISPHERICLIGHT=3,r})();var Lo=(()=>{return(r=Lo||(Lo={}))[r.BackwardCompatible=0]="BackwardCompatible",r[r.Intermediate=1]="Intermediate",r[r.Aggressive=2]="Aggressive",Lo;var r})();let ge=(()=>{class r extends es{static DefaultMaterialFactory(t){throw Ge("StandardMaterial")}static CollisionCoordinatorFactory(){throw Ge("DefaultCollisionCoordinator")}get environmentTexture(){return this._environmentTexture}set environmentTexture(t){this._environmentTexture!==t&&(this._environmentTexture=t,this.markAllMaterialsAsDirty(1))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(t){if(t!==this._performancePriority){switch(this._performancePriority=t,t){case Lo.BackwardCompatible:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case Lo.Intermediate:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case Lo.Aggressive:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1}this.onScenePerformancePriorityChangedObservable.notifyObservers(t)}}set forceWireframe(t){this._forceWireframe!==t&&(this._forceWireframe=t,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(t){this._skipFrustumClipping!==t&&(this._skipFrustumClipping=t)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(t){this._forcePointsCloud!==t&&(this._forcePointsCloud=t,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(t){this._animationPropertiesOverride=t}set onDispose(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)}set beforeRender(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),t&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t))}set afterRender(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),t&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(t))}set beforeCameraRender(t){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(t)}set afterCameraRender(t){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(t)}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return $a.DragMovementThreshold}static set DragMovementThreshold(t){$a.DragMovementThreshold=t}static get LongPressDelay(){return $a.LongPressDelay}static set LongPressDelay(t){$a.LongPressDelay=t}static get DoubleClickDelay(){return $a.DoubleClickDelay}static set DoubleClickDelay(t){$a.DoubleClickDelay=t}static get ExclusiveDoubleClickMode(){return $a.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(t){$a.ExclusiveDoubleClickMode=t}bindEyePosition(t,i="vEyePosition",s=!1){var n;const o=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:null!==(n=this.activeCamera.globalPosition)&&void 0!==n?n:this.activeCamera.devicePosition;return L.Vector4[0].set(o.x,o.y,o.z,this.useRightHandedSystem===(null!=this._mirroredCameraPosition)?-1:1),t&&(s?t.setFloat3(i,L.Vector4[0].x,L.Vector4[0].y,L.Vector4[0].z):t.setVector4(i,L.Vector4[0])),L.Vector4[0]}finalizeSceneUbo(){const t=this.getSceneUniformBuffer(),i=this.bindEyePosition(null);return t.updateFloat4("vEyePosition",i.x,i.y,i.z,i.w),t.update(),t}set useRightHandedSystem(t){this._useRightHandedSystem!==t&&(this._useRightHandedSystem=t,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(t){this._currentStepId=t}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(t){this._fogEnabled!==t&&(this._fogEnabled=t,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(t){this._fogMode!==t&&(this._fogMode=t,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(t){this._shadowsEnabled!==t&&(this._shadowsEnabled=t,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(t){this._lightsEnabled!==t&&(this._lightsEnabled=t,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(t){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),t&&(this._unObserveActiveCameras=zF(t,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=t}get activeCamera(){return this._activeCamera}set activeCamera(t){t!==this._activeCamera&&(this._activeCamera=t,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=r.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(t){this._defaultMaterial=t}set texturesEnabled(t){this._texturesEnabled!==t&&(this._texturesEnabled=t,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}set skeletonsEnabled(t){this._skeletonsEnabled!==t&&(this._skeletonsEnabled=t,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=r.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const t of this._transientComponents)t.register();this._transientComponents.length=0}}_addComponent(t){this._components.push(t),this._transientComponents.push(t),t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(t){for(const i of this._components)if(i.name===t)return i;return null}constructor(t,i){super(),this._inputManager=new $a(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new Te(.2,.2,.3,1),this.ambientColor=new re(0,0,0),this.environmentIntensity=1,this._performancePriority=Lo.BackwardCompatible,this.onScenePerformancePriorityChangedObservable=new z,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=new Array,this.onDisposeObservable=new z,this._onDisposeObserver=null,this.onBeforeRenderObservable=new z,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new z,this.onAfterRenderCameraObservable=new z,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new z,this.onAfterAnimationsObservable=new z,this.onBeforeDrawPhaseObservable=new z,this.onAfterDrawPhaseObservable=new z,this.onReadyObservable=new z,this.onBeforeCameraRenderObservable=new z,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new z,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new z,this.onAfterActiveMeshesEvaluationObservable=new z,this.onBeforeParticlesRenderingObservable=new z,this.onAfterParticlesRenderingObservable=new z,this.onDataLoadedObservable=new z,this.onNewCameraAddedObservable=new z,this.onCameraRemovedObservable=new z,this.onNewLightAddedObservable=new z,this.onLightRemovedObservable=new z,this.onNewGeometryAddedObservable=new z,this.onGeometryRemovedObservable=new z,this.onNewTransformNodeAddedObservable=new z,this.onTransformNodeRemovedObservable=new z,this.onNewMeshAddedObservable=new z,this.onMeshRemovedObservable=new z,this.onNewSkeletonAddedObservable=new z,this.onSkeletonRemovedObservable=new z,this.onNewMaterialAddedObservable=new z,this.onNewMultiMaterialAddedObservable=new z,this.onMaterialRemovedObservable=new z,this.onMultiMaterialRemovedObservable=new z,this.onNewTextureAddedObservable=new z,this.onTextureRemovedObservable=new z,this.onBeforeRenderTargetsRenderObservable=new z,this.onAfterRenderTargetsRenderObservable=new z,this.onBeforeStepObservable=new z,this.onAfterStepObservable=new z,this.onActiveCameraChanged=new z,this.onActiveCamerasChanged=new z,this.onBeforeRenderingGroupObservable=new z,this.onAfterRenderingGroupObservable=new z,this.onMeshImportedObservable=new z,this.onAnimationFileImportedObservable=new z,this._registeredForLateAnimationBindings=new $l(256),this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1,this.onPrePointerObservable=new z,this.onPointerObservable=new z,this.onPreKeyboardObservable=new z,this.onKeyboardObservable=new z,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=r.FOGMODE_NONE,this.fogColor=new re(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new v(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=new Array,this.importedMeshesFiles=new Array,this.probesEnabled=!0,this._meshesForIntersections=new $l(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new eh,this._activeIndices=new eh,this._activeParticles=new eh,this._activeBones=new eh,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new ws(256),this._processedMaterials=new ws(256),this._renderTargets=new $l(256),this._materialsRenderTargets=new $l(256),this._activeParticleSystems=new ws(256),this._activeSkeletons=new $l(32),this._softwareSkinnedMeshes=new $l(32),this._activeAnimatables=new Array,this._transformMatrix=F.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=ki.Create(),this._beforeClearStage=ki.Create(),this._beforeRenderTargetClearStage=ki.Create(),this._gatherRenderTargetsStage=ki.Create(),this._gatherActiveCameraRenderTargetsStage=ki.Create(),this._isReadyForMeshStage=ki.Create(),this._beforeEvaluateActiveMeshStage=ki.Create(),this._evaluateSubMeshStage=ki.Create(),this._preActiveMeshStage=ki.Create(),this._cameraDrawRenderTargetStage=ki.Create(),this._beforeCameraDrawStage=ki.Create(),this._beforeRenderTargetDrawStage=ki.Create(),this._beforeRenderingGroupDrawStage=ki.Create(),this._beforeRenderingMeshStage=ki.Create(),this._afterRenderingMeshStage=ki.Create(),this._afterRenderingGroupDrawStage=ki.Create(),this._afterCameraDrawStage=ki.Create(),this._afterCameraPostProcessStage=ki.Create(),this._afterRenderTargetDrawStage=ki.Create(),this._afterRenderTargetPostProcessStage=ki.Create(),this._afterRenderStage=ki.Create(),this._pointerMoveStage=ki.Create(),this._pointerDownStage=ki.Create(),this._pointerUpStage=ki.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=new Array;const s={useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1,...i};this._engine=t||be.LastCreatedEngine,s.virtual?this._engine._virtualScenes.push(this):(be._LastCreatedScene=this,this._engine.scenes.push(this)),this._uid=null,this._renderingManager=new Jg(this),Zg&&(this.postProcessManager=new Zg(this)),qi()&&this.attachControl(),this._createUbo(),at&&(this._imageProcessingConfiguration=new at),this.setDefaultCandidateProviders(),s.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=s.useMaterialMeshMap,this.useClonedMeshMap=s.useClonedMeshMap,(!i||!i.virtual)&&this._engine.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(t){return this._defaultSubMeshCandidates.data=t.subMeshes,this._defaultSubMeshCandidates.length=t.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=this._getDefaultMeshCandidates.bind(this),this.getActiveSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getIntersectingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getCollidingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(t){this._inputManager.pointerX=t}get pointerY(){return this._inputManager.pointerY}set pointerY(t){this._inputManager.pointerY=t}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(t,i,s=1){return this._cachedEffect!==i||this._cachedMaterial!==t||this._cachedVisibility!==s}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return void 0!==this._animationRatio?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(t,i){return this._inputManager.simulatePointerMove(t,i),this}simulatePointerDown(t,i){return this._inputManager.simulatePointerDown(t,i),this}simulatePointerUp(t,i,s){return this._inputManager.simulatePointerUp(t,i,s),this}isPointerCaptured(t=0){return this._inputManager.isPointerCaptured(t)}attachControl(t=!0,i=!0,s=!0){this._inputManager.attachControl(t,i,s)}detachControl(){this._inputManager.detachControl()}isReady(t=!0){if(this._isDisposed)return!1;let i;const s=this.getEngine();let n=!0;for(this._pendingData.length>0&&(n=!1),t&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),i=0;i<this.meshes.length;i++){const o=this.meshes[i];if(!o.subMeshes||0===o.subMeshes.length)continue;if(!o.isReady(!0)){n=!1;continue}const a=o.hasThinInstances||"InstancedMesh"===o.getClassName()||"InstancedLinesMesh"===o.getClassName()||s.getCaps().instancedArrays&&o.instances.length>0;for(const c of this._isReadyForMeshStage)c.action(o,a)||(n=!1);if(!t)continue;const l=o.material||this.defaultMaterial;if(l)if(l._storeEffectOnSubMeshes)for(const c of o.subMeshes){const h=c.getMaterial();h&&h.hasRenderTargetTextures&&null!=h.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(h)&&(this._processedMaterials.push(h),this._materialsRenderTargets.concatWithNoDuplicate(h.getRenderTargetTextures()))}else l.hasRenderTargetTextures&&null!=l.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(l)&&(this._processedMaterials.push(l),this._materialsRenderTargets.concatWithNoDuplicate(l.getRenderTargetTextures()))}if(!n||!s.areAllEffectsReady())return!1;if(t)for(i=0;i<this._materialsRenderTargets.length;++i)if(!this._materialsRenderTargets.data[i].isReadyForRendering())return!1;for(i=0;i<this.geometries.length;i++)if(2===this.geometries[i].delayLoadState)return!1;if(this.activeCameras&&this.activeCameras.length>0){for(const o of this.activeCameras)if(!o.isReady(!0))return!1}else if(this.activeCamera&&!this.activeCamera.isReady(!0))return!1;for(const o of this.particleSystems)if(!o.isReady())return!1;return!0}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(t){this.onBeforeRenderObservable.add(t)}unregisterBeforeRender(t){this.onBeforeRenderObservable.removeCallback(t)}registerAfterRender(t){this.onAfterRenderObservable.add(t)}unregisterAfterRender(t){this.onAfterRenderObservable.removeCallback(t)}_executeOnceBeforeRender(t){const i=()=>{t(),setTimeout(()=>{this.unregisterBeforeRender(i)})};this.registerBeforeRender(i)}executeOnceBeforeRender(t,i){void 0!==i?setTimeout(()=>{this._executeOnceBeforeRender(t)},i):this._executeOnceBeforeRender(t)}addPendingData(t){this._pendingData.push(t)}removePendingData(t){const i=this.isLoading,s=this._pendingData.indexOf(t);-1!==s&&this._pendingData.splice(s,1),i&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(t,i=!1){this.onReadyObservable.addOnce(t),null===this._executeWhenReadyTimeoutId&&this._checkIsReady(i)}whenReadyAsync(t=!1){return new Promise(i=>{this.executeWhenReady(()=>{i()},t)})}_checkIsReady(t=!1){return this._registerTransientComponents(),this.isReady(t)?(this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):this._isDisposed?(this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):void(this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(t)},100))}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=ir.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(t,i,s,n){!s&&!n&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),(this._viewUpdateFlag!==t.updateFlag||this._projectionUpdateFlag!==i.updateFlag)&&(this._viewUpdateFlag=t.updateFlag,this._projectionUpdateFlag=i.updateFlag,this._viewMatrix=t,this._projectionMatrix=i,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?Gn.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Gn.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(s,n):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(t){const i=new Se(this._engine,void 0,!1,t??"scene");return i.addUniform("viewProjection",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}setSceneUniformBuffer(t){this._sceneUbo=t,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return gE.UniqueId}addMesh(t,i=!1){this._blockEntityCollection||(this.meshes.push(t),t._resyncLightSources(),t.parent||t._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(t),i&&t.getChildMeshes().forEach(s=>{this.addMesh(s)}))}removeMesh(t,i=!1){const s=this.meshes.indexOf(t);return-1!==s&&(this.meshes[s]=this.meshes[this.meshes.length-1],this.meshes.pop(),t.parent||t._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(t),this.onMeshRemovedObservable.notifyObservers(t),i&&t.getChildMeshes().forEach(n=>{this.removeMesh(n)}),s}addTransformNode(t){this._blockEntityCollection||t.getScene()===this&&-1!==t._indexInSceneTransformNodesArray||(t._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(t),t.parent||t._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(t))}removeTransformNode(t){const i=t._indexInSceneTransformNodesArray;if(-1!==i){if(i!==this.transformNodes.length-1){const s=this.transformNodes[this.transformNodes.length-1];this.transformNodes[i]=s,s._indexInSceneTransformNodesArray=i}t._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),t.parent||t._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(t),i}removeSkeleton(t){const i=this.skeletons.indexOf(t);return-1!==i&&(this.skeletons.splice(i,1),this.onSkeletonRemovedObservable.notifyObservers(t),this._executeActiveContainerCleanup(this._activeSkeletons)),i}removeMorphTargetManager(t){const i=this.morphTargetManagers.indexOf(t);return-1!==i&&this.morphTargetManagers.splice(i,1),i}removeLight(t){const i=this.lights.indexOf(t);if(-1!==i){for(const s of this.meshes)s._removeLightSource(t,!1);this.lights.splice(i,1),this.sortLightsByPriority(),t.parent||t._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(t),i}removeCamera(t){const i=this.cameras.indexOf(t);if(-1!==i&&(this.cameras.splice(i,1),t.parent||t._removeFromSceneRootNodes()),this.activeCameras){const s=this.activeCameras.indexOf(t);-1!==s&&this.activeCameras.splice(s,1)}return this.activeCamera===t&&(this.activeCamera=this.cameras.length>0?this.cameras[0]:null),this.onCameraRemovedObservable.notifyObservers(t),i}removeParticleSystem(t){const i=this.particleSystems.indexOf(t);return-1!==i&&(this.particleSystems.splice(i,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),i}removeAnimation(t){const i=this.animations.indexOf(t);return-1!==i&&this.animations.splice(i,1),i}stopAnimation(t,i,s){}removeAnimationGroup(t){const i=this.animationGroups.indexOf(t);return-1!==i&&this.animationGroups.splice(i,1),i}removeMultiMaterial(t){const i=this.multiMaterials.indexOf(t);return-1!==i&&this.multiMaterials.splice(i,1),this.onMultiMaterialRemovedObservable.notifyObservers(t),i}removeMaterial(t){const i=t._indexInSceneMaterialArray;if(-1!==i&&i<this.materials.length){if(i!==this.materials.length-1){const s=this.materials[this.materials.length-1];this.materials[i]=s,s._indexInSceneMaterialArray=i}t._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(t),i}removeActionManager(t){const i=this.actionManagers.indexOf(t);return-1!==i&&this.actionManagers.splice(i,1),i}removeTexture(t){const i=this.textures.indexOf(t);return-1!==i&&this.textures.splice(i,1),this.onTextureRemovedObservable.notifyObservers(t),i}addLight(t){if(!this._blockEntityCollection){this.lights.push(t),this.sortLightsByPriority(),t.parent||t._addToSceneRootNodes();for(const i of this.meshes)-1===i.lightSources.indexOf(t)&&(i.lightSources.push(t),i._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(t)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(ds.CompareLightsPriority)}addCamera(t){this._blockEntityCollection||(this.cameras.push(t),this.onNewCameraAddedObservable.notifyObservers(t),t.parent||t._addToSceneRootNodes())}addSkeleton(t){this._blockEntityCollection||(this.skeletons.push(t),this.onNewSkeletonAddedObservable.notifyObservers(t))}addParticleSystem(t){this._blockEntityCollection||this.particleSystems.push(t)}addAnimation(t){this._blockEntityCollection||this.animations.push(t)}addAnimationGroup(t){this._blockEntityCollection||this.animationGroups.push(t)}addMultiMaterial(t){this._blockEntityCollection||(this.multiMaterials.push(t),this.onNewMultiMaterialAddedObservable.notifyObservers(t))}addMaterial(t){this._blockEntityCollection||t.getScene()===this&&-1!==t._indexInSceneMaterialArray||(t._indexInSceneMaterialArray=this.materials.length,this.materials.push(t),this.onNewMaterialAddedObservable.notifyObservers(t))}addMorphTargetManager(t){this._blockEntityCollection||this.morphTargetManagers.push(t)}addGeometry(t){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[t.uniqueId]=this.geometries.length),this.geometries.push(t))}addActionManager(t){this.actionManagers.push(t)}addTexture(t){this._blockEntityCollection||(this.textures.push(t),this.onNewTextureAddedObservable.notifyObservers(t))}switchActiveCamera(t,i=!0){!this._engine.getInputElement()||(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=t,i&&t.attachControl())}setActiveCameraById(t){const i=this.getCameraById(t);return i?(this.activeCamera=i,i):null}setActiveCameraByName(t){const i=this.getCameraByName(t);return i?(this.activeCamera=i,i):null}getAnimationGroupByName(t){for(let i=0;i<this.animationGroups.length;i++)if(this.animationGroups[i].name===t)return this.animationGroups[i];return null}_getMaterial(t,i){for(let s=0;s<this.materials.length;s++){const n=this.materials[s];if(i(n))return n}if(t)for(let s=0;s<this.multiMaterials.length;s++){const n=this.multiMaterials[s];if(i(n))return n}return null}getMaterialByUniqueID(t,i=!1){return this._getMaterial(i,s=>s.uniqueId===t)}getMaterialById(t,i=!1){return this._getMaterial(i,s=>s.id===t)}getMaterialByName(t,i=!1){return this._getMaterial(i,s=>s.name===t)}getLastMaterialById(t,i=!1){for(let s=this.materials.length-1;s>=0;s--)if(this.materials[s].id===t)return this.materials[s];if(i)for(let s=this.multiMaterials.length-1;s>=0;s--)if(this.multiMaterials[s].id===t)return this.multiMaterials[s];return null}getTextureByUniqueId(t){for(let i=0;i<this.textures.length;i++)if(this.textures[i].uniqueId===t)return this.textures[i];return null}getTextureByName(t){for(let i=0;i<this.textures.length;i++)if(this.textures[i].name===t)return this.textures[i];return null}getCameraById(t){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].id===t)return this.cameras[i];return null}getCameraByUniqueId(t){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].uniqueId===t)return this.cameras[i];return null}getCameraByName(t){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].name===t)return this.cameras[i];return null}getBoneById(t){for(let i=0;i<this.skeletons.length;i++){const s=this.skeletons[i];for(let n=0;n<s.bones.length;n++)if(s.bones[n].id===t)return s.bones[n]}return null}getBoneByName(t){for(let i=0;i<this.skeletons.length;i++){const s=this.skeletons[i];for(let n=0;n<s.bones.length;n++)if(s.bones[n].name===t)return s.bones[n]}return null}getLightByName(t){for(let i=0;i<this.lights.length;i++)if(this.lights[i].name===t)return this.lights[i];return null}getLightById(t){for(let i=0;i<this.lights.length;i++)if(this.lights[i].id===t)return this.lights[i];return null}getLightByUniqueId(t){for(let i=0;i<this.lights.length;i++)if(this.lights[i].uniqueId===t)return this.lights[i];return null}getParticleSystemById(t){for(let i=0;i<this.particleSystems.length;i++)if(this.particleSystems[i].id===t)return this.particleSystems[i];return null}getGeometryById(t){for(let i=0;i<this.geometries.length;i++)if(this.geometries[i].id===t)return this.geometries[i];return null}_getGeometryByUniqueId(t){if(this._geometriesByUniqueId){const i=this._geometriesByUniqueId[t];if(void 0!==i)return this.geometries[i]}else for(let i=0;i<this.geometries.length;i++)if(this.geometries[i].uniqueId===t)return this.geometries[i];return null}pushGeometry(t,i){return!(!i&&this._getGeometryByUniqueId(t.uniqueId)||(this.addGeometry(t),this.onNewGeometryAddedObservable.notifyObservers(t),0))}removeGeometry(t){let i;if(this._geometriesByUniqueId){if(i=this._geometriesByUniqueId[t.uniqueId],void 0===i)return!1}else if(i=this.geometries.indexOf(t),i<0)return!1;if(i!==this.geometries.length-1){const s=this.geometries[this.geometries.length-1];s&&(this.geometries[i]=s,this._geometriesByUniqueId&&(this._geometriesByUniqueId[s.uniqueId]=i))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[t.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(t),!0}getGeometries(){return this.geometries}getMeshById(t){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].id===t)return this.meshes[i];return null}getMeshesById(t){return this.meshes.filter(function(i){return i.id===t})}getTransformNodeById(t){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].id===t)return this.transformNodes[i];return null}getTransformNodeByUniqueId(t){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].uniqueId===t)return this.transformNodes[i];return null}getTransformNodesById(t){return this.transformNodes.filter(function(i){return i.id===t})}getMeshByUniqueId(t){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].uniqueId===t)return this.meshes[i];return null}getLastMeshById(t){for(let i=this.meshes.length-1;i>=0;i--)if(this.meshes[i].id===t)return this.meshes[i];return null}getLastEntryById(t){let i;for(i=this.meshes.length-1;i>=0;i--)if(this.meshes[i].id===t)return this.meshes[i];for(i=this.transformNodes.length-1;i>=0;i--)if(this.transformNodes[i].id===t)return this.transformNodes[i];for(i=this.cameras.length-1;i>=0;i--)if(this.cameras[i].id===t)return this.cameras[i];for(i=this.lights.length-1;i>=0;i--)if(this.lights[i].id===t)return this.lights[i];return null}getNodeById(t){const i=this.getMeshById(t);if(i)return i;const s=this.getTransformNodeById(t);if(s)return s;const n=this.getLightById(t);if(n)return n;const o=this.getCameraById(t);return o||(this.getBoneById(t)||null)}getNodeByName(t){const i=this.getMeshByName(t);if(i)return i;const s=this.getTransformNodeByName(t);if(s)return s;const n=this.getLightByName(t);if(n)return n;const o=this.getCameraByName(t);return o||(this.getBoneByName(t)||null)}getMeshByName(t){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].name===t)return this.meshes[i];return null}getTransformNodeByName(t){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].name===t)return this.transformNodes[i];return null}getLastSkeletonById(t){for(let i=this.skeletons.length-1;i>=0;i--)if(this.skeletons[i].id===t)return this.skeletons[i];return null}getSkeletonByUniqueId(t){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].uniqueId===t)return this.skeletons[i];return null}getSkeletonById(t){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].id===t)return this.skeletons[i];return null}getSkeletonByName(t){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].name===t)return this.skeletons[i];return null}getMorphTargetManagerById(t){for(let i=0;i<this.morphTargetManagers.length;i++)if(this.morphTargetManagers[i].uniqueId===t)return this.morphTargetManagers[i];return null}getMorphTargetById(t){for(let i=0;i<this.morphTargetManagers.length;++i){const s=this.morphTargetManagers[i];for(let n=0;n<s.numTargets;++n){const o=s.getTarget(n);if(o.id===t)return o}}return null}getMorphTargetByName(t){for(let i=0;i<this.morphTargetManagers.length;++i){const s=this.morphTargetManagers[i];for(let n=0;n<s.numTargets;++n){const o=s.getTarget(n);if(o.name===t)return o}}return null}getPostProcessByName(t){for(let i=0;i<this.postProcesses.length;++i){const s=this.postProcesses[i];if(s.name===t)return s}return null}isActiveMesh(t){return-1!==this._activeMeshes.indexOf(t)}get uid(){return this._uid||(this._uid=q.RandomId()),this._uid}addExternalData(t,i){return this._externalData||(this._externalData=new pE),this._externalData.add(t,i)}getExternalData(t){return this._externalData?this._externalData.get(t):null}getOrAddExternalDataWithFactory(t,i){return this._externalData||(this._externalData=new pE),this._externalData.getOrAddWithFactory(t,i)}removeExternalData(t){return this._externalData.remove(t)}_evaluateSubMesh(t,i,s,n){if(n||t.isInFrustum(this._frustumPlanes)){for(const a of this._evaluateSubMeshStage)a.action(i,t);const o=t.getMaterial();null!=o&&(o.hasRenderTargetTextures&&null!=o.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(o)&&(this._processedMaterials.push(o),this._materialsRenderTargets.concatWithNoDuplicate(o.getRenderTargetTextures())),this._renderingManager.dispatch(t,i,o))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(t){this._preventFreeActiveMeshesAndRenderingGroups!==t&&(t&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=t)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let t=0;t<this.activeCameras.length;t++){const i=this.activeCameras[t];i&&i._activeMeshes&&i._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let t=0;t<this.textures.length;t++){const i=this.textures[t];i&&i.renderList&&i.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(t=!1,i,s,n=!0,o=!1){return this.executeWhenReady(()=>{if(this.activeCamera){if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=o,this._skipEvaluateActiveMeshesCompletely=t,n)for(let a=0;a<this._activeMeshes.length;a++)this._activeMeshes.data[a]._freeze();i&&i()}else s&&s("No active camera found")}),this}unfreezeActiveMeshes(){for(let t=0;t<this.meshes.length;t++){const i=this.meshes[t];i._internalAbstractMeshDataInfo&&(i._internalAbstractMeshDataInfo._isActive=!1)}for(let t=0;t<this._activeMeshes.length;t++)this._activeMeshes.data[t]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(t){(!this._engine.snapshotRendering||1!==this._engine.snapshotRenderingMode)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>t.dispose())}_evaluateActiveMeshes(){var t;if(this._engine.snapshotRendering&&1===this._engine.snapshotRenderingMode)return void(this._activeMeshes.length>0&&(null===(t=this.activeCamera)||void 0===t||t._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset()));if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const n=this._activeMeshes.length;for(let o=0;o<n;o++)this._activeMeshes.data[o].computeWorldMatrix()}if(this._activeParticleSystems){const n=this._activeParticleSystems.length;for(let o=0;o<n;o++)this._activeParticleSystems.data[o].animate()}return void this._renderingManager.resetSprites()}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const n of this._beforeEvaluateActiveMeshStage)n.action();const i=this.getActiveMeshCandidates(),s=i.length;for(let n=0;n<s;n++){const o=i.data[n];if(o._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,o.isBlocked||(this._totalVertices.addCount(o.getTotalVertices(),!1),!o.isReady()||!o.isEnabled()||o.scaling.hasAZeroComponent))continue;o.computeWorldMatrix(),o.actionManager&&o.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(o);let a=this.customLODSelector?this.customLODSelector(o,this.activeCamera):o.getLOD(this.activeCamera);if(o._internalAbstractMeshDataInfo._currentLOD=a,o._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,null!=a&&(a!==o&&0!==a.billboardMode&&a.computeWorldMatrix(),o._preActivate(),o.isVisible&&o.visibility>0&&0!=(o.layerMask&this.activeCamera.layerMask)&&(this._skipFrustumClipping||o.alwaysSelectAsActiveMesh||o.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(o),this.activeCamera._activeMeshes.push(o),a!==o&&a._activate(this._renderId,!1);for(const l of this._preActiveMeshStage)l.action(o);o._activate(this._renderId,!1)&&(o.isAnInstance?o._internalAbstractMeshDataInfo._actAsRegularMesh&&(a=o):a._internalAbstractMeshDataInfo._onlyForInstances=!1,a._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(o,a)),o._postActivate()}}if(this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let n=0;n<this.particleSystems.length;n++){const o=this.particleSystems[n];if(!o.isStarted()||!o.emitter)continue;const a=o.emitter;(!a.position||a.isEnabled())&&(this._activeParticleSystems.push(o),o.animate(),this._renderingManager.dispatchParticles(o))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_activeMesh(t,i){this._skeletonsEnabled&&null!=i.skeleton&&(this._activeSkeletons.pushNoDuplicate(i.skeleton)&&(i.skeleton.prepare(),this._activeBones.addCount(i.skeleton.bones.length,!1)),i.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(i));let s=t.hasInstances||t.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||i.alwaysSelectAsActiveMesh;if(i&&i.subMeshes&&i.subMeshes.length>0){const n=this.getActiveSubMeshCandidates(i),o=n.length;s=s||1===o;for(let a=0;a<o;a++)this._evaluateSubMesh(n.data[a],i,t,s)}}updateTransformMatrix(t){if(this.activeCamera)if(this.activeCamera._renderingMultiview){const i=this.activeCamera._rigCameras[0],s=this.activeCamera._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(t),s.getViewMatrix(),s.getProjectionMatrix(t))}else this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(t))}_bindFrameBuffer(t,i=!0){t&&t._multiviewTexture?t._multiviewTexture._bindFrameBuffer():t&&t.outputRenderTarget?t.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),i&&this._clearFrameBuffer(t)}_clearFrameBuffer(t){if(!t||!t._multiviewTexture)if(t&&t.outputRenderTarget&&!t._renderingMultiview){const i=t.outputRenderTarget;i.onClearObservable.hasObservers()?i.onClearObservable.notifyObservers(this._engine):i.skipInitialClear||(this.autoClear&&this._engine.clear(i.clearColor||this.clearColor,!i._cleared,!0,!0),i._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(t,i,s=!0){var n,o,a;if(t&&t._skipRendering)return;const l=this._engine;if(this._activeCamera=t,!this.activeCamera)throw new Error("Active camera not set");if(l.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&s){let h=!0;t._renderingMultiview&&t.outputRenderTarget&&(h=t.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,t.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),t._renderingMultiview&&t.outputRenderTarget&&(t.outputRenderTarget.skipInitialClear=h)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let h=0;h<this._softwareSkinnedMeshes.length;h++){const u=this._softwareSkinnedMeshes.data[h];u.applySkeleton(u.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),i&&i.customRenderTargets&&i.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(i.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const h of this._gatherActiveCameraRenderTargetsStage)h.action(this._renderTargets);let c=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){q.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let h=0;h<this._renderTargets.length;h++){const u=this._renderTargets.data[h];u._shouldRender()&&(this._renderId++,u.render(u.activeCamera&&u.activeCamera!==this.activeCamera,this.dumpNextRenderTargets),c=!0)}q.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(const h of this._cameraDrawRenderTargetStage)c=h.action(this.activeCamera)||c;this._intermediateRendering=!1}this._engine.currentRenderPassId=null!==(a=null!==(o=null===(n=t.outputRenderTarget)||void 0===n?void 0:n.renderPassId)&&void 0!==o?o:t.renderPassId)&&void 0!==a?a:0,c&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!t._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(const h of this._beforeCameraDrawStage)h.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),l.snapshotRendering&&1===l.snapshotRenderingMode&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const h of this._afterCameraDrawStage)h.action(this.activeCamera);this.postProcessManager&&!t._multiviewTexture&&this.postProcessManager._finalizeFrame(t.isIntermediate,t.outputRenderTarget?t.outputRenderTarget.renderTarget:void 0);for(const h of this._afterCameraPostProcessStage)h.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(t,i=!0){if(0===t.cameraRigMode||t._renderingMultiview)return t._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(t,void 0,i),void this.onAfterRenderCameraObservable.notifyObservers(t);if(t._useMultiviewToSingleView)this._renderMultiviewToSingleView(t);else{this.onBeforeCameraRenderObservable.notifyObservers(t);for(let s=0;s<t._rigCameras.length;s++)this._renderForCamera(t._rigCameras[s],t)}this._activeCamera=t,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(t)}_checkIntersections(){for(let t=0;t<this._meshesForIntersections.length;t++){const i=this._meshesForIntersections.data[t];if(i.actionManager)for(let s=0;i.actionManager&&s<i.actionManager.actions.length;s++){const n=i.actionManager.actions[s];if(12===n.trigger||13===n.trigger){const o=n.getTriggerParameter(),a=o.mesh?o.mesh:o,l=a.intersectsMesh(i,o.usePreciseIntersection),c=i._intersectionsInProgress.indexOf(a);l&&-1===c?12===n.trigger?(n._executeCurrent(gi.CreateNew(i,void 0,a)),i._intersectionsInProgress.push(a)):13===n.trigger&&i._intersectionsInProgress.push(a):!l&&c>-1&&(13===n.trigger&&n._executeCurrent(gi.CreateNew(i,void 0,a)),(!i.actionManager.hasSpecificTrigger(13,h=>a===(h.mesh?h.mesh:h))||13===n.trigger)&&i._intersectionsInProgress.splice(c,1))}}}}_advancePhysicsEngineStep(t){}_animate(){}animate(){if(this._engine.isDeterministicLockStep()){let t=Math.max(r.MinDeltaTime,Math.min(this._engine.getDeltaTime(),r.MaxDeltaTime))+this._timeAccumulator;const i=this._engine.getTimeStep(),s=1e3/i/1e3;let n=0;const o=this._engine.getLockstepMaxSteps();let a=Math.floor(t/i);for(a=Math.min(a,o);t>0&&n<a;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=i*s,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(i),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,n++,t-=i;this._timeAccumulator=t<0?0:t}else{const t=this.useConstantAnimationDeltaTime?16:Math.max(r.MinDeltaTime,Math.min(this._engine.getDeltaTime(),r.MaxDeltaTime));this._animationRatio=.06*t,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(t){var i;if(t?.outputRenderTarget&&!t?.isRigCamera&&(t.outputRenderTarget._cleared=!1),null!==(i=t?.rigCameras)&&void 0!==i&&i.length)for(let s=0;s<t.rigCameras.length;++s){const n=t.rigCameras[s].outputRenderTarget;n&&(n._cleared=!1)}}resetDrawCache(t){if(this.meshes)for(const i of this.meshes)i.resetDrawCache(t)}render(t=!0,i=!1){var s,n,o;if(this.isDisposed)return;this.onReadyObservable.hasObservers()&&null===this._executeWhenReadyTimeoutId&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),!(null===(s=this.activeCameras)||void 0===s)&&s.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),i||this.animate();for(const c of this._beforeCameraUpdateStage)c.action();if(t)if(this.activeCameras&&this.activeCameras.length>0)for(let c=0;c<this.activeCameras.length;c++){const h=this.activeCameras[c];if(h.update(),0!==h.cameraRigMode)for(let u=0;u<h._rigCameras.length;u++)h._rigCameras[u].update()}else if(this.activeCamera&&(this.activeCamera.update(),0!==this.activeCamera.cameraRigMode))for(let c=0;c<this.activeCamera._rigCameras.length;c++)this.activeCamera._rigCameras[c].update();this.onBeforeRenderObservable.notifyObservers(this);const a=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const l=null!==(n=this.activeCameras)&&void 0!==n&&n.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){q.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let c=0;c<this.customRenderTargets.length;c++){const h=this.customRenderTargets[c];if(h._shouldRender()){if(this._renderId++,this.activeCamera=h.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");a.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),h.render(l!==this.activeCamera,this.dumpNextRenderTargets)}}q.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=null!==(o=l?.renderPassId)&&void 0!==o?o:0,this.activeCamera=l,this._activeCamera&&22!==this._activeCamera.cameraRigMode&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const c of this._beforeClearStage)c.action();this._clearFrameBuffer(this.activeCamera);for(const c of this._gatherRenderTargetsStage)c.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let c=0;c<this.activeCameras.length;c++)this._processSubCameras(this.activeCameras[c],c>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._checkIntersections();for(const c of this._afterRenderStage)c.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let c=0;c<this._toBeDisposed.length;c++){const h=this._toBeDisposed[c];h&&h.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}freezeMaterials(){for(let t=0;t<this.materials.length;t++)this.materials[t].freeze()}unfreezeMaterials(){for(let t=0;t<this.materials.length;t++)this.materials[t].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=new Array,this.stopAllAnimations&&this.stopAllAnimations(),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const t=this._activeRequests.slice();for(const o of t)o.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(o){console.error("An error occurred while calling onDisposeObservable!",o)}if(this.detachControl(),this._engine.getInputElement())for(let o=0;o<this.cameras.length;o++)this.cameras[o].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,o=>o.dispose(!0)),this._disposeList(this.transformNodes,o=>o.dispose(!0)),this._disposeList(this.cameras),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let n=this._engine.scenes.indexOf(this);n>-1&&this._engine.scenes.splice(n,1),be._LastCreatedScene===this&&(be._LastCreatedScene=this._engine.scenes.length>0?this._engine.scenes[this._engine.scenes.length-1]:null),n=this._engine._virtualScenes.indexOf(this),n>-1&&this._engine._virtualScenes.splice(n,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this._isDisposed=!0}_disposeList(t,i){const s=t.slice(0);i=i??(n=>n.dispose());for(const n of s)i(n);t.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let t=0;t<this.meshes.length;t++){const s=this.meshes[t].geometry;s&&s.clearCachedData()}}cleanCachedTextureBuffer(){for(const t of this.textures)t._buffer&&(t._buffer=null)}getWorldExtends(t){const i=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new v(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return this.meshes.filter(t=t||(()=>!0)).forEach(n=>{if(n.computeWorldMatrix(!0),!n.subMeshes||0===n.subMeshes.length||n.infiniteDistance)return;const o=n.getBoundingInfo(),l=o.boundingBox.maximumWorld;v.CheckExtends(o.boundingBox.minimumWorld,i,s),v.CheckExtends(l,i,s)}),{min:i,max:s}}createPickingRay(t,i,s,n,o=!1){throw Ge("Ray")}createPickingRayToRef(t,i,s,n,o,a=!1,l=!1){throw Ge("Ray")}createPickingRayInCameraSpace(t,i,s){throw Ge("Ray")}createPickingRayInCameraSpaceToRef(t,i,s,n){throw Ge("Ray")}get _pickingAvailable(){return!1}pick(t,i,s,n,o,a){return new Os}pickWithBoundingInfo(t,i,s,n,o){return new Os}pickWithRay(t,i,s,n){throw Ge("Ray")}multiPick(t,i,s,n,o){throw Ge("Ray")}multiPickWithRay(t,i,s){throw Ge("Ray")}setPointerOverMesh(t,i,s){this._inputManager.setPointerOverMesh(t,i,s)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const t of this.geometries)t._rebuild();for(const t of this.meshes)t._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const t of this._components)t.rebuild();for(const t of this.particleSystems)t.rebuild();if(this.spriteManagers)for(const t of this.spriteManagers)t.rebuild()}_rebuildTextures(){for(const t of this.textures)t._rebuild();this.markAllMaterialsAsDirty(1)}_getByTags(t,i,s){if(void 0===i)return t;const n=[];s=s||(o=>{});for(const o in t){const a=t[o];Et&&Et.MatchesQuery(a,i)&&(n.push(a),s(a))}return n}getMeshesByTags(t,i){return this._getByTags(this.meshes,t,i)}getCamerasByTags(t,i){return this._getByTags(this.cameras,t,i)}getLightsByTags(t,i){return this._getByTags(this.lights,t,i)}getMaterialByTags(t,i){return this._getByTags(this.materials,t,i).concat(this._getByTags(this.multiMaterials,t,i))}getTransformNodesByTags(t,i){return this._getByTags(this.transformNodes,t,i)}setRenderingOrder(t,i=null,s=null,n=null){this._renderingManager.setRenderingOrder(t,i,s,n)}setRenderingAutoClearDepthStencil(t,i,s=!0,n=!0){this._renderingManager.setRenderingAutoClearDepthStencil(t,i,s,n)}getAutoClearDepthStencilSetup(t){return this._renderingManager.getAutoClearDepthStencilSetup(t)}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(t){this._blockMaterialDirtyMechanism!==t&&(this._blockMaterialDirtyMechanism=t,t||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(t,i){if(!this._blockMaterialDirtyMechanism)for(const s of this.materials)i&&!i(s)||s.markAsDirty(t)}_loadFile(t,i,s,n,o,a,l){const c=ql(t,i,s,n?this.offlineProvider:void 0,o,a,l);return this._activeRequests.push(c),c.onCompleteObservable.add(h=>{this._activeRequests.splice(this._activeRequests.indexOf(h),1)}),c}_loadFileAsync(t,i,s,n,o){return new Promise((a,l)=>{this._loadFile(t,c=>{a(c)},i,s,n,(c,h)=>{l(h)},o)})}_requestFile(t,i,s,n,o,a,l){const c=fE(t,i,s,n?this.offlineProvider:void 0,o,a,l);return this._activeRequests.push(c),c.onCompleteObservable.add(h=>{this._activeRequests.splice(this._activeRequests.indexOf(h),1)}),c}_requestFileAsync(t,i,s,n,o){return new Promise((a,l)=>{this._requestFile(t,c=>{a(c)},i,s,n,c=>{l(c)},o)})}_readFile(t,i,s,n,o){const a=hp(t,i,s,n,o);return this._activeRequests.push(a),a.onCompleteObservable.add(l=>{this._activeRequests.splice(this._activeRequests.indexOf(l),1)}),a}_readFileAsync(t,i,s){return new Promise((n,o)=>{this._readFile(t,a=>{n(a)},i,s,a=>{o(a)})})}getPerfCollector(){throw Ge("performanceViewerSceneExtension")}}return r.FOGMODE_NONE=0,r.FOGMODE_EXP=1,r.FOGMODE_EXP2=2,r.FOGMODE_LINEAR=3,r.MinDeltaTime=1,r.MaxDeltaTime=1e3,r})();ge.prototype.setActiveCameraByID=function(r){return this.setActiveCameraById(r)},ge.prototype.getLastMaterialByID=function(r){return this.getLastMaterialById(r)},ge.prototype.getMaterialByID=function(r){return this.getMaterialById(r)},ge.prototype.getTextureByUniqueID=function(r){return this.getTextureByUniqueId(r)},ge.prototype.getCameraByID=function(r){return this.getCameraById(r)},ge.prototype.getCameraByUniqueID=function(r){return this.getCameraByUniqueId(r)},ge.prototype.getBoneByID=function(r){return this.getBoneById(r)},ge.prototype.getLightByID=function(r){return this.getLightById(r)},ge.prototype.getLightByUniqueID=function(r){return this.getLightByUniqueId(r)},ge.prototype.getParticleSystemByID=function(r){return this.getParticleSystemById(r)},ge.prototype.getGeometryByID=function(r){return this.getGeometryById(r)},ge.prototype.getMeshByID=function(r){return this.getMeshById(r)},ge.prototype.getMeshesByID=function(r){return this.getMeshesById(r)},ge.prototype.getTransformNodeByID=function(r){return this.getTransformNodeById(r)},ge.prototype.getTransformNodeByUniqueID=function(r){return this.getTransformNodeByUniqueId(r)},ge.prototype.getTransformNodesByID=function(r){return this.getTransformNodesById(r)},ge.prototype.getMeshByUniqueID=function(r){return this.getMeshByUniqueId(r)},ge.prototype.getLastMeshByID=function(r){return this.getLastMeshById(r)},ge.prototype.getLastEntryByID=function(r){return this.getLastEntryById(r)},ge.prototype.getNodeByID=function(r){return this.getNodeById(r)},ge.prototype.getLastSkeletonByID=function(r){return this.getLastSkeletonById(r)};var $e=(()=>{return(r=$e||($e={}))[r.LOCAL=0]="LOCAL",r[r.WORLD=1]="WORLD",r[r.BONE=2]="BONE",$e;var r})();class fs{}fs.X=new v(1,0,0),fs.Y=new v(0,1,0),fs.Z=new v(0,0,1);var Kl=(()=>{return(r=Kl||(Kl={}))[r.X=0]="X",r[r.Y=1]="Y",r[r.Z=2]="Z",Kl;var r})();class Ht extends Rt{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){this._needToCompose=!1,e.updateFlag!==this._localMatrix.updateFlag&&(this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,s=null,n=null,o=null,a=null){super(e,t.getScene()),this.name=e,this.children=new Array,this.animations=new Array,this._index=null,this._absoluteTransform=new F,this._invertedAbsoluteTransform=new F,this._scalingDeterminant=1,this._worldTransform=new F,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=s?s.clone():F.Identity(),this._restPose=n||this._localMatrix.clone(),this._baseMatrix=o||this._localMatrix.clone(),this._index=a,t.bones.push(this),this.setParent(i,!1),(o||s)&&this._updateDifferenceMatrix()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return null===this._index?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const i=this.parent.children.indexOf(this);-1!==i&&this.parent.children.splice(i,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateDifferenceMatrix(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBaseMatrix(){return this._baseMatrix}getRestPose(){return this._restPose}setRestPose(e){this._restPose.copyFrom(e)}getBindPose(){return this._baseMatrix}setBindPose(e){this.updateMatrix(e)}getWorldMatrix(){return this._worldTransform}returnToRest(){var e;if(this._linkedTransformNode){const t=L.Vector3[0],i=L.Quaternion[0],s=L.Vector3[1];this.getRestPose().decompose(t,i,s),this._linkedTransformNode.position.copyFrom(s),this._linkedTransformNode.rotationQuaternion=null!==(e=this._linkedTransformNode.rotationQuaternion)&&void 0!==e?e:Z.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(i),this._linkedTransformNode.scaling.copyFrom(t)}else this._matrix=this._restPose}getInvertedAbsoluteTransform(){return this._invertedAbsoluteTransform}getAbsoluteTransform(){return this._absoluteTransform}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){!this._needToDecompose||(this._needToDecompose=!1,this._localScaling||(this._localScaling=v.Zero(),this._localRotation=Z.Zero(),this._localPosition=v.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling)return void(this._needToCompose=!1);this._needToCompose=!1,F.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(e,t=!0,i=!0){this._baseMatrix.copyFrom(e),t&&this._updateDifferenceMatrix(),i?this._matrix=e:this.markAsDirty()}_updateDifferenceMatrix(e,t=!0){if(e||(e=this._baseMatrix),this.parent?e.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(e),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform),t)for(let i=0;i<this.children.length;i++)this.children[i]._updateDifferenceMatrix();this._scalingDeterminant=this._absoluteTransform.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}translate(e,t=$e.LOCAL,i){const s=this.getLocalMatrix();if(t==$e.LOCAL)s.addAtIndex(12,e.x),s.addAtIndex(13,e.y),s.addAtIndex(14,e.z);else{let n=null;i&&(n=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const o=Ht._TmpMats[0],a=Ht._TmpVecs[0];this.parent?i&&n?(o.copyFrom(this.parent.getAbsoluteTransform()),o.multiplyToRef(n,o)):o.copyFrom(this.parent.getAbsoluteTransform()):F.IdentityToRef(o),o.setTranslationFromFloats(0,0,0),o.invert(),v.TransformCoordinatesToRef(e,o,a),s.addAtIndex(12,a.x),s.addAtIndex(13,a.y),s.addAtIndex(14,a.z)}this._markAsDirtyAndDecompose()}setPosition(e,t=$e.LOCAL,i){const s=this.getLocalMatrix();if(t==$e.LOCAL)s.setTranslationFromFloats(e.x,e.y,e.z);else{let n=null;i&&(n=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const o=Ht._TmpMats[0],a=Ht._TmpVecs[0];this.parent?(i&&n?(o.copyFrom(this.parent.getAbsoluteTransform()),o.multiplyToRef(n,o)):o.copyFrom(this.parent.getAbsoluteTransform()),o.invert()):F.IdentityToRef(o),v.TransformCoordinatesToRef(e,o,a),s.setTranslationFromFloats(a.x,a.y,a.z)}this._markAsDirtyAndDecompose()}setAbsolutePosition(e,t){this.setPosition(e,$e.WORLD,t)}scale(e,t,i,s=!1){const n=this.getLocalMatrix(),o=Ht._TmpMats[0];F.ScalingToRef(e,t,i,o),o.multiplyToRef(n,n),o.invert();for(const a of this.children){const l=a.getLocalMatrix();l.multiplyToRef(o,l),l.multiplyAtIndex(12,e),l.multiplyAtIndex(13,t),l.multiplyAtIndex(14,i),a._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),s)for(const a of this.children)a.scale(e,t,i,s)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,s=$e.LOCAL,n){if(s===$e.LOCAL){const l=Ht._TmpQuat;return Z.RotationYawPitchRollToRef(e,t,i,l),void this.setRotationQuaternion(l,s,n)}const o=Ht._TmpMats[0];if(!this._getNegativeRotationToRef(o,n))return;const a=Ht._TmpMats[1];F.RotationYawPitchRollToRef(e,t,i,a),o.multiplyToRef(a,a),this._rotateWithMatrix(a,s,n)}rotate(e,t,i=$e.LOCAL,s){const n=Ht._TmpMats[0];n.setTranslationFromFloats(0,0,0),F.RotationAxisToRef(e,t,n),this._rotateWithMatrix(n,i,s)}setAxisAngle(e,t,i=$e.LOCAL,s){if(i===$e.LOCAL){const a=Ht._TmpQuat;return Z.RotationAxisToRef(e,t,a),void this.setRotationQuaternion(a,i,s)}const n=Ht._TmpMats[0];if(!this._getNegativeRotationToRef(n,s))return;const o=Ht._TmpMats[1];F.RotationAxisToRef(e,t,o),n.multiplyToRef(o,o),this._rotateWithMatrix(o,i,s)}setRotation(e,t=$e.LOCAL,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=$e.LOCAL,i){if(t===$e.LOCAL)return this._decompose(),this._localRotation.copyFrom(e),void this._markAsDirtyAndCompose();const s=Ht._TmpMats[0];if(!this._getNegativeRotationToRef(s,i))return;const n=Ht._TmpMats[1];F.FromQuaternionToRef(e,n),s.multiplyToRef(n,n),this._rotateWithMatrix(n,t,i)}setRotationMatrix(e,t=$e.LOCAL,i){if(t===$e.LOCAL){const o=Ht._TmpQuat;return Z.FromRotationMatrixToRef(e,o),void this.setRotationQuaternion(o,t,i)}const s=Ht._TmpMats[0];if(!this._getNegativeRotationToRef(s,i))return;const n=Ht._TmpMats[1];n.copyFrom(e),s.multiplyToRef(e,n),this._rotateWithMatrix(n,t,i)}_rotateWithMatrix(e,t=$e.LOCAL,i){const s=this.getLocalMatrix(),n=s.m[12],o=s.m[13],a=s.m[14],l=this.getParent(),c=Ht._TmpMats[3],h=Ht._TmpMats[4];l&&t==$e.WORLD?(i?(c.copyFrom(i.getWorldMatrix()),l.getAbsoluteTransform().multiplyToRef(c,c)):c.copyFrom(l.getAbsoluteTransform()),h.copyFrom(c),h.invert(),s.multiplyToRef(c,s),s.multiplyToRef(e,s),s.multiplyToRef(h,s)):t==$e.WORLD&&i?(c.copyFrom(i.getWorldMatrix()),h.copyFrom(c),h.invert(),s.multiplyToRef(c,s),s.multiplyToRef(e,s),s.multiplyToRef(h,s)):s.multiplyToRef(e,s),s.setTranslationFromFloats(n,o,a),this.computeAbsoluteTransforms(),this._markAsDirtyAndDecompose()}_getNegativeRotationToRef(e,t){const i=Ht._TmpMats[2];return e.copyFrom(this.getAbsoluteTransform()),t?(e.multiplyToRef(t.getWorldMatrix(),e),F.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):F.IdentityToRef(i),e.invert(),!isNaN(e.m[0])&&(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=$e.LOCAL,t=null){const i=v.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=$e.LOCAL,t,i){if(e==$e.LOCAL){const s=this.getLocalMatrix();i.x=s.m[12],i.y=s.m[13],i.z=s.m[14]}else{let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();let n=Ht._TmpMats[0];t&&s?(n.copyFrom(this.getAbsoluteTransform()),n.multiplyToRef(s,n)):n=this.getAbsoluteTransform(),i.x=n.m[12],i.y=n.m[13],i.z=n.m[14]}}getAbsolutePosition(e=null){const t=v.Zero();return this.getPositionToRef($e.WORLD,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef($e.WORLD,e,t)}computeAbsoluteTransforms(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform);else{this._absoluteTransform.copyFrom(this._localMatrix);const i=this._skeleton.getPoseMatrix();i&&this._absoluteTransform.multiplyToRef(i,this._absoluteTransform)}const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteTransforms()}getDirection(e,t=null){const i=v.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const n=Ht._TmpMats[0];n.copyFrom(this.getAbsoluteTransform()),t&&s&&n.multiplyToRef(s,n),v.TransformNormalToRef(e,n,i),i.normalize()}getRotation(e=$e.LOCAL,t=null){const i=v.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=$e.LOCAL,t=null,i){const s=Ht._TmpQuat;this.getRotationQuaternionToRef(e,t,s),s.toEulerAnglesToRef(i)}getRotationQuaternion(e=$e.LOCAL,t=null){const i=Z.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=$e.LOCAL,t=null,i){if(e==$e.LOCAL)this._decompose(),i.copyFrom(this._localRotation);else{const s=Ht._TmpMats[0],n=this.getAbsoluteTransform();t?n.multiplyToRef(t.getWorldMatrix(),s):s.copyFrom(n),s.multiplyAtIndex(0,this._scalingDeterminant),s.multiplyAtIndex(1,this._scalingDeterminant),s.multiplyAtIndex(2,this._scalingDeterminant),s.decompose(void 0,i,void 0)}}getRotationMatrix(e=$e.LOCAL,t){const i=F.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=$e.LOCAL,t,i){if(e==$e.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(i);else{const s=Ht._TmpMats[0],n=this.getAbsoluteTransform();t?n.multiplyToRef(t.getWorldMatrix(),s):s.copyFrom(n),s.multiplyAtIndex(0,this._scalingDeterminant),s.multiplyAtIndex(1,this._scalingDeterminant),s.multiplyAtIndex(2,this._scalingDeterminant),s.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){const i=v.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();let n=Ht._TmpMats[0];t&&s?(n.copyFrom(this.getAbsoluteTransform()),n.multiplyToRef(s,n)):n=this.getAbsoluteTransform(),v.TransformCoordinatesToRef(e,n,i)}getLocalPositionFromAbsolute(e,t=null){const i=v.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const n=Ht._TmpMats[0];n.copyFrom(this.getAbsoluteTransform()),t&&s&&n.multiplyToRef(s,n),n.invert(),v.TransformCoordinatesToRef(e,n,i)}setCurrentPoseAsRest(){this.setRestPose(this.getLocalMatrix())}}Ht._TmpVecs=is.BuildArray(2,v.Zero),Ht._TmpQuat=Z.Identity(),Ht._TmpMats=is.BuildArray(5,F.Identity);class g1{get syncRoot(){return this._syncRoot}get masterFrame(){return 0===this._runtimeAnimations.length?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){this._weight=-1!==e?Math.min(Math.max(e,0),1):-1}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,null!==this._goToFrame&&this.goToFrame(this._goToFrame)}constructor(e,t,i=0,s=100,n=!1,o=1,a,l,c,h=!1){this.target=t,this.fromFrame=i,this.toFrame=s,this.loopAnimation=n,this.onAnimationEnd=a,this.onAnimationLoop=c,this.isAdditive=h,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new z,this.onAnimationLoopObservable=new z,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=o,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const t=this._scene._activeAnimatables.indexOf(this);t>-1&&(this._scene._activeAnimatables.splice(t,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const n=new xie(e,t[i],this._scene,this);n._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(n)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e){var t;const i=this._runtimeAnimations;if(i[0]){const s=i[0].animation.framePerSecond;this._frameToSyncFromJump=null!==(t=this._frameToSyncFromJump)&&void 0!==t?t:i[0].currentFrame,this._manualJumpDelay=-(0===this.speedRatio?0:(e-this._frameToSyncFromJump)/s*1e3/this.speedRatio)}for(let s=0;s<i.length;s++)i[s].goToFrame(e);this._goToFrame=e}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1){if(e||t){const s=this._scene._activeAnimatables.indexOf(this);if(s>-1){const n=this._runtimeAnimations;for(let o=n.length-1;o>=0;o--){const a=n[o];e&&a.animation.name!=e||t&&!t(a.target)||(a.dispose(),n.splice(o,1))}0==n.length&&(i||this._scene._activeAnimatables.splice(s,1),this._raiseOnAnimationEnd())}}else{const s=this._scene._activeAnimatables.indexOf(this);s>-1&&(i||this._scene._activeAnimatables.splice(s,1),this._runtimeAnimations.length=0,this._raiseOnAnimationEnd())}}waitAsync(){return new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){if(this._paused)return this.animationStarted=!1,null===this._pausedDelay&&(this._pausedDelay=e),!0;if(null===this._localDelayOffset?(this._localDelayOffset=e,this._pausedDelay=null):null!==this._pausedDelay&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),null!==this._manualJumpDelay&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,0===this._weight)return!0;let t=!1;const i=this._runtimeAnimations;let s;for(s=0;s<i.length;s++){const o=i[s].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||o}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(s=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(s,1),s=0;s<i.length;s++)i[s].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}ge.prototype._animate=function(){if(!this.animationsEnabled)return;const r=ir.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=r}this.deltaTime=this.useConstantAnimationDeltaTime?16:(r-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=r;const e=this._activeAnimatables;if(0===e.length)return;this._animationTime+=this.deltaTime;const t=this._animationTime;for(let i=0;i<e.length;i++){const s=e[i];!s._animate(t)&&s.disposeOnEnd&&i--}this._processLateAnimationBindings()},ge.prototype.beginWeightedAnimation=function(r,e,t,i=1,s,n=1,o,a,l,c,h=!1){const u=this.beginAnimation(r,e,t,s,n,o,a,!1,l,c,h);return u.weight=i,u},ge.prototype.beginAnimation=function(r,e,t,i,s=1,n,o,a=!0,l,c,h=!1){e>t&&s>0&&(s*=-1),a&&this.stopAnimation(r,void 0,l),o||(o=new g1(this,r,e,t,i,s,n,void 0,c,h));const u=!l||l(r);if(r.animations&&u&&o.appendAnimations(r,r.animations),r.getAnimatables){const d=r.getAnimatables();for(let f=0;f<d.length;f++)this.beginAnimation(d[f],e,t,i,s,n,o,a,l,c)}return o.reset(),o},ge.prototype.beginHierarchyAnimation=function(r,e,t,i,s,n=1,o,a,l=!0,c,h,u=!1){const d=r.getDescendants(e),f=[];f.push(this.beginAnimation(r,t,i,s,n,o,a,l,c,void 0,u));for(const p of d)f.push(this.beginAnimation(p,t,i,s,n,o,a,l,c,void 0,u));return f},ge.prototype.beginDirectAnimation=function(r,e,t,i,s,n,o,a,l=!1){if(void 0===n&&(n=1),t>i&&n>0)n*=-1;else if(i>t&&n<0){const h=i;i=t,t=h}return new g1(this,r,t,i,s,n,o,e,a,l)},ge.prototype.beginDirectHierarchyAnimation=function(r,e,t,i,s,n,o,a,l,c=!1){const h=r.getDescendants(e),u=[];u.push(this.beginDirectAnimation(r,t,i,s,n,o,a,l,c));for(const d of h)u.push(this.beginDirectAnimation(d,t,i,s,n,o,a,l,c));return u},ge.prototype.getAnimatableByTarget=function(r){for(let e=0;e<this._activeAnimatables.length;e++)if(this._activeAnimatables[e].target===r)return this._activeAnimatables[e];return null},ge.prototype.getAllAnimatablesByTarget=function(r){const e=[];for(let t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].target===r&&e.push(this._activeAnimatables[t]);return e},ge.prototype.stopAnimation=function(r,e,t){const i=this.getAllAnimatablesByTarget(r);for(const s of i)s.stop(e,t)},ge.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let r=0;r<this._activeAnimatables.length;r++)this._activeAnimatables[r].stop();this._activeAnimatables.length=0}for(const r of this.animationGroups)r.stop()},ge.prototype._registerTargetForLateAnimationBinding=function(r,e){const t=r.target;this._registeredForLateAnimationBindings.pushNoDuplicate(t),t._lateAnimationHolders||(t._lateAnimationHolders={}),t._lateAnimationHolders[r.targetPath]||(t._lateAnimationHolders[r.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:e}),r.isAdditive?(t._lateAnimationHolders[r.targetPath].additiveAnimations.push(r),t._lateAnimationHolders[r.targetPath].totalAdditiveWeight+=r.weight):(t._lateAnimationHolders[r.targetPath].animations.push(r),t._lateAnimationHolders[r.targetPath].totalWeight+=r.weight)},ge.prototype._processLateAnimationBindingsForMatrices=function(r){if(0===r.totalWeight&&0===r.totalAdditiveWeight)return r.originalValue;let e=1;const t=L.Vector3[0],i=L.Vector3[1],s=L.Quaternion[0];let n=0;const o=r.animations[0];let l=1,c=!1;if(r.totalWeight<1)l=1-r.totalWeight,r.originalValue.decompose(i,s,t);else{if(n=1,e=r.totalWeight,l=o.weight/e,1==l){if(!r.totalAdditiveWeight)return o.currentValue;c=!0}o.currentValue.decompose(i,s,t)}if(!c){i.scaleInPlace(l),t.scaleInPlace(l),s.scaleInPlace(l);for(let u=n;u<r.animations.length;u++){const d=r.animations[u];if(0===d.weight)continue;l=d.weight/e;const f=L.Vector3[2],p=L.Vector3[3],_=L.Quaternion[1];d.currentValue.decompose(p,_,f),p.scaleAndAddToRef(l,i),_.scaleAndAddToRef(Z.Dot(s,_)>0?l:-l,s),f.scaleAndAddToRef(l,t)}s.normalize()}for(let u=0;u<r.additiveAnimations.length;u++){const d=r.additiveAnimations[u];if(0===d.weight)continue;const f=L.Vector3[2],p=L.Vector3[3],_=L.Quaternion[1];d.currentValue.decompose(p,_,f),p.multiplyToRef(i,p),v.LerpToRef(i,p,d.weight,i),s.multiplyToRef(_,_),Z.SlerpToRef(s,_,d.weight,s),f.scaleAndAddToRef(d.weight,t)}const h=o?o._animationState.workValue:L.Matrix[0].clone();return F.ComposeToRef(i,s,t,h),h},ge.prototype._processLateAnimationBindingsForQuaternions=function(r,e){if(0===r.totalWeight&&0===r.totalAdditiveWeight)return e;const t=r.animations[0],i=r.originalValue;let s=e;if(0===r.totalWeight&&r.totalAdditiveWeight>0)s.copyFrom(i);else if(1===r.animations.length){if(Z.SlerpToRef(i,t.currentValue,Math.min(1,r.totalWeight),s),0===r.totalAdditiveWeight)return s}else if(r.animations.length>1){let o,a,n=1;if(r.totalWeight<1){const c=1-r.totalWeight;o=[],a=[],o.push(i),a.push(c)}else{if(2===r.animations.length&&(Z.SlerpToRef(r.animations[0].currentValue,r.animations[1].currentValue,r.animations[1].weight/r.totalWeight,e),0===r.totalAdditiveWeight))return e;o=[],a=[],n=r.totalWeight}for(let c=0;c<r.animations.length;c++){const h=r.animations[c];o.push(h.currentValue),a.push(h.weight/n)}let l=0;for(let c=0;c<o.length;)c?(l+=a[c],Z.SlerpToRef(s,o[c],a[c]/l,s),c++):(Z.SlerpToRef(o[c],o[c+1],a[c+1]/(a[c]+a[c+1]),e),s=e,l=a[c]+a[c+1],c+=2)}for(let n=0;n<r.additiveAnimations.length;n++){const o=r.additiveAnimations[n];0!==o.weight&&(s.multiplyToRef(o.currentValue,L.Quaternion[0]),Z.SlerpToRef(s,L.Quaternion[0],o.weight,s))}return s},ge.prototype._processLateAnimationBindings=function(){if(this._registeredForLateAnimationBindings.length){for(let r=0;r<this._registeredForLateAnimationBindings.length;r++){const e=this._registeredForLateAnimationBindings.data[r];for(const t in e._lateAnimationHolders){const i=e._lateAnimationHolders[t],s=i.animations[0],n=i.originalValue;if(null==n)continue;let a=e[t];if($.AllowMatrixDecomposeForInterpolation&&n.m)a=this._processLateAnimationBindingsForMatrices(i);else if(void 0!==n.w)a=this._processLateAnimationBindingsForQuaternions(i,a||Z.Identity());else{let c=0,h=1;if(i.totalWeight<1)a=s&&n.scale?n.scale(1-i.totalWeight):s?n*(1-i.totalWeight):n.clone?n.clone():n;else if(s){h=i.totalWeight;const u=s.weight/h;a=1!==u?s.currentValue.scale?s.currentValue.scale(u):s.currentValue*u:s.currentValue,c=1}for(let u=c;u<i.animations.length;u++){const d=i.animations[u],f=d.weight/h;f&&(d.currentValue.scaleAndAddToRef?d.currentValue.scaleAndAddToRef(f,a):a+=d.currentValue*f)}for(let u=0;u<i.additiveAnimations.length;u++){const d=i.additiveAnimations[u],f=d.weight;f&&(d.currentValue.scaleAndAddToRef?d.currentValue.scaleAndAddToRef(f,a):a+=d.currentValue*f)}}e[t]=a}e._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}},Ht.prototype.copyAnimationRange=function(r,e,t,i=!1,s=null){0===this.animations.length&&(this.animations.push(new $(this.name,"_matrix",r.animations[0].framePerSecond,$.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const n=r.animations[0].getRange(e);if(!n)return!1;const o=n.from,a=n.to,l=r.animations[0].getKeys(),c=r.length,h=r.getParent(),u=this.getParent(),d=i&&h&&c&&this.length&&c!==this.length,f=d&&u&&h?u.length/h.length:1,p=i&&!u&&s&&(1!==s.x||1!==s.y||1!==s.z),_=this.animations[0].getKeys();let m,g,b;for(let y=0,T=l.length;y<T;y++)m=l[y],m.frame>=o&&m.frame<=a&&(i?(b=m.value.clone(),d?(g=b.getTranslation(),b.setTranslation(g.scaleInPlace(f))):p&&s?(g=b.getTranslation(),b.setTranslation(g.multiplyInPlace(s))):b=m.value):b=m.value,_.push({frame:m.frame+t,value:b}));return this.animations[0].createRange(e,o+t,a+t),!0};var th=(()=>{return(r=th||(th={}))[r.CW=0]="CW",r[r.CCW=1]="CCW",th;var r})();class Ql{constructor(e){this._radians=e,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return 180*this._radians/Math.PI}radians(){return this._radians}static BetweenTwoPoints(e,t){const i=t.subtract(e),s=Math.atan2(i.y,i.x);return new Ql(s)}static FromRadians(e){return new Ql(e)}static FromDegrees(e){return new Ql(e*Math.PI/180)}}class Yie{constructor(e,t,i){this.startPoint=e,this.midPoint=t,this.endPoint=i;const s=Math.pow(t.x,2)+Math.pow(t.y,2),n=(Math.pow(e.x,2)+Math.pow(e.y,2)-s)/2,o=(s-Math.pow(i.x,2)-Math.pow(i.y,2))/2,a=(e.x-t.x)*(t.y-i.y)-(t.x-i.x)*(e.y-t.y);this.centerPoint=new de((n*(t.y-i.y)-o*(e.y-t.y))/a,((e.x-t.x)*o-(t.x-i.x)*n)/a),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=Ql.BetweenTwoPoints(this.centerPoint,this.startPoint);const l=this.startAngle.degrees();let c=Ql.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),h=Ql.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();c-l>180&&(c-=360),c-l<-180&&(c+=360),h-c>180&&(h-=360),h-c<-180&&(h+=360),this.orientation=c-l<0?th.CW:th.CCW,this.angle=Ql.FromDegrees(this.orientation===th.CW?l-h:h-l)}}class vE{constructor(e,t){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new de(e,t))}addLineTo(e,t){if(this.closed)return this;const i=new de(e,t),s=this._points[this._points.length-1];return this._points.push(i),this._length+=i.subtract(s).length(),this}addArcTo(e,t,i,s,n=36){if(this.closed)return this;const o=this._points[this._points.length-1],a=new de(e,t),l=new de(i,s),c=new Yie(o,a,l);let h=c.angle.radians()/n;c.orientation===th.CW&&(h*=-1);let u=c.startAngle.radians()+h;for(let d=0;d<n;d++){const f=Math.cos(u)*c.radius+c.centerPoint.x,p=Math.sin(u)*c.radius+c.centerPoint.y;this.addLineTo(f,p),u+=h}return this}close(){return this.closed=!0,this}length(){let e=this._length;return this.closed&&(e+=this._points[0].subtract(this._points[this._points.length-1]).length()),e}getPoints(){return this._points}getPointAtLengthPosition(e){if(e<0||e>1)return de.Zero();const t=e*this.length();let i=0;for(let s=0;s<this._points.length;s++){const o=this._points[s],l=this._points[(s+1)%this._points.length].subtract(o),c=l.length()+i;if(t>=i&&t<=c){const h=l.normalize(),u=t-i;return new de(o.x+h.x*u,o.y+h.y*u)}i=c}return de.Zero()}static StartingAt(e,t){return new vE(e,t)}}class pp{constructor(e,t=null,i,s=!1){this.path=e,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:v.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:F.Identity()};for(let n=0;n<e.length;n++)this._curve[n]=e[n].clone();this._raw=i||!1,this._alignTangentsWithPath=s,this._compute(t,s)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(e){return this._updatePointAtData(e).point}getTangentAt(e,t=!1){return this._updatePointAtData(e,t),t?v.TransformCoordinates(v.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(e,t=!1){return this._updatePointAtData(e,t),t?v.TransformCoordinates(v.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(e,t=!1){return this._updatePointAtData(e,t),t?v.TransformCoordinates(v.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(e){return this.length()*e}getPreviousPointIndexAt(e){return this._updatePointAtData(e),this._pointAtData.previousPointArrayIndex}getSubPositionAt(e){return this._updatePointAtData(e),this._pointAtData.subPosition}getClosestPositionTo(e){let t=Number.MAX_VALUE,i=0;for(let s=0;s<this._curve.length-1;s++){const n=this._curve[s+0],o=this._curve[s+1].subtract(n).normalize(),a=this._distances[s+1]-this._distances[s+0],l=Math.min(Math.max(v.Dot(o,e.subtract(n).normalize()),0)*v.Distance(n,e)/a,1),c=v.Distance(n.add(o.scale(l*a)),e);c<t&&(t=c,i=(this._distances[s+0]+a*l)/this.length())}return i}slice(e=0,t=1){if(e<0&&(e=1- -1*e%1),t<0&&(t=1- -1*t%1),e>t){const c=e;e=t,t=c}const i=this.getCurve(),s=this.getPointAt(e);let n=this.getPreviousPointIndexAt(e);const o=this.getPointAt(t),a=this.getPreviousPointIndexAt(t)+1,l=[];return 0!==e&&(n++,l.push(s)),l.push(...i.slice(n,a)),(1!==t||1===e)&&l.push(o),new pp(l,this.getNormalAt(e),this._raw,this._alignTangentsWithPath)}update(e,t=null,i=!1){for(let s=0;s<e.length;s++)this._curve[s].x=e[s].x,this._curve[s].y=e[s].y,this._curve[s].z=e[s].z;return this._compute(t,i),this}_compute(e,t=!1){const i=this._curve.length;if(i<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[i-1]=this._curve[i-1].subtract(this._curve[i-2]),this._raw||this._tangents[i-1].normalize();const s=this._tangents[0],n=this._normalVector(s,e);let o,a,l,c,h;this._normals[0]=n,this._raw||this._normals[0].normalize(),this._binormals[0]=v.Cross(s,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(let u=1;u<i;u++)o=this._getLastNonNullVector(u),u<i-1&&(a=this._getFirstNonNullVector(u),this._tangents[u]=t?a:o.add(a),this._tangents[u].normalize()),this._distances[u]=this._distances[u-1]+this._curve[u].subtract(this._curve[u-1]).length(),l=this._tangents[u],h=this._binormals[u-1],this._normals[u]=v.Cross(h,l),this._raw||(0===this._normals[u].length()?(c=this._normals[u-1],this._normals[u]=c.clone()):this._normals[u].normalize()),this._binormals[u]=v.Cross(l,this._normals[u]),this._raw||this._binormals[u].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(e){let t=1,i=this._curve[e+t].subtract(this._curve[e]);for(;0===i.length()&&e+t+1<this._curve.length;)t++,i=this._curve[e+t].subtract(this._curve[e]);return i}_getLastNonNullVector(e){let t=1,i=this._curve[e].subtract(this._curve[e-t]);for(;0===i.length()&&e>t+1;)t++,i=this._curve[e].subtract(this._curve[e-t]);return i}_normalVector(e,t){let i,s=e.length();if(0===s&&(s=1),null==t){let n;n=oe.WithinEpsilon(Math.abs(e.y)/s,1,ot)?oe.WithinEpsilon(Math.abs(e.x)/s,1,ot)?oe.WithinEpsilon(Math.abs(e.z)/s,1,ot)?v.Zero():new v(0,0,1):new v(1,0,0):new v(0,-1,0),i=v.Cross(e,n)}else i=v.Cross(e,t),v.CrossToRef(i,e,i);return i.normalize(),i}_updatePointAtData(e,t=!1){if(this._pointAtData.id===e)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=e;const i=this.getPoints();if(e<=0)return this._setPointAtData(0,0,i[0],0,t);if(e>=1)return this._setPointAtData(1,1,i[i.length-1],i.length-1,t);let n,s=i[0],o=0;const a=e*this.length();for(let l=1;l<i.length;l++){n=i[l];const c=v.Distance(s,n);if(o+=c,o===a)return this._setPointAtData(e,1,n,l,t);if(o>a){const u=(o-a)/c,d=s.subtract(n),f=n.add(d.scaleInPlace(u));return this._setPointAtData(e,1-u,f,l-1,t)}s=n}return this._pointAtData}_setPointAtData(e,t,i,s,n){return this._pointAtData.point=i,this._pointAtData.position=e,this._pointAtData.subPosition=t,this._pointAtData.previousPointArrayIndex=s,this._pointAtData.interpolateReady=n,n&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=F.Identity();const e=this._pointAtData.previousPointArrayIndex;if(e!==this._tangents.length-1){const t=e+1,i=this._tangents[e].clone(),s=this._normals[e].clone(),n=this._binormals[e].clone(),o=this._tangents[t].clone(),a=this._normals[t].clone(),l=this._binormals[t].clone(),c=Z.RotationQuaternionFromAxis(s,n,i),h=Z.RotationQuaternionFromAxis(a,l,o);Z.Slerp(c,h,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class Ka{static CreateQuadraticBezier(e,t,i,s){s=s>2?s:3;const n=new Array,o=(a,l,c,h)=>(1-a)*(1-a)*l+2*a*(1-a)*c+a*a*h;for(let a=0;a<=s;a++)n.push(new v(o(a/s,e.x,t.x,i.x),o(a/s,e.y,t.y,i.y),o(a/s,e.z,t.z,i.z)));return new Ka(n)}static CreateCubicBezier(e,t,i,s,n){n=n>3?n:4;const o=new Array,a=(l,c,h,u,d)=>(1-l)*(1-l)*(1-l)*c+3*l*(1-l)*(1-l)*h+3*l*l*(1-l)*u+l*l*l*d;for(let l=0;l<=n;l++)o.push(new v(a(l/n,e.x,t.x,i.x,s.x),a(l/n,e.y,t.y,i.y,s.y),a(l/n,e.z,t.z,i.z,s.z)));return new Ka(o)}static CreateHermiteSpline(e,t,i,s,n){const o=new Array,a=1/n;for(let l=0;l<=n;l++)o.push(v.Hermite(e,t,i,s,l*a));return new Ka(o)}static CreateCatmullRomSpline(e,t,i){const s=new Array,n=1/t;let o=0;if(i){const a=e.length;for(let l=0;l<a;l++){o=0;for(let c=0;c<t;c++)s.push(v.CatmullRom(e[l%a],e[(l+1)%a],e[(l+2)%a],e[(l+3)%a],o)),o+=n}s.push(s[0])}else{const a=new Array;a.push(e[0].clone()),Array.prototype.push.apply(a,e),a.push(e[e.length-1].clone());let l=0;for(;l<a.length-3;l++){o=0;for(let c=0;c<t;c++)s.push(v.CatmullRom(a[l],a[l+1],a[l+2],a[l+3],o)),o+=n}l--,s.push(v.CatmullRom(a[l],a[l+1],a[l+2],a[l+3],o))}return new Ka(s)}static ArcThru3Points(e,t,i,s=32,n=!1,o=!1){const a=new Array,l=t.subtract(e),c=i.subtract(t),h=e.subtract(i),u=v.Cross(l,c),d=u.length();if(d<Math.pow(10,-8))return new Ka(a);const f=l.lengthSquared(),p=c.lengthSquared(),_=h.lengthSquared(),m=u.lengthSquared(),T=.5*l.length()*c.length()*h.length()/d,x=v.Dot(l,h),P=-.5*_*v.Dot(l,c)/m,M=-.5*f*v.Dot(c,h)/m,w=e.scale(-.5*p*x/m).add(t.scale(P)).add(i.scale(M)),X=e.subtract(w).normalize(),te=v.Cross(u,X).normalize();if(o){const J=2*Math.PI/s;for(let Q=0;Q<=2*Math.PI;Q+=J)a.push(w.add(X.scale(T*Math.cos(Q)).add(te.scale(T*Math.sin(Q)))));a.push(e)}else{const J=1/s;let Q=0,me=v.Zero();do{me=w.add(X.scale(T*Math.cos(Q)).add(te.scale(T*Math.sin(Q)))),a.push(me),Q+=J}while(!me.equalsWithEpsilon(i,T*J*1.1));a.push(i),n&&a.push(e)}return new Ka(a)}constructor(e){this._length=0,this._points=e,this._length=this._computeLength(e)}getPoints(){return this._points}length(){return this._length}continue(e){const t=this._points[this._points.length-1],i=this._points.slice(),s=e.getPoints();for(let o=1;o<s.length;o++)i.push(s[o].subtract(s[0]).add(t));return new Ka(i)}_computeLength(e){let t=0;for(let i=1;i<e.length;i++)t+=e[i].subtract(e[i-1]).length();return t}}let Bo=(()=>{class r{constructor(){this._easingMode=r.EASINGMODE_EASEIN}setEasingMode(t){const i=Math.min(Math.max(t,0),2);this._easingMode=i}getEasingMode(){return this._easingMode}easeInCore(t){throw new Error("You must implement this method")}ease(t){switch(this._easingMode){case r.EASINGMODE_EASEIN:return this.easeInCore(t);case r.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-t)}return t>=.5?.5*(1-this.easeInCore(2*(1-t)))+.5:.5*this.easeInCore(2*t)}}return r.EASINGMODE_EASEIN=0,r.EASINGMODE_EASEOUT=1,r.EASINGMODE_EASEINOUT=2,r})();class qie extends Bo{easeInCore(e){return e=Math.max(0,Math.min(1,e)),1-Math.sqrt(1-e*e)}}class Qie extends Bo{easeInCore(e){return e*e}}class v1 extends Bo{easeInCore(e){return 1-Math.sin(1.5707963267948966*(1-e))}}class bE{constructor(e,t,i){this.frame=e,this.action=t,this.onlyOnce=i,this.isDone=!1}_clone(){return new bE(this.frame,this.action,this.onlyOnce)}}class Zie{getClassName(){return"TargetedAnimation"}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class _p{get from(){return this._from}get to(){return this._to}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let t=0;t<this._animatables.length;t++)this._animatables[t].speedRatio=this._speedRatio}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let t=0;t<this._animatables.length;t++)this._animatables[t].loopAnimation=this._loopAnimation}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let t=0;t<this._animatables.length;t++)this._animatables[t].isAdditive=this._isAdditive}}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}constructor(e,t=null){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._parentContainer=null,this.onAnimationEndObservable=new z,this.onAnimationLoopObservable=new z,this.onAnimationGroupLoopObservable=new z,this.onAnimationGroupEndObservable=new z,this.onAnimationGroupPauseObservable=new z,this.onAnimationGroupPlayObservable=new z,this.metadata=null,this._animationLoopFlags=[],this._scene=t||be.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){const i=new Zie;i.animation=e,i.target=t;const s=e.getKeys();return this._from>s[0].frame&&(this._from=s[0].frame),this._to<s[s.length-1].frame&&(this._to=s[s.length-1].frame),this._targetedAnimations.push(i),i}normalize(e=null,t=null){null==e&&(e=this._from),null==t&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){const n=this._targetedAnimations[i].animation.getKeys(),o=n[0],a=n[n.length-1];o.frame>e&&n.splice(0,0,{frame:e,value:o.value,inTangent:o.inTangent,outTangent:o.outTangent,interpolation:o.interpolation}),a.frame<t&&n.push({frame:t,value:a.value,inTangent:a.inTangent,outTangent:a.outTangent,interpolation:a.interpolation})}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),!this._animationLoopFlags[i]&&(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._targetedAnimations.length&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,s,n){if(this._isStarted||0===this._targetedAnimations.length)return this;this._loopAnimation=e,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let o=0;o<this._targetedAnimations.length;o++){const a=this._targetedAnimations[o],l=this._scene.beginDirectAnimation(a.target,[a.animation],void 0!==i?i:this._from,void 0!==s?s:this._to,e,t,void 0,void 0,void 0!==n?n:this._isAdditive);l.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(a),this._checkAnimationGroupEnded(l)},this._processLoop(l,a,o),this._animatables.push(l)}return this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length===this._targetedAnimations.length?(void 0!==e&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this._isPaused=!1,this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(){if(!this._isStarted)return this;const e=this._animatables.slice();for(let t=0;t<e.length;t++)e[t].stop(void 0,void 0,!0);return this._scene._activeAnimatables=this._scene._activeAnimatables.filter(t=>t._runtimeAnimations.length>0),this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].weight=e;return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e){if(!this._isStarted)return this;for(let t=0;t<this._animatables.length;t++)this._animatables[t].goToFrame(e);return this}dispose(){this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const t=this._parentContainer.animationGroups.indexOf(this);t>-1&&this._parentContainer.animationGroups.splice(t,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e){const t=this._animatables.indexOf(e);t>-1&&this._animatables.splice(t,1),0===this._animatables.length&&(this._isStarted=!1,this.onAnimationGroupEndObservable.notifyObservers(this))}clone(e,t,i=!1){const s=new _p(e||this.name,this._scene);for(const n of this._targetedAnimations)s.addTargetedAnimation(i?n.animation.clone():n.animation,t?t(n.target):n.target);return s}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++)e.targetedAnimations[t]=this.targetedAnimations[t].serialize();return Et&&Et.HasTags(this)&&(e.tags=Et.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){const i=new _p(e.name,t);for(let s=0;s<e.targetedAnimations.length;s++){const n=e.targetedAnimations[s],o=$.Parse(n.animation),a=n.targetId;if("influence"===n.animation.property){const l=t.getMorphTargetById(a);l&&i.addTargetedAnimation(o,l)}else{const l=t.getNodeById(a);null!=l&&i.addTargetedAnimation(o,l)}}return null!==e.from&&null!==e.to&&i.normalize(e.from,e.to),Et&&Et.AddTagsTo(i,e.tags),void 0!==e.metadata&&(i.metadata=e.metadata),i}static MakeAnimationAdditive(e,t=0,i,s=!1,n){let o=e;s&&(o=e.clone(n||o.name));const a=o.targetedAnimations;for(let l=0;l<a.length;l++)$.MakeAnimationAdditive(a[l].animation,t,i);return o.isAdditive=!0,o}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}}function ev(r,e,t){try{const i=r.next();i.done?e(i):i.value?i.value.then(()=>{i.value=void 0,e(i)},t):e(i)}catch(i){t(i)}}function b1(r,e,t,i,s){const n=()=>{let o;const a=l=>{l.done?t(l.value):void 0===o?o=!0:n()};do{o=void 0,s&&s.aborted?i(new Error("Aborted")):e(r,a,i),void 0===o&&(o=!1)}while(o)};n()}function yE(r,e){let t;return b1(r,ev,i=>t=i,i=>{throw i},e),t}function xE(r,e,t){return new Promise((i,s)=>{b1(r,e,i,s,t)})}class qr{constructor(e,t,i,s){this.x=e,this.y=t,this.width=i,this.height=s}toGlobal(e,t){return new qr(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new qr(this.x,this.y,this.width,this.height)}}class ve extends Rt{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){var e,t,i,s;let n=0,o=0;if(this.mode===ve.PERSPECTIVE_CAMERA)this.fovMode===ve.FOVMODE_VERTICAL_FIXED?(o=2*this.minZ*Math.tan(this.fov/2),n=this.getEngine().getAspectRatio(this)*o):(n=2*this.minZ*Math.tan(this.fov/2),o=n/this.getEngine().getAspectRatio(this));else{const a=this.getEngine().getRenderWidth()/2,l=this.getEngine().getRenderHeight()/2;n=(null!==(e=this.orthoRight)&&void 0!==e?e:a)-(null!==(t=this.orthoLeft)&&void 0!==t?t:-a),o=(null!==(i=this.orthoTop)&&void 0!==i?i:l)-(null!==(s=this.orthoBottom)&&void 0!==s?s:-l)}return n*o}set orthoLeft(e){this._orthoLeft=e;for(const t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(const t of this._rigCameras)t.mode=e}get mode(){return this._mode}constructor(e,t,i,s=!0){super(e,i),this._position=v.Zero(),this._upVector=v.Up(),this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=ve.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new qr(0,0,1,1),this.layerMask=268435455,this.fovMode=ve.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=ve.RIG_MODE_NONE,this.customRenderTargets=new Array,this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new z,this.onProjectionMatrixChangedObservable=new z,this.onAfterCheckInputsObservable=new z,this.onRestoreStateObservable=new z,this.isRigCamera=!1,this._rigCameras=new Array,this._webvrViewMatrix=F.Identity(),this._skipRendering=!1,this._projectionMatrix=new F,this._postProcesses=new Array,this._activeMeshes=new ws(256),this._globalPosition=v.Zero(),this._computedViewMatrix=F.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=F.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=Z.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),s&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}_restoreStateValues(){return!!this._stateStored&&(this.fov=this._storedFov,!0)}restoreState(){return!!this._restoreStateValues()&&(this.onRestoreStateObservable.notifyObservers(this),!0)}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return-1!==this._activeMeshes.indexOf(e)}isReady(e=!1){if(e)for(const t of this._postProcesses)if(t&&!t.isReady())return!1;return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return!!super._isSynchronized()&&this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent()}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;const t=this.getEngine();return e=this.mode===ve.PERSPECTIVE_CAMERA?this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),e}attachControl(e,t){}detachControl(e){}update(){this._checkInputs(),this.cameraRigMode!==ve.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(null!==this._postProcesses[e])return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let t=0,i=this._rigCameras.length;t<i;t++){const s=this._rigCameras[t],n=s._rigPostProcess;n?("pass"===n.getEffectName()&&(s.isIntermediate=0===this._postProcesses.length),s._postProcesses=this._postProcesses.slice(0).concat(n),n.markTextureDirty()):s._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(V.Error("You're trying to reuse a post process not defined as reusable."),0):(null==t||t<0?this._postProcesses.push(e):null===this._postProcesses[t]?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()||this.getViewMatrix(),this._worldMatrix}_getViewMatrix(){return F.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()||(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix)),this._computedViewMatrix}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,void 0!==e&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){var t,i,s,n,o,a,l,c;if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;const h=this.getEngine(),u=this.getScene(),d=h.useReverseDepthBuffer;if(this.mode===ve.PERSPECTIVE_CAMERA){let f;this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=h.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1),f=u.useRightHandedSystem?F.PerspectiveFovRHToRef:F.PerspectiveFovLHToRef,f(this.fov,h.getAspectRatio(this),d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===ve.FOVMODE_VERTICAL_FIXED,h.isNDCHalfZRange,this.projectionPlaneTilt,d)}else{const f=h.getRenderWidth()/2,p=h.getRenderHeight()/2;u.useRightHandedSystem?F.OrthoOffCenterRHToRef(null!==(t=this.orthoLeft)&&void 0!==t?t:-f,null!==(i=this.orthoRight)&&void 0!==i?i:f,null!==(s=this.orthoBottom)&&void 0!==s?s:-p,null!==(n=this.orthoTop)&&void 0!==n?n:p,d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,h.isNDCHalfZRange):F.OrthoOffCenterLHToRef(null!==(o=this.orthoLeft)&&void 0!==o?o:-f,null!==(a=this.orthoRight)&&void 0!==a?a:f,null!==(l=this.orthoBottom)&&void 0!==l?l:-p,null!==(c=this.orthoTop)&&void 0!==c?c:p,d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,h.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=h.getRenderWidth(),this._cache.renderHeight=h.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_updateFrustumPlanes(){!this._refreshFrustumPlanes||(this.getTransformationMatrix(),this._frustumPlanes?Gn.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Gn.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let i=!1;return this.rigCameras.forEach(s=>{s._updateFrustumPlanes(),i=i||e.isInFrustum(s._frustumPlanes)}),i}return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw Ge("Ray")}getForwardRayToRef(e,t=100,i,s){throw Ge("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const s=this._rigCameras.pop();s&&s.dispose()}if(this._parentContainer){const s=this._parentContainer.cameras.indexOf(this);s>-1&&this._parentContainer.cameras.splice(s,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==ve.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let s=this._postProcesses.length;for(;--s>=0;){const n=this._postProcesses[s];n&&n.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const i=this._rigCameras.pop();i&&i.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=q.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==ve.RIG_MODE_NONE){const i=this.createRigCamera(this.name+"_L",0);i&&(i._isLeftCamera=!0);const s=this.createRigCamera(this.name+"_R",1);s&&(s._isRightCamera=!0),i&&s&&(this._rigCameras.push(i),this._rigCameras.push(s))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return F.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}_updateCameraRotationMatrix(){}_updateWebVRCameraRotationMatrix(){}_getWebVRProjectionMatrix(){return F.Identity()}_getWebVRViewMatrix(){return F.Identity()}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,"interaxialDistance"===e&&(this._cameraRigParams.stereoHalfAngle=q.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){const e=Ce.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),Ce.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){const i=Ce.Clone(ve.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){const t=v.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){v.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,s=0,n=!0){return Rt.Construct(e,t,i,{interaxial_distance:s,isStereoscopicSideBySide:n})||(()=>ve._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){const s=ve.GetConstructorFromName(e.type,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),n=Ce.Parse(s,e,t);if(void 0!==e.parentId&&(n._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(n._waitingParentInstanceIndex=e.parentInstanceIndex),n.inputs&&(n.inputs.parse(e),n._setupInputs()),e.upVector&&(n.upVector=v.FromArray(e.upVector)),n.setPosition&&(n.position.copyFromFloats(0,0,0),n.setPosition(v.FromArray(e.position))),e.target&&n.setTarget&&n.setTarget(v.FromArray(e.target)),e.cameraRigMode&&n.setCameraRigMode(e.cameraRigMode,e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{}),e.animations){for(let o=0;o<e.animations.length;o++){const a=e.animations[o],l=hs("BABYLON.Animation");l&&n.animations.push(l.Parse(a))}Rt.ParseAnimationRanges(n,e,t)}return e.autoAnimate&&t.beginAnimation(n,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&n.setEnabled(e.isEnabled),n}}ve._CreateDefaultParsedCamera=(r,e)=>{throw Ge("UniversalCamera")},ve.PERSPECTIVE_CAMERA=0,ve.ORTHOGRAPHIC_CAMERA=1,ve.FOVMODE_VERTICAL_FIXED=0,ve.FOVMODE_HORIZONTAL_FIXED=1,ve.RIG_MODE_NONE=0,ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,ve.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,ve.RIG_MODE_STEREOSCOPIC_INTERLACED=14,ve.RIG_MODE_VR=20,ve.RIG_MODE_WEBVR=21,ve.RIG_MODE_CUSTOM=22,ve.ForceAttachControlToAlwaysPreventDefault=!1,E([Ws("position")],ve.prototype,"_position",void 0),E([Ws("upVector")],ve.prototype,"_upVector",void 0),E([I()],ve.prototype,"orthoLeft",null),E([I()],ve.prototype,"orthoRight",null),E([I()],ve.prototype,"orthoBottom",null),E([I()],ve.prototype,"orthoTop",null),E([I()],ve.prototype,"fov",void 0),E([I()],ve.prototype,"projectionPlaneTilt",void 0),E([I()],ve.prototype,"minZ",void 0),E([I()],ve.prototype,"maxZ",void 0),E([I()],ve.prototype,"inertia",void 0),E([I()],ve.prototype,"mode",null),E([I()],ve.prototype,"layerMask",void 0),E([I()],ve.prototype,"fovMode",void 0),E([I()],ve.prototype,"cameraRigMode",void 0),E([I()],ve.prototype,"interaxialDistance",void 0),E([I()],ve.prototype,"isStereoscopicSideBySide",void 0);class ue{constructor(){this._applyTo=function ese(r,e){return(...t)=>yE(r(...t),e)}(this._applyToCoroutine.bind(this))}set(e,t){switch(e.length||V.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case A.PositionKind:this.positions=e;break;case A.NormalKind:this.normals=e;break;case A.TangentKind:this.tangents=e;break;case A.UVKind:this.uvs=e;break;case A.UV2Kind:this.uvs2=e;break;case A.UV3Kind:this.uvs3=e;break;case A.UV4Kind:this.uvs4=e;break;case A.UV5Kind:this.uvs5=e;break;case A.UV6Kind:this.uvs6=e;break;case A.ColorKind:this.colors=e;break;case A.MatricesIndicesKind:this.matricesIndices=e;break;case A.MatricesWeightsKind:this.matricesWeights=e;break;case A.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case A.MatricesWeightsExtraKind:this.matricesWeightsExtra=e}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,i){return this.positions&&(e.setVerticesData(A.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(A.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(A.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(A.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(A.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(A.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(A.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(A.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(A.UV6Kind,this.uvs6,t),i&&(yield)),this.colors&&(e.setVerticesData(A.ColorKind,this.colors,t),i&&(yield)),this.matricesIndices&&(e.setVerticesData(A.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(A.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(A.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(A.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),this}_update(e,t,i){return this.positions&&e.updateVerticesData(A.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(A.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(A.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(A.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(A.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(A.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(A.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(A.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(A.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(A.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(A.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(A.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(A.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(A.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,s=e.length){const n=L.Vector3[0],o=L.Vector3[1];for(let a=i;a<i+s;a+=3)v.FromArrayToRef(e,a,n),v.TransformCoordinatesToRef(n,t,o),e[a]=o.x,e[a+1]=o.y,e[a+2]=o.z}static _TransformVector3Normals(e,t,i=0,s=e.length){const n=L.Vector3[0],o=L.Vector3[1];for(let a=i;a<i+s;a+=3)v.FromArrayToRef(e,a,n),v.TransformNormalToRef(n,t,o),e[a]=o.x,e[a+1]=o.y,e[a+2]=o.z}static _TransformVector4Normals(e,t,i=0,s=e.length){const n=L.Vector4[0],o=L.Vector4[1];for(let a=i;a<i+s;a+=4)vt.FromArrayToRef(e,a,n),vt.TransformNormalToRef(n,t,o),e[a]=o.x,e[a+1]=o.y,e[a+2]=o.z,e[a+3]=o.w}static _FlipFaces(e,t=0,i=e.length){for(let s=t;s<t+i;s+=3){const n=e[s+1];e[s+1]=e[s+2],e[s+2]=n}}transform(e){const t=e.determinant()<0;return this.positions&&ue._TransformVector3Coordinates(this.positions,e),this.normals&&ue._TransformVector3Normals(this.normals,e),this.tangents&&ue._TransformVector4Normals(this.tangents,e),t&&this.indices&&ue._FlipFaces(this.indices),this}merge(e,t=!1,i=!1){const s=Array.isArray(e)?e.map(n=>({vertexData:n})):[{vertexData:e}];return yE(this._mergeCoroutine(void 0,s,t,!1,i))}*_mergeCoroutine(e,t,i=!1,s,n){var o,a,l,c;this._validate();const h=t.map(p=>p.vertexData);for(const p of h)if(p._validate(),!this.normals!=!p.normals||!this.tangents!=!p.tangents||!this.uvs!=!p.uvs||!this.uvs2!=!p.uvs2||!this.uvs3!=!p.uvs3||!this.uvs4!=!p.uvs4||!this.uvs5!=!p.uvs5||!this.uvs6!=!p.uvs6||!this.colors!=!p.colors||!this.matricesIndices!=!p.matricesIndices||!this.matricesWeights!=!p.matricesWeights||!this.matricesIndicesExtra!=!p.matricesIndicesExtra||!this.matricesWeightsExtra!=!p.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");const u=h.reduce((p,_)=>{var m,g;return p+(null!==(g=null===(m=_.indices)||void 0===m?void 0:m.length)&&void 0!==g?g:0)},null!==(a=null===(o=this.indices)||void 0===o?void 0:o.length)&&void 0!==a?a:0);let f=n||h.some(p=>p.indices===this.indices)?null===(l=this.indices)||void 0===l?void 0:l.slice():this.indices;if(u>0){let p=null!==(c=f?.length)&&void 0!==c?c:0;if(f||(f=new Array(u)),f.length!==u){if(Array.isArray(f))f.length=u;else{const m=i||f instanceof Uint32Array?new Uint32Array(u):new Uint16Array(u);m.set(f),f=m}e&&e.determinant()<0&&ue._FlipFaces(f,0,p)}let _=this.positions?this.positions.length/3:0;for(const{vertexData:m,transform:g}of t)if(m.indices){for(let b=0;b<m.indices.length;b++)f[p+b]=m.indices[b]+_;g&&g.determinant()<0&&ue._FlipFaces(f,p,m.indices.length),_+=m.positions.length/3,p+=m.indices.length,s&&(yield)}}return this.indices=f,this.positions=ue._MergeElement(A.PositionKind,this.positions,e,t.map(p=>[p.vertexData.positions,p.transform])),s&&(yield),this.normals=ue._MergeElement(A.NormalKind,this.normals,e,t.map(p=>[p.vertexData.normals,p.transform])),s&&(yield),this.tangents=ue._MergeElement(A.TangentKind,this.tangents,e,t.map(p=>[p.vertexData.tangents,p.transform])),s&&(yield),this.uvs=ue._MergeElement(A.UVKind,this.uvs,e,t.map(p=>[p.vertexData.uvs,p.transform])),s&&(yield),this.uvs2=ue._MergeElement(A.UV2Kind,this.uvs2,e,t.map(p=>[p.vertexData.uvs2,p.transform])),s&&(yield),this.uvs3=ue._MergeElement(A.UV3Kind,this.uvs3,e,t.map(p=>[p.vertexData.uvs3,p.transform])),s&&(yield),this.uvs4=ue._MergeElement(A.UV4Kind,this.uvs4,e,t.map(p=>[p.vertexData.uvs4,p.transform])),s&&(yield),this.uvs5=ue._MergeElement(A.UV5Kind,this.uvs5,e,t.map(p=>[p.vertexData.uvs5,p.transform])),s&&(yield),this.uvs6=ue._MergeElement(A.UV6Kind,this.uvs6,e,t.map(p=>[p.vertexData.uvs6,p.transform])),s&&(yield),this.colors=ue._MergeElement(A.ColorKind,this.colors,e,t.map(p=>[p.vertexData.colors,p.transform])),s&&(yield),this.matricesIndices=ue._MergeElement(A.MatricesIndicesKind,this.matricesIndices,e,t.map(p=>[p.vertexData.matricesIndices,p.transform])),s&&(yield),this.matricesWeights=ue._MergeElement(A.MatricesWeightsKind,this.matricesWeights,e,t.map(p=>[p.vertexData.matricesWeights,p.transform])),s&&(yield),this.matricesIndicesExtra=ue._MergeElement(A.MatricesIndicesExtraKind,this.matricesIndicesExtra,e,t.map(p=>[p.vertexData.matricesIndicesExtra,p.transform])),s&&(yield),this.matricesWeightsExtra=ue._MergeElement(A.MatricesWeightsExtraKind,this.matricesWeightsExtra,e,t.map(p=>[p.vertexData.matricesWeightsExtra,p.transform])),this}static _MergeElement(e,t,i,s){const n=s.filter(l=>null!=l[0]);if(!t&&0==n.length)return t;if(!t)return this._MergeElement(e,n[0][0],n[0][1],n.slice(1));const o=n.reduce((l,c)=>l+c[0].length,t.length),a=e===A.PositionKind?ue._TransformVector3Coordinates:e===A.NormalKind?ue._TransformVector3Normals:e===A.TangentKind?ue._TransformVector4Normals:()=>{};if(t instanceof Float32Array){const l=new Float32Array(o);l.set(t),i&&a(l,i,0,t.length);let c=t.length;for(const[h,u]of n)l.set(h,c),u&&a(l,u,c,h.length),c+=h.length;return l}{const l=new Array(o);for(let h=0;h<t.length;h++)l[h]=t[h];i&&a(l,i,0,t.length);let c=t.length;for(const[h,u]of n){for(let d=0;d<h.length;d++)l[c+d]=h[d];u&&a(l,u,c,h.length),c+=h.length}return l}}_validate(){if(!this.positions)throw new No("Positions are required",0);const e=(s,n)=>{const o=A.DeduceStride(s);if(n.length%o!=0)throw new Error("The "+s+"s array count must be a multiple of "+o);return n.length/o},t=e(A.PositionKind,this.positions),i=(s,n)=>{const o=e(s,n);if(o!==t)throw new Error("The "+s+"s element count ("+o+") does not match the positions count ("+t+")")};this.normals&&i(A.NormalKind,this.normals),this.tangents&&i(A.TangentKind,this.tangents),this.uvs&&i(A.UVKind,this.uvs),this.uvs2&&i(A.UV2Kind,this.uvs2),this.uvs3&&i(A.UV3Kind,this.uvs3),this.uvs4&&i(A.UV4Kind,this.uvs4),this.uvs5&&i(A.UV5Kind,this.uvs5),this.uvs6&&i(A.UV6Kind,this.uvs6),this.colors&&i(A.ColorKind,this.colors),this.matricesIndices&&i(A.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(A.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(A.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(A.MatricesWeightsExtraKind,this.matricesWeightsExtra)}serialize(){const e={};return this.positions&&(e.positions=this.positions),this.normals&&(e.normals=this.normals),this.tangents&&(e.tangents=this.tangents),this.uvs&&(e.uvs=this.uvs),this.uvs2&&(e.uvs2=this.uvs2),this.uvs3&&(e.uvs3=this.uvs3),this.uvs4&&(e.uvs4=this.uvs4),this.uvs5&&(e.uvs5=this.uvs5),this.uvs6&&(e.uvs6=this.uvs6),this.colors&&(e.colors=this.colors),this.matricesIndices&&(e.matricesIndices=this.matricesIndices,e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(e.matricesIndicesExtra=this.matricesIndicesExtra,e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=this.matricesWeightsExtra),e.indices=this.indices,e}static ExtractFromMesh(e,t,i){return ue._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return ue._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){const s=new ue;return e.isVerticesDataPresent(A.PositionKind)&&(s.positions=e.getVerticesData(A.PositionKind,t,i)),e.isVerticesDataPresent(A.NormalKind)&&(s.normals=e.getVerticesData(A.NormalKind,t,i)),e.isVerticesDataPresent(A.TangentKind)&&(s.tangents=e.getVerticesData(A.TangentKind,t,i)),e.isVerticesDataPresent(A.UVKind)&&(s.uvs=e.getVerticesData(A.UVKind,t,i)),e.isVerticesDataPresent(A.UV2Kind)&&(s.uvs2=e.getVerticesData(A.UV2Kind,t,i)),e.isVerticesDataPresent(A.UV3Kind)&&(s.uvs3=e.getVerticesData(A.UV3Kind,t,i)),e.isVerticesDataPresent(A.UV4Kind)&&(s.uvs4=e.getVerticesData(A.UV4Kind,t,i)),e.isVerticesDataPresent(A.UV5Kind)&&(s.uvs5=e.getVerticesData(A.UV5Kind,t,i)),e.isVerticesDataPresent(A.UV6Kind)&&(s.uvs6=e.getVerticesData(A.UV6Kind,t,i)),e.isVerticesDataPresent(A.ColorKind)&&(s.colors=e.getVerticesData(A.ColorKind,t,i)),e.isVerticesDataPresent(A.MatricesIndicesKind)&&(s.matricesIndices=e.getVerticesData(A.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(A.MatricesWeightsKind)&&(s.matricesWeights=e.getVerticesData(A.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(A.MatricesIndicesExtraKind)&&(s.matricesIndicesExtra=e.getVerticesData(A.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(A.MatricesWeightsExtraKind)&&(s.matricesWeightsExtra=e.getVerticesData(A.MatricesWeightsExtraKind,t,i)),s.indices=e.getIndices(t,i),s}static CreateRibbon(e){throw Ge("ribbonBuilder")}static CreateBox(e){throw Ge("boxBuilder")}static CreateTiledBox(e){throw Ge("tiledBoxBuilder")}static CreateTiledPlane(e){throw Ge("tiledPlaneBuilder")}static CreateSphere(e){throw Ge("sphereBuilder")}static CreateCylinder(e){throw Ge("cylinderBuilder")}static CreateTorus(e){throw Ge("torusBuilder")}static CreateLineSystem(e){throw Ge("linesBuilder")}static CreateDashedLines(e){throw Ge("linesBuilder")}static CreateGround(e){throw Ge("groundBuilder")}static CreateTiledGround(e){throw Ge("groundBuilder")}static CreateGroundFromHeightMap(e){throw Ge("groundBuilder")}static CreatePlane(e){throw Ge("planeBuilder")}static CreateDisc(e){throw Ge("discBuilder")}static CreatePolygon(e,t,i,s,n,o,a){throw Ge("polygonBuilder")}static CreateIcoSphere(e){throw Ge("icoSphereBuilder")}static CreatePolyhedron(e){throw Ge("polyhedronBuilder")}static CreateCapsule(e={orientation:v.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw Ge("capsuleBuilder")}static CreateTorusKnot(e){throw Ge("torusKnotBuilder")}static ComputeNormals(e,t,i,s){let n=0,o=0,a=0,l=0,c=0,h=0,u=0,d=0,f=0,p=0,_=0,m=0,g=0,b=0,y=0,T=0,x=0,S=0,C=0,D=0,P=!1,M=!1,w=!1,k=!1,X=1,te=0,J=null;s&&(P=!!s.facetNormals,M=!!s.facetPositions,w=!!s.facetPartitioning,X=!0===s.useRightHandedSystem?-1:1,te=s.ratio||0,k=!!s.depthSort,J=s.distanceTo,k&&void 0===J&&(J=v.Zero()));let Q=0,me=0,ae=0,W=0;for(w&&s&&s.bbSize&&(Q=s.subDiv.X*te/s.bbSize.x,me=s.subDiv.Y*te/s.bbSize.y,ae=s.subDiv.Z*te/s.bbSize.z,W=s.subDiv.max*s.subDiv.max,s.facetPartitioning.length=0),n=0;n<e.length;n++)i[n]=0;const K=t.length/3|0;for(n=0;n<K;n++){if(m=3*t[3*n],g=m+1,b=m+2,y=3*t[3*n+1],T=y+1,x=y+2,S=3*t[3*n+2],C=S+1,D=S+2,o=e[m]-e[y],a=e[g]-e[T],l=e[b]-e[x],c=e[S]-e[y],h=e[C]-e[T],u=e[D]-e[x],d=X*(a*u-l*h),f=X*(l*c-o*u),p=X*(o*h-a*c),_=Math.sqrt(d*d+f*f+p*p),_=0===_?1:_,d/=_,f/=_,p/=_,P&&s&&(s.facetNormals[n].x=d,s.facetNormals[n].y=f,s.facetNormals[n].z=p),M&&s&&(s.facetPositions[n].x=(e[m]+e[y]+e[S])/3,s.facetPositions[n].y=(e[g]+e[T]+e[C])/3,s.facetPositions[n].z=(e[b]+e[x]+e[D])/3),w&&s){const O=Math.floor((s.facetPositions[n].x-s.bInfo.minimum.x*te)*Q),H=Math.floor((s.facetPositions[n].y-s.bInfo.minimum.y*te)*me),Y=Math.floor((s.facetPositions[n].z-s.bInfo.minimum.z*te)*ae),he=Math.floor((e[m]-s.bInfo.minimum.x*te)*Q),Le=Math.floor((e[g]-s.bInfo.minimum.y*te)*me),Fe=Math.floor((e[b]-s.bInfo.minimum.z*te)*ae),se=Math.floor((e[y]-s.bInfo.minimum.x*te)*Q),_e=Math.floor((e[T]-s.bInfo.minimum.y*te)*me),rt=Math.floor((e[x]-s.bInfo.minimum.z*te)*ae),Ze=Math.floor((e[S]-s.bInfo.minimum.x*te)*Q),Ae=Math.floor((e[C]-s.bInfo.minimum.y*te)*me),Ie=Math.floor((e[D]-s.bInfo.minimum.z*te)*ae),ct=he+s.subDiv.max*Le+W*Fe,Ct=se+s.subDiv.max*_e+W*rt,Mt=Ze+s.subDiv.max*Ae+W*Ie,Ke=O+s.subDiv.max*H+W*Y;s.facetPartitioning[Ke]=s.facetPartitioning[Ke]?s.facetPartitioning[Ke]:new Array,s.facetPartitioning[ct]=s.facetPartitioning[ct]?s.facetPartitioning[ct]:new Array,s.facetPartitioning[Ct]=s.facetPartitioning[Ct]?s.facetPartitioning[Ct]:new Array,s.facetPartitioning[Mt]=s.facetPartitioning[Mt]?s.facetPartitioning[Mt]:new Array,s.facetPartitioning[ct].push(n),Ct!=ct&&s.facetPartitioning[Ct].push(n),Mt==Ct||Mt==ct||s.facetPartitioning[Mt].push(n),Ke==ct||Ke==Ct||Ke==Mt||s.facetPartitioning[Ke].push(n)}if(k&&s&&s.facetPositions){const O=s.depthSortedFacets[n];O.ind=3*n,O.sqDistance=v.DistanceSquared(s.facetPositions[n],J)}i[m]+=d,i[g]+=f,i[b]+=p,i[y]+=d,i[T]+=f,i[x]+=p,i[S]+=d,i[C]+=f,i[D]+=p}for(n=0;n<i.length/3;n++)d=i[3*n],f=i[3*n+1],p=i[3*n+2],_=Math.sqrt(d*d+f*f+p*p),_=0===_?1:_,d/=_,f/=_,p/=_,i[3*n]=d,i[3*n+1]=f,i[3*n+2]=p}static _ComputeSides(e,t,i,s,n,o,a){const l=i.length,c=s.length;let h,u;switch(e=e||ue.DEFAULTSIDE){case ue.FRONTSIDE:break;case ue.BACKSIDE:for(h=0;h<l;h+=3){const d=i[h];i[h]=i[h+2],i[h+2]=d}for(u=0;u<c;u++)s[u]=-s[u];break;case ue.DOUBLESIDE:{const d=t.length,f=d/3;for(let m=0;m<d;m++)t[d+m]=t[m];for(h=0;h<l;h+=3)i[h+l]=i[h+2]+f,i[h+1+l]=i[h+1]+f,i[h+2+l]=i[h]+f;for(u=0;u<c;u++)s[c+u]=-s[u];const p=n.length;let _=0;for(_=0;_<p;_++)n[_+p]=n[_];for(o=o||new vt(0,0,1,1),a=a||new vt(0,0,1,1),_=0,h=0;h<p/2;h++)n[_]=o.x+(o.z-o.x)*n[_],n[_+1]=o.y+(o.w-o.y)*n[_+1],n[_+p]=a.x+(a.z-a.x)*n[_+p],n[_+p+1]=a.y+(a.w-a.y)*n[_+p+1],_+=2;break}}}static ImportVertexData(e,t){const i=new ue,s=e.positions;s&&i.set(s,A.PositionKind);const n=e.normals;n&&i.set(n,A.NormalKind);const o=e.tangents;o&&i.set(o,A.TangentKind);const a=e.uvs;a&&i.set(a,A.UVKind);const l=e.uv2s;l&&i.set(l,A.UV2Kind);const c=e.uv3s;c&&i.set(c,A.UV3Kind);const h=e.uv4s;h&&i.set(h,A.UV4Kind);const u=e.uv5s;u&&i.set(u,A.UV5Kind);const d=e.uv6s;d&&i.set(d,A.UV6Kind);const f=e.colors;f&&i.set(Te.CheckColors4(f,s.length/3),A.ColorKind);const p=e.matricesIndices;p&&i.set(p,A.MatricesIndicesKind);const _=e.matricesWeights;_&&i.set(_,A.MatricesWeightsKind);const m=e.indices;m&&(i.indices=m),t.setAllVerticesData(i,e.updatable)}}ue.FRONTSIDE=0,ue.BACKSIDE=1,ue.DOUBLESIDE=2,ue.DEFAULTSIDE=0,E([Yl.filter((...[r])=>!Array.isArray(r))],ue,"_TransformVector3Coordinates",null),E([Yl.filter((...[r])=>!Array.isArray(r))],ue,"_TransformVector3Normals",null),E([Yl.filter((...[r])=>!Array.isArray(r))],ue,"_TransformVector4Normals",null),E([Yl.filter((...[r])=>!Array.isArray(r))],ue,"_FlipFaces",null);class TE{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0}}class Vo{constructor(e,t,i){this.vectors=is.BuildArray(8,v.Zero),this.center=v.Zero(),this.centerWorld=v.Zero(),this.extendSize=v.Zero(),this.extendSizeWorld=v.Zero(),this.directions=is.BuildArray(3,v.Zero),this.vectorsWorld=is.BuildArray(8,v.Zero),this.minimumWorld=v.Zero(),this.maximumWorld=v.Zero(),this.minimum=v.Zero(),this.maximum=v.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){const s=e.x,n=e.y,o=e.z,a=t.x,l=t.y,c=t.z,h=this.vectors;this.minimum.copyFromFloats(s,n,o),this.maximum.copyFromFloats(a,l,c),h[0].copyFromFloats(s,n,o),h[1].copyFromFloats(a,l,c),h[2].copyFromFloats(a,n,o),h[3].copyFromFloats(s,l,o),h[4].copyFromFloats(s,n,c),h[5].copyFromFloats(a,l,o),h[6].copyFromFloats(s,l,c),h[7].copyFromFloats(a,n,c),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||F.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){const t=Vo._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),s=i.length();i.normalizeFromLength(s);const o=i.scaleInPlace(s*e*.5),a=this.center.subtractToRef(o,t[1]),l=this.center.addToRef(o,t[2]);return this.reConstruct(a,l,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){const t=this.minimumWorld,i=this.maximumWorld,s=this.directions,n=this.vectorsWorld,o=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let a=0;a<8;++a)n[a].copyFrom(o[a]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let a=0;a<8;++a){const l=n[a];v.TransformCoordinatesToRef(o[a],e,l),t.minimizeInPlace(l),i.maximizeInPlace(l)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}v.FromArrayToRef(e.m,0,s[0]),v.FromArrayToRef(e.m,4,s[1]),v.FromArrayToRef(e.m,8,s[2]),this._worldMatrix=e}isInFrustum(e){return Vo.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return Vo.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){const t=this.minimumWorld,i=this.maximumWorld,h=e.x,u=e.y,d=e.z,f=-ot;return!(i.x-h<f||f>h-t.x||i.y-u<f||f>u-t.y||i.z-d<f||f>d-t.z)}intersectsSphere(e){return Vo.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){const i=this.minimumWorld,s=this.maximumWorld;return!(s.x<e.x||i.x>t.x||s.y<e.y||i.y>t.y||s.z<e.z||i.z>t.z)}dispose(){var e,t;null===(e=this._drawWrapperFront)||void 0===e||e.dispose(),null===(t=this._drawWrapperBack)||void 0===t||t.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,s){const n=Vo._TmpVector3[0];return v.ClampToRef(i,e,t,n),v.DistanceSquared(i,n)<=s*s}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){const s=t[i];for(let n=0;n<8;++n)if(s.dotCoordinate(e[n])<0)return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let s=!0;const n=t[i];for(let o=0;o<8;++o)if(n.dotCoordinate(e[o])>=0){s=!1;break}if(s)return!1}return!0}}Vo._TmpVector3=is.BuildArray(3,v.Zero);class Qa{constructor(e,t,i){this.center=v.Zero(),this.centerWorld=v.Zero(),this.minimum=v.Zero(),this.maximum=v.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);const s=v.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=.5*s,this._update(i||F.IdentityReadOnly)}scale(e){const i=Qa._TmpVector3,s=i[0].setAll(this.radius*e),n=this.center.subtractToRef(s,i[1]),o=this.center.addToRef(s,i[2]);return this.reConstruct(n,o,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{v.TransformCoordinatesToRef(this.center,e,this.centerWorld);const t=Qa._TmpVector3[0];v.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){const t=this.centerWorld,i=this.radiusWorld;for(let s=0;s<6;s++)if(e[s].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){const t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){const t=v.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){const i=v.DistanceSquared(e.centerWorld,t.centerWorld),s=e.radiusWorld+t.radiusWorld;return!(s*s<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);const s=new Qa(this._TmpVector3[0],this._TmpVector3[2]);return s._worldMatrix=i||F.Identity(),s}}Qa._TmpVector3=is.BuildArray(3,v.Zero);const SE={min:0,max:0},EE={min:0,max:0},y1=(r,e,t)=>{const i=v.Dot(e.centerWorld,r),a=Math.abs(v.Dot(e.directions[0],r))*e.extendSize.x+Math.abs(v.Dot(e.directions[1],r))*e.extendSize.y+Math.abs(v.Dot(e.directions[2],r))*e.extendSize.z;t.min=i-a,t.max=i+a},$r=(r,e,t)=>(y1(r,e,SE),y1(r,t,EE),!(SE.min>EE.max||EE.min>SE.max));class pn{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new Vo(e,t,i),this.boundingSphere=new Qa(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){const i=pn._TmpVector3[0].copyFrom(e).subtractInPlace(t),s=pn._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this}encapsulate(e){const t=v.Minimize(this.minimum,e),i=v.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){return this.encapsulate(e.boundingBox.centerWorld.subtract(e.boundingBox.extendSizeWorld)),this.encapsulate(e.boundingBox.centerWorld.add(e.boundingBox.extendSizeWorld)),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return!(2!==t&&3!==t||!this.boundingSphere.isCenterInFrustum(e))||!!this.boundingSphere.isInFrustum(e)&&(1===t||3===t||this.boundingBox.isInFrustum(e))}get diagonalLength(){const e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,pn._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))}intersects(e,t){if(!Qa.Intersects(this.boundingSphere,e.boundingSphere)||!Vo.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;const i=this.boundingBox,s=e.boundingBox;return!!($r(i.directions[0],i,s)&&$r(i.directions[1],i,s)&&$r(i.directions[2],i,s)&&$r(s.directions[0],i,s)&&$r(s.directions[1],i,s)&&$r(s.directions[2],i,s)&&$r(v.Cross(i.directions[0],s.directions[0]),i,s)&&$r(v.Cross(i.directions[0],s.directions[1]),i,s)&&$r(v.Cross(i.directions[0],s.directions[2]),i,s)&&$r(v.Cross(i.directions[1],s.directions[0]),i,s)&&$r(v.Cross(i.directions[1],s.directions[1]),i,s)&&$r(v.Cross(i.directions[1],s.directions[2]),i,s)&&$r(v.Cross(i.directions[2],s.directions[0]),i,s)&&$r(v.Cross(i.directions[2],s.directions[1]),i,s)&&$r(v.Cross(i.directions[2],s.directions[2]),i,s))}}pn._TmpVector3=is.BuildArray(2,v.Zero);class tv{static extractMinAndMaxIndexed(e,t,i,s,n,o){for(let a=i;a<i+s;a++){const l=3*t[a],c=e[l],h=e[l+1],u=e[l+2];n.minimizeInPlaceFromFloats(c,h,u),o.maximizeInPlaceFromFloats(c,h,u)}}static extractMinAndMax(e,t,i,s,n,o){for(let a=t,l=t*s;a<t+i;a++,l+=s){const c=e[l],h=e[l+1],u=e[l+2];n.minimizeInPlaceFromFloats(c,h,u),o.maximizeInPlaceFromFloats(c,h,u)}}}function x1(r,e,t,i=null,s){const n=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new v(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return s||(s=3),tv.extractMinAndMax(r,e,t,s,n,o),i&&(n.x-=n.x*i.x+i.y,n.y-=n.y*i.x+i.y,n.z-=n.z*i.x+i.y,o.x+=o.x*i.x+i.y,o.y+=o.y*i.x+i.y,o.z+=o.z*i.x+i.y),{minimum:n,maximum:o}}E([Yl.filter((...[r,e])=>!Array.isArray(r)&&!Array.isArray(e))],tv,"extractMinAndMaxIndexed",null),E([Yl.filter((...[r])=>!Array.isArray(r))],tv,"extractMinAndMax",null);class fr{get materialDefines(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:null===(e=this._getDrawWrapper())||void 0===e?void 0:e.defines}set materialDefines(e){var t;(null!==(t=this._mainDrawWrapperOverride)&&void 0!==t?t:this._getDrawWrapper(void 0,!0)).defines=e}_getDrawWrapper(e,t=!1){let i=this._drawWrappers[e=e??this._engine.currentRenderPassId];return!i&&t&&(this._drawWrappers[e]=i=new $i(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0){var i;t&&(null===(i=this._drawWrappers[e])||void 0===i||i.dispose()),this._drawWrappers[e]=void 0}get effect(){var e,t;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:null!==(t=null===(e=this._getDrawWrapper())||void 0===e?void 0:e.effect)&&void 0!==t?t:null}get _drawWrapper(){var e;return null!==(e=this._mainDrawWrapperOverride)&&void 0!==e?e:this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,i,s=!0){const n=this._drawWrapper;n.setEffect(e,t,s),void 0!==i&&(n.materialContext=i),e||(n.defines=null,n.materialContext=void 0)}resetDrawCache(e){if(this._drawWrappers){if(void 0!==e)return void this._removeDrawWrapper(e);for(const t of this._drawWrappers)t?.dispose()}this._drawWrappers=[]}static AddToMesh(e,t,i,s,n,o,a,l=!0){return new fr(e,t,i,s,n,o,a,l)}constructor(e,t,i,s,n,o,a,l=!0,c=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=s,this.indexCount=n,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=o,this._renderingMesh=a||o,c&&o.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=o.subMeshes.length-1,l&&(this.refreshBoundingInfo(),o.computeWorldMatrix(!0))}get IsGlobal(){return 0===this.verticesStart&&this.verticesCount===this._mesh.getTotalVertices()&&0===this.indexStart&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){return(this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null)||this._renderingMesh}getMaterial(e=!0){var t;const i=null!==(t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))&&void 0!==t?t:this._renderingMesh.material;if(!i)return e?this._mesh.getScene().defaultMaterial:null;if(this._isMultiMaterial(i)){const s=i.getSubMaterial(this.materialIndex);return this._currentMaterial!==s&&(this._currentMaterial=s,this.resetDrawCache()),s}return i}_isMultiMaterial(e){return void 0!==e.getSubMaterial}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(A.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;const t=this._renderingMesh.getIndices();let i;if(0===this.indexStart&&this.indexCount===t.length){const s=this._renderingMesh.getBoundingInfo();i={minimum:s.minimum.clone(),maximum:s.maximum.clone()}}else i=function tse(r,e,t,i,s=null){const n=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new v(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return tv.extractMinAndMaxIndexed(r,e,t,i,n,o),s&&(n.x-=n.x*s.x+s.y,n.y-=n.y*s.x+s.y,n.z-=n.z*s.x+s.y,o.x+=o.x*s.x+s.y,o.y+=o.y*s.x+s.y,o.z+=o.z*s.x+s.y),{minimum:n,maximum:o}}(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new pn(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){const t=this.getBoundingInfo();return!!t&&t.isInFrustum(e,this._mesh.cullingStrategy)}isCompletelyInFrustum(e){const t=this.getBoundingInfo();return!!t&&t.isCompletelyInFrustum(e)}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){const i=[];for(let s=this.indexStart;s<this.indexStart+this.indexCount;s+=3)i.push(e[s],e[s+1],e[s+1],e[s+2],e[s+2],e[s]);this._linesIndexBuffer=t.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer}canIntersects(e){const t=this.getBoundingInfo();return!!t&&e.intersectsBox(t.boundingBox)}intersects(e,t,i,s,n){const o=this.getMaterial();if(!o)return null;let a=3,l=!1;switch(o.fillMode){case 3:case 5:case 6:case 8:return null;case 7:a=1,l=!0}return 4===o.fillMode?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,s):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,s):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,s,n):this._intersectTriangles(e,t,i,a,l,s,n)}_intersectLines(e,t,i,s,n){let o=null;for(let a=this.indexStart;a<this.indexStart+this.indexCount;a+=2){const h=e.intersectionSegment(t[i[a]],t[i[a+1]],s);if(!(h<0)&&(n||!o||h<o.distance)&&(o=new TE(null,null,h),o.faceId=a/2,n))break}return o}_intersectUnIndexedLines(e,t,i,s,n){let o=null;for(let a=this.verticesStart;a<this.verticesStart+this.verticesCount;a+=2){const h=e.intersectionSegment(t[a],t[a+1],s);if(!(h<0)&&(n||!o||h<o.distance)&&(o=new TE(null,null,h),o.faceId=a/2,n))break}return o}_intersectTriangles(e,t,i,s,n,o,a){let l=null,c=-1;for(let h=this.indexStart;h<this.indexStart+this.indexCount-(3-s);h+=s){c++;const u=i[h],d=i[h+1],f=i[h+2];if(n&&4294967295===f){h+=2;continue}const p=t[u],_=t[d],m=t[f];if(!p||!_||!m||a&&!a(p,_,m,e,u,d,f))continue;const g=e.intersectsTriangle(p,_,m);if(g){if(g.distance<0)continue;if((o||!l||g.distance<l.distance)&&(l=g,l.faceId=c,o))break}}return l}_intersectUnIndexedTriangles(e,t,i,s,n){let o=null;for(let a=this.verticesStart;a<this.verticesStart+this.verticesCount;a+=3){const l=t[a],c=t[a+1],h=t[a+2];if(n&&!n(l,c,h,e,-1,-1,-1))continue;const u=e.intersectsTriangle(l,c,h);if(u){if(u.distance<0)continue;if((s||!o||u.distance<o.distance)&&(o=u,o.faceId=a/3,s))break}}return o}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){const i=new fr(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){const s=this.getBoundingInfo();if(!s)return i;i._boundingInfo=new pn(s.minimum,s.maximum)}return i}dispose(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);const e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,i,s,n,o=!0){let a=Number.MAX_VALUE,l=-Number.MAX_VALUE;const h=(n||s).getIndices();for(let u=t;u<t+i;u++){const d=h[u];d<a&&(a=d),d>l&&(l=d)}return new fr(e,a,l-a+1,t,i,s,n,o)}}let ua=(()=>{class r{static get ForceFullSceneLoadingForIncremental(){return r._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(t){r._ForceFullSceneLoadingForIncremental=t}static get ShowLoadingScreen(){return r._ShowLoadingScreen}static set ShowLoadingScreen(t){r._ShowLoadingScreen=t}static get loggingLevel(){return r._LoggingLevel}static set loggingLevel(t){r._LoggingLevel=t}static get CleanBoneMatrixWeights(){return r._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(t){r._CleanBoneMatrixWeights=t}}return r._ForceFullSceneLoadingForIncremental=!1,r._ShowLoadingScreen=!0,r._CleanBoneMatrixWeights=!1,r._LoggingLevel=0,r})(),It=(()=>{class r{}return r.UseOpenGLOrientationForUV=!1,r})();class rr{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){const t=new rr(rr.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,t,i,s=!1,n=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||be.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=s,i?this.setAllVerticesData(i,s):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),n&&(this.applyToMesh(n),n.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return 1===this.delayLoadState||0===this.delayLoadState}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable));for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,i=!1,s){i&&Array.isArray(t)&&(t=new Float32Array(t));const n=new A(this._engine,t,e,i,0===this._meshes.length,s);this.setVerticesBuffer(n)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,i=!0){const s=e.getKind();this._vertexBuffers[s]&&i&&this._vertexBuffers[s].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[s]=e;const n=this._meshes,o=n.length;if(s===A.PositionKind){const a=e.getData();null!=t?this._totalVertices=t:null!=a&&(this._totalVertices=a.length/(e.type===A.BYTE?e.byteStride:e.byteStride/4)),this._updateExtend(a),this._resetPointsArrayCache();for(let l=0;l<o;l++){const c=n[l];c.buildBoundingInfo(this._extend.minimum,this._extend.maximum),c._createGlobalSubMesh(c.isUnIndexed),c.computeWorldMatrix(!0),c.synchronizeInstances()}}this._notifyUpdate(s)}updateVerticesDataDirectly(e,t,i,s=!1){const n=this.getVertexBuffer(e);!n||(n.updateDirectly(t,i,s),this._notifyUpdate(e))}updateVerticesData(e,t,i=!1){const s=this.getVertexBuffer(e);!s||(s.update(t),e===A.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){const i=this._meshes;for(const s of i){s.hasBoundingInfo?s.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):s.buildBoundingInfo(this._extend.minimum,this._extend.maximum);const n=s.subMeshes;for(const o of n)o.refreshBoundingInfo()}}}_bind(e,t,i,s){if(!e)return;void 0===t&&(t=this._indexBuffer);const n=this.getVertexBuffers();if(!n)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!s)return void this._engine.bindBuffers(n,t,e,i);const o=s||this._vertexArrayObjects;o[e.key]||(o[e.key]=this._engine.recordVertexArrayObject(n,t,e,i)),this._engine.bindVertexArrayObject(o[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){const s=this.getVertexBuffer(e);return s?s.getFloatData(this._totalVertices,i||t&&1!==this._meshes.length):null}isVertexBufferUpdatable(e){const t=this._vertexBuffers[e];return!!t&&t.isUpdatable()}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?void 0!==this._vertexBuffers[e]:!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}getVerticesDataKinds(){const e=[];let t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=!1){if(this._indexBuffer)if(this._indexBufferIsUpdatable){const s=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),s)for(const n of this._meshes)n._createGlobalSubMesh(!0)}else this.setIndices(e,null,!0)}setIndices(e,t=null,i=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i)),null!=t&&(this._totalVertices=t);for(const s of this._meshes)s._createGlobalSubMesh(!0),s.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;const i=this._indices;return t||e&&1!==this._meshes.length?i.slice():i}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){const i=this._meshes,s=i.indexOf(e);-1!==s&&(i.splice(s,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,0===i.length&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;const t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();const i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&!(e=this.getVerticesData(A.PositionKind)))return;this._extend=x1(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){const t=this._meshes.length;for(const i in this._vertexBuffers)1===t&&this._vertexBuffers[i].create(),i===A.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());1===t&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(const t of this._meshes)t._markSubMeshesAsAttributesDirty()}load(e,t){if(2!==this.delayLoadState){if(this.isReady())return void(t&&t());this.delayLoadState=2,this._queueLoad(e,t)}}_queueLoad(e,t){!this.delayLoadingFile||(e.addPendingData(this),e._loadFile(this.delayLoadingFile,i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);const s=this._meshes,n=s.length;for(let o=0;o<n;o++)this._applyToMesh(s[o]);t&&t()},void 0,!0))}toLeftHanded(){const e=this.getIndices(!1);if(null!=e&&e.length>0){for(let s=0;s<e.length;s+=3){const n=e[s+0];e[s+0]=e[s+2],e[s+2]=n}this.setIndices(e)}const t=this.getVerticesData(A.PositionKind,!1);if(null!=t&&t.length>0){for(let s=0;s<t.length;s+=3)t[s+2]=-t[s+2];this.setVerticesData(A.PositionKind,t,!1)}const i=this.getVerticesData(A.NormalKind,!1);if(null!=i&&i.length>0){for(let s=0;s<i.length;s+=3)i[s+2]=-i[s+2];this.setVerticesData(A.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;const e=this.getVerticesData(A.PositionKind);if(!e||0===e.length)return!1;for(let t=3*this._positionsCache.length,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=v.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(const i in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[i]);this._vertexArrayObjects={};const e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject()}}dispose(){const e=this._meshes,t=e.length;let i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(const s in this._vertexBuffers)this._vertexBuffers[s].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){const s=this._parentContainer.geometries.indexOf(this);s>-1&&this._parentContainer.geometries.splice(s,1),this._parentContainer=null}this._isDisposed=!0}copy(e){const t=new ue;t.indices=[];const i=this.getIndices();if(i)for(let l=0;l<i.length;l++)t.indices.push(i[l]);let o,s=!1,n=!1;for(o in this._vertexBuffers){const l=this.getVerticesData(o);if(l&&(l instanceof Float32Array?t.set(new Float32Array(l),o):t.set(l.slice(0),o),!n)){const c=this.getVertexBuffer(o);c&&(s=c.isUpdatable(),n=!s)}}const a=new rr(e,this._scene,t,s);for(o in a.delayLoadState=this.delayLoadState,a.delayLoadingFile=this.delayLoadingFile,a._delayLoadingFunction=this._delayLoadingFunction,this._delayInfo)a._delayInfo=a._delayInfo||[],a._delayInfo.push(o);return a._boundingInfo=new pn(this._extend.minimum,this._extend.maximum),a}serialize(){const e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,Et&&Et.HasTags(this)&&(e.tags=Et.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(const e in this._vertexBuffers)!Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)||(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){const e=this.serialize();return this.isVerticesDataPresent(A.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(A.PositionKind)),this.isVertexBufferUpdatable(A.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(A.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(A.NormalKind)),this.isVertexBufferUpdatable(A.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(A.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(A.TangentKind)),this.isVertexBufferUpdatable(A.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(A.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(A.UVKind)),this.isVertexBufferUpdatable(A.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(A.UV2Kind)&&(e.uv2s=this._toNumberArray(this.getVerticesData(A.UV2Kind)),this.isVertexBufferUpdatable(A.UV2Kind)&&(e.uv2s._updatable=!0)),this.isVerticesDataPresent(A.UV3Kind)&&(e.uv3s=this._toNumberArray(this.getVerticesData(A.UV3Kind)),this.isVertexBufferUpdatable(A.UV3Kind)&&(e.uv3s._updatable=!0)),this.isVerticesDataPresent(A.UV4Kind)&&(e.uv4s=this._toNumberArray(this.getVerticesData(A.UV4Kind)),this.isVertexBufferUpdatable(A.UV4Kind)&&(e.uv4s._updatable=!0)),this.isVerticesDataPresent(A.UV5Kind)&&(e.uv5s=this._toNumberArray(this.getVerticesData(A.UV5Kind)),this.isVertexBufferUpdatable(A.UV5Kind)&&(e.uv5s._updatable=!0)),this.isVerticesDataPresent(A.UV6Kind)&&(e.uv6s=this._toNumberArray(this.getVerticesData(A.UV6Kind)),this.isVertexBufferUpdatable(A.UV6Kind)&&(e.uv6s._updatable=!0)),this.isVerticesDataPresent(A.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(A.ColorKind)),this.isVertexBufferUpdatable(A.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(A.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(A.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(A.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(A.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(A.MatricesWeightsKind)),this.isVertexBufferUpdatable(A.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){const i=e._geometry;return i?i.copy(t):null}static RandomId(){return q.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){const i=t.getScene(),s=e.geometryUniqueId,n=e.geometryId;if(s||n){const o=s?this._GetGeometryByLoadedUniqueId(s,i):i.getGeometryById(n);o&&o.applyToMesh(t)}else if(e instanceof ArrayBuffer){const o=t._binaryInfo;if(o.positionsAttrDesc&&o.positionsAttrDesc.count>0){const a=new Float32Array(e,o.positionsAttrDesc.offset,o.positionsAttrDesc.count);t.setVerticesData(A.PositionKind,a,!1)}if(o.normalsAttrDesc&&o.normalsAttrDesc.count>0){const a=new Float32Array(e,o.normalsAttrDesc.offset,o.normalsAttrDesc.count);t.setVerticesData(A.NormalKind,a,!1)}if(o.tangetsAttrDesc&&o.tangetsAttrDesc.count>0){const a=new Float32Array(e,o.tangetsAttrDesc.offset,o.tangetsAttrDesc.count);t.setVerticesData(A.TangentKind,a,!1)}if(o.uvsAttrDesc&&o.uvsAttrDesc.count>0){const a=new Float32Array(e,o.uvsAttrDesc.offset,o.uvsAttrDesc.count);if(It.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(A.UVKind,a,!1)}if(o.uvs2AttrDesc&&o.uvs2AttrDesc.count>0){const a=new Float32Array(e,o.uvs2AttrDesc.offset,o.uvs2AttrDesc.count);if(It.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(A.UV2Kind,a,!1)}if(o.uvs3AttrDesc&&o.uvs3AttrDesc.count>0){const a=new Float32Array(e,o.uvs3AttrDesc.offset,o.uvs3AttrDesc.count);if(It.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(A.UV3Kind,a,!1)}if(o.uvs4AttrDesc&&o.uvs4AttrDesc.count>0){const a=new Float32Array(e,o.uvs4AttrDesc.offset,o.uvs4AttrDesc.count);if(It.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(A.UV4Kind,a,!1)}if(o.uvs5AttrDesc&&o.uvs5AttrDesc.count>0){const a=new Float32Array(e,o.uvs5AttrDesc.offset,o.uvs5AttrDesc.count);if(It.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(A.UV5Kind,a,!1)}if(o.uvs6AttrDesc&&o.uvs6AttrDesc.count>0){const a=new Float32Array(e,o.uvs6AttrDesc.offset,o.uvs6AttrDesc.count);if(It.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(A.UV6Kind,a,!1)}if(o.colorsAttrDesc&&o.colorsAttrDesc.count>0){const a=new Float32Array(e,o.colorsAttrDesc.offset,o.colorsAttrDesc.count);t.setVerticesData(A.ColorKind,a,!1,o.colorsAttrDesc.stride)}if(o.matricesIndicesAttrDesc&&o.matricesIndicesAttrDesc.count>0){const a=new Int32Array(e,o.matricesIndicesAttrDesc.offset,o.matricesIndicesAttrDesc.count),l=[];for(let c=0;c<a.length;c++){const h=a[c];l.push(255&h),l.push((65280&h)>>8),l.push((16711680&h)>>16),l.push(h>>24&255)}t.setVerticesData(A.MatricesIndicesKind,l,!1)}if(o.matricesIndicesExtraAttrDesc&&o.matricesIndicesExtraAttrDesc.count>0){const a=new Int32Array(e,o.matricesIndicesExtraAttrDesc.offset,o.matricesIndicesExtraAttrDesc.count),l=[];for(let c=0;c<a.length;c++){const h=a[c];l.push(255&h),l.push((65280&h)>>8),l.push((16711680&h)>>16),l.push(h>>24&255)}t.setVerticesData(A.MatricesIndicesExtraKind,l,!1)}if(o.matricesWeightsAttrDesc&&o.matricesWeightsAttrDesc.count>0){const a=new Float32Array(e,o.matricesWeightsAttrDesc.offset,o.matricesWeightsAttrDesc.count);t.setVerticesData(A.MatricesWeightsKind,a,!1)}if(o.indicesAttrDesc&&o.indicesAttrDesc.count>0){const a=new Int32Array(e,o.indicesAttrDesc.offset,o.indicesAttrDesc.count);t.setIndices(a,null)}if(o.subMeshesAttrDesc&&o.subMeshesAttrDesc.count>0){const a=new Int32Array(e,o.subMeshesAttrDesc.offset,5*o.subMeshesAttrDesc.count);t.subMeshes=[];for(let l=0;l<o.subMeshesAttrDesc.count;l++)fr.AddToMesh(a[5*l+0],a[5*l+1],a[5*l+2],a[5*l+3],a[5*l+4],t)}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(A.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(A.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(A.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(A.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(A.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(A.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(A.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(A.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(A.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(A.ColorKind,Te.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(A.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{const o=[];for(let a=0;a<e.matricesIndices.length;a++){const l=e.matricesIndices[a];o.push(255&l),o.push((65280&l)>>8),o.push((16711680&l)>>16),o.push(l>>24&255)}t.setVerticesData(A.MatricesIndicesKind,o,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(A.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{const o=[];for(let a=0;a<e.matricesIndicesExtra.length;a++){const l=e.matricesIndicesExtra[a];o.push(255&l),o.push((65280&l)>>8),o.push((16711680&l)>>16),o.push(l>>24&255)}t.setVerticesData(A.MatricesIndicesExtraKind,o,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(rr._CleanMatricesWeights(e,t),t.setVerticesData(A.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(A.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let o=0;o<e.subMeshes.length;o++){const a=e.subMeshes[o];fr.AddToMesh(a.materialIndex,a.verticesStart,a.verticesCount,a.indexStart,a.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){if(!ua.CleanBoneMatrixWeights)return;let s=0;if(!(e.skeletonId>-1))return;{const u=t.getScene().getLastSkeletonById(e.skeletonId);if(!u)return;s=u.bones.length}const n=t.getVerticesData(A.MatricesIndicesKind),o=t.getVerticesData(A.MatricesIndicesExtraKind),a=e.matricesWeights,l=e.matricesWeightsExtra,c=e.numBoneInfluencer,h=a.length;for(let u=0;u<h;u+=4){let d=0,f=-1;for(let p=0;p<4;p++){const _=a[u+p];d+=_,_<.001&&f<0&&(f=p)}if(l)for(let p=0;p<4;p++){const _=l[u+p];d+=_,_<.001&&f<0&&(f=p+4)}if((f<0||f>c-1)&&(f=c-1),d>.001){const p=1/d;for(let _=0;_<4;_++)a[u+_]*=p;if(l)for(let _=0;_<4;_++)l[u+_]*=p}else f>=4?(l[u+f-4]=1-d,o[u+f-4]=s):(a[u+f]=1-d,n[u+f]=s)}t.setVerticesData(A.MatricesIndicesKind,n),e.matricesWeightsExtra&&t.setVerticesData(A.MatricesIndicesExtraKind,o)}static Parse(e,t,i){const s=new rr(e.id,t,void 0,e.updatable);return s._loadedUniqueId=e.uniqueId,Et&&Et.AddTagsTo(s,e.tags),e.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=i+e.delayLoadingFile,s._boundingInfo=new pn(v.FromArray(e.boundingBoxMinimum),v.FromArray(e.boundingBoxMaximum)),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(A.UVKind),e.hasUVs2&&s._delayInfo.push(A.UV2Kind),e.hasUVs3&&s._delayInfo.push(A.UV3Kind),e.hasUVs4&&s._delayInfo.push(A.UV4Kind),e.hasUVs5&&s._delayInfo.push(A.UV5Kind),e.hasUVs6&&s._delayInfo.push(A.UV6Kind),e.hasColors&&s._delayInfo.push(A.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(A.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(A.MatricesWeightsKind),s._delayLoadingFunction=ue.ImportVertexData):ue.ImportVertexData(e,s),t.pushGeometry(s,!0),s}}class ise{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new sse(e)}sampleFrame(e=ir.Now){this._enabled&&(null!=this._lastFrameTimeMs&&this._rollingFrameTime.add(e-this._lastFrameTimeMs),this._lastFrameTimeMs=e)}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return 0===e?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class sse{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){const i=this._samples[this._pos];t=i-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(i-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const t=this._samples.length;return(e%t+t)%t}}function CE(r,e,t=!1,i){switch(r){case 3:{const n=(ArrayBuffer,new Int8Array(e));return i&&n.set(new Int8Array(i)),n}case 0:{const n=(ArrayBuffer,new Uint8Array(e));return i&&n.set(new Uint8Array(i)),n}case 4:{const n=e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);return i&&n.set(new Int16Array(i)),n}case 5:case 8:case 9:case 10:case 2:{const n=e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);return i&&n.set(new Uint16Array(i)),n}case 6:{const n=e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);return i&&n.set(new Int32Array(i)),n}case 7:case 11:case 12:case 13:case 14:case 15:{const n=e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);return i&&n.set(new Uint32Array(i)),n}case 1:{const n=e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e);return i&&n.set(new Float32Array(i)),n}}const s=(ArrayBuffer,new Uint8Array(e));return i&&s.set(new Uint8Array(i)),s}we.prototype.setAlphaConstants=function(r,e,t,i){this._alphaState.setAlphaBlendConstants(r,e,t,i)},we.prototype.setAlphaMode=function(r,e=!1){if(this._alphaMode!==r){switch(r){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}e||(this.depthCullingState.depthMask=0===r),this._alphaMode=r}else if(!e){const t=0===r;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}},we.prototype.getAlphaMode=function(){return this._alphaMode},we.prototype.setAlphaEquation=function(r){if(this._alphaEquation!==r){switch(r){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=r}},we.prototype.getAlphaEquation=function(){return this._alphaEquation},we.prototype._readTexturePixelsSync=function(r,e,t,i=-1,s=0,n=null,o=!0,a=!1,l=0,c=0){var h,u;const d=this._gl;if(!d)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const p=d.createFramebuffer();if(!p)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=p}d.bindFramebuffer(d.FRAMEBUFFER,this._dummyFramebuffer),i>-1?d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_CUBE_MAP_POSITIVE_X+i,null===(h=r._hardwareTexture)||void 0===h?void 0:h.underlyingResource,s):d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,null===(u=r._hardwareTexture)||void 0===u?void 0:u.underlyingResource,s);let f=void 0!==r.type?this._getWebGLTextureType(r.type):d.UNSIGNED_BYTE;return a?n||(n=CE(r.type,4*e*t)):f===d.UNSIGNED_BYTE?(n||(n=new Uint8Array(4*e*t)),f=d.UNSIGNED_BYTE):(n||(n=new Float32Array(4*e*t)),f=d.FLOAT),o&&this.flushFramebuffer(),d.readPixels(l,c,e,t,d.RGBA,f,n),d.bindFramebuffer(d.FRAMEBUFFER,this._currentFramebuffer),n},we.prototype._readTexturePixels=function(r,e,t,i=-1,s=0,n=null,o=!0,a=!1,l=0,c=0){return Promise.resolve(this._readTexturePixelsSync(r,e,t,i,s,n,o,a,l,c))},we.prototype.updateDynamicIndexBuffer=function(r,e,t=0){let i;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(r),i=r.is32Bits?e instanceof Uint32Array?e:new Uint32Array(e):e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},we.prototype.updateDynamicVertexBuffer=function(r,e,t,i){this.bindArrayBuffer(r),void 0===t&&(t=0),void 0===i||i>=(e.byteLength||e.length)&&0===t?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e instanceof Array?new Float32Array(e):e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(e).subarray(t,t+i)):(e=e instanceof ArrayBuffer?new Uint8Array(e,t,i):new Uint8Array(e.buffer,e.byteOffset+t,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)),this._resetVertexBufferBinding()};let ee=(()=>{class r extends we{static get NpmPackage(){return we.NpmPackage}static get Version(){return we.Version}static get Instances(){return be.Instances}static get LastCreatedEngine(){return be.LastCreatedEngine}static get LastCreatedScene(){return be.LastCreatedScene}_createImageBitmapFromSource(t,i){return new Promise((n,o)=>{const a=new Image;a.onload=()=>{a.decode().then(()=>{this.createImageBitmap(a,i).then(l=>{n(l)})})},a.onerror=()=>{o(`Error loading image ${a.src}`)},a.src=t})}createImageBitmap(t,i){return createImageBitmap(t,i)}resizeImageBitmap(t,i,s){const o=this.createCanvas(i,s).getContext("2d");if(!o)throw new Error("Unable to get 2d context for resizeImageBitmap");return o.drawImage(t,0,0),o.getImageData(0,0,i,s).data}static MarkAllMaterialsAsDirty(t,i){for(let s=0;s<r.Instances.length;s++){const n=r.Instances[s];for(let o=0;o<n.scenes.length;o++)n.scenes[o].markAllMaterialsAsDirty(t,i)}}static DefaultLoadingScreenFactory(t){throw Ge("LoadingScreen")}get _supportsHardwareTextureRescaling(){return!!r._RescalePostProcessFactory}get performanceMonitor(){return this._performanceMonitor}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(t){this._compatibilityMode=!0}getInputElement(){return this._renderingCanvas}constructor(t,i,s,n=!1){super(t,i,s,n),this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.scenes=new Array,this._virtualScenes=new Array,this.onNewSceneAddedObservable=new z,this.postProcesses=new Array,this.isPointerLock=!1,this.onResizeObservable=new z,this.onCanvasBlurObservable=new z,this.onCanvasFocusObservable=new z,this.onCanvasPointerOutObservable=new z,this.onBeginFrameObservable=new z,this.customAnimationFrameRequester=null,this.onEndFrameObservable=new z,this.onBeforeShaderCompilationObservable=new z,this.onAfterShaderCompilationObservable=new z,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this._fps=60,this._deltaTime=0,this._drawCalls=new eh,this.canvasTabIndex=1,this.disablePerformanceMonitorInBackground=!1,this._performanceMonitor=new ise,this._compatibilityMode=!0,this.currentRenderPassId=0,this._renderPassNames=["main"],r.Instances.push(this),t&&(this._features.supportRenderPasses=!0,s=this._creationOptions,t.getContext&&(this._sharedInit(t),this._connectVREvents()),this._prepareVRComponent(),s.autoEnableWebVR&&this.initWebVR())}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(t){super._sharedInit(t),this._onCanvasFocus=()=>{this.onCanvasFocusObservable.notifyObservers(this)},this._onCanvasBlur=()=>{this.onCanvasBlurObservable.notifyObservers(this)},this._onCanvasContextMenu=s=>{this.disableContextMenu&&s.preventDefault()},t.addEventListener("focus",this._onCanvasFocus),t.addEventListener("blur",this._onCanvasBlur),t.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.disable(),this._windowIsBackground=!0},this._onFocus=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.enable(),this._windowIsBackground=!1},this._onCanvasPointerOut=s=>{document.elementFromPoint(s.clientX,s.clientY)!==t&&this.onCanvasPointerOutObservable.notifyObservers(s)};const i=this.getHostWindow();i&&"function"==typeof i.addEventListener&&(i.addEventListener("blur",this._onBlur),i.addEventListener("focus",this._onFocus)),t.addEventListener("pointerout",this._onCanvasPointerOut),this._creationOptions.doNotHandleTouchAction||this._disableTouchAction(),!r.audioEngine&&this._creationOptions.audioEngine&&r.AudioEngineFactory&&(r.audioEngine=r.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination())),rp()&&(this._onFullscreenChange=()=>{this.isFullscreen=!!document.fullscreenElement,this.isFullscreen&&this._pointerLockRequested&&t&&r._RequestPointerlock(t)},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=()=>{this.isPointerLock=document.pointerLockElement===t},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1)),this.enableOfflineSupport=void 0!==r.OfflineProviderFactory,this._deterministicLockstep=!!this._creationOptions.deterministicLockstep,this._lockstepMaxSteps=this._creationOptions.lockstepMaxSteps||0,this._timeStep=this._creationOptions.timeStep||1/60}getAspectRatio(t,i=!1){const s=t.viewport;return this.getRenderWidth(i)*s.width/(this.getRenderHeight(i)*s.height)}getScreenAspectRatio(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)}getRenderingCanvasClientRect(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null}getInputElementClientRect(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return 1e3*this._timeStep}generateMipMapsForCubemap(t,i=!0){if(t.generateMipMaps){const s=this._gl;this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,t,!0),s.generateMipmap(s.TEXTURE_CUBE_MAP),i&&this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null)}}getDepthWrite(){return this._depthCullingState.depthMask}setDepthWrite(t){this._depthCullingState.depthMask=t}getStencilBuffer(){return this._stencilState.stencilTest}setStencilBuffer(t){this._stencilState.stencilTest=t}getStencilMask(){return this._stencilState.stencilMask}setStencilMask(t){this._stencilState.stencilMask=t}getStencilFunction(){return this._stencilState.stencilFunc}getStencilFunctionReference(){return this._stencilState.stencilFuncRef}getStencilFunctionMask(){return this._stencilState.stencilFuncMask}setStencilFunction(t){this._stencilState.stencilFunc=t}setStencilFunctionReference(t){this._stencilState.stencilFuncRef=t}setStencilFunctionMask(t){this._stencilState.stencilFuncMask=t}getStencilOperationFail(){return this._stencilState.stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilState.stencilOpDepthFail}getStencilOperationPass(){return this._stencilState.stencilOpStencilDepthPass}setStencilOperationFail(t){this._stencilState.stencilOpStencilFail=t}setStencilOperationDepthFail(t){this._stencilState.stencilOpDepthFail=t}setStencilOperationPass(t){this._stencilState.stencilOpStencilDepthPass=t}setDitheringState(t){t?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(t){t?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}getDepthFunction(){return this._depthCullingState.depthFunc}setDepthFunction(t){this._depthCullingState.depthFunc=t}setDepthFunctionToGreater(){this.setDepthFunction(516)}setDepthFunctionToGreaterOrEqual(){this.setDepthFunction(518)}setDepthFunctionToLess(){this.setDepthFunction(513)}setDepthFunctionToLessOrEqual(){this.setDepthFunction(515)}cacheStencilState(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()}restoreStencilState(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}setDirectViewport(t,i,s,n){const o=this._cachedViewport;return this._cachedViewport=null,this._viewport(t,i,s,n),o}scissorClear(t,i,s,n,o){this.enableScissor(t,i,s,n),this.clear(o,!0,!0,!0),this.disableScissor()}enableScissor(t,i,s,n){const o=this._gl;o.enable(o.SCISSOR_TEST),o.scissor(t,i,s,n)}disableScissor(){const t=this._gl;t.disable(t.SCISSOR_TEST)}_reportDrawCall(t=1){this._drawCalls.addCount(t,!1)}initWebVR(){throw Ge("WebVRCamera")}_prepareVRComponent(){}_connectVREvents(t,i){}_submitVRFrame(){}disableVR(){}isVRPresenting(){return!1}_requestVRFrame(){}_loadFileAsync(t,i,s){return new Promise((n,o)=>{this._loadFile(t,a=>{n(a)},void 0,i,s,(a,l)=>{o(l)})})}getVertexShaderSource(t){const i=this._gl.getAttachedShaders(t);return i?this._gl.getShaderSource(i[0]):null}getFragmentShaderSource(t){const i=this._gl.getAttachedShaders(t);return i?this._gl.getShaderSource(i[1]):null}setDepthStencilTexture(t,i,s,n){void 0!==t&&(i&&(this._boundUniforms[t]=i),s&&s.depthStencilTexture?this._setTexture(t,s,!1,!0,n):this._setTexture(t,null,void 0,void 0,n))}setTextureFromPostProcess(t,i,s){var n;let o=null;i&&(i._textures.data[i._currentRenderTextureInd]?o=i._textures.data[i._currentRenderTextureInd]:i._forcedOutputTexture&&(o=i._forcedOutputTexture)),this._bindTexture(t,null!==(n=o?.texture)&&void 0!==n?n:null,s)}setTextureFromPostProcessOutput(t,i,s){var n,o;this._bindTexture(t,null!==(o=null===(n=i?._outputTexture)||void 0===n?void 0:n.texture)&&void 0!==o?o:null,s)}_rebuildBuffers(){for(const t of this.scenes)t.resetCachedMaterial(),t._rebuildGeometries(),t._rebuildTextures();for(const t of this._virtualScenes)t.resetCachedMaterial(),t._rebuildGeometries(),t._rebuildTextures();super._rebuildBuffers()}_renderFrame(){for(let t=0;t<this._activeRenderLoops.length;t++)(0,this._activeRenderLoops[t])()}_renderLoop(){if(!this._contextWasLost){let t=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(t=!1),t&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}_renderViews(){return!1}switchFullscreen(t){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(t)}enterFullscreen(t){this.isFullscreen||(this._pointerLockRequested=t,this._renderingCanvas&&r._RequestFullscreen(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&r._ExitFullscreen()}enterPointerlock(){this._renderingCanvas&&r._RequestPointerlock(this._renderingCanvas)}exitPointerlock(){r._ExitPointerlock()}beginFrame(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),super.beginFrame()}endFrame(){super.endFrame(),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)}resize(t=!1){this.isVRPresenting()||super.resize(t)}setSize(t,i,s=!1){if(!this._renderingCanvas||!super.setSize(t,i,s))return!1;if(this.scenes){for(let n=0;n<this.scenes.length;n++){const o=this.scenes[n];for(let a=0;a<o.cameras.length;a++)o.cameras[a]._currentRenderId=0}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}_deletePipelineContext(t){const i=t;i&&i.program&&i.transformFeedback&&(this.deleteTransformFeedback(i.transformFeedback),i.transformFeedback=null),super._deletePipelineContext(t)}createShaderProgram(t,i,s,n,o,a=null){o=o||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const l=super.createShaderProgram(t,i,s,n,o,a);return this.onAfterShaderCompilationObservable.notifyObservers(this),l}_createShaderProgram(t,i,s,n,o=null){const a=n.createProgram();if(t.program=a,!a)throw new Error("Unable to create program");if(n.attachShader(a,i),n.attachShader(a,s),this.webGLVersion>1&&o){const l=this.createTransformFeedback();this.bindTransformFeedback(l),this.setTranformFeedbackVaryings(a,o),t.transformFeedback=l}return n.linkProgram(a),this.webGLVersion>1&&o&&this.bindTransformFeedback(null),t.context=n,t.vertexShader=i,t.fragmentShader=s,t.isParallelCompiled||this._finalizePipelineContext(t),a}_releaseTexture(t){super._releaseTexture(t)}_releaseRenderTargetWrapper(t){super._releaseRenderTargetWrapper(t),this.scenes.forEach(i=>{i.postProcesses.forEach(s=>{s._outputTexture===t&&(s._outputTexture=null)}),i.cameras.forEach(s=>{s._postProcesses.forEach(n=>{n&&n._outputTexture===t&&(n._outputTexture=null)})})})}getRenderPassNames(){return this._renderPassNames}getCurrentRenderPassName(){return this._renderPassNames[this.currentRenderPassId]}createRenderPassId(t){const i=++r._RenderPassIdCounter;return this._renderPassNames[i]=t??"NONAME",i}releaseRenderPassId(t){this._renderPassNames[t]=void 0;for(let i=0;i<this.scenes.length;++i){const s=this.scenes[i];for(let n=0;n<s.meshes.length;++n){const o=s.meshes[n];if(o.subMeshes)for(let a=0;a<o.subMeshes.length;++a)o.subMeshes[a]._removeDrawWrapper(t)}}}_rescaleTexture(t,i,s,n,o){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const a=this.createRenderTargetTexture({width:i.width,height:i.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&r._RescalePostProcessFactory&&(this._rescalePostProcess=r._RescalePostProcessFactory(this)),this._rescalePostProcess&&(this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled(()=>{this._rescalePostProcess.onApply=function(c){c._bindTexture("textureSampler",t)};let l=s;l||(l=this.scenes[this.scenes.length-1]),l.postProcessManager.directRender([this._rescalePostProcess],a,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,i,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,n,0,0,i.width,i.height,0),this.unBindFramebuffer(a),a.dispose(),o&&o()}))}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}wrapWebGLTexture(t,i=!1,s=3){const n=new lp(t,this._gl),o=new zt(this,Ye.Unknown,!0);return o._hardwareTexture=n,o.isReady=!0,o.useMipMaps=i,this.updateTextureSamplingMode(s,o),o}_uploadImageToTexture(t,i,s=0,n=0){const o=this._gl,a=this._getWebGLTextureType(t.type),l=this._getInternalFormat(t.format),c=this._getRGBABufferInternalSizedFormat(t.type,l),h=t.isCube?o.TEXTURE_CUBE_MAP:o.TEXTURE_2D;this._bindTextureDirectly(h,t,!0),this._unpackFlipY(t.invertY);let u=o.TEXTURE_2D;t.isCube&&(u=o.TEXTURE_CUBE_MAP_POSITIVE_X+s),o.texImage2D(u,n,c,l,a,i),this._bindTextureDirectly(h,null,!0)}updateTextureComparisonFunction(t,i){if(1===this.webGLVersion)return void V.Error("WebGL 1 does not support texture comparison.");const s=this._gl;t.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,t,!0),0===i?(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_FUNC,515),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_MODE,s.NONE)):(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_FUNC,i),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_MODE,s.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),0===i?(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_FUNC,515),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_MODE,s.NONE)):(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_FUNC,i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_MODE,s.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),t._comparisonFunction=i}createInstancesBuffer(t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create instance buffer");const s=new ap(i);return s.capacity=t,this.bindArrayBuffer(s),this._gl.bufferData(this._gl.ARRAY_BUFFER,t,this._gl.DYNAMIC_DRAW),s.references=1,s}deleteInstancesBuffer(t){this._gl.deleteBuffer(t)}_clientWaitAsync(t,i=0,s=10){const n=this._gl;return new Promise((o,a)=>{const l=()=>{const c=n.clientWaitSync(t,i,0);c!=n.WAIT_FAILED?c!=n.TIMEOUT_EXPIRED?o():setTimeout(l,s):a()};l()})}_readPixelsAsync(t,i,s,n,o,a,l){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const c=this._gl,h=c.createBuffer();c.bindBuffer(c.PIXEL_PACK_BUFFER,h),c.bufferData(c.PIXEL_PACK_BUFFER,l.byteLength,c.STREAM_READ),c.readPixels(t,i,s,n,o,a,0),c.bindBuffer(c.PIXEL_PACK_BUFFER,null);const u=c.fenceSync(c.SYNC_GPU_COMMANDS_COMPLETE,0);return u?(c.flush(),this._clientWaitAsync(u,0,10).then(()=>(c.deleteSync(u),c.bindBuffer(c.PIXEL_PACK_BUFFER,h),c.getBufferSubData(c.PIXEL_PACK_BUFFER,0,l),c.bindBuffer(c.PIXEL_PACK_BUFFER,null),c.deleteBuffer(h),l))):null}dispose(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();1===be.Instances.length&&r.audioEngine&&(r.audioEngine.dispose(),r.audioEngine=null),this.disableVR();const t=this.getHostWindow();t&&"function"==typeof t.removeEventListener&&(t.removeEventListener("blur",this._onBlur),t.removeEventListener("focus",this._onFocus)),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),rp()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)),super.dispose();const i=be.Instances.indexOf(this);i>=0&&be.Instances.splice(i,1),r.Instances.length||(be.OnEnginesDisposedObservable.notifyObservers(this),be.OnEnginesDisposedObservable.clear()),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}_disableTouchAction(){!this._renderingCanvas||!this._renderingCanvas.setAttribute||(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")}displayLoadingUI(){if(!qi())return;const t=this.loadingScreen;t&&t.displayLoadingUI()}hideLoadingUI(){if(!qi())return;const t=this._loadingScreen;t&&t.hideLoadingUI()}get loadingScreen(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=r.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen}set loadingScreen(t){this._loadingScreen=t}set loadingUIText(t){this.loadingScreen.loadingUIText=t}set loadingUIBackgroundColor(t){this.loadingScreen.loadingUIBackgroundColor=t}createVideoElement(t){return document.createElement("video")}static _RequestPointerlock(t){if(t.requestPointerLock){const i=t.requestPointerLock();i instanceof Promise?i.then(()=>{t.focus()}).catch(()=>{}):t.focus()}}static _ExitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}static _RequestFullscreen(t){const i=t.requestFullscreen||t.webkitRequestFullscreen;!i||i.call(t)}static _ExitFullscreen(){const t=document;document.exitFullscreen?document.exitFullscreen():t.webkitCancelFullScreen&&t.webkitCancelFullScreen()}getFontOffset(t){const i=document.createElement("span");i.innerHTML="Hg",i.setAttribute("style",`font: ${t} !important`);const s=document.createElement("div");s.style.display="inline-block",s.style.width="1px",s.style.height="0px",s.style.verticalAlign="bottom";const n=document.createElement("div");n.style.whiteSpace="nowrap",n.appendChild(i),n.appendChild(s),document.body.appendChild(n);let o=0,a=0;try{a=s.getBoundingClientRect().top-i.getBoundingClientRect().top,s.style.verticalAlign="baseline",o=s.getBoundingClientRect().top-i.getBoundingClientRect().top}finally{document.body.removeChild(n)}return{ascent:o,height:a,descent:a-o}}}return r.ALPHA_DISABLE=0,r.ALPHA_ADD=1,r.ALPHA_COMBINE=2,r.ALPHA_SUBTRACT=3,r.ALPHA_MULTIPLY=4,r.ALPHA_MAXIMIZED=5,r.ALPHA_ONEONE=6,r.ALPHA_PREMULTIPLIED=7,r.ALPHA_PREMULTIPLIED_PORTERDUFF=8,r.ALPHA_INTERPOLATE=9,r.ALPHA_SCREENMODE=10,r.DELAYLOADSTATE_NONE=0,r.DELAYLOADSTATE_LOADED=1,r.DELAYLOADSTATE_LOADING=2,r.DELAYLOADSTATE_NOTLOADED=4,r.NEVER=512,r.ALWAYS=519,r.LESS=513,r.EQUAL=514,r.LEQUAL=515,r.GREATER=516,r.GEQUAL=518,r.NOTEQUAL=517,r.KEEP=7680,r.REPLACE=7681,r.INCR=7682,r.DECR=7683,r.INVERT=5386,r.INCR_WRAP=34055,r.DECR_WRAP=34056,r.TEXTURE_CLAMP_ADDRESSMODE=0,r.TEXTURE_WRAP_ADDRESSMODE=1,r.TEXTURE_MIRROR_ADDRESSMODE=2,r.TEXTUREFORMAT_ALPHA=0,r.TEXTUREFORMAT_LUMINANCE=1,r.TEXTUREFORMAT_LUMINANCE_ALPHA=2,r.TEXTUREFORMAT_RGB=4,r.TEXTUREFORMAT_RGBA=5,r.TEXTUREFORMAT_RED=6,r.TEXTUREFORMAT_R=6,r.TEXTUREFORMAT_RG=7,r.TEXTUREFORMAT_RED_INTEGER=8,r.TEXTUREFORMAT_R_INTEGER=8,r.TEXTUREFORMAT_RG_INTEGER=9,r.TEXTUREFORMAT_RGB_INTEGER=10,r.TEXTUREFORMAT_RGBA_INTEGER=11,r.TEXTURETYPE_UNSIGNED_BYTE=0,r.TEXTURETYPE_UNSIGNED_INT=0,r.TEXTURETYPE_FLOAT=1,r.TEXTURETYPE_HALF_FLOAT=2,r.TEXTURETYPE_BYTE=3,r.TEXTURETYPE_SHORT=4,r.TEXTURETYPE_UNSIGNED_SHORT=5,r.TEXTURETYPE_INT=6,r.TEXTURETYPE_UNSIGNED_INTEGER=7,r.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,r.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,r.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,r.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,r.TEXTURETYPE_UNSIGNED_INT_24_8=12,r.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,r.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,r.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,r.TEXTURE_NEAREST_SAMPLINGMODE=1,r.TEXTURE_BILINEAR_SAMPLINGMODE=2,r.TEXTURE_TRILINEAR_SAMPLINGMODE=3,r.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,r.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,r.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,r.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,r.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,r.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,r.TEXTURE_NEAREST_LINEAR=7,r.TEXTURE_NEAREST_NEAREST=1,r.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,r.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,r.TEXTURE_LINEAR_LINEAR=2,r.TEXTURE_LINEAR_NEAREST=12,r.TEXTURE_EXPLICIT_MODE=0,r.TEXTURE_SPHERICAL_MODE=1,r.TEXTURE_PLANAR_MODE=2,r.TEXTURE_CUBIC_MODE=3,r.TEXTURE_PROJECTION_MODE=4,r.TEXTURE_SKYBOX_MODE=5,r.TEXTURE_INVCUBIC_MODE=6,r.TEXTURE_EQUIRECTANGULAR_MODE=7,r.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,r.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,r.SCALEMODE_FLOOR=1,r.SCALEMODE_NEAREST=2,r.SCALEMODE_CEILING=3,r._RescalePostProcessFactory=null,r._RenderPassIdCounter=0,r})();class We extends Rt{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=0!=(this._billboardMode&We.BILLBOARDMODE_USE_POSITION),this._computeUseBillboardPath())}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e,this._computeUseBillboardPath())}_computeUseBillboardPath(){this._cache.useBillboardPath=this._billboardMode!==We.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,t=null,i=!0){super(e,t),this._forward=new v(0,0,1),this._up=new v(0,1,0),this._right=new v(1,0,0),this._position=v.Zero(),this._rotation=v.Zero(),this._rotationQuaternion=null,this._scaling=v.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=We.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=F.Zero(),this._usePivotMatrix=!1,this._absolutePosition=v.Zero(),this._absoluteScaling=v.Zero(),this._absoluteRotationQuaternion=Z.Identity(),this._pivotMatrix=F.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new z,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._isDirty=!0}isUsingPivotMatrix(){return this._usePivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._isDirty=!0}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._isDirty=!0}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._isDirty=!0}get forward(){return v.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return v.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return v.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=F.Identity()),this._poseMatrix}_isSynchronized(){const e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==We.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();const e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1,e.useBillboardPath=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=F.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){const s=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);s&&i&&i(this,s);for(const n of this.getChildTransformNodes(!0))n.instantiateHierarchy(s,t,i);return s}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||Z.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,s;if(void 0===e.x){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],s=arguments[2]}else t=e.x,i=e.y,s=e.z;if(this.parent){const n=L.Matrix[0];this.parent.getWorldMatrix().invertToRef(n),v.TransformCoordinatesFromFloatsToRef(t,i,s,n,this.position)}else this.position.x=t,this.position.y=i,this.position.z=s;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=v.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const e=L.Matrix[0];return this._localMatrix.invertToRef(e),v.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=v.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,s=0,n=$e.LOCAL){const o=We._LookAtVectorCache,a=n===$e.LOCAL?this.position:this.getAbsolutePosition();if(e.subtractToRef(a,o),this.setDirection(o,t,i,s),n===$e.WORLD&&this.parent)if(this.rotationQuaternion){const l=L.Matrix[0];this.rotationQuaternion.toRotationMatrix(l);const c=L.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(c),c.invert(),l.multiplyToRef(c,l),this.rotationQuaternion.fromRotationMatrix(l)}else{const l=L.Quaternion[0];Z.FromEulerVectorToRef(this.rotation,l);const c=L.Matrix[0];l.toRotationMatrix(c);const h=L.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(h),h.invert(),c.multiplyToRef(h,c),l.fromRotationMatrix(c),l.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){const t=v.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return v.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,s=0){const n=-Math.atan2(e.z,e.x)+Math.PI/2,o=Math.sqrt(e.x*e.x+e.z*e.z),a=-Math.atan2(e.y,o);return this.rotationQuaternion?Z.RotationYawPitchRollToRef(n+t,a+i,s,this.rotationQuaternion):(this.rotation.x=a+i,this.rotation.y=n+t,this.rotation.z=s),this}setPivotPoint(e,t=$e.LOCAL){0==this.getScene().getRenderId()&&this.computeWorldMatrix(!0);const i=this.getWorldMatrix();if(t==$e.WORLD){const s=L.Matrix[0];i.invertToRef(s),e=v.TransformCoordinates(e,s)}return this.setPivotMatrix(F.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){const e=v.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){const e=v.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),v.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(const t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;const s=L.Quaternion[0],n=L.Vector3[0],o=L.Vector3[1],a=L.Matrix[1];F.IdentityToRef(a);const l=L.Matrix[0];this.computeWorldMatrix(!0);let c=this.rotationQuaternion;return c||(c=We._TmpRotation,Z.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,c)),F.ComposeToRef(this.scaling,c,this.position,l),this.parent&&l.multiplyToRef(this.parent.computeWorldMatrix(!0),l),e&&(e.computeWorldMatrix(!0).invertToRef(a),l.multiplyToRef(a,l)),l.decompose(o,s,n,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(s):s.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(o),this.position.copyFrom(n),this.parent=e,i&&this.setPivotMatrix(F.Identity()),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling!==e&&(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(),e.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,this.parent=e?this._currentParentWhenAttachingToBone:null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){let s;if(e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0)),i&&i!==$e.LOCAL){if(this.parent){const n=L.Matrix[0];this.parent.getWorldMatrix().invertToRef(n),e=v.TransformNormal(e,n)}s=Z.RotationAxisToRef(e,t,We._RotationAxisCache),s.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}else s=Z.RotationAxisToRef(e,t,We._RotationAxisCache),this.rotationQuaternion.multiplyToRef(s,this.rotationQuaternion);return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=Z.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const s=L.Vector3[0],n=L.Vector3[1],o=L.Vector3[2],a=L.Quaternion[0],l=L.Matrix[0],c=L.Matrix[1],h=L.Matrix[2],u=L.Matrix[3];return e.subtractToRef(this.position,s),F.TranslationToRef(s.x,s.y,s.z,l),F.TranslationToRef(-s.x,-s.y,-s.z,c),F.RotationAxisToRef(t,i,h),c.multiplyToRef(h,u),u.multiplyToRef(l,u),u.decompose(n,a,o),this.position.addInPlace(o),a.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){const s=e.scale(t);if(i&&i!==$e.LOCAL)this.setAbsolutePosition(this.getAbsolutePosition().add(s));else{const n=this.getPositionExpressedInLocalSpace().add(s);this.setPositionWithLocalVector(n)}return this}addRotation(e,t,i){let s;this.rotationQuaternion?s=this.rotationQuaternion:(s=L.Quaternion[1],Z.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,s));const n=L.Quaternion[0];return Z.RotationYawPitchRollToRef(t,e,i,n),s.multiplyInPlace(n),this.rotationQuaternion||s.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==We.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}computeWorldMatrix(e=!1,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;const i=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();const s=this._cache;s.pivotMatrixUpdated=!1,s.billboardMode=this.billboardMode,s.infiniteDistance=this.infiniteDistance,s.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;const n=this._getEffectiveParent(),o=We._TmpScaling;let l,a=this._position;if(this._infiniteDistance&&!this.parent&&t){const c=t.getWorldMatrix(),h=new v(c.m[12],c.m[13],c.m[14]);a=We._TmpTranslation,a.copyFromFloats(this._position.x+h.x,this._position.y+h.y,this._position.z+h.z)}if(o.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant),this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,l=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(Z.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(l=We._TmpRotation,Z.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),this._usePivotMatrix){const c=L.Matrix[1];F.ScalingToRef(o.x,o.y,o.z,c);const h=L.Matrix[0];l.toRotationMatrix(h),this._pivotMatrix.multiplyToRef(c,L.Matrix[4]),L.Matrix[4].multiplyToRef(h,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(a.x,a.y,a.z)}else F.ComposeToRef(o,l,a,this._localMatrix);if(n&&n.getWorldMatrix){if(e&&n.computeWorldMatrix(e),s.useBillboardPath){this._transformToBoneReferal?n.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),L.Matrix[7]):L.Matrix[7].copyFrom(n.getWorldMatrix());const c=L.Vector3[5],h=L.Vector3[6],u=L.Quaternion[0];L.Matrix[7].decompose(h,u,c),F.ScalingToRef(h.x,h.y,h.z,L.Matrix[7]),L.Matrix[7].setTranslation(c),We.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(u,c),this._localMatrix.setTranslation(c)),this._localMatrix.multiplyToRef(L.Matrix[7],this._worldMatrix)}else this._transformToBoneReferal?(this._localMatrix.multiplyToRef(n.getWorldMatrix(),L.Matrix[6]),L.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localMatrix.multiplyToRef(n.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(s.useBillboardPath&&t&&this.billboardMode&&!s.useBillboardPosition){if(this._worldMatrix.getTranslationToRef(L.Vector3[0]),L.Matrix[1].copyFrom(t.getViewMatrix()),L.Matrix[1].setTranslationFromFloats(0,0,0),L.Matrix[1].invertToRef(L.Matrix[0]),(this.billboardMode&We.BILLBOARDMODE_ALL)!==We.BILLBOARDMODE_ALL){L.Matrix[0].decompose(void 0,L.Quaternion[0],void 0);const h=L.Vector3[1];L.Quaternion[0].toEulerAnglesToRef(h),(this.billboardMode&We.BILLBOARDMODE_X)!==We.BILLBOARDMODE_X&&(h.x=0),(this.billboardMode&We.BILLBOARDMODE_Y)!==We.BILLBOARDMODE_Y&&(h.y=0),(this.billboardMode&We.BILLBOARDMODE_Z)!==We.BILLBOARDMODE_Z&&(h.z=0),F.RotationYawPitchRollToRef(h.y,h.x,h.z,L.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(L.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(L.Vector3[0])}else if(s.useBillboardPath&&t&&s.useBillboardPosition){this._worldMatrix.getTranslationToRef(L.Vector3[0]);const h=t.globalPosition;this._worldMatrix.invertToRef(L.Matrix[1]);const u=L.Vector3[1];v.TransformCoordinatesToRef(h,L.Matrix[1],u),u.normalize();const d=-Math.atan2(u.z,u.x)+Math.PI/2,f=Math.sqrt(u.x*u.x+u.z*u.z),p=-Math.atan2(u.y,f);if(Z.RotationYawPitchRollToRef(d,p,0,L.Quaternion[0]),(this.billboardMode&We.BILLBOARDMODE_ALL)!==We.BILLBOARDMODE_ALL){const _=L.Vector3[1];L.Quaternion[0].toEulerAnglesToRef(_),(this.billboardMode&We.BILLBOARDMODE_X)!==We.BILLBOARDMODE_X&&(_.x=0),(this.billboardMode&We.BILLBOARDMODE_Y)!==We.BILLBOARDMODE_Y&&(_.y=0),(this.billboardMode&We.BILLBOARDMODE_Z)!==We.BILLBOARDMODE_Z&&(_.z=0),F.RotationYawPitchRollToRef(_.y,_.x,_.z,L.Matrix[0])}else F.FromQuaternionToRef(L.Quaternion[0],L.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(L.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(L.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):this._updateNonUniformScalingState(!(!n||!n._nonUniformScaling)&&n._nonUniformScaling),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=F.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){const t=this.getChildren();for(let i=0;i<t.length;++i){const s=t[i];if(s){s.computeWorldMatrix();const n=L.Matrix[0];s._localMatrix.multiplyToRef(this._localMatrix,n);const o=L.Quaternion[0];n.decompose(s.scaling,o,s.position),s.rotationQuaternion?s.rotationQuaternion.copyFrom(o):o.toEulerAnglesToRef(s.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=Z.Identity()),this._worldMatrix=F.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),v.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){const s=Ce.Clone(()=>new We(e,this.getScene()),this);if(s.name=e,s.id=e,t&&(s.parent=t),!i){const n=this.getDescendants(!0);for(let o=0;o<n.length;o++){const a=n[o];a.clone&&a.clone(e+"."+a.name,s)}}return s}serialize(e){const t=Ce.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),t}static Parse(e,t,i){const s=Ce.Parse(()=>new We(e.name,t),e,t,i);return e.localMatrix?s.setPreTransformMatrix(F.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(F.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s._waitingParsedUniqueId=e.uniqueId,void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),s}getChildTransformNodes(e,t){const i=[];return this._getDescendants(i,e,s=>(!t||t(s))&&s instanceof We),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){const i=this._parentContainer.transformNodes.indexOf(this);i>-1&&this._parentContainer.transformNodes.splice(i,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){const i=this.getChildTransformNodes(!0);for(const s of i)s.parent=null,s.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let s=null,n=null;t&&(this.rotationQuaternion?(n=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(s=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const o=this.getHierarchyBoundingVectors(e,i),a=o.max.subtract(o.min),l=Math.max(a.x,a.y,a.z);return 0===l||(this.scaling.scaleInPlace(1/l),t&&(this.rotationQuaternion&&n?this.rotationQuaternion.copyFrom(n):this.rotation&&s&&this.rotation.copyFrom(s))),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}}We.BILLBOARDMODE_NONE=0,We.BILLBOARDMODE_X=1,We.BILLBOARDMODE_Y=2,We.BILLBOARDMODE_Z=4,We.BILLBOARDMODE_ALL=7,We.BILLBOARDMODE_USE_POSITION=128,We.BillboardUseParentOrientation=!1,We._TmpRotation=Z.Zero(),We._TmpScaling=v.Zero(),We._TmpTranslation=v.Zero(),We._LookAtVectorCache=new v(0,0,0),We._RotationAxisCache=new Z,E([Ws("position")],We.prototype,"_position",void 0),E([Ws("rotation")],We.prototype,"_rotation",void 0),E([function cie(r){return Bn(10,r)}("rotationQuaternion")],We.prototype,"_rotationQuaternion",void 0),E([Ws("scaling")],We.prototype,"_scaling",void 0),E([I("billboardMode")],We.prototype,"_billboardMode",void 0),E([I()],We.prototype,"scalingDeterminant",void 0),E([I("infiniteDistance")],We.prototype,"_infiniteDistance",void 0),E([I()],We.prototype,"ignoreNonUniformScaling",void 0),E([I()],We.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);class rse{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new v(0,0,0),this._diffPositionForCollisions=new v(0,0,0),this._collisionResponse=!0}}class nse{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=v.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}}class ose{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new nse,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new rse,this._enableDistantPicking=!1}}let Zt=(()=>{class r extends We{static get BILLBOARDMODE_NONE(){return We.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return We.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return We.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return We.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return We.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return We.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(t){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=t}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(t){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=t}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(t){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=t}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(t){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=t}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(t){this._internalAbstractMeshDataInfo._collisionRetryCount=t}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(t){this._internalAbstractMeshDataInfo._morphTargetManager!==t&&(this._internalAbstractMeshDataInfo._morphTargetManager=t,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(t){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==t&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=t,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(t){return!!super._updateNonUniformScalingState(t)&&(this._markSubMeshesAsMiscDirty(),!0)}set onCollide(t){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(t)}set onCollisionPositionChange(t){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(t)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(t){if(this._internalAbstractMeshDataInfo._visibility===t)return;const i=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=t,(1===i&&1!==t||1!==i&&1===t)&&this._markSubMeshesAsMiscDirty()}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(t){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=t}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(t){this._internalAbstractMeshDataInfo._renderingGroupId=t}get material(){return this._internalAbstractMeshDataInfo._material}set material(t){this._internalAbstractMeshDataInfo._material!==t&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=t,t&&t.meshMap&&(t.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}getMaterialForRenderPass(t){var i;return null===(i=this._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===i?void 0:i[t]}setMaterialForRenderPass(t,i){this.resetDrawCache(t),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[t]=i}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(t){this._internalAbstractMeshDataInfo._receiveShadows!==t&&(this._internalAbstractMeshDataInfo._receiveShadows=t,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(t){this._internalAbstractMeshDataInfo._hasVertexAlpha!==t&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=t,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(t){this._internalAbstractMeshDataInfo._useVertexColors!==t&&(this._internalAbstractMeshDataInfo._useVertexColors=t,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(t){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==t&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=t,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(t){this._internalAbstractMeshDataInfo._numBoneInfluencers!==t&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=t,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(t){this._internalAbstractMeshDataInfo._applyFog!==t&&(this._internalAbstractMeshDataInfo._applyFog=t,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(t){this._internalAbstractMeshDataInfo._enableDistantPicking=t}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(t){t!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=t,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(t)?-1:t}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=t}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(t)?-1:t}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(t){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=t}get lightSources(){return this._lightSources}get _positions(){return null}set skeleton(t){const i=this._internalAbstractMeshDataInfo._skeleton;i&&i.needInitialSkinMatrix&&i._unregisterMeshWithPoseMatrix(this),t&&t.needInitialSkinMatrix&&t._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=t,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(t,i=null){switch(super(t,i,!1),this._internalAbstractMeshDataInfo=new ose,this._waitingMaterialId=null,this.cullingStrategy=r.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new z,this.onCollisionPositionChangeObservable=new z,this.onMaterialChangedObservable=new z,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=re.Red(),this.outlineWidth=.02,this.overlayColor=re.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new v(.5,1,.5),this.ellipsoidOffset=new v(0,0,0),this.edgesWidth=1,this.edgesColor=new Te(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new z,this._onCollisionPositionChange=(s,n,o=null)=>{n.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>ee.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),o&&this.onCollideObservable.notifyObservers(o),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},(i=this.getScene()).addMesh(this),this._resyncLightSources(),this._uniformBuffer=new Se(this.getScene().getEngine(),void 0,void 0,t,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),i.performancePriority){case Lo.Aggressive:this.doNotSyncBoundingInfo=!0;case Lo.Intermediate:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(t){const i=this._uniformBuffer;i.updateMatrix("world",t),i.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),i.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(t){let i="Name: "+this.name+", isInstance: "+("InstancedMesh"!==this.getClassName()?"YES":"NO");i+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const s=this._internalAbstractMeshDataInfo._skeleton;return s&&(i+=", skeleton: "+s.name),t&&(i+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],i+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),i}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==We.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(t,i=!0){if(this.actionManager&&(i||this.actionManager.isRecursive)){if(!t)return this.actionManager;if(this.actionManager.hasSpecificTrigger(t))return this.actionManager}return this.parent?this.parent._getActionManagerForTrigger(t,!1):null}_rebuild(t=!1){if(this.onRebuildObservable.notifyObservers(this),null!==this._occlusionQuery&&(this._occlusionQuery=null),this.subMeshes)for(const i of this.subMeshes)i._rebuild()}_resyncLightSources(){this._lightSources.length=0;for(const t of this.getScene().lights)!t.isEnabled()||t.canAffectMesh(this)&&this._lightSources.push(t);this._markSubMeshesAsLightDirty()}_resyncLightSource(t){const i=t.isEnabled()&&t.canAffectMesh(this),s=this._lightSources.indexOf(t);let n=!1;if(-1===s){if(!i)return;this._lightSources.push(t)}else{if(i)return;n=!0,this._lightSources.splice(s,1)}this._markSubMeshesAsLightDirty(n)}_unBindEffect(){for(const t of this.subMeshes)t.setEffect(null)}_removeLightSource(t,i){const s=this._lightSources.indexOf(t);-1!==s&&(this._lightSources.splice(s,1),this._markSubMeshesAsLightDirty(i))}_markSubMeshesAsDirty(t){if(this.subMeshes)for(const i of this.subMeshes)for(let s=0;s<i._drawWrappers.length;++s){const n=i._drawWrappers[s];!n||!n.defines||!n.defines.markAllAsDirty||t(n.defines)}}_markSubMeshesAsLightDirty(t=!1){this._markSubMeshesAsDirty(i=>i.markAsLightDirty(t))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(t=>t.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(t=>t.markAsMiscDirty())}markAsDirty(t){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}resetDrawCache(t){if(this.subMeshes)for(const i of this.subMeshes)i.resetDrawCache(t)}get isBlocked(){return!1}getLOD(t){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(t){return null}setVerticesData(t,i,s,n){return this}updateVerticesData(t,i,s,n){return this}setIndices(t,i){return this}isVerticesDataPresent(t){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}setBoundingInfo(t){return this._boundingInfo=t,this}get hasBoundingInfo(){return null!==this._boundingInfo}buildBoundingInfo(t,i,s){return this._boundingInfo=new pn(t,i,s),this._boundingInfo}normalizeToUnitCube(t=!0,i=!1,s){return super.normalizeToUnitCube(t,i,s)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(A.MatricesIndicesKind)&&this.isVerticesDataPresent(A.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(t){}_activate(t,i){return this._renderId=t,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===We.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(t,i,s){return this.position.addInPlace(this.calcMovePOV(t,i,s)),this}calcMovePOV(t,i,s){const n=new F;(this.rotationQuaternion?this.rotationQuaternion:Z.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(n);const a=v.Zero(),l=this.definedFacingForward?-1:1;return v.TransformCoordinatesFromFloatsToRef(t*l,i,s*l,n,a),a}rotatePOV(t,i,s){return this.rotation.addInPlace(this.calcRotatePOV(t,i,s)),this}calcRotatePOV(t,i,s){const n=this.definedFacingForward?1:-1;return new v(t*n,i,s*n)}refreshBoundingInfo(t=!1,i=!1){return this._boundingInfo&&this._boundingInfo.isLocked||this._refreshBoundingInfo(this._getPositionData(t,i),null),this}_refreshBoundingInfo(t,i){if(t){const s=x1(t,0,this.getTotalVertices(),i);this._boundingInfo?this._boundingInfo.reConstruct(s.minimum,s.maximum):this._boundingInfo=new pn(s.minimum,s.maximum)}if(this.subMeshes)for(let s=0;s<this.subMeshes.length;s++)this.subMeshes[s].refreshBoundingInfo(t);this._updateBoundingInfo()}_getData(t=!1,i=!1,s,n=A.PositionKind){if((s=s??this.getVerticesData(n).slice())&&i&&this.morphTargetManager){let o=0,a=0;for(let l=0;l<s.length;l++){for(let c=0;c<this.morphTargetManager.numTargets;c++){const h=this.morphTargetManager.getTarget(c),u=h.influence;if(u>0){const d=h.getPositions();d&&(s[l]+=(d[l]-s[l])*u)}}if(o++,n===A.PositionKind&&this._positions&&3===o){o=0;const c=3*a;this._positions[a++].copyFromFloats(s[c],s[c+1],s[c+2])}}}if(s&&t&&this.skeleton){const o=this.getVerticesData(A.MatricesIndicesKind),a=this.getVerticesData(A.MatricesWeightsKind);if(a&&o){const l=this.numBoneInfluencers>4,c=l?this.getVerticesData(A.MatricesIndicesExtraKind):null,h=l?this.getVerticesData(A.MatricesWeightsExtraKind):null,u=this.skeleton.getTransformMatrices(this),d=L.Vector3[0],f=L.Matrix[0],p=L.Matrix[1];let _=0;for(let m=0;m<s.length;m+=3,_+=4){let g,b;for(f.reset(),g=0;g<4;g++)b=a[_+g],b>0&&(F.FromFloat32ArrayToRefScaled(u,Math.floor(16*o[_+g]),b,p),f.addToSelf(p));if(l)for(g=0;g<4;g++)b=h[_+g],b>0&&(F.FromFloat32ArrayToRefScaled(u,Math.floor(16*c[_+g]),b,p),f.addToSelf(p));n===A.NormalKind?v.TransformNormalFromFloatsToRef(s[m],s[m+1],s[m+2],f,d):v.TransformCoordinatesFromFloatsToRef(s[m],s[m+1],s[m+2],f,d),d.toArray(s,m),n===A.PositionKind&&this._positions&&this._positions[m/3].copyFrom(d)}}}return s}getNormalsData(t=!1,i=!1){return this._getData(t,i,null,A.NormalKind)}getPositionData(t=!1,i=!1,s){return this._getData(t,i,s,A.PositionKind)}_getPositionData(t,i){var s;let n=this.getVerticesData(A.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),n&&(t&&this.skeleton||i&&this.morphTargetManager)){if(n=n.slice(),this._generatePointsArray(),this._positions){const o=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(o.length);for(let a=0;a<o.length;a++)this._internalAbstractMeshDataInfo._positions[a]=(null===(s=o[a])||void 0===s?void 0:s.clone())||new v}return this.getPositionData(t,i,n)}return n}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new pn(v.Zero(),v.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(t){if(!this.subMeshes)return this;const i=this.subMeshes.length;for(let s=0;s<i;s++){const n=this.subMeshes[s];(i>1||!n.IsGlobal)&&n.updateBoundingInfo(t)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(t){return this.getBoundingInfo().isInFrustum(t,this.cullingStrategy)}isCompletelyInFrustum(t){return this.getBoundingInfo().isCompletelyInFrustum(t)}intersectsMesh(t,i=!1,s){const n=this.getBoundingInfo(),o=t.getBoundingInfo();if(n.intersects(o,i))return!0;if(s)for(const a of this.getChildMeshes())if(a.intersectsMesh(t,i,!0))return!0;return!1}intersectsPoint(t){return this.getBoundingInfo().intersectsPoint(t)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(t){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=t}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(t){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);const s=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=s.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,s.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,t,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(t,i,s){var n;if(this._generatePointsArray(),!this._positions)return this;if(!t._lastColliderWorldVertices||!t._lastColliderTransformMatrix.equals(i)){t._lastColliderTransformMatrix=i.clone(),t._lastColliderWorldVertices=[],t._trianglePlanes=[];const a=t.verticesStart+t.verticesCount;for(let l=t.verticesStart;l<a;l++)t._lastColliderWorldVertices.push(v.TransformCoordinates(this._positions[l],i))}return s._collide(t._trianglePlanes,t._lastColliderWorldVertices,this.getIndices(),t.indexStart,t.indexStart+t.indexCount,t.verticesStart,!!t.getMaterial(),this,this._shouldConvertRHS(),7===(null===(n=t.getMaterial())||void 0===n?void 0:n.fillMode)),this}_processCollisionsForSubMeshes(t,i){const s=this._scene.getCollidingSubMeshCandidates(this,t),n=s.length;for(let o=0;o<n;o++){const a=s.data[o];n>1&&!a._checkCollision(t)||this._collideForSubMesh(a,i,t)}return this}_shouldConvertRHS(){return!1}_checkCollision(t){if(!this.getBoundingInfo()._checkCollision(t))return this;const i=L.Matrix[0],s=L.Matrix[1];return F.ScalingToRef(1/t._radius.x,1/t._radius.y,1/t._radius.z,i),this.worldMatrixFromCache.multiplyToRef(i,s),this._processCollisionsForSubMeshes(t,s),this}_generatePointsArray(){return!1}intersects(t,i,s,n=!1,o,a=!1){const l=new Os,c="InstancedLinesMesh"===this.getClassName()||"LinesMesh"===this.getClassName()?this.intersectionThreshold:0,h=this.getBoundingInfo();if(!this.subMeshes||!(a||t.intersectsSphere(h.boundingSphere,c)&&t.intersectsBox(h.boundingBox,c)))return l;if(n)return l.hit=!a,l.pickedMesh=a?null:this,l.distance=a?0:v.Distance(t.origin,h.boundingSphere.center),l.subMeshId=0,l;if(!this._generatePointsArray())return l;let u=null;const d=this._scene.getIntersectingSubMeshCandidates(this,t),f=d.length;let p=!1;for(let _=0;_<f;_++){const g=d.data[_].getMaterial();if(g&&(7==g.fillMode||0==g.fillMode||1==g.fillMode||2==g.fillMode||4==g.fillMode)){p=!0;break}}if(!p)return l.hit=!0,l.pickedMesh=this,l.distance=v.Distance(t.origin,h.boundingSphere.center),l.subMeshId=-1,l;for(let _=0;_<f;_++){const m=d.data[_];if(f>1&&!m.canIntersects(t))continue;const g=m.intersects(t,this._positions,this.getIndices(),i,s);if(g&&(i||!u||g.distance<u.distance)&&(u=g,u.subMeshId=_,i))break}if(u){const _=o??this.getWorldMatrix(),m=L.Vector3[0],g=L.Vector3[1];v.TransformCoordinatesToRef(t.origin,_,m),t.direction.scaleToRef(u.distance,g);const y=v.TransformNormal(g,_).addInPlace(m);return l.hit=!0,l.distance=v.Distance(m,y),l.pickedPoint=y,l.pickedMesh=this,l.bu=u.bu||0,l.bv=u.bv||0,l.subMeshFaceId=u.faceId,l.faceId=u.faceId+d.data[u.subMeshId].indexStart/(-1!==this.getClassName().indexOf("LinesMesh")?2:3),l.subMeshId=u.subMeshId,l}return l}clone(t,i,s){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array;return this}dispose(t,i=!1){let s;for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),null!=this.actionManager&&(this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),s=0;s<this._intersectionsInProgress.length;s++){const a=this._intersectionsInProgress[s],l=a._intersectionsInProgress.indexOf(this);a._intersectionsInProgress.splice(l,1)}this._intersectionsInProgress.length=0,this.getScene().lights.forEach(a=>{let l=a.includedOnlyMeshes.indexOf(this);-1!==l&&a.includedOnlyMeshes.splice(l,1),l=a.excludedMeshes.indexOf(this),-1!==l&&a.excludedMeshes.splice(l,1);const c=a.getShadowGenerators();if(c){const h=c.values();for(let u=h.next();!0!==u.done;u=h.next()){const f=u.value.getShadowMap();f&&f.renderList&&(l=f.renderList.indexOf(this),-1!==l&&f.renderList.splice(l,1))}}}),("InstancedMesh"!==this.getClassName()||"InstancedLinesMesh"!==this.getClassName())&&this.releaseSubMeshes();const o=this.getScene().getEngine();if(null!==this._occlusionQuery&&(this.isOcclusionQueryInProgress=!1,o.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),o.wipeCaches(),this.getScene().removeMesh(this),this._parentContainer){const a=this._parentContainer.meshes.indexOf(this);a>-1&&this._parentContainer.meshes.splice(a,1),this._parentContainer=null}if(i&&this.material&&("MultiMaterial"===this.material.getClassName()?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!t)for(s=0;s<this.getScene().particleSystems.length;s++)this.getScene().particleSystems[s].emitter===this&&(this.getScene().particleSystems[s].dispose(),s--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(t,i)}addChild(t,i=!1){return t.setParent(this,i),this}removeChild(t,i=!1){return t.setParent(null,i),this}_initFacetData(){const t=this._internalAbstractMeshDataInfo._facetData;t.facetNormals||(t.facetNormals=new Array),t.facetPositions||(t.facetPositions=new Array),t.facetPartitioning||(t.facetPartitioning=new Array),t.facetNb=this.getIndices().length/3|0,t.partitioningSubdivisions=t.partitioningSubdivisions?t.partitioningSubdivisions:10,t.partitioningBBoxRatio=t.partitioningBBoxRatio?t.partitioningBBoxRatio:1.01;for(let i=0;i<t.facetNb;i++)t.facetNormals[i]=v.Zero(),t.facetPositions[i]=v.Zero();return t.facetDataEnabled=!0,this}updateFacetData(){const t=this._internalAbstractMeshDataInfo._facetData;t.facetDataEnabled||this._initFacetData();const i=this.getVerticesData(A.PositionKind),s=this.getIndices(),n=this.getVerticesData(A.NormalKind),o=this.getBoundingInfo();if(t.facetDepthSort&&!t.facetDepthSortEnabled){if(t.facetDepthSortEnabled=!0,s instanceof Uint16Array)t.depthSortedIndices=new Uint16Array(s);else if(s instanceof Uint32Array)t.depthSortedIndices=new Uint32Array(s);else{let l=!1;for(let c=0;c<s.length;c++)if(s[c]>65535){l=!0;break}t.depthSortedIndices=l?new Uint32Array(s):new Uint16Array(s)}if(t.facetDepthSortFunction=function(l,c){return c.sqDistance-l.sqDistance},!t.facetDepthSortFrom){const l=this.getScene().activeCamera;t.facetDepthSortFrom=l?l.position:v.Zero()}t.depthSortedFacets=[];for(let l=0;l<t.facetNb;l++)t.depthSortedFacets.push({ind:3*l,sqDistance:0});t.invertedMatrix=F.Identity(),t.facetDepthSortOrigin=v.Zero()}t.bbSize.x=o.maximum.x-o.minimum.x>ot?o.maximum.x-o.minimum.x:ot,t.bbSize.y=o.maximum.y-o.minimum.y>ot?o.maximum.y-o.minimum.y:ot,t.bbSize.z=o.maximum.z-o.minimum.z>ot?o.maximum.z-o.minimum.z:ot;let a=t.bbSize.x>t.bbSize.y?t.bbSize.x:t.bbSize.y;if(a=a>t.bbSize.z?a:t.bbSize.z,t.subDiv.max=t.partitioningSubdivisions,t.subDiv.X=Math.floor(t.subDiv.max*t.bbSize.x/a),t.subDiv.Y=Math.floor(t.subDiv.max*t.bbSize.y/a),t.subDiv.Z=Math.floor(t.subDiv.max*t.bbSize.z/a),t.subDiv.X=t.subDiv.X<1?1:t.subDiv.X,t.subDiv.Y=t.subDiv.Y<1?1:t.subDiv.Y,t.subDiv.Z=t.subDiv.Z<1?1:t.subDiv.Z,t.facetParameters.facetNormals=this.getFacetLocalNormals(),t.facetParameters.facetPositions=this.getFacetLocalPositions(),t.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),t.facetParameters.bInfo=o,t.facetParameters.bbSize=t.bbSize,t.facetParameters.subDiv=t.subDiv,t.facetParameters.ratio=this.partitioningBBoxRatio,t.facetParameters.depthSort=t.facetDepthSort,t.facetDepthSort&&t.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(t.invertedMatrix),v.TransformCoordinatesToRef(t.facetDepthSortFrom,t.invertedMatrix,t.facetDepthSortOrigin),t.facetParameters.distanceTo=t.facetDepthSortOrigin),t.facetParameters.depthSortedFacets=t.depthSortedFacets,n&&ue.ComputeNormals(i,s,n,t.facetParameters),t.facetDepthSort&&t.facetDepthSortEnabled){t.depthSortedFacets.sort(t.facetDepthSortFunction);const l=t.depthSortedIndices.length/3|0;for(let c=0;c<l;c++){const h=t.depthSortedFacets[c].ind;t.depthSortedIndices[3*c]=s[h],t.depthSortedIndices[3*c+1]=s[h+1],t.depthSortedIndices[3*c+2]=s[h+2]}this.updateIndices(t.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){const t=this._internalAbstractMeshDataInfo._facetData;return t.facetNormals||this.updateFacetData(),t.facetNormals}getFacetLocalPositions(){const t=this._internalAbstractMeshDataInfo._facetData;return t.facetPositions||this.updateFacetData(),t.facetPositions}getFacetLocalPartitioning(){const t=this._internalAbstractMeshDataInfo._facetData;return t.facetPartitioning||this.updateFacetData(),t.facetPartitioning}getFacetPosition(t){const i=v.Zero();return this.getFacetPositionToRef(t,i),i}getFacetPositionToRef(t,i){const s=this.getFacetLocalPositions()[t],n=this.getWorldMatrix();return v.TransformCoordinatesToRef(s,n,i),this}getFacetNormal(t){const i=v.Zero();return this.getFacetNormalToRef(t,i),i}getFacetNormalToRef(t,i){const s=this.getFacetLocalNormals()[t];return v.TransformNormalToRef(s,this.getWorldMatrix(),i),this}getFacetsAtLocalCoordinates(t,i,s){const n=this.getBoundingInfo(),o=this._internalAbstractMeshDataInfo._facetData,a=Math.floor((t-n.minimum.x*o.partitioningBBoxRatio)*o.subDiv.X*o.partitioningBBoxRatio/o.bbSize.x),l=Math.floor((i-n.minimum.y*o.partitioningBBoxRatio)*o.subDiv.Y*o.partitioningBBoxRatio/o.bbSize.y),c=Math.floor((s-n.minimum.z*o.partitioningBBoxRatio)*o.subDiv.Z*o.partitioningBBoxRatio/o.bbSize.z);return a<0||a>o.subDiv.max||l<0||l>o.subDiv.max||c<0||c>o.subDiv.max?null:o.facetPartitioning[a+o.subDiv.max*l+o.subDiv.max*o.subDiv.max*c]}getClosestFacetAtCoordinates(t,i,s,n,o=!1,a=!0){const l=this.getWorldMatrix(),c=L.Matrix[5];l.invertToRef(c);const h=L.Vector3[8];v.TransformCoordinatesFromFloatsToRef(t,i,s,c,h);const u=this.getClosestFacetAtLocalCoordinates(h.x,h.y,h.z,n,o,a);return n&&v.TransformCoordinatesFromFloatsToRef(n.x,n.y,n.z,l,n),u}getClosestFacetAtLocalCoordinates(t,i,s,n,o=!1,a=!0){let l=null,c=0,h=0,u=0,d=0,f=0,p=0,_=0,m=0;const g=this.getFacetLocalPositions(),b=this.getFacetLocalNormals(),y=this.getFacetsAtLocalCoordinates(t,i,s);if(!y)return null;let S,C,D,T=Number.MAX_VALUE,x=T;for(let P=0;P<y.length;P++)S=y[P],C=b[S],D=g[S],d=(t-D.x)*C.x+(i-D.y)*C.y+(s-D.z)*C.z,(!o||o&&a&&d>=0||o&&!a&&d<=0)&&(d=C.x*D.x+C.y*D.y+C.z*D.z,f=-(C.x*t+C.y*i+C.z*s-d)/(C.x*C.x+C.y*C.y+C.z*C.z),p=t+C.x*f,_=i+C.y*f,m=s+C.z*f,c=p-t,h=_-i,u=m-s,x=c*c+h*h+u*u,x<T&&(T=x,l=S,n&&(n.x=p,n.y=_,n.z=m)));return l}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){const t=this._internalAbstractMeshDataInfo._facetData;return t.facetDataEnabled&&(t.facetDataEnabled=!1,t.facetPositions=new Array,t.facetNormals=new Array,t.facetPartitioning=new Array,t.facetParameters=null,t.depthSortedIndices=new Uint32Array(0)),this}updateIndices(t,i,s=!1){return this}createNormals(t){const i=this.getVerticesData(A.PositionKind),s=this.getIndices();let n;return n=this.isVerticesDataPresent(A.NormalKind)?this.getVerticesData(A.NormalKind):[],ue.ComputeNormals(i,s,n,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(A.NormalKind,n,t),this}alignWithNormal(t,i){i||(i=fs.Y);const s=L.Vector3[0],n=L.Vector3[1];return v.CrossToRef(i,t,n),v.CrossToRef(t,n,s),this.rotationQuaternion?Z.RotationQuaternionFromAxisToRef(s,t,n,this.rotationQuaternion):v.RotationFromAxisToRef(s,t,n,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw Ge("EdgesRenderer")}enableEdgesRendering(t,i,s){throw Ge("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(t=>t.emitter===this)}}return r.OCCLUSION_TYPE_NONE=0,r.OCCLUSION_TYPE_OPTIMISTIC=1,r.OCCLUSION_TYPE_STRICT=2,r.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,r.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,r.CULLINGSTRATEGY_STANDARD=0,r.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,r.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,r.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,r})();function Uo(r){-1===r.indexOf("vClipPlane")&&r.push("vClipPlane"),-1===r.indexOf("vClipPlane2")&&r.push("vClipPlane2"),-1===r.indexOf("vClipPlane3")&&r.push("vClipPlane3"),-1===r.indexOf("vClipPlane4")&&r.push("vClipPlane4"),-1===r.indexOf("vClipPlane5")&&r.push("vClipPlane5"),-1===r.indexOf("vClipPlane6")&&r.push("vClipPlane6")}function Za(r,e,t){var i,s,n,o,a,l;let c=!1,h=null!==(i=r.clipPlane)&&void 0!==i?i:e.clipPlane;return c=Hu(h,t,"CLIPPLANE","#define CLIPPLANE")||c,h=null!==(s=r.clipPlane2)&&void 0!==s?s:e.clipPlane2,c=Hu(h,t,"CLIPPLANE2","#define CLIPPLANE2")||c,h=null!==(n=r.clipPlane3)&&void 0!==n?n:e.clipPlane3,c=Hu(h,t,"CLIPPLANE3","#define CLIPPLANE3")||c,h=null!==(o=r.clipPlane4)&&void 0!==o?o:e.clipPlane4,c=Hu(h,t,"CLIPPLANE4","#define CLIPPLANE4")||c,h=null!==(a=r.clipPlane5)&&void 0!==a?a:e.clipPlane5,c=Hu(h,t,"CLIPPLANE5","#define CLIPPLANE5")||c,h=null!==(l=r.clipPlane6)&&void 0!==l?l:e.clipPlane6,c=Hu(h,t,"CLIPPLANE6","#define CLIPPLANE6")||c,c}function fo(r,e,t){var i,s,n,o,a,l;let c=null!==(i=e.clipPlane)&&void 0!==i?i:t.clipPlane;zu(r,"vClipPlane",c),c=null!==(s=e.clipPlane2)&&void 0!==s?s:t.clipPlane2,zu(r,"vClipPlane2",c),c=null!==(n=e.clipPlane3)&&void 0!==n?n:t.clipPlane3,zu(r,"vClipPlane3",c),c=null!==(o=e.clipPlane4)&&void 0!==o?o:t.clipPlane4,zu(r,"vClipPlane4",c),c=null!==(a=e.clipPlane5)&&void 0!==a?a:t.clipPlane5,zu(r,"vClipPlane5",c),c=null!==(l=e.clipPlane6)&&void 0!==l?l:t.clipPlane6,zu(r,"vClipPlane6",c)}function zu(r,e,t){t&&r.setFloat4(e,t.normal.x,t.normal.y,t.normal.z,t.d)}function Hu(r,e,t,i){const s=!!r;let n;if(Array.isArray(e)){const a=e.indexOf(i);n=-1!==a,!n&&r?e.push(i):n&&!r&&e.splice(a,1)}else n=e[t],e[t]=s;return n!==s}le("BABYLON.AbstractMesh",Zt);class ce{static BindSceneUniformBuffer(e,t){t.bindToEffect(e,"Scene")}static PrepareDefinesForMergedUV(e,t,i){t._needUVs=!0,t[i]=!0,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(t[i+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[i+"DIRECTUV"]=0}static BindTextureMatrix(e,t,i){const s=e.getTextureMatrix();t.updateMatrix(i+"Matrix",s)}static GetFogState(e,t){return t.fogEnabled&&e.applyFog&&t.fogMode!==ge.FOGMODE_NONE}static PrepareDefinesForMisc(e,t,i,s,n,o,a){a._areMiscDirty&&(a.LOGARITHMICDEPTH=i,a.POINTSIZE=s,a.FOG=n&&this.GetFogState(e,t),a.NONUNIFORMSCALING=e.nonUniformScaling,a.ALPHATEST=o)}static PrepareDefinesForCamera(e,t){let i=!1;if(e.activeCamera){const n=t.CAMERA_PERSPECTIVE?1:0,o=e.activeCamera.mode===ve.ORTHOGRAPHIC_CAMERA?1:0,a=e.activeCamera.mode===ve.PERSPECTIVE_CAMERA?1:0;((t.CAMERA_ORTHOGRAPHIC?1:0)^o||n^a)&&(t.CAMERA_ORTHOGRAPHIC=1===o,t.CAMERA_PERSPECTIVE=1===a,i=!0)}return i}static PrepareDefinesForFrameBoundValues(e,t,i,s,n,o=null,a=!1){let l=ce.PrepareDefinesForCamera(e,s);!1!==o&&(l=Za(i,e,s)),s.DEPTHPREPASS!==!t.getColorWrite()&&(s.DEPTHPREPASS=!s.DEPTHPREPASS,l=!0),s.INSTANCES!==n&&(s.INSTANCES=n,l=!0),s.THIN_INSTANCES!==a&&(s.THIN_INSTANCES=a,l=!0),l&&s.markAsUnprocessed()}static PrepareDefinesForBones(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;const i=void 0!==t.BONETEXTURE;if(e.skeleton.isUsingTextureForMatrices&&i)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=!i&&void 0;const s=e.getScene().prePassRenderer;if(s&&s.enabled){const n=-1===s.excludedSkinnedMesh.indexOf(e);t.BONES_VELOCITY_ENABLED=n}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,void 0!==t.BONETEXTURE&&(t.BONETEXTURE=!1)}static PrepareDefinesForMorphTargets(e,t){const i=e.morphTargetManager;i?(t.MORPHTARGETS_UV=i.supportsUVs&&t.UV1,t.MORPHTARGETS_TANGENT=i.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=i.supportsNormals&&t.NORMAL,t.MORPHTARGETS=i.numInfluencers>0,t.NUM_MORPH_INFLUENCERS=i.numInfluencers,t.MORPHTARGETS_TEXTURE=i.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)}static PrepareDefinesForBakedVertexAnimation(e,t){const i=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!(!i||!i.isEnabled)}static PrepareDefinesForAttributes(e,t,i,s,n=!1,o=!0,a=!0){if(!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(A.NormalKind),t._needNormals&&e.isVerticesDataPresent(A.TangentKind)&&(t.TANGENT=!0);for(let l=1;l<=6;++l)t["UV"+l]=!!t._needUVs&&e.isVerticesDataPresent(`uv${1===l?"":l}`);if(i){const l=e.useVertexColors&&e.isVerticesDataPresent(A.ColorKind);t.VERTEXCOLOR=l,t.VERTEXALPHA=e.hasVertexAlpha&&l&&o}return e.isVerticesDataPresent(A.ColorInstanceKind)&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),s&&this.PrepareDefinesForBones(e,t),n&&this.PrepareDefinesForMorphTargets(e,t),a&&this.PrepareDefinesForBakedVertexAnimation(e,t),!0}static PrepareDefinesForMultiview(e,t){if(e.activeCamera){const i=t.MULTIVIEW;t.MULTIVIEW=null!==e.activeCamera.outputRenderTarget&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=i&&t.markAsUnprocessed()}}static PrepareDefinesForOIT(e,t,i){const s=t.ORDER_INDEPENDENT_TRANSPARENCY,n=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&i,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,(s!==t.ORDER_INDEPENDENT_TRANSPARENCY||n!==t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&t.markAsUnprocessed()}static PrepareDefinesForPrePass(e,t,i){const s=t.PREPASS;if(!t._arePrePassDirty)return;const n=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&i){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount;for(let o=0;o<n.length;o++){const a=e.prePassRenderer.getIndex(n[o].type);-1!==a?(t[n[o].define]=!0,t[n[o].index]=a):t[n[o].define]=!1}}else{t.PREPASS=!1;for(let o=0;o<n.length;o++)t[n[o].define]=!1}t.PREPASS!=s&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}static PrepareDefinesForLight(e,t,i,s,n,o,a){var l;switch(a.needNormals=!0,void 0===n["LIGHT"+s]&&(a.needRebuild=!0),n["LIGHT"+s]=!0,n["SPOTLIGHT"+s]=!1,n["HEMILIGHT"+s]=!1,n["POINTLIGHT"+s]=!1,n["DIRLIGHT"+s]=!1,i.prepareLightSpecificDefines(n,s),n["LIGHT_FALLOFF_PHYSICAL"+s]=!1,n["LIGHT_FALLOFF_GLTF"+s]=!1,n["LIGHT_FALLOFF_STANDARD"+s]=!1,i.falloffType){case ds.FALLOFF_GLTF:n["LIGHT_FALLOFF_GLTF"+s]=!0;break;case ds.FALLOFF_PHYSICAL:n["LIGHT_FALLOFF_PHYSICAL"+s]=!0;break;case ds.FALLOFF_STANDARD:n["LIGHT_FALLOFF_STANDARD"+s]=!0}if(o&&!i.specular.equalsFloats(0,0,0)&&(a.specularEnabled=!0),n["SHADOW"+s]=!1,n["SHADOWCSM"+s]=!1,n["SHADOWCSMDEBUG"+s]=!1,n["SHADOWCSMNUM_CASCADES"+s]=!1,n["SHADOWCSMUSESHADOWMAXZ"+s]=!1,n["SHADOWCSMNOBLEND"+s]=!1,n["SHADOWCSM_RIGHTHANDED"+s]=!1,n["SHADOWPCF"+s]=!1,n["SHADOWPCSS"+s]=!1,n["SHADOWPOISSON"+s]=!1,n["SHADOWESM"+s]=!1,n["SHADOWCLOSEESM"+s]=!1,n["SHADOWCUBE"+s]=!1,n["SHADOWLOWQUALITY"+s]=!1,n["SHADOWMEDIUMQUALITY"+s]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&i.shadowEnabled){const c=null!==(l=i.getShadowGenerator(e.activeCamera))&&void 0!==l?l:i.getShadowGenerator();if(c){const h=c.getShadowMap();h&&h.renderList&&h.renderList.length>0&&(a.shadowEnabled=!0,c.prepareDefines(n,s))}}i.lightmapMode!=ds.LIGHTMAP_DEFAULT?(a.lightmapMode=!0,n["LIGHTMAPEXCLUDED"+s]=!0,n["LIGHTMAPNOSPECULAR"+s]=i.lightmapMode==ds.LIGHTMAP_SHADOWSONLY):(n["LIGHTMAPEXCLUDED"+s]=!1,n["LIGHTMAPNOSPECULAR"+s]=!1)}static PrepareDefinesForLights(e,t,i,s,n=4,o=!1){if(!i._areLightsDirty)return i._needNormals;let a=0;const l={needNormals:i._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!o)for(const h of t.lightSources)if(this.PrepareDefinesForLight(e,t,h,a,i,s,l),a++,a===n)break;i.SPECULARTERM=l.specularEnabled,i.SHADOWS=l.shadowEnabled;for(let h=a;h<n;h++)void 0!==i["LIGHT"+h]&&(i["LIGHT"+h]=!1,i["HEMILIGHT"+h]=!1,i["POINTLIGHT"+h]=!1,i["DIRLIGHT"+h]=!1,i["SPOTLIGHT"+h]=!1,i["SHADOW"+h]=!1,i["SHADOWCSM"+h]=!1,i["SHADOWCSMDEBUG"+h]=!1,i["SHADOWCSMNUM_CASCADES"+h]=!1,i["SHADOWCSMUSESHADOWMAXZ"+h]=!1,i["SHADOWCSMNOBLEND"+h]=!1,i["SHADOWCSM_RIGHTHANDED"+h]=!1,i["SHADOWPCF"+h]=!1,i["SHADOWPCSS"+h]=!1,i["SHADOWPOISSON"+h]=!1,i["SHADOWESM"+h]=!1,i["SHADOWCLOSEESM"+h]=!1,i["SHADOWCUBE"+h]=!1,i["SHADOWLOWQUALITY"+h]=!1,i["SHADOWMEDIUMQUALITY"+h]=!1);const c=e.getEngine().getCaps();return void 0===i.SHADOWFLOAT&&(l.needRebuild=!0),i.SHADOWFLOAT=l.shadowEnabled&&(c.textureFloatRender&&c.textureFloatLinearFiltering||c.textureHalfFloatRender&&c.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=l.lightmapMode,l.needRebuild&&i.rebuild(),l.needNormals}static PrepareUniformsAndSamplersForLight(e,t,i,s,n=null,o=!1){n&&n.push("Light"+e),!o&&(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),i.push("shadowSampler"+e),i.push("depthSampler"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),s&&(i.push("projectionLightSampler"+e),t.push("textureProjectionMatrix"+e)))}static PrepareUniformsAndSamplersList(e,t,i,s=4){let n,o=null;e.uniformsNames?(n=e.uniformsNames,o=e.uniformBuffersNames,t=e.samplers,i=e.defines,s=e.maxSimultaneousLights||0):(n=e,t||(t=[]));for(let a=0;a<s&&i["LIGHT"+a];a++)this.PrepareUniformsAndSamplersForLight(a,n,t,i["PROJECTEDLIGHTTEXTURE"+a],o);i.NUM_MORPH_INFLUENCERS&&n.push("morphTargetInfluences"),i.BAKED_VERTEX_ANIMATION_TEXTURE&&(n.push("bakedVertexAnimationSettings"),n.push("bakedVertexAnimationTextureSizeInverted"),n.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))}static HandleFallbacksForShadows(e,t,i=4,s=0){let n=0;for(let o=0;o<i&&e["LIGHT"+o];o++)o>0&&(n=s+o,t.addFallback(n,"LIGHT"+o)),e.SHADOWS||(e["SHADOW"+o]&&t.addFallback(s,"SHADOW"+o),e["SHADOWPCF"+o]&&t.addFallback(s,"SHADOWPCF"+o),e["SHADOWPCSS"+o]&&t.addFallback(s,"SHADOWPCSS"+o),e["SHADOWPOISSON"+o]&&t.addFallback(s,"SHADOWPOISSON"+o),e["SHADOWESM"+o]&&t.addFallback(s,"SHADOWESM"+o),e["SHADOWCLOSEESM"+o]&&t.addFallback(s,"SHADOWCLOSEESM"+o));return n++}static PrepareAttributesForMorphTargetsInfluencers(e,t,i){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=i,this.PrepareAttributesForMorphTargets(e,t,this._TmpMorphInfluencers)}static PrepareAttributesForMorphTargets(e,t,i){const s=i.NUM_MORPH_INFLUENCERS;if(s>0&&be.LastCreatedEngine){const n=be.LastCreatedEngine.getCaps().maxVertexAttribs,o=t.morphTargetManager;if(o?.isUsingTextureForTargets)return;const a=o&&o.supportsNormals&&i.NORMAL,l=o&&o.supportsTangents&&i.TANGENT,c=o&&o.supportsUVs&&i.UV1;for(let h=0;h<s;h++)e.push(A.PositionKind+h),a&&e.push(A.NormalKind+h),l&&e.push(A.TangentKind+h),c&&e.push(A.UVKind+"_"+h),e.length>n&&V.Error("Cannot add more vertex attributes for mesh "+t.name)}}static PrepareAttributesForBakedVertexAnimation(e,t,i){i.BAKED_VERTEX_ANIMATION_TEXTURE&&i.INSTANCES&&e.push("bakedVertexAnimationSettingsInstanced")}static PrepareAttributesForBones(e,t,i,s){i.NUM_BONE_INFLUENCERS>0&&(s.addCPUSkinningFallback(0,t),e.push(A.MatricesIndicesKind),e.push(A.MatricesWeightsKind),i.NUM_BONE_INFLUENCERS>4&&(e.push(A.MatricesIndicesExtraKind),e.push(A.MatricesWeightsExtraKind)))}static PrepareAttributesForInstances(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&this.PushAttributesForInstances(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push(A.ColorInstanceKind)}static PushAttributesForInstances(e,t=!1){e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))}static BindLightProperties(e,t,i){e.transferToEffect(t,i+"")}static BindLight(e,t,i,s,n,o=!0){e._bindLight(t,i,s,n,o)}static BindLights(e,t,i,s,n=4){const o=Math.min(t.lightSources.length,n);for(let a=0;a<o;a++)this.BindLight(t.lightSources[a],a,e,i,"boolean"==typeof s?s:s.SPECULARTERM,t.receiveShadows)}static BindFogParameters(e,t,i,s=!1){e.fogEnabled&&t.applyFog&&e.fogMode!==ge.FOGMODE_NONE&&(i.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),s?(e.fogColor.toLinearSpaceToRef(this._TempFogColor,e.getEngine().useExactSrgbConversions),i.setColor3("vFogColor",this._TempFogColor)):i.setColor3("vFogColor",e.fogColor))}static BindBonesParameters(e,t,i){if(t&&e&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){const s=e.skeleton;if(s.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){const n=s.getTransformMatrixTexture(e);t.setTexture("boneSampler",n),t.setFloat("boneTextureWidth",4*(s.bones.length+1))}else{const n=s.getTransformMatrices(e);n&&(t.setMatrices("mBones",n),i&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2)&&(i.previousBones[e.uniqueId]||(i.previousBones[e.uniqueId]=n.slice()),t.setMatrices("mPreviousBones",i.previousBones[e.uniqueId]),ce._CopyBonesTransformationMatrices(n,i.previousBones[e.uniqueId])))}}}static _CopyBonesTransformationMatrices(e,t){return t.set(e),t}static BindMorphTargetParameters(e,t){const i=e.morphTargetManager;!e||!i||t.setFloatArray("morphTargetInfluences",i.influences)}static BindLogDepth(e,t,i){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf("LOGARITHMICDEPTH")>=0){const s=i.activeCamera;s.mode===ve.ORTHOGRAPHIC_CAMERA&&V.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(s.maxZ+1)/Math.LN2))}}}ce._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0},ce._TempFogColor=re.Black();class Ja{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){Ce.Clone(()=>e,this)}serialize(){return Ce.Serialize(this)}parse(e,t,i){Ce.Parse(()=>this,e,t,i)}}E([I()],Ja.prototype,"func",null),E([I()],Ja.prototype,"funcRef",null),E([I()],Ja.prototype,"funcMask",null),E([I()],Ja.prototype,"opStencilFail",null),E([I()],Ja.prototype,"opDepthFail",null),E([I()],Ja.prototype,"opStencilDepthPass",null),E([I()],Ja.prototype,"mask",null),E([I()],Ja.prototype,"enabled",null);var Ns=(()=>{return(r=Ns||(Ns={}))[r.Created=1]="Created",r[r.Disposed=2]="Disposed",r[r.GetDefineNames=4]="GetDefineNames",r[r.PrepareUniformBuffer=8]="PrepareUniformBuffer",r[r.IsReadyForSubMesh=16]="IsReadyForSubMesh",r[r.PrepareDefines=32]="PrepareDefines",r[r.BindForSubMesh=64]="BindForSubMesh",r[r.PrepareEffect=128]="PrepareEffect",r[r.GetAnimatables=256]="GetAnimatables",r[r.GetActiveTextures=512]="GetActiveTextures",r[r.HasTexture=1024]="HasTexture",r[r.FillRenderTargetTextures=2048]="FillRenderTargetTextures",r[r.HasRenderTargetTextures=4096]="HasRenderTargetTextures",r[r.HardBindForSubMesh=8192]="HardBindForSubMesh",Ns;var r})();class ie{get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;const t=this._alpha;this._alpha=e,(1===t||1===e)&&this.markAsDirty(ie.MiscDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(ie.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(ie.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new z),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new z),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new z),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(ie.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(ie.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case ie.WireFrameFillMode:case ie.LineListDrawMode:case ie.LineLoopDrawMode:case ie.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?ie.WireFrameFillMode:ie.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case ie.PointFillMode:case ie.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?ie.PointFillMode:ie.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(ie.MiscDirtyFlag))}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}constructor(e,t,i){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new z,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new Ja,this._useUBO=!1,this._fillMode=ie.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=e;const s=t||be.LastCreatedScene;!s||(this._scene=s,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||q.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new $i(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this.sideOrientation=this._scene.useRightHandedSystem?ie.ClockWiseSideOrientation:ie.CounterClockWiseSideOrientation,this._uniformBuffer=new Se(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),ie.OnEventObservable.notifyObservers(this,Ns.Created))}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,i){const s=t.materialDefines;return!!s&&(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh)}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===ie.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _disableAlphaBlending(){return this._transparencyMode===ie.MATERIAL_OPAQUE||this._transparencyMode===ie.MATERIAL_ALPHATEST}needAlphaBlending(){return!this._disableAlphaBlending&&this.alpha<1}needAlphaBlendingForMesh(e){return e.visibility<1||!this._disableAlphaBlending&&(e.hasVertexAlpha||this.needAlphaBlending())}needAlphaTesting(){return!!this._forceAlphaTest}_shouldTurnAlphaTestOn(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=!1){const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const s of i.subMeshes)s.getMaterial()===this&&(!s.effect||(s.effect._wasPreviouslyReady=!1,s.effect._wasPreviouslyUsingInstances=null,s.effect._forceRebindOnNextCall=e));e&&this.markAsDirty(ie.AllDirtyFlag)}_preBind(e,t=null){const i=this._scene.getEngine(),n=(t??this.sideOrientation)===ie.ClockWiseSideOrientation;return i.enableEffect(e||this._getDrawWrapper()),i.setState(this.backFaceCulling,this.zOffset,!1,n,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),n}bind(e,t){}buildUniformLayout(){const e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(Ns.PrepareUniformBuffer,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,i){const s=i.effect;!s||(this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),s._forceRebindOnNextCall=!1)}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,ce.BindSceneUniformBuffer(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),this._scene._cachedVisibility=e?e.visibility:1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){const i=this._scene.getEngine();this._cachedDepthWriteState=i.getDepthWrite(),i.setDepthWrite(!1)}if(this.disableColorWrite){const i=this._scene.getEngine();this._cachedColorWriteState=i.getColorWrite(),i.setColorWrite(!1)}if(0!==this.depthFunction){const i=this._scene.getEngine();this._cachedDepthFunctionState=i.getDepthFunction()||0,i.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),0!==this.depthFunction&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(Ns.GetAnimatables,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(Ns.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(Ns.HasTexture,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}getBindedMeshes(){if(this.meshMap){const e=new Array;for(const t in this.meshMap){const i=this.meshMap[t];i&&e.push(i)}return e}return this._scene.meshes.filter(t=>t.material===this)}forceCompilation(e,t,i,s){const n={clipPlane:!1,useInstances:!1,...i},o=this.getScene(),a=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;const l=()=>{if(!this._scene||!this._scene.getEngine())return;const c=o.clipPlane;if(n.clipPlane&&(o.clipPlane=new Dr(0,0,0,1)),this._storeEffectOnSubMeshes){let h=!0,u=null;if(e.subMeshes){const d=new fr(0,0,0,0,0,e,void 0,!1,!1);d.materialDefines&&(d.materialDefines._renderId=-1),this.isReadyForSubMesh(e,d,n.useInstances)||(d.effect&&d.effect.getCompilationError()&&d.effect.allFallbacksProcessed()?u=d.effect.getCompilationError():(h=!1,setTimeout(l,16)))}h&&(this.allowShaderHotSwapping=a,u&&s&&s(u),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=a,t&&t(this)):setTimeout(l,16);n.clipPlane&&(o.clipPlane=c)};l()}forceCompilationAsync(e,t){return new Promise((i,s)=>{this.forceCompilation(e,()=>{i()},t,n=>{s(n)})})}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(ie._DirtyCallbackArray.length=0,e&ie.TextureDirtyFlag&&ie._DirtyCallbackArray.push(ie._TextureDirtyCallBack),e&ie.LightDirtyFlag&&ie._DirtyCallbackArray.push(ie._LightsDirtyCallBack),e&ie.FresnelDirtyFlag&&ie._DirtyCallbackArray.push(ie._FresnelDirtyCallBack),e&ie.AttributesDirtyFlag&&ie._DirtyCallbackArray.push(ie._AttributeDirtyCallBack),e&ie.MiscDirtyFlag&&ie._DirtyCallbackArray.push(ie._MiscDirtyCallBack),e&ie.PrePassDirtyFlag&&ie._DirtyCallbackArray.push(ie._PrePassDirtyCallBack),ie._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(ie._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){const e=this.getScene().meshes;for(const t of e)if(t.subMeshes)for(const i of t.subMeshes)i.getMaterial()===this&&i.resetDrawCache()}_markAllSubMeshesAsDirty(e){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const s of i.subMeshes)if(s.getMaterial(!1)===this)for(const n of s._drawWrappers)!n||!n.defines||!n.defines.markAllAsDirty||this._materialContext===n.materialContext&&e(n.defines)}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(ie._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(ie._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(ie._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(ie._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(ie._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(ie._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(ie._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(ie._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(ie._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(ie._TextureAndMiscDirtyCallBack)}_checkScenePerformancePriority(){if(this._scene.performancePriority!==Lo.BackwardCompatible){this.checkReadyOnlyOnce=!0;const e=this._scene.onScenePerformancePriorityChangedObservable.addOnce(()=>{this.checkReadyOnlyOnce=!1});this.onDisposeObservable.add(()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e)})}}setPrePassRenderer(e){return!1}dispose(e,t,i){const s=this.getScene();if(s.stopAnimation(this),s.freeProcessedMaterials(),s.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(Ns.Disposed,this._eventInfo),this._parentContainer){const n=this._parentContainer.materials.indexOf(this);n>-1&&this._parentContainer.materials.splice(n,1),this._parentContainer=null}if(!0!==i)if(this.meshMap)for(const n in this.meshMap){const o=this.meshMap[n];o&&(o.material=null,this.releaseVertexArrayObject(o,e))}else{const n=s.meshes;for(const o of n)o.material===this&&!o.sourceMesh&&(o.material=null,this.releaseVertexArrayObject(o,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}releaseVertexArrayObject(e,t){if(e.geometry){const i=e.geometry;if(this._storeEffectOnSubMeshes)for(const s of e.subMeshes)i._releaseVertexArrayObject(s.effect),t&&s.effect&&s.effect.dispose();else i._releaseVertexArrayObject(this._drawWrapper.effect)}}serialize(){const e=Ce.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,e}static Parse(e,t,i){if(e.customType){if("BABYLON.PBRMaterial"===e.customType&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return V.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null}else e.customType="BABYLON.StandardMaterial";const n=q.Instantiate(e.customType).Parse(e,t,i);return n._loadedUniqueId=e.uniqueId,n}}ie.TriangleFillMode=0,ie.WireFrameFillMode=1,ie.PointFillMode=2,ie.PointListDrawMode=3,ie.LineListDrawMode=4,ie.LineLoopDrawMode=5,ie.LineStripDrawMode=6,ie.TriangleStripDrawMode=7,ie.TriangleFanDrawMode=8,ie.ClockWiseSideOrientation=0,ie.CounterClockWiseSideOrientation=1,ie.TextureDirtyFlag=1,ie.LightDirtyFlag=2,ie.FresnelDirtyFlag=4,ie.AttributesDirtyFlag=8,ie.MiscDirtyFlag=16,ie.PrePassDirtyFlag=32,ie.AllDirtyFlag=63,ie.MATERIAL_OPAQUE=0,ie.MATERIAL_ALPHATEST=1,ie.MATERIAL_ALPHABLEND=2,ie.MATERIAL_ALPHATESTANDBLEND=3,ie.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0,ie.MATERIAL_NORMALBLENDMETHOD_RNM=1,ie.OnEventObservable=new z,be.OnEnginesDisposedObservable.addOnce(()=>{ie.OnEventObservable.clear()}),ie._AllDirtyCallBack=r=>r.markAllAsDirty(),ie._ImageProcessingDirtyCallBack=r=>r.markAsImageProcessingDirty(),ie._TextureDirtyCallBack=r=>r.markAsTexturesDirty(),ie._FresnelDirtyCallBack=r=>r.markAsFresnelDirty(),ie._MiscDirtyCallBack=r=>r.markAsMiscDirty(),ie._PrePassDirtyCallBack=r=>r.markAsPrePassDirty(),ie._LightsDirtyCallBack=r=>r.markAsLightDirty(),ie._AttributeDirtyCallBack=r=>r.markAsAttributesDirty(),ie._FresnelAndMiscDirtyCallBack=r=>{ie._FresnelDirtyCallBack(r),ie._MiscDirtyCallBack(r)},ie._TextureAndMiscDirtyCallBack=r=>{ie._TextureDirtyCallBack(r),ie._MiscDirtyCallBack(r)},ie._DirtyCallbackArray=[],ie._RunDirtyCallBacks=r=>{for(const e of ie._DirtyCallbackArray)e(r)},E([I()],ie.prototype,"id",void 0),E([I()],ie.prototype,"uniqueId",void 0),E([I()],ie.prototype,"name",void 0),E([I()],ie.prototype,"metadata",void 0),E([I()],ie.prototype,"checkReadyOnEveryCall",void 0),E([I()],ie.prototype,"checkReadyOnlyOnce",void 0),E([I()],ie.prototype,"state",void 0),E([I("alpha")],ie.prototype,"_alpha",void 0),E([I("backFaceCulling")],ie.prototype,"_backFaceCulling",void 0),E([I("cullBackFaces")],ie.prototype,"_cullBackFaces",void 0),E([I()],ie.prototype,"sideOrientation",void 0),E([I("alphaMode")],ie.prototype,"_alphaMode",void 0),E([I()],ie.prototype,"_needDepthPrePass",void 0),E([I()],ie.prototype,"disableDepthWrite",void 0),E([I()],ie.prototype,"disableColorWrite",void 0),E([I()],ie.prototype,"forceDepthWrite",void 0),E([I()],ie.prototype,"depthFunction",void 0),E([I()],ie.prototype,"separateCullingPass",void 0),E([I("fogEnabled")],ie.prototype,"_fogEnabled",void 0),E([I()],ie.prototype,"pointSize",void 0),E([I()],ie.prototype,"zOffset",void 0),E([I()],ie.prototype,"zOffsetUnits",void 0),E([I()],ie.prototype,"pointsCloud",null),E([I()],ie.prototype,"fillMode",null),E([I()],ie.prototype,"transparencyMode",null);class el extends ie{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().multiMaterials.push(this),this.subMaterials=new Array,this._storeEffectOnSubMeshes=!0}_hookArray(e){const t=e.push;e.push=(...s)=>{const n=t.apply(e,s);return this._markAllSubMeshesAsTexturesDirty(),n};const i=e.splice;e.splice=(s,n)=>{const o=i.apply(e,[s,n]);return this._markAllSubMeshesAsTexturesDirty(),o}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){var t;if(super.hasTexture(e))return!0;for(let i=0;i<this.subMaterials.length;i++)if(null!==(t=this.subMaterials[i])&&void 0!==t&&t.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,i){for(let s=0;s<this.subMaterials.length;s++){const n=this.subMaterials[s];if(n){if(n._storeEffectOnSubMeshes){if(!n.isReadyForSubMesh(e,t,i))return!1;continue}if(!n.isReady(e))return!1}}return!0}clone(e,t){const i=new el(e,this.getScene());for(let s=0;s<this.subMaterials.length;s++){let n=null;const o=this.subMaterials[s];n=t&&o?o.clone(e+"-"+o.name):this.subMaterials[s],i.subMaterials.push(n)}return i}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,Et&&(e.tags=Et.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){const i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,i){const s=this.getScene();if(!s)return;if(i)for(let o=0;o<this.subMaterials.length;o++){const a=this.subMaterials[o];a&&a.dispose(e,t)}const n=s.multiMaterials.indexOf(this);n>=0&&s.multiMaterials.splice(n,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){const i=new el(e.name,t);return i.id=e.id,i._loadedUniqueId=e.uniqueId,Et&&Et.AddTagsTo(i,e.tags),e.materialsUniqueIds?i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach(s=>i.subMaterials.push(t.getLastMaterialById(s))),i}}le("BABYLON.MultiMaterial",el);class ase{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}}class T1{}class lse{constructor(){this.visibleInstances={},this.batchCache=new S1,this.batchCacheReplacementModeInFrozenMode=new S1,this.instancesBufferSize=2048}}class S1{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array}}class cse{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=512,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class hse{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0}}class G extends Zt{static _GetDefaultSideOrientation(e){return e||G.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(A.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(A.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new z),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new z),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new z),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new z),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new z),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){var e;return(null!==(e=this._thinInstanceDataStorage.instancesCount)&&void 0!==e?e:0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}constructor(e,t=null,i=null,s=null,n,o=!0){if(super(e,t),this._internalMeshDataInfo=new hse,this.delayLoadState=0,this.instances=new Array,this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new lse,this._thinInstanceDataStorage=new cse,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=G.DEFAULTSIDE,this.overrideMaterialSideOrientation=null,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._onBeforeDraw=(a,l,c)=>{a&&c&&(this._uniformBuffer?this.transferToEffect(l):c.bindOnlyWorldMatrix(l))},s){if(s._geometry&&s._geometry.applyToMesh(this),Pr.DeepCopy(s,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo"],["_poseMatrix"]),this._internalMeshDataInfo._source=s,t.useClonedMeshMap&&(s._internalMeshDataInfo.meshMap||(s._internalMeshDataInfo.meshMap={}),s._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=s._originalBuilderSideOrientation,this._creationDataStorage=s._creationDataStorage,s._ranges){const a=s._ranges;for(const l in a)!Object.prototype.hasOwnProperty.call(a,l)||!a[l]||this.createAnimationRange(l,a[l].from,a[l].to)}if(this.metadata=s.metadata&&s.metadata.clone?s.metadata.clone():s.metadata,this._internalMetadata=s._internalMetadata,Et&&Et.HasTags(s)&&Et.AddTagsTo(this,Et.GetTags(s,!0)),this.setEnabled(s.isEnabled(!1)),this.parent=s.parent,this.setPivotMatrix(s.getPivotMatrix()),this.id=e+"."+s.id,this.material=s.material,!n){const a=s.getDescendants(!0);for(let l=0;l<a.length;l++){const c=a[l];c.clone&&c.clone(e+"."+c.name,this)}}if(s.morphTargetManager&&(this.morphTargetManager=s.morphTargetManager),t.getPhysicsEngine){const a=t.getPhysicsEngine();if(o&&a&&1===a.getPluginVersion()){const l=a.getImpostorForPhysicsObject(s);l&&(this.physicsImpostor=l.clone(this))}}for(let a=0;a<t.particleSystems.length;a++){const l=t.particleSystems[a];l.emitter===s&&l.clone(l.name,this)}this.skeleton=s.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}null!==i&&(this.parent=i),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=a=>{a.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new z(this._internalMeshDataInfo._onMeshReadyObserverAdded),s&&s.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,i){const s=0===this.getTotalVertices()||t&&t.doNotInstantiate&&(!0===t.doNotInstantiate||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));s.parent=e||this.parent,s.position=this.position.clone(),s.scaling=this.scaling.clone(),this.rotationQuaternion?s.rotationQuaternion=this.rotationQuaternion.clone():s.rotation=this.rotation.clone(),i&&i(this,s);for(const n of this.getChildTransformNodes(!0))"InstancedMesh"===n.getClassName()&&"Mesh"===s.getClassName()&&n.sourceMesh===this?n.instantiateHierarchy(s,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:s},i):n.instantiateHierarchy(s,t,i);return s}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){const i=this.getIndices(),s=this.getVerticesData(A.PositionKind);s&&i&&(t+=", flat shading: "+(s.length/3===i.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0)}addLODLevel(e,t){if(t&&t._masterMesh)return V.Warn("You cannot use a mesh as LOD level twice"),this;const i=new ase(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){const s=t._LODLevels[i];if(s.distanceOrScreenCoverage===e)return s.mesh}return null}removeLODLevel(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){const i=this._internalMeshDataInfo;if(!i._LODLevels||0===i._LODLevels.length)return this;const s=t||this.getBoundingInfo().boundingSphere,n=e.mode===ve.ORTHOGRAPHIC_CAMERA?e.minZ:s.centerWorld.subtract(e.globalPosition).length();let o=n,a=1;if(i._useLODScreenCoverage){let c=s.radiusWorld*e.minZ/n;c=c*c*Math.PI,o=c/e.screenArea,a=-1}if(a*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>a*o)return this.onLODLevelSelection&&this.onLODLevelSelection(o,this,this),this;for(let l=0;l<i._LODLevels.length;l++){const c=i._LODLevels[l];if(a*c.distanceOrScreenCoverage<a*o){if(c.mesh){if(4===c.mesh.delayLoadState)return c.mesh._checkDelayState(),this;if(2===c.mesh.delayLoadState)return this;c.mesh._preActivate(),c.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(o,this,c.mesh),c.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(o,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return null==this._geometry?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i){var s,n;if(!this._geometry)return null;let o=null===(n=null===(s=this._userInstancedBuffersStorage)||void 0===s?void 0:s.vertexBuffers[e])||void 0===n?void 0:n.getFloatData(this._geometry.getTotalVertices(),i||t&&1!==this._geometry.meshes.length);return o||(o=this._geometry.getVerticesData(e,t,i)),o}getVertexBuffer(e){var t,i;return this._geometry?null!==(i=null===(t=this._userInstancedBuffersStorage)||void 0===t?void 0:t.vertexBuffers[e])&&void 0!==i?i:this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e){var t;return this._geometry?void 0!==(null===(t=this._userInstancedBuffersStorage)||void 0===t?void 0:t.vertexBuffers[e])||this._geometry.isVerticesDataPresent(e):!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}isVertexBufferUpdatable(e){var t,i;return this._geometry?(null===(i=null===(t=this._userInstancedBuffersStorage)||void 0===t?void 0:t.vertexBuffers[e])||void 0===i?void 0:i.isUpdatable())||this._geometry.isVertexBufferUpdatable(e):!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}getVerticesDataKinds(){if(!this._geometry){const t=new Array;return this._delayInfo&&this._delayInfo.forEach(function(i){t.push(i)}),t}const e=this._geometry.getVerticesDataKinds();if(this._userInstancedBuffersStorage)for(const t in this._userInstancedBuffersStorage.vertexBuffers)e.push(t);return e}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return null!=this._masterMesh}isReady(e=!1,t=!1){var i,s,n,o,a,l;if(2===this.delayLoadState||!super.isReady(e))return!1;if(!this.subMeshes||0===this.subMeshes.length||!e)return!0;const c=this.getEngine(),h=this.getScene(),u=t||c.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const d=this.material||h.defaultMaterial;if(d)if(d._storeEffectOnSubMeshes)for(const p of this.subMeshes){const _=p.getMaterial();if(_)if(_._storeEffectOnSubMeshes){if(!_.isReadyForSubMesh(this,p,u))return!1}else if(!_.isReady(this,u))return!1}else if(!d.isReady(this,u))return!1;const f=c.currentRenderPassId;for(const p of this.lightSources){const _=p.getShadowGenerators();if(!_)continue;const m=_.values();for(let g=m.next();!0!==g.done;g=m.next()){const b=g.value;if(b&&(null===(i=b.getShadowMap())||void 0===i||!i.renderList||(null===(s=b.getShadowMap())||void 0===s?void 0:s.renderList)&&-1!==(null===(o=null===(n=b.getShadowMap())||void 0===n?void 0:n.renderList)||void 0===o?void 0:o.indexOf(this)))){b.getShadowMap()&&(c.currentRenderPassId=b.getShadowMap().renderPassId);for(const y of this.subMeshes)if(!b.isReady(y,u,null!==(l=null===(a=y.getMaterial())||void 0===a?void 0:a.needAlphaBlendingForMesh(this))&&void 0!==l&&l))return c.currentRenderPassId=f,!1;c.currentRenderPassId=f}}}for(const p of this._internalMeshDataInfo._LODLevels)if(p.mesh&&!p.mesh.isReady(u))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){const e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t||(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null),this}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(void 0!==this._instanceDataStorage.previousRenderId&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,t),i),this}_createGlobalSubMesh(e){const t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const i=this.getIndices();if(!i)return null;const s=i.length;let n=!1;if(e)n=!0;else for(const o of this.subMeshes){if(o.indexStart+o.indexCount>s){n=!0;break}if(o.verticesStart+o.verticesCount>t){n=!0;break}}if(!n)return this.subMeshes[0]}return this.releaseSubMeshes(),new fr(0,0,t,0,this.getTotalIndices(),this)}subdivide(e){if(e<1)return;const t=this.getTotalIndices();let i=t/e|0,s=0;for(;i%3!=0;)i++;this.releaseSubMeshes();for(let n=0;n<e&&!(s>=t);n++)fr.CreateFromIndices(0,s,n===e-1?t-s:i,this),s+=i;this.synchronizeInstances()}setVerticesData(e,t,i=!1,s){if(this._geometry)this._geometry.setVerticesData(e,t,i,s);else{const n=new ue;n.set(t,e);const o=this.getScene();new rr(rr.RandomId(),o,n,i,this)}return this}removeVerticesData(e){!this._geometry||this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){const i=this.getVertexBuffer(e);!i||i.isUpdatable()===t||this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=rr.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,s){return this._geometry?(s?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){const i=this.getVerticesData(A.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(A.PositionKind,i,!1,!1),t){const s=this.getIndices(),n=this.getVerticesData(A.NormalKind);if(!n)return this;ue.ComputeNormals(i,s,n),this.updateVerticesData(A.NormalKind,n,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(1===this._geometry.meshes.length)return this;const e=this._geometry,t=this._geometry.copy(rr.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndices(e,t=null,i=!1){if(this._geometry)this._geometry.setIndices(e,t,i);else{const s=new ue;s.indices=e;const n=this.getScene();new rr(rr.RandomId(),n,s,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i,s=!0){if(!this._geometry)return this;const n=this.getScene().getEngine();let o;if(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(t),this._unIndexed)o=null;else switch(i){case ie.PointFillMode:o=null;break;case ie.WireFrameFillMode:o=e._getLinesIndexBuffer(this.getIndices(),n);break;default:o=this._geometry.getIndexBuffer()}return s&&this._userInstancedBuffersStorage&&!this.hasThinInstances?this._geometry._bind(t,o,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(t,o),this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const n=this.getScene().getEngine();return this._unIndexed||t==ie.PointFillMode?n.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==ie.WireFrameFillMode?n.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):n.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}const i=this.getScene(),s=i._isInIntermediateRendering(),n=s?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,o=this._instanceDataStorage.batchCache;if(o.mustReturn=!1,o.renderSelf[e]=t||!n&&this.isEnabled()&&this.isVisible,o.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){const a=this._instanceDataStorage.visibleInstances,l=i.getRenderId(),c=s?a.intermediateDefaultRenderId:a.defaultRenderId;o.visibleInstances[e]=a[l],!o.visibleInstances[e]&&c&&(o.visibleInstances[e]=a[c])}return o.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&null!=o.visibleInstances[e],this._instanceDataStorage.previousBatch=o,o}_renderWithInstances(e,t,i,s,n){var o;const a=i.visibleInstances[e._id],l=a?a.length:0,c=this._instanceDataStorage,h=c.instancesBufferSize;let u=c.instancesBuffer,d=c.instancesPreviousBuffer;const p=16*(l+1)*4;for(;c.instancesBufferSize<p;)c.instancesBufferSize*=2;(!c.instancesData||h!=c.instancesBufferSize)&&(c.instancesData=new Float32Array(c.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!c.instancesPreviousData||h!=c.instancesBufferSize)&&(c.instancesPreviousData=new Float32Array(c.instancesBufferSize/4));let _=0,m=0;const g=i.renderSelf[e._id],b=!u||h!==c.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!c.instancesPreviousBuffer;if(this._instanceDataStorage.manualUpdate||c.isFrozen&&!b)m=(g?1:0)+l;else{const y=this.getWorldMatrix();if(g&&(this._scene.needsPreviousWorldMatrices&&(c.masterMeshPreviousWorldMatrix?(c.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,_),c.masterMeshPreviousWorldMatrix.copyFrom(y)):(c.masterMeshPreviousWorldMatrix=y.clone(),c.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,_))),y.copyToArray(c.instancesData,_),_+=16,m++),a){if(G.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&(null===(o=e.getMaterial())||void 0===o?void 0:o.needAlphaBlendingForMesh(e.getRenderingMesh()))){const T=this._scene.activeCamera.globalPosition;for(let x=0;x<a.length;x++){const S=a[x];S._distanceToCamera=v.Distance(S.getBoundingInfo().boundingSphere.centerWorld,T)}a.sort((x,S)=>x._distanceToCamera>S._distanceToCamera?-1:x._distanceToCamera<S._distanceToCamera?1:0)}for(let T=0;T<a.length;T++){const x=a[T],S=x.getWorldMatrix();S.copyToArray(c.instancesData,_),this._scene.needsPreviousWorldMatrices&&(x._previousWorldMatrix?(x._previousWorldMatrix.copyToArray(c.instancesPreviousData,_),x._previousWorldMatrix.copyFrom(S)):(x._previousWorldMatrix=S.clone(),x._previousWorldMatrix.copyToArray(c.instancesPreviousData,_))),_+=16,m++}}}return b?(u&&u.dispose(),d&&d.dispose(),u=new kn(n,c.instancesData,!0,16,!1,!0),c.instancesBuffer=u,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=u.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=u.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=u.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=u.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(d=new kn(n,c.instancesPreviousData,!0,16,!1,!0),c.instancesPreviousBuffer=d,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=d.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=d.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=d.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=d.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(u.updateDirectly(c.instancesData,0,m),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&d.updateDirectly(c.instancesPreviousData,0,m)),this._processInstancedBuffers(a,g),this.getScene()._activeIndices.addCount(e.indexCount*m,!1),n._currentDrawContext&&(n._currentDrawContext.useInstancing=!0),this._bind(e,s,t),this._draw(e,t,m),this._scene.needsPreviousWorldMatrices&&!b&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&d.updateDirectly(c.instancesData,0,m),n.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,s){var n,o;const a=null!==(o=null===(n=this._thinInstanceDataStorage)||void 0===n?void 0:n.instancesCount)&&void 0!==o?o:0;this.getScene()._activeIndices.addCount(e.indexCount*a,!1),s._currentDrawContext&&(s._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,a),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,a):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),s.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,s,n,o,a,l){const c=this.getScene(),h=c.getEngine();if(o&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,s,i,h),this;if(o)this._renderWithInstances(t,s,n,i,h);else{h._currentDrawContext&&(h._currentDrawContext.useInstancing=!1);let u=0;n.renderSelf[t._id]&&(a&&a(!1,e.getWorldMatrix(),l),u++,this._draw(t,s,this._instanceDataStorage.overridenInstanceCount));const d=n.visibleInstances[t._id];if(d){const f=d.length;u+=f;for(let p=0;p<f;p++){const m=d[p].getWorldMatrix();a&&a(!0,m,l),this._draw(t,s)}}c._activeIndices.addCount(t.indexCount*u,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(const t in this._userInstancedBuffersStorage.vertexBuffers){const i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}render(e,t,i){var s,n,o;const a=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const l=this._getInstancesRenderList(e._id,!!i);if(l.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const c=a.getEngine();let h=0,u=null;this.ignoreCameraMaxZ&&a.activeCamera&&!a._isInIntermediateRendering()&&(h=a.activeCamera.maxZ,u=a.activeCamera,a.activeCamera.maxZ=0,a.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const d=e.getRenderingMesh(),f=l.hardwareInstancedRendering[e._id]||d.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,p=this._instanceDataStorage,_=e.getMaterial();if(!_)return u&&(u.maxZ=h,a.updateTransformMatrix(!0)),this;if(p.isFrozen&&this._internalMeshDataInfo._effectiveMaterial&&this._internalMeshDataInfo._effectiveMaterial===_){if(_._storeEffectOnSubMeshes&&(null===(s=e.effect)||void 0===s||!s._wasPreviouslyReady)||!_._storeEffectOnSubMeshes&&(null===(n=_.getEffect())||void 0===n||!n._wasPreviouslyReady))return u&&(u.maxZ=h,a.updateTransformMatrix(!0)),this}else{if(_._storeEffectOnSubMeshes){if(!_.isReadyForSubMesh(this,e,f))return u&&(u.maxZ=h,a.updateTransformMatrix(!0)),this}else if(!_.isReady(this,f))return u&&(u.maxZ=h,a.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=_}let m;t&&c.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode),m=this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?e._drawWrapper:this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const g=null!==(o=m?.effect)&&void 0!==o?o:null;for(const D of a._beforeRenderingMeshStage)D.action(this,e,l,g);if(!m||!g)return u&&(u.maxZ=h,a.updateTransformMatrix(!0)),this;const b=i||this;let y;if(p.isFrozen||!this._internalMeshDataInfo._effectiveMaterial.backFaceCulling&&null===this.overrideMaterialSideOrientation)y=p.sideOrientation;else{const D=b._getWorldMatrixDeterminant();y=this.overrideMaterialSideOrientation,null==y&&(y=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),D<0&&(y=y===ie.ClockWiseSideOrientation?ie.CounterClockWiseSideOrientation:ie.ClockWiseSideOrientation),p.sideOrientation=y}const T=this._internalMeshDataInfo._effectiveMaterial._preBind(m,y);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&c.setDepthWrite(!0);const x=a.forcePointsCloud?ie.PointFillMode:a.forceWireframe?ie.WireFrameFillMode:this._internalMeshDataInfo._effectiveMaterial.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),f||this._bind(e,g,x,!1);const S=this._internalMeshDataInfo._effectiveMaterial,C=b.getWorldMatrix();S._storeEffectOnSubMeshes?S.bindForSubMesh(C,this,e):S.bind(C,this),!S.backFaceCulling&&S.separateCullingPass&&(c.setState(!0,S.zOffset,!1,!T,S.cullBackFaces,S.stencil,S.zOffsetUnits),this._processRendering(this,e,g,x,l,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),c.setState(!0,S.zOffset,!1,T,S.cullBackFaces,S.stencil,S.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,g,x,l,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const D of a._afterRenderingMeshStage)D.action(this,e,l,g);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),u&&(u.maxZ=h,a.updateTransformMatrix(!0)),a.performancePriority===Lo.Aggressive&&!p.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(A.MatricesWeightsKind)&&(this.isVerticesDataPresent(A.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){const e=this.getVerticesData(A.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){const s=e[i]+e[i+1]+e[i+2]+e[i+3];if(0===s)e[i]=1;else{const n=1/s;e[i]*=n,e[i+1]*=n,e[i+2]*=n,e[i+3]*=n}}this.setVerticesData(A.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(A.MatricesWeightsExtraKind),t=this.getVerticesData(A.MatricesWeightsKind),i=t.length;for(let s=0;s<i;s+=4){let n=t[s]+t[s+1]+t[s+2]+t[s+3];if(n+=e[s]+e[s+1]+e[s+2]+e[s+3],0===n)t[s]=1;else{const o=1/n;t[s]*=o,t[s+1]*=o,t[s+2]*=o,t[s+3]*=o,e[s]*=o,e[s+1]*=o,e[s+2]*=o,e[s+3]*=o}}this.setVerticesData(A.MatricesWeightsKind,t),this.setVerticesData(A.MatricesWeightsKind,e)}validateSkinning(){const e=this.getVerticesData(A.MatricesWeightsExtraKind),t=this.getVerticesData(A.MatricesWeightsKind);if(null===t||null==this.skeleton)return{skinned:!1,valid:!0,report:"not skinned"};const i=t.length;let s=0,n=0,o=0,a=0;const l=null===e?4:8,c=new Array;for(let m=0;m<=l;m++)c[m]=0;for(let m=0;m<i;m+=4){let g=t[m],b=g,y=0===b?0:1;for(let T=1;T<l;T++){const x=T<4?t[m+T]:e[m+T-4];x>g&&s++,0!==x&&y++,b+=x,g=x}if(c[y]++,y>o&&(o=y),0===b)n++;else{const T=1/b;let x=0;for(let S=0;S<l;S++)x+=S<4?Math.abs(t[m+S]-t[m+S]*T):Math.abs(e[m+S-4]-e[m+S-4]*T);x>.001&&a++}}const u=this.skeleton.bones.length,d=this.getVerticesData(A.MatricesIndicesKind),f=this.getVerticesData(A.MatricesIndicesExtraKind);let p=0;for(let m=0;m<i;m+=4)for(let g=0;g<l;g++){const b=g<4?d[m+g]:f[m+g-4];(b>=u||b<0)&&p++}return{skinned:!0,valid:0===n&&0===a&&0===p,report:"Number of Weights = "+i/4+"\nMaximum influences = "+o+"\nMissing Weights = "+n+"\nNot Sorted = "+s+"\nNot Normalized = "+a+"\nWeightCounts = ["+c+"]\nNumber of bones = "+u+"\nBad Bone Indices = "+p}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):4===this.delayLoadState&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const t=-1!==this.delayLoadingFile.indexOf(".babylonbinarymeshdata");return q.LoadFile(this.delayLoadingFile,i=>{i instanceof ArrayBuffer?this._delayLoadingFunction(i,this):this._delayLoadingFunction(JSON.parse(i),this),this.instances.forEach(s=>{s.refreshBoundingInfo(),s._syncSubMeshes()}),this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,t),this}isInFrustum(e){return!(2===this.delayLoadState||!super.isInFrustum(e)||(this._checkDelayState(),0))}setMaterialById(e){const t=this.getScene().materials;let i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;const s=this.getScene().multiMaterials;for(i=s.length-1;i>-1;i--)if(s[i].id===e)return this.material=s[i],this;return this}getAnimatables(){const e=new Array;return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(A.PositionKind))return this;const t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(A.PositionKind);const s=v.Zero();let n;for(n=0;n<i.length;n+=3)v.TransformCoordinatesFromFloatsToRef(i[n],i[n+1],i[n+2],e,s).toArray(i,n);if(this.setVerticesData(A.PositionKind,i,this.getVertexBuffer(A.PositionKind).isUpdatable()),this.isVerticesDataPresent(A.NormalKind)){for(i=this.getVerticesData(A.NormalKind),n=0;n<i.length;n+=3)v.TransformNormalFromFloatsToRef(i[n],i[n+1],i[n+2],e,s).normalize().toArray(i,n);this.setVerticesData(A.NormalKind,i,this.getVertexBuffer(A.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return!!this._geometry&&this._geometry._generatePointsArray()}clone(e="",t=null,i,s=!0){return new G(e,this.getScene(),t,this,i,s)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);const i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(const s in i.meshMap){const n=i.meshMap[s];n&&(n._internalMeshDataInfo._source=null,i.meshMap[s]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{const s=this.getScene().meshes;for(const n of s){const o=n;o._internalMeshDataInfo&&o._internalMeshDataInfo._source&&o._internalMeshDataInfo._source===this&&(o._internalMeshDataInfo._source=null)}}i._source=null,this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,s,n,o,a=!1){const l=this.getScene();return q.LoadImage(e,h=>{const u=h.width,d=h.height,p=this.getEngine().createCanvas(u,d).getContext("2d");p.drawImage(h,0,0);const _=p.getImageData(0,0,u,d).data;this.applyDisplacementMapFromBuffer(_,u,d,t,i,n,o,a),s&&s(this)},()=>{},l.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,s,n,o,a,l=!1){if(!this.isVerticesDataPresent(A.PositionKind)||!this.isVerticesDataPresent(A.NormalKind)||!this.isVerticesDataPresent(A.UVKind))return V.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const c=this.getVerticesData(A.PositionKind,!0,!0),h=this.getVerticesData(A.NormalKind),u=this.getVerticesData(A.UVKind);let d=v.Zero();const f=v.Zero(),p=de.Zero();o=o||de.Zero(),a=a||new de(1,1);for(let _=0;_<c.length;_+=3){v.FromArrayToRef(c,_,d),v.FromArrayToRef(h,_,f),de.FromArrayToRef(u,_/3*2,p);const b=4*((Math.abs(p.x*a.x+o.x%1)*(t-1)%t|0)+(Math.abs(p.y*a.y+o.y%1)*(i-1)%i|0)*t),S=e[b]/255*.3+e[b+1]/255*.59+e[b+2]/255*.11;f.normalize(),f.scaleInPlace(s+(n-s)*S),d=d.add(f),d.toArray(c,_)}return ue.ComputeNormals(c,this.getIndices(),h),l?(this.setVerticesData(A.PositionKind,c),this.setVerticesData(A.NormalKind,h),this.setVerticesData(A.UVKind,u)):(this.updateVerticesData(A.PositionKind,c),this.updateVerticesData(A.NormalKind,h)),this}convertToFlatShadedMesh(){const e=this.getVerticesDataKinds(),t={},i={},s={};let o,a,n=!1;for(o=0;o<e.length;o++){a=e[o];const m=this.getVertexBuffer(a),g=m.getData();if(!(g instanceof Array||g instanceof Float32Array)||0!==g.length){if(a===A.NormalKind){n=m.isUpdatable(),e.splice(o,1),o--;continue}t[a]=m,i[a]=this.getVerticesData(a),s[a]=[]}}const l=this.subMeshes.slice(0),c=this.getIndices(),h=this.getTotalIndices();let u;for(u=0;u<h;u++){const m=c[u];for(o=0;o<e.length;o++){if(a=e[o],!t[a])continue;const g=t[a].getStrideSize();for(let b=0;b<g;b++)s[a].push(i[a][m*g+b])}}const d=[],f=s[A.PositionKind];let _;for(_=this.getScene().useRightHandedSystem?1===this.overrideMaterialSideOrientation:0===this.overrideMaterialSideOrientation,u=0;u<h;u+=3){c[u]=u,c[u+1]=u+1,c[u+2]=u+2;const m=v.FromArray(f,3*u),g=v.FromArray(f,3*(u+1)),b=v.FromArray(f,3*(u+2)),y=m.subtract(g),T=b.subtract(g),x=v.Normalize(v.Cross(y,T));_&&x.scaleInPlace(-1);for(let S=0;S<3;S++)d.push(x.x),d.push(x.y),d.push(x.z)}for(this.setIndices(c),this.setVerticesData(A.NormalKind,d,n),o=0;o<e.length;o++)a=e[o],s[a]&&this.setVerticesData(a,s[a],t[a].isUpdatable());this.releaseSubMeshes();for(let m=0;m<l.length;m++){const g=l[m];fr.AddToMesh(g.materialIndex,g.indexStart,g.indexCount,g.indexStart,g.indexCount,this)}return this.synchronizeInstances(),this}convertToUnIndexedMesh(){const e=this.getVerticesDataKinds(),t={},i={},s={};let n,o;for(n=0;n<e.length;n++){o=e[n];const u=this.getVertexBuffer(o);t[o]=u,i[o]=t[o].getData(),s[o]=[]}const a=this.subMeshes.slice(0),l=this.getIndices(),c=this.getTotalIndices();let h;for(h=0;h<c;h++){const u=l[h];for(n=0;n<e.length;n++){o=e[n];const d=t[o].getStrideSize();for(let f=0;f<d;f++)s[o].push(i[o][u*d+f])}}for(h=0;h<c;h+=3)l[h]=h,l[h+1]=h+1,l[h+2]=h+2;for(this.setIndices(l),n=0;n<e.length;n++)o=e[n],this.setVerticesData(o,s[o],t[o].isUpdatable(),t[o].getStrideSize());this.releaseSubMeshes();for(let u=0;u<a.length;u++){const d=a[u];fr.AddToMesh(d.materialIndex,d.indexStart,d.indexCount,d.indexStart,d.indexCount,this)}return this._unIndexed=!0,this.synchronizeInstances(),this}flipFaces(e=!1){const t=ue.ExtractFromMesh(this);let i;if(e&&this.isVerticesDataPresent(A.NormalKind)&&t.normals)for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;if(t.indices){let s;for(i=0;i<t.indices.length;i+=3)s=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=s}return t.applyToMesh(this,this.isVertexBufferUpdatable(A.PositionKind)),this}increaseVertices(e=1){const t=ue.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,s=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,n=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,o=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(i&&s){t.indices=i,t.positions=s,n&&(t.uvs=n),o&&(t.normals=o);const a=e+1,l=new Array;for(let x=0;x<a+1;x++)l[x]=new Array;let c,h;const u=new v(0,0,0),d=new v(0,0,0),f=new de(0,0),p=new Array,_=new Array,m=new Array;let g,y,T,b=s.length;n&&(y=n.length),o&&(T=o.length);for(let x=0;x<i.length;x+=3){_[0]=i[x],_[1]=i[x+1],_[2]=i[x+2];for(let S=0;S<3;S++)if(c=_[S],h=_[(S+1)%3],void 0===m[c]&&void 0===m[h]?(m[c]=new Array,m[h]=new Array):(void 0===m[c]&&(m[c]=new Array),void 0===m[h]&&(m[h]=new Array)),void 0===m[c][h]&&void 0===m[h][c]){m[c][h]=[],u.x=(s[3*h]-s[3*c])/a,u.y=(s[3*h+1]-s[3*c+1])/a,u.z=(s[3*h+2]-s[3*c+2])/a,o&&(d.x=(o[3*h]-o[3*c])/a,d.y=(o[3*h+1]-o[3*c+1])/a,d.z=(o[3*h+2]-o[3*c+2])/a),n&&(f.x=(n[2*h]-n[2*c])/a,f.y=(n[2*h+1]-n[2*c+1])/a),m[c][h].push(c);for(let C=1;C<a;C++)m[c][h].push(s.length/3),s[b++]=s[3*c]+C*u.x,s[b++]=s[3*c+1]+C*u.y,s[b++]=s[3*c+2]+C*u.z,o&&(o[T++]=o[3*c]+C*d.x,o[T++]=o[3*c+1]+C*d.y,o[T++]=o[3*c+2]+C*d.z),n&&(n[y++]=n[2*c]+C*f.x,n[y++]=n[2*c+1]+C*f.y);m[c][h].push(h),m[h][c]=new Array,g=m[c][h].length;for(let C=0;C<g;C++)m[h][c][C]=m[c][h][g-1-C]}l[0][0]=i[x],l[1][0]=m[i[x]][i[x+1]][1],l[1][1]=m[i[x]][i[x+2]][1];for(let S=2;S<a;S++){l[S][0]=m[i[x]][i[x+1]][S],l[S][S]=m[i[x]][i[x+2]][S],u.x=(s[3*l[S][S]]-s[3*l[S][0]])/S,u.y=(s[3*l[S][S]+1]-s[3*l[S][0]+1])/S,u.z=(s[3*l[S][S]+2]-s[3*l[S][0]+2])/S,o&&(d.x=(o[3*l[S][S]]-o[3*l[S][0]])/S,d.y=(o[3*l[S][S]+1]-o[3*l[S][0]+1])/S,d.z=(o[3*l[S][S]+2]-o[3*l[S][0]+2])/S),n&&(f.x=(n[2*l[S][S]]-n[2*l[S][0]])/S,f.y=(n[2*l[S][S]+1]-n[2*l[S][0]+1])/S);for(let C=1;C<S;C++)l[S][C]=s.length/3,s[b++]=s[3*l[S][0]]+C*u.x,s[b++]=s[3*l[S][0]+1]+C*u.y,s[b++]=s[3*l[S][0]+2]+C*u.z,o&&(o[T++]=o[3*l[S][0]]+C*d.x,o[T++]=o[3*l[S][0]+1]+C*d.y,o[T++]=o[3*l[S][0]+2]+C*d.z),n&&(n[y++]=n[2*l[S][0]]+C*f.x,n[y++]=n[2*l[S][0]+1]+C*f.y)}l[a]=m[i[x+1]][i[x+2]],p.push(l[0][0],l[1][0],l[1][1]);for(let S=1;S<a;S++){let C;for(C=0;C<S;C++)p.push(l[S][C],l[S+1][C],l[S+1][C+1]),p.push(l[S][C],l[S+1][C+1],l[S][C+1]);p.push(l[S][C],l[S+1][C],l[S+1][C+1])}}t.indices=p,t.applyToMesh(this,this.isVertexBufferUpdatable(A.PositionKind))}else V.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions")}forceSharedVertices(){const e=ue.ExtractFromMesh(this),t=e.uvs,i=e.indices,s=e.positions,n=e.colors,o=e.matricesIndices,a=e.matricesWeights,l=e.matricesIndicesExtra,c=e.matricesWeightsExtra;if(void 0===i||void 0===s||null===i||null===s)V.Warn("VertexData contains empty entries");else{const h=new Array,u=new Array,d=new Array,f=new Array,p=new Array,_=new Array,m=new Array,g=new Array;let b=new Array,y=0;const T={};let x,S;for(let D=0;D<i.length;D+=3){S=[i[D],i[D+1],i[D+2]],b=new Array;for(let P=0;P<3;P++){b[P]="";for(let M=0;M<3;M++)Math.abs(s[3*S[P]+M])<1e-8&&(s[3*S[P]+M]=0),b[P]+=s[3*S[P]+M]+"|"}if(b[0]!=b[1]&&b[0]!=b[2]&&b[1]!=b[2])for(let P=0;P<3;P++){if(x=T[b[P]],void 0===x){T[b[P]]=y,x=y++;for(let M=0;M<3;M++)h.push(s[3*S[P]+M]);if(null!=n)for(let M=0;M<4;M++)f.push(n[4*S[P]+M]);if(null!=t)for(let M=0;M<2;M++)d.push(t[2*S[P]+M]);if(null!=o)for(let M=0;M<4;M++)p.push(o[4*S[P]+M]);if(null!=a)for(let M=0;M<4;M++)_.push(a[4*S[P]+M]);if(null!=l)for(let M=0;M<4;M++)m.push(l[4*S[P]+M]);if(null!=c)for(let M=0;M<4;M++)g.push(c[4*S[P]+M])}u.push(x)}}const C=new Array;ue.ComputeNormals(h,u,C),e.positions=h,e.indices=u,e.normals=C,null!=t&&(e.uvs=d),null!=n&&(e.colors=f),null!=o&&(e.matricesIndices=p),null!=a&&(e.matricesWeights=_),null!=l&&(e.matricesIndicesExtra=m),null!=a&&(e.matricesWeightsExtra=g),e.applyToMesh(this,this.isVertexBufferUpdatable(A.PositionKind))}}static _instancedMeshFactory(e,t){throw Ge("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw Ge("PhysicsImpostor")}createInstance(e){return G._instancedMeshFactory(e,this)}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){const t=this.getIndices(),i=this.getVerticesData(A.PositionKind);if(!i||!t)return this;const s=new Array;for(let o=0;o<i.length;o+=3)s.push(v.FromArray(i,o));const n=new Array;return ho.SyncAsyncForLoop(s.length,40,o=>{const a=s.length-1-o,l=s[a];for(let c=0;c<a;++c)if(l.equals(s[c])){n[a]=c;break}},()=>{for(let a=0;a<t.length;++a)t[a]=n[t[a]]||t[a];const o=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=o,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),Et&&Et.HasTags(this)&&(e.tags=Et.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let i=0;i<this.subMeshes.length;i++){const s=this.subMeshes[i];e.subMeshes.push({materialIndex:s.materialIndex,verticesStart:s.verticesStart,verticesCount:s.verticesCount,indexStart:s.indexStart,indexCount:s.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(Me.NAME_PHYSICSENGINE)){const i=this.getPhysicsImpostor();i&&(e.physicsMass=i.getParam("mass"),e.physicsFriction=i.getParam("friction"),e.physicsRestitution=i.getParam("mass"),e.physicsImpostor=i.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let i=0;i<this.instances.length;i++){const s=this.instances[i];if(s.doNotSerialize)continue;const n={name:s.name,id:s.id,isEnabled:s.isEnabled(!1),isVisible:s.isVisible,isPickable:s.isPickable,checkCollisions:s.checkCollisions,position:s.position.asArray(),scaling:s.scaling.asArray()};if(s.parent&&s.parent._serializeAsParent(n),s.rotationQuaternion?n.rotationQuaternion=s.rotationQuaternion.asArray():s.rotation&&(n.rotation=s.rotation.asArray()),this.getScene()._getComponent(Me.NAME_PHYSICSENGINE)){const o=s.getPhysicsImpostor();o&&(n.physicsMass=o.getParam("mass"),n.physicsFriction=o.getParam("friction"),n.physicsRestitution=o.getParam("mass"),n.physicsImpostor=o.type)}s.metadata&&(n.metadata=s.metadata),s.actionManager&&(n.actions=s.actionManager.serialize(s.name)),e.instances.push(n),Ce.AppendSerializedAnimations(s,n),n.ranges=s.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const i={data:{},sizes:{},strides:{}};for(const s in this._userThinInstanceBuffersStorage.data)i.data[s]=Array.from(this._userThinInstanceBuffersStorage.data[s]),i.sizes[s]=this._userThinInstanceBuffersStorage.sizes[s],i.strides[s]=this._userThinInstanceBuffersStorage.strides[s];e.thinInstances.userThinInstance=i}return Ce.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices())return V.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),void(this.morphTargetManager=null);if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){const i=e.getActiveTarget(t),s=i.getPositions();if(!s)return void V.Error("Invalid morph target. Target must have positions.");this.geometry.setVerticesData(A.PositionKind+t,s,!1,3);const n=i.getNormals();n&&this.geometry.setVerticesData(A.NormalKind+t,n,!1,3);const o=i.getTangents();o&&this.geometry.setVerticesData(A.TangentKind+t,o,!1,3);const a=i.getUVs();a&&this.geometry.setVerticesData(A.UVKind+"_"+t,a,!1,2)}}else{let t=0;for(;this.geometry.isVerticesDataPresent(A.PositionKind+t);)this.geometry.removeVerticesData(A.PositionKind+t),this.geometry.isVerticesDataPresent(A.NormalKind+t)&&this.geometry.removeVerticesData(A.NormalKind+t),this.geometry.isVerticesDataPresent(A.TangentKind+t)&&this.geometry.removeVerticesData(A.TangentKind+t),this.geometry.isVerticesDataPresent(A.UVKind+t)&&this.geometry.removeVerticesData(A.UVKind+"_"+t),t++}}static Parse(e,t,i){let s;if(s=e.type&&"LinesMesh"===e.type?G._LinesMeshParser(e,t):e.type&&"GroundMesh"===e.type?G._GroundMeshParser(e,t):e.type&&"GoldbergMesh"===e.type?G._GoldbergMeshParser(e,t):new G(e.name,t),s.id=e.id,s._waitingParsedUniqueId=e.uniqueId,Et&&Et.AddTagsTo(s,e.tags),s.position=v.FromArray(e.position),void 0!==e.metadata&&(s.metadata=e.metadata),e.rotationQuaternion?s.rotationQuaternion=Z.FromArray(e.rotationQuaternion):e.rotation&&(s.rotation=v.FromArray(e.rotation)),s.scaling=v.FromArray(e.scaling),e.localMatrix?s.setPreTransformMatrix(F.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(F.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s.isVisible=e.isVisible,s.infiniteDistance=e.infiniteDistance,s.showBoundingBox=e.showBoundingBox,s.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,void 0!==e.applyFog&&(s.applyFog=e.applyFog),void 0!==e.pickable&&(s.isPickable=e.pickable),void 0!==e.alphaIndex&&(s.alphaIndex=e.alphaIndex),s.receiveShadows=e.receiveShadows,void 0!==e.billboardMode&&(s.billboardMode=e.billboardMode),void 0!==e.visibility&&(s.visibility=e.visibility),s.checkCollisions=e.checkCollisions,s.overrideMaterialSideOrientation=e.overrideMaterialSideOrientation,void 0!==e.isBlocker&&(s.isBlocker=e.isBlocker),s._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(s._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.actions&&(s._waitingData.actions=e.actions),void 0!==e.overlayAlpha&&(s.overlayAlpha=e.overlayAlpha),void 0!==e.overlayColor&&(s.overlayColor=re.FromArray(e.overlayColor)),void 0!==e.renderOverlay&&(s.renderOverlay=e.renderOverlay),s.isUnIndexed=!!e.isUnIndexed,s.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=i+e.delayLoadingFile,s.buildBoundingInfo(v.FromArray(e.boundingBoxMinimum),v.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(s._binaryInfo=e._binaryInfo),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(A.UVKind),e.hasUVs2&&s._delayInfo.push(A.UV2Kind),e.hasUVs3&&s._delayInfo.push(A.UV3Kind),e.hasUVs4&&s._delayInfo.push(A.UV4Kind),e.hasUVs5&&s._delayInfo.push(A.UV5Kind),e.hasUVs6&&s._delayInfo.push(A.UV6Kind),e.hasColors&&s._delayInfo.push(A.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(A.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(A.MatricesWeightsKind),s._delayLoadingFunction=rr._ImportGeometry,ua.ForceFullSceneLoadingForIncremental&&s._checkDelayState()):rr._ImportGeometry(e,s),e.materialUniqueId?s._waitingMaterialId=e.materialUniqueId:e.materialId&&(s._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(s.morphTargetManager=t.getMorphTargetManagerById(e.morphTargetManagerId)),null!=e.skeletonId&&(s.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(s.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let n=0;n<e.animations.length;n++){const o=e.animations[n],a=hs("BABYLON.Animation");a&&s.animations.push(a.Parse(o))}Rt.ParseAnimationRanges(s,e,t)}if(e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),s.layerMask=e.layerMask&&!isNaN(e.layerMask)?Math.abs(parseInt(e.layerMask)):268435455,e.physicsImpostor&&G._PhysicsImpostorParser(t,s,e),e.lodMeshIds&&(s._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let n=0;n<e.instances.length;n++){const o=e.instances[n],a=s.createInstance(o.name);if(o.id&&(a.id=o.id),Et&&Et.AddTagsTo(a,o.tags?o.tags:e.tags),a.position=v.FromArray(o.position),void 0!==o.metadata&&(a.metadata=o.metadata),void 0!==o.parentId&&(a._waitingParentId=o.parentId),void 0!==o.parentInstanceIndex&&(a._waitingParentInstanceIndex=o.parentInstanceIndex),null!=o.isEnabled&&a.setEnabled(o.isEnabled),null!=o.isVisible&&(a.isVisible=o.isVisible),null!=o.isPickable&&(a.isPickable=o.isPickable),o.rotationQuaternion?a.rotationQuaternion=Z.FromArray(o.rotationQuaternion):o.rotation&&(a.rotation=v.FromArray(o.rotation)),a.scaling=v.FromArray(o.scaling),null!=o.checkCollisions&&null!=o.checkCollisions&&(a.checkCollisions=o.checkCollisions),null!=o.pickable&&null!=o.pickable&&(a.isPickable=o.pickable),null!=o.showBoundingBox&&null!=o.showBoundingBox&&(a.showBoundingBox=o.showBoundingBox),null!=o.showSubMeshesBoundingBox&&null!=o.showSubMeshesBoundingBox&&(a.showSubMeshesBoundingBox=o.showSubMeshesBoundingBox),null!=o.alphaIndex&&null!=o.showSubMeshesBoundingBox&&(a.alphaIndex=o.alphaIndex),o.physicsImpostor&&G._PhysicsImpostorParser(t,a,o),void 0!==o.actions&&(a._waitingData.actions=o.actions),o.animations){for(let l=0;l<o.animations.length;l++){const c=o.animations[l],h=hs("BABYLON.Animation");h&&a.animations.push(h.Parse(c))}Rt.ParseAnimationRanges(a,o,t),o.autoAnimate&&t.beginAnimation(a,o.autoAnimateFrom,o.autoAnimateTo,o.autoAnimateLoop,o.autoAnimateSpeed||1)}}if(e.thinInstances){const n=e.thinInstances;if(s.thinInstanceEnablePicking=!!n.enablePicking,n.matrixData?(s.thinInstanceSetBuffer("matrix",new Float32Array(n.matrixData),16,!1),s._thinInstanceDataStorage.matrixBufferSize=n.matrixBufferSize,s._thinInstanceDataStorage.instancesCount=n.instancesCount):s._thinInstanceDataStorage.matrixBufferSize=n.matrixBufferSize,e.thinInstances.userThinInstance){const o=e.thinInstances.userThinInstance;for(const a in o.data)s.thinInstanceSetBuffer(a,new Float32Array(o.data[a]),o.strides[a],!1),s._userThinInstanceBuffersStorage.sizes[a]=o.sizes[a]}}return s}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const t=this.getVerticesData(A.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(A.PositionKind)||this.setVerticesData(A.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const t=this.getVerticesData(A.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(A.NormalKind)||this.setVerticesData(A.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(A.PositionKind))return this;if(!this.isVerticesDataPresent(A.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(A.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(A.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const g=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=g}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let s=this.getVerticesData(A.PositionKind);if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s));let n=this.getVerticesData(A.NormalKind);if(t){if(!n)return this;n instanceof Float32Array||(n=new Float32Array(n))}const o=this.getVerticesData(A.MatricesIndicesKind),a=this.getVerticesData(A.MatricesWeightsKind);if(!a||!o)return this;const l=this.numBoneInfluencers>4,c=l?this.getVerticesData(A.MatricesIndicesExtraKind):null,h=l?this.getVerticesData(A.MatricesWeightsExtraKind):null,u=e.getTransformMatrices(this),d=v.Zero(),f=new F,p=new F;let m,_=0;for(let g=0;g<s.length;g+=3,_+=4){let b;for(m=0;m<4;m++)b=a[_+m],b>0&&(F.FromFloat32ArrayToRefScaled(u,Math.floor(16*o[_+m]),b,p),f.addToSelf(p));if(l)for(m=0;m<4;m++)b=h[_+m],b>0&&(F.FromFloat32ArrayToRefScaled(u,Math.floor(16*c[_+m]),b,p),f.addToSelf(p));v.TransformCoordinatesFromFloatsToRef(i._sourcePositions[g],i._sourcePositions[g+1],i._sourcePositions[g+2],f,d),d.toArray(s,g),t&&(v.TransformNormalFromFloatsToRef(i._sourceNormals[g],i._sourceNormals[g+1],i._sourceNormals[g+2],f,d),d.toArray(n,g)),f.reset()}return this.updateVerticesData(A.PositionKind,s),t&&this.updateVerticesData(A.NormalKind,n),this}static MinMax(e){let t=null,i=null;return e.forEach(function(s){const o=s.getBoundingInfo().boundingBox;t&&i?(t.minimizeInPlace(o.minimumWorld),i.maximizeInPlace(o.maximumWorld)):(t=o.minimumWorld,i=o.maximumWorld)}),t&&i?{min:t,max:i}:{min:v.Zero(),max:v.Zero()}}static Center(e){const t=e instanceof Array?G.MinMax(e):e;return v.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,s,n,o){return yE(G._MergeMeshesCoroutine(e,t,i,s,n,o,!1))}static MergeMeshesAsync(e,t=!0,i,s,n,o){return xE(G._MergeMeshesCoroutine(e,t,i,s,n,o,!0),function Jie(r=25){let e;return(t,i,s)=>{const n=performance.now();void 0===e||n-e>r?(e=n,setTimeout(()=>{ev(t,i,s)},0)):ev(t,i,s)}}())}static*_MergeMeshesCoroutine(e,t=!0,i,s,n,o,a){if(0===(e=e.filter(Boolean)).length)return null;let l;if(!i){let C=0;for(l=0;l<e.length;l++)if(C+=e[l].getTotalVertices(),C>=65536)return V.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}o&&(n=!1);const c=new Array,h=new Array,u=new Array,d=e[0].overrideMaterialSideOrientation;for(l=0;l<e.length;l++){const C=e[l];if(C.isAnInstance)return V.Warn("Cannot merge instance meshes."),null;if(d!==C.overrideMaterialSideOrientation)return V.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),null;if(n&&u.push(C.getTotalIndices()),o)if(C.material){const D=C.material;if(D instanceof el){for(let P=0;P<D.subMaterials.length;P++)c.indexOf(D.subMaterials[P])<0&&c.push(D.subMaterials[P]);for(let P=0;P<C.subMeshes.length;P++)h.push(c.indexOf(D.subMaterials[C.subMeshes[P].materialIndex])),u.push(C.subMeshes[P].indexCount)}else{c.indexOf(D)<0&&c.push(D);for(let P=0;P<C.subMeshes.length;P++)h.push(c.indexOf(D)),u.push(C.subMeshes[P].indexCount)}}else for(let D=0;D<C.subMeshes.length;D++)h.push(0),u.push(C.subMeshes[D].indexCount)}const f=e[0],p=C=>{const D=C.computeWorldMatrix(!0);return{vertexData:ue.ExtractFromMesh(C,!1,!1),transform:D}},{vertexData:_,transform:m}=p(f);a&&(yield);const g=new Array(e.length-1);for(let C=1;C<e.length;C++)g[C-1]=p(e[C]),a&&(yield);const b=_._mergeCoroutine(m,g,i,a,!t);let y=b.next();for(;!y.done;)a&&(yield),y=b.next();const T=y.value;s||(s=new G(f.name+"_merged",f.getScene()));const x=T._applyToCoroutine(s,void 0,a);let S=x.next();for(;!S.done;)a&&(yield),S=x.next();if(s.checkCollisions=f.checkCollisions,s.overrideMaterialSideOrientation=f.overrideMaterialSideOrientation,t)for(l=0;l<e.length;l++)e[l].dispose();if(n||o){s.releaseSubMeshes(),l=0;let C=0;for(;l<u.length;)fr.CreateFromIndices(0,C,u[l],s,void 0,!1),C+=u[l],l++;for(const D of s.subMeshes)D.refreshBoundingInfo();s.computeWorldMatrix(!0)}if(o){const C=new el(f.name+"_merged",f.getScene());C.subMaterials=c;for(let D=0;D<s.subMeshes.length;D++)s.subMeshes[D].materialIndex=h[D];s.material=C}else s.material=f.material;return s}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){const t=e._indexInSourceMeshInstanceArray;if(-1!=t){if(t!==this.instances.length-1){const i=this.instances[this.instances.length-1];this.instances[t]=i,i._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this.overrideMaterialSideOrientation===ie.CounterClockWiseSideOrientation}}G.FRONTSIDE=ue.FRONTSIDE,G.BACKSIDE=ue.BACKSIDE,G.DOUBLESIDE=ue.DOUBLESIDE,G.DEFAULTSIDE=ue.DEFAULTSIDE,G.NO_CAP=0,G.CAP_START=1,G.CAP_END=2,G.CAP_ALL=3,G.NO_FLIP=0,G.FLIP_TILE=1,G.ROTATE_TILE=2,G.FLIP_ROW=3,G.ROTATE_ROW=4,G.FLIP_N_ROTATE_TILE=5,G.FLIP_N_ROTATE_ROW=6,G.CENTER=0,G.LEFT=1,G.RIGHT=2,G.TOP=3,G.BOTTOM=4,G.INSTANCEDMESH_SORT_TRANSPARENT=!1,G._GroundMeshParser=(r,e)=>{throw Ge("GroundMesh")},G._GoldbergMeshParser=(r,e)=>{throw Ge("GoldbergMesh")},G._LinesMeshParser=(r,e)=>{throw Ge("LinesMesh")},le("BABYLON.Mesh",G),G.prototype.setMaterialByID=function(r){return this.setMaterialById(r)},G.CreateDisc=G.CreateDisc||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G.CreateBox=G.CreateBox||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G.CreateSphere=G.CreateSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G.CreateCylinder=G.CreateCylinder||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G.CreateTorusKnot=G.CreateTorusKnot||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G.CreateTorus=G.CreateTorus||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G.CreatePlane=G.CreatePlane||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G.CreateGround=G.CreateGround||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G.CreateTiledGround=G.CreateTiledGround||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G.CreateGroundFromHeightMap=G.CreateGroundFromHeightMap||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G.CreateTube=G.CreateTube||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G.CreatePolyhedron=G.CreatePolyhedron||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G.CreateIcoSphere=G.CreateIcoSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G.CreateDecal=G.CreateDecal||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G.CreateCapsule=G.CreateCapsule||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G.ExtendToGoldberg=G.ExtendToGoldberg||(()=>{throw new Error("Import MeshBuilder to populate this function")}),G._instancedMeshFactory=(r,e)=>{const t=new AE(r,e);if(e.instancedBuffers){t.instancedBuffers={};for(const i in e.instancedBuffers)t.instancedBuffers[i]=e.instancedBuffers[i]}return t};class AE extends Zt{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(const i of t.getAnimationRanges())null!=i&&this.createAnimationRange(i.name,i.from,i.to);this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}get material(){return this._sourceMesh.material}get visibility(){return this._sourceMesh.visibility}get skeleton(){return this._sourceMesh.skeleton}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||V.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t){return this._sourceMesh.getVerticesData(e,t)}setVerticesData(e,t,i,s){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,s),this.sourceMesh}updateVerticesData(e,t,i,s){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,s),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(e,t),i),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||V.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==We.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new F);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,L.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(L.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const t=this.sourceMesh.getLODLevels();if(t&&0!==t.length){const i=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,i.boundingSphere)}else this._currentLOD=this.sourceMesh;return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,i,s){const n=(s||this._sourceMesh).createInstance(e);if(Pr.DeepCopy(this,n,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),t&&(n.parent=t),!i)for(let o=0;o<this.getScene().meshes.length;o++){const a=this.getScene().meshes[o];a.parent===this&&a.clone(a.name,n)}return n.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(n),n}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,i){const s=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);s&&i&&i(this,s);for(const n of this.getChildTransformNodes(!0))n.instantiateHierarchy(s,t,i);return s}}G.prototype.registerInstancedBuffer=function(r,e){var t,i;if(null===(i=null===(t=this._userInstancedBuffersStorage)||void 0===t?void 0:t.vertexBuffers[r])||void 0===i||i.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const s of this.instances)s.instancedBuffers={};this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0})}this.instancedBuffers[r]=null,this._userInstancedBuffersStorage.strides[r]=e,this._userInstancedBuffersStorage.sizes[r]=32*e,this._userInstancedBuffersStorage.data[r]=new Float32Array(this._userInstancedBuffersStorage.sizes[r]),this._userInstancedBuffersStorage.vertexBuffers[r]=new A(this.getEngine(),this._userInstancedBuffersStorage.data[r],r,!0,!1,e,!0);for(const s of this.instances)s.instancedBuffers[r]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()},G.prototype._processInstancedBuffers=function(r,e){const t=r?r.length:0;for(const i in this.instancedBuffers){let s=this._userInstancedBuffersStorage.sizes[i];const n=this._userInstancedBuffersStorage.strides[i],o=(t+1)*n;for(;s<o;)s*=2;this._userInstancedBuffersStorage.data[i].length!=s&&(this._userInstancedBuffersStorage.data[i]=new Float32Array(s),this._userInstancedBuffersStorage.sizes[i]=s,this._userInstancedBuffersStorage.vertexBuffers[i]&&(this._userInstancedBuffersStorage.vertexBuffers[i].dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null));const a=this._userInstancedBuffersStorage.data[i];let l=0;if(e){const c=this.instancedBuffers[i];c.toArray?c.toArray(a,l):c.copyToArray?c.copyToArray(a,l):a[l]=c,l+=n}for(let c=0;c<t;c++){const u=r[c].instancedBuffers[i];u.toArray?u.toArray(a,l):u.copyToArray?u.copyToArray(a,l):a[l]=u,l+=n}this._userInstancedBuffersStorage.vertexBuffers[i]?this._userInstancedBuffersStorage.vertexBuffers[i].updateDirectly(a,0):(this._userInstancedBuffersStorage.vertexBuffers[i]=new A(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,n,!0),this._invalidateInstanceVertexArrayObject())}},G.prototype._invalidateInstanceVertexArrayObject=function(){if(this._userInstancedBuffersStorage&&void 0!==this._userInstancedBuffersStorage.vertexArrayObjects){for(const r in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[r]);this._userInstancedBuffersStorage.vertexArrayObjects={}}},G.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(const r in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[r]&&this._userInstancedBuffersStorage.vertexBuffers[r].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};class Je extends Rt{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}constructor(e,t){super(e,t),this.diffuse=new re(1,1,1),this.specular=new re(1,1,1),this.falloffType=Je.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=Je.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new Se(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=new Array,this.excludedMeshes=new Array,this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,s,n=!0){var o;const a=e.toString();let l=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+a),this._renderId!==t.getRenderId()||this._lastUseSpecular!==s||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=s;const c=this.getScaledIntensity();this.transferToEffect(i,a),this.diffuse.scaleToRef(c,wt.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",wt.Color3[0],this.range,a),s&&(this.specular.scaleToRef(c,wt.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",wt.Color3[1],this.radius,a)),l=!0}if(this.transferTexturesToEffect(i,a),t.shadowsEnabled&&this.shadowEnabled&&n){const c=null!==(o=this.getShadowGenerator(t.activeCamera))&&void 0!==o?o:this.getShadowGenerator();c&&(c.bindShadowLight(a,i),l=!0)}l?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){var t;return null===this._shadowGenerators?null:null!==(t=this._shadowGenerators.get(e))&&void 0!==t?t:null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return v.Zero()}canAffectMesh(e){return!e||!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&-1===this.includedOnlyMeshes.indexOf(e)||this.excludedMeshes&&this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)||0!==this.includeOnlyWithLayerMask&&0==(this.includeOnlyWithLayerMask&e.layerMask)||0!==this.excludeWithLayerMask&&this.excludeWithLayerMask&e.layerMask)}dispose(e,t=!1){if(this._shadowGenerators){const i=this._shadowGenerators.values();for(let s=i.next();!0!==s.done;s=i.next())s.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){const i=this._parentContainer.lights.indexOf(this);i>-1&&this._parentContainer.lights.splice(i,1),this._parentContainer=null}for(const i of this.getScene().meshes)i._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const i=Je.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;const s=Ce.Clone(i,this);return e&&(s.name=e),t&&(s.parent=t),s.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(s),s}serialize(){const e=Ce.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach(t=>{e.excludedMeshesIds.push(t.id)})),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(t=>{e.includedOnlyMeshesIds.push(t.id)})),Ce.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){return Rt.Construct("Light_Type_"+e,t,i)||null}static Parse(e,t){const i=Je.GetConstructorFromName(e.type,e.name,t);if(!i)return null;const s=Ce.Parse(i,e,t);if(e.excludedMeshesIds&&(s._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(s._includedOnlyMeshesIds=e.includedOnlyMeshesIds),void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.falloffType&&(s.falloffType=e.falloffType),void 0!==e.lightmapMode&&(s.lightmapMode=e.lightmapMode),e.animations){for(let n=0;n<e.animations.length;n++){const o=e.animations[n],a=hs("BABYLON.Animation");a&&s.animations.push(a.Parse(o))}Rt.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&s.setEnabled(e.isEnabled),s}_hookArrayForExcluded(e){const t=e.push;e.push=(...s)=>{const n=t.apply(e,s);for(const o of s)o._resyncLightSource(this);return n};const i=e.splice;e.splice=(s,n)=>{const o=i.apply(e,[s,n]);for(const a of o)a._resyncLightSource(this);return o};for(const s of e)s._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...s)=>{const n=t.apply(e,s);return this._resyncMeshes(),n};const i=e.splice;e.splice=(s,n)=>{const o=i.apply(e,[s,n]);return this._resyncMeshes(),o},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)-1!==e.lightSources.indexOf(this)&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const t=this.getTypeID();let i=this.intensityMode;switch(i===Je.INTENSITYMODE_AUTOMATIC&&(i=t===Je.LIGHTTYPEID_DIRECTIONALLIGHT?Je.INTENSITYMODE_ILLUMINANCE:Je.INTENSITYMODE_LUMINOUSINTENSITY),t){case Je.LIGHTTYPEID_POINTLIGHT:case Je.LIGHTTYPEID_SPOTLIGHT:switch(i){case Je.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case Je.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case Je.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius}break;case Je.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case Je.INTENSITYMODE_ILLUMINANCE:e=1;break;case Je.INTENSITYMODE_LUMINANCE:{let s=this.radius;s=Math.max(s,.001),e=2*Math.PI*(1-Math.cos(s));break}}break;case Je.LIGHTTYPEID_HEMISPHERICLIGHT:e=1}return e}_reorderLightsInScene(){const e=this.getScene();0!=this._renderPriority&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}}Je.FALLOFF_DEFAULT=ds.FALLOFF_DEFAULT,Je.FALLOFF_PHYSICAL=ds.FALLOFF_PHYSICAL,Je.FALLOFF_GLTF=ds.FALLOFF_GLTF,Je.FALLOFF_STANDARD=ds.FALLOFF_STANDARD,Je.LIGHTMAP_DEFAULT=ds.LIGHTMAP_DEFAULT,Je.LIGHTMAP_SPECULAR=ds.LIGHTMAP_SPECULAR,Je.LIGHTMAP_SHADOWSONLY=ds.LIGHTMAP_SHADOWSONLY,Je.INTENSITYMODE_AUTOMATIC=ds.INTENSITYMODE_AUTOMATIC,Je.INTENSITYMODE_LUMINOUSPOWER=ds.INTENSITYMODE_LUMINOUSPOWER,Je.INTENSITYMODE_LUMINOUSINTENSITY=ds.INTENSITYMODE_LUMINOUSINTENSITY,Je.INTENSITYMODE_ILLUMINANCE=ds.INTENSITYMODE_ILLUMINANCE,Je.INTENSITYMODE_LUMINANCE=ds.INTENSITYMODE_LUMINANCE,Je.LIGHTTYPEID_POINTLIGHT=ds.LIGHTTYPEID_POINTLIGHT,Je.LIGHTTYPEID_DIRECTIONALLIGHT=ds.LIGHTTYPEID_DIRECTIONALLIGHT,Je.LIGHTTYPEID_SPOTLIGHT=ds.LIGHTTYPEID_SPOTLIGHT,Je.LIGHTTYPEID_HEMISPHERICLIGHT=ds.LIGHTTYPEID_HEMISPHERICLIGHT,E([us()],Je.prototype,"diffuse",void 0),E([us()],Je.prototype,"specular",void 0),E([I()],Je.prototype,"falloffType",void 0),E([I()],Je.prototype,"intensity",void 0),E([I()],Je.prototype,"range",null),E([I()],Je.prototype,"intensityMode",null),E([I()],Je.prototype,"radius",null),E([I()],Je.prototype,"_renderPriority",void 0),E([ne("_reorderLightsInScene")],Je.prototype,"renderPriority",void 0),E([I("shadowEnabled")],Je.prototype,"_shadowEnabled",void 0),E([I("excludeWithLayerMask")],Je.prototype,"_excludeWithLayerMask",void 0),E([I("includeOnlyWithLayerMask")],Je.prototype,"_includeOnlyWithLayerMask",void 0),E([I("lightmapMode")],Je.prototype,"_lightmapMode",void 0);class use extends es{}class dse{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach(e=>{e.dispose()}),this.rootNodes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0}}class E1 extends es{constructor(e){super(),this._wasAddedToScene=!1,(e=e||be.LastCreatedScene)&&(this.scene=e,this.sounds=[],this.effectLayers=[],this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.reflectionProbes=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(const t of this.geometries)t._rebuild();for(const t of this.meshes)t._rebuild();for(const t of this.particleSystems)t.rebuild();for(const t of this.textures)t._rebuild()}))}_topologicalSort(e){const t=new Map;for(const a of e)t.set(a.uniqueId,a);const i={dependsOn:new Map,dependedBy:new Map};for(const a of e){const l=a.uniqueId;i.dependsOn.set(l,new Set),i.dependedBy.set(l,new Set)}for(const a of e){const l=a.uniqueId,c=i.dependsOn.get(l);if(a instanceof AE){const u=a.sourceMesh;t.has(u.uniqueId)&&(c.add(u.uniqueId),i.dependedBy.get(u.uniqueId).add(l))}const h=i.dependedBy.get(l);for(const u of a.getDescendants()){const d=u.uniqueId;t.has(d)&&(h.add(d),i.dependsOn.get(d).add(l))}}const s=[],n=[];for(const a of e){const l=a.uniqueId;0===i.dependsOn.get(l).size&&(n.push(a),t.delete(l))}const o=n;for(;o.length>0;){const a=o.shift();s.push(a);const l=i.dependedBy.get(a.uniqueId);for(const c of Array.from(l.values())){const h=i.dependsOn.get(c);h.delete(a.uniqueId),0===h.size&&t.get(c)&&(o.push(t.get(c)),t.delete(c))}}return t.size>0&&(console.error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(a=>console.error(a.name))),s}_addNodeAndDescendantsToList(e,t,i,s){if(i&&(!s||s(i))&&!t.has(i.uniqueId)){e.push(i),t.add(i.uniqueId);for(const n of i.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,n,s)}}_isNodeInContainer(e){return e instanceof G&&-1!==this.meshes.indexOf(e)||e instanceof We&&-1!==this.transformNodes.indexOf(e)||e instanceof Je&&-1!==this.lights.indexOf(e)||e instanceof ve&&-1!==this.cameras.indexOf(e)}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return V.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return V.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return V.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return V.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||q.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const s={},n={},o=new dse,a=[],l=[],c={doNotInstantiate:!0,...i},u=[],d=new Set;for(const _ of this.transformNodes)null===_.parent&&this._addNodeAndDescendantsToList(u,d,_,c.predicate);for(const _ of this.meshes)null===_.parent&&this._addNodeAndDescendantsToList(u,d,_,c.predicate);const f=this._topologicalSort(u),p=(_,m)=>{if(((_,m)=>{if(s[_.uniqueId]=m.uniqueId,n[m.uniqueId]=m,e&&(m.name=e(_.name)),m instanceof G){const g=m;if(g.morphTargetManager){const b=_.morphTargetManager;g.morphTargetManager=b.clone();for(let y=0;y<b.numTargets;y++){const T=b.getTarget(y),x=g.morphTargetManager.getTarget(y);s[T.uniqueId]=x.uniqueId,n[x.uniqueId]=x}}}})(_,m),_.parent){m.parent=n[s[_.parent.uniqueId]]||_.parent}if(m.position.copyFrom(_.position),m.rotation.copyFrom(_.rotation),m.scaling.copyFrom(_.scaling),m.material){const g=m;if(g.material)if(t){const b=_.material;if(-1===l.indexOf(b)){let y=b.clone(e?e(b.name):"Clone of "+b.name);if(l.push(b),s[b.uniqueId]=y.uniqueId,n[y.uniqueId]=y,"MultiMaterial"===b.getClassName()){const T=b;for(const x of T.subMaterials)!x||(y=x.clone(e?e(x.name):"Clone of "+x.name),l.push(x),s[x.uniqueId]=y.uniqueId,n[y.uniqueId]=y);T.subMaterials=T.subMaterials.map(x=>x&&n[s[x.uniqueId]])}}"InstancedMesh"!==g.getClassName()&&(g.material=n[s[b.uniqueId]])}else"MultiMaterial"===g.material.getClassName()?-1===this.scene.multiMaterials.indexOf(g.material)&&this.scene.addMultiMaterial(g.material):-1===this.scene.materials.indexOf(g.material)&&this.scene.addMaterial(g.material)}null===m.parent&&o.rootNodes.push(m)};return f.forEach(_=>{if("InstancedMesh"===_.getClassName()){const m=_,g=m.sourceMesh,b=s[g.uniqueId],T=("number"==typeof b?n[b]:g).createInstance(m.name);p(m,T)}else{let m=!0;"TransformNode"===_.getClassName()||_.skeleton||0===_.getTotalVertices()?m=!1:c.doNotInstantiate&&(m="function"==typeof c.doNotInstantiate?!c.doNotInstantiate(_):!c.doNotInstantiate);const g=m?_.createInstance(`instance of ${_.name}`):_.clone(`Clone of ${_.name}`,null,!0);if(!g)throw new Error(`Could not clone or instantiate node on Asset Container ${_.name}`);p(_,g)}}),this.skeletons.forEach(_=>{if(c.predicate&&!c.predicate(_))return;const m=_.clone(e?e(_.name):"Clone of "+_.name);for(const g of this.meshes)if(g.skeleton===_&&!g.isAnInstance){const b=n[s[g.uniqueId]];if(b.isAnInstance||(b.skeleton=m,-1!==a.indexOf(m)))continue;a.push(m);for(const y of m.bones)y._linkedTransformNode&&(y._linkedTransformNode=n[s[y._linkedTransformNode.uniqueId]])}o.skeletons.push(m)}),this.animationGroups.forEach(_=>{if(c.predicate&&!c.predicate(_))return;const m=_.clone(e?e(_.name):"Clone of "+_.name,g=>n[s[g.uniqueId]]||g);o.animationGroups.push(m)}),o}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||q.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.addCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.addLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.addMesh(t)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.addSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.addAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.addAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.addMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.addMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.addMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.addGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.addTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.addActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.addTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.addReflectionProbe(t)})}removeAllFromScene(){this._isValidHierarchy()||q.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.removeCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.removeLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.removeMesh(t)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.removeSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.removeAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.removeAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.removeMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.removeMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.removeMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.removeGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.removeTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.removeActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.removeTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.removeReflectionProbe(t)})}dispose(){this.cameras.slice(0).forEach(e=>{e.dispose()}),this.cameras.length=0,this.lights.slice(0).forEach(e=>{e.dispose()}),this.lights.length=0,this.meshes.slice(0).forEach(e=>{e.dispose()}),this.meshes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach(e=>{e.dispose()}),this.multiMaterials.length=0,this.materials.slice(0).forEach(e=>{e.dispose()}),this.materials.length=0,this.geometries.slice(0).forEach(e=>{e.dispose()}),this.geometries.length=0,this.transformNodes.slice(0).forEach(e=>{e.dispose()}),this.transformNodes.length=0,this.actionManagers.slice(0).forEach(e=>{e.dispose()}),this.actionManagers.length=0,this.textures.slice(0).forEach(e=>{e.dispose()}),this.textures.length=0,this.reflectionProbes.slice(0).forEach(e=>{e.dispose()}),this.reflectionProbes.length=0,this.morphTargetManagers.slice(0).forEach(e=>{e.dispose()}),this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(e&&t)for(const s of e){let n=!0;if(i)for(const o of i)if(s===o){n=!1;break}n&&(t.push(s),s._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,void 0===e&&(e=new use);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||("_environmentTexture"===t?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new G("assetContainerRootMesh",this.scene);return this.meshes.forEach(t=>{t.parent||e.addChild(t)}),this.meshes.unshift(e),e}mergeAnimationsTo(e=be.LastCreatedScene,t,i=null){if(!e)return V.Error("No scene available to merge animations to"),[];const s=i||(a=>{let l=null;const c=a.animations.length?a.animations[0].targetProperty:"",h=a.name.split(".").join("").split("_primitive")[0];switch(c){case"position":case"rotationQuaternion":l=e.getTransformNodeByName(a.name)||e.getTransformNodeByName(h);break;case"influence":l=e.getMorphTargetByName(a.name)||e.getMorphTargetByName(h);break;default:l=e.getNodeByName(a.name)||e.getNodeByName(h)}return l});this.getNodes().forEach(a=>{const l=s(a);if(null!==l){for(const c of a.animations){const h=l.animations.filter(u=>u.targetProperty===c.targetProperty);for(const u of h){const d=l.animations.indexOf(u,0);d>-1&&l.animations.splice(d,1)}}l.animations=l.animations.concat(a.animations)}});const o=new Array;return this.animationGroups.slice().forEach(a=>{o.push(a.clone(a.name,s)),a.animatables.forEach(l=>{l.stop()})}),t.forEach(a=>{const l=s(a.target);l&&(e.beginAnimation(l,a.fromFrame,a.toFrame,a.loopAnimation,a.speedRatio,a.onAnimationEnd?a.onAnimationEnd:void 0,void 0,!0,void 0,a.onAnimationLoop?a.onAnimationLoop:void 0),e.stopAnimation(a.target))}),o}}ee.AudioEngineFactory=(r,e,t)=>new fse(r,e,t);class fse{get audioContext(){return this._audioContextInitialized?!this.unlocked&&!this._muteButton&&this._displayMuteButton():this._initializeAudioContext(),this._audioContext}constructor(e=null,t=null,i=null){if(this._audioContext=null,this._audioContextInitialized=!1,this._muteButton=null,this._audioDestination=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!0,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new z,this.onAudioLockedObservable=new z,this._tryToRun=!1,this._onResize=()=>{this._moveButtonToTopLeft()},!qi())return;typeof window.AudioContext<"u"&&(this.canUseWebAudio=!0);const s=document.createElement("audio");this._hostElement=e,this._audioContext=t,this._audioDestination=i;try{s&&s.canPlayType&&(s.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||s.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch{}try{s&&s.canPlayType&&s.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch{}}lock(){this._triggerSuspendedState()}unlock(){this._triggerRunningState()}_resumeAudioContext(){let e;return void 0!==this._audioContext.resume&&(e=this._audioContext.resume()),e||Promise.resolve()}_initializeAudioContext(){try{this.canUseWebAudio&&(this._audioContext||(this._audioContext=new AudioContext),this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this._audioDestination||(this._audioDestination=this._audioContext.destination),this.masterGain.connect(this._audioDestination),this._audioContextInitialized=!0,"running"===this._audioContext.state&&this._triggerRunningState())}catch(e){this.canUseWebAudio=!1,V.Error("Web Audio: "+e.message)}}_triggerRunningState(){this._tryToRun||(this._tryToRun=!0,this._resumeAudioContext().then(()=>{this._tryToRun=!1,this._muteButton&&this._hideMuteButton(),this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)}).catch(()=>{this._tryToRun=!1,this.unlocked=!1}))}_triggerSuspendedState(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this._displayMuteButton()}_displayMuteButton(){if(this.useCustomUnlockedButton||this._muteButton)return;this._muteButton=document.createElement("BUTTON"),this._muteButton.className="babylonUnmuteIcon",this._muteButton.id="babylonUnmuteIconBtn",this._muteButton.title="Unmute";const t=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png")+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",i=document.createElement("style");i.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(i),document.body.appendChild(this._muteButton),this._moveButtonToTopLeft(),this._muteButton.addEventListener("touchend",()=>{this._triggerRunningState()},!0),this._muteButton.addEventListener("click",()=>{this._triggerRunningState()},!0),window.addEventListener("resize",this._onResize)}_moveButtonToTopLeft(){this._hostElement&&this._muteButton&&(this._muteButton.style.top=this._hostElement.offsetTop+20+"px",this._muteButton.style.left=this._hostElement.offsetLeft+20+"px")}_hideMuteButton(){this._muteButton&&(document.body.removeChild(this._muteButton),this._muteButton=null)}dispose(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this._hideMuteButton(),window.removeEventListener("resize",this._onResize),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1}setGlobalVolume(e){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=e)}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))}}let mp=(()=>{class r{get loop(){return this._loop}set loop(t){t!==this._loop&&(this._loop=t,this.updateOptions({loop:t}))}get currentTime(){var t;return this._htmlAudioElement?this._htmlAudioElement.currentTime:(null===(t=ee.audioEngine)||void 0===t?void 0:t.audioContext)&&(this.isPlaying||this.isPaused)?this._currentTime+(this.isPaused?0:ee.audioEngine.audioContext.currentTime-this._startTime):0}get spatialSound(){return this._spatialSound}set spatialSound(t){var i;this._spatialSound=t,this._spatialSound&&(null===(i=ee.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&ee.audioEngine.audioContext&&this._createSpatialParameters()}constructor(t,i,s,n=null,o){var a,l,c,h,u;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new z,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=v.Zero(),this._localDirection=new v(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=t,s=s||be.LastCreatedScene)if(this._scene=s,r._SceneComponentInitialization(s),this._readyToPlayCallback=n,this._customAttenuationFunction=(d,f,p,_,m)=>f<p?d*(1-f/p):0,o&&(this.autoplay=o.autoplay||!1,this._loop=o.loop||!1,void 0!==o.volume&&(this._volume=o.volume),this._spatialSound=null!==(a=o.spatialSound)&&void 0!==a&&a,this.maxDistance=null!==(l=o.maxDistance)&&void 0!==l?l:100,this.useCustomAttenuation=null!==(c=o.useCustomAttenuation)&&void 0!==c&&c,this.rolloffFactor=o.rolloffFactor||1,this.refDistance=o.refDistance||1,this.distanceModel=o.distanceModel||"linear",this._playbackRate=o.playbackRate||1,this._streaming=null!==(h=o.streaming)&&void 0!==h&&h,this._length=o.length,this._offset=o.offset),(null===(u=ee.audioEngine)||void 0===u?void 0:u.canUseWebAudio)&&ee.audioEngine.audioContext){this._soundGain=ee.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let d=!0;if(i)try{"string"==typeof i?this._urlType="String":i instanceof ArrayBuffer?this._urlType="ArrayBuffer":i instanceof HTMLMediaElement?this._urlType="MediaElement":i instanceof MediaStream?this._urlType="MediaStream":i instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(i)&&(this._urlType="Array");let f=[],p=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=ee.audioEngine.audioContext.createMediaElementSource(i),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=ee.audioEngine.audioContext.createMediaStreamSource(i),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":i.byteLength>0&&(p=!0,this._soundLoaded(i));break;case"AudioBuffer":this._audioBufferLoaded(i);break;case"String":f.push(i);case"Array":0===f.length&&(f=i);for(let _=0;_<f.length;_++){const m=f[_];if(p=o&&o.skipCodecCheck||-1!==m.indexOf(".mp3",m.length-4)&&ee.audioEngine.isMP3supported||-1!==m.indexOf(".ogg",m.length-4)&&ee.audioEngine.isOGGsupported||-1!==m.indexOf(".wav",m.length-4)||-1!==m.indexOf(".m4a",m.length-4)||-1!==m.indexOf(".mp4",m.length-4)||-1!==m.indexOf("blob:"),p){this._streaming?(this._htmlAudioElement=new Audio(m),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,q.SetCorsBehavior(m,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(m,g=>{this._soundLoaded(g)},void 0,!0,!0,g=>{g&&V.Error("XHR "+g.status+" error on: "+m+"."),V.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:d=!1}d?p||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):V.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch{V.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),ee.audioEngine&&!ee.audioEngine.WarnedWebAudioUnsupported&&(V.Error("Web Audio is not supported by your browser."),ee.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}dispose(){var t;null!==(t=ee.audioEngine)&&void 0!==t&&t.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,-1===this.soundTrackId?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._streamingSource&&this._streamingSource.disconnect(),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null))}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(t){var i;null===(i=ee.audioEngine)||void 0===i||!i.audioContext||(this._audioBuffer=t,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(t){var i;null===(i=ee.audioEngine)||void 0===i||!i.audioContext||ee.audioEngine.audioContext.decodeAudioData(t,s=>{this._audioBufferLoaded(s)},s=>{V.Error("Error while decoding audio data for: "+this.name+" / Error: "+s)})}setAudioBuffer(t){var i;null!==(i=ee.audioEngine)&&void 0!==i&&i.canUseWebAudio&&(this._audioBuffer=t,this._isReadyToPlay=!0)}updateOptions(t){var i,s,n,o,a,l,c,h,u,d;t&&(this.loop=null!==(i=t.loop)&&void 0!==i?i:this.loop,this.maxDistance=null!==(s=t.maxDistance)&&void 0!==s?s:this.maxDistance,this.useCustomAttenuation=null!==(n=t.useCustomAttenuation)&&void 0!==n?n:this.useCustomAttenuation,this.rolloffFactor=null!==(o=t.rolloffFactor)&&void 0!==o?o:this.rolloffFactor,this.refDistance=null!==(a=t.refDistance)&&void 0!==a?a:this.refDistance,this.distanceModel=null!==(l=t.distanceModel)&&void 0!==l?l:this.distanceModel,this._playbackRate=null!==(c=t.playbackRate)&&void 0!==c?c:this._playbackRate,this._length=null!==(h=t.length)&&void 0!==h?h:void 0,this._setOffset(null!==(u=t.offset)&&void 0!==u?u:void 0),this.setVolume(null!==(d=t.volume)&&void 0!==d?d:this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),void 0!==this._offset&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),void 0!==this._length&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(0|this._offset)+this._length))))}_createSpatialParameters(){var t,i;(null===(t=ee.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&ee.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=null!==(i=this._soundPanner)&&void 0!==i?i:ee.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_updateSpatialParameters(){this._spatialSound&&this._soundPanner&&(this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel))}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){var t;(null===(t=ee.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(t){var i;(null===(i=ee.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(t),this._isOutputConnected=!0)}setDirectionalCone(t,i,s){i<t?V.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle."):(this._coneInnerAngle=t,this._coneOuterAngle=i,this._coneOuterGain=s,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length)))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(t){var i;if(t!=this._coneInnerAngle){if(this._coneOuterAngle<t)return void V.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneInnerAngle=t,(null===(i=ee.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(t){var i;if(t!=this._coneOuterAngle){if(t<this._coneInnerAngle)return void V.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneOuterAngle=t,(null===(i=ee.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(t){var i;t.equals(this._position)||(this._position.copyFrom(t),(null===(i=ee.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(t){var i;this._localDirection=t,(null===(i=ee.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;const t=this._connectedTransformNode.getWorldMatrix(),i=v.TransformNormal(this._localDirection,t);i.normalize(),this._soundPanner.orientationX.value=i.x,this._soundPanner.orientationY.value=i.y,this._soundPanner.orientationZ.value=i.z}updateDistanceFromListener(){var t;if((null===(t=ee.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){const i=this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,i,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(t){this._customAttenuationFunction=t}play(t,i,s){var n,o,a,l;if(this._isReadyToPlay&&this._scene.audioEnabled&&(null===(n=ee.audioEngine)||void 0===n?void 0:n.audioContext))try{let c=t?(null===(o=ee.audioEngine)||void 0===o?void 0:o.audioContext.currentTime)+t:null===(a=ee.audioEngine)||void 0===a?void 0:a.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(this._streamingSource||(this._streamingSource=ee.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement){const h=()=>{var u,d;if(null!==(u=ee.audioEngine)&&void 0!==u&&u.unlocked){const f=this._htmlAudioElement.play();void 0!==f&&f.catch(()=>{var p,_;null===(p=ee.audioEngine)||void 0===p||p.lock(),(this.loop||this.autoplay)&&(null===(_=ee.audioEngine)||void 0===_||_.onAudioUnlockedObservable.addOnce(()=>{h()}))})}else(this.loop||this.autoplay)&&(null===(d=ee.audioEngine)||void 0===d||d.onAudioUnlockedObservable.addOnce(()=>{h()}))};h()}}else{const h=()=>{var u,d,f,p;if(null!==(u=ee.audioEngine)&&void 0!==u&&u.audioContext){if(s=s||this._length,void 0!==i&&this._setOffset(i),this._soundSource){const _=this._soundSource;_.onended=()=>{_.disconnect()}}if(this._soundSource=null===(d=ee.audioEngine)||void 0===d?void 0:d.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,void 0!==i&&(this._soundSource.loopStart=i),void 0!==s&&(this._soundSource.loopEnd=(0|i)+s),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},c=t?(null===(f=ee.audioEngine)||void 0===f?void 0:f.audioContext.currentTime)+t:ee.audioEngine.audioContext.currentTime;const _=((this.isPaused?this.currentTime:0)+(null!==(p=this._offset)&&void 0!==p?p:0))%this._soundSource.buffer.duration;this._soundSource.start(c,_,this.loop?void 0:s)}}};"suspended"===(null===(l=ee.audioEngine)||void 0===l?void 0:l.audioContext.state)?setTimeout(()=>{var u;"suspended"===(null===(u=ee.audioEngine)||void 0===u?void 0:u.audioContext.state)?(ee.audioEngine.lock(),(this.loop||this.autoplay)&&ee.audioEngine.onAudioUnlockedObservable.addOnce(()=>{h()})):h()},500):h()}this._startTime=c,this.isPlaying=!0,this.isPaused=!1}catch(c){V.Error("Error while trying to play audio: "+this.name+", "+c.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(t){var i;if(this.isPlaying){if(this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource.disconnect(),this.isPlaying=!1;else if((null===(i=ee.audioEngine)||void 0===i?void 0:i.audioContext)&&this._soundSource){const s=t?ee.audioEngine.audioContext.currentTime+t:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(s)}}else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){var t;this.isPlaying&&(this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource.disconnect(),this.isPlaying=!1,this.isPaused=!0):(null===(t=ee.audioEngine)||void 0===t?void 0:t.audioContext)&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=ee.audioEngine.audioContext.currentTime-this._startTime))}setVolume(t,i){var s;(null===(s=ee.audioEngine)||void 0===s?void 0:s.canUseWebAudio)&&this._soundGain&&(i&&ee.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(ee.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,ee.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(t,ee.audioEngine.audioContext.currentTime+i)):this._soundGain.gain.value=t),this._volume=t}setPlaybackRate(t){this._playbackRate=t,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(t){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=t,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=i=>this._onRegisterAfterWorldMatrixUpdate(i),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(t){var i;if(t.getBoundingInfo){const n=t.getBoundingInfo();this.setPosition(n.boundingSphere.centerWorld)}else this.setPosition(t.absolutePosition);(null===(i=ee.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{const t=()=>{this._isReadyToPlay?(s._audioBuffer=this.getAudioBuffer(),s._isReadyToPlay=!0,s.autoplay&&s.play(0,this._offset,this._length)):setTimeout(t,300)},i={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},s=new r(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,i);return this.useCustomAttenuation&&s.setAttenuationFunction(this._customAttenuationFunction),s.setPosition(this._position),s.setPlaybackRate(this._playbackRate),t(),s}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){const t={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(t.connectedMeshId=this._connectedTransformNode.id),t.position=this._position.asArray(),t.refDistance=this.refDistance,t.distanceModel=this.distanceModel,t.isDirectional=this._isDirectional,t.localDirectionToMesh=this._localDirection.asArray(),t.coneInnerAngle=this._coneInnerAngle,t.coneOuterAngle=this._coneOuterAngle,t.coneOuterGain=this._coneOuterGain),t}static Parse(t,i,s,n){const o=t.name;let a;a=t.url?s+t.url:s+o;const l={autoplay:t.autoplay,loop:t.loop,volume:t.volume,spatialSound:t.spatialSound,maxDistance:t.maxDistance,rolloffFactor:t.rolloffFactor,refDistance:t.refDistance,distanceModel:t.distanceModel,playbackRate:t.playbackRate};let c;if(n){const h=()=>{n._isReadyToPlay?(c._audioBuffer=n.getAudioBuffer(),c._isReadyToPlay=!0,c.autoplay&&c.play(0,c._offset,c._length)):setTimeout(h,300)};c=new r(o,new ArrayBuffer(0),i,null,l),h()}else c=new r(o,a,i,()=>{i.removePendingData(c)},l),i.addPendingData(c);if(t.position){const h=v.FromArray(t.position);c.setPosition(h)}if(t.isDirectional&&(c.setDirectionalCone(t.coneInnerAngle||360,t.coneOuterAngle||360,t.coneOuterGain||0),t.localDirectionToMesh)){const h=v.FromArray(t.localDirectionToMesh);c.setLocalDirectionToMesh(h)}if(t.connectedMeshId){const h=i.getMeshById(t.connectedMeshId);h&&c.attachToMesh(h)}return t.metadata&&(c.metadata=t.metadata),c}_setOffset(t){this._offset!==t&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=t)}}return r._SceneComponentInitialization=e=>{throw Ge("AudioSceneComponent")},r})();class pse{constructor(e,t={}){this.id=-1,this._isInitialized=!1,(e=e||be.LastCreatedScene)&&(this._scene=e,this.soundCollection=new Array,this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){var e;(null===(e=ee.audioEngine)||void 0===e?void 0:e.canUseWebAudio)&&ee.audioEngine.audioContext&&(this._outputAudioNode=ee.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(ee.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(ee.audioEngine&&ee.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){var t;this._isInitialized||this._initializeSoundTrackAudioGraph(),(null===(t=ee.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),e.soundTrackId&&(-1===e.soundTrackId?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){const t=this.soundCollection.indexOf(e);-1!==t&&this.soundCollection.splice(t,1)}setVolume(e){var t;(null===(t=ee.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){var e;if(null!==(e=ee.audioEngine)&&void 0!==e&&e.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){var e;if(null!==(e=ee.audioEngine)&&void 0!==e&&e.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToEqualPower()}connectToAnalyser(e){var t;this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,(null===(t=ee.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,ee.audioEngine.masterGain))}}es.AddParser(Me.NAME_AUDIO,(r,e,t,i)=>{var s;let o,n=[];if(t.sounds=t.sounds||[],null!=r.sounds)for(let a=0,l=r.sounds.length;a<l;a++){const c=r.sounds[a];null!==(s=ee.audioEngine)&&void 0!==s&&s.canUseWebAudio?(c.url||(c.url=c.name),n[c.url]?t.sounds.push(mp.Parse(c,e,i,n[c.url])):(o=mp.Parse(c,e,i),n[c.url]=o,t.sounds.push(o))):t.sounds.push(new mp(c.name,null,e))}n=[]}),Object.defineProperty(ge.prototype,"mainSoundTrack",{get:function(){let r=this._getComponent(Me.NAME_AUDIO);return r||(r=new Kr(this),this._addComponent(r)),this._mainSoundTrack||(this._mainSoundTrack=new pse(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0}),ge.prototype.getSoundByName=function(r){let e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++)if(this.mainSoundTrack.soundCollection[e].name===r)return this.mainSoundTrack.soundCollection[e];if(this.soundTracks)for(let t=0;t<this.soundTracks.length;t++)for(e=0;e<this.soundTracks[t].soundCollection.length;e++)if(this.soundTracks[t].soundCollection[e].name===r)return this.soundTracks[t].soundCollection[e];return null},Object.defineProperty(ge.prototype,"audioEnabled",{get:function(){let r=this._getComponent(Me.NAME_AUDIO);return r||(r=new Kr(this),this._addComponent(r)),r.audioEnabled},set:function(r){let e=this._getComponent(Me.NAME_AUDIO);e||(e=new Kr(this),this._addComponent(e)),r?e.enableAudio():e.disableAudio()},enumerable:!0,configurable:!0}),Object.defineProperty(ge.prototype,"headphone",{get:function(){let r=this._getComponent(Me.NAME_AUDIO);return r||(r=new Kr(this),this._addComponent(r)),r.headphone},set:function(r){let e=this._getComponent(Me.NAME_AUDIO);e||(e=new Kr(this),this._addComponent(e)),r?e.switchAudioModeForHeadphones():e.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0}),Object.defineProperty(ge.prototype,"audioListenerPositionProvider",{get:function(){let r=this._getComponent(Me.NAME_AUDIO);return r||(r=new Kr(this),this._addComponent(r)),r.audioListenerPositionProvider},set:function(r){let e=this._getComponent(Me.NAME_AUDIO);if(e||(e=new Kr(this),this._addComponent(e)),"function"!=typeof r)throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");e.audioListenerPositionProvider=r},enumerable:!0,configurable:!0}),Object.defineProperty(ge.prototype,"audioListenerRotationProvider",{get:function(){let r=this._getComponent(Me.NAME_AUDIO);return r||(r=new Kr(this),this._addComponent(r)),r.audioListenerRotationProvider},set:function(r){let e=this._getComponent(Me.NAME_AUDIO);if(e||(e=new Kr(this),this._addComponent(e)),"function"!=typeof r)throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");e.audioListenerRotationProvider=r},enumerable:!0,configurable:!0}),Object.defineProperty(ge.prototype,"audioPositioningRefreshRate",{get:function(){let r=this._getComponent(Me.NAME_AUDIO);return r||(r=new Kr(this),this._addComponent(r)),r.audioPositioningRefreshRate},set:function(r){let e=this._getComponent(Me.NAME_AUDIO);e||(e=new Kr(this),this._addComponent(e)),e.audioPositioningRefreshRate=r},enumerable:!0,configurable:!0});class Kr{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){this.name=Me.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new v,this._cachedCameraPosition=new v,this._lastCheck=0,this._invertMatrixTemp=new F,this._cameraDirectionTemp=new v,(e=e||be.LastCreatedScene)&&(this.scene=e,e.soundTracks=new Array,e.sounds=new Array)}register(){this.scene._afterRenderStage.registerStep(Me.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){const i=this.scene.soundTracks[t];for(let s=0;s<i.soundCollection.length;s++)e.sounds.push(i.soundCollection[s].serialize())}}addFromContainer(e){!e.sounds||e.sounds.forEach(t=>{t.play(),t.autoplay=!0,this.scene.mainSoundTrack.addSound(t)})}removeFromContainer(e,t=!1){!e.sounds||e.sounds.forEach(i=>{i.stop(),i.autoplay=!1,this.scene.mainSoundTrack.removeSound(i),t&&i.dispose()})}dispose(){const e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){const e=this.scene;let t;for(this._audioEnabled=!1,ee.audioEngine&&ee.audioEngine.audioContext&&ee.audioEngine.audioContext.suspend(),t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].pause()}enableAudio(){const e=this.scene;let t;for(this._audioEnabled=!0,ee.audioEngine&&ee.audioEngine.audioContext&&ee.audioEngine.audioContext.resume(),t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].isPaused&&e.soundTracks[t].soundCollection[i].play()}switchAudioModeForHeadphones(){const e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){const e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){const e=ir.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;const t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||0===t._mainSoundTrack.soundCollection.length&&1===t.soundTracks.length)return;const i=ee.audioEngine;if(i&&i.audioContext){let n,s=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(s=t.activeCameras[0]),this.audioListenerPositionProvider){const o=this.audioListenerPositionProvider();i.audioContext.listener.setPosition(o.x||0,o.y||0,o.z||0)}else s?this._cachedCameraPosition.equals(s.globalPosition)||(this._cachedCameraPosition.copyFrom(s.globalPosition),i.audioContext.listener.setPosition(s.globalPosition.x,s.globalPosition.y,s.globalPosition.z)):i.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){const o=this.audioListenerRotationProvider();i.audioContext.listener.setOrientation(o.x||0,o.y||0,o.z||0,0,1,0)}else s?(s.rigCameras&&s.rigCameras.length>0&&(s=s.rigCameras[0]),s.getViewMatrix().invertToRef(this._invertMatrixTemp),v.TransformNormalToRef(Kr._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),!isNaN(this._cameraDirectionTemp.x)&&!isNaN(this._cameraDirectionTemp.y)&&!isNaN(this._cameraDirectionTemp.z)&&(this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0)))):i.audioContext.listener.setOrientation(0,0,0,0,1,0);for(n=0;n<t.mainSoundTrack.soundCollection.length;n++){const o=t.mainSoundTrack.soundCollection[n];o.useCustomAttenuation&&o.updateDistanceFromListener()}if(t.soundTracks)for(n=0;n<t.soundTracks.length;n++)for(let o=0;o<t.soundTracks[n].soundCollection.length;o++){const a=t.soundTracks[n].soundCollection[o];a.useCustomAttenuation&&a.updateDistanceFromListener()}}}}Kr._CameraDirection=new v(0,0,-1),mp._SceneComponentInitialization=r=>{let e=r._getComponent(Me.NAME_AUDIO);e||(e=new Kr(r),r._addComponent(e))};class _se{constructor(e,t,i){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==i.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=i;let s=0;for(const o of i)s+=o;const n=s>0?1/s:0;for(let o=0;o<this._weights.length;o++)this._weights[o]*=n;this._sounds=t;for(const o of this._sounds)o.onEndedObservable.add(()=>{this._onended()})}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e)return void V.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneInnerAngle=e;for(const t of this._sounds)t.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle)return void V.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneOuterAngle=e;for(const t of this._sounds)t.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(const t of this._sounds)t.setVolume(e)}_onended(){void 0!==this._currentIndex&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPaused=!0,void 0!==this._currentIndex&&this._sounds[this._currentIndex].pause()}stop(){this.isPlaying=!1,void 0!==this._currentIndex&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();const i=Math.random();let s=0;for(let n=0;n<this._weights.length;n++)if(s+=this._weights[n],i<=s){this._currentIndex=n;break}}const t=this._sounds[this._currentIndex];t.isReady()?t.play(0,this.isPaused?void 0:e):t.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}}class Wu{constructor(e){this._texture=null,this._isEnabled=!0,this.isEnabled=!0,this.time=0,(e=e||be.LastCreatedScene)&&(this._scene=e,this.animationParameters=new vt(0,0,0,30))}_markSubMeshesAsAttributesDirty(){for(const e of this._scene.meshes)e.bakedVertexAnimationManager===this&&e._markSubMeshesAsAttributesDirty()}bind(e,t=!1){if(!this._texture||!this._isEnabled)return;const i=this._texture.getSize();e.setFloat2("bakedVertexAnimationTextureSizeInverted",1/i.width,1/i.height),e.setFloat("bakedVertexAnimationTime",this.time),t||e.setVector4("bakedVertexAnimationSettings",this.animationParameters),e.setTexture("bakedVertexAnimationTexture",this._texture)}clone(){const e=new Wu(this._scene);return this.copyTo(e),e}setAnimationParameters(e,t,i=0,s=30){this.animationParameters=new vt(e,t,i,s)}dispose(e){var t;e&&(null===(t=this._texture)||void 0===t||t.dispose())}getClassName(){return"BakedVertexAnimationManager"}copyTo(e){Ce.Clone(()=>e,this)}serialize(){return Ce.Serialize(this)}parse(e,t,i){Ce.Parse(()=>this,e,t,i)}}E([ht(),ne("_markSubMeshesAsAttributesDirty")],Wu.prototype,"texture",void 0),E([I(),ne("_markSubMeshesAsAttributesDirty")],Wu.prototype,"isEnabled",void 0),E([I()],Wu.prototype,"animationParameters",void 0),E([I()],Wu.prototype,"time",void 0);class ih{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return!!this._texture&&this._texture.isCube}set isCube(e){!this._texture||(this._texture.isCube=e)}get is3D(){return!!this._texture&&this._texture.is3D}set is3D(e){!this._texture||(this._texture.is3D=e)}get is2DArray(){return!!this._texture&&this._texture.is2DArray}set is2DArray(e){!this._texture||(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return void 0!==e?._shareDepth}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=Vn.Zero(),this._cachedBaseSize=Vn.Zero(),this._initialSamplingMode=2,this._texture=ih._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine())}isReady(){return 4===this.delayLoadState?(this.delayLoad(),!1):!!this._texture&&this._texture.isReady}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return this.isReady()&&this._texture?this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize):(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}class kt extends ih{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return!!this._texture&&this._texture.is3D}set is3D(e){!this._texture||(this._texture.is3D=e)}get is2DArray(){return!!this._texture&&this._texture.is2DArray}set is2DArray(e){!this._texture||(this._texture.is2DArray=e)}get gammaSpace(){return this._texture?(null===this._texture._gammaSpace&&(this._texture._gammaSpace=this._gammaSpace),this._texture._gammaSpace&&!this._texture._useSRGBBuffer):this._gammaSpace}set gammaSpace(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}this._markAllSubMeshesAsTexturesDirty()}get isRGBD(){return null!=this._texture&&this._texture._isRGBD}set isRGBD(e){this._texture&&(this._texture._isRGBD=e)}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return!!this._texture&&this._texture._linearSpecularLOD}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=Qg()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=kt.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=new Array,this.onDisposeObservable=new z,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?kt._IsScene(e)?this._scene=e:this._engine=e:this._scene=be.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}checkTransformsAreIdentical(e){return null!==e}getTextureMatrix(){return F.IdentityReadOnly}getReflectionTextureMatrix(){return F.IdentityReadOnly}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,i,s,n,o){const a=this._getEngine();if(!a)return null;const l=a._getUseSRGBBuffer(!!n,t),c=a.getLoadedTexturesCache();for(let h=0;h<c.length;h++){const u=c[h];if(!(void 0!==n&&l!==u._useSRGBBuffer||void 0!==s&&s!==u.invertY||u.url!==e||u.generateMipMaps!==!t||i&&i!==u.samplingMode||void 0!==o&&o!==u.isCube))return u.incrementReferences(),u}return null}_rebuild(){}clone(){return null}get textureType(){return this._texture&&void 0!==this._texture.type?this._texture.type:0}get textureFormat(){return this._texture&&void 0!==this._texture.format?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();!e||e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,i=null,s=!0,n=!1,o=0,a=0,l=Number.MAX_VALUE,c=Number.MAX_VALUE){if(!this._texture)return null;const h=this._getEngine();if(!h)return null;const u=this.getSize();let d=u.width,f=u.height;0!==t&&(d/=Math.pow(2,t),f/=Math.pow(2,t),d=Math.round(d),f=Math.round(f)),l=Math.min(d,l),c=Math.min(f,c);try{return h._readTexturePixels(this._texture,l,c,this._texture.isCube?e:-1,t,i,s,n,o,a)}catch{return null}}_readPixelsSync(e=0,t=0,i=null,s=!0,n=!1){if(!this._texture)return null;const o=this.getSize();let a=o.width,l=o.height;const c=this._getEngine();if(!c)return null;0!=t&&(a/=Math.pow(2,t),l/=Math.pow(2,t),a=Math.round(a),l=Math.round(l));try{return c._readTexturePixelsSync(this._texture,a,l,this._texture.isCube?e:-1,t,i,s,n)}catch{return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const t=this._parentContainer.textures.indexOf(this);t>-1&&this._parentContainer.textures.splice(t,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;const t=Ce.Serialize(this);return Ce.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let i=e.length;if(0!==i)for(let s=0;s<e.length;s++){const n=e[s];if(n.isReady())0==--i&&t();else{const o=n.onLoadObservable;o?o.addOnce(()=>{0==--i&&t()}):0==--i&&t()}}else t()}static _IsScene(e){return"Scene"===e.getClassName()}}function RE(r,e,t=!1){const i=e.width,s=e.height;if(r instanceof Float32Array){let c=r.byteLength/r.BYTES_PER_ELEMENT;const h=new Uint8Array(c);for(;--c>=0;){let u=r[c];u<0?u=0:u>1&&(u=1),h[c]=255*u}r=h}const n=document.createElement("canvas");n.width=i,n.height=s;const o=n.getContext("2d");if(!o)return null;const a=o.createImageData(i,s);if(a.data.set(r),o.putImageData(a,0,0),t){const c=document.createElement("canvas");c.width=i,c.height=s;const h=c.getContext("2d");return h?(h.translate(0,s),h.scale(1,-1),h.drawImage(n,0,0),c.toDataURL("image/png")):null}return n.toDataURL("image/png")}function IE(){return IE=Qt(function*(r,e=0,t=0){const i=r.getInternalTexture();if(!i)return null;const s=yield r.readPixels(e,t);return s?RE(s,r.getSize(),i.invertY):null}),IE.apply(this,arguments)}kt.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,E([I()],kt.prototype,"uniqueId",void 0),E([I()],kt.prototype,"name",void 0),E([I()],kt.prototype,"metadata",void 0),E([I("hasAlpha")],kt.prototype,"_hasAlpha",void 0),E([I("getAlphaFromRGB")],kt.prototype,"_getAlphaFromRGB",void 0),E([I()],kt.prototype,"level",void 0),E([I("coordinatesIndex")],kt.prototype,"_coordinatesIndex",void 0),E([I()],kt.prototype,"optimizeUVAllocation",void 0),E([I("coordinatesMode")],kt.prototype,"_coordinatesMode",void 0),E([I()],kt.prototype,"wrapU",null),E([I()],kt.prototype,"wrapV",null),E([I()],kt.prototype,"wrapR",void 0),E([I()],kt.prototype,"anisotropicFilteringLevel",void 0),E([I()],kt.prototype,"isCube",null),E([I()],kt.prototype,"is3D",null),E([I()],kt.prototype,"is2DArray",null),E([I()],kt.prototype,"gammaSpace",null),E([I()],kt.prototype,"invertZ",void 0),E([I()],kt.prototype,"lodLevelInAlpha",void 0),E([I()],kt.prototype,"lodGenerationOffset",null),E([I()],kt.prototype,"lodGenerationScale",null),E([I()],kt.prototype,"linearSpecularLOD",null),E([ht()],kt.prototype,"irradianceTexture",null),E([I()],kt.prototype,"isRenderTarget",void 0);class U extends kt{get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,t,i,s,n=U.TRILINEAR_SAMPLINGMODE,o=null,a=null,l=null,c=!1,h,u,d,f,p){var _,m,g,b,y,T,x,S,C;super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new z,this._isBlocking=!0,this.name=e||"",this.url=e;let D,P=!1,M=null;"object"==typeof i&&null!==i?(D=null!==(_=i.noMipmap)&&void 0!==_&&_,s=null!==(m=i.invertY)&&void 0!==m?m:!It.UseOpenGLOrientationForUV,n=null!==(g=i.samplingMode)&&void 0!==g?g:U.TRILINEAR_SAMPLINGMODE,o=null!==(b=i.onLoad)&&void 0!==b?b:null,a=null!==(y=i.onError)&&void 0!==y?y:null,l=null!==(T=i.buffer)&&void 0!==T?T:null,c=null!==(x=i.deleteBuffer)&&void 0!==x&&x,h=i.format,u=i.mimeType,d=i.loaderOptions,f=i.creationFlags,P=null!==(S=i.useSRGBBuffer)&&void 0!==S&&S,M=null!==(C=i.internalTexture)&&void 0!==C?C:null):D=!!i,this._noMipmap=D,this._invertY=void 0===s?!It.UseOpenGLOrientationForUV:s,this._initialSamplingMode=n,this._buffer=l,this._deleteBuffer=c,this._mimeType=u,this._loaderOptions=d,this._creationFlags=f,this._useSRGBBuffer=P,this._forcedExtension=p,h&&(this._format=h);const w=this.getScene(),k=this._getEngine();if(!k)return;k.onBeforeTextureInitObservable.notifyObservers(this);const X=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),null!==this._texture._cachedWrapU&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),null!==this._texture._cachedWrapV&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),null!==this._texture._cachedWrapR&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),o&&o(),!this.isBlocking&&w&&w.resetCachedMaterial()},te=(J,Q)=>{this._loadingError=!0,this._errorObject={message:J,exception:Q},a&&a(J,Q),U.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!M)return this._delayedOnLoad=X,void(this._delayedOnError=te);if(this._texture=M??this._getFromCache(this.url,D,n,this._invertY,P),this._texture)if(this._texture.isReady)ku.SetImmediate(()=>X());else{const J=this._texture.onLoadedObservable.add(X);this._texture.onErrorObservable.add(Q=>{var me;te(Q.message,Q.exception),null===(me=this._texture)||void 0===me||me.onLoadedObservable.remove(J)})}else if(w&&w.useDelayedTextureLoading)this.delayLoadState=4,this._delayedOnLoad=X,this._delayedOnError=te;else{try{this._texture=k.createTexture(this.url,D,this._invertY,w,n,X,te,this._buffer,void 0,this._format,this._forcedExtension,u,d,f,P)}catch(J){throw te("error loading",J),J}c&&(this._buffer=null)}}updateURL(e,t=null,i,s){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1)),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=s,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(4!==this.delayLoadState)return;const e=this.getScene();!e||(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer),this._texture?this._delayedOnLoad&&(this._texture.isReady?ku.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,i,s){e*=this._cachedUScale,t*=this._cachedVScale,v.TransformCoordinatesFromFloatsToRef(e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,this._rowGenerationMatrix,s),s.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,s.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,s.z+=this.wRotationCenter}checkTransformsAreIdentical(e){return null!==e&&this.uOffset===e.uOffset&&this.vOffset===e.vOffset&&this.uScale===e.uScale&&this.vScale===e.vScale&&this.uAng===e.uAng&&this.vAng===e.vAng&&this.wAng===e.wAng}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=F.Zero(),this._rowGenerationMatrix=new F,this._t0=v.Zero(),this._t1=v.Zero(),this._t2=v.Zero()),F.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(F.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,L.Matrix[0]),F.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,L.Matrix[1]),F.ScalingToRef(this._cachedUScale,this._cachedVScale,0,L.Matrix[2]),F.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,L.Matrix[3]),L.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(L.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(L.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(L.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),F.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const t=this.getScene();return t?(this.optimizeUVAllocation&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)),this._cachedTextureMatrix):this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode){if(this.coordinatesMode!==U.PROJECTION_MODE)return this._cachedReflectionTextureMatrix;if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=F.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=F.Zero());const t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case U.PLANAR_MODE:F.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break;case U.PROJECTION_MODE:{F.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const i=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=i.updateFlag,i.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:F.IdentityToRef(this._cachedReflectionTextureMatrix)}return t&&e.markAllMaterialsAsDirty(1,i=>-1!==i.getActiveTextures().indexOf(this)),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return Ce.Clone(()=>new U(this._texture?this._texture.url:null,this.getScene(),e),this)}serialize(){var e,t;const i=this.name;U.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const s=super.serialize(U._SerializeInternalTextureUniqueId);return s?((U.SerializeBuffers||U.ForceSerializeBuffers)&&("string"==typeof this._buffer&&"data:"===this._buffer.substr(0,5)?(s.base64String=this._buffer,s.name=s.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?s.base64String="data:image/png;base64,"+aE(this._buffer):(U.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(s.base64String=!this._engine||this._engine._features.supportSyncTextureRead?function C1(r,e=0,t=0){const i=r.getInternalTexture();if(!i)return null;const s=r._readPixelsSync(e,t);return s?RE(s,r.getSize(),i.invertY):null}(this):function A1(r){return IE.apply(this,arguments)}(this))),s.invertY=this._invertY,s.samplingMode=this.samplingMode,s._creationFlags=this._creationFlags,s._useSRGBBuffer=this._useSRGBBuffer,U._SerializeInternalTextureUniqueId&&(s.internalTextureUniqueId=null!==(t=null===(e=this._texture)||void 0===e?void 0:e.uniqueId)&&void 0!==t?t:void 0),this.name=i,s):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,t,i){if(e.customType){const c=Kg.Instantiate(e.customType).Parse(e,t,i);return e.samplingMode&&c.updateSamplingMode&&c._samplingMode&&c._samplingMode!==e.samplingMode&&c.updateSamplingMode(e.samplingMode),c}if(e.isCube&&!e.isRenderTarget)return U._CubeTextureParser(e,t,i);const s=void 0!==e.internalTextureUniqueId;if(!e.name&&!e.isRenderTarget&&!s)return null;let n;if(s){const l=t.getEngine().getLoadedTexturesCache();for(const c of l)if(c.uniqueId===e.internalTextureUniqueId){n=c;break}}const o=l=>{var c;if(l&&l._texture&&(l._texture._cachedWrapU=null,l._texture._cachedWrapV=null,l._texture._cachedWrapR=null),e.samplingMode){const h=e.samplingMode;l&&l.samplingMode!==h&&l.updateSamplingMode(h)}if(l&&e.animations)for(let h=0;h<e.animations.length;h++){const u=e.animations[h],d=hs("BABYLON.Animation");d&&l.animations.push(d.Parse(u))}s&&!n&&(null===(c=l?._texture)||void 0===c||c._setUniqueId(e.internalTextureUniqueId))};return Ce.Parse(()=>{var l,c,h;let u=!0;if(e.noMipmap&&(u=!1),e.mirrorPlane){const d=U._CreateMirror(e.name,e.renderTargetSize,t,u);return d._waitingRenderList=e.renderList,d.mirrorPlane=Dr.FromArray(e.mirrorPlane),o(d),d}if(e.isRenderTarget){let d=null;if(e.isCube){if(t.reflectionProbes)for(let f=0;f<t.reflectionProbes.length;f++){const p=t.reflectionProbes[f];if(p.name===e.name)return p.cubeTexture}}else d=U._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,u,null!==(l=e._creationFlags)&&void 0!==l?l:0),d._waitingRenderList=e.renderList;return o(d),d}{let d;if(e.base64String&&!n)d=U.CreateFromBase64String(e.base64String,e.base64String,t,!u,e.invertY,e.samplingMode,()=>{o(d)},null!==(c=e._creationFlags)&&void 0!==c?c:0,null!==(h=e._useSRGBBuffer)&&void 0!==h&&h),d.name=e.name;else{let f;f=e.name&&e.name.indexOf("://")>0?e.name:i+e.name,e.url&&(e.url.startsWith("data:")||U.UseSerializedUrlIfAny)&&(f=e.url),d=new U(f,t,{noMipmap:!u,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{o(d)},internalTexture:n})}return d}},e,t)}static CreateFromBase64String(e,t,i,s,n,o=U.TRILINEAR_SAMPLINGMODE,a=null,l=null,c=5,h){return new U("data:"+t,i,s,n,o,a,l,e,!1,c,void 0,void 0,h)}static LoadFromDataString(e,t,i,s=!1,n,o=!0,a=U.TRILINEAR_SAMPLINGMODE,l=null,c=null,h=5,u){return"data:"!==e.substr(0,5)&&(e="data:"+e),new U(e,i,n,o,a,l,c,t,s,h,void 0,void 0,u)}}function R1(r,e,t,i){let s,n=1;1===i?s=new Float32Array(e*t*4):2===i?(s=new Uint16Array(e*t*4),n=15360):s=7===i?new Uint32Array(e*t*4):new Uint8Array(e*t*4);for(let o=0;o<e;o++)for(let a=0;a<t;a++){const l=3*(a*e+o),c=4*(a*e+o);s[c+0]=r[l+0],s[c+1]=r[l+1],s[c+2]=r[l+2],s[c+3]=n}return s}function I1(r){return function(e,t,i,s,n,o,a,l,c=null,h=0){const u=r?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,f=new zt(this,r?Ye.Raw3D:Ye.Raw2DArray);f.baseWidth=t,f.baseHeight=i,f.baseDepth=s,f.width=t,f.height=i,f.depth=s,f.format=n,f.type=h,f.generateMipMaps=o,f.samplingMode=l,r?f.is3D=!0:f.is2DArray=!0,this._doNotHandleContextLost||(f._bufferView=e),r?this.updateRawTexture3D(f,e,n,a,c,h):this.updateRawTexture2DArray(f,e,n,a,c,h),this._bindTextureDirectly(u,f,!0);const p=this._getSamplingParameters(l,o);return this._gl.texParameteri(u,this._gl.TEXTURE_MAG_FILTER,p.mag),this._gl.texParameteri(u,this._gl.TEXTURE_MIN_FILTER,p.min),o&&this._gl.generateMipmap(u),this._bindTextureDirectly(u,null),this._internalTexturesCache.push(f),f}}function M1(r){return function(e,t,i,s,n=null,o=0){const a=r?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(o),c=this._getInternalFormat(i),h=this._getRGBABufferInternalSizedFormat(o,i);this._bindTextureDirectly(a,e,!0),this._unpackFlipY(void 0===s||!!s),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=s,e._compression=n),e.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&t?this._gl.compressedTexImage3D(a,0,this.getCaps().s3tc[n],e.width,e.height,e.depth,0,t):this._gl.texImage3D(a,0,h,e.width,e.height,e.depth,0,c,l,t),e.generateMipMaps&&this._gl.generateMipmap(a),this._bindTextureDirectly(a,null),e.isReady=!0}}U.SerializeBuffers=!0,U.ForceSerializeBuffers=!1,U.OnTextureLoadErrorObservable=new z,U._SerializeInternalTextureUniqueId=!1,U._CubeTextureParser=(r,e,t)=>{throw Ge("CubeTexture")},U._CreateMirror=(r,e,t,i)=>{throw Ge("MirrorTexture")},U._CreateRenderTargetTexture=(r,e,t,i,s)=>{throw Ge("RenderTargetTexture")},U.NEAREST_SAMPLINGMODE=1,U.NEAREST_NEAREST_MIPLINEAR=8,U.BILINEAR_SAMPLINGMODE=2,U.LINEAR_LINEAR_MIPNEAREST=11,U.TRILINEAR_SAMPLINGMODE=3,U.LINEAR_LINEAR_MIPLINEAR=3,U.NEAREST_NEAREST_MIPNEAREST=4,U.NEAREST_LINEAR_MIPNEAREST=5,U.NEAREST_LINEAR_MIPLINEAR=6,U.NEAREST_LINEAR=7,U.NEAREST_NEAREST=1,U.LINEAR_NEAREST_MIPNEAREST=9,U.LINEAR_NEAREST_MIPLINEAR=10,U.LINEAR_LINEAR=2,U.LINEAR_NEAREST=12,U.EXPLICIT_MODE=0,U.SPHERICAL_MODE=1,U.PLANAR_MODE=2,U.CUBIC_MODE=3,U.PROJECTION_MODE=4,U.SKYBOX_MODE=5,U.INVCUBIC_MODE=6,U.EQUIRECTANGULAR_MODE=7,U.FIXED_EQUIRECTANGULAR_MODE=8,U.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,U.CLAMP_ADDRESSMODE=0,U.WRAP_ADDRESSMODE=1,U.MIRROR_ADDRESSMODE=2,U.UseSerializedUrlIfAny=!1,E([I()],U.prototype,"url",void 0),E([I()],U.prototype,"uOffset",void 0),E([I()],U.prototype,"vOffset",void 0),E([I()],U.prototype,"uScale",void 0),E([I()],U.prototype,"vScale",void 0),E([I()],U.prototype,"uAng",void 0),E([I()],U.prototype,"vAng",void 0),E([I()],U.prototype,"wAng",void 0),E([I()],U.prototype,"uRotationCenter",void 0),E([I()],U.prototype,"vRotationCenter",void 0),E([I()],U.prototype,"wRotationCenter",void 0),E([I()],U.prototype,"homogeneousRotationInUVTransform",void 0),E([I()],U.prototype,"isBlocking",null),le("BABYLON.Texture",U),Ce._TextureParser=U.Parse,we.prototype.updateRawTexture=function(r,e,t,i,s=null,n=0,o=!1){if(!r)return;const a=this._getRGBABufferInternalSizedFormat(n,t,o),l=this._getInternalFormat(t),c=this._getWebGLTextureType(n);this._bindTextureDirectly(this._gl.TEXTURE_2D,r,!0),this._unpackFlipY(void 0===i||!!i),this._doNotHandleContextLost||(r._bufferView=e,r.format=t,r.type=n,r.invertY=i,r._compression=s),r.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[s],r.width,r.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,a,r.width,r.height,0,l,c,e),r.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),r.isReady=!0},we.prototype.createRawTexture=function(r,e,t,i,s,n,o,a=null,l=0,c=0,h=!1){const u=new zt(this,Ye.Raw);u.baseWidth=e,u.baseHeight=t,u.width=e,u.height=t,u.format=i,u.generateMipMaps=s,u.samplingMode=o,u.invertY=n,u._compression=a,u.type=l,u._useSRGBBuffer=this._getUseSRGBBuffer(h,!s),this._doNotHandleContextLost||(u._bufferView=r),this.updateRawTexture(u,r,i,n,a,l,u._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,u,!0);const d=this._getSamplingParameters(o,s);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,d.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,d.min),s&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(u),u},we.prototype.createRawCubeTexture=function(r,e,t,i,s,n,o,a=null){const l=this._gl,c=new zt(this,Ye.CubeRaw);c.isCube=!0,c.format=t,c.type=i,this._doNotHandleContextLost||(c._bufferViewArray=r);const h=this._getWebGLTextureType(i);let u=this._getInternalFormat(t);u===l.RGB&&(u=l.RGBA),h!==l.FLOAT||this._caps.textureFloatLinearFiltering?h!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?h!==l.FLOAT||this._caps.textureFloatRender?h===l.HALF_FLOAT&&!this._caps.colorBufferFloat&&(s=!1,V.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(s=!1,V.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(s=!1,o=1,V.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(s=!1,o=1,V.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const f=e;if(c.width=e,c.height=f,c.invertY=n,c._compression=a,!this.needPOTTextures||q.IsExponentOfTwo(c.width)&&q.IsExponentOfTwo(c.height)||(s=!1),r)this.updateRawCubeTexture(c,r,t,i,n,a);else{const m=this._getRGBABufferInternalSizedFormat(i),g=0;this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,c,!0);for(let b=0;b<6;b++)a?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+b,g,this.getCaps().s3tc[a],c.width,c.height,0,void 0):l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+b,g,m,c.width,c.height,0,u,h,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,c,!0),r&&s&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const _=this._getSamplingParameters(o,s);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,_.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,_.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),c.generateMipMaps=s,c.samplingMode=o,c.isReady=!0,c},we.prototype.updateRawCubeTexture=function(r,e,t,i,s,n=null,o=0){r._bufferViewArray=e,r.format=t,r.type=i,r.invertY=s,r._compression=n;const a=this._gl,l=this._getWebGLTextureType(i);let c=this._getInternalFormat(t);const h=this._getRGBABufferInternalSizedFormat(i);let u=!1;c===a.RGB&&(c=a.RGBA,u=!0),this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,r,!0),this._unpackFlipY(void 0===s||!!s),r.width%4!=0&&a.pixelStorei(a.UNPACK_ALIGNMENT,1);for(let f=0;f<6;f++){let p=e[f];n?a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+f,o,this.getCaps().s3tc[n],r.width,r.height,0,p):(u&&(p=R1(p,r.width,r.height,i)),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+f,o,h,r.width,r.height,0,c,l,p))}(!this.needPOTTextures||q.IsExponentOfTwo(r.width)&&q.IsExponentOfTwo(r.height))&&r.generateMipMaps&&0===o&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),r.isReady=!0},we.prototype.createRawCubeTextureFromUrl=function(r,e,t,i,s,n,o,a,l=null,c=null,h=3,u=!1){const d=this._gl,f=this.createRawCubeTexture(null,t,i,s,!n,u,h,null);e?.addPendingData(f),f.url=r,this._internalTexturesCache.push(f);const _=m=>{const g=f.width,b=o(m);if(b){if(a){const y=this._getWebGLTextureType(s);let T=this._getInternalFormat(i);const x=this._getRGBABufferInternalSizedFormat(s);let S=!1;T===d.RGB&&(T=d.RGBA,S=!0),this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,f,!0),this._unpackFlipY(!1);const C=a(b);for(let D=0;D<C.length;D++){const P=g>>D;for(let M=0;M<6;M++){let w=C[D][M];S&&(w=R1(w,P,P,s)),d.texImage2D(M,D,x,P,P,0,T,y,w)}}this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(f,b,i,s,u);f.isReady=!0,e?.removePendingData(f),f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),l&&l()}};return this._loadFile(r,m=>{_(m)},void 0,e?.offlineProvider,!0,(m,g)=>{e?.removePendingData(f),c&&m&&c(m.status+" "+m.statusText,g)}),f},we.prototype.createRawTexture2DArray=I1(!1),we.prototype.createRawTexture3D=I1(!0),we.prototype.updateRawTexture2DArray=M1(!1),we.prototype.updateRawTexture3D=M1(!0);class pr extends U{constructor(e,t,i,s,n,o=!0,a=!1,l=3,c=0,h,u){super(null,n,!o,a,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,h),this.format=s,this._engine&&(!this._engine._caps.textureFloatLinearFiltering&&1===c&&(l=1),!this._engine._caps.textureHalfFloatLinearFiltering&&2===c&&(l=1),this._texture=this._engine.createRawTexture(e,t,i,s,o,a,l,null,c,h??0,u??!1),this.wrapU=U.CLAMP_ADDRESSMODE,this.wrapV=U.CLAMP_ADDRESSMODE)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)}static CreateLuminanceTexture(e,t,i,s,n=!0,o=!1,a=3){return new pr(e,t,i,1,s,n,o,a)}static CreateLuminanceAlphaTexture(e,t,i,s,n=!0,o=!1,a=3){return new pr(e,t,i,2,s,n,o,a)}static CreateAlphaTexture(e,t,i,s,n=!0,o=!1,a=3){return new pr(e,t,i,0,s,n,o,a)}static CreateRGBTexture(e,t,i,s,n=!0,o=!1,a=3,l=0,c=0,h=!1){return new pr(e,t,i,4,s,n,o,a,l,c,h)}static CreateRGBATexture(e,t,i,s,n=!0,o=!1,a=3,l=0,c=0,h=!1){return new pr(e,t,i,5,s,n,o,a,l,c,h)}static CreateRGBAStorageTexture(e,t,i,s,n=!0,o=!1,a=3,l=0,c=!1){return new pr(e,t,i,5,s,n,o,a,l,1,c)}static CreateRTexture(e,t,i,s,n=!0,o=!1,a=U.TRILINEAR_SAMPLINGMODE,l=1){return new pr(e,t,i,6,s,n,o,a,l)}static CreateRStorageTexture(e,t,i,s,n=!0,o=!1,a=U.TRILINEAR_SAMPLINGMODE,l=1){return new pr(e,t,i,6,s,n,o,a,l,1)}}class mse{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{i.type!==Re.POINTERDOWN?i.type===Re.POINTERUP&&(this._isPointerDown=!1):this._isPointerDown=!0}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{if(this._reachTargetAlpha())return;const i=ir.Now;let s=0;null!=this._lastFrameTime&&(s=i-this._lastFrameTime),this._lastFrameTime=i,this._applyUserInteraction();const o=Math.max(Math.min((i-this._lastInteractionTime-this._idleRotationWaitTime)/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*o,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(s/1e3))})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null}resetLastInteractionTime(e){this._lastInteractionTime=e??ir.Now}_reachTargetAlpha(){return!(!this._attachedCamera||!this.targetAlpha)&&Math.abs(this._attachedCamera.alpha-this.targetAlpha)<ot}_userIsZooming(){return!!this._attachedCamera&&0!==this._attachedCamera.inertialRadiusOffset}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&0!==this._attachedCamera.inertialRadiusOffset&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=ir.Now)}_userIsMoving(){return!!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)}}class sh{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;const t=this._attachedCamera;!t||(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add(i=>{if(!i)return;i.computeWorldMatrix(!0);const s=i.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=.05*s,this.upperRadiusTransitionRange=.05*s}):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{!this._attachedCamera||(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))})}detach(){!this._attachedCamera||(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return!!this._attachedCamera&&this._attachedCamera.radius===e&&!this._radiusIsAnimating}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(sh.EasingFunction.setEasingMode(sh.EasingMode),this._radiusBounceTransition=$.CreateAnimation("radius",$.ANIMATIONTYPE_FLOAT,60,sh.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;const t=$.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,()=>this._clearAnimationLocks());t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}}sh.EasingFunction=new class $ie extends Bo{constructor(e=1){super(),this.amplitude=e}easeInCore(e){const t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)}}(.3),sh.EasingMode=Bo.EASINGMODE_EASEOUT;class Qr{constructor(){this.onTargetFramingAnimationEndObservable=new z,this._mode=Qr.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();Qr.EasingFunction.setEasingMode(Qr.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{i.type!==Re.POINTERDOWN?i.type===Re.POINTERUP&&(this._isPointerDown=!1):this._isPointerDown=!0}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(i=>{i&&this.zoomOnMesh(i,void 0,()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()})}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);const s=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(s.minimumWorld,s.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);const s=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(s.min,s.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){const s=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new v(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let o=0;o<e.length;o++){const a=e[o].getHierarchyBoundingVectors(!0);v.CheckExtends(a.min,s,n),v.CheckExtends(a.max,s,n)}this.zoomOnBoundingInfo(s,n,t,i)}zoomOnBoundingInfo(e,t,i=!1,s=null){let n;if(!this._attachedCamera)return;const o=e.y,l=o+(t.y-o)*this._positionScale,c=t.subtract(e).scale(.5);if(i)n=new v(0,l,0);else{const d=e.add(c);n=new v(d.x,l,d.z)}this._vectorTransition||(this._vectorTransition=$.CreateAnimation("target",$.ANIMATIONTYPE_VECTOR3,60,Qr.EasingFunction)),this._betaIsAnimating=!0;let h=$.TransitionTo("target",n,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);h&&this._animatables.push(h);let u=0;if(this._mode===Qr.FitFrustumSidesMode){const d=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=c.length()+this._attachedCamera.minZ),u=d}else this._mode===Qr.IgnoreBoundsSizeMode&&(u=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&null===this._attachedCamera.lowerRadiusLimit&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){const d=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/d,this._attachedCamera.wheelPrecision=100/u}this._radiusTransition||(this._radiusTransition=$.CreateAnimation("radius",$.ANIMATIONTYPE_FLOAT,60,Qr.EasingFunction)),h=$.TransitionTo("radius",u,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,()=>{this.stopAllAnimations(),s&&s(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()}),h&&this._animatables.push(h)}_calculateLowerRadiusFromModelBoundingSphere(e,t){const s=t.subtract(e).length(),n=this._getFrustumSlope(),a=.5*s*this._radiusScale,l=a*Math.sqrt(1+1/(n.x*n.x)),c=a*Math.sqrt(1+1/(n.y*n.y));let h=Math.max(l,c);const u=this._attachedCamera;return u?(u.lowerRadiusLimit&&this._mode===Qr.IgnoreBoundsSizeMode&&(h=h<u.lowerRadiusLimit?u.lowerRadiusLimit:h),u.upperRadiusLimit&&(h=h>u.upperRadiusLimit?u.upperRadiusLimit:h),h):0}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;const t=.5*Math.PI-this._defaultElevation,i=.5*Math.PI;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&ir.Now-this._lastInteractionTime>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=$.CreateAnimation("beta",$.ANIMATIONTYPE_FLOAT,60,Qr.EasingFunction));const s=$.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,()=>{this._clearAnimationLocks(),this.stopAllAnimations()});s&&this._animatables.push(s)}}_getFrustumSlope(){const e=this._attachedCamera;if(!e)return de.Zero();const i=e.getScene().getEngine().getAspectRatio(e),s=Math.tan(e.fov/2);return new de(s*i,s)}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=ir.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return!!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)}}Qr.EasingFunction=new class Kie extends Bo{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}},Qr.EasingMode=Bo.EASINGMODE_EASEINOUT,Qr.IgnoreBoundsSizeMode=0,Qr.FitFrustumSidesMode=1;class Qe{constructor(e,t,i=Number.MAX_VALUE){this.origin=e,this.direction=t,this.length=i}clone(){return new Qe(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){const s=Qe._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),n=Qe._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i);let l,c,h,u,o=0,a=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<s.x||this.origin.x>n.x)return!1}else if(l=1/this.direction.x,c=(s.x-this.origin.x)*l,h=(n.x-this.origin.x)*l,h===-1/0&&(h=1/0),c>h&&(u=c,c=h,h=u),o=Math.max(c,o),a=Math.min(h,a),o>a)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<s.y||this.origin.y>n.y)return!1}else if(l=1/this.direction.y,c=(s.y-this.origin.y)*l,h=(n.y-this.origin.y)*l,h===-1/0&&(h=1/0),c>h&&(u=c,c=h,h=u),o=Math.max(c,o),a=Math.min(h,a),o>a)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<s.z||this.origin.z>n.z)return!1}else if(l=1/this.direction.z,c=(s.z-this.origin.z)*l,h=(n.z-this.origin.z)*l,h===-1/0&&(h=1/0),c>h&&(u=c,c=h,h=u),o=Math.max(c,o),a=Math.min(h,a),o>a)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){const i=e.center.x-this.origin.x,s=e.center.y-this.origin.y,n=e.center.z-this.origin.z,o=i*i+s*s+n*n,a=e.radius+t,l=a*a;if(o<=l)return!0;const c=i*this.direction.x+s*this.direction.y+n*this.direction.z;return!(c<0)&&o-c*c<=l}intersectsTriangle(e,t,i){const s=Qe._TmpVector3[0],n=Qe._TmpVector3[1],o=Qe._TmpVector3[2],a=Qe._TmpVector3[3],l=Qe._TmpVector3[4];t.subtractToRef(e,s),i.subtractToRef(e,n),v.CrossToRef(this.direction,n,o);const c=v.Dot(s,o);if(0===c)return null;const h=1/c;this.origin.subtractToRef(e,a);const u=v.Dot(a,o)*h;if(u<0||u>1)return null;v.CrossToRef(a,s,l);const d=v.Dot(this.direction,l)*h;if(d<0||u+d>1)return null;const f=v.Dot(n,l)*h;return f>this.length?null:new TE(1-u-d,u,f)}intersectsPlane(e){let t;const i=v.Dot(e.normal,this.direction);if(Math.abs(i)<9.99999997475243e-7)return null;{const s=v.Dot(e.normal,this.origin);return t=(-e.d-s)/i,t<0?t<-9.99999997475243e-7?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{const i=(this.origin.y-t)/this.direction.y;return i>0?null:new v(this.origin.x+this.direction.x*-i,t,this.origin.z+this.direction.z*-i)}case"x":{const i=(this.origin.x-t)/this.direction.x;return i>0?null:new v(t,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{const i=(this.origin.z-t)/this.direction.z;return i>0?null:new v(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,t)}default:return null}}intersectsMesh(e,t){const i=L.Matrix[0];return e.getWorldMatrix().invertToRef(i),this._tmpRay?Qe.TransformToRef(this,i,this._tmpRay):this._tmpRay=Qe.Transform(this,i),e.intersects(this._tmpRay,t)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let s=0;s<e.length;s++){const n=this.intersectsMesh(e[s],t);n.hit&&i.push(n)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){const s=this.origin,n=L.Vector3[0],o=L.Vector3[1],a=L.Vector3[2],l=L.Vector3[3];t.subtractToRef(e,n),this.direction.scaleToRef(Qe._Rayl,a),s.addToRef(a,o),e.subtractToRef(s,l);const c=v.Dot(n,n),h=v.Dot(n,a),u=v.Dot(a,a),d=v.Dot(n,l),f=v.Dot(a,l),p=c*u-h*h;let _,g,m=p,b=p;p<Qe._Smallnum?(_=0,m=1,g=f,b=u):(_=h*f-u*d,g=c*f-h*d,_<0?(_=0,g=f,b=u):_>m&&(_=m,g=f+h,b=u)),g<0?(g=0,-d<0?_=0:-d>c?_=m:(_=-d,m=c)):g>b&&(g=b,-d+h<0?_=0:-d+h>c?_=m:(_=-d+h,m=c));const y=Math.abs(_)<Qe._Smallnum?0:_/m,T=Math.abs(g)<Qe._Smallnum?0:g/b,x=L.Vector3[4];a.scaleToRef(T,x);const S=L.Vector3[5];n.scaleToRef(y,S),S.addInPlace(l);const C=L.Vector3[6];return S.subtractToRef(x,C),T>0&&T<=this.length&&C.lengthSquared()<i*i?S.length():-1}update(e,t,i,s,n,o,a,l=!1){if(l){Qe._RayDistant||(Qe._RayDistant=Qe.Zero()),Qe._RayDistant.unprojectRayToRef(e,t,i,s,F.IdentityReadOnly,o,a);const c=L.Matrix[0];n.invertToRef(c),Qe.TransformToRef(Qe._RayDistant,c,this)}else this.unprojectRayToRef(e,t,i,s,n,o,a);return this}static Zero(){return new Qe(v.Zero(),v.Zero())}static CreateNew(e,t,i,s,n,o,a){return Qe.Zero().update(e,t,i,s,n,o,a)}static CreateNewFromTo(e,t,i=F.IdentityReadOnly){const s=t.subtract(e),n=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);return s.normalize(),Qe.Transform(new Qe(e,s,n),i)}static Transform(e,t){const i=new Qe(new v(0,0,0),new v(0,0,0));return Qe.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){v.TransformCoordinatesToRef(e.origin,t,i.origin),v.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length;const s=i.direction,n=s.length();if(0!==n&&1!==n){const o=1/n;s.x*=o,s.y*=o,s.z*=o,i.length*=n}}unprojectRayToRef(e,t,i,s,n,o,a){var l;const c=L.Matrix[0];n.multiplyToRef(o,c),c.multiplyToRef(a,c),c.invert();const h=L.Vector3[0];h.x=e/i*2-1,h.y=-(t/s*2-1),h.z=null!==(l=be.LastCreatedEngine)&&void 0!==l&&l.isNDCHalfZRange?0:-1;const u=L.Vector3[1].copyFromFloats(h.x,h.y,1-1e-8),d=L.Vector3[2],f=L.Vector3[3];v._UnprojectFromInvertedMatrixToRef(h,c,d),v._UnprojectFromInvertedMatrixToRef(u,c,f),this.origin.copyFrom(d),f.subtractToRef(d,this.direction),this.direction.normalize()}}Qe._TmpVector3=is.BuildArray(6,v.Zero),Qe._RayDistant=Qe.Zero(),Qe._Smallnum=1e-8,Qe._Rayl=1e9,ge.prototype.createPickingRay=function(r,e,t,i,s=!1){const n=Qe.Zero();return this.createPickingRayToRef(r,e,t,n,i,s),n},ge.prototype.createPickingRayToRef=function(r,e,t,i,s,n=!1,o=!1){const a=this.getEngine();if(!s){if(!this.activeCamera)return this;s=this.activeCamera}const c=s.viewport.toGlobal(a.getRenderWidth(),a.getRenderHeight());return r=r/a.getHardwareScalingLevel()-c.x,e=e/a.getHardwareScalingLevel()-(a.getRenderHeight()-c.y-c.height),i.update(r,e,c.width,c.height,t||F.IdentityReadOnly,n?F.IdentityReadOnly:s.getViewMatrix(),s.getProjectionMatrix(),o),this},ge.prototype.createPickingRayInCameraSpace=function(r,e,t){const i=Qe.Zero();return this.createPickingRayInCameraSpaceToRef(r,e,i,t),i},ge.prototype.createPickingRayInCameraSpaceToRef=function(r,e,t,i){if(!Os)return this;const s=this.getEngine();if(!i){if(!this.activeCamera)throw new Error("Active camera not set");i=this.activeCamera}const o=i.viewport.toGlobal(s.getRenderWidth(),s.getRenderHeight()),a=F.Identity();return r=r/s.getHardwareScalingLevel()-o.x,e=e/s.getHardwareScalingLevel()-(s.getRenderHeight()-o.y-o.height),t.update(r,e,o.width,o.height,a,a,i.getProjectionMatrix()),this},ge.prototype._internalPickForMesh=function(r,e,t,i,s,n,o,a){const l=e(i,t.enableDistantPicking),c=t.intersects(l,s,o,n,i,a);return!c||!c.hit||!s&&null!=r&&c.distance>=r.distance?null:c},ge.prototype._internalPick=function(r,e,t,i,s){let n=null;const o=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),a=this.cameraToUseForPointers||this.activeCamera;for(let l=0;l<this.meshes.length;l++){const c=this.meshes[l];if(e){if(!e(c))continue}else if(!c.isEnabled()||!c.isVisible||!c.isPickable)continue;const h=o&&c.isWorldMatrixCameraDependent(),u=c.computeWorldMatrix(h,a);if(c.hasThinInstances&&c.thinInstanceEnablePicking){const d=this._internalPickForMesh(n,r,c,u,!0,!0,s);if(d){if(i)return d;const f=L.Matrix[1],p=c.thinInstanceGetWorldMatrices();for(let _=0;_<p.length;_++){p[_].multiplyToRef(u,f);const g=this._internalPickForMesh(n,r,c,f,t,i,s,!0);if(g&&(n=g,n.thinInstanceIndex=_,t))return n}}}else{const d=this._internalPickForMesh(n,r,c,u,t,i,s);if(d&&(n=d,t))return n}}return n||new Os},ge.prototype._internalMultiPick=function(r,e,t){if(!Os)return null;const i=new Array,s=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),n=this.cameraToUseForPointers||this.activeCamera;for(let o=0;o<this.meshes.length;o++){const a=this.meshes[o];if(e){if(!e(a))continue}else if(!a.isEnabled()||!a.isVisible||!a.isPickable)continue;const l=s&&a.isWorldMatrixCameraDependent(),c=a.computeWorldMatrix(l,n);if(a.hasThinInstances&&a.thinInstanceEnablePicking){if(this._internalPickForMesh(null,r,a,c,!0,!0,t)){const u=L.Matrix[1],d=a.thinInstanceGetWorldMatrices();for(let f=0;f<d.length;f++){d[f].multiplyToRef(c,u);const _=this._internalPickForMesh(null,r,a,u,!1,!1,t,!0);_&&(_.thinInstanceIndex=f,i.push(_))}}}else{const h=this._internalPickForMesh(null,r,a,c,!1,!1,t);h&&i.push(h)}}return i},ge.prototype.pickWithBoundingInfo=function(r,e,t,i,s){if(!Os)return null;const n=this._internalPick(o=>(this._tempPickingRay||(this._tempPickingRay=Qe.Zero()),this.createPickingRayToRef(r,e,o,this._tempPickingRay,s||null),this._tempPickingRay),t,i,!0);return n&&(n.ray=this.createPickingRay(r,e,F.Identity(),s||null)),n},Object.defineProperty(ge.prototype,"_pickingAvailable",{get:()=>!0,enumerable:!1,configurable:!1}),ge.prototype.pick=function(r,e,t,i,s,n,o=!1){const a=this._internalPick((l,c)=>(this._tempPickingRay||(this._tempPickingRay=Qe.Zero()),this.createPickingRayToRef(r,e,l,this._tempPickingRay,s||null,!1,c),this._tempPickingRay),t,i,!1,n);return a&&(a.ray=this.createPickingRay(r,e,F.Identity(),s||null)),a},ge.prototype.pickWithRay=function(r,e,t,i){const s=this._internalPick(n=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=F.Identity()),n.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=Qe.Zero()),Qe.TransformToRef(r,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t,!1,i);return s&&(s.ray=r),s},ge.prototype.multiPick=function(r,e,t,i,s){return this._internalMultiPick(n=>this.createPickingRay(r,e,n,i||null),t,s)},ge.prototype.multiPickWithRay=function(r,e,t){return this._internalMultiPick(i=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=F.Identity()),i.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=Qe.Zero()),Qe.TransformToRef(r,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t)},ve.prototype.getForwardRay=function(r=100,e,t){return this.getForwardRayToRef(new Qe(v.Zero(),v.Zero(),r),r,e,t)},ve.prototype.getForwardRayToRef=function(r,e=100,t,i){return t||(t=this.getWorldMatrix()),r.length=e,r.origin.copyFrom(i||this.position),L.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),v.TransformNormalToRef(L.Vector3[2],t,L.Vector3[3]),v.NormalizeToRef(L.Vector3[3],r.direction),r};class li{static _RemoveAndStorePivotPoint(e){e&&0===li._PivotCached&&(e.getPivotPointToRef(li._OldPivotPoint),li._PivotPostMultiplyPivotMatrix=e._postMultiplyPivotMatrix,li._OldPivotPoint.equalsToFloats(0,0,0)||(e.setPivotMatrix(F.IdentityReadOnly),li._OldPivotPoint.subtractToRef(e.getPivotPoint(),li._PivotTranslation),li._PivotTmpVector.copyFromFloats(1,1,1),li._PivotTmpVector.subtractInPlace(e.scaling),li._PivotTmpVector.multiplyInPlace(li._PivotTranslation),e.position.addInPlace(li._PivotTmpVector))),li._PivotCached++}static _RestorePivotPoint(e){e&&!li._OldPivotPoint.equalsToFloats(0,0,0)&&1===li._PivotCached&&(e.setPivotPoint(li._OldPivotPoint),e._postMultiplyPivotMatrix=li._PivotPostMultiplyPivotMatrix,li._PivotTmpVector.copyFromFloats(1,1,1),li._PivotTmpVector.subtractInPlace(e.scaling),li._PivotTmpVector.multiplyInPlace(li._PivotTranslation),e.position.subtractInPlace(li._PivotTmpVector)),this._PivotCached--}}function P1(r){const e=[],t=[],i=[],s=[],a=0===r.sideOrientation?0:r.sideOrientation||ue.DEFAULTSIDE,l=(r.width||r.size||1)/2,c=(r.height||r.size||1)/2;t.push(-l,-c,0),i.push(0,0,-1),s.push(0,It.UseOpenGLOrientationForUV?1:0),t.push(l,-c,0),i.push(0,0,-1),s.push(1,It.UseOpenGLOrientationForUV?1:0),t.push(l,c,0),i.push(0,0,-1),s.push(1,It.UseOpenGLOrientationForUV?0:1),t.push(-l,c,0),i.push(0,0,-1),s.push(0,It.UseOpenGLOrientationForUV?0:1),e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),ue._ComputeSides(a,t,e,i,s,r.frontUVs,r.backUVs);const h=new ue;return h.indices=e,h.positions=t,h.normals=i,h.uvs=s,h}function rh(r,e={},t=null){const i=new G(r,t);return e.sideOrientation=G._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,P1(e).applyToMesh(i,e.updatable),e.sourcePlane&&(i.translate(e.sourcePlane.normal,-e.sourcePlane.d),i.setDirection(e.sourcePlane.normal.scale(-1))),i}li._PivotCached=0,li._OldPivotPoint=new v,li._PivotTranslation=new v,li._PivotTmpVector=new v,li._PivotPostMultiplyPivotMatrix=!1,ue.CreatePlane=P1,G.CreatePlane=(r,e,t,i,s)=>rh(r,{size:e,width:e,height:e,sideOrientation:s,updatable:i},t);let gse=(()=>{class r{get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(t){this.currentDraggingPointerId=t}set enabled(t){t!=this._enabled&&this.onEnabledObservable.notifyObservers(t),this._enabled=t}get enabled(){return this._enabled}get options(){return this._options}set options(t){this._options=t}constructor(t){this._useAlternatePickedPointAboveMaxDragAngleDragSpeed=-1.1,this._activeDragButton=-1,this.maxDragAngle=0,this.dragButtons=[0,1,2],this._useAlternatePickedPointAboveMaxDragAngle=!1,this.currentDraggingPointerId=-1,this.dragging=!1,this.dragDeltaRatio=.2,this.updateDragPlane=!0,this._debugMode=!1,this._moving=!1,this.onDragObservable=new z,this.onDragStartObservable=new z,this.onDragEndObservable=new z,this.onEnabledObservable=new z,this.moveAttached=!0,this._enabled=!0,this.startAndReleaseDragOnPointerEvents=!0,this.detachCameraControls=!0,this.useObjectOrientationForDragging=!0,this.validateDrag=s=>!0,this._tmpVector=new v(0,0,0),this._alternatePickedPoint=new v(0,0,0),this._worldDragAxis=new v(0,0,0),this._targetPosition=new v(0,0,0),this._attachedToElement=!1,this._startDragRay=new Qe(new v,new v),this._lastPointerRay={},this._dragDelta=new v,this._pointA=new v(0,0,0),this._pointC=new v(0,0,0),this._localAxis=new v(0,0,0),this._lookAt=new v(0,0,0),this._options=t||{};let i=0;if(this._options.dragAxis&&i++,this._options.dragPlaneNormal&&i++,i>1)throw"Multiple drag modes specified in dragBehavior options. Only one expected"}get name(){return"PointerDrag"}init(){}attach(t,i){this._scene=t.getScene(),t.isNearGrabbable=!0,this.attachedNode=t,r._PlaneScene||(this._debugMode?r._PlaneScene=this._scene:(r._PlaneScene=new ge(this._scene.getEngine(),{virtual:!0}),r._PlaneScene.detachControl(),this._scene.onDisposeObservable.addOnce(()=>{r._PlaneScene.dispose(),r._PlaneScene=null}))),this._dragPlane=rh("pointerDragPlane",{size:this._debugMode?1:1e4,updatable:!1,sideOrientation:G.DOUBLESIDE},r._PlaneScene),this.lastDragPosition=new v(0,0,0);const s=i||(n=>this.attachedNode==n||n.isDescendantOf(this.attachedNode));this._pointerObserver=this._scene.onPointerObservable.add(n=>{if(this.enabled){if(n.type==Re.POINTERDOWN)this.startAndReleaseDragOnPointerEvents&&!this.dragging&&n.pickInfo&&n.pickInfo.hit&&n.pickInfo.pickedMesh&&n.pickInfo.pickedPoint&&n.pickInfo.ray&&s(n.pickInfo.pickedMesh)&&-1===this._activeDragButton&&-1!==this.dragButtons.indexOf(n.event.button)&&(this._activeDragButton=n.event.button,this._activePointerInfo=n,this._startDrag(n.event.pointerId,n.pickInfo.ray,n.pickInfo.pickedPoint));else if(n.type==Re.POINTERUP)this.startAndReleaseDragOnPointerEvents&&this.currentDraggingPointerId==n.event.pointerId&&(this._activeDragButton===n.event.button||-1===this._activeDragButton)&&this.releaseDrag();else if(n.type==Re.POINTERMOVE){const o=n.event.pointerId;if(this.currentDraggingPointerId===r._AnyMouseId&&o!==r._AnyMouseId){const a=n.event;("mouse"===a.pointerType||!this._scene.getEngine().hostInformation.isMobile&&a instanceof MouseEvent)&&(this._lastPointerRay[this.currentDraggingPointerId]&&(this._lastPointerRay[o]=this._lastPointerRay[this.currentDraggingPointerId],delete this._lastPointerRay[this.currentDraggingPointerId]),this.currentDraggingPointerId=o)}this._lastPointerRay[o]||(this._lastPointerRay[o]=new Qe(new v,new v)),n.pickInfo&&n.pickInfo.ray&&(this._lastPointerRay[o].origin.copyFrom(n.pickInfo.ray.origin),this._lastPointerRay[o].direction.copyFrom(n.pickInfo.ray.direction),this.currentDraggingPointerId==o&&this.dragging&&this._moveDrag(n.pickInfo.ray))}}else this._attachedToElement&&this.releaseDrag()}),this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add(()=>{if(this._moving&&this.moveAttached){let n=!1;li._RemoveAndStorePivotPoint(this.attachedNode),this._targetPosition.subtractToRef(this.attachedNode.absolutePosition,this._tmpVector),this._tmpVector.scaleInPlace(this.dragDeltaRatio),this.attachedNode.getAbsolutePosition().addToRef(this._tmpVector,this._tmpVector),this.validateDrag(this._tmpVector)&&(this.attachedNode.setAbsolutePosition(this._tmpVector),n=!0),li._RestorePivotPoint(this.attachedNode),n&&this.attachedNode.computeWorldMatrix()}})}releaseDrag(){if(this.dragging&&(this.dragging=!1,this.onDragEndObservable.notifyObservers({dragPlanePoint:this.lastDragPosition,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo})),this.currentDraggingPointerId=-1,this._activeDragButton=-1,this._activePointerInfo=null,this._moving=!1,this.detachCameraControls&&this._attachedToElement&&this._scene.activeCamera&&!this._scene.activeCamera.leftCamera){if("ArcRotateCamera"===this._scene.activeCamera.getClassName()){const t=this._scene.activeCamera;t.attachControl(!t.inputs||t.inputs.noPreventDefault,t._useCtrlForPanning,t._panningMouseButton)}else this._scene.activeCamera.attachControl(!this._scene.activeCamera.inputs||this._scene.activeCamera.inputs.noPreventDefault);this._attachedToElement=!1}}startDrag(t=r._AnyMouseId,i,s){this._startDrag(t,i,s);let n=this._lastPointerRay[t];t===r._AnyMouseId&&(n=this._lastPointerRay[Object.keys(this._lastPointerRay)[0]]),n&&this._moveDrag(n)}_startDrag(t,i,s){if(!this._scene.activeCamera||this.dragging||!this.attachedNode)return;li._RemoveAndStorePivotPoint(this.attachedNode),i?(this._startDragRay.direction.copyFrom(i.direction),this._startDragRay.origin.copyFrom(i.origin)):(this._startDragRay.origin.copyFrom(this._scene.activeCamera.position),this.attachedNode.getWorldMatrix().getTranslationToRef(this._tmpVector),this._tmpVector.subtractToRef(this._scene.activeCamera.position,this._startDragRay.direction)),this._updateDragPlanePosition(this._startDragRay,s||this._tmpVector);const n=this._pickWithRayOnDragPlane(this._startDragRay);n?(this.dragging=!0,this.currentDraggingPointerId=t,this.lastDragPosition.copyFrom(n),this.onDragStartObservable.notifyObservers({dragPlanePoint:n,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this._targetPosition.copyFrom(this.attachedNode.getAbsolutePosition()),this.detachCameraControls&&this._scene.activeCamera&&this._scene.activeCamera.inputs&&!this._scene.activeCamera.leftCamera&&(this._scene.activeCamera.inputs.attachedToElement?(this._scene.activeCamera.detachControl(),this._attachedToElement=!0):this._attachedToElement=!1)):this.releaseDrag(),li._RestorePivotPoint(this.attachedNode)}_moveDrag(t){this._moving=!0;const i=this._pickWithRayOnDragPlane(t);if(i){li._RemoveAndStorePivotPoint(this.attachedNode),this.updateDragPlane&&this._updateDragPlanePosition(t,i);let s=0;this._options.dragAxis?(this.useObjectOrientationForDragging?v.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._worldDragAxis):this._worldDragAxis.copyFrom(this._options.dragAxis),i.subtractToRef(this.lastDragPosition,this._tmpVector),s=v.Dot(this._tmpVector,this._worldDragAxis),this._worldDragAxis.scaleToRef(s,this._dragDelta)):(s=this._dragDelta.length(),i.subtractToRef(this.lastDragPosition,this._dragDelta)),this._targetPosition.addInPlace(this._dragDelta),this.onDragObservable.notifyObservers({dragDistance:s,delta:this._dragDelta,dragPlanePoint:i,dragPlaneNormal:this._dragPlane.forward,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this.lastDragPosition.copyFrom(i),li._RestorePivotPoint(this.attachedNode)}}_pickWithRayOnDragPlane(t){if(!t)return null;let i=Math.acos(v.Dot(this._dragPlane.forward,t.direction));if(i>Math.PI/2&&(i=Math.PI-i),this.maxDragAngle>0&&i>this.maxDragAngle){if(this._useAlternatePickedPointAboveMaxDragAngle){this._tmpVector.copyFrom(t.direction),this.attachedNode.absolutePosition.subtractToRef(t.origin,this._alternatePickedPoint),this._alternatePickedPoint.normalize(),this._alternatePickedPoint.scaleInPlace(this._useAlternatePickedPointAboveMaxDragAngleDragSpeed*v.Dot(this._alternatePickedPoint,this._tmpVector)),this._tmpVector.addInPlace(this._alternatePickedPoint);const n=v.Dot(this._dragPlane.forward,this._tmpVector);return this._dragPlane.forward.scaleToRef(-n,this._alternatePickedPoint),this._alternatePickedPoint.addInPlace(this._tmpVector),this._alternatePickedPoint.addInPlace(this.attachedNode.absolutePosition),this._alternatePickedPoint}return null}const s=r._PlaneScene.pickWithRay(t,n=>n==this._dragPlane);return s&&s.hit&&s.pickedMesh&&s.pickedPoint?s.pickedPoint:null}_updateDragPlanePosition(t,i){this._pointA.copyFrom(i),this._options.dragAxis?(this.useObjectOrientationForDragging?v.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragAxis),t.origin.subtractToRef(this._pointA,this._pointC),this._pointC.normalize(),Math.abs(v.Dot(this._localAxis,this._pointC))>.999?Math.abs(v.Dot(v.UpReadOnly,this._pointC))>.999?this._lookAt.copyFrom(v.Right()):this._lookAt.copyFrom(v.UpReadOnly):(v.CrossToRef(this._localAxis,this._pointC,this._lookAt),v.CrossToRef(this._localAxis,this._lookAt,this._lookAt),this._lookAt.normalize()),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._lookAt,this._lookAt),this._dragPlane.lookAt(this._lookAt)):this._options.dragPlaneNormal?(this.useObjectOrientationForDragging?v.TransformCoordinatesToRef(this._options.dragPlaneNormal,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragPlaneNormal),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._localAxis,this._lookAt),this._dragPlane.lookAt(this._lookAt)):(this._dragPlane.position.copyFrom(this._pointA),this._dragPlane.lookAt(t.origin)),this._dragPlane.position.copyFrom(this.attachedNode.getAbsolutePosition()),this._dragPlane.computeWorldMatrix(!0)}detach(){this._lastPointerRay={},this.attachedNode&&(this.attachedNode.isNearGrabbable=!1),this._pointerObserver&&this._scene.onPointerObservable.remove(this._pointerObserver),this._beforeRenderObserver&&this._scene.onBeforeRenderObservable.remove(this._beforeRenderObserver),this._dragPlane&&this._dragPlane.dispose(),this.releaseDrag()}}return r._AnyMouseId=-2,r})(),Ki=(()=>{class r{}return r.ANCHOR_SYSTEM="xr-anchor-system",r.BACKGROUND_REMOVER="xr-background-remover",r.HIT_TEST="xr-hit-test",r.MESH_DETECTION="xr-mesh-detection",r.PHYSICS_CONTROLLERS="xr-physics-controller",r.PLANE_DETECTION="xr-plane-detection",r.POINTER_SELECTION="xr-controller-pointer-selection",r.TELEPORTATION="xr-controller-teleportation",r.FEATURE_POINTS="xr-feature-points",r.HAND_TRACKING="xr-hand-tracking",r.IMAGE_TRACKING="xr-image-tracking",r.NEAR_INTERACTION="xr-near-interaction",r.DOM_OVERLAY="xr-dom-overlay",r.MOVEMENT="xr-controller-movement",r.LIGHT_ESTIMATION="xr-light-estimation",r.EYE_TRACKING="xr-eye-tracking",r.WALKING_LOCOMOTION="xr-walking-locomotion",r.LAYERS="xr-layers",r.DEPTH_SENSING="xr-depth-sensing",r})();class Ai{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add(()=>{this.getEnabledFeatures().forEach(t=>{const i=this._features[t];i.enabled&&!i.featureImplementation.attached&&!i.featureImplementation.disableAutoAttach&&this.attachFeature(t)})}),this._xrSessionManager.onXRSessionEnded.add(()=>{this.getEnabledFeatures().forEach(t=>{const i=this._features[t];i.enabled&&i.featureImplementation.attached&&this.detachFeature(t)})})}static AddWebXRFeature(e,t,i=1,s=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:i},i>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=i),s&&(this._AvailableFeatures[e].stable=i),this._AvailableFeatures[e][i]=t}static ConstructFeature(e,t=1,i,s){const n=this._AvailableFeatures[e][t];if(!n)throw new Error("feature not found");return n(i,s)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){const t=this._features[e];t&&t.enabled&&!t.featureImplementation.attached&&t.featureImplementation.attach()}detachFeature(e){const t=this._features[e];t&&t.featureImplementation.attached&&t.featureImplementation.detach()}disableFeature(e){const t="string"==typeof e?e:e.Name,i=this._features[t];return!(!i||!i.enabled||(i.enabled=!1,this.detachFeature(t),i.featureImplementation.dispose(),delete this._features[t],0))}dispose(){this.getEnabledFeatures().forEach(e=>{this.disableFeature(e)})}enableFeature(e,t="latest",i={},s=!0,n=!0){const o="string"==typeof e?e:e.Name;let a=0;if("string"==typeof t){if(!t)throw new Error(`Error in provided version - ${o} (${t})`);if(a="stable"===t?Ai.GetStableVersionOfFeature(o):"latest"===t?Ai.GetLatestVersionOfFeature(o):+t,-1===a||isNaN(a))throw new Error(`feature not found - ${o} (${t})`)}else a=t;const l=Ai._ConflictingFeatures[o];if(void 0!==l&&-1!==this.getEnabledFeatures().indexOf(l))throw new Error(`Feature ${o} cannot be enabled while ${l} is enabled.`);const c=this._features[o],h=Ai.ConstructFeature(o,a,this._xrSessionManager,i);if(!h)throw new Error(`feature not found - ${o}`);c&&this.disableFeature(o);const u=h();if(u.dependsOn&&!u.dependsOn.every(f=>!!this._features[f]))throw new Error(`Dependant features missing. Make sure the following features are enabled - ${u.dependsOn.join(", ")}`);if(u.isCompatible())return this._features[o]={featureImplementation:u,enabled:!0,version:a,required:n},s?this._xrSessionManager.session&&!this._features[o].featureImplementation.attached&&this.attachFeature(o):this._features[o].featureImplementation.disableAutoAttach=!0,this._features[o].featureImplementation;if(n)throw new Error("required feature not compatible");return q.Warn(`Feature ${o} not compatible with the current environment/browser and was not enabled.`),u}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}_extendXRSessionInitObject(e){var t=this;return Qt(function*(){const i=t.getEnabledFeatures();for(const s of i){const n=t._features[s],o=n.featureImplementation.xrNativeFeatureName;if(o&&(n.required?(e.requiredFeatures=e.requiredFeatures||[],-1===e.requiredFeatures.indexOf(o)&&e.requiredFeatures.push(o)):(e.optionalFeatures=e.optionalFeatures||[],-1===e.optionalFeatures.indexOf(o)&&e.optionalFeatures.push(o))),n.featureImplementation.getXRSessionInitExtension){const a=yield n.featureImplementation.getXRSessionInitExtension();e={...e,...a}}}return e})()}}Ai._AvailableFeatures={},Ai._ConflictingFeatures={[Ki.TELEPORTATION]:Ki.MOVEMENT,[Ki.MOVEMENT]:Ki.TELEPORTATION};class Xs{constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this.xrNativeFeatureName=""}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,t=>this._onXRFrame(t)),!0}detach(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach(e=>{e.observable.remove(e.observer)}),!0):(this.disableAutoAttach=!0,!1)}dispose(){this.detach(),this.isDisposed=!0}isCompatible(){return!0}_addNewAttachObserver(e,t){this._removeOnDetach.push({observable:e,observer:e.add(t)})}}class $t{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}}$t.DistanceJoint=0,$t.HingeJoint=1,$t.BallAndSocketJoint=2,$t.WheelJoint=3,$t.SliderJoint=4,$t.PrismaticJoint=5,$t.UniversalJoint=6,$t.Hinge2Joint=$t.WheelJoint,$t.PointToPointJoint=8,$t.SpringJoint=9,$t.LockJoint=10,G._PhysicsImpostorParser=function(r,e,t){return new Be(e,t.physicsImpostor,{mass:t.physicsMass,friction:t.physicsFriction,restitution:t.physicsRestitution},r)};class Be{get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){!this._physicsEngine||this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){!this._physicsEngine||this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();!t.setBodyPressure||t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();!t.setBodyStiffness||t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();!t.setBodyVelocityIterations||t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();!t.setBodyPositionIterations||t.setBodyPositionIterations(this,e)}constructor(e,t,i={mass:0},s){this.object=e,this.type=t,this._options=i,this._scene=s,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=v.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new Z,this._tmpQuat2=new Z,this.beforeStep=()=>{!this._physicsEngine||(this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new Z),this._options.disableBidirectionalTransformation||this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat),this._onBeforePhysicsStepCallbacks.forEach(n=>{n(this)}))},this.afterStep=()=>{!this._physicsEngine||(this._onAfterPhysicsStepCallbacks.forEach(n=>{n(this)}),this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,Be._TmpVecs[0]),this.object.translate(Be._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0))},this.onCollideEvent=null,this.onCollide=n=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent||!this._physicsEngine)return;const o=this._physicsEngine.getImpostorWithPhysicsBody(n.body);o&&(this.onCollideEvent&&this.onCollideEvent(this,o),this._onPhysicsCollideCallbacks.filter(a=>-1!==a.otherImpostors.indexOf(o)).forEach(a=>{a.callback(this,o,n.point,n.distance,n.impulse,n.normal)}))},this.object?(this.object.parent&&0!==i.mass&&V.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotationQuaternion=this.object.rotation?Z.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):new Z),this._options.mass=void 0===i.mass?0:i.mass,this._options.friction=void 0===i.friction?.2:i.friction,this._options.restitution=void 0===i.restitution?.2:i.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=void 0===i.pressure?200:i.pressure,this._options.stiffness=void 0===i.stiffness?1:i.stiffness,this._options.velocityIterations=void 0===i.velocityIterations?20:i.velocityIterations,this._options.positionIterations=void 0===i.positionIterations?20:i.positionIterations,this._options.fixedPoints=void 0===i.fixedPoints?0:i.fixedPoints,this._options.margin=void 0===i.margin?0:i.margin,this._options.damping=void 0===i.damping?0:i.damping,this._options.path=void 0===i.path?null:i.path,this._options.shape=void 0===i.shape?null:i.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&V.Warn("You must affect impostors to children before affecting impostor to parent.")):V.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))):V.Error("No object was provided. A physics object is obligatory")}_init(){!this._physicsEngine||(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),!this._isDisposed&&(!this.parent||this._options.ignoreParent)&&this._physicsEngine.addImpostor(this))}_getPhysicsParent(){return this.object.parent instanceof Zt?this.object.parent.physicsImpostor:null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(this.object.getBoundingInfo){const e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=Be.IDENTITY_QUATERNION;const i=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);i&&i.decompose(t,void 0,void 0);const n=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return n.x=Math.abs(n.x),n.y=Math.abs(n.y),n.z=Math.abs(n.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),n}return Be.DEFAULT_OBJECT_SIZE}getObjectCenter(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):v.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):v.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){const t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):V.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){const t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):V.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:e instanceof Array?e:[e]})}unregisterOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];let s=-1;this._onPhysicsCollideCallbacks.some((o,a)=>{if(o.callback===t&&o.otherImpostors.length===i.length){const l=o.otherImpostors.every(c=>i.indexOf(c)>-1);return l&&(s=a),l}return!1})?this._onPhysicsCollideCallbacks.splice(s,1):V.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):Z.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,i){const s=new $t(t,i);return this.addJoint(e,s),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,i,s,n){if(!this._physicsEngine)return this;const o=this._physicsEngine.getPhysicsPlugin();return o.appendAnchor?(this._physicsEngine&&o.appendAnchor(this,e,t,i,s,n),this):this}addHook(e,t,i,s){if(!this._physicsEngine)return this;const n=this._physicsEngine.getPhysicsPlugin();return n.appendAnchor?(this._physicsEngine&&n.appendHook(this,e,t,i,s),this):this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new Be(e,this.type,this._options,this._scene):null}dispose(){!this._physicsEngine||(this._joints.forEach(e=>{this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint)}),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new Z),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,i,s,n){const o=Be._TmpVecs[0],a=this.object;if(a.rotationQuaternion)if(n){const l=Be._TmpQuat;a.rotationQuaternion.multiplyToRef(n,l),e.setRotationQuaternion(l,$e.WORLD,t)}else e.setRotationQuaternion(a.rotationQuaternion,$e.WORLD,t);o.x=0,o.y=0,o.z=0,i&&(o.x=i.x,o.y=i.y,o.z=i.z,e.getDirectionToRef(o,t,o),null==s&&(s=i.length()),o.x*=s,o.y*=s,o.z*=s),e.getParent()?(o.addInPlace(a.getAbsolutePosition()),e.setAbsolutePosition(o,t)):(t.setAbsolutePosition(a.getAbsolutePosition()),t.position.x-=o.x,t.position.y-=o.y,t.position.z-=o.z)}syncImpostorWithBone(e,t,i,s,n,o){const a=this.object;if(a.rotationQuaternion)if(n){const h=Be._TmpQuat;e.getRotationQuaternionToRef($e.WORLD,t,h),h.multiplyToRef(n,a.rotationQuaternion)}else e.getRotationQuaternionToRef($e.WORLD,t,a.rotationQuaternion);const l=Be._TmpVecs[0],c=Be._TmpVecs[1];o||((o=Be._TmpVecs[2]).x=0,o.y=1,o.z=0),e.getDirectionToRef(o,t,c),e.getAbsolutePositionToRef(t,l),null==s&&i&&(s=i.length()),null!=s&&(l.x+=c.x*s,l.y+=c.y*s,l.z+=c.z*s),a.setAbsolutePosition(l)}}Be.DEFAULT_OBJECT_SIZE=new v(1,1,1),Be.IDENTITY_QUATERNION=Z.Identity(),Be._TmpVecs=is.BuildArray(3,v.Zero),Be._TmpQuat=Z.Identity(),Be.NoImpostor=0,Be.SphereImpostor=1,Be.BoxImpostor=2,Be.PlaneImpostor=3,Be.MeshImpostor=4,Be.CapsuleImpostor=6,Be.CylinderImpostor=7,Be.ParticleImpostor=8,Be.HeightmapImpostor=9,Be.ConvexHullImpostor=10,Be.CustomImpostor=100,Be.RopeImpostor=101,Be.ClothImpostor=102,Be.SoftbodyImpostor=103;var tl=(()=>{return(r=tl||(tl={}))[r.Clean=0]="Clean",r[r.Stop=1]="Stop",r[r.Sync=2]="Sync",r[r.NoSync=3]="NoSync",tl;var r})();class ke{static get ForceFullSceneLoadingForIncremental(){return ua.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){ua.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return ua.ShowLoadingScreen}static set ShowLoadingScreen(e){ua.ShowLoadingScreen=e}static get loggingLevel(){return ua.loggingLevel}static set loggingLevel(e){ua.loggingLevel=e}static get CleanBoneMatrixWeights(){return ua.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){ua.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return ke._RegisteredPlugins[".babylon"]}static _GetPluginForExtension(e){return ke._RegisteredPlugins[e]||(V.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),ke.GetDefaultPlugin())}static _GetPluginForDirectLoad(e){for(const t in ke._RegisteredPlugins){const i=ke._RegisteredPlugins[t].plugin;if(i.canDirectLoad&&i.canDirectLoad(e))return ke._RegisteredPlugins[t]}return ke.GetDefaultPlugin()}static _GetPluginForFilename(e){const t=e.indexOf("?");-1!==t&&(e=e.substring(0,t));const i=e.lastIndexOf("."),s=e.substring(i,e.length).toLowerCase();return ke._GetPluginForExtension(s)}static _GetDirectLoad(e){return"data:"===e.substr(0,5)?e.substr(5):null}static _FormatErrorMessage(e,t,i){let s="Unable to load from "+e.url;return t?s+=`: ${t}`:i&&(s+=`: ${i}`),s}static _LoadData(e,t,i,s,n,o,a){const l=ke._GetDirectLoad(e.url),c=a?ke._GetPluginForExtension(a):l?ke._GetPluginForDirectLoad(e.url):ke._GetPluginForFilename(e.url);let h;if(h=void 0!==c.plugin.createPlugin?c.plugin.createPlugin():c.plugin,!h)throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(ke.OnPluginActivatedObservable.notifyObservers(h),l&&(h.canDirectLoad&&h.canDirectLoad(e.url)||!$g(e.url))){if(h.directLoad){const y=h.directLoad(t,l);y.then?y.then(T=>{i(h,T)}).catch(T=>{n("Error in directLoad of _loadData: "+T,T)}):i(h,y)}else i(h,l);return h}const u=c.isBinary,d=(y,T)=>{t.isDisposed?n("Scene has been disposed"):i(h,y,T)};let f=null,p=!1;const _=h.onDisposeObservable;_&&_.add(()=>{p=!0,f&&(f.abort(),f=null),o()});const m=()=>{if(p)return;const y=(x,S)=>{n(x?.statusText,S)},T=e.file||e.url;f=h.loadFile?h.loadFile(t,T,d,s,u,y):t._loadFile(T,d,s,!0,u,y)},g=t.getEngine();let b=g.enableOfflineSupport;if(b){let y=!1;for(const T of t.disableOfflineSupportExceptionRules)if(T.test(e.url)){y=!0;break}b=!y}return b&&ee.OfflineProviderFactory?t.offlineProvider=ee.OfflineProviderFactory(e.url,m,g.disableManifestCheck):m(),h}static _GetFileInfo(e,t){let i,s,n=null;if(t)if(t.name)i=`file:${t.name}`,s=t.name,n=t;else if("string"==typeof t&&t.startsWith("data:"))i=t,s="";else{const o=t;if("/"===o.substr(0,1))return q.Error("Wrong sceneFilename parameter"),null;i=e+o,s=o}else i=e,s=q.GetFilename(e),e=q.GetFolderPath(e);return{url:i,rootUrl:e,name:s,file:n}}static GetPluginForExtension(e){return ke._GetPluginForExtension(e).plugin}static IsPluginForExtensionAvailable(e){return!!ke._RegisteredPlugins[e]}static RegisterPlugin(e){if("string"==typeof e.extensions)ke._RegisteredPlugins[e.extensions.toLowerCase()]={plugin:e,isBinary:!1};else{const t=e.extensions;Object.keys(t).forEach(i=>{ke._RegisteredPlugins[i.toLowerCase()]={plugin:e,isBinary:t[i].isBinary}})}}static ImportMesh(e,t,i="",s=be.LastCreatedScene,n=null,o=null,a=null,l=null){if(!s)return V.Error("No scene available to import mesh to"),null;const c=ke._GetFileInfo(t,i);if(!c)return null;const h={};s.addPendingData(h);const u=()=>{s.removePendingData(h)},d=(_,m)=>{const g=ke._FormatErrorMessage(c,_,m);a?a(s,g,new No(g,3e3,m)):V.Error(g),u()},f=o?_=>{try{o(_)}catch(m){d("Error in onProgress callback: "+m,m)}}:void 0,p=(_,m,g,b,y,T,x)=>{if(s.importedMeshesFiles.push(c.url),n)try{n(_,m,g,b,y,T,x)}catch(S){d("Error in onSuccess callback: "+S,S)}s.removePendingData(h)};return ke._LoadData(c,s,(_,m,g)=>{if(_.rewriteRootURL&&(c.rootUrl=_.rewriteRootURL(c.rootUrl,g)),_.importMesh){const b=_,y=new Array,T=new Array,x=new Array;if(!b.importMesh(e,s,m,c.rootUrl,y,T,x,d))return;s.loadingPluginName=_.name,p(y,T,x,[],[],[],[])}else _.importMeshAsync(e,s,m,c.rootUrl,f,c.name).then(y=>{s.loadingPluginName=_.name,p(y.meshes,y.particleSystems,y.skeletons,y.animationGroups,y.transformNodes,y.geometries,y.lights)}).catch(y=>{d(y.message,y)})},f,d,u,l)}static ImportMeshAsync(e,t,i="",s=be.LastCreatedScene,n=null,o=null){return new Promise((a,l)=>{ke.ImportMesh(e,t,i,s,(c,h,u,d,f,p,_)=>{a({meshes:c,particleSystems:h,skeletons:u,animationGroups:d,transformNodes:f,geometries:p,lights:_})},n,(c,h,u)=>{l(u||new Error(h))},o)})}static Load(e,t="",i=be.LastCreatedEngine,s=null,n=null,o=null,a=null){return i?ke.Append(e,t,new ge(i),s,n,o,a):(q.Error("No engine available"),null)}static LoadAsync(e,t="",i=be.LastCreatedEngine,s=null,n=null){return new Promise((o,a)=>{ke.Load(e,t,i,l=>{o(l)},s,(l,c,h)=>{a(h||new Error(c))},n)})}static Append(e,t="",i=be.LastCreatedScene,s=null,n=null,o=null,a=null){if(!i)return V.Error("No scene available to append to"),null;const l=ke._GetFileInfo(e,t);if(!l)return null;const c={};i.addPendingData(c);const h=()=>{i.removePendingData(c)};ke.ShowLoadingScreen&&!this._ShowingLoadingScreen&&(this._ShowingLoadingScreen=!0,i.getEngine().displayLoadingUI(),i.executeWhenReady(()=>{i.getEngine().hideLoadingUI(),this._ShowingLoadingScreen=!1}));const u=(p,_)=>{const m=ke._FormatErrorMessage(l,p,_);o?o(i,m,new No(m,3e3,_)):V.Error(m),h()},d=n?p=>{try{n(p)}catch(_){u("Error in onProgress callback",_)}}:void 0,f=()=>{if(s)try{s(i)}catch(p){u("Error in onSuccess callback",p)}i.removePendingData(c)};return ke._LoadData(l,i,(p,_)=>{if(p.load){if(!p.load(i,_,l.rootUrl,u))return;i.loadingPluginName=p.name,f()}else p.loadAsync(i,_,l.rootUrl,d,l.name).then(()=>{i.loadingPluginName=p.name,f()}).catch(g=>{u(g.message,g)})},d,u,h,a)}static AppendAsync(e,t="",i=be.LastCreatedScene,s=null,n=null){return new Promise((o,a)=>{ke.Append(e,t,i,l=>{o(l)},s,(l,c,h)=>{a(h||new Error(c))},n)})}static LoadAssetContainer(e,t="",i=be.LastCreatedScene,s=null,n=null,o=null,a=null){if(!i)return V.Error("No scene available to load asset container to"),null;const l=ke._GetFileInfo(e,t);if(!l)return null;const c={};i.addPendingData(c);const h=()=>{i.removePendingData(c)},u=(p,_)=>{const m=ke._FormatErrorMessage(l,p,_);o?o(i,m,new No(m,3e3,_)):V.Error(m),h()},d=n?p=>{try{n(p)}catch(_){u("Error in onProgress callback",_)}}:void 0,f=p=>{if(s)try{s(p)}catch(_){u("Error in onSuccess callback",_)}i.removePendingData(c)};return ke._LoadData(l,i,(p,_)=>{if(p.loadAssetContainer){const g=p.loadAssetContainer(i,_,l.rootUrl,u);if(!g)return;i.loadingPluginName=p.name,f(g)}else p.loadAssetContainerAsync?p.loadAssetContainerAsync(i,_,l.rootUrl,d,l.name).then(g=>{i.loadingPluginName=p.name,f(g)}).catch(g=>{u(g.message,g)}):u("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},d,u,h,a)}static LoadAssetContainerAsync(e,t="",i=be.LastCreatedScene,s=null,n=null){return new Promise((o,a)=>{ke.LoadAssetContainer(e,t,i,l=>{o(l)},s,(l,c,h)=>{a(h||new Error(c))},n)})}static ImportAnimations(e,t="",i=be.LastCreatedScene,s=!0,n=tl.Clean,o=null,a=null,l=null,c=null,h=null){if(!i)return void V.Error("No scene available to load animations to");if(s){for(const p of i.animatables)p.reset();i.stopAllAnimations(),i.animationGroups.slice().forEach(p=>{p.dispose()}),i.getNodes().forEach(p=>{p.animations&&(p.animations=[])})}else switch(n){case tl.Clean:i.animationGroups.slice().forEach(f=>{f.dispose()});break;case tl.Stop:i.animationGroups.forEach(f=>{f.stop()});break;case tl.Sync:i.animationGroups.forEach(f=>{f.reset(),f.restart()});break;case tl.NoSync:break;default:return void V.Error("Unknown animation group loading mode value '"+n+"'")}const u=i.animatables.length;this.LoadAssetContainer(e,t,i,f=>{f.mergeAnimationsTo(i,i.animatables.slice(u),o),f.dispose(),i.onAnimationFileImportedObservable.notifyObservers(i),a&&a(i)},l,c,h)}static ImportAnimationsAsync(e,t="",i=be.LastCreatedScene,s=!0,n=tl.Clean,o=null,a=null,l=null,c=null,h=null){return new Promise((u,d)=>{ke.ImportAnimations(e,t,i,s,n,o,f=>{u(f)},l,(f,p,_)=>{d(_||new Error(p))},h)})}}ke.NO_LOGGING=0,ke.MINIMAL_LOGGING=1,ke.SUMMARY_LOGGING=2,ke.DETAILED_LOGGING=3,ke.OnPluginActivatedObservable=new z,ke._RegisteredPlugins={},ke._ShowingLoadingScreen=!1;class gp extends ie{constructor(e,t,i=!0){super(e,t),this._normalMatrix=new F,this._storeEffectOnSubMeshes=i}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return!!e&&(!this._storeEffectOnSubMeshes||!e.subMeshes||0===e.subMeshes.length||this.isReadyForSubMesh(e,e.subMeshes[0],t))}_isReadyForSubMesh(e){const t=e.materialDefines;return!(this.checkReadyOnEveryCall||!e.effect||!t||t._renderId!==this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,t){!t||this.bindForSubMesh(e,t,t.subMeshes[0])}_afterBind(e,t=null){super._afterBind(e,t),this.getScene()._cachedEffect=t,t&&(t._forceRebindOnNextCall=!1)}_mustRebind(e,t,i=1){return e.isCachedMaterialInvalid(this,t,i)}dispose(e,t,i){this._activeEffect=void 0,super.dispose(e,t,i)}}var R=(()=>{return(r=R||(R={}))[r.Float=1]="Float",r[r.Int=2]="Int",r[r.Vector2=4]="Vector2",r[r.Vector3=8]="Vector3",r[r.Vector4=16]="Vector4",r[r.Color3=32]="Color3",r[r.Color4=64]="Color4",r[r.Matrix=128]="Matrix",r[r.Object=256]="Object",r[r.AutoDetect=1024]="AutoDetect",r[r.BasedOnInput=2048]="BasedOnInput",r[r.All=4095]="All",R;var r})(),B=(()=>{return(r=B||(B={}))[r.Vertex=1]="Vertex",r[r.Fragment=2]="Fragment",r[r.Neutral=4]="Neutral",r[r.VertexAndFragment=3]="VertexAndFragment",B;var r})();class D1{constructor(){this.supportUniformBuffers=!1,this.attributes=new Array,this.uniforms=new Array,this.constants=new Array,this.samplers=new Array,this.functions={},this.extensions={},this.counters={},this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}finalize(e){const t=e.sharedData.emitComments,i=this.target===B.Fragment;this.compilationString=`\r\n${t?"//Entry point\r\n":""}void main(void) {\r\n${this.compilationString}`,this._constantDeclaration&&(this.compilationString=`\r\n${t?"//Constants\r\n":""}${this._constantDeclaration}\r\n${this.compilationString}`);let s="";for(const n in this.functions)s+=this.functions[n]+"\r\n";this.compilationString=`\r\n${s}\r\n${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}\r\n${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}\r\n${this._injectAtEnd}`),this.compilationString=`${this.compilationString}\r\n}`,this.sharedData.varyingDeclaration&&(this.compilationString=`\r\n${t?"//Varyings\r\n":""}${this.sharedData.varyingDeclaration}\r\n${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`\r\n${t?"//Samplers\r\n":""}${this._samplerDeclaration}\r\n${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`\r\n${t?"//Uniforms\r\n":""}${this._uniformDeclaration}\r\n${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`\r\n${t?"//Attributes\r\n":""}${this._attributeDeclaration}\r\n${this.compilationString}`),this.compilationString="precision highp float;\r\n"+this.compilationString,this.compilationString="#if defined(WEBGL2) || defines(WEBGPU)\r\nprecision highp sampler2DArray;\r\n#endif\r\n"+this.compilationString;for(const n in this.extensions)this.compilationString=`\r\n${this.extensions[n]}\r\n${this.compilationString}`;this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=e.replace(/[^a-zA-Z_]+/g,""),void 0===this.sharedData.variableNames[e]?(this.sharedData.variableNames[e]=0,"output"===e||"texture"===e?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return void 0===this.sharedData.defineNames[e]?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2D ${e};\r\n`,this.samplers.push(e))}_emit2DArraySampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2DArray ${e};\r\n`,this.samplers.push(e))}_getGLType(e){switch(e){case R.Float:return"float";case R.Int:return"int";case R.Vector2:return"vec2";case R.Color3:case R.Vector3:return"vec3";case R.Color4:case R.Vector4:return"vec4";case R.Matrix:return"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}\r\n${t}\r\n#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+"\r\n"+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\r\n`;let s=Ot.IncludesShadersStore[e]+"\r\n";if(this.sharedData.emitComments&&(s=t+"\r\n"+s),!i)return s;if(i.replaceStrings)for(let n=0;n<i.replaceStrings.length;n++){const o=i.replaceStrings[n];s=s.replace(o.search,o.replace)}return s}_emitFunctionFromInclude(e,t,i,s=""){const n=e+s;if(!this.functions[n]){if(!i||!(i.removeAttributes||i.removeUniforms||i.removeVaryings||i.removeIfDef||i.replaceStrings))return this.functions[n]=i&&i.repeatKey?`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\r\n`:`#include<${e}>${i?.substitutionVars?"("+i?.substitutionVars+")":""}\r\n`,void(this.sharedData.emitComments&&(this.functions[n]=t+"\r\n"+this.functions[n]));if(this.functions[n]=Ot.IncludesShadersStore[e],this.sharedData.emitComments&&(this.functions[n]=t+"\r\n"+this.functions[n]),i.removeIfDef&&(this.functions[n]=this.functions[n].replace(/^\s*?#ifdef.+$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#endif.*$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#else.*$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[n]=this.functions[n].replace(/^\s*?attribute.+$/gm,"")),i.removeUniforms&&(this.functions[n]=this.functions[n].replace(/^\s*?uniform.+$/gm,"")),i.removeVaryings&&(this.functions[n]=this.functions[n].replace(/^\s*?varying.+$/gm,"")),i.replaceStrings)for(let o=0;o<i.replaceStrings.length;o++){const a=i.replaceStrings[o];this.functions[n]=this.functions[n].replace(a.search,a.replace)}}}_registerTempVariable(e){return-1===this.sharedData.temps.indexOf(e)&&(this.sharedData.temps.push(e),!0)}_emitVaryingFromString(e,t,i="",s=!1){return-1===this.sharedData.varyings.indexOf(e)&&(this.sharedData.varyings.push(e),i&&(i.startsWith("defined(")?this.sharedData.varyingDeclaration+=`#if ${i}\r\n`:this.sharedData.varyingDeclaration+=`${s?"#ifndef":"#ifdef"} ${i}\r\n`),this.sharedData.varyingDeclaration+=`varying ${t} ${e};\r\n`,i&&(this.sharedData.varyingDeclaration+="#endif\r\n"),!0)}_emitUniformFromString(e,t,i="",s=!1){-1===this.uniforms.indexOf(e)&&(this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}\r\n`:this._uniformDeclaration+=`${s?"#ifndef":"#ifdef"} ${i}\r\n`),this._uniformDeclaration+=`uniform ${t} ${e};\r\n`,i&&(this._uniformDeclaration+="#endif\r\n"))}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}}class vse{constructor(){this.temps=new Array,this.varyings=new Array,this.varyingDeclaration="",this.inputBlocks=new Array,this.textureBlocks=new Array,this.bindableBlocks=new Array,this.forcedBindableBlocks=new Array,this.blocksWithFallbacks=new Array,this.blocksWithDefines=new Array,this.repeatableContentBlocks=new Array,this.dynamicUniformBlocks=new Array,this.blockingBlocks=new Array,this.animatedInputs=new Array,this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(){let e="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(e+="NodeMaterial does not have a vertex output. You need to at least add a block that generates a glPosition value.\r\n"),this.checks.emitFragment||(e+="NodeMaterial does not have a fragment output. You need to at least add a block that generates a glFragColor value.\r\n");for(const t of this.checks.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.\r\n`;if(e)throw"Build of NodeMaterial failed:\r\n"+e}}var _n=(()=>{return(r=_n||(_n={}))[r.Compatible=0]="Compatible",r[r.TypeIncompatible=1]="TypeIncompatible",r[r.TargetIncompatible=2]="TargetIncompatible",r[r.HierarchyIssue=3]="HierarchyIssue",_n;var r})(),Ei=(()=>{return(r=Ei||(Ei={}))[r.Input=0]="Input",r[r.Output=1]="Output",Ei;var r})();class ju{static AreEquivalentTypes(e,t){switch(e){case R.Vector3:if(t===R.Color3)return!0;break;case R.Vector4:if(t===R.Color4)return!0;break;case R.Color3:if(t===R.Vector3)return!0;break;case R.Color4:if(t===R.Vector4)return!0}return!1}get direction(){return this._direction}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:this._enforceAssociatedVariableName&&this._associatedVariableName||!this._connectedPoint?this._associatedVariableName:this._connectedPoint.associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===R.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===R.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get target(){return this._prioritizeVertex&&this._ownerBlock?this._target!==B.VertexAndFragment?this._target:this._ownerBlock.target===B.Fragment?B.Fragment:B.Vertex:this._target}set target(e){this._target=e}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get isConnectedToInputBlock(){return null!==this.connectedPoint&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return 0===this._endpoints.length?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===B.Vertex||(e.ownerBlock.target===B.Neutral||e.ownerBlock.target===B.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isDirectlyConnectedToVertexOutput))return!0;return!1}get isConnectedInVertexShader(){if(this.target===B.Vertex)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===B.Vertex||e.target===B.Vertex||(e.ownerBlock.target===B.Neutral||e.ownerBlock.target===B.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInVertexShader))return!0;return!1}get isConnectedInFragmentShader(){if(this.target===B.Fragment)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===B.Fragment||(e.ownerBlock.target===B.Neutral||e.ownerBlock.target===B.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInFragmentShader))return!0;return!1}createCustomInputBlock(){return null}constructor(e,t,i){this._connectedPoint=null,this._endpoints=new Array,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this._linkedConnectionSource=null,this._acceptedConnectionPointType=null,this._type=R.Float,this._enforceAssociatedVariableName=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=new Array,this.excludedConnectionPointTypes=new Array,this.onConnectionObservable=new z,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=B.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===_n.Compatible}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(t.target===B.Fragment){if(i.target===B.Vertex)return _n.TargetIncompatible;for(const o of i.outputs)if(o.ownerBlock.target!=B.Neutral&&o.isConnectedInVertexShader)return _n.TargetIncompatible}if(this.type!==e.type&&e.innerType!==R.AutoDetect)return ju.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&-1!==e.acceptedConnectionPointTypes.indexOf(this.type)||e._acceptedConnectionPointType&&ju.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?_n.Compatible:_n.TypeIncompatible;if(e.excludedConnectionPointTypes&&-1!==e.excludedConnectionPointTypes.indexOf(this.type))return _n.TypeIncompatible;let s=i,n=t;return this.direction===Ei.Input&&(s=t,n=i),s.isAnAncestorOf(n)?_n.HierarchyIssue:_n.Compatible}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return-1===t||(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1),this}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<R.All;)e&t||this.excludedConnectionPointTypes.push(t),t<<=1}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear()}}class De{get name(){return this._name}set name(e){!this.validateBlockName(e)||(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){0==(this._target&e)&&(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){const t=this._inputs.filter(i=>i.name===e);return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter(i=>i.name===e);return t.length?t[0]:null}constructor(e,t=B.Vertex,i=!1,s=!1){this._isFinalMerger=!1,this._isInput=!1,this._name="",this._isUnique=!1,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===B.Neutral,this._isFinalMerger=i,this._isInput=s,this._name=e,this.uniqueId=gE.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===B.Neutral}initialize(e){}bind(e,t,i,s){}_declareOutput(e,t){return`${t._getGLType(e.type)} ${e.associatedVariableName}`}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return-1===t.indexOf(".")&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}registerInput(e,t,i=!1,s,n){return(n=n??new ju(e,this,Ei.Input)).type=t,n.isOptional=i,s&&(n.target=s),this._inputs.push(n),this}registerOutput(e,t,i,s){return(s=s??new ju(e,this,Ei.Output)).type=t,i&&(s.target=i),this._outputs.push(s),this}getFirstAvailableInput(e=null){for(const t of this._inputs)if(!(t.connectedPoint||e&&e.type!==t.type&&t.type!==R.AutoDetect))return t;return null}getFirstAvailableOutput(e=null){for(const t of this._outputs)if(!e||!e.target||e.target===B.Neutral||0!=(e.target&t.target))return t;return null}getSiblingOutput(e){const t=this._outputs.indexOf(e);return-1===t||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0;return!1}connectTo(e,t){if(0===this._outputs.length)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),s=!0;for(;s;){const n=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&n&&i.canConnectTo(n))i.connectTo(n),s=!1;else{if(!i)throw"Unable to find a compatible match";i=this.getSiblingOutput(i)}}return this}_buildBlock(e){}updateUniformsAndSamples(e,t,i,s){}provideFallbacks(e,t){}initializeDefines(e,t,i,s=!1){}prepareDefines(e,t,i,s=!1,n){}autoConfigure(e){}replaceRepeatableContent(e,t,i,s){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return!(this.isInput||this.isFinalMerger||this._outputs.some(e=>e.isDirectlyConnectedToVertexOutput)||this.target===B.Vertex||this.target!==B.VertexAndFragment&&this.target!==B.Neutral||!this._outputs.some(e=>e.isConnectedInVertexShader))}isReady(e,t,i,s=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,s){if(e.build(t,s),null!=t._vertexState&&(0==(e.target&e._buildTarget)||0==(e.target&i.target)||this.target!==B.VertexAndFragment&&e._buildTarget===B.Vertex&&e.target!==B.VertexAndFragment)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){const a=i.connectedPoint;t._vertexState._emitVaryingFromString("v_"+a.associatedVariableName,t._getGLType(a.type))&&(t._vertexState.compilationString+=`${"v_"+a.associatedVariableName} = ${a.associatedVariableName};\r\n`),i.associatedVariableName="v_"+a.associatedVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){const t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(const i of t)if(e===i)return!1;return!0}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(const i of this._outputs)i.associatedVariableName||(i.associatedVariableName=e._getFreeVariableName(i.name));for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==B.Neutral&&(0==(i.target&this.target)||0==(i.target&e.target)))continue;const s=i.connectedPoint.ownerBlock;s&&s!==this&&this._processBuild(s,e,i,t)}if(this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&console.log(`${e.target===B.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case B.Vertex:e.sharedData.checks.emitVertex=!0;break;case B.Fragment:e.sharedData.checks.emitFragment=!0}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`\r\n//${this.name}\r\n`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(const i of this._outputs)if(0!=(i.target&e.target))for(const s of i.endpoints){const n=s.ownerBlock;n&&0!=(n.target&e.target)&&-1!==t.indexOf(n)&&this._processBuild(n,e,s,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};\r\n${e}.visibleOnFrame = ${this.visibleOnFrame};\r\n${e}.target = ${this.target};\r\n`}_dumpCode(e,t){let i;t.push(this);const s=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=s||`${this.getClassName()}_${this.uniqueId}`,-1!==e.indexOf(this._codeVariableName)){let n=0;do{n++,this._codeVariableName=s+n}while(-1!==e.indexOf(this._codeVariableName))}e.push(this._codeVariableName),i=`\r\n// ${this.getClassName()}\r\n`,this.comments&&(i+=`// ${this.comments}\r\n`),i+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");\r\n`,i+=this._dumpPropertiesCode();for(const n of this.inputs){if(!n.isConnected)continue;const a=n.connectedPoint.ownerBlock;-1===t.indexOf(a)&&(i+=a._dumpCode(e,t))}for(const n of this.outputs)if(n.hasEndpoints)for(const o of n.endpoints){const a=o.ownerBlock;a&&-1===t.indexOf(a)&&(i+=a._dumpCode(e,t))}return i}_dumpCodeForOutputConnections(e){let t="";if(-1!==e.indexOf(this))return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const s=i.connectedPoint,n=s.ownerBlock;t+=n._dumpCodeForOutputConnections(e),t+=`${n._codeVariableName}.${n._outputRename(s.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});\r\n`}return t}clone(e,t=""){const i=this.serialize(),s=hs(i.customType);if(s){const n=new s;return n._deserialize(i,e,t),n}return null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i){var s;this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=null!==(s=e.target)&&void 0!==s?s:this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach((s,n)=>{s.displayName&&(this.inputs[n].displayName=s.displayName),s.isExposedOnFrame&&(this.inputs[n].isExposedOnFrame=s.isExposedOnFrame,this.inputs[n].exposedPortPosition=s.exposedPortPosition)}),i&&i.forEach((s,n)=>{s.displayName&&(this.outputs[n].displayName=s.displayName),s.isExposedOnFrame&&(this.outputs[n].isExposedOnFrame=s.isExposedOnFrame,this.outputs[n].exposedPortPosition=s.exposedPortPosition)})}dispose(){for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose()}}class ME extends De{constructor(e){super(e,B.Neutral),this.complementW=1,this.complementZ=0,this.target=B.Vertex,this.registerInput("vector",R.AutoDetect),this.registerInput("transform",R.Matrix),this.registerOutput("output",R.Vector4),this.registerOutput("xyz",R.Vector3),this._inputs[0].onConnectionObservable.add(t=>{if(t.ownerBlock.isInput){const i=t.ownerBlock;("normal"===i.name||"tangent"===i.name)&&(this.complementW=0)}})}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.transform;if(t.connectedPoint){if(0===this.complementW){e._emitFunctionFromInclude("helperFunctions",`//${this.name}`),e.sharedData.blocksWithDefines.push(this);const n=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(e.compilationString+=`mat3 ${n} = mat3(${i.associatedVariableName});\r\n`,e.compilationString+="#ifdef NONUNIFORMSCALING\r\n",e.compilationString+=`${n} = transposeMat3(inverseMat3(${n}));\r\n`,e.compilationString+="#endif\r\n",t.connectedPoint.type){case R.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${n} * vec3(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});\r\n`;break;case R.Vector3:case R.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${n} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\r\n`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${n} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});\r\n`}}else{const s=i.associatedVariableName;switch(t.connectedPoint.type){case R.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = ${s} * vec4(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});\r\n`;break;case R.Vector3:case R.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = ${s} * vec4(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\r\n`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = ${s} * ${t.associatedVariableName};\r\n`}}this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+` = ${this.output.associatedVariableName}.xyz;\r\n`)}return this}prepareDefines(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)}serialize(){const e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=void 0!==e.complementZ?e.complementZ:0,this.complementW=void 0!==e.complementW?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};\r\n`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};\r\n`,e}}le("BABYLON.TransformBlock",ME);class iv extends De{constructor(e){super(e,B.Vertex,!0),this.registerInput("vector",R.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e){for(const t of e)if(t.useLogarithmicDepth)return!0;return!1}_buildBlock(e){return super._buildBlock(e),e.compilationString+=`gl_Position = ${this.vector.associatedVariableName};\r\n`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes)&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.compilationString+="vFragmentDepth = 1.0 + gl_Position.w;\r\n",e.compilationString+="gl_Position.z = log2(max(0.000001, vFragmentDepth)) * logarithmicDepthConstant;\r\n"),this}}le("BABYLON.VertexOutputBlock",iv);var lt=(()=>{return(r=lt||(lt={}))[r.Boolean=0]="Boolean",r[r.Float=1]="Float",r[r.Int=2]="Int",r[r.Vector2=3]="Vector2",r[r.List=4]="List",lt;var r})();function _t(r,e=lt.Boolean,t="PROPERTIES",i){return(s,n)=>{let o=s._propStore;o||(o=[],s._propStore=o),o.push({propertyName:n,displayName:r,type:e,groupName:t,options:i??{}})}}class Zl extends De{constructor(e){super(e,B.Fragment,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",R.Color4,!0),this.registerInput("rgb",R.AutoDetect,!0),this.registerInput("a",R.Float,!0),this.rgb.addExcludedConnectionPointFromAllowedTypes(R.Color3|R.Vector3|R.Float)}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)}bind(e,t,i){this.useLogarithmicDepth&&i&&ce.BindLogDepth(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=this.rgba,i=this.rgb,s=this.a;if(e.sharedData.hints.needAlphaBlending=t.isConnected||s.isConnected,e.sharedData.blocksWithDefines.push(this),this.useLogarithmicDepth&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.sharedData.bindableBlocks.push(this)),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA"),e._emitFunctionFromInclude("helperFunctions",`//${this.name}`),t.connectedPoint)e.compilationString+=s.isConnected?`gl_FragColor = vec4(${t.associatedVariableName}.rgb, ${s.associatedVariableName});\r\n`:`gl_FragColor = ${t.associatedVariableName};\r\n`;else if(i.connectedPoint){let o="1.0";s.connectedPoint&&(o=s.associatedVariableName),e.compilationString+=i.connectedPoint.type===R.Float?`gl_FragColor = vec4(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${o});\r\n`:`gl_FragColor = vec4(${i.associatedVariableName}, ${o});\r\n`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);return e.compilationString+=`#ifdef ${this._linearDefineName}\r\n`,e.compilationString+="gl_FragColor = toLinearSpace(gl_FragColor);\r\n",e.compilationString+="#endif\r\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\r\n`,e.compilationString+="gl_FragColor = toGammaSpace(gl_FragColor);\r\n",e.compilationString+="#endif\r\n",this.useLogarithmicDepth&&(e.compilationString+="gl_FragDepthEXT = log2(vFragmentDepth) * logarithmicDepthConstant * 0.5;\r\n"),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\r\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\r\n`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};\r\n`,e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=e.convertToLinearSpace,this.useLogarithmicDepth=null!==(s=e.useLogarithmicDepth)&&void 0!==s&&s}}E([_t("Convert to gamma space",lt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Zl.prototype,"convertToGammaSpace",void 0),E([_t("Convert to linear space",lt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Zl.prototype,"convertToLinearSpace",void 0),E([_t("Use logarithmic depth",lt.Boolean,"PROPERTIES")],Zl.prototype,"useLogarithmicDepth",void 0),le("BABYLON.FragmentOutputBlock",Zl);var js=(()=>{return(r=js||(js={}))[r.Uniform=0]="Uniform",r[r.Attribute=1]="Attribute",r[r.Varying=2]="Varying",r[r.Undefined=3]="Undefined",js;var r})(),it=(()=>{return(r=it||(it={}))[r.World=1]="World",r[r.View=2]="View",r[r.Projection=3]="Projection",r[r.ViewProjection=4]="ViewProjection",r[r.WorldView=5]="WorldView",r[r.WorldViewProjection=6]="WorldViewProjection",r[r.CameraPosition=7]="CameraPosition",r[r.FogColor=8]="FogColor",r[r.DeltaTime=9]="DeltaTime",r[r.CameraParameters=10]="CameraParameters",r[r.MaterialAlpha=11]="MaterialAlpha",it;var r})(),il=(()=>{return(r=il||(il={}))[r.None=0]="None",r[r.Time=1]="Time",r[r.RealTime=2]="RealTime",il;var r})();const bse={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},PE={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},N1={particle_texturemask:!0};class et extends De{get type(){if(this._type===R.AutoDetect){if(this.isUniform&&null!=this.value){if(!isNaN(this.value))return this._type=R.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=R.Vector2,this._type;case"Vector3":return this._type=R.Vector3,this._type;case"Vector4":return this._type=R.Vector4,this._type;case"Color3":return this._type=R.Color3,this._type;case"Color4":return this._type=R.Color4,this._type;case"Matrix":return this._type=R.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"particle_positionw":return this._type=R.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":return this._type=R.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=R.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":return this._type=R.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case it.World:case it.WorldView:case it.WorldViewProjection:case it.View:case it.ViewProjection:case it.Projection:return this._type=R.Matrix,this._type;case it.CameraPosition:return this._type=R.Vector3,this._type;case it.FogColor:return this._type=R.Color3,this._type;case it.DeltaTime:case it.MaterialAlpha:return this._type=R.Float,this._type;case it.CameraParameters:return this._type=R.Vector4,this._type}}return this._type}constructor(e,t=B.Vertex,i=R.AutoDetect){super(e,t,!1,!0),this._mode=js.Undefined,this._animationType=il.None,this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new z,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}validateBlockName(e){return!!this.isAttribute||super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=js.Attribute,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===R.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=js.Uniform,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=js.Uniform}get associatedVariableName(){return this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return this._mode===js.Undefined}get isUniform(){return this._mode===js.Uniform}set isUniform(e){this._mode=e?js.Uniform:js.Undefined,this.associatedVariableName=""}get isAttribute(){return this._mode===js.Attribute}set isAttribute(e){this._mode=e?js.Attribute:js.Undefined,this.associatedVariableName=""}get isVarying(){return this._mode===js.Varying}set isVarying(e){this._mode=e?js.Varying:js.Undefined,this.associatedVariableName=""}get isSystemValue(){return null!=this._systemValue}get systemValue(){return this._systemValue}set systemValue(e){this._mode=js.Uniform,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case il.Time:this.type===R.Float&&(this.value+=.01*e.getAnimationRatio());break;case il.RealTime:this.type===R.Float&&(this.value=(ir.Now-e.getEngine().startTime)/1e3)}}_emitDefine(e){return"!"===e[0]?`#ifndef ${e.substring(1)}\r\n`:`#ifdef ${e}\r\n`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case R.Float:this.value=0;break;case R.Vector2:this.value=de.Zero();break;case R.Vector3:this.value=v.Zero();break;case R.Vector4:this.value=vt.Zero();break;case R.Color3:this.value=re.White();break;case R.Color4:this.value=new Te(1,1,1,1);break;case R.Matrix:this.value=F.Identity()}}_emitConstant(e){switch(this.type){case R.Float:return`${e._emitFloat(this.value)}`;case R.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case R.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case R.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case R.Color3:return wt.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&wt.Color3[0].toGammaSpaceToRef(wt.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&wt.Color3[0].toLinearSpaceToRef(wt.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${wt.Color3[0].r}, ${wt.Color3[0].g}, ${wt.Color3[0].b})`;case R.Color4:return wt.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&wt.Color4[0].toGammaSpaceToRef(wt.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&wt.Color4[0].toLinearSpaceToRef(wt.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${wt.Color4[0].r}, ${wt.Color4[0].g}, ${wt.Color4[0].b}, ${wt.Color4[0].a})`}return""}get _noContextSwitch(){return PE[this.name]}_emit(e,t){var i;if(this.isUniform){if(this.associatedVariableName||(this.associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(-1!==e.constants.indexOf(this.associatedVariableName))return;return e.constants.push(this.associatedVariableName),void(e._constantDeclaration+=this._declareOutput(this.output,e)+` = ${this._emitConstant(e)};\r\n`)}if(-1!==e.uniforms.indexOf(this.associatedVariableName))return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t)),e._uniformDeclaration+=`uniform ${e._getGLType(this.type)} ${this.associatedVariableName};\r\n`,t&&(e._uniformDeclaration+="#endif\r\n");const s=e.sharedData.hints;if(null!=this._systemValue)switch(this._systemValue){case it.WorldView:s.needWorldViewMatrix=!0;break;case it.WorldViewProjection:s.needWorldViewProjectionMatrix=!0}else this._animationType!==il.None&&e.sharedData.animatedInputs.push(this)}else if(this.isAttribute){if(this.associatedVariableName=null!==(i=bse[this.name])&&void 0!==i?i:this.name,this.target===B.Vertex&&e._vertexState)return void(PE[this.name]?N1[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):this._emit(e._vertexState,t));if(-1!==e.attributes.indexOf(this.associatedVariableName))return;e.attributes.push(this.associatedVariableName),PE[this.name]?N1[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):(t&&(e._attributeDeclaration+=this._emitDefine(t)),e._attributeDeclaration+=`attribute ${e._getGLType(this.type)} ${this.associatedVariableName};\r\n`,t&&(e._attributeDeclaration+="#endif\r\n"))}}_transmitWorld(e,t,i,s){if(!this._systemValue)return;const n=this.associatedVariableName;switch(this._systemValue){case it.World:e.setMatrix(n,t);break;case it.WorldView:e.setMatrix(n,i);break;case it.WorldViewProjection:e.setMatrix(n,s)}}_transmit(e,t,i){if(this.isAttribute)return;const s=this.associatedVariableName;if(this._systemValue){switch(this._systemValue){case it.World:case it.WorldView:case it.WorldViewProjection:return;case it.View:e.setMatrix(s,t.getViewMatrix());break;case it.Projection:e.setMatrix(s,t.getProjectionMatrix());break;case it.ViewProjection:e.setMatrix(s,t.getTransformMatrix());break;case it.CameraPosition:t.bindEyePosition(e,s,!0);break;case it.FogColor:e.setColor3(s,t.fogColor);break;case it.DeltaTime:e.setFloat(s,t.deltaTime/1e3);break;case it.CameraParameters:t.activeCamera&&e.setFloat4(s,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case it.MaterialAlpha:e.setFloat(s,i.alpha)}return}const n=this._valueCallback?this._valueCallback():this._storedValue;if(null!==n)switch(this.type){case R.Float:e.setFloat(s,n);break;case R.Int:e.setInt(s,n);break;case R.Color3:wt.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&wt.Color3[0].toGammaSpaceToRef(wt.Color3[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&wt.Color3[0].toLinearSpaceToRef(wt.Color3[0],t.getEngine().useExactSrgbConversions),e.setColor3(s,wt.Color3[0]);break;case R.Color4:wt.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&wt.Color4[0].toGammaSpaceToRef(wt.Color4[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&wt.Color4[0].toLinearSpaceToRef(wt.Color4[0],t.getEngine().useExactSrgbConversions),e.setDirectColor4(s,wt.Color4[0]);break;case R.Vector2:e.setVector2(s,n);break;case R.Vector3:e.setVector3(s,n);break;case R.Vector4:e.setVector4(s,n);break;case R.Matrix:e.setMatrix(s,n)}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");\r\n`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${it[this._systemValue]});\r\n`;if(this.isUniform){const t=[];let i="";switch(this.type){case R.Float:i=`${this.value}`;break;case R.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case R.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case R.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case R.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case R.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case R.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m}])`}return t.push(`${e}.value = ${i}`),this.type===R.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${il[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(";\r\n")}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,null!=this._storedValue&&this._mode===js.Uniform&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,"tangent"===e.name&&e.mode===js.Attribute&&e.type===R.Vector3&&(this._type=R.Vector4),e.valueType)if("number"===e.valueType)this._storedValue=e.value;else{const s=hs(e.valueType);s&&(this._storedValue=s.FromArray(e.value))}}}le("BABYLON.InputBlock",et);class F1 extends De{constructor(e){super(e,B.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",R.AutoDetect,!1,B.VertexAndFragment),this.registerOutput("rgba",R.Color4,B.Neutral),this.registerOutput("rgb",R.Color3,B.Neutral),this.registerOutput("r",R.Float,B.Neutral),this.registerOutput("g",R.Float,B.Neutral),this.registerOutput("b",R.Float,B.Neutral),this.registerOutput("a",R.Float,B.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(R.Vector2|R.Vector3|R.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?B.VertexAndFragment:B.Fragment}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec2")),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\r\n`,this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name,!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===B.Fragment)return;e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName});\r\n`}else e.compilationString+=this.uv.ownerBlock.target!==B.Fragment?`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this._mainUVName});\r\n`:`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName});\r\n`}_writeOutput(e,t,i,s=!1){if(s){if(e.target===B.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`}else this.uv.ownerBlock.target!==B.Fragment?(e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`,e.compilationString+=`#ifdef ${this._linearDefineName}\r\n`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\r\n`,e.compilationString+="#endif\r\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\r\n`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\r\n`,e.compilationString+="#endif\r\n"):e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==B.Fragment)return e._emit2DSampler(this._samplerName),void this._injectVertexCode(e);if(this._outputs.some(i=>i.isConnectedInFragmentShader)){e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),e._emitFunctionFromInclude("helperFunctions",`//${this.name}`),this._writeTextureRead(e);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=U.Parse(e.texture,t,i))}}le("BABYLON.CurrentScreenBlock",F1);class L1 extends De{constructor(e){super(e,B.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",R.AutoDetect,!1,B.VertexAndFragment),this.registerOutput("rgba",R.Color4,B.Neutral),this.registerOutput("rgb",R.Color3,B.Neutral),this.registerOutput("r",R.Float,B.Neutral),this.registerOutput("g",R.Float,B.Neutral),this.registerOutput("b",R.Float,B.Neutral),this.registerOutput("a",R.Float,B.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(R.Vector2|R.Vector3|R.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e){if(!this.uv.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"particle_uv"===i.name);t||(t=new et("uv"),t.setAsAttribute("particle_uv")),t.output.connectTo(this.uv)}}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,i){e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`,e.compilationString+=`#ifdef ${this._linearDefineName}\r\n`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\r\n`,e.compilationString+="#endif\r\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\r\n`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\r\n`,e.compilationString+="#endif\r\n"}_buildBlock(e){if(super._buildBlock(e),e.target!==B.Vertex){this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),e._emitFunctionFromInclude("helperFunctions",`//${this.name}`),e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this.uv.associatedVariableName});\r\n`;for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=U.Parse(e.texture,t,i))}}le("BABYLON.ParticleTextureBlock",L1);class B1 extends De{constructor(e){super(e,B.Fragment),this._isUnique=!0,this.registerInput("color",R.Color4,!1,B.Fragment),this.registerOutput("rampColor",R.Color4,B.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor"),e._excludeVariableName("finalAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==B.Vertex)return e._emit2DSampler("rampSampler"),e._emitVaryingFromString("remapRanges","vec4","RAMPGRADIENT"),e.compilationString+=`\n            #ifdef RAMPGRADIENT\n                vec4 baseColor = ${this.color.associatedVariableName};\n                float alpha = ${this.color.associatedVariableName}.a;\n\n                float remappedColorIndex = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);\n\n                vec4 rampColor = texture2D(rampSampler, vec2(1.0 - remappedColorIndex, 0.));\n                baseColor.rgb *= rampColor.rgb;\n\n                // Remapped alpha\n                float finalAlpha = baseColor.a;\n                baseColor.a = clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0);\n\n                ${this._declareOutput(this.rampColor,e)} = baseColor;\n            #else\n                ${this._declareOutput(this.rampColor,e)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}le("BABYLON.ParticleRampGradientBlock",B1);class V1 extends De{constructor(e){super(e,B.Fragment),this._isUnique=!0,this.registerInput("color",R.Color4,!1,B.Fragment),this.registerInput("alphaTexture",R.Float,!1,B.Fragment),this.registerInput("alphaColor",R.Float,!1,B.Fragment),this.registerOutput("blendColor",R.Color4,B.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==B.Vertex)return e.compilationString+=`\n            #ifdef BLENDMULTIPLYMODE\n                ${this._declareOutput(this.blendColor,e)};\n                float sourceAlpha = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};\n                ${this.blendColor.associatedVariableName}.rgb = ${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha);\n                ${this.blendColor.associatedVariableName}.a = ${this.color.associatedVariableName}.a;\n            #else\n                ${this._declareOutput(this.blendColor,e)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}le("BABYLON.ParticleBlendMultiplyBlock",V1);class oh{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;const i=this._mesh.getScene();for(let s=0;s<i.meshes.length;s++){const n=i.meshes[s];if(n.material){if(n.computeBonesUsingShaders&&0!==n.numBoneInfluencers)if(n.material.getEffect()===t)n.computeBonesUsingShaders=!1;else if(n.subMeshes)for(const o of n.subMeshes)if(o.effect===t){n.computeBonesUsingShaders=!1;break}}else!this._mesh.material&&n.computeBonesUsingShaders&&n.numBoneInfluencers>0&&(n.computeBonesUsingShaders=!1)}}else{const i=this._defines[this._currentRank];if(i)for(let s=0;s<i.length;s++)e=e.replace("#define "+i[s],"");this._currentRank++}return e}}j.ShadersStore.postprocessVertexShader="attribute vec2 position;\nuniform vec2 scale;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class DE{get depthStencilTexture(){return this._depthStencilTexture}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get size(){return this.width}get width(){return this._size.width||this._size}get height(){return this._size.height||this._size}get layers(){return this._size.layers||0}get texture(){var e,t;return null!==(t=null===(e=this._textures)||void 0===e?void 0:e[0])&&void 0!==t?t:null}get textures(){return this._textures}get samples(){return this._samples}setSamples(e,t=!0,i=!1){if(this.samples===e&&!i)return e;const s=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,s}constructor(e,t,i,s){this._textures=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=e,this._isCube=t,this._size=i,this._engine=s,this._depthStencilTexture=null}setTextures(e){this._textures=Array.isArray(e)?e:e?[e]:null}setTexture(e,t=0,i=!0){this._textures||(this._textures=[]),this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e}createDepthStencilTexture(e=0,t=!0,i=!1,s=1,n=14){var o;return null===(o=this._depthStencilTexture)||void 0===o||o.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:s,depthTextureFormat:n},this),this._depthStencilTexture}_shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){var e,t,i,s,n,o;let a=null;if(this._isMulti){const l=this.textures;if(l&&l.length>0){let c=!1,h=l.length;const u=l[l.length-1]._source;(u===Ye.Depth||u===Ye.DepthStencil)&&(c=!0,h--);const d=[],f=[];for(let m=0;m<h;++m){const g=l[m];d.push(g.samplingMode),f.push(g.type)}a=this._engine.createMultipleRenderTarget({width:this.width,height:this.height},{samplingModes:d,generateMipMaps:l[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:c,types:f,textureCount:h})}}else{const l={};if(l.generateDepthBuffer=this._generateDepthBuffer,l.generateMipMaps=null!==(t=null===(e=this.texture)||void 0===e?void 0:e.generateMipMaps)&&void 0!==t&&t,l.generateStencilBuffer=this._generateStencilBuffer,l.samplingMode=null===(i=this.texture)||void 0===i?void 0:i.samplingMode,l.type=null===(s=this.texture)||void 0===s?void 0:s.type,l.format=null===(n=this.texture)||void 0===n?void 0:n.format,this.isCube)a=this._engine.createRenderTargetCubeTexture(this.width,l);else{const c={width:this.width,height:this.height,layers:this.is2DArray?null===(o=this.texture)||void 0===o?void 0:o.depth:void 0};a=this._engine.createRenderTargetTexture(c,l)}a.texture.isReady=!0}return a}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){const t=this._depthStencilTexture.samplingMode;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,2===t||3===t||11===t,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){var e,t;if(this._textures)for(let i=0;null!==(t=i<(null===(e=this._textures)||void 0===e?void 0:e.length))&&void 0!==t&&t;++i)this._textures[i].dispose();this._textures=null}dispose(e=!1){var t;e||(null===(t=this._depthStencilTexture)||void 0===t||t.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}class yse extends DE{constructor(e,t,i,s,n){super(e,t,i,s),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._context=n}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}_shareDepth(e){super._shareDepth(e);const t=this._context,i=this._depthStencilBuffer,s=e._MSAAFramebuffer||e._framebuffer;e._depthStencilBuffer&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=this._depthStencilBuffer,this._engine._bindUnboundFramebuffer(s),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,i),this._engine._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,i=-1,s=0){if(!e._hardwareTexture)return;const n=this._context,a=this._engine._currentFramebuffer;this._engine._bindUnboundFramebuffer(this._framebuffer),n.framebufferTexture2D(n.FRAMEBUFFER,n[this._engine.webGLVersion>1?"COLOR_ATTACHMENT"+t:"COLOR_ATTACHMENT"+t+"_WEBGL"],-1!==i?n.TEXTURE_CUBE_MAP_POSITIVE_X+i:n.TEXTURE_2D,e._hardwareTexture.underlyingResource,s),this._engine._bindUnboundFramebuffer(a)}setTexture(e,t=0,i=!0){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t)}dispose(e=!1){const t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}we.prototype._createHardwareRenderTargetWrapper=function(r,e,t){const i=new yse(r,e,t,this,this._gl);return this._renderTargetWrapperCache.push(i),i},we.prototype.createRenderTargetTexture=function(r,e){var t,i;const s=this._createHardwareRenderTargetWrapper(!1,!1,r);let l,n=!0,o=!1,a=!1,c=1;void 0!==e&&"object"==typeof e&&(n=null===(t=e.generateDepthBuffer)||void 0===t||t,o=!!e.generateStencilBuffer,a=!!e.noColorAttachment,l=e.colorAttachment,c=null!==(i=e.samples)&&void 0!==i?i:1);const h=l||(a?null:this._createInternalTexture(r,e,!0,Ye.RenderTarget)),u=r.width||r,d=r.height||r,f=this._currentFramebuffer,p=this._gl,_=p.createFramebuffer();return this._bindUnboundFramebuffer(_),s._depthStencilBuffer=this._setupFramebufferDepthAttachments(o,n,u,d),h&&!h.is2DArray&&p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,h._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(f),s._framebuffer=_,s._generateDepthBuffer=n,s._generateStencilBuffer=o,s.setTextures(h),this.updateRenderTargetTextureSampleCount(s,c),s},we.prototype.createDepthStencilTexture=function(r,e,t){return e.isCube?this._createDepthStencilCubeTexture(r.width||r,e,t):this._createDepthStencilTexture(r,e,t)},we.prototype._createDepthStencilTexture=function(r,e,t){const i=this._gl,s=r.layers||0,n=0!==s?i.TEXTURE_2D_ARRAY:i.TEXTURE_2D,o=new zt(this,Ye.DepthStencil);if(!this._caps.depthTextureExtension)return V.Error("Depth texture is not supported by your browser or hardware."),o;const a={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e};if(this._bindTextureDirectly(n,o,!0),this._setupDepthStencilTexture(o,r,a.generateStencil,0!==a.comparisonFunction&&a.bilinearFiltering,a.comparisonFunction,a.samples),void 0!==a.depthTextureFormat){if(15!==a.depthTextureFormat&&16!==a.depthTextureFormat&&17!==a.depthTextureFormat&&13!==a.depthTextureFormat&&14!==a.depthTextureFormat&&18!==a.depthTextureFormat)return V.Error("Depth texture format is not supported."),o;o.format=a.depthTextureFormat}else o.format=a.generateStencil?13:16;const l=17===o.format||13===o.format||18===o.format;t._depthStencilTexture=o,t._depthStencilTextureWithStencil=l;let c=i.UNSIGNED_INT;15===o.format?c=i.UNSIGNED_SHORT:17===o.format||13===o.format?c=i.UNSIGNED_INT_24_8:14===o.format?c=i.FLOAT:18===o.format&&(c=i.FLOAT_32_UNSIGNED_INT_24_8_REV);const h=l?i.DEPTH_STENCIL:i.DEPTH_COMPONENT;let u=h;this.webGLVersion>1&&(15===o.format?u=i.DEPTH_COMPONENT16:16===o.format?u=i.DEPTH_COMPONENT24:17===o.format||13===o.format?u=i.DEPTH24_STENCIL8:14===o.format?u=i.DEPTH_COMPONENT32F:18===o.format&&(u=i.DEPTH32F_STENCIL8)),o.is2DArray?i.texImage3D(n,0,u,o.width,o.height,s,0,h,c,null):i.texImage2D(n,0,u,o.width,o.height,0,h,c,null),this._bindTextureDirectly(n,null),this._internalTexturesCache.push(o);const d=t;if(d._depthStencilBuffer){const f=this._currentFramebuffer;this._bindUnboundFramebuffer(d._framebuffer),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,null),this._bindUnboundFramebuffer(f),i.deleteRenderbuffer(d._depthStencilBuffer),d._depthStencilBuffer=null}return o},we.prototype.updateRenderTargetTextureSampleCount=function(r,e){if(this.webGLVersion<2||!r||!r.texture)return 1;if(r.samples===e)return e;const t=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),r._depthStencilBuffer&&(t.deleteRenderbuffer(r._depthStencilBuffer),r._depthStencilBuffer=null),r._MSAAFramebuffer&&(t.deleteFramebuffer(r._MSAAFramebuffer),r._MSAAFramebuffer=null);const i=r.texture._hardwareTexture;if(i._MSAARenderBuffer&&(t.deleteRenderbuffer(i._MSAARenderBuffer),i._MSAARenderBuffer=null),e>1&&"function"==typeof t.renderbufferStorageMultisample){const s=t.createFramebuffer();if(!s)throw new Error("Unable to create multi sampled framebuffer");r._MSAAFramebuffer=s,this._bindUnboundFramebuffer(r._MSAAFramebuffer);const n=this._createRenderBuffer(r.texture.width,r.texture.height,e,-1,this._getRGBAMultiSampleBufferFormat(r.texture.type),t.COLOR_ATTACHMENT0,!1);if(!n)throw new Error("Unable to create multi sampled framebuffer");i._MSAARenderBuffer=n}else this._bindUnboundFramebuffer(r._framebuffer);return r.texture.samples=e,r._samples=e,r._depthStencilBuffer=this._setupFramebufferDepthAttachments(r._generateStencilBuffer,r._generateDepthBuffer,r.texture.width,r.texture.height,e),this._bindUnboundFramebuffer(null),e};class Pe{static RegisterShaderCodeProcessing(e,t){t?Pe._CustomShaderCodeProcessing[e??""]=t:delete Pe._CustomShaderCodeProcessing[e??""]}static _GetShaderCodeProcessing(e){var t;return null!==(t=Pe._CustomShaderCodeProcessing[e])&&void 0!==t?t:Pe._CustomShaderCodeProcessing[""]}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(t=>{t.setSamples(this._samples)})}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,i,s,n,o,a=1,l,c,h=null,u=0,d="postprocess",f,p=!1,_=5,m=ui.GLSL){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.alphaMode=0,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new ws(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new de(1,1),this._texelSize=de.Zero(),this.onActivateObservable=new z,this.onSizeChangedObservable=new z,this.onApplyObservable=new z,this.onBeforeRenderObservable=new z,this.onAfterRenderObservable=new z,this.name=e,null!=o?(this._camera=o,this._scene=o.getScene(),o.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):l&&(this._engine=l,this._engine.postProcesses.push(this)),this._options=n,this.renderTargetSamplingMode=a||1,this._reusable=c||!1,this._textureType=u,this._textureFormat=_,this._shaderLanguage=m,this._samplers=s||[],this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=d,this._parameters=i||[],this._parameters.push("scale"),this._indexParameters=f,this._drawWrapper=new $i(this._engine),p||this.updateEffect(h)}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){0==this._textures.length&&(this._textures=new ws(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,i=null,s,n,o,a,l){var c,h;const u=Pe._GetShaderCodeProcessing(this.name);if(u?.defineCustomBindings){const d=null!==(c=t?.slice())&&void 0!==c?c:[];d.push(...this._parameters);const f=null!==(h=i?.slice())&&void 0!==h?h:[];f.push(...this._samplers),e=u.defineCustomBindings(this.name,e,d,f),t=d,i=f}this._postProcessDefines=e,this._drawWrapper.effect=this._engine.createEffect({vertex:a??this._vertexUrl,fragment:l??this._fragmentUrl},{attributes:["position"],uniformsNames:t||this._parameters,uniformBuffersNames:[],samplers:i||this._samplers,defines:null!==e?e:"",fallbacks:null,onCompiled:n??null,onError:o??null,indexParameters:s||this._indexParameters,processCodeAfterIncludes:u?.processCodeAfterIncludes?(d,f)=>u.processCodeAfterIncludes(this.name,d,f):null,processFinalCode:u?.processFinalCode?(d,f)=>u.processFinalCode(this.name,d,f):null,shaderLanguage:this._shaderLanguage},this._engine)}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,i=0){for(let n=0;n<this._textureCache.length;n++)if(this._textureCache[n].texture.width===e.width&&this._textureCache[n].texture.height===e.height&&this._textureCache[n].postProcessChannel===i&&this._textureCache[n].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[n].texture.samples===t.samples)return this._textureCache[n].texture;const s=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:s,postProcessChannel:i,lastUsedRenderId:-1}),s}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let i=!1;for(let s=0;s<this._textures.length;s++)if(this._textures.data[s]===this._textureCache[t].texture){i=!0;break}i||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}_resize(e,t,i,s,n){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let o=null;for(let c=0;c<i._postProcesses.length;c++)if(null!==i._postProcesses[c]){o=i._postProcesses[c];break}const a={width:this.width,height:this.height},l={generateMipMaps:s,generateDepthBuffer:n||o===this,generateStencilBuffer:(n||o===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples};this._textures.push(this._createRenderTargetTexture(a,l,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(a,l,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}activate(e,t=null,i){var s,n;const o=(e=e||this._camera).getScene(),a=o.getEngine(),l=a.getCaps().maxTextureSize;let c=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0;const h=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0,u=e.parent;u&&(u.leftCamera==e||u.rightCamera==e)&&(c/=2);let d=this._options.width||c,f=this._options.height||h;const p=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const m=a.currentViewport;m&&(d*=m.width,f*=m.height)}(p||this.alwaysForcePOT)&&(this._options.width||(d=a.needPOTTextures?ee.GetExponentOfTwo(d,l,this.scaleMode):d),this._options.height||(f=a.needPOTTextures?ee.GetExponentOfTwo(f,l,this.scaleMode):f)),(this.width!==d||this.height!==f)&&this._resize(d,f,e,p,i),this._textures.forEach(m=>{m.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(m,this.samples)}),this._flushTextureCache(),this._renderId++}let _;if(this._shareOutputWithPostProcess)_=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)_=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let m;_=this.inputTexture;for(let g=0;g<this._textureCache.length;g++)if(this._textureCache[g].texture===_){m=this._textureCache[g];break}m&&(m.lastUsedRenderId=this._renderId)}return this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(c/d,h/f),this._engine.bindFramebuffer(_,0,c,h,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(_,0,void 0,void 0,this.forceFullscreenViewport)),null===(n=(s=this._engine)._debugInsertMarker)||void 0===n||n.call(s,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(e),this.autoClear&&0===this.alphaMode&&this._engine.clear(this.clearColor?this.clearColor:o.clearColor,o._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),_}get isSupported(){return this._drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){var e,t;return null!==(t=null===(e=this._drawWrapper.effect)||void 0===e?void 0:e.isReady())&&void 0!==t&&t}apply(){var e,t,i;if(null===(e=this._drawWrapper.effect)||void 0===e||!e.isReady())return null;let s;return this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),s=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",s?.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),null===(i=null===(t=Pe._GetShaderCodeProcessing(this.name))||void 0===t?void 0:t.bindCustomBindings)||void 0===i||i.call(t,this.name,this._drawWrapper.effect),this._drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(e){let t;if(e=e||this._camera,this._disposeTextures(),this._scene&&(t=this._scene.postProcesses.indexOf(this),-1!==t&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const i=this._parentContainer.postProcesses.indexOf(this);i>-1&&this._parentContainer.postProcesses.splice(i,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),-1!==t&&this._engine.postProcesses.splice(t,1),e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),0===t&&e._postProcesses.length>0){const i=this._camera._getFirstPostProcess();i&&i.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}}serialize(){const e=Ce.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=Pe.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,i){const s=hs(e.customType);if(!s||!s._Parse)return null;const n=t?t.getCameraById(e.cameraId):null;return s._Parse(e,n,t,i)}static _Parse(e,t,i,s){return Ce.Parse(()=>new Pe(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,i,s)}}Pe._CustomShaderCodeProcessing={},E([I()],Pe.prototype,"uniqueId",void 0),E([I()],Pe.prototype,"name",void 0),E([I()],Pe.prototype,"width",void 0),E([I()],Pe.prototype,"height",void 0),E([I()],Pe.prototype,"renderTargetSamplingMode",void 0),E([sE()],Pe.prototype,"clearColor",void 0),E([I()],Pe.prototype,"autoClear",void 0),E([I()],Pe.prototype,"alphaMode",void 0),E([I()],Pe.prototype,"alphaConstants",void 0),E([I()],Pe.prototype,"enablePixelPerfectMode",void 0),E([I()],Pe.prototype,"forceFullscreenViewport",void 0),E([I()],Pe.prototype,"scaleMode",void 0),E([I()],Pe.prototype,"alwaysForcePOT",void 0),E([I("samples")],Pe.prototype,"_samples",void 0),E([I()],Pe.prototype,"adaptScaleToCurrentViewport",void 0),le("BABYLON.PostProcess",Pe);class sv extends De{constructor(e){super(e,B.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",R.Vector4,!0),this.registerInput("xyz ",R.Vector3,!0),this.registerInput("xy ",R.Vector2,!0),this.registerInput("zw ",R.Vector2,!0),this.registerInput("x",R.Float,!0),this.registerInput("y",R.Float,!0),this.registerInput("z",R.Float,!0),this.registerInput("w",R.Float,!0),this.registerOutput("xyzw",R.Vector4),this.registerOutput("xyz",R.Vector3),this.registerOutput("xy",R.Vector2),this.registerOutput("zw",R.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return"xyzw "===e?"xyzwIn":"xyz "===e?"xyzIn":"xy "===e?"xyIn":"zw "===e?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substr(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.x,i=this.y,s=this.z,n=this.w,o=this.xyIn,a=this.zwIn,l=this.xyzIn,c=this.xyzwIn,h=this._outputs[0],u=this._outputs[1],d=this._outputs[2],f=this._outputs[3];return c.isConnected?(h.hasEndpoints&&(e.compilationString+=this._declareOutput(h,e)+` = ${c.associatedVariableName}${this._buildSwizzle(4)};\r\n`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = ${c.associatedVariableName}${this._buildSwizzle(3)};\r\n`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${c.associatedVariableName}${this._buildSwizzle(2)};\r\n`)):l.isConnected?(h.hasEndpoints&&(e.compilationString+=this._declareOutput(h,e)+` = vec4(${l.associatedVariableName}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};\r\n`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};\r\n`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};\r\n`)):o.isConnected?(h.hasEndpoints&&(e.compilationString+=a.isConnected?this._declareOutput(h,e)+` = vec4(${o.associatedVariableName}, ${a.associatedVariableName})${this._buildSwizzle(4)};\r\n`:this._declareOutput(h,e)+` = vec4(${o.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};\r\n`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = vec3(${o.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\r\n`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};\r\n`),f.hasEndpoints&&(e.compilationString+=a.isConnected?this._declareOutput(f,e)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};\r\n`:this._declareOutput(f,e)+` = vec2(${s.isConnected?this._writeVariable(s):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(2)};\r\n`)):(h.hasEndpoints&&(e.compilationString+=a.isConnected?this._declareOutput(h,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${a.associatedVariableName})${this._buildSwizzle(4)};\r\n`:this._declareOutput(h,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};\r\n`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = vec3(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\r\n`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = vec2(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};\r\n`),f.hasEndpoints&&(e.compilationString+=a.isConnected?this._declareOutput(f,e)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};\r\n`:this._declareOutput(f,e)+` = vec2(${s.isConnected?this._writeVariable(s):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(2)};\r\n`)),this}serialize(){const e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){var s,n,o,a;super._deserialize(e,t,i),this.xSwizzle=null!==(s=e.xSwizzle)&&void 0!==s?s:"x",this.ySwizzle=null!==(n=e.ySwizzle)&&void 0!==n?n:"y",this.zSwizzle=null!==(o=e.zSwizzle)&&void 0!==o?o:"z",this.wSwizzle=null!==(a=e.wSwizzle)&&void 0!==a?a:"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";\r\n`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";\r\n`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";\r\n`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";\r\n`,e}}le("BABYLON.VectorMergerBlock",sv);class rv extends De{constructor(e){super(e,B.Neutral),this.sourceRange=new de(-1,1),this.targetRange=new de(0,1),this.registerInput("input",R.AutoDetect),this.registerInput("sourceMin",R.Float,!0),this.registerInput("sourceMax",R.Float,!0),this.registerInput("targetMin",R.Float,!0),this.registerInput("targetMax",R.Float,!0),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),s=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),n=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),o=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=this._declareOutput(t,e)+` = ${n} + (${this._inputs[0].associatedVariableName} - ${i}) * (${o} - ${n}) / (${s} - ${i});\r\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});\r\n`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});\r\n`,e}serialize(){const e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=de.FromArray(e.sourceRange),this.targetRange=de.FromArray(e.targetRange)}}E([_t("From",lt.Vector2)],rv.prototype,"sourceRange",void 0),E([_t("To",lt.Vector2)],rv.prototype,"targetRange",void 0),le("BABYLON.RemapBlock",rv);class wE extends De{constructor(e){super(e,B.Neutral),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MultiplyBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};\r\n`,this}}le("BABYLON.MultiplyBlock",wE);var wr=(()=>{return(r=wr||(wr={}))[r.Material=0]="Material",r[r.PostProcess=1]="PostProcess",r[r.Particle=2]="Particle",r[r.ProceduralTexture=3]="ProceduralTexture",wr;var r})();class ah{constructor(){this.direction1=new v(0,1,0),this.direction2=new v(0,1,0),this.minEmitBox=new v(-.5,-.5,-.5),this.maxEmitBox=new v(.5,.5,.5)}startDirectionFunction(e,t,i,s){const n=oe.RandomRange(this.direction1.x,this.direction2.x),o=oe.RandomRange(this.direction1.y,this.direction2.y),a=oe.RandomRange(this.direction1.z,this.direction2.z);if(s)return t.x=n,t.y=o,void(t.z=a);v.TransformNormalFromFloatsToRef(n,o,a,e,t)}startPositionFunction(e,t,i,s){const n=oe.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),o=oe.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),a=oe.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(s)return t.x=n,t.y=o,void(t.z=a);v.TransformCoordinatesFromFloatsToRef(n,o,a,e,t)}clone(){const e=new ah;return Pr.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e}parse(e){v.FromArrayToRef(e.direction1,0,this.direction1),v.FromArrayToRef(e.direction2,0,this.direction2),v.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),v.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)}}class nv{get radius(){return this._radius}set radius(e){this._radius=e,this._buildHeight()}get angle(){return this._angle}set angle(e){this._angle=e,this._buildHeight()}_buildHeight(){this._height=0!==this._angle?this._radius/Math.tan(this._angle/2):1}constructor(e=1,t=Math.PI,i=0){this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}startDirectionFunction(e,t,i,s){s?L.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(e.getTranslation(),L.Vector3[0]).normalize();const n=oe.RandomRange(0,this.directionRandomizer),o=oe.RandomRange(0,this.directionRandomizer),a=oe.RandomRange(0,this.directionRandomizer);t.x=L.Vector3[0].x+n,t.y=L.Vector3[0].y+o,t.z=L.Vector3[0].z+a,t.normalize()}startPositionFunction(e,t,i,s){const n=oe.RandomRange(0,2*Math.PI);let o;this.emitFromSpawnPointOnly?o=1e-4:(o=oe.RandomRange(0,this.heightRange),o=1-o*o);let a=this._radius-oe.RandomRange(0,this._radius*this.radiusRange);a*=o;const l=a*Math.sin(n),c=a*Math.cos(n),h=o*this._height;if(s)return t.x=l,t.y=h,void(t.z=c);v.TransformCoordinatesFromFloatsToRef(l,h,c,e,t)}clone(){const e=new nv(this._radius,this._angle,this.directionRandomizer);return Pr.DeepCopy(this,e),e}applyToShader(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)}getEffectDefines(){let e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+="\n#define CONEEMITTERSPAWNPOINT"),e}getClassName(){return"ConeParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e}parse(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=void 0!==e.radiusRange?e.radiusRange:1,this.heightRange=void 0!==e.radiusRange?e.heightRange:1,this.emitFromSpawnPointOnly=void 0!==e.emitFromSpawnPointOnly&&e.emitFromSpawnPointOnly}}class vp{constructor(e=1,t=1,i=1,s=0){this.radius=e,this.height=t,this.radiusRange=i,this.directionRandomizer=s,this._tempVector=v.Zero()}startDirectionFunction(e,t,i,s,n){i.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),v.TransformNormalToRef(this._tempVector,n,this._tempVector);const o=oe.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2);let a=Math.atan2(this._tempVector.x,this._tempVector.z);a+=oe.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=o,this._tempVector.x=Math.sin(a),this._tempVector.z=Math.cos(a),this._tempVector.normalize(),s?t.copyFrom(this._tempVector):v.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)}startPositionFunction(e,t,i,s){const n=oe.RandomRange(-this.height/2,this.height/2),o=oe.RandomRange(0,2*Math.PI),a=oe.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),l=Math.sqrt(a)*this.radius,c=l*Math.cos(o),h=l*Math.sin(o);s?t.copyFromFloats(c,n,h):v.TransformCoordinatesFromFloatsToRef(c,n,h,e,t)}clone(){const e=new vp(this.radius,this.directionRandomizer);return Pr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class ov extends vp{constructor(e=1,t=1,i=1,s=new v(0,1,0),n=new v(0,1,0)){super(e,t,i),this.direction1=s,this.direction2=n}startDirectionFunction(e,t){const i=oe.RandomRange(this.direction1.x,this.direction2.x),s=oe.RandomRange(this.direction1.y,this.direction2.y),n=oe.RandomRange(this.direction1.z,this.direction2.z);v.TransformNormalFromFloatsToRef(i,s,n,e,t)}clone(){const e=new ov(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return Pr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define CYLINDEREMITTER\n#define DIRECTEDCYLINDEREMITTER"}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class av{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,s){const n=i.position.subtract(e.getTranslation()).normalize(),o=oe.RandomRange(0,this.directionRandomizer),a=oe.RandomRange(0,this.directionRandomizer),l=oe.RandomRange(0,this.directionRandomizer);n.x+=o,n.y+=a,n.z+=l,n.normalize(),s?t.copyFrom(n):v.TransformNormalFromFloatsToRef(n.x,n.y,n.z,e,t)}startPositionFunction(e,t,i,s){const n=this.radius-oe.RandomRange(0,this.radius*this.radiusRange),o=oe.RandomRange(0,1),a=oe.RandomRange(0,2*Math.PI),l=Math.acos(2*o-1),c=n*Math.cos(a)*Math.sin(l),h=n*Math.cos(l),u=n*Math.sin(a)*Math.sin(l);s?t.copyFromFloats(c,Math.abs(h),u):v.TransformCoordinatesFromFloatsToRef(c,Math.abs(h),u,e,t)}clone(){const e=new av(this.radius,this.directionRandomizer);return Pr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class lv{constructor(){this.direction1=new v(0,1,0),this.direction2=new v(0,1,0)}startDirectionFunction(e,t,i,s){const n=oe.RandomRange(this.direction1.x,this.direction2.x),o=oe.RandomRange(this.direction1.y,this.direction2.y),a=oe.RandomRange(this.direction1.z,this.direction2.z);s?t.copyFromFloats(n,o,a):v.TransformNormalFromFloatsToRef(n,o,a,e,t)}startPositionFunction(e,t,i,s){s?t.copyFromFloats(0,0,0):v.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)}clone(){const e=new lv;return Pr.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){v.FromArrayToRef(e.direction1,0,this.direction1),v.FromArrayToRef(e.direction2,0,this.direction2)}}class bp{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,s){const n=i.position.subtract(e.getTranslation()).normalize(),o=oe.RandomRange(0,this.directionRandomizer),a=oe.RandomRange(0,this.directionRandomizer),l=oe.RandomRange(0,this.directionRandomizer);n.x+=o,n.y+=a,n.z+=l,n.normalize(),s?t.copyFrom(n):v.TransformNormalFromFloatsToRef(n.x,n.y,n.z,e,t)}startPositionFunction(e,t,i,s){const n=this.radius-oe.RandomRange(0,this.radius*this.radiusRange),o=oe.RandomRange(0,1),a=oe.RandomRange(0,2*Math.PI),l=Math.acos(2*o-1),c=n*Math.cos(a)*Math.sin(l),h=n*Math.cos(l),u=n*Math.sin(a)*Math.sin(l);s?t.copyFromFloats(c,h,u):v.TransformCoordinatesFromFloatsToRef(c,h,u,e,t)}clone(){const e=new bp(this.radius,this.directionRandomizer);return Pr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class cv extends bp{constructor(e=1,t=new v(0,1,0),i=new v(0,1,0)){super(e),this.direction1=t,this.direction2=i}startDirectionFunction(e,t){const i=oe.RandomRange(this.direction1.x,this.direction2.x),s=oe.RandomRange(this.direction1.y,this.direction2.y),n=oe.RandomRange(this.direction1.z,this.direction2.z);v.TransformNormalFromFloatsToRef(i,s,n,e,t)}clone(){const e=new cv(this.radius,this.direction1,this.direction2);return Pr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define SPHEREEMITTER\n#define DIRECTEDSPHEREEMITTER"}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class lh{constructor(){this.particlePositionGenerator=()=>{},this.particleDestinationGenerator=()=>{}}startDirectionFunction(e,t,i,s){const n=L.Vector3[0];if(this.particleDestinationGenerator){this.particleDestinationGenerator(-1,i,n);const o=L.Vector3[1];n.subtractToRef(i.position,o),o.scaleToRef(1/i.lifeTime,n)}else n.set(0,0,0);s?t.copyFrom(n):v.TransformNormalToRef(n,e,t)}startPositionFunction(e,t,i,s){const n=L.Vector3[0];this.particlePositionGenerator?this.particlePositionGenerator(-1,i,n):n.set(0,0,0),s?t.copyFrom(n):v.TransformCoordinatesToRef(n,e,t)}clone(){const e=new lh;return Pr.DeepCopy(this,e),e}applyToShader(e){}buildUniformLayout(e){}getEffectDefines(){return"#define CUSTOMEMITTER"}getClassName(){return"CustomParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e}parse(e){}}class OE{get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh=e,e?(this._indices=e.getIndices(),this._positions=e.getVerticesData(A.PositionKind),this._normals=e.getVerticesData(A.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))}constructor(e=null){this._indices=null,this._positions=null,this._normals=null,this._storedNormal=v.Zero(),this._mesh=null,this.direction1=new v(0,1,0),this.direction2=new v(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=e}startDirectionFunction(e,t,i,s){if(this.useMeshNormalsForDirection&&this._normals)return void v.TransformNormalToRef(this._storedNormal,e,t);const n=oe.RandomRange(this.direction1.x,this.direction2.x),o=oe.RandomRange(this.direction1.y,this.direction2.y),a=oe.RandomRange(this.direction1.z,this.direction2.z);s?t.copyFromFloats(n,o,a):v.TransformNormalFromFloatsToRef(n,o,a,e,t)}startPositionFunction(e,t,i,s){if(!this._indices||!this._positions)return;const n=3*Math.random()*(this._indices.length/3)|0,o=Math.random(),a=Math.random()*(1-o),l=1-o-a,c=this._indices[n],h=this._indices[n+1],u=this._indices[n+2],d=L.Vector3[0],f=L.Vector3[1],p=L.Vector3[2],_=L.Vector3[3];v.FromArrayToRef(this._positions,3*c,d),v.FromArrayToRef(this._positions,3*h,f),v.FromArrayToRef(this._positions,3*u,p),_.x=o*d.x+a*f.x+l*p.x,_.y=o*d.y+a*f.y+l*p.y,_.z=o*d.z+a*f.z+l*p.z,s?t.copyFromFloats(_.x,_.y,_.z):v.TransformCoordinatesFromFloatsToRef(_.x,_.y,_.z,e,t),this.useMeshNormalsForDirection&&this._normals&&(v.FromArrayToRef(this._normals,3*c,d),v.FromArrayToRef(this._normals,3*h,f),v.FromArrayToRef(this._normals,3*u,p),this._storedNormal.x=o*d.x+a*f.x+l*p.x,this._storedNormal.y=o*d.y+a*f.y+l*p.y,this._storedNormal.z=o*d.z+a*f.z+l*p.z)}clone(){const e=new OE(this.mesh);return Pr.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return""}getClassName(){return"MeshParticleEmitter"}serialize(){var e;const t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t.meshId=null===(e=this.mesh)||void 0===e?void 0:e.id,t.useMeshNormalsForDirection=this.useMeshNormalsForDirection,t}parse(e,t){v.FromArrayToRef(e.direction1,0,this.direction1),v.FromArrayToRef(e.direction2,0,this.direction2),e.meshId&&t&&(this.mesh=t.getLastMeshById(e.meshId)),this.useMeshNormalsForDirection=e.useMeshNormalsForDirection}}let hv=(()=>{class r{get noiseTexture(){return this._noiseTexture}set noiseTexture(t){this._noiseTexture!==t&&(this._noiseTexture=t,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(t){this._isAnimationSheetEnabled!=t&&(this._isAnimationSheetEnabled=t,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(t){this._useLogarithmicDepth=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:v.Zero()}set direction1(t){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=t)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:v.Zero()}set direction2(t){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=t)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:v.Zero()}set minEmitBox(t){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=t)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:v.Zero()}set maxEmitBox(t){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=t)}get billboardMode(){return this._billboardMode}set billboardMode(t){this._billboardMode!==t&&(this._billboardMode=t,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(t){this._isBillboardBased!==t&&(this._isBillboardBased=t,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(t){this._attachImageProcessingConfiguration(t)}_attachImageProcessingConfiguration(t){t!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration=!t&&this._scene?this._scene.imageProcessingConfiguration:t)}_reset(){}_removeGradientAndTexture(t,i,s){if(!i)return this;let n=0;for(const o of i){if(o.gradient===t){i.splice(n,1);break}n++}return s&&s.dispose(),this}constructor(t){this.animations=[],this.renderingGroupId=0,this.emitter=v.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new v(10,10,10),this.onAnimationEnd=null,this.blendMode=r.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new de(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new v(0,0,0),this._useLogarithmicDepth=!1,this.gravity=v.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new Te(1,1,1,1),this.color2=new Te(1,1,1,1),this.colorDead=new Te(0,0,0,1),this.textureMask=new Te(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new kie,this.id=t,this.name=t}createPointEmitter(t,i){const s=new lv;return s.direction1=t,s.direction2=i,this.particleEmitterType=s,s}createHemisphericEmitter(t=1,i=1){const s=new av(t,i);return this.particleEmitterType=s,s}createSphereEmitter(t=1,i=1){const s=new bp(t,i);return this.particleEmitterType=s,s}createDirectedSphereEmitter(t=1,i=new v(0,1,0),s=new v(0,1,0)){const n=new cv(t,i,s);return this.particleEmitterType=n,n}createCylinderEmitter(t=1,i=1,s=1,n=0){const o=new vp(t,i,s,n);return this.particleEmitterType=o,o}createDirectedCylinderEmitter(t=1,i=1,s=1,n=new v(0,1,0),o=new v(0,1,0)){const a=new ov(t,i,s,n,o);return this.particleEmitterType=a,a}createConeEmitter(t=1,i=Math.PI/4){const s=new nv(t,i);return this.particleEmitterType=s,s}createBoxEmitter(t,i,s,n){const o=new ah;return this.particleEmitterType=o,this.direction1=t,this.direction2=i,this.minEmitBox=s,this.maxEmitBox=n,o}}return r.BLENDMODE_ONEONE=0,r.BLENDMODE_STANDARD=1,r.BLENDMODE_ADD=2,r.BLENDMODE_MULTIPLY=3,r.BLENDMODE_MULTIPLYADD=4,r})();class G1 extends De{constructor(e){super(e,B.Neutral),this.registerInput("rgba",R.Color4,!0),this.registerInput("rgb ",R.Color3,!0),this.registerOutput("rgb",R.Color3),this.registerOutput("r",R.Float),this.registerOutput("g",R.Float),this.registerOutput("b",R.Float),this.registerOutput("a",R.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return"rgb "===e?"rgbIn":e}_outputRename(e){return"rgb"===e?"rgbOut":e}_buildBlock(e){super._buildBlock(e);const t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;const i=this._outputs[0],s=this._outputs[1],n=this._outputs[2],o=this._outputs[3],a=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+` = ${t.associatedVariableName}.rgb;\r\n`),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+` = ${t.associatedVariableName}.r;\r\n`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${t.associatedVariableName}.g;\r\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${t.associatedVariableName}.b;\r\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${t.associatedVariableName}.a;\r\n`),this}}le("BABYLON.ColorSplitterBlock",G1),we.prototype.createRenderTargetCubeTexture=function(r,e){const t=this._createHardwareRenderTargetWrapper(!1,!0,r),i={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...e};i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,(1===i.type&&!this._caps.textureFloatLinearFiltering||2===i.type&&!this._caps.textureHalfFloatLinearFiltering)&&(i.samplingMode=1);const s=this._gl,n=new zt(this,Ye.RenderTarget);this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,n,!0);const o=this._getSamplingParameters(i.samplingMode,i.generateMipMaps);1===i.type&&!this._caps.textureFloat&&(i.type=0,V.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,o.mag),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,o.min),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);for(let l=0;l<6;l++)s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,this._getRGBABufferInternalSizedFormat(i.type,i.format),r,r,0,this._getInternalFormat(i.format),this._getWebGLTextureType(i.type),null);const a=s.createFramebuffer();return this._bindUnboundFramebuffer(a),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(i.generateStencilBuffer,i.generateDepthBuffer,r,r),i.generateMipMaps&&s.generateMipmap(s.TEXTURE_CUBE_MAP),this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),t._framebuffer=a,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer,n.width=r,n.height=r,n.isReady=!0,n.isCube=!0,n.samples=1,n.generateMipMaps=i.generateMipMaps,n.samplingMode=i.samplingMode,n.type=i.type,n.format=i.format,this._internalTexturesCache.push(n),t.setTextures(n),t};const NE={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class uv{constructor(e,t=NE){var i,s;this._fullscreenViewport=new qr(0,0,1,1);const n=null!==(i=t.positions)&&void 0!==i?i:NE.positions,o=null!==(s=t.indices)&&void 0!==s?s:NE.indices;this.engine=e,this._vertexBuffers={[A.PositionKind]:new A(e,n,A.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(o),this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{this._indexBuffer=e.createIndexBuffer(o);for(const a in this._vertexBuffers)this._vertexBuffers[a]._rebuild()})}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e._drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}restoreStates(){this.engine.depthCullingState.depthTest=!0,this.engine.stencilState.stencilTest=!0}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return void 0!==e.renderTarget}render(e,t=null){if(!e.effect.isReady())return;this.setViewport();const i=null===t?null:this._isRenderTargetTexture(t)?t.renderTarget:t;i&&this.engine.bindFramebuffer(i),this.applyEffectWrapper(e),this.draw(),i&&this.engine.unBindFramebuffer(i),this.restoreStates()}dispose(){const e=this._vertexBuffers[A.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[A.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class sl{get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){let t;this.onApplyObservable=new z;const i=e.uniformNames||[];e.vertexShader?t={fragmentSource:e.fragmentShader,vertexSource:e.vertexShader,spectorName:e.name||"effectWrapper"}:(i.push("scale"),t={fragmentSource:e.fragmentShader,vertex:"postprocess",spectorName:e.name||"effectWrapper"},this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)}));const s=e.defines?e.defines.join("\n"):"";this._drawWrapper=new $i(e.engine),e.useShaderStore?(t.fragment=t.fragmentSource,t.vertex||(t.vertex=t.vertexSource),delete t.fragmentSource,delete t.vertexSource,this.effect=e.engine.createEffect(t,e.attributeNames||["position"],i,e.samplerNames,s,void 0,e.onCompiled,void 0,void 0,e.shaderLanguage)):(this.effect=new Ot(t,e.attributeNames||["position"],i,e.samplerNames,e.engine,s,void 0,e.onCompiled,void 0,void 0,void 0,e.shaderLanguage),this._onContextRestoredObserver=e.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._wasPreviouslyReady=!1,this.effect._prepareEffect()}))}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.effect.dispose()}}const z1="passPixelShader",H1="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\ngl_FragColor=texture2D(textureSampler,vUV);\n}";j.ShadersStore[z1]=H1;const W1_name=z1,W1_shader=H1;class _r{static _CreateDumpRenderer(){if(!_r._DumpToolsEngine){const e=document.createElement("canvas"),t=new we(e,!1,{preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1});t.getCaps().parallelShaderCompile=void 0;const i=new uv(t),s=new sl({engine:t,name:W1_name,fragmentShader:W1_shader,samplerNames:["textureSampler"]});_r._DumpToolsEngine={canvas:e,engine:t,renderer:i,wrapper:s}}return _r._DumpToolsEngine}static DumpFramebuffer(e,t,i,s,n="image/png",o){return Qt(function*(){const a=yield i.readPixels(0,0,e,t),l=new Uint8Array(a.buffer);_r.DumpData(e,t,l,s,n,o,!0)})()}static DumpDataAsync(e,t,i,s="image/png",n,o=!1,a=!1,l){return new Promise(c=>{_r.DumpData(e,t,i,h=>c(h),s,n,o,a,l)})}static DumpData(e,t,i,s,n="image/png",o,a=!1,l=!1,c){const h=_r._CreateDumpRenderer();if(h.engine.setSize(e,t,!0),i instanceof Float32Array){const d=new Uint8Array(i.length);let f=i.length;for(;f--;){const p=i[f];d[f]=p<0?0:p>1?1:Math.round(255*p)}i=d}const u=h.engine.createRawTexture(i,e,t,5,!1,!a,1);h.renderer.setViewport(),h.renderer.applyEffectWrapper(h.wrapper),h.wrapper.effect._bindTexture("textureSampler",u),h.renderer.draw(),l?q.ToBlob(h.canvas,d=>{const f=new FileReader;f.onload=p=>{s&&s(p.target.result)},f.readAsArrayBuffer(d)},n,c):q.EncodeScreenshotCanvasData(h.canvas,s,n,o,c),u.dispose()}static Dispose(){_r._DumpToolsEngine&&(_r._DumpToolsEngine.wrapper.dispose(),_r._DumpToolsEngine.renderer.dispose(),_r._DumpToolsEngine.engine.dispose()),_r._DumpToolsEngine=null}}q.DumpData=_r.DumpData,q.DumpDataAsync=_r.DumpDataAsync,q.DumpFramebuffer=_r.DumpFramebuffer;let Ss=(()=>{class r extends U{get renderList(){return this._renderList}set renderList(t){this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),t&&(this._unObserveRenderList=zF(t,this._renderListHasChanged)),this._renderList=t}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(t){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(t)}set onBeforeRender(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)}set onAfterRender(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)}set onClear(t){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(t)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(t,i){let s;s=Array.isArray(t)?t:[t];for(let n=0;n<s.length;++n)for(let o=0;o<this._renderPassIds.length;++o)s[n].setMaterialForRenderPass(this._renderPassIds[o],void 0!==i?Array.isArray(i)?i[o]:i:void 0)}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(t){if(this._boundingBoxSize&&this._boundingBoxSize.equals(t))return;this._boundingBoxSize=t;const i=this.getScene();i&&i.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var t,i;return null!==(i=null===(t=this._renderTarget)||void 0===t?void 0:t._depthStencilTexture)&&void 0!==i?i:null}constructor(t,i,s,n=!1,o=!0,a=0,l=!1,c=U.TRILINEAR_SAMPLINGMODE,h=!0,u=!1,d=!1,f=5,p=!1,_,m,g=!1,b=!1){var y,T,x,S,C,D;let P;if("object"==typeof n){const w=n;n=!!w.generateMipMaps,o=null===(y=w.doNotChangeAspectRatio)||void 0===y||y,a=null!==(T=w.type)&&void 0!==T?T:0,l=!!w.isCube,c=null!==(x=w.samplingMode)&&void 0!==x?x:U.TRILINEAR_SAMPLINGMODE,h=null===(S=w.generateDepthBuffer)||void 0===S||S,u=!!w.generateStencilBuffer,d=!!w.isMulti,f=null!==(C=w.format)&&void 0!==C?C:5,p=!!w.delayAllocation,_=w.samples,m=w.creationFlags,g=!!w.noColorAttachment,b=!!w.useSRGBBuffer,P=w.colorAttachment}if(super(null,s,!n,void 0,c,void 0,void 0,void 0,void 0,f),this._unObserveRenderList=null,this._renderListHasChanged=(w,k)=>{var X;const te=this._renderList?this._renderList.length:0;(0===k&&te>0||0===te)&&(null===(X=this.getScene())||void 0===X||X.meshes.forEach(J=>{J._markSubMeshesAsLightDirty()}))},this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new z,this.onAfterUnbindObservable=new z,this.onBeforeRenderObservable=new z,this.onAfterRenderObservable=new z,this.onClearObservable=new z,this.onResizeObservable=new z,this._cleared=!1,this.skipInitialClear=!1,this._currentRefreshId=-1,this._refreshRate=1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=v.Zero(),!(s=this.getScene()))return;const M=this.getScene().getEngine();this._coordinatesMode=U.PROJECTION_MODE,this.renderList=new Array,this.name=t,this.isRenderTarget=!0,this._initialSizeParameter=i,this._renderPassIds=[],this._isCubeData=l,this._processSizeParameter(i),this.renderPassId=this._renderPassIds[0],this._resizeObserver=M.onResizeObservable.add(()=>{}),this._generateMipMaps=!!n,this._doNotChangeAspectRatio=o,this._renderingManager=new Jg(s),this._renderingManager._useSceneAutoClearSetup=!0,!d&&(this._renderTargetOptions={generateMipMaps:n,type:a,format:null!==(D=this._format)&&void 0!==D?D:void 0,samplingMode:this.samplingMode,generateDepthBuffer:h,generateStencilBuffer:u,samples:_,creationFlags:m,noColorAttachment:g,useSRGBBuffer:b,colorAttachment:P},this.samplingMode===U.NEAREST_SAMPLINGMODE&&(this.wrapU=U.CLAMP_ADDRESSMODE,this.wrapV=U.CLAMP_ADDRESSMODE),p||(l?(this._renderTarget=s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=U.INVCUBIC_MODE,this._textureMatrix=F.Identity()):this._renderTarget=s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==_&&(this.samples=_)))}createDepthStencilTexture(t=0,i=!0,s=!1,n=1,o=14){var a;null===(a=this._renderTarget)||void 0===a||a.createDepthStencilTexture(t,i,s,n,o)}_releaseRenderPassId(){if(this._scene){const t=this._scene.getEngine();for(let i=0;i<this._renderPassIds.length;++i)t.releaseRenderPassId(this._renderPassIds[i])}this._renderPassIds=[]}_createRenderPassId(){this._releaseRenderPassId();const t=this._scene.getEngine(),i=this._isCubeData?6:this.getRenderLayers()||1;for(let s=0;s<i;++s)this._renderPassIds[s]=t.createRenderPassId(`RenderTargetTexture - ${this.name}#${s}`)}_processSizeParameter(t){if(t.ratio){this._sizeRatio=t.ratio;const i=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(i.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(i.getRenderHeight(),this._sizeRatio)}}else this._size=t;this._createRenderPassId()}get samples(){var t,i;return null!==(i=null===(t=this._renderTarget)||void 0===t?void 0:t.samples)&&void 0!==i?i:this._samples}set samples(t){this._renderTarget&&(this._samples=this._renderTarget.setSamples(t))}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(t){this._refreshRate=t,this.resetRefreshCounter()}addPostProcess(t){if(!this._postProcessManager){const i=this.getScene();if(!i)return;this._postProcessManager=new Zg(i),this._postProcesses=new Array}this._postProcesses.push(t),this._postProcesses[0].autoClear=!1}clearPostProcesses(t=!1){if(this._postProcesses){if(t)for(const i of this._postProcesses)i.dispose();this._postProcesses=[]}}removePostProcess(t){if(!this._postProcesses)return;const i=this._postProcesses.indexOf(t);-1!==i&&(this._postProcesses.splice(i,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}_shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){return this._size.layers||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(t){const i=Math.max(1,this.getRenderSize()*t);this.resize(i)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(t){var i;const s=this.isCube;null===(i=this._renderTarget)||void 0===i||i.dispose(),this._renderTarget=null;const n=this.getScene();!n||(this._processSizeParameter(t),this._renderTarget=s?n.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):n.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(t=!1,i=!1){this._render(t,i)}isReadyForRendering(){return this._render(!1,!1,!0)}_render(t=!1,i=!1,s=!1){var n;const o=this.getScene();if(!o)return s;const a=o.getEngine();if(void 0!==this.useCameraPostProcesses&&(t=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(let d=0;d<this._waitingRenderList.length;d++){const p=o.getMeshById(this._waitingRenderList[d]);p&&this.renderList.push(p)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const d=this.getScene();if(!d)return s;const f=d.meshes;for(let p=0;p<f.length;p++){const _=f[p];this.renderListPredicate(_)&&this.renderList.push(_)}}const l=a.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);const c=null!==(n=this.activeCamera)&&void 0!==n?n:o.activeCamera,h=o.activeCamera;c&&(c!==o.activeCamera&&(o.setTransformMatrix(c.getViewMatrix(),c.getProjectionMatrix(!0)),o.activeCamera=c),a.setViewport(c.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;let u=s;if(s){o.getViewMatrix()||o.updateTransformMatrix();const d=this.is2DArray?this.getRenderLayers():this.isCube?6:1;for(let f=0;f<d&&u;f++){let p=null;const _=this.renderList?this.renderList:o.getActiveMeshes().data,m=this.renderList?this.renderList.length:o.getActiveMeshes().length;a.currentRenderPassId=this._renderPassIds[f],this.onBeforeRenderObservable.notifyObservers(f),this.getCustomRenderList&&(p=this.getCustomRenderList(f,_,m)),p||(p=_),this._doNotChangeAspectRatio||o.updateTransformMatrix(!0);for(let g=0;g<p.length&&u;++g){const b=p[g];if(b.isEnabled()&&!b.isBlocked&&b.isVisible&&b.subMeshes)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(b,this.refreshRate,s)){u=!1;continue}}else if(!b.isReady(!0)){u=!1;continue}}this.onAfterRenderObservable.notifyObservers(f),(this.is2DArray||this.isCube)&&(o.incrementRenderId(),o.resetCachedMaterial())}}else if(this.is2DArray)for(let d=0;d<this.getRenderLayers();d++)this._renderToTarget(0,t,i,d,c),o.incrementRenderId(),o.resetCachedMaterial();else if(this.isCube)for(let d=0;d<6;d++)this._renderToTarget(d,t,i,void 0,c),o.incrementRenderId(),o.resetCachedMaterial();else this._renderToTarget(0,t,i,void 0,c);return this.onAfterUnbindObservable.notifyObservers(this),a.currentRenderPassId=l,h&&(o.activeCamera=h,(o.getEngine().scenes.length>1||this.activeCamera&&this.activeCamera!==o.activeCamera)&&o.setTransformMatrix(o.activeCamera.getViewMatrix(),o.activeCamera.getProjectionMatrix(!0)),a.setViewport(o.activeCamera.viewport)),o.resetCachedMaterial(),u}_bestReflectionRenderTargetDimension(t,i){const n=t*i,o=ee.NearestPOT(n+16384/(128+n));return Math.min(ee.FloorPOT(t),o)}_prepareRenderingManager(t,i,s,n){const o=this.getScene();if(!o)return;this._renderingManager.reset();const a=o.getRenderId();for(let l=0;l<i;l++){const c=t[l];if(c&&!c.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(c,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!c.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}if(!c._internalAbstractMeshDataInfo._currentLODIsUpToDate&&o.activeCamera&&(c._internalAbstractMeshDataInfo._currentLOD=o.customLODSelector?o.customLODSelector(c,this.activeCamera||o.activeCamera):c.getLOD(this.activeCamera||o.activeCamera),c._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!c._internalAbstractMeshDataInfo._currentLOD)continue;let u,h=c._internalAbstractMeshDataInfo._currentLOD;if(h._preActivateForIntermediateRendering(a),u=!(!n||!s)&&0==(c.layerMask&s.layerMask),c.isEnabled()&&c.isVisible&&c.subMeshes&&!u&&(h!==c&&h._activate(a,!0),c._activate(a,!0)&&c.subMeshes.length)){c.isAnInstance?c._internalAbstractMeshDataInfo._actAsRegularMesh&&(h=c):h._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,h._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(let d=0;d<h.subMeshes.length;d++)this._renderingManager.dispatch(h.subMeshes[d],h)}}}for(let l=0;l<o.particleSystems.length;l++){const c=o.particleSystems[l],h=c.emitter;!c.isStarted()||!h||h.position&&!h.isEnabled()||this._renderingManager.dispatchParticles(c)}}_bindFrameBuffer(t=0,i=0){const s=this.getScene();if(!s)return;const n=s.getEngine();this._renderTarget&&n.bindFramebuffer(this._renderTarget,this.isCube?t:void 0,void 0,void 0,this.ignoreCameraViewport,0,i)}_unbindFrameBuffer(t,i){!this._renderTarget||t.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(i)})}_prepareFrame(t,i,s,n){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!n||!t.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(i,s)}_renderToTarget(t,i,s,n=0,o=null){var a,l,c,h,u,d;const f=this.getScene();if(!f)return;const p=f.getEngine();if(null===(a=p._debugPushGroup)||void 0===a||a.call(p,`render to face #${t} layer #${n}`,1),this._prepareFrame(f,t,n,i),this.is2DArray?(p.currentRenderPassId=this._renderPassIds[n],this.onBeforeRenderObservable.notifyObservers(n)):(p.currentRenderPassId=this._renderPassIds[t],this.onBeforeRenderObservable.notifyObservers(t)),p.snapshotRendering&&1===p.snapshotRenderingMode)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(p):this.skipInitialClear||p.clear(this.clearColor||f.clearColor,!0,!0,!0);else{let m=null;const g=this.renderList?this.renderList:f.getActiveMeshes().data,b=this.renderList?this.renderList.length:f.getActiveMeshes().length;this.getCustomRenderList&&(m=this.getCustomRenderList(this.is2DArray?n:t,g,b)),m?this._prepareRenderingManager(m,m.length,o,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(g,b,o,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),m=g);for(const T of f._beforeRenderTargetClearStage)T.action(this,t,n);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(p):this.skipInitialClear||p.clear(this.clearColor||f.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||f.updateTransformMatrix(!0);for(const T of f._beforeRenderTargetDrawStage)T.action(this,t,n);this._renderingManager.render(this.customRenderFunction,m,this.renderParticles,this.renderSprites);for(const T of f._afterRenderTargetDrawStage)T.action(this,t,n);const y=null!==(c=null===(l=this._texture)||void 0===l?void 0:l.generateMipMaps)&&void 0!==c&&c;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,null!==(h=this._renderTarget)&&void 0!==h?h:void 0,t,this._postProcesses,this.ignoreCameraViewport):i&&f.postProcessManager._finalizeFrame(!1,null!==(u=this._renderTarget)&&void 0!==u?u:void 0,t);for(const T of f._afterRenderTargetPostProcessStage)T.action(this,t,n);this._texture&&(this._texture.generateMipMaps=y),this._doNotChangeAspectRatio||f.updateTransformMatrix(!0),s&&_r.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),p)}this._unbindFrameBuffer(p,t),this._texture&&this.isCube&&5===t&&p.generateMipMapsForCubemap(this._texture),null===(d=p._debugPopGroup)||void 0===d||d.call(p,1)}setRenderingOrder(t,i=null,s=null,n=null){this._renderingManager.setRenderingOrder(t,i,s,n)}setRenderingAutoClearDepthStencil(t,i){this._renderingManager.setRenderingAutoClearDepthStencil(t,i),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const t=this.getSize(),i=new r(this.name,t,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.coordinatesMode=this.coordinatesMode,this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const t=super.serialize();if(t.renderTargetSize=this.getRenderSize(),t.renderList=[],this.renderList)for(let i=0;i<this.renderList.length;i++)t.renderList.push(this.renderList[i].id);return t}disposeFramebufferObjects(){var t;null===(t=this._renderTarget)||void 0===t||t.dispose(!0)}releaseInternalTexture(){var t;null===(t=this._renderTarget)||void 0===t||t.releaseTextures(),this._texture=null}dispose(){var t;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;const i=this.getScene();if(!i)return;let s=i.customRenderTargets.indexOf(this);s>=0&&i.customRenderTargets.splice(s,1);for(const n of i.cameras)s=n.customRenderTargets.indexOf(this),s>=0&&n.customRenderTargets.splice(s,1);null===(t=this._renderTarget)||void 0===t||t.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this.refreshRate===r.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=r.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}getViewCount(){return 1}}return r.REFRESHRATE_RENDER_ONCE=0,r.REFRESHRATE_RENDER_ONEVERYFRAME=1,r.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,r})();U._CreateRenderTargetTexture=(r,e,t,i,s)=>new Ss(r,e,t,i);class xse{constructor(e){this.name=Me.NAME_PROCEDURALTEXTURE,this.scene=e,this.scene.proceduralTextures=new Array}register(){this.scene._beforeClearStage.registerStep(Me.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){q.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){const t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}q.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}}j.ShadersStore.proceduralVertexShader="attribute vec2 position;\nvarying vec2 vPosition;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvPosition=position;\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class da extends U{constructor(e,t,i,s,n=null,o=!0,a=!1,l=0){super(null,s,!o),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new z,this.onBeforeGenerationObservable=new z,this.nodeMaterialSource=null,this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null;let c=(s=this.getScene()||be.LastCreatedScene)._getComponent(Me.NAME_PROCEDURALTEXTURE);c||(c=new xse(s),s._addComponent(c)),s.proceduralTextures.push(this),this._fullEngine=s.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=t,this._textureType=l,this._generateMipMaps=o,this._drawWrapper=new $i(this._fullEngine),this.setFragment(i),this._fallbackTexture=n;const h=this._createRtWrapper(a,t,o,l);this._texture=h.texture;const u=[];u.push(1,1),u.push(-1,1),u.push(-1,-1),u.push(1,-1),this._vertexBuffers[A.PositionKind]=new A(this._fullEngine,u,A.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,i,s){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:s}),this.setFloat("face",0)):this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:s}),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId||(this._contentData?this._contentData.then(e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId)),this._contentData}_createIndexBuffer(){const e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[A.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===Ss.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Ss.REFRESHRATE_RENDER_ONCE)}reset(){var e;null===(e=this._drawWrapper.effect)||void 0===e||e.dispose()}_getDefines(){return""}isReady(){const e=this._fullEngine;let t;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;const i=this._getDefines();return!(!this._drawWrapper.effect||i!==this._cachedDefines||!this._drawWrapper.effect.isReady())||(t=void 0!==this._fragment.fragmentElement?{vertex:"procedural",fragmentElement:this._fragment.fragmentElement}:{vertex:"procedural",fragment:this._fragment},this._cachedDefines!==i&&(this._cachedDefines=i,this._drawWrapper.effect=e.createEffect(t,[A.PositionKind],this._uniforms,this._samplers,i,void 0,void 0,()=>{var s;null===(s=this._rtWrapper)||void 0===s||s.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0})),this._drawWrapper.effect.isReady())}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return this.isEnabled&&this.isReady()&&this._texture?!this._fallbackTextureUsed&&(-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)):(this._texture&&(this._texture.isReady=!1),!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;const i=this._texture.isCube;this._rtWrapper.dispose();const s=this._createRtWrapper(i,e,t,this._textureType);this._texture=s.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){-1===this._uniforms.indexOf(e)&&this._uniforms.push(e)}setTexture(e,t){return-1===this._samplers.indexOf(e)&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){var t,i;const s=this.getScene();if(!s)return;const n=this._fullEngine;if(n.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),n.setState(!1),!this.nodeMaterialSource){for(const a in this._textures)this._drawWrapper.effect.setTexture(a,this._textures[a]);for(const a in this._ints)this._drawWrapper.effect.setInt(a,this._ints[a]);for(const a in this._floats)this._drawWrapper.effect.setFloat(a,this._floats[a]);for(const a in this._floatsArrays)this._drawWrapper.effect.setArray(a,this._floatsArrays[a]);for(const a in this._colors3)this._drawWrapper.effect.setColor3(a,this._colors3[a]);for(const a in this._colors4){const l=this._colors4[a];this._drawWrapper.effect.setFloat4(a,l.r,l.g,l.b,l.a)}for(const a in this._vectors2)this._drawWrapper.effect.setVector2(a,this._vectors2[a]);for(const a in this._vectors3)this._drawWrapper.effect.setVector3(a,this._vectors3[a]);for(const a in this._matrices)this._drawWrapper.effect.setMatrix(a,this._matrices[a])}if(!this._texture||!this._rtWrapper)return;null===(t=n._debugPushGroup)||void 0===t||t.call(n,`procedural texture generation for ${this.name}`,1);const o=n.currentViewport;if(this.isCube)for(let a=0;a<6;a++)n.bindFramebuffer(this._rtWrapper,a,void 0,void 0,!0),n.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",a),this.autoClear&&n.clear(s.clearColor,!0,!1,!1),n.drawElementsType(ie.TriangleFillMode,0,6);else n.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0),n.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this.autoClear&&n.clear(s.clearColor,!0,!1,!1),n.drawElementsType(ie.TriangleFillMode,0,6);n.unBindFramebuffer(this._rtWrapper,this.isCube),o&&n.setViewport(o),this.isCube&&n.generateMipMapsForCubemap(this._texture),null===(i=n._debugPopGroup)||void 0===i||i.call(n,1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){const e=this.getSize(),t=new da(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){const e=this.getScene();if(!e)return;const t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);const i=this._vertexBuffers[A.PositionKind];i&&(i.dispose(),this._vertexBuffers[A.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}}E([I()],da.prototype,"isEnabled",void 0),E([I()],da.prototype,"autoClear",void 0),E([I()],da.prototype,"_generateMipMaps",void 0),E([I()],da.prototype,"_size",void 0),E([I()],da.prototype,"refreshRate",null),le("BABYLON.ProceduralTexture",da);var ss=(()=>{return(r=ss||(ss={}))[r.Cos=0]="Cos",r[r.Sin=1]="Sin",r[r.Abs=2]="Abs",r[r.Exp=3]="Exp",r[r.Exp2=4]="Exp2",r[r.Round=5]="Round",r[r.Floor=6]="Floor",r[r.Ceiling=7]="Ceiling",r[r.Sqrt=8]="Sqrt",r[r.Log=9]="Log",r[r.Tan=10]="Tan",r[r.ArcTan=11]="ArcTan",r[r.ArcCos=12]="ArcCos",r[r.ArcSin=13]="ArcSin",r[r.Fract=14]="Fract",r[r.Sign=15]="Sign",r[r.Radians=16]="Radians",r[r.Degrees=17]="Degrees",ss;var r})();class Y1 extends De{constructor(e){super(e,B.Neutral),this.operation=ss.Cos,this.registerInput("input",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="";switch(this.operation){case ss.Cos:i="cos";break;case ss.Sin:i="sin";break;case ss.Abs:i="abs";break;case ss.Exp:i="exp";break;case ss.Exp2:i="exp2";break;case ss.Round:i="round";break;case ss.Floor:i="floor";break;case ss.Ceiling:i="ceil";break;case ss.Sqrt:i="sqrt";break;case ss.Log:i="log";break;case ss.Tan:i="tan";break;case ss.ArcTan:i="atan";break;case ss.ArcCos:i="acos";break;case ss.ArcSin:i="asin";break;case ss.Fract:i="fract";break;case ss.Sign:i="sign";break;case ss.Radians:i="radians";break;case ss.Degrees:i="degrees"}return e.compilationString+=this._declareOutput(t,e)+` = ${i}(${this.input.associatedVariableName});\r\n`,this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${ss[this.operation]};\r\n`}}le("BABYLON.TrigonometryBlock",Y1);const FE={effect:null,subMesh:null};class dv extends Un{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.rebuild()}setValue(e,t,i=!1){void 0===this[e]&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}}class Ri extends gp{static _BlockIsTextureBlock(e){return"TextureBlock"===e.getClassName()||"ReflectionTextureBaseBlock"===e.getClassName()||"RefractionBlock"===e.getClassName()||"CurrentScreenBlock"===e.getClassName()||"ParticleTextureBlock"===e.getClassName()||"ImageSourceBlock"===e.getClassName()||"TriPlanarBlock"===e.getClassName()||"BiPlanarBlock"===e.getClassName()}_getGlobalNodeMaterialEditor(){return typeof NODEEDITOR<"u"?NODEEDITOR:typeof BABYLON<"u"&&typeof BABYLON.NodeEditor<"u"?BABYLON:void 0}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,i={}){super(e,t||be.LastCreatedScene),this._buildId=Ri._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new F,this._cachedWorldViewProjectionMatrix=new F,this._optimizers=new Array,this._animationFrame=-1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new z,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=new Array,this._mode=wr.Material,this.forceAlphaBlending=!1,this._options={emitComments:!1,...i},this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e){if(t)return q.Warn("More than one block was found with the name `"+e+"`"),t;t=i}return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(const t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){const t=this._optimizers.indexOf(e);if(-1!==t)return this._optimizers.splice(t,1),this}addOutputNode(e){if(null===e.target)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return 0!=(e.target&B.Vertex)&&this._addVertexOutputNode(e),0!=(e.target&B.Fragment)&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return null===e.target||(0!=(e.target&B.Vertex)&&this._removeVertexOutputNode(e),0!=(e.target&B.Fragment)&&this._removeFragmentOutputNode(e)),this}_addVertexOutputNode(e){if(-1===this._vertexOutputNodes.indexOf(e))return e.target=B.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){const t=this._vertexOutputNodes.indexOf(e);if(-1!==t)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(-1===this._fragmentOutputNodes.indexOf(e))return e.target=B.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){const t=this._fragmentOutputNodes.indexOf(e);if(-1!==t)return this._fragmentOutputNodes.splice(t,1),this}needAlphaBlending(){return!this.ignoreAlpha&&(this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending)}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_initializeBlock(e,t,i,s=!0){if(e.initialize(t),s&&e.autoConfigure(this),e._preparationId=this._buildId,-1===this.attachedBlocks.indexOf(e)){if(e.isUnique){const n=e.getClassName();for(const o of this.attachedBlocks)if(o.getClassName()===n)throw`Cannot have multiple blocks of type ${n} in the same NodeMaterial`}this.attachedBlocks.push(e)}for(const n of e.inputs){n.associatedVariableName="";const o=n.connectedPoint;if(o){const a=o.ownerBlock;a!==e&&((a.target===B.VertexAndFragment||t.target===B.Fragment&&a.target===B.Vertex&&a._preparationId!==this._buildId)&&i.push(a),this._initializeBlock(a,t,i,s))}}for(const n of e.outputs)n.associatedVariableName=""}_resetDualBlocks(e,t){e.target===B.VertexAndFragment&&(e.buildId=t);for(const i of e.inputs){const s=i.connectedPoint;if(s){const n=s.ownerBlock;n!==e&&this._resetDualBlocks(n,t)}}}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!0){this._buildWasSuccessful=!1;const s=this.getScene().getEngine(),n=this._mode===wr.Particle;if(0===this._vertexOutputNodes.length&&!n)throw"You must define at least one vertexOutputNode";if(0===this._fragmentOutputNodes.length)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new D1,this._vertexCompilationState.supportUniformBuffers=s.supportsUniformBuffers,this._vertexCompilationState.target=B.Vertex,this._fragmentCompilationState=new D1,this._fragmentCompilationState.supportUniformBuffers=s.supportsUniformBuffers,this._fragmentCompilationState.target=B.Fragment,this._sharedData=new vse,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=n;const o=[],a=[];for(const c of this._vertexOutputNodes)o.push(c),this._initializeBlock(c,this._vertexCompilationState,a,i);for(const c of this._fragmentOutputNodes)a.push(c),this._initializeBlock(c,this._fragmentCompilationState,o,i);this.optimize();for(const c of o)c.build(this._vertexCompilationState,o);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(const c of a)this._resetDualBlocks(c,this._buildId-1);for(const c of a)c.build(this._fragmentCompilationState,a);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=Ri._BuildIdGenerator++),this._sharedData.emitErrors(),e&&(console.log("Vertex shader:"),console.log(this._vertexCompilationState.compilationString),console.log("Fragment shader:"),console.log(this._fragmentCompilationState.compilationString)),this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this);const l=this.getScene().meshes;for(const c of l)if(c.subMeshes)for(const h of c.subMeshes){if(h.getMaterial()!==this||!h.materialDefines)continue;const u=h.materialDefines;u.markAllAsDirty(),u.reset()}}optimize(){for(const e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){const i=t.NORMAL,s=t.TANGENT;t.NORMAL=e.isVerticesDataPresent(A.NormalKind),t.TANGENT=e.isVerticesDataPresent(A.TangentKind);let n=!1;for(let o=1;o<=6;++o){const a=t["UV"+o];t["UV"+o]=e.isVerticesDataPresent(`uv${1===o?"":o}`),n=n||t["UV"+o]!==a}(i!==t.NORMAL||s!==t.TANGENT||n)&&t.markAsAttributesDirty()}createPostProcess(e,t=1,i=1,s,n,o=0,a=5){return this.mode!==wr.PostProcess?(console.log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,s,n,o,a)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,s=1,n,o,a=0,l=5){let c=this.name+this._buildId;const h=new dv,u=new Zt(c+"PostProcess",this.getScene());let d=this._buildId;return this._processDefines(u,h),Ot.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),e?e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c):e=new Pe(this.name+"PostProcess",c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,s,n,o,h.toString(),a,c,{maxSimultaneousLights:this.maxSimultaneousLights},!1,l),e.nodeMaterialSource=this,e.onApplyObservable.add(f=>{d!==this._buildId&&(delete Ot.ShadersStore[c+"VertexShader"],delete Ot.ShadersStore[c+"PixelShader"],c=this.name+this._buildId,h.markAllAsDirty(),d=this._buildId),this._processDefines(u,h)&&(Ot.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),ku.SetImmediate(()=>e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c))),this._checkInternals(f)}),e}createProceduralTexture(e,t){if(this.mode!==wr.ProceduralTexture)return console.log("Incompatible material mode"),null;let i=this.name+this._buildId;const s=new da(i,e,null,t),n=new Zt(i+"Procedural",this.getScene());n.reservedDataStore={hidden:!0};const o=new dv,a=this._processDefines(n,o);Ot.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString);let l=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[A.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString(),a?.fallbacks,void 0);s.nodeMaterialSource=this,s._setEffect(l);let c=this._buildId;return s.onBeforeGenerationObservable.add(()=>{c!==this._buildId&&(delete Ot.ShadersStore[i+"VertexShader"],delete Ot.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,o.markAllAsDirty(),c=this._buildId);const h=this._processDefines(n,o);h&&(Ot.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),ku.SetImmediate(()=>{l=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[A.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString(),h?.fallbacks,void 0),s._setEffect(l)})),this._checkInternals(l)}),s}_createEffectForParticles(e,t,i,s,n,o,a,l=""){let c=this.name+this._buildId+"_"+t;o||(o=new dv),a||(a=this.getScene().getMeshByName(this.name+"Particle"))||((a=new Zt(this.name+"Particle",this.getScene())).reservedDataStore={hidden:!0});let h=this._buildId;const u=[];let d=l;if(!n){const f=this._processDefines(a,o);Ot.RegisterShader(c,this._fragmentCompilationState._builtCompilationString),e.fillDefines(u,t),d=u.join("\n"),n=this.getScene().getEngine().createEffectForParticles(c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString()+"\n"+d,f?.fallbacks,i,s,e),e.setCustomEffect(n,t)}n.onBindObservable.add(f=>{h!==this._buildId&&(delete Ot.ShadersStore[c+"PixelShader"],c=this.name+this._buildId+"_"+t,o.markAllAsDirty(),h=this._buildId),u.length=0,e.fillDefines(u,t);const p=u.join("\n");p!==d&&(o.markAllAsDirty(),d=p);const _=this._processDefines(a,o);if(_)return Ot.RegisterShader(c,this._fragmentCompilationState._builtCompilationString),f=this.getScene().getEngine().createEffectForParticles(c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString()+"\n"+d,_?.fallbacks,i,s,e),e.setCustomEffect(f,t),void this._createEffectForParticles(e,t,i,s,f,o,a,l);this._checkInternals(f)})}_checkInternals(e){if(this._sharedData.animatedInputs){const t=this.getScene(),i=t.getFrameId();if(this._animationFrame!==i){for(const s of this._sharedData.animatedInputs)s.animate(t);this._animationFrame=i}}for(const t of this._sharedData.bindableBlocks)t.bind(e,this);for(const t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){this.mode===wr.Particle?(this._createEffectForParticles(e,hv.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,hv.BLENDMODE_MULTIPLY,t,i)):console.log("Incompatible material mode")}createAsShadowDepthWrapper(e){this.mode===wr.Material?e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene()):console.log("Incompatible material mode")}_processDefines(e,t,i=!1,s){let n=null;const o=this.getScene();if(ce.PrepareDefinesForCamera(o,t)&&t.markAsMiscDirty(),this._sharedData.blocksWithDefines.forEach(a=>{a.initializeDefines(e,this,t,i)}),this._sharedData.blocksWithDefines.forEach(a=>{a.prepareDefines(e,this,t,i,s)}),t.isDirty){const a=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach(d=>{d.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,t)});const l=[];this._sharedData.dynamicUniformBlocks.forEach(d=>{d.updateUniformsAndSamples(this._vertexCompilationState,this,t,l)});const c=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach(d=>{-1===c.indexOf(d)&&c.push(d)});const h=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach(d=>{-1===h.indexOf(d)&&h.push(d)});const u=new oh;this._sharedData.blocksWithFallbacks.forEach(d=>{d.provideFallbacks(e,u)}),n={lightDisposed:a,uniformBuffers:l,mergedUniforms:c,mergedSamplers:h,fallbacks:u}}return n}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;const s=this.getScene();if(this._sharedData.animatedInputs){const l=s.getFrameId();if(this._animationFrame!==l){for(const c of this._sharedData.animatedInputs)c.animate(s);this._animationFrame=l}}if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new dv);const n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=s.getEngine();if(this._prepareDefinesForAttributes(e,n),this._sharedData.blockingBlocks.some(l=>!l.isReady(e,this,n,i)))return!1;const a=this._processDefines(e,n,i,t);if(a){const l=t.effect,c=n.toString();let h=o.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:a.mergedUniforms,uniformBuffersNames:a.uniformBuffers,samplers:a.mergedSamplers,defines:c,fallbacks:a.fallbacks,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:n.NUM_MORPH_INFLUENCERS}},o);if(h)if(this._onEffectCreatedObservable&&(FE.effect=h,FE.subMesh=t,this._onEffectCreatedObservable.notifyObservers(FE)),this.allowShaderHotSwapping&&l&&!h.isReady()){if(h=l,n.markAsUnprocessed(),a.lightDisposed)return n._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(h,n,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(n._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}get compiledShaders(){return`// Vertex shader\r\n${this._vertexCompilationState.compilationString}\r\n\r\n// Fragment shader\r\n${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){const t=this.getScene();if(!this._activeEffect)return;const i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(const s of this._sharedData.inputBlocks)s._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){const s=this.getScene(),n=i.effect;if(!n)return;this._activeEffect=n,this.bindOnlyWorldMatrix(e);const o=this._mustRebind(s,n,t.visibility),a=this._sharedData;if(o){for(const l of a.bindableBlocks)l.bind(n,this,t,i);for(const l of a.forcedBindableBlocks)l.bind(n,this,t,i);for(const l of a.inputBlocks)l._transmit(n,s,this)}else if(!this.isFrozen)for(const l of a.forcedBindableBlocks)l.bind(n,this,t,i);this._afterBind(t,this._activeEffect)}getActiveTextures(){const e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter(t=>t.texture).map(t=>t.texture)),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){const e=[];for(const t of this.attachedBlocks)Ri._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(const t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(const s of this.getTextureBlocks().filter(n=>n.texture).map(n=>n.texture))s.dispose();for(const s of this.attachedBlocks)s.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(){this.BJSNODEMATERIALEDITOR.NodeEditor.Show({nodeMaterial:this})}edit(e){return new Promise(t=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),typeof this.BJSNODEMATERIALEDITOR>"u"?q.LoadScript(e&&e.editorURL?e.editorURL:Ri.EditorURL,()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(),t()}):(this._createNodeEditor(),t())})}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0}setToDefault(){this.clear(),this.editorData=null;const e=new et("Position");e.setAsAttribute("position");const t=new et("World");t.setAsSystemValue(it.World);const i=new ME("WorldPos");e.connectTo(i),t.connectTo(i);const s=new et("ViewProjection");s.setAsSystemValue(it.ViewProjection);const n=new ME("WorldPos * ViewProjectionTransform");i.connectTo(n),s.connectTo(n);const o=new iv("VertexOutput");n.connectTo(o);const a=new et("color");a.value=new Te(.8,.8,.8,1);const l=new Zl("FragmentOutput");a.connectTo(l),this.addOutputNode(o),this.addOutputNode(l),this._mode=wr.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const e=new et("Position");e.setAsAttribute("position2d");const t=new et("Constant1");t.isConstant=!0,t.value=1;const i=new sv("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const s=new iv("VertexOutput");i.connectTo(s);const n=new et("Scale");n.visibleInInspector=!0,n.value=new de(1,1);const o=new rv("uv0");e.connectTo(o);const a=new wE("UV scale");o.connectTo(a),n.connectTo(a);const l=new F1("CurrentScreen");a.connectTo(l),l.texture=new U("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());const c=new Zl("FragmentOutput");l.connectTo(c,{output:"rgba"}),this.addOutputNode(s),this.addOutputNode(c),this._mode=wr.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const e=new et("Position");e.setAsAttribute("position2d");const t=new et("Constant1");t.isConstant=!0,t.value=1;const i=new sv("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const s=new iv("VertexOutput");i.connectTo(s);const n=new et("Time");n.value=0,n.min=0,n.max=0,n.isBoolean=!1,n.matrixMode=0,n.animationType=il.Time,n.isConstant=!1;const o=new et("Color3");o.value=new re(1,1,1),o.isConstant=!1;const a=new Zl("FragmentOutput"),l=new sv("VectorMerger");l.visibleInInspector=!1;const c=new Y1("Cos");c.operation=ss.Cos,e.connectTo(l),n.output.connectTo(c.input),c.output.connectTo(l.z),l.xyzOut.connectTo(a.rgb),this.addOutputNode(s),this.addOutputNode(a),this._mode=wr.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const e=new et("uv");e.setAsAttribute("particle_uv");const t=new L1("ParticleTexture");e.connectTo(t);const i=new et("Color");i.setAsAttribute("particle_color");const s=new wE("Texture * Color");t.connectTo(s),i.connectTo(s);const n=new B1("ParticleRampGradient");s.connectTo(n);const o=new G1("ColorSplitter");i.connectTo(o);const a=new V1("ParticleBlendMultiply");n.connectTo(a),t.connectTo(a,{output:"a"}),o.connectTo(a,{output:"a"});const l=new Zl("FragmentOutput");a.connectTo(l),this.addOutputNode(l),this._mode=wr.Particle}loadAsync(e,t=""){var i=this;return Qt(function*(){return Ri.ParseFromFileAsync("",e,i.getScene(),t,!0,i)})()}_gatherBlocks(e,t){if(-1===t.indexOf(e)){t.push(e);for(const i of e.inputs){const s=i.connectedPoint;if(s){const n=s.ownerBlock;n!==e&&this._gatherBlocks(n,t)}}}}generateCode(){let e=[];const t=[],i=["const","var","let"];for(const o of this._vertexOutputNodes)this._gatherBlocks(o,t);const s=[];for(const o of this._fragmentOutputNodes)this._gatherBlocks(o,s);let n=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");\r\n`;for(const o of t)o.isInput&&-1===e.indexOf(o)&&(n+=o._dumpCode(i,e));for(const o of s)o.isInput&&-1===e.indexOf(o)&&(n+=o._dumpCode(i,e));e=[],n+="\r\n// Connections\r\n";for(const o of this._vertexOutputNodes)n+=o._dumpCodeForOutputConnections(e);for(const o of this._fragmentOutputNodes)n+=o._dumpCodeForOutputConnections(e);n+="\r\n// Output nodes\r\n";for(const o of this._vertexOutputNodes)n+=`nodeMaterial.addOutputNode(${o._codeVariableName});\r\n`;for(const o of this._fragmentOutputNodes)n+=`nodeMaterial.addOutputNode(${o._codeVariableName});\r\n`;return n+="nodeMaterial.build();\r\n",n}serialize(e){const t=e?{}:Ce.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(const s of this._vertexOutputNodes)this._gatherBlocks(s,i),t.outputNodes.push(s.uniqueId);for(const s of this._fragmentOutputNodes)this._gatherBlocks(s,i),-1===t.outputNodes.indexOf(s.uniqueId)&&t.outputNodes.push(s.uniqueId)}t.blocks=[];for(const s of i)t.blocks.push(s.serialize());if(!e)for(const s of this.attachedBlocks)-1===i.indexOf(s)&&t.blocks.push(s.serialize());return t}_restoreConnections(e,t,i){for(const s of e.outputs)for(const n of t.blocks){const o=i[n.id];if(o)for(const a of n.inputs)if(i[a.targetBlockId]===e&&a.targetConnectionName===s.name){const l=o.getInputByName(a.inputName);if(!l||l.isConnected)continue;s.connectTo(l,!0),this._restoreConnections(o,t,i);continue}}}parseSerializedObject(e,t="",i=!1){var s;i||this.clear();const n={};for(const o of e.blocks){const a=hs(o.customType);if(a){const l=new a;l._deserialize(o,this.getScene(),t),n[o.id]=l,this.attachedBlocks.push(l)}}for(let o=0;o<e.blocks.length;o++){const l=n[e.blocks[o].id];!l||l.inputs.length&&!i||this._restoreConnections(l,e,n)}if(e.outputNodes)for(const o of e.outputNodes)this.addOutputNode(n[o]);if(e.locations||e.editorData&&e.editorData.locations){const o=e.locations||e.editorData.locations;for(const l of o)n[l.blockId]&&(l.blockId=n[l.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&o.concat(this.editorData.locations),e.locations?this.editorData={locations:o}:(this.editorData=e.editorData,this.editorData.locations=o);const a=[];for(const l in n)a[l]=n[l].uniqueId;this.editorData.map=a}this.comment=e.comment,void 0!==e.forceAlphaBlending&&(this.forceAlphaBlending=e.forceAlphaBlending),i||(this._mode=null!==(s=e.mode)&&void 0!==s?s:wr.Material)}loadFromSerialization(e,t="",i=!1){this.parseSerializedObject(e,t,i)}clone(e,t=!1){const i=this.serialize(),s=Ce.Clone(()=>new Ri(e,this.getScene(),this.options),this);return s.id=e,s.name=e,s.parseSerializedObject(i),s._buildId=this._buildId,s.build(!1,!t),s}static Parse(e,t,i=""){const s=Ce.Parse(()=>new Ri(e.name,t),e,t,i);return s.parseSerializedObject(e,i),s.build(),s}static ParseFromFileAsync(e,t,i,s="",n=!1,o){return Qt(function*(){const a=o??new Ri(e,i),l=yield i._loadFileAsync(t),c=JSON.parse(l);return a.parseSerializedObject(c,s),n||a.build(),a})()}static ParseFromSnippetAsync(e,t=be.LastCreatedScene,i="",s,n=!1){return"_BLANK"===e?Promise.resolve(Ri.CreateDefault("blank",t)):new Promise((o,a)=>{const l=new Yi;l.addEventListener("readystatechange",()=>{if(4==l.readyState)if(200==l.status){const c=JSON.parse(JSON.parse(l.responseText).jsonPayload),h=JSON.parse(c.nodeMaterial);s||((s=Ce.Parse(()=>new Ri(e,t),h,t,i)).uniqueId=t.getUniqueId()),s.parseSerializedObject(h),s.snippetId=e;try{n||s.build(),o(s)}catch(u){a(u)}}else a("Unable to load the snippet "+e)}),l.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),l.send()})}static CreateDefault(e,t){const i=new Ri(e,t);return i.setToDefault(),i.build(),i}}function q1(r){const e=r.sideOrientation||ue.DEFAULTSIDE,t=r.radius||1,i=void 0===r.flat||r.flat,s=r.subdivisions||4,n=r.radiusX||t,o=r.radiusY||t,a=r.radiusZ||t,l=(1+Math.sqrt(5))/2,c=[-1,l,-0,1,l,0,-1,-l,0,1,-l,0,0,-1,-l,0,1,-l,0,-1,l,0,1,l,l,0,1,l,0,-1,-l,0,1,-l,0,-1],h=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],u=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],d=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],y=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],T=new Array,x=new Array,S=new Array,C=new Array;let D=0;const P=new Array(3),M=new Array(3);let w;for(w=0;w<3;w++)P[w]=v.Zero(),M[w]=de.Zero();for(let X=0;X<20;X++){for(w=0;w<3;w++){const J=h[3*X+w];P[w].copyFromFloats(c[3*u[J]],c[3*u[J]+1],c[3*u[J]+2]),P[w].normalize(),M[w].copyFromFloats(.134765625*d[2*J]+.05859375+-.0390625*y[X],.2333984375*d[2*J+1]+.025390625+.01953125*y[X])}const te=(J,Q,me,ae)=>{const W=v.Lerp(P[0],P[2],Q/s),K=v.Lerp(P[1],P[2],Q/s),O=s===Q?P[2]:v.Lerp(W,K,J/(s-Q));let H;if(O.normalize(),i){const Fe=v.Lerp(P[0],P[2],ae/s),se=v.Lerp(P[1],P[2],ae/s);H=v.Lerp(Fe,se,me/(s-ae))}else H=new v(O.x,O.y,O.z);H.x/=n,H.y/=o,H.z/=a,H.normalize();const Y=de.Lerp(M[0],M[2],Q/s),he=de.Lerp(M[1],M[2],Q/s),Le=s===Q?M[2]:de.Lerp(Y,he,J/(s-Q));x.push(O.x*n,O.y*o,O.z*a),S.push(H.x,H.y,H.z),C.push(Le.x,It.UseOpenGLOrientationForUV?1-Le.y:Le.y),T.push(D),D++};for(let J=0;J<s;J++)for(let Q=0;Q+J<s;Q++)te(Q,J,Q+1/3,J+1/3),te(Q+1,J,Q+1/3,J+1/3),te(Q,J+1,Q+1/3,J+1/3),Q+J+1<s&&(te(Q+1,J,Q+2/3,J+2/3),te(Q+1,J+1,Q+2/3,J+2/3),te(Q,J+1,Q+2/3,J+2/3))}ue._ComputeSides(e,x,T,S,C,r.frontUVs,r.backUVs);const k=new ue;return k.indices=T,k.positions=x,k.normals=S,k.uvs=C,k}function fv(r,e={},t=null){const i=new G(r,t);return e.sideOrientation=G._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,q1(e).applyToMesh(i,e.updatable),i}Ri._BuildIdGenerator=0,Ri.EditorURL=`https://unpkg.com/babylonjs-node-editor@${ee.Version}/babylon.nodeEditor.js`,Ri.SnippetUrl="https://snippet.babylonjs.com",Ri.IgnoreTexturesAtLoadTime=!1,E([I()],Ri.prototype,"ignoreAlpha",void 0),E([I()],Ri.prototype,"maxSimultaneousLights",void 0),E([I("mode")],Ri.prototype,"_mode",void 0),E([I("comment")],Ri.prototype,"comment",void 0),E([I()],Ri.prototype,"forceAlphaBlending",void 0),le("BABYLON.NodeMaterial",Ri),ue.CreateIcoSphere=q1,G.CreateIcoSphere=(r,e,t)=>fv(r,e,t);var rl=(()=>{return(r=rl||(rl={})).WRIST="wrist",r.THUMB="thumb",r.INDEX="index",r.MIDDLE="middle",r.RING="ring",r.LITTLE="little",rl;var r})(),Ve=(()=>{return(r=Ve||(Ve={})).WRIST="wrist",r.THUMB_METACARPAL="thumb-metacarpal",r.THUMB_PHALANX_PROXIMAL="thumb-phalanx-proximal",r.THUMB_PHALANX_DISTAL="thumb-phalanx-distal",r.THUMB_TIP="thumb-tip",r.INDEX_FINGER_METACARPAL="index-finger-metacarpal",r.INDEX_FINGER_PHALANX_PROXIMAL="index-finger-phalanx-proximal",r.INDEX_FINGER_PHALANX_INTERMEDIATE="index-finger-phalanx-intermediate",r.INDEX_FINGER_PHALANX_DISTAL="index-finger-phalanx-distal",r.INDEX_FINGER_TIP="index-finger-tip",r.MIDDLE_FINGER_METACARPAL="middle-finger-metacarpal",r.MIDDLE_FINGER_PHALANX_PROXIMAL="middle-finger-phalanx-proximal",r.MIDDLE_FINGER_PHALANX_INTERMEDIATE="middle-finger-phalanx-intermediate",r.MIDDLE_FINGER_PHALANX_DISTAL="middle-finger-phalanx-distal",r.MIDDLE_FINGER_TIP="middle-finger-tip",r.RING_FINGER_METACARPAL="ring-finger-metacarpal",r.RING_FINGER_PHALANX_PROXIMAL="ring-finger-phalanx-proximal",r.RING_FINGER_PHALANX_INTERMEDIATE="ring-finger-phalanx-intermediate",r.RING_FINGER_PHALANX_DISTAL="ring-finger-phalanx-distal",r.RING_FINGER_TIP="ring-finger-tip",r.PINKY_FINGER_METACARPAL="pinky-finger-metacarpal",r.PINKY_FINGER_PHALANX_PROXIMAL="pinky-finger-phalanx-proximal",r.PINKY_FINGER_PHALANX_INTERMEDIATE="pinky-finger-phalanx-intermediate",r.PINKY_FINGER_PHALANX_DISTAL="pinky-finger-phalanx-distal",r.PINKY_FINGER_TIP="pinky-finger-tip",Ve;var r})();const ko=[Ve.WRIST,Ve.THUMB_METACARPAL,Ve.THUMB_PHALANX_PROXIMAL,Ve.THUMB_PHALANX_DISTAL,Ve.THUMB_TIP,Ve.INDEX_FINGER_METACARPAL,Ve.INDEX_FINGER_PHALANX_PROXIMAL,Ve.INDEX_FINGER_PHALANX_INTERMEDIATE,Ve.INDEX_FINGER_PHALANX_DISTAL,Ve.INDEX_FINGER_TIP,Ve.MIDDLE_FINGER_METACARPAL,Ve.MIDDLE_FINGER_PHALANX_PROXIMAL,Ve.MIDDLE_FINGER_PHALANX_INTERMEDIATE,Ve.MIDDLE_FINGER_PHALANX_DISTAL,Ve.MIDDLE_FINGER_TIP,Ve.RING_FINGER_METACARPAL,Ve.RING_FINGER_PHALANX_PROXIMAL,Ve.RING_FINGER_PHALANX_INTERMEDIATE,Ve.RING_FINGER_PHALANX_DISTAL,Ve.RING_FINGER_TIP,Ve.PINKY_FINGER_METACARPAL,Ve.PINKY_FINGER_PHALANX_PROXIMAL,Ve.PINKY_FINGER_PHALANX_INTERMEDIATE,Ve.PINKY_FINGER_PHALANX_DISTAL,Ve.PINKY_FINGER_TIP],Tse={[rl.WRIST]:[Ve.WRIST],[rl.THUMB]:[Ve.THUMB_METACARPAL,Ve.THUMB_PHALANX_PROXIMAL,Ve.THUMB_PHALANX_DISTAL,Ve.THUMB_TIP],[rl.INDEX]:[Ve.INDEX_FINGER_METACARPAL,Ve.INDEX_FINGER_PHALANX_PROXIMAL,Ve.INDEX_FINGER_PHALANX_INTERMEDIATE,Ve.INDEX_FINGER_PHALANX_DISTAL,Ve.INDEX_FINGER_TIP],[rl.MIDDLE]:[Ve.MIDDLE_FINGER_METACARPAL,Ve.MIDDLE_FINGER_PHALANX_PROXIMAL,Ve.MIDDLE_FINGER_PHALANX_INTERMEDIATE,Ve.MIDDLE_FINGER_PHALANX_DISTAL,Ve.MIDDLE_FINGER_TIP],[rl.RING]:[Ve.RING_FINGER_METACARPAL,Ve.RING_FINGER_PHALANX_PROXIMAL,Ve.RING_FINGER_PHALANX_INTERMEDIATE,Ve.RING_FINGER_PHALANX_DISTAL,Ve.RING_FINGER_TIP],[rl.LITTLE]:[Ve.PINKY_FINGER_METACARPAL,Ve.PINKY_FINGER_PHALANX_PROXIMAL,Ve.PINKY_FINGER_PHALANX_INTERMEDIATE,Ve.PINKY_FINGER_PHALANX_DISTAL,Ve.PINKY_FINGER_TIP]};class Sse{get handMesh(){return this._handMesh}getHandPartMeshes(e){return Tse[e].map(t=>this._jointMeshes[ko.indexOf(t)])}getJointMesh(e){return this._jointMeshes[ko.indexOf(e)]}constructor(e,t,i,s,n=!1,o=!1,a=1){this.xrController=e,this._jointMeshes=t,this._handMesh=i,this.rigMapping=s,this._leftHandedMeshes=n,this._jointsInvisible=o,this._jointScaleFactor=a,this._jointTransforms=new Array(ko.length),this._jointTransformMatrices=new Float32Array(16*ko.length),this._tempJointMatrix=new F,this._jointRadii=new Float32Array(ko.length),this._scene=t[0].getScene();for(let l=0;l<this._jointTransforms.length;l++)(this._jointTransforms[l]=new We(ko[l],this._scene)).rotationQuaternion=new Z,t[l].rotationQuaternion=new Z;i&&this.setHandMesh(i,s),this.xrController.motionController&&(this.xrController.motionController.rootMesh?this.xrController.motionController.rootMesh.setEnabled(!1):this.xrController.motionController.onModelLoadedObservable.add(l=>{l.rootMesh&&l.rootMesh.setEnabled(!1)})),this.xrController.onMotionControllerInitObservable.add(l=>{l.onModelLoadedObservable.add(c=>{c.rootMesh&&c.rootMesh.setEnabled(!1)}),l.rootMesh&&l.rootMesh.setEnabled(!1)})}setHandMesh(e,t){if(this._handMesh=e,e.alwaysSelectAsActiveMesh=!0,e.getChildMeshes().forEach(i=>i.alwaysSelectAsActiveMesh=!0),this._handMesh.skeleton){const i=this._handMesh.skeleton;ko.forEach((s,n)=>{const o=i.getBoneIndexByName(t?t[s]:s);-1!==o&&i.bones[o].linkTransformNode(this._jointTransforms[n])})}}updateFromXRFrame(e,t){const i=this.xrController.inputSource.hand;if(!i)return;const s=i,n=ko.map(a=>s[a]||i.get(a));let o=!1;if(e.fillPoses&&e.fillJointRadii)o=e.fillPoses(n,t,this._jointTransformMatrices)&&e.fillJointRadii(n,this._jointRadii);else if(e.getJointPose){o=!0;for(let a=0;a<n.length;a++){const l=e.getJointPose(n[a],t);if(!l){o=!1;break}this._jointTransformMatrices.set(l.transform.matrix,16*a),this._jointRadii[a]=l.radius||.008}}!o||(ko.forEach((a,l)=>{const c=this._jointTransforms[l];F.FromArrayToRef(this._jointTransformMatrices,16*l,this._tempJointMatrix),this._tempJointMatrix.decompose(void 0,c.rotationQuaternion,c.position);const h=this._jointRadii[l]*this._jointScaleFactor,u=this._jointMeshes[l];u.isVisible=!this._handMesh&&!this._jointsInvisible,u.position.copyFrom(c.position),u.rotationQuaternion.copyFrom(c.rotationQuaternion),u.scaling.setAll(h),this._scene.useRightHandedSystem||(u.position.z*=-1,u.rotationQuaternion.z*=-1,u.rotationQuaternion.w*=-1,this._leftHandedMeshes&&this._handMesh&&(c.position.z*=-1,c.rotationQuaternion.z*=-1,c.rotationQuaternion.w*=-1))}),this._handMesh&&(this._handMesh.isVisible=!0))}dispose(){this._handMesh&&(this._handMesh.isVisible=!1)}}class Yt extends Xs{static _GenerateTrackedJointMeshes(e){const t={};return["left","right"].map(i=>{var s,n,o,a,l;const c=[],h=(null===(s=e.jointMeshes)||void 0===s?void 0:s.sourceMesh)||fv("jointParent",Yt._ICOSPHERE_PARAMS);h.isVisible=!(null===(n=e.jointMeshes)||void 0===n||!n.keepOriginalVisible);for(let u=0;u<ko.length;++u){let d=h.createInstance(`${i}-handJoint-${u}`);if(null!==(o=e.jointMeshes)&&void 0!==o&&o.onHandJointMeshGenerated){const f=e.jointMeshes.onHandJointMeshGenerated(d,u,i);f&&f!==d&&(d.dispose(),d=f)}if(d.isPickable=!1,null!==(a=e.jointMeshes)&&void 0!==a&&a.enablePhysics){const f=(null===(l=e.jointMeshes)||void 0===l?void 0:l.physicsProps)||{};d.scaling.setAll(.02),d.physicsImpostor=new Be(d,void 0!==f.impostorType?f.impostorType:Be.SphereImpostor,{mass:0,...f})}d.rotationQuaternion=new Z,d.isVisible=!1,c.push(d)}t[i]=c}),{left:t.left,right:t.right}}static _GenerateDefaultHandMeshesAsync(e,t){return new Promise(function(){var i=Qt(function*(s){var n,o,a,l,c;const h={};!(null===(o=null===(n=Yt._RightHandGLB)||void 0===n?void 0:n.meshes[1])||void 0===o)&&o.isDisposed()&&(Yt._RightHandGLB=null),null!==(l=null===(a=Yt._LeftHandGLB)||void 0===a?void 0:a.meshes[1])&&void 0!==l&&l.isDisposed()&&(Yt._LeftHandGLB=null);const u=!(!Yt._RightHandGLB||!Yt._LeftHandGLB),d=yield Promise.all([Yt._RightHandGLB||ke.ImportMeshAsync("",Yt.DEFAULT_HAND_MODEL_BASE_URL,Yt.DEFAULT_HAND_MODEL_RIGHT_FILENAME,e),Yt._LeftHandGLB||ke.ImportMeshAsync("",Yt.DEFAULT_HAND_MODEL_BASE_URL,Yt.DEFAULT_HAND_MODEL_LEFT_FILENAME,e)]);Yt._RightHandGLB=d[0],Yt._LeftHandGLB=d[1];const f=new Ri("handShader",e,{emitComments:!1});yield f.loadAsync(Yt.DEFAULT_HAND_MODEL_SHADER_URL),f.needDepthPrePass=!0,f.transparencyMode=ie.MATERIAL_ALPHABLEND,f.alphaMode=2,f.build(!1);const p={base:re.FromInts(116,63,203),fresnel:re.FromInts(149,102,229),fingerColor:re.FromInts(177,130,255),tipFresnel:re.FromInts(220,200,255),...null===(c=t?.handMeshes)||void 0===c?void 0:c.customColors},_={base:f.getBlockByName("baseColor"),fresnel:f.getBlockByName("fresnelColor"),fingerColor:f.getBlockByName("fingerColor"),tipFresnel:f.getBlockByName("tipFresnelColor")};_.base.value=p.base,_.fresnel.value=p.fresnel,_.fingerColor.value=p.fingerColor,_.tipFresnel.value=p.tipFresnel,["left","right"].forEach(m=>{const g="left"==m?Yt._LeftHandGLB:Yt._RightHandGLB;if(!g)throw new Error("Could not load hand model");const b=g.meshes[1];b._internalAbstractMeshDataInfo._computeBonesUsingShaders=!0,b.material=f.clone(`${m}HandShaderClone`,!0),b.isVisible=!1,h[m]=b,!u&&!e.useRightHandedSystem&&g.meshes[1].rotate(fs.Y,Math.PI)}),f.dispose(),s({left:h.left,right:h.right})});return function(s){return i.apply(this,arguments)}}())}static _GenerateDefaultHandMeshRigMapping(e){const t="right"==e?"R":"L";return{[Ve.WRIST]:`wrist_${t}`,[Ve.THUMB_METACARPAL]:`thumb_metacarpal_${t}`,[Ve.THUMB_PHALANX_PROXIMAL]:`thumb_proxPhalanx_${t}`,[Ve.THUMB_PHALANX_DISTAL]:`thumb_distPhalanx_${t}`,[Ve.THUMB_TIP]:`thumb_tip_${t}`,[Ve.INDEX_FINGER_METACARPAL]:`index_metacarpal_${t}`,[Ve.INDEX_FINGER_PHALANX_PROXIMAL]:`index_proxPhalanx_${t}`,[Ve.INDEX_FINGER_PHALANX_INTERMEDIATE]:`index_intPhalanx_${t}`,[Ve.INDEX_FINGER_PHALANX_DISTAL]:`index_distPhalanx_${t}`,[Ve.INDEX_FINGER_TIP]:`index_tip_${t}`,[Ve.MIDDLE_FINGER_METACARPAL]:`middle_metacarpal_${t}`,[Ve.MIDDLE_FINGER_PHALANX_PROXIMAL]:`middle_proxPhalanx_${t}`,[Ve.MIDDLE_FINGER_PHALANX_INTERMEDIATE]:`middle_intPhalanx_${t}`,[Ve.MIDDLE_FINGER_PHALANX_DISTAL]:`middle_distPhalanx_${t}`,[Ve.MIDDLE_FINGER_TIP]:`middle_tip_${t}`,[Ve.RING_FINGER_METACARPAL]:`ring_metacarpal_${t}`,[Ve.RING_FINGER_PHALANX_PROXIMAL]:`ring_proxPhalanx_${t}`,[Ve.RING_FINGER_PHALANX_INTERMEDIATE]:`ring_intPhalanx_${t}`,[Ve.RING_FINGER_PHALANX_DISTAL]:`ring_distPhalanx_${t}`,[Ve.RING_FINGER_TIP]:`ring_tip_${t}`,[Ve.PINKY_FINGER_METACARPAL]:`little_metacarpal_${t}`,[Ve.PINKY_FINGER_PHALANX_PROXIMAL]:`little_proxPhalanx_${t}`,[Ve.PINKY_FINGER_PHALANX_INTERMEDIATE]:`little_intPhalanx_${t}`,[Ve.PINKY_FINGER_PHALANX_DISTAL]:`little_distPhalanx_${t}`,[Ve.PINKY_FINGER_TIP]:`little_tip_${t}`}}isCompatible(){return typeof XRHand<"u"}getHandByControllerId(e){return this._attachedHands[e]}getHandByHandedness(e){return"none"==e?null:this._trackingHands[e]}constructor(e,t){super(e),this.options=t,this._attachedHands={},this._trackingHands={left:null,right:null},this._handResources={jointMeshes:null,handMeshes:null,rigMappings:null},this.onHandAddedObservable=new z,this.onHandRemovedObservable=new z,this._attachHand=n=>{var o,a,l;if(!n.inputSource.hand||"none"==n.inputSource.handedness||!this._handResources.jointMeshes)return;const c=n.inputSource.handedness,h=new Sse(n,this._handResources.jointMeshes[c],this._handResources.handMeshes&&this._handResources.handMeshes[c],this._handResources.rigMappings&&this._handResources.rigMappings[c],null===(o=this.options.handMeshes)||void 0===o?void 0:o.meshesUseLeftHandedCoordinates,null===(a=this.options.jointMeshes)||void 0===a?void 0:a.invisible,null===(l=this.options.jointMeshes)||void 0===l?void 0:l.scaleFactor);this._attachedHands[n.uniqueId]=h,this._trackingHands[c]=h,this.onHandAddedObservable.notifyObservers(h)},this._detachHand=n=>{this._detachHandById(n.uniqueId)},this.xrNativeFeatureName="hand-tracking";const s=t.jointMeshes;if(s&&(typeof s.disableDefaultHandMesh<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.disableDefaultMeshes=s.disableDefaultHandMesh),typeof s.handMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.customMeshes=s.handMeshes),typeof s.leftHandedSystemMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.meshesUseLeftHandedCoordinates=s.leftHandedSystemMeshes),typeof s.rigMapping<"u")){t.handMeshes=t.handMeshes||{};const n={},o={};[[s.rigMapping.left,n],[s.rigMapping.right,o]].forEach(a=>{const c=a[1];a[0].forEach((h,u)=>{c[ko[u]]=h})}),t.handMeshes.customRigMappings={left:n,right:o}}}attach(){var e,t,i,s;return!!super.attach()&&(this._handResources={jointMeshes:Yt._GenerateTrackedJointMeshes(this.options),handMeshes:(null===(e=this.options.handMeshes)||void 0===e?void 0:e.customMeshes)||null,rigMappings:(null===(t=this.options.handMeshes)||void 0===t?void 0:t.customRigMappings)||null},!(null!==(i=this.options.handMeshes)&&void 0!==i&&i.customMeshes)&&!(null!==(s=this.options.handMeshes)&&void 0!==s&&s.disableDefaultMeshes)&&Yt._GenerateDefaultHandMeshesAsync(be.LastCreatedScene,this.options).then(n=>{var o,a;this._handResources.handMeshes=n,this._handResources.rigMappings={left:Yt._GenerateDefaultHandMeshRigMapping("left"),right:Yt._GenerateDefaultHandMeshRigMapping("right")},null===(o=this._trackingHands.left)||void 0===o||o.setHandMesh(this._handResources.handMeshes.left,this._handResources.rigMappings.left),null===(a=this._trackingHands.right)||void 0===a||a.setHandMesh(this._handResources.handMeshes.right,this._handResources.rigMappings.right)}),this.options.xrInput.controllers.forEach(this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,this._detachHand),!0)}_onXRFrame(e){var t,i;null===(t=this._trackingHands.left)||void 0===t||t.updateFromXRFrame(e,this._xrSessionManager.referenceSpace),null===(i=this._trackingHands.right)||void 0===i||i.updateFromXRFrame(e,this._xrSessionManager.referenceSpace)}_detachHandById(e){var t;const i=this.getHandByControllerId(e);if(i){const s="left"==i.xrController.inputSource.handedness?"left":"right";(null===(t=this._trackingHands[s])||void 0===t?void 0:t.xrController.uniqueId)===e&&(this._trackingHands[s]=null),this.onHandRemovedObservable.notifyObservers(i),i.dispose(),delete this._attachedHands[e]}}detach(){return!!super.detach()&&(Object.keys(this._attachedHands).forEach(e=>this._detachHandById(e)),!0)}dispose(){var e;super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this._handResources.handMeshes&&!(null!==(e=this.options.handMeshes)&&void 0!==e&&e.customMeshes)&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),Yt._RightHandGLB=null,Yt._LeftHandGLB=null),this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach(t=>t.dispose()),this._handResources.jointMeshes.right.forEach(t=>t.dispose()))}}Yt.Name=Ki.HAND_TRACKING,Yt.Version=1,Yt.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/meshes/HandMeshes/",Yt.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb",Yt.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb",Yt.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/meshes/HandMeshes/handsShader.json",Yt._ICOSPHERE_PARAMS={radius:.5,flat:!1,subdivisions:2},Yt._RightHandGLB=null,Yt._LeftHandGLB=null,Ai.AddWebXRFeature(Yt.Name,(r,e)=>()=>new Yt(r,e),Yt.Version,!1);class zn{get maxAngle(){return this._maxAngle}set maxAngle(e){this._setMaxAngle(e)}constructor(e,t,i){this.targetPosition=v.Zero(),this.poleTargetPosition=v.Zero(),this.poleTargetLocalOffset=v.Zero(),this.poleAngle=0,this.slerpAmount=1,this._bone1Quat=Z.Identity(),this._bone1Mat=F.Identity(),this._bone2Ang=Math.PI,this._maxAngle=Math.PI,this._rightHandedSystem=!1,this._bendAxis=v.Right(),this._slerping=!1,this._adjustRoll=0,this._notEnoughInformation=!1,this._bone2=t;const s=t.getParent();if(!s)return this._notEnoughInformation=!0,void V.Error("BoneIKController: bone must have a parent for IK to work.");if(this._bone1=s,0===this._bone2.children.length&&!this._bone2.length)return this._notEnoughInformation=!0,void V.Error("BoneIKController: bone must not be a leaf or it should have a length for IK to work.");this.mesh=e;const n=t.getPosition();if(t.getAbsoluteTransform().determinant()>0&&(this._rightHandedSystem=!0,this._bendAxis.x=0,this._bendAxis.y=0,this._bendAxis.z=-1,n.x>n.y&&n.x>n.z&&(this._adjustRoll=.5*Math.PI,this._bendAxis.z=1)),this._bone1.length&&this._bone2.length){const o=this._bone1.getScale(),a=this._bone2.getScale();this._bone1Length=this._bone1.length*o.y*this.mesh.scaling.y,this._bone2Length=this._bone2.length*a.y*this.mesh.scaling.y}else if(this._bone2.children[0]){e.computeWorldMatrix(!0);const o=this._bone2.children[0].getAbsolutePosition(e),a=this._bone2.getAbsolutePosition(e),l=this._bone1.getAbsolutePosition(e);this._bone2Length=v.Distance(o,a),this._bone1Length=v.Distance(a,l)}else{e.computeWorldMatrix(!0);const o=this._bone2.getScale();this._bone2Length=this._bone2.length*o.y*this.mesh.scaling.y;const a=this._bone2.getAbsolutePosition(e),l=this._bone1.getAbsolutePosition(e);this._bone1Length=v.Distance(a,l)}this._bone1.getRotationMatrixToRef($e.WORLD,e,this._bone1Mat),this.maxAngle=Math.PI,i&&(i.targetMesh&&(this.targetMesh=i.targetMesh,this.targetMesh.computeWorldMatrix(!0)),i.poleTargetMesh?(this.poleTargetMesh=i.poleTargetMesh,this.poleTargetMesh.computeWorldMatrix(!0)):i.poleTargetBone?this.poleTargetBone=i.poleTargetBone:this._bone1.getParent()&&(this.poleTargetBone=this._bone1.getParent()),i.poleTargetLocalOffset&&this.poleTargetLocalOffset.copyFrom(i.poleTargetLocalOffset),i.poleAngle&&(this.poleAngle=i.poleAngle),i.bendAxis&&this._bendAxis.copyFrom(i.bendAxis),i.maxAngle&&(this.maxAngle=i.maxAngle),i.slerpAmount&&(this.slerpAmount=i.slerpAmount))}_setMaxAngle(e){e<0&&(e=0),(e>Math.PI||null==e)&&(e=Math.PI),this._maxAngle=e;const t=this._bone1Length,i=this._bone2Length;this._maxReach=Math.sqrt(t*t+i*i-2*t*i*Math.cos(e))}update(){if(this._notEnoughInformation)return;const e=this.targetPosition,t=this.poleTargetPosition,i=zn._TmpMats[0],s=zn._TmpMats[1];this.targetMesh&&e.copyFrom(this.targetMesh.getAbsolutePosition()),this.poleTargetBone?this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,t):this.poleTargetMesh&&v.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),t);const n=zn._TmpVecs[0],o=zn._TmpVecs[1],a=zn._TmpVecs[2],l=zn._TmpVecs[3],c=zn._TmpVecs[4],h=zn._TmpQuat;this._bone1.getAbsolutePositionToRef(this.mesh,n),t.subtractToRef(n,c),0==c.x&&0==c.y&&0==c.z?c.y=1:c.normalize(),e.subtractToRef(n,l),l.normalize(),v.CrossToRef(l,c,o),o.normalize(),v.CrossToRef(l,o,a),a.normalize(),F.FromXYZAxesToRef(a,l,o,i);const u=this._bone1Length,d=this._bone2Length;let f=v.Distance(n,e);this._maxReach>0&&(f=Math.min(this._maxReach,f));let p=(d*d+f*f-u*u)/(2*d*f),_=(f*f+u*u-d*d)/(2*f*u);p>1&&(p=1),_>1&&(_=1),p<-1&&(p=-1),_<-1&&(_=-1);const m=Math.acos(p),g=Math.acos(_);let b=-m-g;if(this._rightHandedSystem)F.RotationYawPitchRollToRef(0,0,this._adjustRoll,s),s.multiplyToRef(i,i),F.RotationAxisToRef(this._bendAxis,g,s),s.multiplyToRef(i,i);else{const y=zn._TmpVecs[5];y.copyFrom(this._bendAxis),y.x*=-1,F.RotationAxisToRef(y,-g,s),s.multiplyToRef(i,i)}this.poleAngle&&(F.RotationAxisToRef(l,this.poleAngle,s),i.multiplyToRef(s,i)),this._bone1&&(this.slerpAmount<1?(this._slerping||Z.FromRotationMatrixToRef(this._bone1Mat,this._bone1Quat),Z.FromRotationMatrixToRef(i,h),Z.SlerpToRef(this._bone1Quat,h,this.slerpAmount,this._bone1Quat),b=this._bone2Ang*(1-this.slerpAmount)+b*this.slerpAmount,this._bone1.setRotationQuaternion(this._bone1Quat,$e.WORLD,this.mesh),this._slerping=!0):(this._bone1.setRotationMatrix(i,$e.WORLD,this.mesh),this._bone1Mat.copyFrom(i),this._slerping=!1),this._updateLinkedTransformRotation(this._bone1)),this._bone2.setAxisAngle(this._bendAxis,b,$e.LOCAL),this._updateLinkedTransformRotation(this._bone2),this._bone2Ang=b}_updateLinkedTransformRotation(e){e._linkedTransformNode&&(e._linkedTransformNode.rotationQuaternion||(e._linkedTransformNode.rotationQuaternion=new Z),e.getRotationQuaternionToRef($e.LOCAL,null,e._linkedTransformNode.rotationQuaternion))}}zn._TmpVecs=[v.Zero(),v.Zero(),v.Zero(),v.Zero(),v.Zero(),v.Zero()],zn._TmpQuat=Z.Identity(),zn._TmpMats=[F.Identity(),F.Identity()];class nr{get minYaw(){return this._minYaw}set minYaw(e){this._minYaw=e,this._minYawSin=Math.sin(e),this._minYawCos=Math.cos(e),null!=this._maxYaw&&(this._midYawConstraint=.5*this._getAngleDiff(this._minYaw,this._maxYaw)+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)}get maxYaw(){return this._maxYaw}set maxYaw(e){this._maxYaw=e,this._maxYawSin=Math.sin(e),this._maxYawCos=Math.cos(e),null!=this._minYaw&&(this._midYawConstraint=.5*this._getAngleDiff(this._minYaw,this._maxYaw)+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)}get minPitch(){return this._minPitch}set minPitch(e){this._minPitch=e,this._minPitchTan=Math.tan(e)}get maxPitch(){return this._maxPitch}set maxPitch(e){this._maxPitch=e,this._maxPitchTan=Math.tan(e)}constructor(e,t,i,s){if(this.upAxis=v.Up(),this.upAxisSpace=$e.LOCAL,this.adjustYaw=0,this.adjustPitch=0,this.adjustRoll=0,this.slerpAmount=1,this._boneQuat=Z.Identity(),this._slerping=!1,this._firstFrameSkipped=!1,this._fowardAxis=v.Forward(),this.mesh=e,this.bone=t,this.target=i,s&&(s.adjustYaw&&(this.adjustYaw=s.adjustYaw),s.adjustPitch&&(this.adjustPitch=s.adjustPitch),s.adjustRoll&&(this.adjustRoll=s.adjustRoll),this.maxYaw=null!=s.maxYaw?s.maxYaw:Math.PI,this.minYaw=null!=s.minYaw?s.minYaw:-Math.PI,this.maxPitch=null!=s.maxPitch?s.maxPitch:Math.PI,this.minPitch=null!=s.minPitch?s.minPitch:-Math.PI,null!=s.slerpAmount&&(this.slerpAmount=s.slerpAmount),null!=s.upAxis&&(this.upAxis=s.upAxis),null!=s.upAxisSpace&&(this.upAxisSpace=s.upAxisSpace),null!=s.yawAxis||null!=s.pitchAxis)){let n=fs.Y,o=fs.X;null!=s.yawAxis&&(n=s.yawAxis.clone(),n.normalize()),null!=s.pitchAxis&&(o=s.pitchAxis.clone(),o.normalize());const a=v.Cross(o,n);this._transformYawPitch=F.Identity(),F.FromXYZAxesToRef(o,n,a,this._transformYawPitch),this._transformYawPitchInv=this._transformYawPitch.clone(),this._transformYawPitch.invert()}!t.getParent()&&this.upAxisSpace==$e.BONE&&(this.upAxisSpace=$e.LOCAL)}update(){if(this.slerpAmount<1&&!this._firstFrameSkipped)return void(this._firstFrameSkipped=!0);const e=this.bone,t=nr._TmpVecs[0];e.getAbsolutePositionToRef(this.mesh,t);let i=this.target;const s=nr._TmpMats[0],n=nr._TmpMats[1],o=this.mesh,a=e.getParent(),l=nr._TmpVecs[1];l.copyFrom(this.upAxis),this.upAxisSpace==$e.BONE&&a?(this._transformYawPitch&&v.TransformCoordinatesToRef(l,this._transformYawPitchInv,l),a.getDirectionToRef(l,this.mesh,l)):this.upAxisSpace==$e.LOCAL&&(o.getDirectionToRef(l,l),(1!=o.scaling.x||1!=o.scaling.y||1!=o.scaling.z)&&l.normalize());let c=!1,h=!1;if((this._maxYaw!=Math.PI||this._minYaw!=-Math.PI)&&(c=!0),(this._maxPitch!=Math.PI||this._minPitch!=-Math.PI)&&(h=!0),c||h){const _=nr._TmpMats[2],m=nr._TmpMats[3];if(this.upAxisSpace==$e.BONE&&1==l.y&&a)a.getRotationMatrixToRef($e.WORLD,this.mesh,_);else if(this.upAxisSpace!=$e.LOCAL||1!=l.y||a){let b=nr._TmpVecs[2];b.copyFrom(this._fowardAxis),this._transformYawPitch&&v.TransformCoordinatesToRef(b,this._transformYawPitchInv,b),a?a.getDirectionToRef(b,this.mesh,b):o.getDirectionToRef(b,b);const y=v.Cross(l,b);y.normalize(),b=v.Cross(y,l),F.FromXYZAxesToRef(y,l,b,_)}else _.copyFrom(o.getWorldMatrix());_.invertToRef(m);let g=null;if(h){const b=nr._TmpVecs[3];i.subtractToRef(t,b),v.TransformCoordinatesToRef(b,m,b),g=Math.sqrt(b.x*b.x+b.z*b.z);const y=Math.atan2(b.y,g);let T=y;y>this._maxPitch?(b.y=this._maxPitchTan*g,T=this._maxPitch):y<this._minPitch&&(b.y=this._minPitchTan*g,T=this._minPitch),y!=T&&(v.TransformCoordinatesToRef(b,_,b),b.addInPlace(t),i=b)}if(c){const b=nr._TmpVecs[4];i.subtractToRef(t,b),v.TransformCoordinatesToRef(b,m,b);const y=Math.atan2(b.x,b.z);let T=y;if((y>this._maxYaw||y<this._minYaw)&&(null==g&&(g=Math.sqrt(b.x*b.x+b.z*b.z)),this._yawRange>Math.PI?this._isAngleBetween(y,this._maxYaw,this._midYawConstraint)?(b.z=this._maxYawCos*g,b.x=this._maxYawSin*g,T=this._maxYaw):this._isAngleBetween(y,this._midYawConstraint,this._minYaw)&&(b.z=this._minYawCos*g,b.x=this._minYawSin*g,T=this._minYaw):y>this._maxYaw?(b.z=this._maxYawCos*g,b.x=this._maxYawSin*g,T=this._maxYaw):y<this._minYaw&&(b.z=this._minYawCos*g,b.x=this._minYawSin*g,T=this._minYaw)),this._slerping&&this._yawRange>Math.PI){const x=nr._TmpVecs[8];x.copyFrom(fs.Z),this._transformYawPitch&&v.TransformCoordinatesToRef(x,this._transformYawPitchInv,x);const S=nr._TmpMats[4];this._boneQuat.toRotationMatrix(S),this.mesh.getWorldMatrix().multiplyToRef(S,S),v.TransformCoordinatesToRef(x,S,x),v.TransformCoordinatesToRef(x,m,x);const C=Math.atan2(x.x,x.z);if(this._getAngleBetween(C,y)>this._getAngleBetween(C,this._midYawConstraint)){null==g&&(g=Math.sqrt(b.x*b.x+b.z*b.z));const M=this._getAngleBetween(C,this._maxYaw);this._getAngleBetween(C,this._minYaw)<M?(T=C+.75*Math.PI,b.z=Math.cos(T)*g,b.x=Math.sin(T)*g):(T=C-.75*Math.PI,b.z=Math.cos(T)*g,b.x=Math.sin(T)*g)}}y!=T&&(v.TransformCoordinatesToRef(b,_,b),b.addInPlace(t),i=b)}}const u=nr._TmpVecs[5],d=nr._TmpVecs[6],f=nr._TmpVecs[7],p=nr._TmpQuat;i.subtractToRef(t,u),u.normalize(),v.CrossToRef(l,u,d),d.normalize(),v.CrossToRef(u,d,f),f.normalize(),F.FromXYZAxesToRef(d,f,u,s),(0!==d.x||0!==d.y||0!==d.z)&&(0===f.x&&0===f.y&&0===f.z||0===u.x&&0===u.y&&0===u.z||((this.adjustYaw||this.adjustPitch||this.adjustRoll)&&(F.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,n),n.multiplyToRef(s,s)),this.slerpAmount<1?(this._slerping||this.bone.getRotationQuaternionToRef($e.WORLD,this.mesh,this._boneQuat),this._transformYawPitch&&this._transformYawPitch.multiplyToRef(s,s),Z.FromRotationMatrixToRef(s,p),Z.SlerpToRef(this._boneQuat,p,this.slerpAmount,this._boneQuat),this.bone.setRotationQuaternion(this._boneQuat,$e.WORLD,this.mesh),this._slerping=!0):(this._transformYawPitch&&this._transformYawPitch.multiplyToRef(s,s),this.bone.setRotationMatrix(s,$e.WORLD,this.mesh),this._slerping=!1),this._updateLinkedTransformRotation()))}_getAngleDiff(e,t){let i=t-e;return i%=2*Math.PI,i>Math.PI?i-=2*Math.PI:i<-Math.PI&&(i+=2*Math.PI),i}_getAngleBetween(e,t){let i=0;return i=(e=(e%=2*Math.PI)<0?e+2*Math.PI:e)<(t=(t%=2*Math.PI)<0?t+2*Math.PI:t)?t-e:e-t,i>Math.PI&&(i=2*Math.PI-i),i}_isAngleBetween(e,t,i){if(e=(e%=2*Math.PI)<0?e+2*Math.PI:e,(t=(t%=2*Math.PI)<0?t+2*Math.PI:t)<(i=(i%=2*Math.PI)<0?i+2*Math.PI:i)){if(e>t&&e<i)return!0}else if(e>i&&e<t)return!0;return!1}_updateLinkedTransformRotation(){const e=this.bone;e._linkedTransformNode&&(e._linkedTransformNode.rotationQuaternion||(e._linkedTransformNode.rotationQuaternion=new Z),e.getRotationQuaternionToRef($e.LOCAL,null,e._linkedTransformNode.rotationQuaternion))}}nr._TmpVecs=is.BuildArray(10,v.Zero),nr._TmpQuat=Z.Identity(),nr._TmpMats=is.BuildArray(5,F.Identity);class Jl{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,i){this.name=e,this.id=t,this.bones=new Array,this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=F.Identity(),this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new z,this.bones=[],this._scene=i||be.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const s=this._scene.getEngine().getCaps();this._canUseTextureForBones=s.textureFloat&&s.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){return this.needInitialSkinMatrix?(e._bonesTransformMatrices||this.prepare(),e._bonesTransformMatrices):((!this._transformMatrices||this._isDirty)&&this.prepare(),this._transformMatrices)}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let i=!0;for(const s in this._ranges)i&&(t+=", ",i=!1),t+=s;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new Vu(e,t,i);for(let s=0,n=this.bones.length;s<n;s++)this.bones[s].animations[0]&&this.bones[s].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,s=this.bones.length;i<s;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let s=!0;const n=this._getHighestAnimationFrame()+1,o={},a=e.bones;let l,c;for(c=0,l=a.length;c<l;c++)o[a[c].name]=a[c];this.bones.length!==a.length&&(V.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${a.length}`),s=!1);const h=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(c=0,l=this.bones.length;c<l;c++){const d=this.bones[c].name,f=o[d];f?s=s&&this.bones[c].copyAnimationRange(f,t,n,i,h):(V.Warn("copyAnimationRange: not same rig, missing source bone "+d),s=!1)}const u=e.getAnimationRange(t);return u&&(this._ranges[t]=new Vu(t,u.from+n,u.to+n)),s}returnToRest(){for(const e of this.bones)-1!==e._index&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){const s=this.bones[t].animations[0].getHighestFrame();e<s&&(e=s)}return e}beginAnimation(e,t,i,s){const n=this.getAnimationRange(e);return n?this._scene.beginAnimation(this,n.from,n.to,t,i,s):null}static MakeAnimationAdditive(e,t=0,i){const s=e.getAnimationRange(i);if(!s)return null;const n=e._scene.getAllAnimatablesByTarget(e);let o=null;for(let l=0;l<n.length;l++){const c=n[l];if(c.fromFrame===s?.from&&c.toFrame===s?.to){o=c;break}}const a=e.getAnimatables();for(let l=0;l<a.length;l++){const h=a[l].animations;if(h)for(let u=0;u<h.length;u++)$.MakeAnimationAdditive(h[u],t,i)}return o&&(o.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){const s=this.bones[i];s._childUpdateId++;const n=s.getParent();if(n?s.getLocalMatrix().multiplyToRef(n.getWorldMatrix(),s.getWorldMatrix()):t?s.getLocalMatrix().multiplyToRef(t,s.getWorldMatrix()):s.getWorldMatrix().copyFrom(s.getLocalMatrix()),-1!==s._index){const o=null===s._index?i:s._index;s.getInvertedAbsoluteTransform().multiplyToArray(s.getWorldMatrix(),e,16*o)}}this._identity.copyToArray(e,16*this.bones.length)}prepare(){if(this._numBonesWithLinkedTransformNode>0)for(const e of this.bones)if(e._linkedTransformNode){const t=e._linkedTransformNode;e.position=t.position,t.rotationQuaternion?e.rotationQuaternion=t.rotationQuaternion:e.rotation=t.rotation,e.scaling=t.scaling}if(this.needInitialSkinMatrix)for(const e of this._meshesWithPoseMatrix){const t=e.getPoseMatrix();let i=this._isDirty;if((!e._bonesTransformMatrices||e._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(e._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),i=!0),i){if(this._synchronizedWithMesh!==e){this._synchronizedWithMesh=e;for(const s of this.bones)s.getParent()||(s.getBaseMatrix().multiplyToRef(t,L.Matrix[1]),s._updateDifferenceMatrix(L.Matrix[1]));if(this.isUsingTextureForMatrices){const s=4*(this.bones.length+1);(!e._transformMatrixTexture||e._transformMatrixTexture.getSize().width!==s)&&(e._transformMatrixTexture&&e._transformMatrixTexture.dispose(),e._transformMatrixTexture=pr.CreateRGBATexture(e._bonesTransformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(e._bonesTransformMatrices,t),this.isUsingTextureForMatrices&&e._transformMatrixTexture&&e._transformMatrixTexture.update(e._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=pr.CreateRGBATexture(this._transformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){const i=new Jl(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let s=0;s<this.bones.length;s++){const n=this.bones[s];let o=null;const a=n.getParent();if(a){const c=this.bones.indexOf(a);o=i.bones[c]}const l=new Ht(n.name,i,o,n.getBaseMatrix().clone(),n.getRestPose().clone());l._index=n._index,n._linkedTransformNode&&l.linkTransformNode(n._linkedTransformNode),Pr.DeepCopy(n.animations,l.animations)}if(this._ranges){i._ranges={};for(const s in this._ranges){const n=this._ranges[s];n&&(i._ranges[s]=n.clone())}}return this._isDirty=!0,i}enableBlending(e=.01){this.bones.forEach(t=>{t.animations.forEach(i=>{i.enableBlending=!0,i.blendingSpeed=e})})}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){var e;const t={};t.name=this.name,t.id=this.id,this.dimensionsAtRest&&(t.dimensionsAtRest=this.dimensionsAtRest.asArray()),t.bones=[],t.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let i=0;i<this.bones.length;i++){const s=this.bones[i],n=s.getParent(),o={parentBoneIndex:n?this.bones.indexOf(n):-1,index:s.getIndex(),name:s.name,id:s.id,matrix:s.getBaseMatrix().toArray(),rest:s.getRestPose().toArray(),linkedTransformNodeId:null===(e=s.getTransformNode())||void 0===e?void 0:e.id};t.bones.push(o),s.length&&(o.length=s.length),s.metadata&&(o.metadata=s.metadata),s.animations&&s.animations.length>0&&(o.animation=s.animations[0].serialize()),t.ranges=[];for(const a in this._ranges){const l=this._ranges[a];if(!l)continue;const c={};c.name=a,c.from=l.from,c.to=l.to,t.ranges.push(c)}}return t}static Parse(e,t){const i=new Jl(e.name,e.id,t);let s;for(e.dimensionsAtRest&&(i.dimensionsAtRest=v.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix,s=0;s<e.bones.length;s++){const n=e.bones[s],o=e.bones[s].index;let a=null;n.parentBoneIndex>-1&&(a=i.bones[n.parentBoneIndex]);const l=n.rest?F.FromArray(n.rest):null,c=new Ht(n.name,i,a,F.FromArray(n.matrix),l,null,o);null!=n.id&&(c.id=n.id),n.length&&(c.length=n.length),n.metadata&&(c.metadata=n.metadata),n.animation&&c.animations.push($.Parse(n.animation)),null!=n.linkedTransformNodeId&&(i._hasWaitingData=!0,c._waitingTransformNodeId=n.linkedTransformNodeId)}if(e.ranges)for(s=0;s<e.ranges.length;s++){const n=e.ranges[s];i.createAnimationRange(n.name,n.from,n.to)}return i}computeAbsoluteTransforms(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteTransforms(),this._absoluteTransformIsDirty=!1)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=new Array,t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;const s=this.bones[e];if(!s)return;void 0===s._index&&(s._index=e);const n=s.getParent();n&&this._sortBones(this.bones.indexOf(n),t,i),t.push(s)}setCurrentPoseAsRest(){this.bones.forEach(e=>{e.setCurrentPoseAsRest()})}}class Ese{constructor(e,t,i=3){this._engine=e,this._engine._storageBuffers.push(this),this._create(t,i)}_create(e,t){this._bufferSize=e,this._creationFlags=t,this._buffer=this._engine.createStorageBuffer(e,t)}_rebuild(){this._create(this._bufferSize,this._creationFlags)}getBuffer(){return this._buffer}update(e,t,i){!this._buffer||this._engine.updateStorageBuffer(this._buffer,e,t,i)}read(e,t,i){return this._engine.readFromStorageBuffer(this._buffer,e,t,i)}dispose(){const e=this._engine._storageBuffers,t=e.indexOf(this);-1!==t&&(e[t]=e[e.length-1],e.pop()),this._engine._releaseBuffer(this._buffer),this._buffer=null}}class pv{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new z,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Re.POINTERWHEEL)return;const i=t.event,s=i.deltaMode===mE.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*s*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*s*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*s*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Re.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}E([I()],pv.prototype,"wheelPrecisionX",void 0),E([I()],pv.prototype,"wheelPrecisionY",void 0),E([I()],pv.prototype,"wheelPrecisionZ",void 0);class LE{constructor(){this._currentActiveButton=-1,this.buttons=[0,1,2]}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();let s=0,n=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=a=>{var l,c;const h=a.event,u="touch"===h.pointerType;if(t.isInVRExclusivePointerMode||a.type!==Re.POINTERMOVE&&-1===this.buttons.indexOf(h.button))return;const d=h.target;if(this._altKey=h.altKey,this._ctrlKey=h.ctrlKey,this._metaKey=h.metaKey,this._shiftKey=h.shiftKey,this._buttonsPressed=h.buttons,t.isPointerLock)this.onTouch(null,h.movementX,h.movementY),this._pointA=null,this._pointB=null;else{if(a.type!==Re.POINTERDOWN&&u&&(null===(l=this._pointA)||void 0===l?void 0:l.pointerId)!==h.pointerId&&(null===(c=this._pointB)||void 0===c?void 0:c.pointerId)!==h.pointerId)return;if(a.type!==Re.POINTERDOWN||-1!==this._currentActiveButton&&!u)if(a.type===Re.POINTERDOUBLETAP)this.onDoubleTap(h.pointerType);else if(a.type!==Re.POINTERUP||this._currentActiveButton!==h.button&&!u){if(a.type===Re.POINTERMOVE)if(e||h.preventDefault(),this._pointA&&null===this._pointB)this.onTouch(this._pointA,h.clientX-this._pointA.x,h.clientY-this._pointA.y),this._pointA.x=h.clientX,this._pointA.y=h.clientY;else if(this._pointA&&this._pointB){const f=this._pointA.pointerId===h.pointerId?this._pointA:this._pointB;f.x=h.clientX,f.y=h.clientY;const p=this._pointA.x-this._pointB.x,_=this._pointA.y-this._pointB.y,m=p*p+_*_,g={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:h.pointerId,type:a.type};this.onMultiTouch(this._pointA,this._pointB,s,m,n,g),n=g,s=m}}else{try{d?.releasePointerCapture(h.pointerId)}catch{}u||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==h.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==h.pointerId?this._pointB=null:this._pointA=this._pointB=null,(0!==s||n)&&(this.onMultiTouch(this._pointA,this._pointB,s,0,n,null),s=0,n=null),this._currentActiveButton=-1,this.onButtonUp(h),e||h.preventDefault()}else{try{d?.setPointerCapture(h.pointerId)}catch{}if(null===this._pointA)this._pointA={x:h.clientX,y:h.clientY,pointerId:h.pointerId,type:h.pointerType};else{if(null!==this._pointB)return;this._pointB={x:h.clientX,y:h.clientY,pointerId:h.pointerId,type:h.pointerType}}-1===this._currentActiveButton&&!u&&(this._currentActiveButton=h.button),this.onButtonDown(h),e||(h.preventDefault(),i&&i.focus())}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Re.POINTERDOWN|Re.POINTERUP|Re.POINTERMOVE|Re.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,s=0,n=null,this.onLostFocus()},this._contextMenuBind=this.onContextMenu.bind(this),i&&i.addEventListener("contextmenu",this._contextMenuBind,!1);const o=this.camera.getScene().getEngine().getHostWindow();o&&q.RegisterTopRootEvents(o,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){const e=this.camera.getScene().getEngine().getHostWindow();e&&q.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){const e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentActiveButton=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,s,n,o){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}}E([I()],LE.prototype,"buttons",void 0);var or={};class _v{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){const t=e.getSimpleName();this.attached[t]?V.Warn("camera input of type "+t+" already exists on camera"):(this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault))}remove(e){for(const t in this.attached){const i=this.attached[t];if(i===e)return i.detachControl(),i.camera=null,delete this.attached[t],void this.rebuildInputCheck()}}removeByType(e){for(const t in this.attached){const i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){const t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=!ve.ForceAttachControlToAlwaysPreventDefault&&e,this.attachedToElement=!0,this.noPreventDefault=e;for(const t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(const t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){const t={};for(const i in this.attached){const s=this.attached[i],n=Ce.Serialize(s);t[s.getClassName()]=n}e.inputsmgr=t}parse(e){const t=e.inputsmgr;if(t){this.clear();for(const i in t){const s=or[i];if(s){const o=Ce.Parse(()=>new s,t[i],null);this.add(o)}}}else for(const i in this.attached){const s=or[this.attached[i].getClassName()];if(s){const n=Ce.Parse(()=>new s,e,null);this.remove(this.attached[i]),this.add(n)}}}}let ar=(()=>{class r{get isConnected(){return this._isConnected}constructor(t,i,s,n=0,o=1,a=2,l=3){this.id=t,this.index=i,this.browserGamepad=s,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=r.GAMEPAD,this._leftStickAxisX=n,this._leftStickAxisY=o,this._rightStickAxisX=a,this._rightStickAxisY=l,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(t){this._onleftstickchanged=t}onrightstickchanged(t){this._onrightstickchanged=t}get leftStick(){return this._leftStick}set leftStick(t){this._onleftstickchanged&&(this._leftStick.x!==t.x||this._leftStick.y!==t.y)&&this._onleftstickchanged(t),this._leftStick=t}get rightStick(){return this._rightStick}set rightStick(t){this._onrightstickchanged&&(this._rightStick.x!==t.x||this._rightStick.y!==t.y)&&this._onrightstickchanged(t),this._rightStick=t}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}return r.GAMEPAD=0,r.GENERIC=1,r.XBOX=2,r.POSE_ENABLED=3,r.DUALSHOCK=4,r})();class Cse extends ar{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,t,i){super(e,t,i),this.onButtonDownObservable=new z,this.onButtonUpObservable=new z,this.type=ar.GENERIC,this._buttons=new Array(i.buttons.length)}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}}class mv{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return 1!==this._yAxisScale}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==ar.POSE_ENABLED&&(!this.gamepad||t.type===ar.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(ar.XBOX)}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){const e=this.camera,t=this.gamepad.rightStick;if(t){if(0!=t.x){const s=t.x/this.gamepadRotationSensibility;0!=s&&Math.abs(s)>.005&&(e.inertialAlphaOffset+=s)}if(0!=t.y){const s=t.y/this.gamepadRotationSensibility*this._yAxisScale;0!=s&&Math.abs(s)>.005&&(e.inertialBetaOffset+=s)}}const i=this.gamepad.leftStick;if(i&&0!=i.y){const s=i.y/this.gamepadMoveSensibility;0!=s&&Math.abs(s)>.005&&(this.camera.inertialRadiusOffset-=s)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}}E([I()],mv.prototype,"gamepadRotationSensibility",void 0),E([I()],mv.prototype,"gamepadMoveSensibility",void 0),or.ArcRotateCameraGamepadInput=mv;class Go{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey)if(t.type===Gu.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysReset.indexOf(i.keyCode))&&(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysReset.indexOf(i.keyCode)){const s=this._keys.indexOf(i.keyCode);s>=0&&this._keys.splice(s,1),i.preventDefault&&(e||i.preventDefault())}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];-1!==this.keysLeft.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:-1!==this.keysUp.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:-1!==this.keysRight.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:-1!==this.keysDown.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:-1!==this.keysReset.indexOf(i)&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}}E([I()],Go.prototype,"keysUp",void 0),E([I()],Go.prototype,"keysDown",void 0),E([I()],Go.prototype,"keysLeft",void 0),E([I()],Go.prototype,"keysRight",void 0),E([I()],Go.prototype,"keysReset",void 0),E([I()],Go.prototype,"panningSensibility",void 0),E([I()],Go.prototype,"zoomingSensibility",void 0),E([I()],Go.prototype,"useAltToZoom",void 0),E([I()],Go.prototype,"angularSpeed",void 0),or.ArcRotateCameraKeyboardMoveInput=Go;class Tp{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._inertialPanning=v.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0;const s=.01*e*this.wheelDeltaPercentage*t;return i=e>0?s/(1+this.wheelDeltaPercentage):s*(1+this.wheelDeltaPercentage),i}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Re.POINTERWHEEL)return;const i=t.event;let s=0;const o=-i.deltaY*(i.deltaMode===mE.DOM_DELTA_LINE?40:1);if(this.customComputeDeltaFromMouseWheel)s=this.customComputeDeltaFromMouseWheel(o,this,i);else if(this.wheelDeltaPercentage){if(s=this._computeDeltaFromMouseWheelLegacyEvent(o,this.camera.radius),s>0){let a=this.camera.radius,l=this.camera.inertialRadiusOffset+s;for(let c=0;c<20&&Math.abs(l)>.001;c++)a-=l,l*=this.camera.inertia;a=oe.Clamp(a,0,Number.MAX_VALUE),s=this._computeDeltaFromMouseWheelLegacyEvent(o,a)}}else s=o/(40*this.wheelPrecision);s&&(this.zoomToMouseLocation&&this._hitPlane?this._zoomToMouse(s):this.camera.inertialRadiusOffset+=s),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Re.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;const e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){const e=this.camera,t=e.target.subtract(e.position);this._hitPlane=Dr.FromPositionAndNormal(e.target,t)}_getPosition(){var e;const t=this.camera,i=t.getScene(),s=i.createPickingRay(i.pointerX,i.pointerY,F.Identity(),t,!1);let n=0;return this._hitPlane&&(n=null!==(e=s.intersectsPlane(this._hitPlane))&&void 0!==e?e:0),s.origin.addInPlace(s.direction.scaleInPlace(n))}_zoomToMouse(e){var t,i;const s=this.camera,n=1-s.inertia;if(s.lowerRadiusLimit){const h=null!==(t=s.lowerRadiusLimit)&&void 0!==t?t:0;s.radius-(s.inertialRadiusOffset+e)/n<h&&(e=(s.radius-h)*n-s.inertialRadiusOffset)}if(s.upperRadiusLimit){const h=null!==(i=s.upperRadiusLimit)&&void 0!==i?i:0;s.radius-(s.inertialRadiusOffset+e)/n>h&&(e=(s.radius-h)*n-s.inertialRadiusOffset)}const a=e/n/s.radius,l=this._getPosition(),c=L.Vector3[6];l.subtractToRef(s.target,c),c.scaleInPlace(a),c.scaleInPlace(n),this._inertialPanning.addInPlace(c),s.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<ot&&(e.x=0),Math.abs(e.y)<ot&&(e.y=0),Math.abs(e.z)<ot&&(e.z=0)}}E([I()],Tp.prototype,"wheelPrecision",void 0),E([I()],Tp.prototype,"zoomToMouseLocation",void 0),E([I()],Tp.prototype,"wheelDeltaPercentage",void 0),or.ArcRotateCameraMouseWheelInput=Tp;class Zr extends LE{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(0!==this.panningSensibility&&e&&t){const s=t.y-e.y;this.camera.inertialPanningX+=-(t.x-e.x)/this.panningSensibility,this.camera.inertialPanningY+=s/this.panningSensibility}}_computePinchZoom(e,t){const i=this.camera.radius||Zr.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.camera.inertialRadiusOffset+=this.pinchDeltaPercentage?.001*(t-e)*i*this.pinchDeltaPercentage:(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){0!==this.panningSensibility&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,s,n,o){0===i&&null===n||0===s&&null===o||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,s),this._computeMultiTouchPanning(n,o)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(s)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,s),this._isPinching=!0):this._computeMultiTouchPanning(n,o)):this.multiTouchPanning?this._computeMultiTouchPanning(n,o):this.pinchZoom&&this._computePinchZoom(i,s))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}}Zr.MinimumRadiusForPinch=.001,E([I()],Zr.prototype,"buttons",void 0),E([I()],Zr.prototype,"angularSensibilityX",void 0),E([I()],Zr.prototype,"angularSensibilityY",void 0),E([I()],Zr.prototype,"pinchPrecision",void 0),E([I()],Zr.prototype,"pinchDeltaPercentage",void 0),E([I()],Zr.prototype,"useNaturalPinchZoom",void 0),E([I()],Zr.prototype,"pinchZoom",void 0),E([I()],Zr.prototype,"panningSensibility",void 0),E([I()],Zr.prototype,"multiTouchPanning",void 0),E([I()],Zr.prototype,"multiTouchPanAndZoom",void 0),or.ArcRotateCameraPointersInput=Zr;class BE extends _v{constructor(e){super(e)}addMouseWheel(){return this.add(new Tp),this}addPointers(){return this.add(new Zr),this}addKeyboard(){return this.add(new Go),this}}BE.prototype.addVRDeviceOrientation=function(){return this.add(new $1),this};class $1{constructor(){this.alphaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=this._onOrientationEvent.bind(this)}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),this.camera.attachControl(e);const t=this.camera.getScene().getEngine().getHostWindow();t&&(typeof DeviceOrientationEvent<"u"&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(i=>{"granted"===i?t.addEventListener("deviceorientation",this._deviceOrientationHandler):q.Warn("Permission not granted.")}).catch(i=>{q.Error(i)}):t.addEventListener("deviceorientation",this._deviceOrientationHandler))}_onOrientationEvent(e){null!==e.alpha&&(this._alpha=(0|+e.alpha)*this.alphaCorrection),null!==e.gamma&&(this._gamma=(0|+e.gamma)*this.gammaCorrection),this._dirty=!0}checkInputs(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)}detachControl(){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)}getClassName(){return"ArcRotateCameraVRDeviceOrientationInput"}getSimpleName(){return"VRDeviceOrientation"}}or.ArcRotateCameraVRDeviceOrientationInput=$1;class ec{constructor(){this.keysForward=[87],this.keysBackward=[83],this.keysUp=[69],this.keysDown=[81],this.keysRight=[68],this.keysLeft=[65],this._keys=new Array}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(t.type===Gu.KEYDOWN)(-1!==this.keysForward.indexOf(i.keyCode)||-1!==this.keysBackward.indexOf(i.keyCode)||-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode))&&(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),e||i.preventDefault());else if(-1!==this.keysForward.indexOf(i.keyCode)||-1!==this.keysBackward.indexOf(i.keyCode)||-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)){const s=this._keys.indexOf(i.keyCode);s>=0&&this._keys.splice(s,1),e||i.preventDefault()}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}getClassName(){return"FlyCameraKeyboardInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=e._computeLocalCameraSpeed();-1!==this.keysForward.indexOf(i)?e._localDirection.copyFromFloats(0,0,s):-1!==this.keysBackward.indexOf(i)?e._localDirection.copyFromFloats(0,0,-s):-1!==this.keysUp.indexOf(i)?e._localDirection.copyFromFloats(0,s,0):-1!==this.keysDown.indexOf(i)?e._localDirection.copyFromFloats(0,-s,0):-1!==this.keysRight.indexOf(i)?e._localDirection.copyFromFloats(s,0,0):-1!==this.keysLeft.indexOf(i)&&e._localDirection.copyFromFloats(-s,0,0),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),v.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}}E([I()],ec.prototype,"keysForward",void 0),E([I()],ec.prototype,"keysBackward",void 0),E([I()],ec.prototype,"keysUp",void 0),E([I()],ec.prototype,"keysDown",void 0),E([I()],ec.prototype,"keysRight",void 0),E([I()],ec.prototype,"keysLeft",void 0),or.FlyCameraKeyboardInput=ec;class gv{constructor(){this.buttons=[0,1,2],this.buttonsYaw=[-1,0,1],this.buttonsPitch=[-1,0,1],this.buttonsRoll=[2],this.activeButton=-1,this.angularSensibility=1e3,this._previousPosition=null}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),this._noPreventDefault=e,this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(t=>{this._pointerInput(t)},Re.POINTERDOWN|Re.POINTERUP|Re.POINTERMOVE),this._rollObserver=this.camera.getScene().onBeforeRenderObservable.add(()=>{this.camera.rollCorrect&&this.camera.restoreRoll(this.camera.rollCorrect)})}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this.camera.getScene().onBeforeRenderObservable.remove(this._rollObserver),this._observer=null,this._rollObserver=null,this._previousPosition=null,this._noPreventDefault=void 0)}getClassName(){return"FlyCameraMouseInput"}getSimpleName(){return"mouse"}_pointerInput(e){const t=e.event,s=this.camera.getEngine();if(s.isInVRExclusivePointerMode||!this.touchEnabled&&"touch"===t.pointerType||e.type!==Re.POINTERMOVE&&-1===this.buttons.indexOf(t.button))return;const n=t.target;if(e.type===Re.POINTERDOWN){try{n?.setPointerCapture(t.pointerId)}catch{}this._previousPosition={x:t.clientX,y:t.clientY},this.activeButton=t.button,this._noPreventDefault||(t.preventDefault(),this._element.focus()),s.isPointerLock&&this._onMouseMove(e.event)}else if(e.type===Re.POINTERUP){try{n?.releasePointerCapture(t.pointerId)}catch{}this.activeButton=-1,this._previousPosition=null,this._noPreventDefault||t.preventDefault()}else if(e.type===Re.POINTERMOVE){if(!this._previousPosition)return void(s.isPointerLock&&this._onMouseMove(e.event));this._rotateCamera(t.clientX-this._previousPosition.x,t.clientY-this._previousPosition.y),this._previousPosition={x:t.clientX,y:t.clientY},this._noPreventDefault||t.preventDefault()}}_onMouseMove(e){const i=this.camera.getEngine();i.isPointerLock&&!i.isInVRExclusivePointerMode&&(this._rotateCamera(e.movementX,e.movementY),this._previousPosition=null,this._noPreventDefault||e.preventDefault())}_rotateCamera(e,t){const i=this.camera;this.camera.getScene().useRightHandedSystem&&(e*=-1),i.parent&&i.parent._getWorldMatrixDeterminant()<0&&(e*=-1);const n=e/this.angularSensibility,o=t/this.angularSensibility,a=Z.RotationYawPitchRoll(i.rotation.y,i.rotation.x,i.rotation.z);let l;if(this.buttonsPitch.some(c=>c===this.activeButton)&&(l=Z.RotationAxis(fs.X,o),a.multiplyInPlace(l)),this.buttonsYaw.some(c=>c===this.activeButton)){l=Z.RotationAxis(fs.Y,n),a.multiplyInPlace(l);const c=i.bankedTurnLimit+i._trackRoll;i.bankedTurn&&-c<i.rotation.z&&i.rotation.z<c&&(l=Z.RotationAxis(fs.Z,i.bankedTurnMultiplier*-n),a.multiplyInPlace(l))}this.buttonsRoll.some(c=>c===this.activeButton)&&(l=Z.RotationAxis(fs.Z,-n),i._trackRoll-=n,a.multiplyInPlace(l)),a.toEulerAnglesToRef(i.rotation)}}E([I()],gv.prototype,"buttons",void 0),E([I()],gv.prototype,"angularSensibility",void 0),or.FlyCameraMouseInput=gv;class Ys{constructor(){this.keysHeightOffsetIncr=[38],this.keysHeightOffsetDecr=[40],this.keysHeightOffsetModifierAlt=!1,this.keysHeightOffsetModifierCtrl=!1,this.keysHeightOffsetModifierShift=!1,this.keysRotationOffsetIncr=[37],this.keysRotationOffsetDecr=[39],this.keysRotationOffsetModifierAlt=!1,this.keysRotationOffsetModifierCtrl=!1,this.keysRotationOffsetModifierShift=!1,this.keysRadiusIncr=[40],this.keysRadiusDecr=[38],this.keysRadiusModifierAlt=!0,this.keysRadiusModifierCtrl=!1,this.keysRadiusModifierShift=!1,this.heightSensibility=1,this.rotationSensibility=1,this.radiusSensibility=1,this._keys=new Array}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey)if(t.type===Gu.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,this._shiftPressed=i.shiftKey,(-1!==this.keysHeightOffsetIncr.indexOf(i.keyCode)||-1!==this.keysHeightOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetIncr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRadiusIncr.indexOf(i.keyCode)||-1!==this.keysRadiusDecr.indexOf(i.keyCode))&&(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(-1!==this.keysHeightOffsetIncr.indexOf(i.keyCode)||-1!==this.keysHeightOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetIncr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRadiusIncr.indexOf(i.keyCode)||-1!==this.keysRadiusDecr.indexOf(i.keyCode)){const s=this._keys.indexOf(i.keyCode);s>=0&&this._keys.splice(s,1),i.preventDefault&&(e||i.preventDefault())}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){this._onKeyboardObserver&&this._keys.forEach(e=>{-1!==this.keysHeightOffsetIncr.indexOf(e)&&this._modifierHeightOffset()?this.camera.heightOffset+=this.heightSensibility:-1!==this.keysHeightOffsetDecr.indexOf(e)&&this._modifierHeightOffset()?this.camera.heightOffset-=this.heightSensibility:-1!==this.keysRotationOffsetIncr.indexOf(e)&&this._modifierRotationOffset()?(this.camera.rotationOffset+=this.rotationSensibility,this.camera.rotationOffset%=360):-1!==this.keysRotationOffsetDecr.indexOf(e)&&this._modifierRotationOffset()?(this.camera.rotationOffset-=this.rotationSensibility,this.camera.rotationOffset%=360):-1!==this.keysRadiusIncr.indexOf(e)&&this._modifierRadius()?this.camera.radius+=this.radiusSensibility:-1!==this.keysRadiusDecr.indexOf(e)&&this._modifierRadius()&&(this.camera.radius-=this.radiusSensibility)})}getClassName(){return"FollowCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}_modifierHeightOffset(){return this.keysHeightOffsetModifierAlt===this._altPressed&&this.keysHeightOffsetModifierCtrl===this._ctrlPressed&&this.keysHeightOffsetModifierShift===this._shiftPressed}_modifierRotationOffset(){return this.keysRotationOffsetModifierAlt===this._altPressed&&this.keysRotationOffsetModifierCtrl===this._ctrlPressed&&this.keysRotationOffsetModifierShift===this._shiftPressed}_modifierRadius(){return this.keysRadiusModifierAlt===this._altPressed&&this.keysRadiusModifierCtrl===this._ctrlPressed&&this.keysRadiusModifierShift===this._shiftPressed}}E([I()],Ys.prototype,"keysHeightOffsetIncr",void 0),E([I()],Ys.prototype,"keysHeightOffsetDecr",void 0),E([I()],Ys.prototype,"keysHeightOffsetModifierAlt",void 0),E([I()],Ys.prototype,"keysHeightOffsetModifierCtrl",void 0),E([I()],Ys.prototype,"keysHeightOffsetModifierShift",void 0),E([I()],Ys.prototype,"keysRotationOffsetIncr",void 0),E([I()],Ys.prototype,"keysRotationOffsetDecr",void 0),E([I()],Ys.prototype,"keysRotationOffsetModifierAlt",void 0),E([I()],Ys.prototype,"keysRotationOffsetModifierCtrl",void 0),E([I()],Ys.prototype,"keysRotationOffsetModifierShift",void 0),E([I()],Ys.prototype,"keysRadiusIncr",void 0),E([I()],Ys.prototype,"keysRadiusDecr",void 0),E([I()],Ys.prototype,"keysRadiusModifierAlt",void 0),E([I()],Ys.prototype,"keysRadiusModifierCtrl",void 0),E([I()],Ys.prototype,"keysRadiusModifierShift",void 0),E([I()],Ys.prototype,"heightSensibility",void 0),E([I()],Ys.prototype,"rotationSensibility",void 0),E([I()],Ys.prototype,"radiusSensibility",void 0),or.FollowCameraKeyboardMoveInput=Ys;class ch{constructor(){this.axisControlRadius=!0,this.axisControlHeight=!1,this.axisControlRotation=!1,this.wheelPrecision=3,this.wheelDeltaPercentage=0}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Re.POINTERWHEEL)return;const i=t.event;let s=0;const n=Math.max(-1,Math.min(1,i.deltaY));this.wheelDeltaPercentage?(console.assert(this.axisControlRadius+this.axisControlHeight+this.axisControlRotation<=1,"wheelDeltaPercentage only usable when mouse wheel controls ONE axis. Currently enabled: axisControlRadius: "+this.axisControlRadius+", axisControlHeightOffset: "+this.axisControlHeight+", axisControlRotationOffset: "+this.axisControlRotation),this.axisControlRadius?s=.01*n*this.wheelDeltaPercentage*this.camera.radius:this.axisControlHeight?s=.01*n*this.wheelDeltaPercentage*this.camera.heightOffset:this.axisControlRotation&&(s=.01*n*this.wheelDeltaPercentage*this.camera.rotationOffset)):s=n*this.wheelPrecision,s&&(this.axisControlRadius?this.camera.radius+=s:this.axisControlHeight?this.camera.heightOffset-=s:this.axisControlRotation&&(this.camera.rotationOffset-=s)),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Re.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}E([I()],ch.prototype,"axisControlRadius",void 0),E([I()],ch.prototype,"axisControlHeight",void 0),E([I()],ch.prototype,"axisControlRotation",void 0),E([I()],ch.prototype,"wheelPrecision",void 0),E([I()],ch.prototype,"wheelDeltaPercentage",void 0),or.FollowCameraMouseWheelInput=ch;class Jr extends LE{constructor(){super(...arguments),this.angularSensibilityX=1,this.angularSensibilityY=1,this.pinchPrecision=1e4,this.pinchDeltaPercentage=0,this.axisXControlRadius=!1,this.axisXControlHeight=!1,this.axisXControlRotation=!0,this.axisYControlRadius=!1,this.axisYControlHeight=!0,this.axisYControlRotation=!1,this.axisPinchControlRadius=!0,this.axisPinchControlHeight=!1,this.axisPinchControlRotation=!1,this.warningEnable=!0,this._warningCounter=0}getClassName(){return"FollowCameraPointersInput"}onTouch(e,t,i){this._warning(),this.axisXControlRotation?this.camera.rotationOffset+=t/this.angularSensibilityX:this.axisYControlRotation&&(this.camera.rotationOffset+=i/this.angularSensibilityX),this.axisXControlHeight?this.camera.heightOffset+=t/this.angularSensibilityY:this.axisYControlHeight&&(this.camera.heightOffset+=i/this.angularSensibilityY),this.axisXControlRadius?this.camera.radius-=t/this.angularSensibilityY:this.axisYControlRadius&&(this.camera.radius-=i/this.angularSensibilityY)}onMultiTouch(e,t,i,s,n,o){if(0===i&&null===n||0===s&&null===o)return;let a=(s-i)/(this.pinchPrecision*(this.angularSensibilityX+this.angularSensibilityY)/2);this.pinchDeltaPercentage?(a*=.01*this.pinchDeltaPercentage,this.axisPinchControlRotation&&(this.camera.rotationOffset+=a*this.camera.rotationOffset),this.axisPinchControlHeight&&(this.camera.heightOffset+=a*this.camera.heightOffset),this.axisPinchControlRadius&&(this.camera.radius-=a*this.camera.radius)):(this.axisPinchControlRotation&&(this.camera.rotationOffset+=a),this.axisPinchControlHeight&&(this.camera.heightOffset+=a),this.axisPinchControlRadius&&(this.camera.radius-=a))}_warning(){if(!this.warningEnable||this._warningCounter++%100!=0)return;const e="It probably only makes sense to control ONE camera property with each pointer axis. Set 'warningEnable = false' if you are sure. Currently enabled: ";console.assert(this.axisXControlRotation+this.axisXControlHeight+this.axisXControlRadius<=1,e+"axisXControlRotation: "+this.axisXControlRotation+", axisXControlHeight: "+this.axisXControlHeight+", axisXControlRadius: "+this.axisXControlRadius),console.assert(this.axisYControlRotation+this.axisYControlHeight+this.axisYControlRadius<=1,e+"axisYControlRotation: "+this.axisYControlRotation+", axisYControlHeight: "+this.axisYControlHeight+", axisYControlRadius: "+this.axisYControlRadius),console.assert(this.axisPinchControlRotation+this.axisPinchControlHeight+this.axisPinchControlRadius<=1,e+"axisPinchControlRotation: "+this.axisPinchControlRotation+", axisPinchControlHeight: "+this.axisPinchControlHeight+", axisPinchControlRadius: "+this.axisPinchControlRadius)}}E([I()],Jr.prototype,"angularSensibilityX",void 0),E([I()],Jr.prototype,"angularSensibilityY",void 0),E([I()],Jr.prototype,"pinchPrecision",void 0),E([I()],Jr.prototype,"pinchDeltaPercentage",void 0),E([I()],Jr.prototype,"axisXControlRadius",void 0),E([I()],Jr.prototype,"axisXControlHeight",void 0),E([I()],Jr.prototype,"axisXControlRotation",void 0),E([I()],Jr.prototype,"axisYControlRadius",void 0),E([I()],Jr.prototype,"axisYControlHeight",void 0),E([I()],Jr.prototype,"axisYControlRotation",void 0),E([I()],Jr.prototype,"axisPinchControlRadius",void 0),E([I()],Jr.prototype,"axisPinchControlHeight",void 0),E([I()],Jr.prototype,"axisPinchControlRotation",void 0),or.FollowCameraPointersInput=Jr;class Hn{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey)if(t.type===Gu.KEYDOWN)(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysUpward.indexOf(i.keyCode)||-1!==this.keysDownward.indexOf(i.keyCode)||-1!==this.keysRotateLeft.indexOf(i.keyCode)||-1!==this.keysRotateRight.indexOf(i.keyCode)||-1!==this.keysRotateUp.indexOf(i.keyCode)||-1!==this.keysRotateDown.indexOf(i.keyCode))&&(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),e||i.preventDefault());else if(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysUpward.indexOf(i.keyCode)||-1!==this.keysDownward.indexOf(i.keyCode)||-1!==this.keysRotateLeft.indexOf(i.keyCode)||-1!==this.keysRotateRight.indexOf(i.keyCode)||-1!==this.keysRotateUp.indexOf(i.keyCode)||-1!==this.keysRotateDown.indexOf(i.keyCode)){const s=this._keys.indexOf(i.keyCode);s>=0&&this._keys.splice(s,1),e||i.preventDefault()}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=e._computeLocalCameraSpeed();-1!==this.keysLeft.indexOf(i)?e._localDirection.copyFromFloats(-s,0,0):-1!==this.keysUp.indexOf(i)?e._localDirection.copyFromFloats(0,0,s):-1!==this.keysRight.indexOf(i)?e._localDirection.copyFromFloats(s,0,0):-1!==this.keysDown.indexOf(i)?e._localDirection.copyFromFloats(0,0,-s):-1!==this.keysUpward.indexOf(i)?e._localDirection.copyFromFloats(0,s,0):-1!==this.keysDownward.indexOf(i)?e._localDirection.copyFromFloats(0,-s,0):-1!==this.keysRotateLeft.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):-1!==this.keysRotateRight.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):-1!==this.keysRotateUp.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):-1!==this.keysRotateDown.indexOf(i)&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),v.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){let e=this.rotationSpeed*this._engine.getDeltaTime()/1e3;return this.camera.getScene().useRightHandedSystem&&(e*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}}E([I()],Hn.prototype,"keysUp",void 0),E([I()],Hn.prototype,"keysUpward",void 0),E([I()],Hn.prototype,"keysDown",void 0),E([I()],Hn.prototype,"keysDownward",void 0),E([I()],Hn.prototype,"keysLeft",void 0),E([I()],Hn.prototype,"keysRight",void 0),E([I()],Hn.prototype,"rotationSpeed",void 0),E([I()],Hn.prototype,"keysRotateLeft",void 0),E([I()],Hn.prototype,"keysRotateRight",void 0),E([I()],Hn.prototype,"keysRotateUp",void 0),E([I()],Hn.prototype,"keysRotateDown",void 0),or.FreeCameraKeyboardMoveInput=Hn;class vv{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new z,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=s=>{const n=s.event,o="touch"===n.pointerType;if(t.isInVRExclusivePointerMode||!this.touchEnabled&&o||s.type!==Re.POINTERMOVE&&-1===this.buttons.indexOf(n.button))return;const a=n.target;if(s.type===Re.POINTERDOWN){if(o&&-1!==this._activePointerId||!o&&-1!==this._currentActiveButton)return;this._activePointerId=n.pointerId;try{a?.setPointerCapture(n.pointerId)}catch{}-1===this._currentActiveButton&&(this._currentActiveButton=n.button),this._previousPosition={x:n.clientX,y:n.clientY},e||(n.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(s.event)}else if(s.type===Re.POINTERUP){if(o&&this._activePointerId!==n.pointerId||!o&&this._currentActiveButton!==n.button)return;try{a?.releasePointerCapture(n.pointerId)}catch{}this._currentActiveButton=-1,this._previousPosition=null,e||n.preventDefault(),this._activePointerId=-1}else if(s.type===Re.POINTERMOVE&&(this._activePointerId===n.pointerId||!o))if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(s.event);else if(this._previousPosition){let l=n.clientX-this._previousPosition.x;const c=n.clientY-this._previousPosition.y;this.camera.getScene().useRightHandedSystem&&(l*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(l*=-1),this._allowCameraRotation&&(this.camera.cameraRotation.y+=l/this.angularSensibility,this.camera.cameraRotation.x+=c/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:l,offsetY:c}),this._previousPosition={x:n.clientX,y:n.clientY},e||n.preventDefault()}}),this._onMouseMove=s=>{if(!t.isPointerLock||t.isInVRExclusivePointerMode)return;let n=s.movementX;this.camera.getScene().useRightHandedSystem&&(n*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(n*=-1),this.camera.cameraRotation.y+=n/this.angularSensibility,this.camera.cameraRotation.x+=s.movementY/this.angularSensibility,this._previousPosition=null,e||s.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Re.POINTERDOWN|Re.POINTERUP|Re.POINTERMOVE),i&&(this._contextMenuBind=this.onContextMenu.bind(this),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}E([I()],vv.prototype,"buttons",void 0),E([I()],vv.prototype,"angularSensibility",void 0),or.FreeCameraMouseInput=vv;var Jt=(()=>{return(r=Jt||(Jt={}))[r.MoveRelative=0]="MoveRelative",r[r.RotateRelative=1]="RotateRelative",r[r.MoveScene=2]="MoveScene",Jt;var r})();class zo extends pv{constructor(){super(...arguments),this._moveRelative=v.Zero(),this._rotateRelative=v.Zero(),this._moveScene=v.Zero(),this._wheelXAction=Jt.MoveRelative,this._wheelXActionCoordinate=Kl.X,this._wheelYAction=Jt.MoveRelative,this._wheelYActionCoordinate=Kl.Z,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){null===e&&this._wheelXAction!==Jt.MoveRelative||(this._wheelXAction=Jt.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==Jt.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){null===e&&this._wheelYAction!==Jt.MoveRelative||(this._wheelYAction=Jt.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==Jt.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){null===e&&this._wheelZAction!==Jt.MoveRelative||(this._wheelZAction=Jt.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==Jt.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){null===e&&this._wheelXAction!==Jt.RotateRelative||(this._wheelXAction=Jt.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==Jt.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){null===e&&this._wheelYAction!==Jt.RotateRelative||(this._wheelYAction=Jt.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==Jt.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){null===e&&this._wheelZAction!==Jt.RotateRelative||(this._wheelZAction=Jt.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==Jt.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){null===e&&this._wheelXAction!==Jt.MoveScene||(this._wheelXAction=Jt.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==Jt.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){null===e&&this._wheelYAction!==Jt.MoveScene||(this._wheelYAction=Jt.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==Jt.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){null===e&&this._wheelZAction!==Jt.MoveScene||(this._wheelZAction=Jt.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==Jt.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(0===this._wheelDeltaX&&0===this._wheelDeltaY&&0==this._wheelDeltaZ)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=F.Zero();this.camera.getViewMatrix().invertToRef(e);const t=v.Zero();v.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(0===e||null===t||null===i)return;let s=null;switch(t){case Jt.MoveRelative:s=this._moveRelative;break;case Jt.RotateRelative:s=this._rotateRelative;break;case Jt.MoveScene:s=this._moveScene}switch(i){case Kl.X:s.set(e,0,0);break;case Kl.Y:s.set(0,e,0);break;case Kl.Z:s.set(0,0,e)}}}E([I()],zo.prototype,"wheelXMoveRelative",null),E([I()],zo.prototype,"wheelYMoveRelative",null),E([I()],zo.prototype,"wheelZMoveRelative",null),E([I()],zo.prototype,"wheelXRotateRelative",null),E([I()],zo.prototype,"wheelYRotateRelative",null),E([I()],zo.prototype,"wheelZRotateRelative",null),E([I()],zo.prototype,"wheelXMoveScene",null),E([I()],zo.prototype,"wheelYMoveScene",null),E([I()],zo.prototype,"wheelZMoveScene",null),or.FreeCameraMouseWheelInput=zo;class bv{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=q.IsSafari()}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments);let t=null;if(void 0===this._pointerInput&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{const s=i.event;if(this.allowMouse||!("mouse"===s.pointerType||this._isSafari&&typeof s.pointerType>"u"))if(i.type===Re.POINTERDOWN){if(e||s.preventDefault(),this._pointerPressed.push(s.pointerId),1!==this._pointerPressed.length)return;t={x:s.clientX,y:s.clientY}}else if(i.type===Re.POINTERUP){e||s.preventDefault();const o=this._pointerPressed.indexOf(s.pointerId);if(-1===o||(this._pointerPressed.splice(o,1),0!=o))return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===Re.POINTERMOVE){if(e||s.preventDefault(),!t||0!=this._pointerPressed.indexOf(s.pointerId))return;this._offsetX=s.clientX-t.x,this._offsetY=-(s.clientY-t.y)}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Re.POINTERDOWN|Re.POINTERUP|Re.POINTERMOVE),this._onLostFocus){const s=this.camera.getEngine().getInputElement();s&&s.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(null===this._offsetX||null===this._offsetY||0===this._offsetX&&0===this._offsetY)return;const e=this.camera;if(e.cameraRotation.y=this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&1===this._pointerPressed.length||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const i=e._computeLocalCameraSpeed(),s=new v(0,0,0!==this.touchMoveSensibility?i*this._offsetY/this.touchMoveSensibility:0);F.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(v.TransformCoordinates(s,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}E([I()],bv.prototype,"touchAngularSensibility",void 0),E([I()],bv.prototype,"touchMoveSensibility",void 0),or.FreeCameraTouchInput=bv;class yv extends _v{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new Hn),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new vv(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new zo,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new bv),this}clear(){super.clear(),this._mouseInput=null}}yv.prototype.addDeviceOrientation=function(r){return this._deviceOrientationInput||(this._deviceOrientationInput=new K1,r&&(this._deviceOrientationInput.smoothFactor=r),this.add(this._deviceOrientationInput)),this};class K1{static WaitForOrientationChangeAsync(e){return new Promise((t,i)=>{let s=!1;const n=()=>{window.removeEventListener("deviceorientation",n),s=!0,t()};e&&setTimeout(()=>{s||(window.removeEventListener("deviceorientation",n),i("WaitForOrientationChangeAsync timed out"))},e),typeof DeviceOrientationEvent<"u"&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(o=>{"granted"==o?window.addEventListener("deviceorientation",n):q.Warn("Permission not granted.")}).catch(o=>{q.Error(o)}):window.addEventListener("deviceorientation",n)})}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new Z,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new z,this._orientationChanged=()=>{this._screenOrientationAngle=void 0!==window.orientation?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-q.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=null!==e.alpha?q.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=null!==e.beta?q.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=null!==e.gamma?q.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=null!==e.alpha?e.alpha:0,this._beta=null!==e.beta?e.beta:0,this._gamma=null!==e.gamma?e.gamma:0),null!==e.alpha&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTranform=new Z(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,null!=this._camera&&!this._camera.rotationQuaternion&&(this._camera.rotationQuaternion=new Z),this._camera&&this._camera.onDisposeObservable.add(()=>{this._onDeviceOrientationChangedObservable.clear()})}attachControl(){const e=this.camera.getScene().getEngine().getHostWindow();if(e){const t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};typeof DeviceOrientationEvent<"u"&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(i=>{"granted"===i?t():q.Warn("Permission not granted.")}).catch(i=>{q.Error(i)}):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){!this._alpha||(Z.RotationYawPitchRollToRef(q.ToRadians(this._alpha),q.ToRadians(this._beta),-q.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform),this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}or.FreeCameraDeviceOrientationInput=K1;class xv{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=F.Identity(),this._deltaTransform=v.Zero(),this._vector3=v.Zero(),this._vector2=de.Zero()}get invertYAxis(){return 1!==this._yAxisScale}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==ar.POSE_ENABLED&&(!this.gamepad||t.type===ar.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(ar.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){const e=this.camera,t=this.gamepad.leftStick;0!==this.gamepadMoveSensibility&&(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadMoveSensibility:0,t.y=Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadMoveSensibility:0);let i=this.gamepad.rightStick;i&&0!==this.gamepadAngularSensibility?(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadAngularSensibility:0,i.y=(Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadAngularSensibility:0)*this._yAxisScale):i={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):F.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);const s=50*e._computeLocalCameraSpeed();this._vector3.copyFromFloats(t.x*s,0,-t.y*s),v.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(i.y,i.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}}E([I()],xv.prototype,"gamepadAngularSensibility",void 0),E([I()],xv.prototype,"gamepadMoveSensibility",void 0),or.FreeCameraGamepadInput=xv;var ps=(()=>{return(r=ps||(ps={}))[r.X=0]="X",r[r.Y=1]="Y",r[r.Z=2]="Z",ps;var r})();let Q1=(()=>{class r{static _GetDefaultOptions(){return{puckSize:40,containerSize:60,color:"cyan",puckImage:void 0,containerImage:void 0,position:void 0,alwaysVisible:!1,limitToContainer:!1}}constructor(t,i){this._released=!1;const s={...r._GetDefaultOptions(),...i};if(this._leftJoystick=!!t,r._GlobalJoystickIndex++,this._axisTargetedByLeftAndRight=ps.X,this._axisTargetedByUpAndDown=ps.Y,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new pE,this.deltaPosition=v.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._onResize=()=>{r._VJCanvasWidth=window.innerWidth,r._VJCanvasHeight=window.innerHeight,r.Canvas&&(r.Canvas.width=r._VJCanvasWidth,r.Canvas.height=r._VJCanvasHeight),r._HalfWidth=r._VJCanvasWidth/2},!r.Canvas){window.addEventListener("resize",this._onResize,!1),r.Canvas=document.createElement("canvas"),r._VJCanvasWidth=window.innerWidth,r._VJCanvasHeight=window.innerHeight,r.Canvas.width=window.innerWidth,r.Canvas.height=window.innerHeight,r.Canvas.style.width="100%",r.Canvas.style.height="100%",r.Canvas.style.position="absolute",r.Canvas.style.backgroundColor="transparent",r.Canvas.style.top="0px",r.Canvas.style.left="0px",r.Canvas.style.zIndex="5",r.Canvas.style.touchAction="none",r.Canvas.setAttribute("touch-action","none");const n=r.Canvas.getContext("2d");if(!n)throw new Error("Unable to create canvas for virtual joystick");r._VJCanvasContext=n,r._VJCanvasContext.strokeStyle="#ffffff",r._VJCanvasContext.lineWidth=2,document.body.appendChild(r.Canvas)}r._HalfWidth=r.Canvas.width/2,this.pressed=!1,this.limitToContainer=s.limitToContainer,this._joystickColor=s.color,this.containerSize=s.containerSize,this.puckSize=s.puckSize,s.position&&this.setPosition(s.position.x,s.position.y),s.puckImage&&this.setPuckImage(s.puckImage),s.containerImage&&this.setContainerImage(s.containerImage),s.alwaysVisible&&r._AlwaysVisibleSticks++,this.alwaysVisible=s.alwaysVisible,this._joystickPointerId=-1,this._joystickPointerPos=new de(0,0),this._joystickPreviousPointerPos=new de(0,0),this._joystickPointerStartPos=new de(0,0),this._deltaJoystickVector=new de(0,0),this._onPointerDownHandlerRef=n=>{this._onPointerDown(n)},this._onPointerMoveHandlerRef=n=>{this._onPointerMove(n)},this._onPointerUpHandlerRef=n=>{this._onPointerUp(n)},r.Canvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,!1),r.Canvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,!1),r.Canvas.addEventListener("pointerup",this._onPointerUpHandlerRef,!1),r.Canvas.addEventListener("pointerout",this._onPointerUpHandlerRef,!1),r.Canvas.addEventListener("contextmenu",n=>{n.preventDefault()},!1),requestAnimationFrame(()=>{this._drawVirtualJoystick()})}setJoystickSensibility(t){this._joystickSensibility=t,this._inversedSensibility=1/(this._joystickSensibility/1e3)}_onPointerDown(t){let i;t.preventDefault(),i=!0===this._leftJoystick?t.clientX<r._HalfWidth:t.clientX>r._HalfWidth,i&&this._joystickPointerId<0?(this._joystickPointerId=t.pointerId,this._joystickPosition?(this._joystickPointerStartPos=this._joystickPosition.clone(),this._joystickPointerPos=this._joystickPosition.clone(),this._joystickPreviousPointerPos=this._joystickPosition.clone(),this._onPointerMove(t)):(this._joystickPointerStartPos.x=t.clientX,this._joystickPointerStartPos.y=t.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone()),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(t.pointerId.toString(),t)):r._GlobalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(t.pointerId.toString(),{x:t.clientX,y:t.clientY,prevX:t.clientX,prevY:t.clientY}))}_onPointerMove(t){if(this._joystickPointerId==t.pointerId){if(this.limitToContainer){const a=new de(t.clientX-this._joystickPointerStartPos.x,t.clientY-this._joystickPointerStartPos.y),l=a.length();l>this.containerSize&&a.scaleInPlace(this.containerSize/l),this._joystickPointerPos.x=this._joystickPointerStartPos.x+a.x,this._joystickPointerPos.y=this._joystickPointerStartPos.y+a.y}else this._joystickPointerPos.x=t.clientX,this._joystickPointerPos.y=t.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos),0<r._AlwaysVisibleSticks&&(this._joystickPointerPos.x=this._leftJoystick?Math.min(r._HalfWidth,this._joystickPointerPos.x):Math.max(r._HalfWidth,this._joystickPointerPos.x));const s=(this.reverseLeftRight?-1:1)*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case ps.X:this.deltaPosition.x=Math.min(1,Math.max(-1,s));break;case ps.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,s));break;case ps.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,s))}const o=(this.reverseUpDown?1:-1)*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case ps.X:this.deltaPosition.x=Math.min(1,Math.max(-1,o));break;case ps.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,o));break;case ps.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,o))}}else{const i=this._touches.get(t.pointerId.toString());i&&(i.x=t.clientX,i.y=t.clientY)}}_onPointerUp(t){if(this._joystickPointerId==t.pointerId)this._clearPreviousDraw(),this._joystickPointerId=-1,this.pressed=!1;else{const i=this._touches.get(t.pointerId.toString());i&&r._VJCanvasContext.clearRect(i.prevX-44,i.prevY-44,88,88)}this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(t.pointerId.toString())}setJoystickColor(t){this._joystickColor=t}set containerSize(t){this._joystickContainerSize=t,this._clearContainerSize=~~(2.1*this._joystickContainerSize),this._clearContainerSizeOffset=~~(this._clearContainerSize/2)}get containerSize(){return this._joystickContainerSize}set puckSize(t){this._joystickPuckSize=t,this._clearPuckSize=~~(2.1*this._joystickPuckSize),this._clearPuckSizeOffset=~~(this._clearPuckSize/2)}get puckSize(){return this._joystickPuckSize}clearPosition(){this.alwaysVisible=!1,this._joystickPosition=null}set alwaysVisible(t){this._alwaysVisible!==t&&(t&&this._joystickPosition?(r._AlwaysVisibleSticks++,this._alwaysVisible=!0):(r._AlwaysVisibleSticks--,this._alwaysVisible=!1))}get alwaysVisible(){return this._alwaysVisible}setPosition(t,i){this._joystickPointerStartPos&&this._clearPreviousDraw(),this._joystickPosition=new de(t,i)}setActionOnTouch(t){this._action=t}setAxisForLeftRight(t){switch(t){case ps.X:case ps.Y:case ps.Z:this._axisTargetedByLeftAndRight=t;break;default:this._axisTargetedByLeftAndRight=ps.X}}setAxisForUpDown(t){switch(t){case ps.X:case ps.Y:case ps.Z:this._axisTargetedByUpAndDown=t;break;default:this._axisTargetedByUpAndDown=ps.Y}}_clearPreviousDraw(){const t=this._joystickPosition||this._joystickPointerStartPos;r._VJCanvasContext.clearRect(t.x-this._clearContainerSizeOffset,t.y-this._clearContainerSizeOffset,this._clearContainerSize,this._clearContainerSize),r._VJCanvasContext.clearRect(this._joystickPreviousPointerPos.x-this._clearPuckSizeOffset-1,this._joystickPreviousPointerPos.y-this._clearPuckSizeOffset-1,this._clearPuckSize+2,this._clearPuckSize+2)}setContainerImage(t){const i=new Image;i.src=t,i.onload=()=>this._containerImage=i}setPuckImage(t){const i=new Image;i.src=t,i.onload=()=>this._puckImage=i}_drawContainer(){const t=this._joystickPosition||this._joystickPointerStartPos;this._clearPreviousDraw(),this._containerImage?r._VJCanvasContext.drawImage(this._containerImage,t.x-this.containerSize,t.y-this.containerSize,2*this.containerSize,2*this.containerSize):(r._VJCanvasContext.beginPath(),r._VJCanvasContext.strokeStyle=this._joystickColor,r._VJCanvasContext.lineWidth=2,r._VJCanvasContext.arc(t.x,t.y,this.containerSize,0,2*Math.PI,!0),r._VJCanvasContext.stroke(),r._VJCanvasContext.closePath(),r._VJCanvasContext.beginPath(),r._VJCanvasContext.lineWidth=6,r._VJCanvasContext.strokeStyle=this._joystickColor,r._VJCanvasContext.arc(t.x,t.y,this.puckSize,0,2*Math.PI,!0),r._VJCanvasContext.stroke(),r._VJCanvasContext.closePath())}_drawPuck(){this._puckImage?r._VJCanvasContext.drawImage(this._puckImage,this._joystickPointerPos.x-this.puckSize,this._joystickPointerPos.y-this.puckSize,2*this.puckSize,2*this.puckSize):(r._VJCanvasContext.beginPath(),r._VJCanvasContext.strokeStyle=this._joystickColor,r._VJCanvasContext.lineWidth=2,r._VJCanvasContext.arc(this._joystickPointerPos.x,this._joystickPointerPos.y,this.puckSize,0,2*Math.PI,!0),r._VJCanvasContext.stroke(),r._VJCanvasContext.closePath())}_drawVirtualJoystick(){this._released||(this.alwaysVisible&&this._drawContainer(),this.pressed&&this._touches.forEach((t,i)=>{i.pointerId===this._joystickPointerId?(this.alwaysVisible||this._drawContainer(),this._drawPuck(),this._joystickPreviousPointerPos=this._joystickPointerPos.clone()):(r._VJCanvasContext.clearRect(i.prevX-44,i.prevY-44,88,88),r._VJCanvasContext.beginPath(),r._VJCanvasContext.fillStyle="white",r._VJCanvasContext.beginPath(),r._VJCanvasContext.strokeStyle="red",r._VJCanvasContext.lineWidth=6,r._VJCanvasContext.arc(i.x,i.y,40,0,2*Math.PI,!0),r._VJCanvasContext.stroke(),r._VJCanvasContext.closePath(),i.prevX=i.x,i.prevY=i.y)}),requestAnimationFrame(()=>{this._drawVirtualJoystick()}))}releaseCanvas(){r.Canvas&&(r.Canvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef),r.Canvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef),r.Canvas.removeEventListener("pointerup",this._onPointerUpHandlerRef),r.Canvas.removeEventListener("pointerout",this._onPointerUpHandlerRef),window.removeEventListener("resize",this._onResize),document.body.removeChild(r.Canvas),r.Canvas=null),this._released=!0}}return r._GlobalJoystickIndex=0,r._AlwaysVisibleSticks=0,r})();yv.prototype.addVirtualJoystick=function(){return this.add(new Z1),this};class Z1{getLeftJoystick(){return this._leftjoystick}getRightJoystick(){return this._rightjoystick}checkInputs(){if(this._leftjoystick){const e=this.camera,t=50*e._computeLocalCameraSpeed(),i=F.RotationYawPitchRoll(e.rotation.y,e.rotation.x,0),s=v.TransformCoordinates(new v(this._leftjoystick.deltaPosition.x*t,this._leftjoystick.deltaPosition.y*t,this._leftjoystick.deltaPosition.z*t),i);e.cameraDirection=e.cameraDirection.add(s),e.cameraRotation=e.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}}attachControl(){this._leftjoystick=new Q1(!0),this._leftjoystick.setAxisForUpDown(ps.Z),this._leftjoystick.setAxisForLeftRight(ps.X),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new Q1(!1),this._rightjoystick.setAxisForUpDown(ps.X),this._rightjoystick.setAxisForLeftRight(ps.Y),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")}detachControl(){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()}getClassName(){return"FreeCameraVirtualJoystickInput"}getSimpleName(){return"virtualJoystick"}}or.FreeCameraVirtualJoystickInput=Z1;class Gi extends ve{constructor(e,t,i,s=!0){super(e,t,i,s),this._tmpUpVector=v.Zero(),this._tmpTargetVector=v.Zero(),this.cameraDirection=new v(0,0,0),this.cameraRotation=new de(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new Z,this.rotation=new v(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=v.Zero(),this._initialFocalDistance=1,this._viewMatrix=F.Zero(),this._camMatrix=F.Zero(),this._cameraTransformMatrix=F.Zero(),this._cameraRotationMatrix=F.Zero(),this._referencePoint=new v(0,0,1),this._transformedReferencePoint=v.Zero(),this._defaultUp=v.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(e){this.getWorldMatrix();const t=this.getTarget().subtract(this.position);return t.normalize(),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){const e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return!!super._restoreStateValues()&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0)}_initCache(){super._initCache(),this._cache.lockedTarget=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new Z(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();const t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;const e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(100*e.getFps()))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=ot),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),F.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);const t=e.subtract(this.position);this.rotation.y=t.x>=0?-Math.atan(t.z/t.x)+Math.PI/2:-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&Z.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent)return this.parent.getWorldMatrix().invertToRef(L.Matrix[0]),v.TransformNormalToRef(this.cameraDirection,L.Matrix[0],L.Vector3[0]),void this.position.addInPlace(L.Vector3[0]);this.position.addInPlace(this.cameraDirection)}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;t&&this._updatePosition(),i&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this.rotation),this.rotation.x+=this.cameraRotation.x*e,this.rotation.y+=this.cameraRotation.y*e,this.noRotationConstraint||(this.rotation.x>1.570796&&(this.rotation.x=1.570796),this.rotation.x<-1.570796&&(this.rotation.x=-1.570796)),this.rotationQuaternion&&this.rotation.lengthSquared()&&Z.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)),t&&(Math.abs(this.cameraDirection.x)<this.speed*ot&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*ot&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*ot&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*ot&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*ot&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):F.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return v.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),v.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?fs.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(Z.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),fs.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.ignoreParentScaling){if(this.parent){const s=this.parent.getWorldMatrix();v.TransformCoordinatesToRef(e,s,this._globalPosition),v.TransformCoordinatesToRef(t,s,this._tmpTargetVector),v.TransformNormalToRef(i,s,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(t),this._tmpUpVector.copyFrom(i);this.getScene().useRightHandedSystem?F.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):F.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix)}else if(this.getScene().useRightHandedSystem?F.LookAtRHToRef(e,t,i,this._viewMatrix):F.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){const s=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(s,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==ve.RIG_MODE_NONE){const i=new Gi(e,this.position.clone(),this.getScene());return i.isRigCamera=!0,i.rigParent=this,(this.cameraRigMode===ve.RIG_MODE_VR||this.cameraRigMode===ve.RIG_MODE_WEBVR)&&(this.rotationQuaternion||(this.rotationQuaternion=new Z),i._cameraRigParams={},i.rotationQuaternion=new Z),i.mode=this.mode,i.orthoLeft=this.orthoLeft,i.orthoRight=this.orthoRight,i.orthoTop=this.orthoTop,i.orthoBottom=this.orthoBottom,i}return null}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case ve.RIG_MODE_STEREOSCOPIC_OVERUNDER:case ve.RIG_MODE_STEREOSCOPIC_INTERLACED:{const s=this.cameraRigMode===ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*(this.cameraRigMode===ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1),e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*s,t);break}case ve.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position)}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,Gi._TargetFocalPoint),Gi._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const s=Gi._TargetFocalPoint.addInPlace(this.position);F.TranslationToRef(-s.x,-s.y,-s.z,Gi._TargetTransformMatrix),Gi._TargetTransformMatrix.multiplyToRef(F.RotationAxis(t.upVector,e),Gi._RigCamTransformMatrix),F.TranslationToRef(s.x,s.y,s.z,Gi._TargetTransformMatrix),Gi._RigCamTransformMatrix.multiplyToRef(Gi._TargetTransformMatrix,Gi._RigCamTransformMatrix),v.TransformCoordinatesToRef(this.position,Gi._RigCamTransformMatrix,t.position),t.setTarget(s)}getClassName(){return"TargetCamera"}}Gi._RigCamTransformMatrix=new F,Gi._TargetTransformMatrix=new F,Gi._TargetFocalPoint=new v,E([Ws()],Gi.prototype,"rotation",void 0),E([I()],Gi.prototype,"speed",void 0),E([ip("lockedTargetId")],Gi.prototype,"lockedTarget",void 0);class lr extends Gi{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,s=!0){super(e,t,i,s),this.ellipsoid=new v(.5,1,.5),this.ellipsoidOffset=new v(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=v.Zero(),this._diffPosition=v.Zero(),this._newPosition=v.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(n,o,a=null)=>{(c=>{this._newPosition.copyFrom(c),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>ee.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&a&&this.onCollide(a))})(o)},this.inputs=new yv(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=q.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new v(0,0,0),this.cameraRotation=new de(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;t=this.parent?v.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let s=e;this.applyGravity&&(s=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,s,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=v.Zero(),this._transformedDirection=v.Zero()),this.inputs.checkInputs(),super._checkInputs()}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}E([Ws()],lr.prototype,"ellipsoid",void 0),E([Ws()],lr.prototype,"ellipsoidOffset",void 0),E([I()],lr.prototype,"checkCollisions",void 0),E([I()],lr.prototype,"applyGravity",void 0),Rt.AddNodeConstructor("TouchCamera",(r,e)=>()=>new J1(r,v.Zero(),e));class J1 extends lr{get touchAngularSensibility(){const e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)}get touchMoveSensibility(){const e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){const e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!1:e.allowMouse=!0}}Rt.AddNodeConstructor("ArcRotateCamera",(r,e)=>()=>new si(r,0,0,1,v.Zero(),e));class si extends Gi{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new F,this._upToYMatrix=new F,this._upVector=v.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){F.RotationAlignToRef(v.UpReadOnly,this._upVector,this._yToUpMatrix),F.RotationAlignToRef(this._upVector,v.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){const e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){const t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){const e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){const t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){const e=this.inputs.attached.pointers;return!!e&&e.useNaturalPinchZoom}set useNaturalPinchZoom(e){const t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){const e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){const t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){const e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){const e=this.inputs.attached.mousewheel;return!!e&&e.zoomToMouseLocation}set zoomToMouseLocation(e){const t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){const e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return null!=this._bouncingBehavior}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new sh,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return null!=this._framingBehavior}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new Qr,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return null!=this._autoRotationBehavior}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new mse,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,i,s,n,o,a=!0){super(e,v.Zero(),o,a),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=v.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=de.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this._viewMatrix=new F,this.panningAxis=new v(1,1,0),this._transformedDirection=new v,this.mapPanning=!1,this.onMeshTargetChangedObservable=new z,this.checkCollisions=!1,this.collisionRadius=new v(.5,.5,.5),this._previousPosition=v.Zero(),this._collisionVelocity=v.Zero(),this._newPosition=v.Zero(),this._computationVector=v.Zero(),this._onCollisionPositionChange=(l,c,h=null)=>{h?(this.setPosition(c),this.onCollide&&this.onCollide(h)):this._previousPosition.copyFrom(this._position);const u=Math.cos(this.alpha),d=Math.sin(this.alpha),f=Math.cos(this.beta);let p=Math.sin(this.beta);0===p&&(p=1e-4);const _=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*u*p,this.radius*f,this.radius*d*p),_.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let m=this.upVector;this.allowUpsideDown&&this.beta<0&&(m=m.clone(),m=m.negate()),this._computeViewMatrix(this._position,_,m),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=v.Zero(),n&&this.setTarget(n),this.alpha=t,this.beta=i,this.radius=s,this.getViewMatrix(),this.inputs=new BE(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=de.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){const t=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?t.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(t)}return this._getLockedTargetPosition()||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return!!super._restoreStateValues()&&(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0)}_isSynchronizedViewMatrix(){return!!super._isSynchronizedViewMatrix()&&this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset)}attachControl(e,t,i=!0,s=2){const n=arguments;t=q.BackCompatCameraNoPreventDefault(n),this._useCtrlForPanning=i,this._panningMouseButton=s,"boolean"==typeof n[0]&&(n.length>1&&(this._useCtrlForPanning=n[1]),n.length>2&&(this._panningMouseButton=n[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),0!==this.inertialAlphaOffset||0!==this.inertialBetaOffset||0!==this.inertialRadiusOffset){const e=this.invertRotation?-1:1;let t=this.inertialAlphaOffset;this.beta<=0&&(t*=-1),this.getScene().useRightHandedSystem&&(t*=-1),this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(t*=-1),this.alpha+=t*e,this.beta+=this.inertialBetaOffset*e,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<ot&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<ot&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*ot&&(this.inertialRadiusOffset=0)}if(0!==this.inertialPanningX||0!==this.inertialPanningY){const e=new v(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);this._viewMatrix.invertToRef(this._cameraTransformMatrix),e.multiplyInPlace(this.panningAxis),v.TransformNormalToRef(e,this._cameraTransformMatrix,this._transformedDirection),(this.mapPanning||!this.panningAxis.y)&&(this._transformedDirection.y=0),this._targetHost||(this.panningDistanceLimit?(this._transformedDirection.addInPlace(this._target),v.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection)):this._target.addInPlace(this._transformedDirection)),this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*ot&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*ot&&(this.inertialPanningY=0)}this._checkLimits(),super._checkInputs()}}_checkLimits(){null==this.lowerBetaLimit?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),null==this.upperBetaLimit?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),null!==this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),null!==this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),null!==this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),null!==this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),(0!==this._upVector.x||1!==this._upVector.y||0!==this._upVector.z)&&v.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),0===this.radius&&(this.radius=1e-4);const e=this.alpha;this.alpha=0===this._computationVector.x&&0===this._computationVector.z?Math.PI/2:Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2))),this._computationVector.z<0&&(this.alpha=2*Math.PI-this.alpha);const t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=2*t*Math.PI,this.beta=Math.acos(this._computationVector.y/this.radius),this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,s=!1){var n;if(s=null!==(n=this.overrideCloneAlphaBetaRadius)&&void 0!==n?n:s,e.getBoundingInfo)this._targetBoundingCenter=t?e.getBoundingInfo().boundingBox.centerWorld.clone():null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{const o=e,a=this._getTargetPosition();if(a&&!i&&a.equals(o))return;this._targetHost=null,this._target=o,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}s||this.rebuildAnglesAndRadius()}_getViewMatrix(){const e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta);let s=Math.sin(this.beta);0===s&&(s=1e-4),0===this.radius&&(this.radius=1e-4);const n=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*s,this.radius*i,this.radius*t*s),(0!==this._upVector.x||1!==this._upVector.y||0!==this._upVector.z)&&v.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),n.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){const o=this.getScene().collisionCoordinator;this._collider||(this._collider=o.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,o.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let o=this.upVector;this.allowUpsideDown&&s<0&&(o=o.negate()),this._computeViewMatrix(this._position,n,o),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=n,this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;const i=G.MinMax(e),s=v.Distance(i.min,i.max);this.radius=s*this.zoomOnFactor,this.focusOn({min:i.min,max:i.max,distance:s},t)}focusOn(e,t=!1){let i,s;if(void 0===e.min){const n=e||this.getScene().meshes;i=G.MinMax(n),s=v.Distance(i.min,i.max)}else i=e,s=e.distance;this._target=G.Center(i),t||(this.maxZ=2*s)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case ve.RIG_MODE_STEREOSCOPIC_OVERUNDER:case ve.RIG_MODE_STEREOSCOPIC_INTERLACED:case ve.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(0===t?1:-1);break;case ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(0===t?-1:1)}const s=new si(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return s._cameraRigParams={},s.isRigCamera=!0,s.rigParent=this,s.upVector=this.upVector,s.mode=this.mode,s.orthoLeft=this.orthoLeft,s.orthoRight=this.orthoRight,s.orthoBottom=this.orthoBottom,s.orthoTop=this.orthoTop,s}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case ve.RIG_MODE_STEREOSCOPIC_OVERUNDER:case ve.RIG_MODE_STEREOSCOPIC_INTERLACED:case ve.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle}super._updateRigCameras()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}}E([I()],si.prototype,"alpha",void 0),E([I()],si.prototype,"beta",void 0),E([I()],si.prototype,"radius",void 0),E([I()],si.prototype,"overrideCloneAlphaBetaRadius",void 0),E([Ws("target")],si.prototype,"_target",void 0),E([ip("targetHost")],si.prototype,"_targetHost",void 0),E([I()],si.prototype,"inertialAlphaOffset",void 0),E([I()],si.prototype,"inertialBetaOffset",void 0),E([I()],si.prototype,"inertialRadiusOffset",void 0),E([I()],si.prototype,"lowerAlphaLimit",void 0),E([I()],si.prototype,"upperAlphaLimit",void 0),E([I()],si.prototype,"lowerBetaLimit",void 0),E([I()],si.prototype,"upperBetaLimit",void 0),E([I()],si.prototype,"lowerRadiusLimit",void 0),E([I()],si.prototype,"upperRadiusLimit",void 0),E([I()],si.prototype,"inertialPanningX",void 0),E([I()],si.prototype,"inertialPanningY",void 0),E([I()],si.prototype,"pinchToPanMaxDistance",void 0),E([I()],si.prototype,"panningDistanceLimit",void 0),E([Ws()],si.prototype,"panningOriginTarget",void 0),E([I()],si.prototype,"panningInertia",void 0),E([I()],si.prototype,"zoomToMouseLocation",null),E([I()],si.prototype,"zoomOnFactor",void 0),E([iE()],si.prototype,"targetScreenOffset",void 0),E([I()],si.prototype,"allowUpsideDown",void 0),E([I()],si.prototype,"useInputToRestoreState",void 0),Rt.AddNodeConstructor("DeviceOrientationCamera",(r,e)=>()=>new VE(r,v.Zero(),e));class VE extends lr{constructor(e,t,i){super(e,t,i),this._tmpDragQuaternion=new Z,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new Z,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce(()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add(s=>{0!=this._dragFactor&&(this._initialQuaternion||(this._initialQuaternion=new Z),Z.FromEulerAnglesToRef(0,s.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))}))})}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(e=fs.Y){!this.rotationQuaternion||(this._initialQuaternion||(this._initialQuaternion=new Z),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach(t=>{e[t]?this._initialQuaternion[t]*=-1:this._initialQuaternion[t]=0}),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}}class Rse extends _v{constructor(e){super(e)}addKeyboard(){return this.add(new ec),this}addMouse(){return this.add(new gv),this}}class Tv extends Gi{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysForward(){const e=this.inputs.attached.keyboard;return e?e.keysForward:[]}set keysForward(e){const t=this.inputs.attached.keyboard;t&&(t.keysForward=e)}get keysBackward(){const e=this.inputs.attached.keyboard;return e?e.keysBackward:[]}set keysBackward(e){const t=this.inputs.attached.keyboard;t&&(t.keysBackward=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}constructor(e,t,i,s=!0){super(e,t,i,s),this.ellipsoid=new v(1,1,1),this.ellipsoidOffset=new v(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this.cameraDirection=v.Zero(),this._trackRoll=0,this.rollCorrect=100,this.bankedTurn=!1,this.bankedTurnLimit=Math.PI/2,this.bankedTurnMultiplier=1,this._needMoveForGravity=!1,this._oldPosition=v.Zero(),this._diffPosition=v.Zero(),this._newPosition=v.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(n,o,a=null)=>{(c=>{this._newPosition.copyFrom(c),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>ee.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&a&&this.onCollide(a))})(o)},this.inputs=new Rse(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=q.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new v(0,0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;t=this.parent?v.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let s=e;this.applyGravity&&(s=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,s,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=v.Zero(),this._transformedDirection=v.Zero()),this.inputs.checkInputs(),super._checkInputs()}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}restoreRoll(e){const t=this._trackRoll,s=t-this.rotation.z;Math.abs(s)>=.001&&(this.rotation.z+=s/e,Math.abs(t-this.rotation.z)<=.001&&(this.rotation.z=t))}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FlyCamera"}}E([Ws()],Tv.prototype,"ellipsoid",void 0),E([Ws()],Tv.prototype,"ellipsoidOffset",void 0),E([I()],Tv.prototype,"checkCollisions",void 0),E([I()],Tv.prototype,"applyGravity",void 0);class Ise extends _v{constructor(e){super(e)}addKeyboard(){return this.add(new Ys),this}addMouseWheel(){return this.add(new ch),this}addPointers(){return this.add(new Jr),this}addVRDeviceOrientation(){return console.warn("DeviceOrientation support not yet implemented for FollowCamera."),this}}Rt.AddNodeConstructor("FollowCamera",(r,e)=>()=>new Wn(r,v.Zero(),e)),Rt.AddNodeConstructor("ArcFollowCamera",(r,e)=>()=>new Mse(r,0,0,1,null,e));class Wn extends Gi{constructor(e,t,i,s=null){super(e,t,i),this.radius=12,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.rotationOffset=0,this.lowerRotationOffsetLimit=null,this.upperRotationOffsetLimit=null,this.heightOffset=4,this.lowerHeightOffsetLimit=null,this.upperHeightOffsetLimit=null,this.cameraAcceleration=.05,this.maxCameraSpeed=20,this.lockedTarget=s,this.inputs=new Ise(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_follow(e){if(!e)return;const t=L.Matrix[0];e.absoluteRotationQuaternion.toRotationMatrix(t);const i=Math.atan2(t.m[8],t.m[10]),s=q.ToRadians(this.rotationOffset)+i,n=e.getAbsolutePosition(),o=n.x+Math.sin(s)*this.radius,a=n.z+Math.cos(s)*this.radius;let u=(o-this.position.x)*this.cameraAcceleration*2,d=(n.y+this.heightOffset-this.position.y)*this.cameraAcceleration,f=(a-this.position.z)*this.cameraAcceleration*2;(u>this.maxCameraSpeed||u<-this.maxCameraSpeed)&&(u=u<1?-this.maxCameraSpeed:this.maxCameraSpeed),(d>this.maxCameraSpeed||d<-this.maxCameraSpeed)&&(d=d<1?-this.maxCameraSpeed:this.maxCameraSpeed),(f>this.maxCameraSpeed||f<-this.maxCameraSpeed)&&(f=f<1?-this.maxCameraSpeed:this.maxCameraSpeed),this.position=new v(this.position.x+u,this.position.y+d,this.position.z+f),this.setTarget(n)}attachControl(e,t){t=q.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t),this._reset=()=>{}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){this.inputs.checkInputs(),this._checkLimits(),super._checkInputs(),this.lockedTarget&&this._follow(this.lockedTarget)}_checkLimits(){null!==this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),null!==this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit),null!==this.lowerHeightOffsetLimit&&this.heightOffset<this.lowerHeightOffsetLimit&&(this.heightOffset=this.lowerHeightOffsetLimit),null!==this.upperHeightOffsetLimit&&this.heightOffset>this.upperHeightOffsetLimit&&(this.heightOffset=this.upperHeightOffsetLimit),null!==this.lowerRotationOffsetLimit&&this.rotationOffset<this.lowerRotationOffsetLimit&&(this.rotationOffset=this.lowerRotationOffsetLimit),null!==this.upperRotationOffsetLimit&&this.rotationOffset>this.upperRotationOffsetLimit&&(this.rotationOffset=this.upperRotationOffsetLimit)}getClassName(){return"FollowCamera"}}E([I()],Wn.prototype,"radius",void 0),E([I()],Wn.prototype,"lowerRadiusLimit",void 0),E([I()],Wn.prototype,"upperRadiusLimit",void 0),E([I()],Wn.prototype,"rotationOffset",void 0),E([I()],Wn.prototype,"lowerRotationOffsetLimit",void 0),E([I()],Wn.prototype,"upperRotationOffsetLimit",void 0),E([I()],Wn.prototype,"heightOffset",void 0),E([I()],Wn.prototype,"lowerHeightOffsetLimit",void 0),E([I()],Wn.prototype,"upperHeightOffsetLimit",void 0),E([I()],Wn.prototype,"cameraAcceleration",void 0),E([I()],Wn.prototype,"maxCameraSpeed",void 0),E([ip("lockedTargetId")],Wn.prototype,"lockedTarget",void 0);class Mse extends Gi{constructor(e,t,i,s,n,o){super(e,v.Zero(),o),this.alpha=t,this.beta=i,this.radius=s,this._cartesianCoordinates=v.Zero(),this.setMeshTarget(n)}setMeshTarget(e){this._meshTarget=e,this._follow()}_follow(){if(!this._meshTarget)return;this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta),this._cartesianCoordinates.y=this.radius*Math.sin(this.beta),this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);const e=this._meshTarget.getAbsolutePosition();this.position=e.add(this._cartesianCoordinates),this.setTarget(e)}_checkInputs(){super._checkInputs(),this._follow()}getClassName(){return"ArcFollowCamera"}}var Ho=(()=>{return(r=Ho||(Ho={}))[r.VIVE=0]="VIVE",r[r.OCULUS=1]="OCULUS",r[r.WINDOWS=2]="WINDOWS",r[r.GEAR_VR=3]="GEAR_VR",r[r.DAYDREAM=4]="DAYDREAM",r[r.GENERIC=5]="GENERIC",Ho;var r})();let hh=(()=>{class r{static InitiateController(t){for(const i of this._ControllerFactories)if(i.canCreate(t))return i.create(t);if(this._DefaultControllerFactory)return this._DefaultControllerFactory(t);throw"The type of gamepad you are trying to load needs to be imported first or is not supported."}}return r._ControllerFactories=[],r._DefaultControllerFactory=null,r})(),Sv=(()=>{class r extends ar{_disableTrackPosition(t){this._trackPosition&&(this._calculatedPosition.copyFrom(t),this._trackPosition=!1)}constructor(t){super(t.id,t.index,t),this.isXR=!1,this._deviceRoomPosition=v.Zero(),this._deviceRoomRotationQuaternion=new Z,this.devicePosition=v.Zero(),this.deviceRotationQuaternion=new Z,this.deviceScaleFactor=1,this._trackPosition=!0,this._maxRotationDistFromHeadset=Math.PI/5,this._draggedRoomRotation=0,this._leftHandSystemQuaternion=new Z,this._deviceToWorld=F.Identity(),this._pointingPoseNode=null,this._workingMatrix=F.Identity(),this._meshAttachedObservable=new z,this.type=ar.POSE_ENABLED,this.controllerType=Ho.GENERIC,this.position=v.Zero(),this.rotationQuaternion=new Z,this._calculatedPosition=v.Zero(),this._calculatedRotation=new Z,Z.RotationYawPitchRollToRef(Math.PI,0,0,this._leftHandSystemQuaternion)}update(){super.update(),this._updatePoseAndMesh()}_updatePoseAndMesh(){if(!this.isXR){if(this.updateFromDevice(this.browserGamepad.pose),!this._trackPosition&&be.LastCreatedScene&&be.LastCreatedScene.activeCamera&&be.LastCreatedScene.activeCamera.devicePosition){const i=be.LastCreatedScene.activeCamera;if(i._computeDevicePosition(),this._deviceToWorld.setTranslation(i.devicePosition),i.deviceRotationQuaternion){i._deviceRoomRotationQuaternion.toEulerAnglesToRef(L.Vector3[0]);const s=Math.atan2(Math.sin(L.Vector3[0].y-this._draggedRoomRotation),Math.cos(L.Vector3[0].y-this._draggedRoomRotation));if(Math.abs(s)>this._maxRotationDistFromHeadset){const n=s-(s<0?-this._maxRotationDistFromHeadset:this._maxRotationDistFromHeadset);this._draggedRoomRotation+=n;const o=Math.sin(-n),a=Math.cos(-n);this._calculatedPosition.x=this._calculatedPosition.x*a-this._calculatedPosition.z*o,this._calculatedPosition.z=this._calculatedPosition.x*o+this._calculatedPosition.z*a}}}v.TransformCoordinatesToRef(this._calculatedPosition,this._deviceToWorld,this.devicePosition),this._deviceToWorld.getRotationMatrixToRef(this._workingMatrix),Z.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion),this.deviceRotationQuaternion.multiplyInPlace(this._calculatedRotation),this._mesh&&(this._mesh.position.copyFrom(this.devicePosition),this._mesh.rotationQuaternion&&this._mesh.rotationQuaternion.copyFrom(this.deviceRotationQuaternion))}}updateFromDevice(t){if(!this.isXR&&t){this.rawPose=t,t.position&&(this._deviceRoomPosition.copyFromFloats(t.position[0],t.position[1],-t.position[2]),this._mesh&&this._mesh.getScene().useRightHandedSystem&&(this._deviceRoomPosition.z*=-1),this._trackPosition&&this._deviceRoomPosition.scaleToRef(this.deviceScaleFactor,this._calculatedPosition),this._calculatedPosition.addInPlace(this.position));const i=this.rawPose;t.orientation&&i.orientation&&4===i.orientation.length&&(this._deviceRoomRotationQuaternion.copyFromFloats(i.orientation[0],i.orientation[1],-i.orientation[2],-i.orientation[3]),this._mesh&&(this._mesh.getScene().useRightHandedSystem?(this._deviceRoomRotationQuaternion.z*=-1,this._deviceRoomRotationQuaternion.w*=-1):this._deviceRoomRotationQuaternion.multiplyToRef(this._leftHandSystemQuaternion,this._deviceRoomRotationQuaternion)),this._deviceRoomRotationQuaternion.multiplyToRef(this.rotationQuaternion,this._calculatedRotation))}}attachToMesh(t){if(this._mesh&&(this._mesh.parent=null),this._mesh=t,this._poseControlledCamera&&(this._mesh.parent=this._poseControlledCamera),this._mesh.rotationQuaternion||(this._mesh.rotationQuaternion=new Z),!this.isXR&&(this._updatePoseAndMesh(),this._pointingPoseNode)){const i=[];let s=this._pointingPoseNode;for(;s.parent;)i.push(s.parent),s=s.parent;i.reverse().forEach(n=>{n.computeWorldMatrix(!0)})}this._meshAttachedObservable.notifyObservers(t)}attachToPoseControlledCamera(t){this._poseControlledCamera=t,this._mesh&&(this._mesh.parent=this._poseControlledCamera)}dispose(){this._mesh&&this._mesh.dispose(),this._mesh=null,super.dispose()}get mesh(){return this._mesh}getForwardRay(t=100){if(!this.mesh)return new Qe(v.Zero(),new v(0,0,1),t);const i=this._pointingPoseNode?this._pointingPoseNode.getWorldMatrix():this.mesh.getWorldMatrix(),s=i.getTranslation(),n=new v(0,0,-1),o=v.TransformNormal(n,i),a=v.Normalize(o);return new Qe(s,a,t)}}return r.POINTING_POSE="POINTING_POSE",r})();var en=(()=>{return(r=en||(en={}))[r.A=0]="A",r[r.B=1]="B",r[r.X=2]="X",r[r.Y=3]="Y",r[r.LB=4]="LB",r[r.RB=5]="RB",r[r.Back=8]="Back",r[r.Start=9]="Start",r[r.LeftStick=10]="LeftStick",r[r.RightStick=11]="RightStick",en;var r})(),uh=(()=>{return(r=uh||(uh={}))[r.Up=12]="Up",r[r.Down=13]="Down",r[r.Left=14]="Left",r[r.Right=15]="Right",uh;var r})();class Pse extends ar{constructor(e,t,i,s=!1){super(e,t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new z,this.onButtonUpObservable=new z,this.onPadDownObservable=new z,this.onPadUpObservable=new z,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=ar.XBOX,this._isXboxOnePad=s}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,en.A)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,en.B)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,en.X)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,en.Y)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,en.Start)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,en.Back)}get buttonLB(){return this._buttonLB}set buttonLB(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,en.LB)}get buttonRB(){return this._buttonRB}set buttonRB(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,en.RB)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,en.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,en.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,uh.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,uh.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,uh.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,uh.Right)}update(){super.update(),this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}var Xn=(()=>{return(r=Xn||(Xn={}))[r.Cross=0]="Cross",r[r.Circle=1]="Circle",r[r.Square=2]="Square",r[r.Triangle=3]="Triangle",r[r.L1=4]="L1",r[r.R1=5]="R1",r[r.Share=8]="Share",r[r.Options=9]="Options",r[r.LeftStick=10]="LeftStick",r[r.RightStick=11]="RightStick",Xn;var r})(),dh=(()=>{return(r=dh||(dh={}))[r.Up=12]="Up",r[r.Down=13]="Down",r[r.Left=14]="Left",r[r.Right=15]="Right",dh;var r})();class Dse extends ar{constructor(e,t,i){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new z,this.onButtonUpObservable=new z,this.onPadDownObservable=new z,this.onPadUpObservable=new z,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=ar.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,Xn.Cross)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,Xn.Circle)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,Xn.Square)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,Xn.Triangle)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,Xn.Options)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,Xn.Share)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,Xn.L1)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,Xn.R1)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,Xn.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,Xn.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,dh.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,dh.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,dh.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,dh.Right)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}class wse{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new z,qi()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new z(t=>{for(const i in this._babylonGamepads){const s=this._babylonGamepads[i];s&&s._isConnected&&this.onGamepadConnectedObservable.notifyObserver(t,s)}}),this._onGamepadConnectedEvent=t=>{const i=t.gamepad;if(i.index in this._babylonGamepads&&this._babylonGamepads[i.index].isConnected)return;let s;this._babylonGamepads[i.index]?(s=this._babylonGamepads[i.index],s.browserGamepad=i,s._isConnected=!0):s=this._addNewGamepad(i),this.onGamepadConnectedObservable.notifyObservers(s),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=t=>{const i=t.gamepad;for(const s in this._babylonGamepads)if(this._babylonGamepads[s].index===i.index){const n=this._babylonGamepads[s];n._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(n),n.dispose&&n.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){const t=this._scene?this._scene.getEngine().getHostWindow():window;t&&(t.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),t.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=ar.XBOX){for(const t of this._babylonGamepads)if(t&&t.type===e)return t;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach(e=>{e.dispose()}),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){let t;this._oneGamepadConnected||(this._oneGamepadConnected=!0);const i=-1!==e.id.search("054c")&&-1===e.id.search("0ce6"),s=-1!==e.id.search("Xbox One");return t=s||-1!==e.id.search("Xbox 360")||-1!==e.id.search("xinput")||-1!==e.id.search("045e")&&-1===e.id.search("Surface Dock")?new Pse(e.id,e.index,e,s):i?new Dse(e.id,e.index,e):e.pose?hh.InitiateController(e):new Cse(e.id,e.index,e),this._babylonGamepads[t.index]=t,t}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._scene||this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(const e in this._babylonGamepads){const t=this._babylonGamepads[e];if(t&&t.isConnected)try{t.update()}catch{-1===this._loggedErrors.indexOf(t.index)&&(q.Warn(`Error updating gamepad ${t.id}`),this._loggedErrors.push(t.index))}}this._isMonitoring&&!this._scene&&ee.QueueNewFrame(()=>{this._checkGamepadsStatus()})}_updateGamepadObjects(){const e=navigator.getGamepads?navigator.getGamepads():[];for(let t=0;t<e.length;t++){const i=e[t];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[t].browserGamepad=i,this._babylonGamepads[t].isConnected||(this._babylonGamepads[t]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t]));else{const s=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(s)}}}}Object.defineProperty(ge.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new wse(this);let r=this._getComponent(Me.NAME_GAMEPAD);r||(r=new Ose(this),this._addComponent(r))}return this._gamepadManager},enumerable:!0,configurable:!0}),yv.prototype.addGamepad=function(){return this.add(new xv),this},BE.prototype.addGamepad=function(){return this.add(new mv),this};class Ose{constructor(e){this.name=Me.NAME_GAMEPAD,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(Me.STEP_BEFORECAMERAUPDATE_GAMEPAD,this,this._beforeCameraUpdate)}rebuild(){}dispose(){const e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}_beforeCameraUpdate(){const e=this.scene._gamepadManager;e&&e._isMonitoring&&e._checkGamepadsStatus()}}Rt.AddNodeConstructor("FreeCamera",(r,e)=>()=>new qu(r,v.Zero(),e));class qu extends J1{get gamepadAngularSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}}ve._CreateDefaultParsedCamera=(r,e)=>new qu(r,v.Zero(),e),Rt.AddNodeConstructor("GamepadCamera",(r,e)=>()=>new UE(r,v.Zero(),e));class UE extends qu{constructor(e,t,i){super(e,t,i)}getClassName(){return"GamepadCamera"}}j.ShadersStore.passCubePixelShader="varying vec2 vUV;\nuniform samplerCube textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\nvec2 uv=vUV*2.0-1.0;\n#ifdef POSITIVEX\ngl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));\n#endif\n#ifdef NEGATIVEX\ngl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));\n#endif\n#ifdef POSITIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));\n#endif\n#ifdef NEGATIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));\n#endif\n#ifdef POSITIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,1.001));\n#endif\n#ifdef NEGATIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));\n#endif\n}";class fa extends Pe{getClassName(){return"PassPostProcess"}constructor(e,t,i=null,s,n,o,a=0,l=!1){super(e,"pass",null,null,t,i,s,n,o,void 0,a,void 0,null,l)}static _Parse(e,t,i,s){return Ce.Parse(()=>new fa(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,i,s)}}le("BABYLON.PassPostProcess",fa),ee._RescalePostProcessFactory=r=>new fa("rescale",1,null,2,r,!1,0);j.ShadersStore.anaglyphPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D leftSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec4 leftFrag=texture2D(leftSampler,vUV);\nleftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);\nvec4 rightFrag=texture2D(textureSampler,vUV);\nrightFrag=vec4(rightFrag.r,1.0,1.0,1.0);\ngl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);\n}";class nL extends Pe{getClassName(){return"AnaglyphPostProcess"}constructor(e,t,i,s,n,o){super(e,"anaglyph",null,["leftSampler"],t,i[1],s,n,o),this._passedProcess=i[0]._rigPostProcess,this.onApplyObservable.add(a=>{a.setTextureFromPostProcess("leftSampler",this._passedProcess)})}}function Ev(r){r._rigCameras[0]._rigPostProcess=new fa(r.name+"_passthru",1,r._rigCameras[0]),r._rigCameras[1]._rigPostProcess=new nL(r.name+"_anaglyph",1,r._rigCameras)}le("BABYLON.AnaglyphPostProcess",nL),Rt.AddNodeConstructor("AnaglyphArcRotateCamera",(r,e,t)=>()=>new Nse(r,0,0,1,v.Zero(),t.interaxial_distance,e));class Nse extends si{constructor(e,t,i,s,n,o,a){super(e,t,i,s,n,a),this._setRigMode=Ev.bind(null,this),this.interaxialDistance=o,this.setCameraRigMode(ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:o})}getClassName(){return"AnaglyphArcRotateCamera"}}Rt.AddNodeConstructor("AnaglyphFreeCamera",(r,e,t)=>()=>new Fse(r,v.Zero(),t.interaxial_distance,e));class Fse extends lr{constructor(e,t,i,s){super(e,t,s),this._setRigMode=Ev.bind(null,this),this.interaxialDistance=i,this.setCameraRigMode(ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphFreeCamera"}}Rt.AddNodeConstructor("AnaglyphGamepadCamera",(r,e,t)=>()=>new Lse(r,v.Zero(),t.interaxial_distance,e));class Lse extends UE{constructor(e,t,i,s){super(e,t,s),this._setRigMode=Ev.bind(null,this),this.interaxialDistance=i,this.setCameraRigMode(ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphGamepadCamera"}}Rt.AddNodeConstructor("AnaglyphUniversalCamera",(r,e,t)=>()=>new Bse(r,v.Zero(),t.interaxial_distance,e));class Bse extends qu{constructor(e,t,i,s){super(e,t,s),this._setRigMode=Ev.bind(null,this),this.interaxialDistance=i,this.setCameraRigMode(ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphUniversalCamera"}}j.ShadersStore.stereoscopicInterlacePixelShader="const vec3 TWO=vec3(2.0,2.0,2.0);\nvarying vec2 vUV;\nuniform sampler2D camASampler;\nuniform sampler2D textureSampler;\nuniform vec2 stepSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nbool useCamA;\nbool useCamB;\nvec2 texCoord1;\nvec2 texCoord2;\nvec3 frag1;\nvec3 frag2;\n#ifdef IS_STEREOSCOPIC_HORIZ\nuseCamB=vUV.x>0.5;\nuseCamA=!useCamB;\ntexCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);\ntexCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);\n#else\n#ifdef IS_STEREOSCOPIC_INTERLACED\nfloat rowNum=floor(vUV.y/stepSize.y);\nuseCamA=mod(rowNum,2.0)==1.0;\nuseCamB=mod(rowNum,2.0)==0.0;\ntexCoord1=vec2(vUV.x,vUV.y);\ntexCoord2=vec2(vUV.x,vUV.y);\n#else\nuseCamB=vUV.y>0.5;\nuseCamA=!useCamB;\ntexCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);\ntexCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);\n#endif\n#endif\nif (useCamB){\nfrag1=texture2D(textureSampler,texCoord1).rgb;\nfrag2=texture2D(textureSampler,texCoord2).rgb;\n}else if (useCamA){\nfrag1=texture2D(camASampler ,texCoord1).rgb;\nfrag2=texture2D(camASampler ,texCoord2).rgb;\n}else {\ndiscard;\n}\ngl_FragColor=vec4((frag1+frag2)/TWO,1.0);\n}\n";class Vse extends Pe{getClassName(){return"StereoscopicInterlacePostProcessI"}constructor(e,t,i,s,n,o,a){super(e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,t[1],n,o,a,s?"#define IS_STEREOSCOPIC_INTERLACED 1":i?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=t[0]._rigPostProcess,this._stepSize=new de(1/this.width,1/this.height),this.onSizeChangedObservable.add(()=>{this._stepSize=new de(1/this.width,1/this.height)}),this.onApplyObservable.add(l=>{l.setTextureFromPostProcess("camASampler",this._passedProcess),l.setFloat2("stepSize",this._stepSize.x,this._stepSize.y)})}}function Cv(r){const e=r.cameraRigMode===ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||r.cameraRigMode===ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,t=r.cameraRigMode===ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;r.cameraRigMode===ve.RIG_MODE_STEREOSCOPIC_INTERLACED?(r._rigCameras[0]._rigPostProcess=new fa(r.name+"_passthru",1,r._rigCameras[0]),r._rigCameras[1]._rigPostProcess=new Vse(r.name+"_stereoInterlace",r._rigCameras,!1,!0)):(r._rigCameras[t?1:0].viewport=new qr(0,0,e?.5:1,e?1:.5),r._rigCameras[t?0:1].viewport=new qr(e?.5:0,e?0:.5,e?.5:1,e?1:.5))}Rt.AddNodeConstructor("StereoscopicArcRotateCamera",(r,e,t)=>()=>new Use(r,0,0,1,v.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class Use extends si{constructor(e,t,i,s,n,o,a,l){super(e,t,i,s,n,l),this._setRigMode=Cv.bind(null,this),this.interaxialDistance=o,this.isStereoscopicSideBySide=a,this.setCameraRigMode(a?ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:ve.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:o})}getClassName(){return"StereoscopicArcRotateCamera"}}Rt.AddNodeConstructor("StereoscopicFreeCamera",(r,e,t)=>()=>new kse(r,v.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class kse extends lr{constructor(e,t,i,s,n){super(e,t,n),this._setRigMode=Cv.bind(null,this),this.interaxialDistance=i,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:ve.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicFreeCamera"}}Rt.AddNodeConstructor("StereoscopicGamepadCamera",(r,e,t)=>()=>new Gse(r,v.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class Gse extends UE{constructor(e,t,i,s,n){super(e,t,n),this._setRigMode=Cv.bind(null,this),this.interaxialDistance=i,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:ve.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicGamepadCamera"}}Rt.AddNodeConstructor("StereoscopicFreeCamera",(r,e,t)=>()=>new zse(r,v.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class zse extends qu{constructor(e,t,i,s,n){super(e,t,n),this._setRigMode=Cv.bind(null,this),this.interaxialDistance=i,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:ve.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicUniversalCamera"}}Rt.AddNodeConstructor("VirtualJoysticksCamera",(r,e)=>()=>new Hse(r,v.Zero(),e));class Hse extends lr{constructor(e,t,i){super(e,t,i),this.inputs.addVirtualJoystick()}getClassName(){return"VirtualJoysticksCamera"}}class fh{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){return F.Translation(4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize,0,0)}get rightHMatrix(){return F.Translation(-4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize,0,0)}get leftPreViewMatrix(){return F.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return F.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){const e=new fh;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}}j.ShadersStore.vrDistortionCorrectionPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 LensCenter;\nuniform vec2 Scale;\nuniform vec2 ScaleIn;\nuniform vec4 HmdWarpParam;\nvec2 HmdWarp(vec2 in01) {\nvec2 theta=(in01-LensCenter)*ScaleIn; \nfloat rSq=theta.x*theta.x+theta.y*theta.y;\nvec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);\nreturn LensCenter+Scale*rvector;\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec2 tc=HmdWarp(vUV);\nif (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)\ngl_FragColor=vec4(0.0,0.0,0.0,0.0);\nelse{\ngl_FragColor=texture2D(textureSampler,tc);\n}\n}";class hL extends Pe{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,t,i,s){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,s.postProcessScaleFactor,t,U.BILINEAR_SAMPLINGMODE),this._isRightEye=i,this._distortionFactors=s.distortionK,this._postProcessScaleFactor=s.postProcessScaleFactor,this._lensCenterOffset=s.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add(()=>{this._scaleIn=new de(2,2/this.aspectRatio),this._scaleFactor=new de(1/this._postProcessScaleFactor*.5,1/this._postProcessScaleFactor*.5*this.aspectRatio),this._lensCenter=new de(this._isRightEye?.5-.5*this._lensCenterOffset:.5+.5*this._lensCenterOffset,.5)}),this.onApplyObservable.add(n=>{n.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),n.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),n.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),n.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])})}}j.ShadersStore.vrMultiviewToSingleviewPixelShader="precision mediump sampler2DArray;\nvarying vec2 vUV;\nuniform sampler2DArray multiviewSampler;\nuniform int imageIndex;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\ngl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));\n}";class kE extends Ss{set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){!this._renderTarget||this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}}function fL(r,e){const t=new Se(r,void 0,!0,e);return t.addUniform("viewProjection",16),t.addUniform("viewProjectionR",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}ee.prototype.createMultiviewRenderTargetTexture=function(r,e){const t=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";const i=this._createHardwareRenderTargetWrapper(!1,!1,{width:r,height:e});i._framebuffer=t.createFramebuffer();const s=new zt(this,Ye.Unknown,!0);return s.width=r,s.height=e,s.isMultiview=!0,i._colorTextureArray=t.createTexture(),t.bindTexture(t.TEXTURE_2D_ARRAY,i._colorTextureArray),t.texStorage3D(t.TEXTURE_2D_ARRAY,1,t.RGBA8,r,e,2),i._depthStencilTextureArray=t.createTexture(),t.bindTexture(t.TEXTURE_2D_ARRAY,i._depthStencilTextureArray),t.texStorage3D(t.TEXTURE_2D_ARRAY,1,t.DEPTH24_STENCIL8,r,e,2),s.isReady=!0,i.setTextures(s),i._depthStencilTexture=s,i},ee.prototype.bindMultiviewFramebuffer=function(r){const e=r,t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),!e._colorTextureArray||!e._depthStencilTextureArray)throw"Invalid multiview frame buffer";this.getCaps().oculusMultiview?(i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,e.samples,0,2),i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,e.samples,0,2)):(i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,0,2))},ve.prototype._useMultiviewToSingleView=!1,ve.prototype._multiviewTexture=null,ve.prototype._resizeOrCreateMultiviewTexture=function(r,e){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=r||this._multiviewTexture.getRenderHeight()!=e)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new kE(this.getScene(),{width:r,height:e})):this._multiviewTexture=new kE(this.getScene(),{width:r,height:e})};const Wse=ge.prototype.createSceneUniformBuffer;ge.prototype._transformMatrixR=F.Zero(),ge.prototype._multiviewSceneUbo=null,ge.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=fL(this.getEngine(),"scene_multiview")},ge.prototype.createSceneUniformBuffer=function(r){return this._multiviewSceneUbo?fL(this.getEngine(),r):Wse.bind(this)(r)},ge.prototype._updateMultiviewUbo=function(r,e){r&&e&&r.multiplyToRef(e,this._transformMatrixR),r&&e&&(r.multiplyToRef(e,L.Matrix[0]),Gn.GetRightPlaneToRef(L.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))},ge.prototype._renderMultiviewToSingleView=function(r){r._resizeOrCreateMultiviewTexture(r._rigPostProcess&&r._rigPostProcess&&r._rigPostProcess.width>0?r._rigPostProcess.width:this.getEngine().getRenderWidth(!0),r._rigPostProcess&&r._rigPostProcess&&r._rigPostProcess.height>0?r._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),r.outputRenderTarget=r._multiviewTexture,this._renderForCamera(r),r.outputRenderTarget=null;for(let e=0;e<r._rigCameras.length;e++){const t=this.getEngine();this._activeCamera=r._rigCameras[e],t.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};class pL extends Pe{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,i){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],i,t,U.BILINEAR_SAMPLINGMODE);const s=t??this.getCamera();this.onSizeChangedObservable.add(()=>{}),this.onApplyObservable.add(n=>{n.setInt("imageIndex",s._scene.activeCamera&&s._scene.activeCamera.isLeftCamera?0:1),n.setTexture("multiviewSampler",s._multiviewTexture)})}}function GE(r,e){const t=e.vrCameraMetrics||fh.GetDefault();r._rigCameras[0]._cameraRigParams.vrMetrics=t,r._rigCameras[0].viewport=new qr(0,0,.5,1),r._rigCameras[0]._cameraRigParams.vrWorkMatrix=new F,r._rigCameras[0]._cameraRigParams.vrHMatrix=t.leftHMatrix,r._rigCameras[0]._cameraRigParams.vrPreViewMatrix=t.leftPreViewMatrix,r._rigCameras[0].getProjectionMatrix=r._rigCameras[0]._getVRProjectionMatrix,r._rigCameras[1]._cameraRigParams.vrMetrics=t,r._rigCameras[1].viewport=new qr(.5,0,.5,1),r._rigCameras[1]._cameraRigParams.vrWorkMatrix=new F,r._rigCameras[1]._cameraRigParams.vrHMatrix=t.rightHMatrix,r._rigCameras[1]._cameraRigParams.vrPreViewMatrix=t.rightPreViewMatrix,r._rigCameras[1].getProjectionMatrix=r._rigCameras[1]._getVRProjectionMatrix,t.multiviewEnabled&&(r.getScene().getEngine().getCaps().multiview?(r._useMultiviewToSingleView=!0,r._rigPostProcess=new pL("VRMultiviewToSingleview",r,t.postProcessScaleFactor)):(V.Warn("Multiview is not supported, falling back to standard rendering"),t.multiviewEnabled=!1)),t.compensateDistortion&&(r._rigCameras[0]._rigPostProcess=new hL("VR_Distort_Compensation_Left",r._rigCameras[0],!1,t),r._rigCameras[1]._rigPostProcess=new hL("VR_Distort_Compensation_Right",r._rigCameras[1],!0,t))}Rt.AddNodeConstructor("VRDeviceOrientationArcRotateCamera",(r,e)=>()=>new Xse(r,0,0,1,v.Zero(),e));class Xse extends si{constructor(e,t,i,s,n,o,a=!0,l=fh.GetDefault()){super(e,t,i,s,n,o),this._setRigMode=GE.bind(null,this),l.compensateDistortion=a,this.setCameraRigMode(ve.RIG_MODE_VR,{vrCameraMetrics:l}),this.inputs.addVRDeviceOrientation()}getClassName(){return"VRDeviceOrientationArcRotateCamera"}}Rt.AddNodeConstructor("VRDeviceOrientationFreeCamera",(r,e)=>()=>new zE(r,v.Zero(),e));class zE extends VE{constructor(e,t,i,s=!0,n=fh.GetDefault()){super(e,t,i),this._setRigMode=GE.bind(null,this),n.compensateDistortion=s,this.setCameraRigMode(ve.RIG_MODE_VR,{vrCameraMetrics:n})}getClassName(){return"VRDeviceOrientationFreeCamera"}}Rt.AddNodeConstructor("VRDeviceOrientationGamepadCamera",(r,e)=>()=>new jse(r,v.Zero(),e));class jse extends zE{constructor(e,t,i,s=!0,n=fh.GetDefault()){super(e,t,i,s,n),this._setRigMode=GE.bind(null,this),this.inputs.addGamepad()}getClassName(){return"VRDeviceOrientationGamepadCamera"}}Rt.AddNodeConstructor("Light_Type_3",(r,e)=>()=>new jn(r,v.Zero(),e));class jn extends Je{constructor(e,t,i){super(e,i),this.groundColor=new re(0,0,0),this.direction=t||v.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=v.Normalize(e.subtract(v.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){const i=v.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){const i=v.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=F.Identity()),this._worldMatrix}getTypeID(){return Je.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}}function Yse(r,e){if(e.vrDisplay){const t=e.vrDisplay.getEyeParameters("left"),i=e.vrDisplay.getEyeParameters("right");r._rigCameras[0].viewport=new qr(0,0,.5,1),r._rigCameras[0].setCameraRigParameter("left",!0),r._rigCameras[0].setCameraRigParameter("specs",e.specs),r._rigCameras[0].setCameraRigParameter("eyeParameters",t),r._rigCameras[0].setCameraRigParameter("frameData",e.frameData),r._rigCameras[0].setCameraRigParameter("parentCamera",e.parentCamera),r._rigCameras[0]._cameraRigParams.vrWorkMatrix=new F,r._rigCameras[0].getProjectionMatrix=r._getWebVRProjectionMatrix,r._rigCameras[0].parent=r,r._rigCameras[0]._getViewMatrix=r._getWebVRViewMatrix,r._rigCameras[1].viewport=new qr(.5,0,.5,1),r._rigCameras[1].setCameraRigParameter("eyeParameters",i),r._rigCameras[1].setCameraRigParameter("specs",e.specs),r._rigCameras[1].setCameraRigParameter("frameData",e.frameData),r._rigCameras[1].setCameraRigParameter("parentCamera",e.parentCamera),r._rigCameras[1]._cameraRigParams.vrWorkMatrix=new F,r._rigCameras[1].getProjectionMatrix=r._getWebVRProjectionMatrix,r._rigCameras[1].parent=r,r._rigCameras[1]._getViewMatrix=r._getWebVRViewMatrix}}E([us()],jn.prototype,"groundColor",void 0),E([Ws()],jn.prototype,"direction",void 0),Object.defineProperty(ee.prototype,"isInVRExclusivePointerMode",{get:function(){return this._vrExclusivePointerMode},enumerable:!0,configurable:!0}),ee.prototype._prepareVRComponent=function(){this._vrSupported=!1,this._vrExclusivePointerMode=!1,this.onVRDisplayChangedObservable=new z,this.onVRRequestPresentComplete=new z,this.onVRRequestPresentStart=new z},ee.prototype.isVRDevicePresent=function(){return!!this._vrDisplay},ee.prototype.getVRDevice=function(){return this._vrDisplay},ee.prototype.initWebVR=function(){return this.initWebVRAsync(),this.onVRDisplayChangedObservable},ee.prototype.initWebVRAsync=function(){const r=()=>{const e={vrDisplay:this._vrDisplay,vrSupported:this._vrSupported};this.onVRDisplayChangedObservable.notifyObservers(e),this._webVRInitPromise=new Promise(t=>{t(e)})};if(!this._onVrDisplayConnect){this._onVrDisplayConnect=t=>{this._vrDisplay=t.display,r()},this._onVrDisplayDisconnect=()=>{this._vrDisplay.cancelAnimationFrame(this._frameHandler),this._vrDisplay=void 0,this._frameHandler=ee.QueueNewFrame(this._boundRenderFunction),r()},this._onVrDisplayPresentChange=()=>{this._vrExclusivePointerMode=this._vrDisplay&&this._vrDisplay.isPresenting};const e=this.getHostWindow();e&&(e.addEventListener("vrdisplayconnect",this._onVrDisplayConnect),e.addEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),e.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange))}return this._webVRInitPromise=this._webVRInitPromise||this._getVRDisplaysAsync(),this._webVRInitPromise.then(r),this._webVRInitPromise},ee.prototype._getVRDisplaysAsync=function(){return new Promise(r=>{navigator.getVRDisplays?navigator.getVRDisplays().then(e=>{this._vrSupported=!0,this._vrDisplay=e[0],r({vrDisplay:this._vrDisplay,vrSupported:this._vrSupported})}):(this._vrDisplay=void 0,this._vrSupported=!1,r({vrDisplay:this._vrDisplay,vrSupported:this._vrSupported}))})},ee.prototype.enableVR=function(r){if(this._vrDisplay&&!this._vrDisplay.isPresenting){const e=()=>{this.onVRRequestPresentComplete.notifyObservers(!0),this._onVRFullScreenTriggered()},t=()=>{this.onVRRequestPresentComplete.notifyObservers(!1)};this.onVRRequestPresentStart.notifyObservers(this);const i={highRefreshRate:!!this.vrPresentationAttributes&&this.vrPresentationAttributes.highRefreshRate,foveationLevel:this.vrPresentationAttributes?this.vrPresentationAttributes.foveationLevel:1,multiview:(this.getCaps().multiview||this.getCaps().oculusMultiview)&&r.useMultiview};this._vrDisplay.requestPresent([{source:this.getRenderingCanvas(),attributes:i,...i}]).then(e).catch(t)}},ee.prototype._onVRFullScreenTriggered=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting){this._oldSize=new Vn(this.getRenderWidth(),this.getRenderHeight()),this._oldHardwareScaleFactor=this.getHardwareScalingLevel();const r=this._vrDisplay.getEyeParameters("left");this.setHardwareScalingLevel(1),this.setSize(2*r.renderWidth,r.renderHeight)}else this.setHardwareScalingLevel(this._oldHardwareScaleFactor),this.setSize(this._oldSize.width,this._oldSize.height)},ee.prototype.disableVR=function(){this._vrDisplay&&this._vrDisplay.isPresenting&&this._vrDisplay.exitPresent().then(()=>this._onVRFullScreenTriggered()).catch(()=>this._onVRFullScreenTriggered()),qi()&&(window.removeEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted),window.removeEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted),this._onVrDisplayConnect&&(window.removeEventListener("vrdisplayconnect",this._onVrDisplayConnect),this._onVrDisplayDisconnect&&window.removeEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),this._onVrDisplayPresentChange&&window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),this._onVrDisplayConnect=null,this._onVrDisplayDisconnect=null))},ee.prototype._connectVREvents=function(r,e){if(this._onVRDisplayPointerRestricted=()=>{r&&r.requestPointerLock()},this._onVRDisplayPointerUnrestricted=()=>{if(e)!e.exitPointerLock||e.exitPointerLock();else{const t=this.getHostWindow();t.document&&t.document.exitPointerLock&&t.document.exitPointerLock()}},qi()){const t=this.getHostWindow();t.addEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted,!1),t.addEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted,!1)}},ee.prototype._submitVRFrame=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting)try{this._vrDisplay.submitFrame()}catch(r){q.Warn("webVR submitFrame has had an unexpected failure: "+r)}},ee.prototype.isVRPresenting=function(){return this._vrDisplay&&this._vrDisplay.isPresenting},ee.prototype._requestVRFrame=function(){this._frameHandler=ee.QueueNewFrame(this._boundRenderFunction,this._vrDisplay)},Rt.AddNodeConstructor("WebVRFreeCamera",(r,e)=>()=>new HE(r,v.Zero(),e)),Rt.AddNodeConstructor("WebVRGamepadCamera",(r,e)=>()=>new HE(r,v.Zero(),e));class HE extends lr{constructor(e,t,i,s={}){super(e,t,i),this._webVROptions=s,this._vrDevice=null,this.rawPose=null,this._specsVersion="1.1",this._attached=!1,this._descendants=[],this._deviceRoomPosition=v.Zero(),this._deviceRoomRotationQuaternion=Z.Identity(),this._standingMatrix=null,this.devicePosition=v.Zero(),this.deviceRotationQuaternion=Z.Identity(),this.deviceScaleFactor=1,this._deviceToWorld=F.Identity(),this._worldToDevice=F.Identity(),this.controllers=[],this.onControllersAttachedObservable=new z,this.onControllerMeshLoadedObservable=new z,this.onPoseUpdatedFromDeviceObservable=new z,this._poseSet=!1,this.rigParenting=!0,this._defaultHeight=void 0,this._setRigMode=Yse.bind(null,this),this._detachIfAttached=()=>{const o=this.getEngine().getVRDevice();o&&!o.isPresenting&&this.detachControl()},this._workingVector=v.Zero(),this._oneVector=v.One(),this._workingMatrix=F.Identity(),this._tmpMatrix=new F,this._cache.position=v.Zero(),s.defaultHeight&&(this._defaultHeight=s.defaultHeight,this.position.y=this._defaultHeight),this.minZ=.1,5===arguments.length&&(this._webVROptions=arguments[4]),null==this._webVROptions.trackPosition&&(this._webVROptions.trackPosition=!0),null==this._webVROptions.controllerMeshes&&(this._webVROptions.controllerMeshes=!0),null==this._webVROptions.defaultLightingOnControllers&&(this._webVROptions.defaultLightingOnControllers=!0),this.rotationQuaternion=new Z,this._webVROptions&&this._webVROptions.positionScale&&(this.deviceScaleFactor=this._webVROptions.positionScale);const n=this.getEngine();this._onVREnabled=o=>{o&&this.initControllers()},n.onVRRequestPresentComplete.add(this._onVREnabled),n.initWebVR().add(o=>{!o.vrDisplay||this._vrDevice===o.vrDisplay||(this._vrDevice=o.vrDisplay,this.setCameraRigMode(ve.RIG_MODE_WEBVR,{parentCamera:this,vrDisplay:this._vrDevice,frameData:this._frameData,specs:this._specsVersion}),this._attached&&this.getEngine().enableVR(this._webVROptions))}),typeof VRFrameData<"u"&&(this._frameData=new VRFrameData),s.useMultiview&&(this.getScene().getEngine().getCaps().multiview?(this._useMultiviewToSingleView=!0,this._rigPostProcess=new pL("VRMultiviewToSingleview",this,1)):(V.Warn("Multiview is not supported, falling back to standard rendering"),this._useMultiviewToSingleView=!1)),this.getScene().onBeforeCameraRenderObservable.add(o=>{o.parent===this&&this.rigParenting&&(this._descendants=this.getDescendants(!0,a=>{const l=this.controllers.some(h=>h._mesh===a),c=-1!==this._rigCameras.indexOf(a);return!l&&!c}),this._descendants.forEach(a=>{a.parent=o}))}),this.getScene().onAfterCameraRenderObservable.add(o=>{o.parent===this&&this.rigParenting&&this._descendants.forEach(a=>{a.parent=this})})}deviceDistanceToRoomGround(){return this._standingMatrix?(this._standingMatrix.getTranslationToRef(this._workingVector),this._deviceRoomPosition.y+this._workingVector.y):this._defaultHeight||0}useStandingMatrix(e=(t=>{})){this.getEngine().initWebVRAsync().then(t=>{t.vrDisplay&&t.vrDisplay.stageParameters&&t.vrDisplay.stageParameters.sittingToStandingTransform&&this._webVROptions.trackPosition?(this._standingMatrix=new F,F.FromFloat32ArrayToRefScaled(t.vrDisplay.stageParameters.sittingToStandingTransform,0,1,this._standingMatrix),this.getScene().useRightHandedSystem||this._standingMatrix&&this._standingMatrix.toggleModelMatrixHandInPlace(),e(!0)):e(!1)})}useStandingMatrixAsync(){return new Promise(e=>{this.useStandingMatrix(t=>{e(t)})})}dispose(){this._detachIfAttached(),this.getEngine().onVRRequestPresentComplete.removeCallback(this._onVREnabled),this._updateCacheWhenTrackingDisabledObserver&&this._scene.onBeforeRenderObservable.remove(this._updateCacheWhenTrackingDisabledObserver),super.dispose()}getControllerByName(e){for(const t of this.controllers)if(t.hand===e)return t;return null}get leftController(){return this._leftController||(this._leftController=this.getControllerByName("left")),this._leftController}get rightController(){return this._rightController||(this._rightController=this.getControllerByName("right")),this._rightController}getForwardRay(e=100){return this.leftCamera?super.getForwardRay(e,this.leftCamera.getWorldMatrix(),this.leftCamera.globalPosition):super.getForwardRay(e)}_checkInputs(){this._vrDevice&&this._vrDevice.isPresenting&&(this._vrDevice.getFrameData(this._frameData),this.updateFromDevice(this._frameData.pose)),super._checkInputs()}updateFromDevice(e){e&&e.orientation&&4===e.orientation.length&&(this.rawPose=e,this._deviceRoomRotationQuaternion.copyFromFloats(e.orientation[0],e.orientation[1],-e.orientation[2],-e.orientation[3]),this.getScene().useRightHandedSystem&&(this._deviceRoomRotationQuaternion.z*=-1,this._deviceRoomRotationQuaternion.w*=-1),this._webVROptions.trackPosition&&this.rawPose.position&&(this._deviceRoomPosition.copyFromFloats(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2]),this.getScene().useRightHandedSystem&&(this._deviceRoomPosition.z*=-1)),this._poseSet=!0)}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),super.attachControl(e),this._attached=!0,e=!ve.ForceAttachControlToAlwaysPreventDefault&&e,this._vrDevice&&this.getEngine().enableVR(this._webVROptions);const t=this._scene.getEngine().getHostWindow();t&&t.addEventListener("vrdisplaypresentchange",this._detachIfAttached)}detachControl(){this.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),super.detachControl(),this._attached=!1,this.getEngine().disableVR(),window.removeEventListener("vrdisplaypresentchange",this._detachIfAttached)}getClassName(){return"WebVRFreeCamera"}resetToCurrentRotation(){this._vrDevice.resetPose()}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];e.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion),t.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion),e.position.copyFrom(this._deviceRoomPosition),t.position.copyFrom(this._deviceRoomPosition)}_correctPositionIfNotTrackPosition(e,t=!1){this.rawPose&&this.rawPose.position&&!this._webVROptions.trackPosition&&(F.TranslationToRef(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2],this._tmpMatrix),t||this._tmpMatrix.invert(),this._tmpMatrix.multiplyToRef(e,e))}_updateCache(e){(!this.rotationQuaternion.equals(this._cache.rotationQuaternion)||!this.position.equals(this._cache.position))&&(this._updateCacheCalled||(this._updateCacheCalled=!0,this.update()),this.rotationQuaternion.toRotationMatrix(this._workingMatrix),v.TransformCoordinatesToRef(this._deviceRoomPosition,this._workingMatrix,this._workingVector),this.devicePosition.subtractToRef(this._workingVector,this._workingVector),F.ComposeToRef(this._oneVector,this.rotationQuaternion,this._workingVector,this._deviceToWorld),this._deviceToWorld.getTranslationToRef(this._workingVector),this._workingVector.addInPlace(this.position),this._workingVector.subtractInPlace(this._cache.position),this._deviceToWorld.setTranslation(this._workingVector),this._deviceToWorld.invertToRef(this._worldToDevice),this.controllers.forEach(t=>{t._deviceToWorld.copyFrom(this._deviceToWorld),this._correctPositionIfNotTrackPosition(t._deviceToWorld),t.update()})),e||super._updateCache(),this._updateCacheCalled=!1}_computeDevicePosition(){v.TransformCoordinatesToRef(this._deviceRoomPosition,this._deviceToWorld,this.devicePosition)}update(){this._computeDevicePosition(),F.FromQuaternionToRef(this._deviceRoomRotationQuaternion,this._workingMatrix),this._workingMatrix.multiplyToRef(this._deviceToWorld,this._workingMatrix),Z.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion),this._poseSet&&this.onPoseUpdatedFromDeviceObservable.notifyObservers(null),super.update()}_getViewMatrix(){return F.Identity()}_getWebVRViewMatrix(){const e=this._cameraRigParams.parentCamera;return e._updateCache(),F.FromArrayToRef(this._cameraRigParams.left?this._cameraRigParams.frameData.leftViewMatrix:this._cameraRigParams.frameData.rightViewMatrix,0,this._webvrViewMatrix),this.getScene().useRightHandedSystem||this._webvrViewMatrix.toggleModelMatrixHandInPlace(),this._webvrViewMatrix.getRotationMatrixToRef(this._cameraRotationMatrix),v.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),1!==e.deviceScaleFactor&&(this._webvrViewMatrix.invert(),e.deviceScaleFactor&&(this._webvrViewMatrix.multiplyAtIndex(12,e.deviceScaleFactor),this._webvrViewMatrix.multiplyAtIndex(13,e.deviceScaleFactor),this._webvrViewMatrix.multiplyAtIndex(14,e.deviceScaleFactor)),this._webvrViewMatrix.invert()),e._correctPositionIfNotTrackPosition(this._webvrViewMatrix,!0),e._worldToDevice.multiplyToRef(this._webvrViewMatrix,this._webvrViewMatrix),this._workingMatrix=this._workingMatrix||F.Identity(),this._webvrViewMatrix.invertToRef(this._workingMatrix),this._workingMatrix.multiplyToRef(e.getWorldMatrix(),this._workingMatrix),this._workingMatrix.getTranslationToRef(this._globalPosition),this._markSyncedWithParent(),this._webvrViewMatrix}_getWebVRProjectionMatrix(){const e=this.parent;return e._vrDevice.depthNear=e.minZ,e._vrDevice.depthFar=e.maxZ,F.FromArrayToRef(this._cameraRigParams.left?this._cameraRigParams.frameData.leftProjectionMatrix:this._cameraRigParams.frameData.rightProjectionMatrix,0,this._projectionMatrix),this.getScene().useRightHandedSystem||this._projectionMatrix.toggleProjectionMatrixHandInPlace(),this._projectionMatrix}initControllers(){this.controllers.length=0;const e=this.getScene().gamepadManager;this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{if(t.type===ar.POSE_ENABLED){const i=t;i.defaultModel&&i.defaultModel.setEnabled(!1),"right"===i.hand&&(this._rightController=null),"left"===i.hand&&(this._leftController=null);const s=this.controllers.indexOf(i);-1!==s&&this.controllers.splice(s,1)}}),this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{if(t.type===ar.POSE_ENABLED){const i=t;if(this._webVROptions.trackPosition||(i._disableTrackPosition(new v("left"==i.hand?-.15:.15,-.5,.25)),this._updateCacheWhenTrackingDisabledObserver||(this._updateCacheWhenTrackingDisabledObserver=this._scene.onBeforeRenderObservable.add(()=>{this._updateCache()}))),i.deviceScaleFactor=this.deviceScaleFactor,i._deviceToWorld.copyFrom(this._deviceToWorld),this._correctPositionIfNotTrackPosition(i._deviceToWorld),this._webVROptions.controllerMeshes&&(i.defaultModel?i.defaultModel.setEnabled(!0):i.initControllerMesh(this.getScene(),s=>{if(s.scaling.scaleInPlace(this.deviceScaleFactor),this.onControllerMeshLoadedObservable.notifyObservers(i),this._webVROptions.defaultLightingOnControllers){this._lightOnControllers||(this._lightOnControllers=new jn("vrControllersLight",new v(0,1,0),this.getScene()));const n=function(o,a){const l=o.getChildren();l&&0!==l.length&&l.forEach(c=>{a.includedOnlyMeshes.push(c),n(c,a)})};this._lightOnControllers.includedOnlyMeshes.push(s),n(s,this._lightOnControllers)}})),i.attachToPoseControlledCamera(this),-1===this.controllers.indexOf(i)){this.controllers.push(i);let s=!1;for(let n=0;n<this.controllers.length;n++)this.controllers[n].controllerType===Ho.VIVE&&(s?this.controllers[n].hand="right":(s=!0,this.controllers[n].hand="left"));this.controllers.length>=2&&this.onControllersAttachedObservable.notifyObservers(this.controllers)}}})}}class ph extends Sv{onButtonStateChange(e){this._onButtonStateChange=e}get defaultModel(){return this._defaultModel}constructor(e){super(e),this.onTriggerStateChangedObservable=new z,this.onMainButtonStateChangedObservable=new z,this.onSecondaryButtonStateChangedObservable=new z,this.onPadStateChangedObservable=new z,this.onPadValuesChangedObservable=new z,this.pad={x:0,y:0},this._changes={pressChanged:!1,touchChanged:!1,valueChanged:!1,changed:!1},this._buttons=new Array(e.buttons.length),this.hand=e.hand}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._setButtonValue(this.browserGamepad.buttons[e],this._buttons[e],e);(this.leftStick.x!==this.pad.x||this.leftStick.y!==this.pad.y)&&(this.pad.x=this.leftStick.x,this.pad.y=this.leftStick.y,this.onPadValuesChangedObservable.notifyObservers(this.pad))}_setButtonValue(e,t,i){e||(e={pressed:!1,touched:!1,value:0}),t?(this._checkChanges(e,t),this._changes.changed&&(this._onButtonStateChange&&this._onButtonStateChange(this.index,i,e),this._handleButtonChange(i,e,this._changes)),this._buttons[i].pressed=e.pressed,this._buttons[i].touched=e.touched,this._buttons[i].value=e.value<1e-8?0:e.value):this._buttons[i]={pressed:e.pressed,touched:e.touched,value:e.value}}_checkChanges(e,t){return this._changes.pressChanged=e.pressed!==t.pressed,this._changes.touchChanged=e.touched!==t.touched,this._changes.valueChanged=e.value!==t.value,this._changes.changed=this._changes.pressChanged||this._changes.touchChanged||this._changes.valueChanged,this._changes}dispose(){super.dispose(),this._defaultModel=null,this.onTriggerStateChangedObservable.clear(),this.onMainButtonStateChangedObservable.clear(),this.onSecondaryButtonStateChangedObservable.clear(),this.onPadStateChangedObservable.clear(),this.onPadValuesChangedObservable.clear()}}class $u{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,i,s,n){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&-1!==t.prePassRenderer.getIndex(2)){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=s.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());const o=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=o.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==o.frameId&&(this._lastUpdateFrameId=o.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=s.clone()}}}let pe=(()=>{class r{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(t){this._DiffuseTextureEnabled!==t&&(this._DiffuseTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(t){this._DetailTextureEnabled!==t&&(this._DetailTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(t){this._DecalMapEnabled!==t&&(this._DecalMapEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(t){this._AmbientTextureEnabled!==t&&(this._AmbientTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(t){this._OpacityTextureEnabled!==t&&(this._OpacityTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(t){this._ReflectionTextureEnabled!==t&&(this._ReflectionTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(t){this._EmissiveTextureEnabled!==t&&(this._EmissiveTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(t){this._SpecularTextureEnabled!==t&&(this._SpecularTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(t){this._BumpTextureEnabled!==t&&(this._BumpTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(t){this._LightmapTextureEnabled!==t&&(this._LightmapTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(t){this._RefractionTextureEnabled!==t&&(this._RefractionTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(t){this._ColorGradingTextureEnabled!==t&&(this._ColorGradingTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(t){this._FresnelEnabled!==t&&(this._FresnelEnabled=t,ee.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(t){this._ClearCoatTextureEnabled!==t&&(this._ClearCoatTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(t){this._ClearCoatBumpTextureEnabled!==t&&(this._ClearCoatBumpTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(t){this._ClearCoatTintTextureEnabled!==t&&(this._ClearCoatTintTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(t){this._SheenTextureEnabled!==t&&(this._SheenTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(t){this._AnisotropicTextureEnabled!==t&&(this._AnisotropicTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(t){this._ThicknessTextureEnabled!==t&&(this._ThicknessTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(t){this._RefractionIntensityTextureEnabled!==t&&(this._RefractionIntensityTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set TranslucencyIntensityTextureEnabled(t){this._TranslucencyIntensityTextureEnabled!==t&&(this._TranslucencyIntensityTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(t){this._IridescenceTextureEnabled!==t&&(this._IridescenceTextureEnabled=t,ee.MarkAllMaterialsAsDirty(1))}}return r._DiffuseTextureEnabled=!0,r._DetailTextureEnabled=!0,r._DecalMapEnabled=!0,r._AmbientTextureEnabled=!0,r._OpacityTextureEnabled=!0,r._ReflectionTextureEnabled=!0,r._EmissiveTextureEnabled=!0,r._SpecularTextureEnabled=!0,r._BumpTextureEnabled=!0,r._LightmapTextureEnabled=!0,r._RefractionTextureEnabled=!0,r._ColorGradingTextureEnabled=!0,r._FresnelEnabled=!0,r._ClearCoatTextureEnabled=!0,r._ClearCoatBumpTextureEnabled=!0,r._ClearCoatTintTextureEnabled=!0,r._SheenTextureEnabled=!0,r._AnisotropicTextureEnabled=!0,r._ThicknessTextureEnabled=!0,r._RefractionIntensityTextureEnabled=!0,r._TranslucencyIntensityTextureEnabled=!0,r._IridescenceTextureEnabled=!0,r})();j.IncludesShadersStore.decalFragmentDeclaration="#ifdef DECAL\nuniform vec4 vDecalInfos;\n#endif\n";j.IncludesShadersStore.defaultFragmentDeclaration="uniform vec4 vEyePosition;\nuniform vec4 vDiffuseColor;\n#ifdef SPECULARTERM\nuniform vec4 vSpecularColor;\n#endif\nuniform vec3 vEmissiveColor;\nuniform vec3 vAmbientColor;\nuniform float visibility;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#ifdef ALPHATEST\nuniform float alphaCutOff;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifndef REFRACTIONMAP_3D\nuniform mat4 refractionMatrix;\n#endif\n#ifdef REFRACTIONFRESNEL\nuniform vec4 refractionLeftColor;\nuniform vec4 refractionRightColor;\n#endif\n#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)\nuniform vec3 vRefractionPosition;\nuniform vec3 vRefractionSize; \n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\n#endif\n#ifdef DIFFUSEFRESNEL\nuniform vec4 diffuseLeftColor;\nuniform vec4 diffuseRightColor;\n#endif\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;\nuniform vec4 emissiveRightColor;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)\nuniform mat4 reflectionMatrix;\n#endif\n#ifndef REFLECTIONMAP_SKYBOX\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize; \n#endif\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 reflectionLeftColor;\nuniform vec4 reflectionRightColor;\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#include<decalFragmentDeclaration>\n#define ADDITIONAL_FRAGMENT_DECLARATION\n";j.IncludesShadersStore.sceneUboDeclaration="layout(std140,column_major) uniform;\nuniform Scene {\nmat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif \nmat4 view;\nmat4 projection;\nvec4 vEyePosition;\n};\n";j.IncludesShadersStore.meshUboDeclaration="#ifdef WEBGL2\nuniform mat4 world;\nuniform float visibility;\n#else\nlayout(std140,column_major) uniform;\nuniform Mesh\n{\nmat4 world;\nfloat visibility;\n};\n#endif\n#define WORLD_UBO\n";j.IncludesShadersStore.defaultUboDeclaration="layout(std140,column_major) uniform;\nuniform Material\n{\nvec4 diffuseLeftColor;\nvec4 diffuseRightColor;\nvec4 opacityParts;\nvec4 reflectionLeftColor;\nvec4 reflectionRightColor;\nvec4 refractionLeftColor;\nvec4 refractionRightColor;\nvec4 emissiveLeftColor;\nvec4 emissiveRightColor;\nvec2 vDiffuseInfos;\nvec2 vAmbientInfos;\nvec2 vOpacityInfos;\nvec2 vReflectionInfos;\nvec3 vReflectionPosition;\nvec3 vReflectionSize;\nvec2 vEmissiveInfos;\nvec2 vLightmapInfos;\nvec2 vSpecularInfos;\nvec3 vBumpInfos;\nmat4 diffuseMatrix;\nmat4 ambientMatrix;\nmat4 opacityMatrix;\nmat4 reflectionMatrix;\nmat4 emissiveMatrix;\nmat4 lightmapMatrix;\nmat4 specularMatrix;\nmat4 bumpMatrix;\nvec2 vTangentSpaceParams;\nfloat pointSize;\nfloat alphaCutOff;\nmat4 refractionMatrix;\nvec4 vRefractionInfos;\nvec3 vRefractionPosition;\nvec3 vRefractionSize;\nvec4 vSpecularColor;\nvec3 vEmissiveColor;\nvec4 vDiffuseColor;\nvec3 vAmbientColor;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";j.IncludesShadersStore.prePassDeclaration="#ifdef PREPASS\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;\n#ifdef PREPASS_DEPTH\nvarying highp vec3 vViewPos;\n#endif\n#ifdef PREPASS_VELOCITY\nvarying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;\n#endif\n#endif\n";j.IncludesShadersStore.oitDeclaration="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out vec2 depth; \nlayout(location=1) out vec4 frontColor;\nlayout(location=2) out vec4 backColor;\n#define MAX_DEPTH 99999.0\nhighp vec4 gl_FragColor;\nuniform sampler2D oitDepthSampler;\nuniform sampler2D oitFrontColorSampler;\n#endif\n";j.IncludesShadersStore.mainUVVaryingDeclaration="#ifdef MAINUV{X}\nvarying vec2 vMainUV{X};\n#endif\n";j.IncludesShadersStore.helperFunctions="const float PI=3.1415926535897932384626433832795;\nconst float HALF_MIN=5.96046448e-08; \nconst float LinearEncodePowerApprox=2.2;\nconst float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;\nconst vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);\nconst float Epsilon=0.0000001;\n#define saturate(x) clamp(x,0.0,1.0)\n#define absEps(x) abs(x)+Epsilon\n#define maxEps(x) max(x,Epsilon)\n#define saturateEps(x) clamp(x,Epsilon,1.0)\nmat3 transposeMat3(mat3 inMatrix) {\nvec3 i0=inMatrix[0];\nvec3 i1=inMatrix[1];\nvec3 i2=inMatrix[2];\nmat3 outMatrix=mat3(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);\nreturn outMatrix;\n}\nmat3 inverseMat3(mat3 inMatrix) {\nfloat a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];\nfloat a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];\nfloat a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];\nfloat b01=a22*a11-a12*a21;\nfloat b11=-a22*a10+a12*a20;\nfloat b21=a21*a10-a11*a20;\nfloat det=a00*b01+a01*b11+a02*b21;\nreturn mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),\nb11,(a22*a00-a02*a20),(-a12*a00+a02*a10),\nb21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;\n}\n#if USE_EXACT_SRGB_CONVERSIONS\nvec3 toLinearSpaceExact(vec3 color)\n{\nvec3 nearZeroSection=0.0773993808*color;\nvec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));\n#else\nreturn\nvec3(\ncolor.r<=0.04045 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.04045 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.04045 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\nvec3 toGammaSpaceExact(vec3 color)\n{\nvec3 nearZeroSection=12.92*color;\nvec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));\n#else\nreturn\nvec3(\ncolor.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\n#endif\nfloat toLinearSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=0.0773993808*color;\nfloat remainingSection=pow(0.947867299*(color+0.055),2.4);\nreturn color<=0.04045 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,LinearEncodePowerApprox);\n#endif\n}\nvec3 toLinearSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toLinearSpaceExact(color);\n#else\nreturn pow(color,vec3(LinearEncodePowerApprox));\n#endif\n}\nvec4 toLinearSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toLinearSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);\n#endif\n}\nfloat toGammaSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=12.92*color;\nfloat remainingSection=1.055*pow(color,0.41666)-0.055;\nreturn color<=0.0031308 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,GammaEncodePowerApprox);\n#endif\n}\nvec3 toGammaSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toGammaSpaceExact(color);\n#else\nreturn pow(color,vec3(GammaEncodePowerApprox));\n#endif\n}\nvec4 toGammaSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toGammaSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);\n#endif\n}\nfloat square(float value)\n{\nreturn value*value;\n}\nvec3 square(vec3 value)\n{\nreturn value*value;\n}\nfloat pow5(float value) {\nfloat sq=value*value;\nreturn sq*sq*value;\n}\nfloat getLuminance(vec3 color)\n{\nreturn clamp(dot(color,LuminanceEncodeApprox),0.,1.);\n}\nfloat getRand(vec2 seed) {\nreturn fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);\n}\nfloat dither(vec2 seed,float varianceAmount) {\nfloat rand=getRand(seed);\nfloat normVariance=varianceAmount/255.0;\nfloat dither=mix(-normVariance,normVariance,rand);\nreturn dither;\n}\nconst float rgbdMaxRange=255.0;\nvec4 toRGBD(vec3 color) {\nfloat maxRGB=maxEps(max(color.r,max(color.g,color.b)));\nfloat D =max(rgbdMaxRange/maxRGB,1.);\nD =clamp(floor(D)/255.0,0.,1.);\nvec3 rgb=color.rgb*D;\nrgb=toGammaSpace(rgb);\nreturn vec4(clamp(rgb,0.,1.),D); \n}\nvec3 fromRGBD(vec4 rgbd) {\nrgbd.rgb=toLinearSpace(rgbd.rgb);\nreturn rgbd.rgb/rgbd.a;\n}\nvec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {\nvec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;\nvec3 halfSize=cubeSize*0.5;\nvec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;\nvec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;\nvec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);\nfloat distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);\nvec3 intersectPositionWS=vertexPos+origVec*distance;\nreturn intersectPositionWS-cubePos;\n}\n";j.IncludesShadersStore.lightFragmentDeclaration="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};\nuniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float cascadeBlendFactor{X};\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\nuniform highp sampler2DArray depthSampler{X};\nuniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\n#else\nuniform highp sampler2DArray shadowSampler{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);\nvec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X};\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};\nuniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};\nuniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};\nuniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};\nuniform sampler2D projectionLightSampler{X};\n#endif\n#endif\n";j.IncludesShadersStore.lightUboDeclaration="#ifdef LIGHT{X}\nuniform Light{X}\n{\nvec4 vLightData;\nvec4 vLightDiffuse;\nvec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;\nvec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;\nvec2 depthValues;\n} light{X};\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};\nuniform sampler2D projectionLightSampler{X};\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float cascadeBlendFactor{X};\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\nuniform highp sampler2DArray depthSampler{X};\nuniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\n#else\nuniform highp sampler2DArray shadowSampler{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);\nvec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X}; \n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};\nuniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n";j.IncludesShadersStore.lightsFragmentFunctions="struct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef NDOTL\nfloat ndl;\n#endif\n};\nlightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 lightVectorW;\nfloat attenuation=1.0;\nif (lightData.w==0.)\n{\nvec3 direction=lightData.xyz-vPositionW;\nattenuation=max(0.,1.0-length(direction)/range);\nlightVectorW=normalize(direction);\n}\nelse\n{\nlightVectorW=normalize(-lightData.xyz);\n}\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 direction=lightData.xyz-vPositionW;\nvec3 lightVectorW=normalize(direction);\nfloat attenuation=max(0.,1.0-length(direction)/range);\nfloat cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));\nif (cosAngle>=lightDirection.w)\n{\ncosAngle=max(0.,pow(cosAngle,lightData.w));\nattenuation*=cosAngle;\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nresult.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;\n}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {\nlightingInfo result;\nfloat ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor;\n#endif\nreturn result;\n}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){\nvec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);\nstrq/=strq.w;\nvec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;\nreturn textureColor;\n}";j.IncludesShadersStore.shadowsFragmentFunctions="#ifdef SHADOWS\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\n#ifndef SHADOWFLOAT\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}\n#endif\nfloat computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)\n{\nfloat mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));\nreturn mix(value,1.0,mask);\n}\n#define inline\nfloat computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x;\n#endif\nreturn depth>shadow ? darkness : 1.0;\n}\n#define inline\nfloat computeShadowWithPoissonSamplingCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\nfloat visibility=1.;\nvec3 poissonDisk[4];\npoissonDisk[0]=vec3(-1.0,1.0,-1.0);\npoissonDisk[1]=vec3(1.0,-1.0,-1.0);\npoissonDisk[2]=vec3(-1.0,-1.0,-1.0);\npoissonDisk[3]=vec3(1.0,-1.0,1.0);\n#ifndef SHADOWFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);\n}\n#define inline\nfloat computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); \nreturn esm;\n}\n#define inline\nfloat computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn esm;\n}\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define inline\nfloat computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nvec3 uvLayer=vec3(uv.x,uv.y,layer);\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uvLayer));\n#else\nfloat shadow=texture2D(shadowSampler,uvLayer).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;\n}\n#endif\n#define inline\nfloat computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;\n}\n}\n#define inline\nfloat computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\nfloat visibility=1.;\nvec2 poissonDisk[4];\npoissonDisk[0]=vec2(-0.94201624,-0.39906216);\npoissonDisk[1]=vec2(0.94558609,-0.76890725);\npoissonDisk[2]=vec2(-0.094184101,-0.92938870);\npoissonDisk[3]=vec2(0.34495938,0.29387760);\n#ifndef SHADOWFLOAT\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\n#else\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#ifdef IS_NDC_HALF_ZRANGE\n#define ZINCLIP clipSpace.z\n#else\n#define ZINCLIP uvDepth.z\n#endif\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define GREATEST_LESS_THAN_ONE 0.99999994\n#define inline\nfloat computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);\nfloat shadow=texture2D(shadowSampler,uvDepthLayer);\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n#define inline\nfloat computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;\nvec2 uvw1=1.+2.*st;\nvec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;\nvec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));\nshadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));\nshadow=shadow/16.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n#define inline\nfloat computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;\nvec2 uvw1=vec2(7.);\nvec2 uvw2=1.+3.*st;\nvec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;\nvec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));\nshadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));\nshadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));\nshadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));\nshadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));\nshadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));\nshadow=shadow/144.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n#define inline\nfloat computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nfloat shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;\nvec2 uvw1=1.+2.*st;\nvec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;\nvec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);\nshadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);\nshadow=shadow/16.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;\nvec2 uvw1=vec2(7.);\nvec2 uvw2=1.+3.*st;\nvec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;\nvec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);\nshadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);\nshadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);\nshadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);\nshadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);\nshadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);\nshadow=shadow/144.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\nconst vec3 PoissonSamplers32[64]=vec3[64](\nvec3(0.06407013,0.05409927,0.),\nvec3(0.7366577,0.5789394,0.),\nvec3(-0.6270542,-0.5320278,0.),\nvec3(-0.4096107,0.8411095,0.),\nvec3(0.6849564,-0.4990818,0.),\nvec3(-0.874181,-0.04579735,0.),\nvec3(0.9989998,0.0009880066,0.),\nvec3(-0.004920578,-0.9151649,0.),\nvec3(0.1805763,0.9747483,0.),\nvec3(-0.2138451,0.2635818,0.),\nvec3(0.109845,0.3884785,0.),\nvec3(0.06876755,-0.3581074,0.),\nvec3(0.374073,-0.7661266,0.),\nvec3(0.3079132,-0.1216763,0.),\nvec3(-0.3794335,-0.8271583,0.),\nvec3(-0.203878,-0.07715034,0.),\nvec3(0.5912697,0.1469799,0.),\nvec3(-0.88069,0.3031784,0.),\nvec3(0.5040108,0.8283722,0.),\nvec3(-0.5844124,0.5494877,0.),\nvec3(0.6017799,-0.1726654,0.),\nvec3(-0.5554981,0.1559997,0.),\nvec3(-0.3016369,-0.3900928,0.),\nvec3(-0.5550632,-0.1723762,0.),\nvec3(0.925029,0.2995041,0.),\nvec3(-0.2473137,0.5538505,0.),\nvec3(0.9183037,-0.2862392,0.),\nvec3(0.2469421,0.6718712,0.),\nvec3(0.3916397,-0.4328209,0.),\nvec3(-0.03576927,-0.6220032,0.),\nvec3(-0.04661255,0.7995201,0.),\nvec3(0.4402924,0.3640312,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.)\n);\nconst vec3 PoissonSamplers64[64]=vec3[64](\nvec3(-0.613392,0.617481,0.),\nvec3(0.170019,-0.040254,0.),\nvec3(-0.299417,0.791925,0.),\nvec3(0.645680,0.493210,0.),\nvec3(-0.651784,0.717887,0.),\nvec3(0.421003,0.027070,0.),\nvec3(-0.817194,-0.271096,0.),\nvec3(-0.705374,-0.668203,0.),\nvec3(0.977050,-0.108615,0.),\nvec3(0.063326,0.142369,0.),\nvec3(0.203528,0.214331,0.),\nvec3(-0.667531,0.326090,0.),\nvec3(-0.098422,-0.295755,0.),\nvec3(-0.885922,0.215369,0.),\nvec3(0.566637,0.605213,0.),\nvec3(0.039766,-0.396100,0.),\nvec3(0.751946,0.453352,0.),\nvec3(0.078707,-0.715323,0.),\nvec3(-0.075838,-0.529344,0.),\nvec3(0.724479,-0.580798,0.),\nvec3(0.222999,-0.215125,0.),\nvec3(-0.467574,-0.405438,0.),\nvec3(-0.248268,-0.814753,0.),\nvec3(0.354411,-0.887570,0.),\nvec3(0.175817,0.382366,0.),\nvec3(0.487472,-0.063082,0.),\nvec3(-0.084078,0.898312,0.),\nvec3(0.488876,-0.783441,0.),\nvec3(0.470016,0.217933,0.),\nvec3(-0.696890,-0.549791,0.),\nvec3(-0.149693,0.605762,0.),\nvec3(0.034211,0.979980,0.),\nvec3(0.503098,-0.308878,0.),\nvec3(-0.016205,-0.872921,0.),\nvec3(0.385784,-0.393902,0.),\nvec3(-0.146886,-0.859249,0.),\nvec3(0.643361,0.164098,0.),\nvec3(0.634388,-0.049471,0.),\nvec3(-0.688894,0.007843,0.),\nvec3(0.464034,-0.188818,0.),\nvec3(-0.440840,0.137486,0.),\nvec3(0.364483,0.511704,0.),\nvec3(0.034028,0.325968,0.),\nvec3(0.099094,-0.308023,0.),\nvec3(0.693960,-0.366253,0.),\nvec3(0.678884,-0.204688,0.),\nvec3(0.001801,0.780328,0.),\nvec3(0.145177,-0.898984,0.),\nvec3(0.062655,-0.611866,0.),\nvec3(0.315226,-0.604297,0.),\nvec3(-0.780145,0.486251,0.),\nvec3(-0.371868,0.882138,0.),\nvec3(0.200476,0.494430,0.),\nvec3(-0.494552,-0.711051,0.),\nvec3(0.612476,0.705252,0.),\nvec3(-0.578845,-0.768792,0.),\nvec3(-0.772454,-0.090976,0.),\nvec3(0.504440,0.372295,0.),\nvec3(0.155736,0.065157,0.),\nvec3(0.391522,0.849605,0.),\nvec3(-0.620106,-0.328104,0.),\nvec3(0.789239,-0.419965,0.),\nvec3(-0.545396,0.538133,0.),\nvec3(-0.178564,-0.596057,0.)\n);\n#define inline\nfloat computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);\nfloat blockerDepth=0.0;\nfloat sumBlockerDepth=0.0;\nfloat numBlocker=0.0;\nfor (int i=0; i<searchTapCount; i ++) {\nblockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;\nif (blockerDepth<depthMetric) {\nsumBlockerDepth+=blockerDepth;\nnumBlocker++;\n}\n}\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;\nfloat AAOffset=shadowMapSizeInverse*10.;\nfloat penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);\nvec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);\nfloat random=getRand(vPositionFromLight.xy);\nfloat rotationAngle=random*3.1415926;\nvec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));\nfloat shadow=0.;\nfor (int i=0; i<pcfTapCount; i++) {\nvec4 offset=vec4(poissonSamplers[i],0.);\noffset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);\nshadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);\n}\nshadow/=float(pcfTapCount);\nshadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));\nshadow=mix(darkness,1.,shadow);\nif (numBlocker<1.0) {\nreturn 1.0;\n}\nelse\n{\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nfloat blockerDepth=0.0;\nfloat sumBlockerDepth=0.0;\nfloat numBlocker=0.0;\nfor (int i=0; i<searchTapCount; i ++) {\nblockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;\nif (blockerDepth<depthMetric) {\nsumBlockerDepth+=blockerDepth;\nnumBlocker++;\n}\n}\nif (numBlocker<1.0) {\nreturn 1.0;\n}\nelse\n{\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;\nfloat AAOffset=shadowMapSizeInverse*10.;\nfloat penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);\nfloat filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;\nfloat random=getRand(vPositionFromLight.xy);\nfloat rotationAngle=random*3.1415926;\nvec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));\nfloat shadow=0.;\nfor (int i=0; i<pcfTapCount; i++) {\nvec3 offset=poissonSamplers[i];\noffset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);\nshadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);\n}\nshadow/=float(pcfTapCount);\nshadow=mix(shadow,1.,depthMetric-avgBlockerDepth);\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n}\n#define inline\nfloat computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);\n}\n#define inline\nfloat computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);\n}\n#define inline\nfloat computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);\n}\n#define inline\nfloat computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nreturn computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);\n}\n#define inline\nfloat computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nreturn computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);\n}\n#define inline\nfloat computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nreturn computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);\n}\n#endif\n#endif\n";j.IncludesShadersStore.samplerFragmentDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\nuniform sampler2D _SAMPLERNAME_Sampler;\n#endif\n";j.IncludesShadersStore.fresnelFunction="#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{\nfloat fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);\nreturn clamp(fresnelTerm,0.,1.);\n}\n#endif\n";j.IncludesShadersStore.reflectionFunction="vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{\nfloat lon=atan(direction.z,direction.x);\nfloat lat=acos(direction.y);\nvec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;\nfloat s=sphereCoords.x*0.5+0.5;\nfloat t=sphereCoords.y;\nreturn vec3(s,t,0); \n}\nvec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{\nfloat lon=atan(direction.z,direction.x);\nfloat lat=acos(direction.y);\nvec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;\nfloat s=sphereCoords.x*0.5+0.5;\nfloat t=sphereCoords.y;\nreturn vec3(1.0-s,t,0); \n}\nvec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{\nvec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);\nvec3 r=normalize(reflect(cameraToVertex,worldNormal));\nr=vec3(reflectionMatrix*vec4(r,0));\nfloat lon=atan(r.z,r.x);\nfloat lat=acos(r.y);\nvec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;\nfloat s=sphereCoords.x*0.5+0.5;\nfloat t=sphereCoords.y;\nreturn vec3(s,t,0);\n}\nvec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)\n{\nvec3 viewDir=normalize(vec3(view*worldPos));\nvec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));\nvec3 r=reflect(viewDir,viewNormal);\nr=vec3(reflectionMatrix*vec4(r,0));\nr.z=r.z-1.0;\nfloat m=2.0*length(r);\nreturn vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);\n}\nvec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{\nvec3 viewDir=worldPos.xyz-eyePosition;\nvec3 coords=normalize(reflect(viewDir,worldNormal));\nreturn vec3(reflectionMatrix*vec4(coords,1));\n}\nvec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{\nvec3 viewDir=normalize(worldPos.xyz-eyePosition);\nvec3 coords=reflect(viewDir,worldNormal);\ncoords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;\n}\nvec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)\n{\nvec3 viewDir=normalize(worldPos.xyz-eyePosition);\nvec3 coords=reflect(viewDir,worldNormal);\ncoords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);\ncoords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;\n}\nvec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)\n{\nreturn vec3(reflectionMatrix*(view*worldPos));\n}\nvec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)\n{\nreturn vec3(reflectionMatrix*vec4(positionW,1.));\n}\n#ifdef REFLECTION\nvec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)\n{\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);\nreturn computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);\nreturn computeFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nreturn computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nreturn computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nreturn computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_CUBIC\n#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\nreturn computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);\n#else\nreturn computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn computeProjectionCoords(worldPos,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nreturn computeSkyBoxCoords(vPositionUVW,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3(0,0,0);\n#endif\n}\n#endif\n";j.IncludesShadersStore.imageProcessingDeclaration="#ifdef EXPOSURE\nuniform float exposureLinear;\n#endif\n#ifdef CONTRAST\nuniform float contrast;\n#endif\n#if defined(VIGNETTE) || defined(DITHER)\nuniform vec2 vInverseScreenSize;\n#endif\n#ifdef VIGNETTE\nuniform vec4 vignetteSettings1;\nuniform vec4 vignetteSettings2;\n#endif\n#ifdef COLORCURVES\nuniform vec4 vCameraColorCurveNegative;\nuniform vec4 vCameraColorCurveNeutral;\nuniform vec4 vCameraColorCurvePositive;\n#endif\n#ifdef COLORGRADING\n#ifdef COLORGRADING3D\nuniform highp sampler3D txColorTransform;\n#else\nuniform sampler2D txColorTransform;\n#endif\nuniform vec4 colorTransformSettings;\n#endif\n#ifdef DITHER\nuniform float ditherIntensity;\n#endif\n";j.IncludesShadersStore.imageProcessingFunctions="#if defined(COLORGRADING) && !defined(COLORGRADING3D)\n/** \n* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.\n* sampler3dSetting.x=textureOffset (0.5/textureSize).\n* sampler3dSetting.y=textureSize.\n*/\n#define inline\nvec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)\n{\nfloat sliceSize=2.0*sampler3dSetting.x; \n#ifdef SAMPLER3DGREENDEPTH\nfloat sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;\n#else\nfloat sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;\n#endif\nfloat sliceInteger=floor(sliceContinuous);\nfloat sliceFraction=sliceContinuous-sliceInteger;\n#ifdef SAMPLER3DGREENDEPTH\nvec2 sliceUV=color.rb;\n#else\nvec2 sliceUV=color.rg;\n#endif\nsliceUV.x*=sliceSize;\nsliceUV.x+=sliceInteger*sliceSize;\nsliceUV=saturate(sliceUV);\nvec4 slice0Color=texture2D(colorTransform,sliceUV);\nsliceUV.x+=sliceSize;\nsliceUV=saturate(sliceUV);\nvec4 slice1Color=texture2D(colorTransform,sliceUV);\nvec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);\n#ifdef SAMPLER3DBGRMAP\ncolor.rgb=result.rgb;\n#else\ncolor.rgb=result.bgr;\n#endif\nreturn color;\n}\n#endif\n#ifdef TONEMAPPING_ACES\nconst mat3 ACESInputMat=mat3(\nvec3(0.59719,0.07600,0.02840),\nvec3(0.35458,0.90834,0.13383),\nvec3(0.04823,0.01566,0.83777)\n);\nconst mat3 ACESOutputMat=mat3(\nvec3( 1.60475,-0.10208,-0.00327),\nvec3(-0.53108, 1.10813,-0.07276),\nvec3(-0.07367,-0.00605, 1.07602)\n);\nvec3 RRTAndODTFit(vec3 v)\n{\nvec3 a=v*(v+0.0245786)-0.000090537;\nvec3 b=v*(0.983729*v+0.4329510)+0.238081;\nreturn a/b;\n}\nvec3 ACESFitted(vec3 color)\n{\ncolor=ACESInputMat*color;\ncolor=RRTAndODTFit(color);\ncolor=ACESOutputMat*color;\ncolor=saturate(color);\nreturn color;\n}\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS\nvec4 applyImageProcessing(vec4 result) {\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART\n#ifdef EXPOSURE\nresult.rgb*=exposureLinear;\n#endif\n#ifdef VIGNETTE\nvec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;\nviewportXY=viewportXY*2.0-1.0;\nvec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);\nfloat vignetteTerm=dot(vignetteXY1,vignetteXY1);\nfloat vignette=pow(vignetteTerm,vignetteSettings2.w);\nvec3 vignetteColor=vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);\nresult.rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nresult.rgb=mix(vignetteColor,result.rgb,vignette);\n#endif\n#endif\n#ifdef TONEMAPPING\n#ifdef TONEMAPPING_ACES\nresult.rgb=ACESFitted(result.rgb);\n#else\nconst float tonemappingCalibration=1.590579;\nresult.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);\n#endif\n#endif\nresult.rgb=toGammaSpace(result.rgb);\nresult.rgb=saturate(result.rgb);\n#ifdef CONTRAST\nvec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);\nif (contrast<1.0) {\nresult.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);\n} else {\nresult.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);\n}\n#endif\n#ifdef COLORGRADING\nvec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;\n#ifdef COLORGRADING3D\nvec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;\n#else\nvec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;\n#endif\nresult.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\nfloat luma=getLuminance(result.rgb);\nvec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));\nvec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;\nresult.rgb*=colorCurve.rgb;\nresult.rgb=mix(vec3(luma),result.rgb,colorCurve.a);\n#endif\n#ifdef DITHER\nfloat rand=getRand(gl_FragCoord.xy*vInverseScreenSize);\nfloat dither=mix(-ditherIntensity,ditherIntensity,rand);\nresult.rgb=saturate(result.rgb+vec3(dither));\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND\nreturn result;\n}";j.IncludesShadersStore.bumpFragmentMainFunctions="#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform mat4 normalMatrix;\n#if defined(WEBGL2) || defined(WEBGPU)\nmat4 toNormalMatrix(mat4 wMatrix)\n{\nmat4 ret=inverse(wMatrix);\nret=transpose(ret);\nret[0][3]=0.;\nret[1][3]=0.;\nret[2][3]=0.;\nret[3]=vec4(0.,0.,0.,1.);\nreturn ret;\n}\n#else\nmat4 toNormalMatrix(mat4 m)\n{\nfloat\na00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],\na10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],\na20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],\na30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],\nb00=a00*a11-a01*a10,\nb01=a00*a12-a02*a10,\nb02=a00*a13-a03*a10,\nb03=a01*a12-a02*a11,\nb04=a01*a13-a03*a11,\nb05=a02*a13-a03*a12,\nb06=a20*a31-a21*a30,\nb07=a20*a32-a22*a30,\nb08=a20*a33-a23*a30,\nb09=a21*a32-a22*a31,\nb10=a21*a33-a23*a31,\nb11=a22*a33-a23*a32,\ndet=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;\nmat4 mi=mat4(\na11*b11-a12*b10+a13*b09,\na02*b10-a01*b11-a03*b09,\na31*b05-a32*b04+a33*b03,\na22*b04-a21*b05-a23*b03,\na12*b08-a10*b11-a13*b07,\na00*b11-a02*b08+a03*b07,\na32*b02-a30*b05-a33*b01,\na20*b05-a22*b02+a23*b01,\na10*b10-a11*b08+a13*b06,\na01*b08-a00*b10-a03*b06,\na30*b04-a31*b02+a33*b00,\na21*b02-a20*b04-a23*b00,\na11*b07-a10*b09-a12*b06,\na00*b09-a01*b07+a02*b06,\na31*b01-a30*b03-a32*b00,\na20*b03-a21*b01+a22*b00)/det;\nreturn mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],\nmi[0][1],mi[1][1],mi[2][1],mi[3][1],\nmi[0][2],mi[1][2],mi[2][2],mi[3][2],\nmi[0][3],mi[1][3],mi[2][3],mi[3][3]);\n}\n#endif\n#endif\nvec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)\n{\n#ifdef NORMALXYSCALE\nnormal=normalize(normal*vec3(scale,scale,1.0));\n#endif\nreturn normalize(cotangentFrame*normal);\n}\nvec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)\n{\nreturn perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);\n}\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)\n{\nvec3 dp1=dFdx(p);\nvec3 dp2=dFdy(p);\nvec2 duv1=dFdx(uv);\nvec2 duv2=dFdy(uv);\nvec3 dp2perp=cross(dp2,normal);\nvec3 dp1perp=cross(normal,dp1);\nvec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;\nvec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;\ntangent*=tangentSpaceParams.x;\nbitangent*=tangentSpaceParams.y;\nfloat det=max(dot(tangent,tangent),dot(bitangent,bitangent));\nfloat invmax=det==0.0 ? 0.0 : inversesqrt(det);\nreturn mat3(tangent*invmax,bitangent*invmax,normal);\n}\n#endif\n";j.IncludesShadersStore.bumpFragmentFunctions="#if defined(BUMP)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)\n#endif\n#if defined(DETAIL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)\n#endif\n#if defined(BUMP) && defined(PARALLAX)\nconst float minSamples=4.;\nconst float maxSamples=15.;\nconst int iMaxSamples=15;\nvec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {\nfloat parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;\nparallaxLimit*=parallaxScale;\nvec2 vOffsetDir=normalize(vViewDirCoT.xy);\nvec2 vMaxOffset=vOffsetDir*parallaxLimit;\nfloat numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));\nfloat stepSize=1.0/numSamples;\nfloat currRayHeight=1.0;\nvec2 vCurrOffset=vec2(0,0);\nvec2 vLastOffset=vec2(0,0);\nfloat lastSampledHeight=1.0;\nfloat currSampledHeight=1.0;\nbool keepWorking=true;\nfor (int i=0; i<iMaxSamples; i++)\n{\ncurrSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;\nif (!keepWorking)\n{\n}\nelse if (currSampledHeight>currRayHeight)\n{\nfloat delta1=currSampledHeight-currRayHeight;\nfloat delta2=(currRayHeight+stepSize)-lastSampledHeight;\nfloat ratio=delta1/(delta1+delta2);\nvCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;\nkeepWorking=false;\n}\nelse\n{\ncurrRayHeight-=stepSize;\nvLastOffset=vCurrOffset;\nvCurrOffset+=stepSize*vMaxOffset;\nlastSampledHeight=currSampledHeight;\n}\n}\nreturn vCurrOffset;\n}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{\nfloat height=texture2D(bumpSampler,vBumpUV).w;\nvec2 texCoordOffset=heightScale*viewDir.xy*height;\nreturn -texCoordOffset;\n}\n#endif\n";j.IncludesShadersStore.clipPlaneFragmentDeclaration="#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nvarying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nvarying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nvarying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nvarying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nvarying float fClipDistance6;\n#endif\n";j.IncludesShadersStore.logDepthDeclaration="#ifdef LOGARITHMICDEPTH\nuniform float logarithmicDepthConstant;\nvarying float vFragmentDepth;\n#endif\n";j.IncludesShadersStore.fogFragmentDeclaration="#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\n#define E 2.71828\nuniform vec4 vFogInfos;\nuniform vec3 vFogColor;\nvarying vec3 vFogDistance;\nfloat CalcFogFactor()\n{\nfloat fogCoeff=1.0;\nfloat fogStart=vFogInfos.y;\nfloat fogEnd=vFogInfos.z;\nfloat fogDensity=vFogInfos.w;\nfloat fogDistance=length(vFogDistance);\nif (FOGMODE_LINEAR==vFogInfos.x)\n{\nfogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);\n}\nelse if (FOGMODE_EXP==vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDensity);\n}\nelse if (FOGMODE_EXP2==vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);\n}\nreturn clamp(fogCoeff,0.0,1.0);\n}\n#endif\n";j.IncludesShadersStore.clipPlaneFragment="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fClipDistance>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE2\nelse if (fClipDistance2>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE3\nelse if (fClipDistance3>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE4\nelse if (fClipDistance4>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE5\nelse if (fClipDistance5>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE6\nelse if (fClipDistance6>0.0)\n{\ndiscard;\n}\n#endif\n";j.IncludesShadersStore.bumpFragment="vec2 uvOffset=vec2(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)\n#ifdef NORMALXYSCALE\nfloat normalScale=1.0;\n#elif defined(BUMP)\nfloat normalScale=vBumpInfos.y;\n#else\nfloat normalScale=1.0;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#elif defined(BUMP)\nvec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;\nmat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);\n#else\nvec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;\nmat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#elif defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#else\nvec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;\nmat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);\n#endif\n#endif\n#ifdef DETAIL\nvec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);\nvec2 detailNormalRG=detailColor.wy*2.0-1.0;\nfloat detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));\nvec3 detailNormal=vec3(detailNormalRG,detailNormalB);\n#endif\n#ifdef BUMP\n#ifdef OBJECTSPACE_NORMALMAP\n#define CUSTOM_FRAGMENT_BUMP_FRAGMENT\nnormalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);\nnormalW=normalize(mat3(normalMatrix)*normalW);\n#elif !defined(DETAIL)\nnormalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);\n#else\nvec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;\n#if DETAIL_NORMALBLENDMETHOD==0 \ndetailNormal.xy*=vDetailInfos.z;\nvec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));\n#elif DETAIL_NORMALBLENDMETHOD==1 \ndetailNormal.xy*=vDetailInfos.z;\nbumpNormal+=vec3(0.0,0.0,1.0);\ndetailNormal*=vec3(-1.0,-1.0,1.0);\nvec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;\n#endif\nnormalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);\n#endif\n#elif defined(DETAIL)\ndetailNormal.xy*=vDetailInfos.z;\nnormalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);\n#endif\n";j.IncludesShadersStore.decalFragment="#ifdef DECAL\n#ifdef GAMMADECAL\ndecalColor.rgb=toLinearSpace(decalColor.rgb);\n#endif\n#ifdef DECAL_SMOOTHALPHA\ndecalColor.a*=decalColor.a;\n#endif\nsurfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,decalColor.rgb,decalColor.a);\n#endif\n";j.IncludesShadersStore.depthPrePass="#ifdef DEPTHPREPASS\ngl_FragColor=vec4(0.,0.,0.,1.0);\nreturn;\n#endif\n";j.IncludesShadersStore.lightFragment="#ifdef LIGHT{X}\n#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n#else\n#ifdef PBR\n#ifdef SPOTLIGHT{X}\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(POINTLIGHT{X})\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(HEMILIGHT{X})\npreInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(DIRLIGHT{X})\npreInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#endif\npreInfo.NdotV=NdotV;\n#ifdef SPOTLIGHT{X}\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\npreInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\npreInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\npreInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\npreInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#elif defined(POINTLIGHT{X})\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#endif\n#else\npreInfo.attenuation=1.0;\n#endif\n#ifdef HEMILIGHT{X}\npreInfo.roughness=roughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#ifdef IRIDESCENCE\npreInfo.iridescenceIntensity=iridescenceIntensity;\n#endif\n#ifdef HEMILIGHT{X}\ninfo.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);\n#elif defined(SS_TRANSLUCENCY)\ninfo.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);\n#endif\n#ifdef SPECULARTERM\n#ifdef ANISOTROPIC\ninfo.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#else\ninfo.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#endif\n#endif\n#ifdef SHEEN\n#ifdef SHEEN_LINKWITHALBEDO\npreInfo.roughness=sheenOut.sheenIntensity;\n#else\n#ifdef HEMILIGHT{X}\npreInfo.roughness=sheenOut.sheenRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#endif\ninfo.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#endif\n#ifdef CLEARCOAT\n#ifdef HEMILIGHT{X}\npreInfo.roughness=clearcoatOut.clearCoatRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\ninfo.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);\n#ifdef CLEARCOAT_TINT\nabsorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);\ninfo.diffuse*=absorption;\n#ifdef SPECULARTERM\ninfo.specular*=absorption;\n#endif\n#endif\ninfo.diffuse*=info.clearCoat.w;\n#ifdef SPECULARTERM\ninfo.specular*=info.clearCoat.w;\n#endif\n#ifdef SHEEN\ninfo.sheen*=info.clearCoat.w;\n#endif\n#endif\n#else\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);\n#elif defined(HEMILIGHT{X})\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);\n#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);\n#endif\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\ninfo.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nfor (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) \n{\n#ifdef SHADOWCSM_RIGHTHANDED{X}\ndiff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;\n#else\ndiff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;\n#endif\nif (diff{X}>=0.) {\nindex{X}=i;\nbreak;\n}\n}\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nif (index{X}>=0)\n#endif\n{\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nshadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nshadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];\n#endif\n#ifndef SHADOWCSMNOBLEND{X}\nfloat frustumLength=frustumLengths{X}[index{X}];\nfloat diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};\nif (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)\n{\nindex{X}+=1;\nfloat nextShadow=0.;\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nnextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nnextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nnextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\nshadow=mix(nextShadow,shadow,diffRatio);\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);\n#endif\n}\n#endif\n}\n#elif defined(SHADOWCLOSEESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPOISSON{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPoissonSamplingCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#ifdef SHADOWONLY\n#ifndef SHADOWINUSE\n#define SHADOWINUSE\n#endif\nglobalShadow+=shadow;\nshadowLightCount+=1.0;\n#endif\n#else\nshadow=1.;\n#endif\n#ifndef SHADOWONLY\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor.rgb*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifndef LIGHTMAPNOSPECULAR{X}\nclearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef SHEEN\n#ifndef LIGHTMAPNOSPECULAR{X}\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#else\n#ifdef SHADOWCSMDEBUG{X}\ndiffuseBase+=info.diffuse*shadowDebug{X};\n#else \ndiffuseBase+=info.diffuse*shadow;\n#endif\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#ifdef CLEARCOAT\nclearCoatBase+=info.clearCoat.rgb*shadow;\n#endif\n#ifdef SHEEN\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#endif\n#endif\n";j.IncludesShadersStore.logDepthFragment="#ifdef LOGARITHMICDEPTH\ngl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;\n#endif\n";j.IncludesShadersStore.fogFragment="#ifdef FOG\nfloat fog=CalcFogFactor();\n#ifdef PBR\nfog=toLinearSpace(fog);\n#endif\ncolor.rgb=mix(vFogColor,color.rgb,fog);\n#endif\n";j.IncludesShadersStore.oitFragment="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\nfloat fragDepth=gl_FragCoord.z; \n#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS\nuint halfFloat=packHalf2x16(vec2(fragDepth));\nvec2 full=unpackHalf2x16(halfFloat);\nfragDepth=full.x;\n#endif\nivec2 fragCoord=ivec2(gl_FragCoord.xy);\nvec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;\nvec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);\ndepth.rg=vec2(-MAX_DEPTH);\nfrontColor=lastFrontColor;\nbackColor=vec4(0.0);\n#ifdef USE_REVERSE_DEPTHBUFFER\nfloat furthestDepth=-lastDepth.x;\nfloat nearestDepth=lastDepth.y;\n#else\nfloat nearestDepth=-lastDepth.x;\nfloat furthestDepth=lastDepth.y;\n#endif\nfloat alphaMultiplier=1.0-lastFrontColor.a;\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth>nearestDepth || fragDepth<furthestDepth) {\n#else\nif (fragDepth<nearestDepth || fragDepth>furthestDepth) {\n#endif\nreturn;\n}\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth<nearestDepth && fragDepth>furthestDepth) {\n#else\nif (fragDepth>nearestDepth && fragDepth<furthestDepth) {\n#endif\ndepth.rg=vec2(-fragDepth,fragDepth);\nreturn;\n}\n#endif\n";j.ShadersStore.defaultPixelShader="#include<__decl__defaultFragment>\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#define RECIPROCAL_PI2 0.15915494\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#include<helperFunctions>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\n#endif\n#endif\n#if defined(SPECULARTERM)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)\n#endif\n#include<fresnelFunction>\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\nvec4 baseColor=vec4(1.,1.,1.,1.);\nvec3 diffuseColor=vDiffuseColor.rgb;\nfloat alpha=vDiffuseColor.a;\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n#ifdef DIFFUSE\nbaseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);\n#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)\nif (baseColor.a<alphaCutOff)\ndiscard;\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\nbaseColor.rgb*=vDiffuseInfos.y;\n#endif\n#ifdef DECAL\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#include<depthPrePass>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nbaseColor.rgb*=vColor.rgb;\n#endif\n#ifdef DETAIL\nbaseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE\nvec3 baseAmbientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\n#ifdef SPECULARTERM\nfloat glossiness=vSpecularColor.a;\nvec3 specularColor=vSpecularColor.rgb;\n#ifdef SPECULAR\nvec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);\nspecularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#else\nfloat glossiness=0.;\n#endif\nvec3 diffuseBase=vec3(0.,0.,0.);\nlightingInfo info;\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\nfloat shadow=1.;\n#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\nvec4 refractionColor=vec4(0.,0.,0.,1.);\n#ifdef REFRACTION\nvec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\n#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nif (dot(refractionVector,viewDirectionW)<1.0) {\nrefractionColor=textureCube(refractionCubeSampler,refractionVector);\n}\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\nrefractionColor=texture2D(refraction2DSampler,refractionCoords);\n#endif\n#ifdef RGBDREFRACTION\nrefractionColor.rgb=fromRGBD(refractionColor);\n#endif\n#ifdef IS_REFRACTION_LINEAR\nrefractionColor.rgb=toGammaSpace(refractionColor.rgb);\n#endif\nrefractionColor.rgb*=vRefractionInfos.x;\n#endif\nvec4 reflectionColor=vec4(0.,0.,0.,1.);\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nvReflectionUVW.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nfloat bias=vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);\n#else\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);\n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;\nreflectionColor=texture2D(reflection2DSampler,coords);\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef IS_REFLECTION_LINEAR\nreflectionColor.rgb=toGammaSpace(reflectionColor.rgb);\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#ifdef REFLECTIONFRESNEL\nfloat reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nfloat refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);\nrefractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);\nalpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);\nalpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n#ifdef ALPHATEST\n#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS\nif (alpha<alphaCutOff)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\nvec3 emissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);\nemissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n#ifdef DIFFUSEFRESNEL\nfloat diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);\ndiffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);\n#else\nvec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);\n#endif\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor.rgb*=lightmapColor.rgb;\n#else\ncolor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\ncolor.rgb=max(color.rgb,0.);\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor.rgb=toLinearSpace(color.rgb);\n#else\n#ifdef IMAGEPROCESSING\ncolor.rgb=toLinearSpace(color.rgb);\ncolor=applyImageProcessing(color);\n#endif\n#endif\ncolor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\nfloat writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;\ngl_FragData[0]=color; \n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;\nvec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;\nvec2 velocity=abs(a-b);\nvelocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;\ngl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_IRRADIANCE\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_NORMAL\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); \n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_REFLECTIVITY\n#if defined(SPECULARTERM)\n#if defined(SPECULAR)\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; \n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;\n#endif\n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0)*writeGeometryInfo;\n#endif\n#endif\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=color;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {\nfrontColor.rgb+=color.rgb*color.a*alphaMultiplier;\nfrontColor.a=1.0-alphaMultiplier*(1.0-color.a);\n} else {\nbackColor+=color;\n}\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";j.IncludesShadersStore.decalVertexDeclaration="#ifdef DECAL\nuniform vec4 vDecalInfos;\nuniform mat4 decalMatrix;\n#endif\n";j.IncludesShadersStore.defaultVertexDeclaration="uniform mat4 viewProjection;\nuniform mat4 view;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\nuniform mat4 specularMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef REFLECTION\nuniform mat4 reflectionMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\nuniform mat4 detailMatrix;\n#endif\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n";j.IncludesShadersStore.uvAttributeDeclaration="#ifdef UV{X}\nattribute vec2 uv{X};\n#endif\n";j.IncludesShadersStore.bonesDeclaration="#if NUM_BONE_INFLUENCERS>0\nattribute vec4 matricesIndices;\nattribute vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nattribute vec4 matricesIndicesExtra;\nattribute vec4 matricesWeightsExtra;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nuniform sampler2D boneSampler;\nuniform float boneTextureWidth;\n#else\nuniform mat4 mBones[BonesPerMesh];\n#ifdef BONES_VELOCITY_ENABLED\nuniform mat4 mPreviousBones[BonesPerMesh];\n#endif\n#endif\n#ifdef BONETEXTURE\n#define inline\nmat4 readMatrixFromRawSampler(sampler2D smp,float index)\n{\nfloat offset=index *4.0;\nfloat dx=1.0/boneTextureWidth;\nvec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));\nvec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));\nvec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));\nvec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));\nreturn mat4(m0,m1,m2,m3);\n}\n#endif\n#endif\n#endif\n";j.IncludesShadersStore.bakedVertexAnimationDeclaration="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform float bakedVertexAnimationTime;\nuniform vec2 bakedVertexAnimationTextureSizeInverted;\nuniform vec4 bakedVertexAnimationSettings;\nuniform sampler2D bakedVertexAnimationTexture;\n#ifdef INSTANCES\nattribute vec4 bakedVertexAnimationSettingsInstanced;\n#endif\n#define inline\nmat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)\n{\nfloat offset=index*4.0;\nfloat frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;\nfloat dx=bakedVertexAnimationTextureSizeInverted.x;\nvec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));\nvec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));\nvec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));\nvec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));\nreturn mat4(m0,m1,m2,m3);\n}\n#endif\n";j.IncludesShadersStore.instancesDeclaration="#ifdef INSTANCES\nattribute vec4 world0;\nattribute vec4 world1;\nattribute vec4 world2;\nattribute vec4 world3;\n#ifdef INSTANCESCOLOR\nattribute vec4 instanceColor;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nattribute vec4 previousWorld0;\nattribute vec4 previousWorld1;\nattribute vec4 previousWorld2;\nattribute vec4 previousWorld3;\n#ifdef THIN_INSTANCES\nuniform mat4 previousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nuniform mat4 previousWorld;\n#endif\n#endif\n";j.IncludesShadersStore.prePassVertexDeclaration="#ifdef PREPASS\n#ifdef PREPASS_DEPTH\nvarying vec3 vViewPos;\n#endif\n#ifdef PREPASS_VELOCITY\nuniform mat4 previousViewProjection;\nvarying vec4 vCurrentPosition;\nvarying vec4 vPreviousPosition;\n#endif\n#endif\n";j.IncludesShadersStore.samplerVertexDeclaration="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n";j.IncludesShadersStore.bumpVertexDeclaration="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#endif\n";j.IncludesShadersStore.clipPlaneVertexDeclaration="#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nvarying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nuniform vec4 vClipPlane2;\nvarying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nuniform vec4 vClipPlane3;\nvarying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nuniform vec4 vClipPlane4;\nvarying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nuniform vec4 vClipPlane5;\nvarying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nuniform vec4 vClipPlane6;\nvarying float fClipDistance6;\n#endif\n";j.IncludesShadersStore.fogVertexDeclaration="#ifdef FOG\nvarying vec3 vFogDistance;\n#endif\n";j.IncludesShadersStore.lightVxFragmentDeclaration="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};\nuniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};\nuniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};\nuniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#endif\n";j.IncludesShadersStore.lightVxUboDeclaration="#ifdef LIGHT{X}\nuniform Light{X}\n{\nvec4 vLightData;\nvec4 vLightDiffuse;\nvec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;\nvec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;\nvec2 depthValues;\n} light{X};\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n";j.IncludesShadersStore.morphTargetsVertexGlobalDeclaration="#ifdef MORPHTARGETS\nuniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];\n#ifdef MORPHTARGETS_TEXTURE \nprecision mediump sampler2DArray; \nuniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];\nuniform vec3 morphTargetTextureInfo;\nuniform sampler2DArray morphTargets;\nvec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)\n{ \nfloat y=floor(vertexIndex/morphTargetTextureInfo.y);\nfloat x=vertexIndex-y*morphTargetTextureInfo.y;\nvec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);\nreturn texture(morphTargets,textureUV).xyz;\n}\n#endif\n#endif\n";j.IncludesShadersStore.morphTargetsVertexDeclaration="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\nattribute vec3 position{X};\n#ifdef MORPHTARGETS_NORMAL\nattribute vec3 normal{X};\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute vec3 tangent{X};\n#endif\n#ifdef MORPHTARGETS_UV\nattribute vec2 uv_{X};\n#endif\n#endif\n#endif\n";j.IncludesShadersStore.morphTargetsVertexGlobal="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nfloat vertexID;\n#endif\n#endif\n";j.IncludesShadersStore.morphTargetsVertex="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE \nvertexID=float(gl_VertexID)*morphTargetTextureInfo.x;\npositionUpdated+=(readVector3FromRawSampler({X},vertexID)-position)*morphTargetInfluences[{X}];\nvertexID+=1.0;\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(readVector3FromRawSampler({X},vertexID) -normal)*morphTargetInfluences[{X}];\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(readVector3FromRawSampler({X},vertexID).xy-uv)*morphTargetInfluences[{X}];\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#else\npositionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n";j.IncludesShadersStore.instancesVertex="#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nmat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\nfinalWorld=world*finalWorld;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nfinalPreviousWorld=previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\nmat4 finalWorld=world;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nmat4 finalPreviousWorld=previousWorld;\n#endif\n#endif\n";j.IncludesShadersStore.bonesVertex="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nmat4 influence;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];\n#endif\n#else\ninfluence=mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n";j.IncludesShadersStore.bakedVertexAnimation="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\n#define BVASNAME bakedVertexAnimationSettingsInstanced\n#else\n#define BVASNAME bakedVertexAnimationSettings\n#endif\nfloat VATStartFrame=BVASNAME.x;\nfloat VATEndFrame=BVASNAME.y;\nfloat VATOffsetFrame=BVASNAME.z;\nfloat VATSpeed=BVASNAME.w;\nfloat totalFrames=VATEndFrame-VATStartFrame+1.0;\nfloat time=bakedVertexAnimationTime*VATSpeed/totalFrames;\nfloat frameCorrection=time<1.0 ? 0.0 : 1.0;\nfloat numOfFrames=totalFrames-frameCorrection;\nfloat VATFrameNum=fract(time)*numOfFrames;\nVATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);\nVATFrameNum=floor(VATFrameNum);\nVATFrameNum+=VATStartFrame+frameCorrection;\nmat4 VATInfluence;\nVATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;\n}\n#endif\n";j.IncludesShadersStore.prePassVertex="#ifdef PREPASS_DEPTH\nvViewPos=(view*worldPos).rgb;\n#endif\n#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*worldPos;\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;\npreviousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n";j.IncludesShadersStore.uvVariableDeclaration="#if !defined(UV{X}) && defined(MAINUV{X})\nvec2 uv{X}=vec2(0.,0.);\n#endif\n#ifdef MAINUV{X}\nvMainUV{X}=uv{X};\n#endif\n";j.IncludesShadersStore.samplerVertexImplementation="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nif (v_INFONAME_==0.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));\n}\n#ifdef UV2\nelse if (v_INFONAME_==1.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef UV3\nelse if (v_INFONAME_==2.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));\n}\n#endif\n#ifdef UV4\nelse if (v_INFONAME_==3.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));\n}\n#endif\n#ifdef UV5\nelse if (v_INFONAME_==4.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));\n}\n#endif\n#ifdef UV6\nelse if (v_INFONAME_==5.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));\n}\n#endif\n#endif\n";j.IncludesShadersStore.bumpVertex="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nvec3 tbnNormal=normalize(normalUpdated);\nvec3 tbnTangent=normalize(tangentUpdated.xyz);\nvec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;\nvTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);\n#endif\n#endif\n";j.IncludesShadersStore.clipPlaneVertex="#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nfClipDistance2=dot(worldPos,vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nfClipDistance3=dot(worldPos,vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nfClipDistance4=dot(worldPos,vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nfClipDistance5=dot(worldPos,vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nfClipDistance6=dot(worldPos,vClipPlane6);\n#endif\n";j.IncludesShadersStore.fogVertex="#ifdef FOG\nvFogDistance=(view*worldPos).xyz;\n#endif\n";j.IncludesShadersStore.shadowsVertex="#ifdef SHADOWS\n#if defined(SHADOWCSM{X})\nvPositionFromCamera{X}=view*worldPos;\nfor (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {\nvPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n}\n#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvPositionFromLight{X}=lightMatrix{X}*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif\n#endif\n";j.IncludesShadersStore.vertexColorMixing="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvColor=vec4(1.0);\n#ifdef VERTEXCOLOR\n#ifdef VERTEXALPHA\nvColor*=color;\n#else\nvColor.rgb*=color.rgb;\n#endif\n#endif\n#ifdef INSTANCESCOLOR\nvColor*=instanceColor;\n#endif\n#endif\n";j.IncludesShadersStore.pointCloudVertex="#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n";j.IncludesShadersStore.logDepthVertex="#ifdef LOGARITHMICDEPTH\nvFragmentDepth=1.0+gl_Position.w;\ngl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;\n#endif\n";j.ShadersStore.defaultVertexShader="#include<__decl__defaultVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<mainUVVaryingDeclaration>[1..7]\n#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#if defined(SPECULARTERM)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)\n#endif\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));\nvNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*worldPos;\n} else {\ngl_Position=viewProjectionR*worldPos;\n}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\nvPositionW=vec3(worldPos);\n#include<prePassVertex>\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#include<uvVariableDeclaration>[2..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#if defined(SPECULARTERM)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)\n#endif\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<pointCloudVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";const qse=new RegExp("^([gimus]+)!");let $se=(()=>{class r{constructor(t){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=t,this._scene=t.getScene(),this._engine=this._scene.getEngine()}_addPlugin(t){for(let n=0;n<this._plugins.length;++n)if(this._plugins[n].name===t.name)throw`Plugin "${t.name}" already added to the material "${this._material.name}"!`;if(this._material._uniformBufferLayoutBuilt)throw`The plugin "${t.name}" can't be added to the material "${this._material.name}" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.`;const i=t.getClassName();r._MaterialPluginClassToMainDefine[i]||(r._MaterialPluginClassToMainDefine[i]="MATERIALPLUGIN_"+ ++r._MaterialPluginCounter),this._material._callbackPluginEventGeneric=this._handlePluginEvent.bind(this),this._plugins.push(t),this._plugins.sort((n,o)=>n.priority-o.priority),this._codeInjectionPoints={};const s={};s[r._MaterialPluginClassToMainDefine[i]]={type:"boolean",default:!0};for(const n of this._plugins)n.collectDefines(s),this._collectPointNames("vertex",n.getCustomCode("vertex")),this._collectPointNames("fragment",n.getCustomCode("fragment"));this._defineNamesFromPlugins=s}_activatePlugin(t){-1===this._activePlugins.indexOf(t)&&(this._activePlugins.push(t),this._activePlugins.sort((i,s)=>i.priority-s.priority),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),t.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(t),this._activePluginsForExtraEvents.sort((i,s)=>i.priority-s.priority),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(t){for(let i=0;i<this._plugins.length;++i)if(this._plugins[i].name===t)return this._plugins[i];return null}_handlePluginEventIsReadyForSubMesh(t){let i=!0;for(const s of this._activePlugins)i=i&&s.isReadyForSubMesh(t.defines,this._scene,this._engine,t.subMesh);t.isReadyForSubMesh=i}_handlePluginEventPrepareDefinesBeforeAttributes(t){for(const i of this._activePlugins)i.prepareDefinesBeforeAttributes(t.defines,this._scene,t.mesh)}_handlePluginEventPrepareDefines(t){for(const i of this._activePlugins)i.prepareDefines(t.defines,this._scene,t.mesh)}_handlePluginEventHardBindForSubMesh(t){for(const i of this._activePluginsForExtraEvents)i.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,t.subMesh)}_handlePluginEventBindForSubMesh(t){for(const i of this._activePlugins)i.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,t.subMesh)}_handlePluginEventHasRenderTargetTextures(t){let i=!1;for(const s of this._activePluginsForExtraEvents)if(i=s.hasRenderTargetTextures(),i)break;t.hasRenderTargetTextures=i}_handlePluginEventFillRenderTargetTextures(t){for(const i of this._activePluginsForExtraEvents)i.fillRenderTargetTextures(t.renderTargets)}_handlePluginEvent(t,i){switch(t){case Ns.GetActiveTextures:{const s=i;for(const n of this._activePlugins)n.getActiveTextures(s.activeTextures);break}case Ns.GetAnimatables:{const s=i;for(const n of this._activePlugins)n.getAnimatables(s.animatables);break}case Ns.HasTexture:{const s=i;let n=!1;for(const o of this._activePlugins)if(n=o.hasTexture(s.texture),n)break;s.hasTexture=n;break}case Ns.Disposed:{const s=i;for(const n of this._plugins)n.dispose(s.forceDisposeTextures);break}case Ns.GetDefineNames:i.defineNames=this._defineNamesFromPlugins;break;case Ns.PrepareEffect:{const s=i;for(const n of this._activePlugins)s.fallbackRank=n.addFallbacks(s.defines,s.fallbacks,s.fallbackRank),n.getAttributes(s.attributes,this._scene,s.mesh);this._uniformList.length>0&&s.uniforms.push(...this._uniformList),this._samplerList.length>0&&s.samplers.push(...this._samplerList),this._uboList.length>0&&s.uniformBuffersNames.push(...this._uboList),s.customCode=this._injectCustomCode(s.customCode);break}case Ns.PrepareUniformBuffer:{const s=i;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(const n of this._plugins){const o=n.getUniforms();if(o){if(o.ubo)for(const a of o.ubo)s.ubo.addUniform(a.name,a.size),this._uboDeclaration+=`${a.type} ${a.name};\r\n`,this._uniformList.push(a.name);o.vertex&&(this._vertexDeclaration+=o.vertex+"\r\n"),o.fragment&&(this._fragmentDeclaration+=o.fragment+"\r\n")}n.getSamplers(this._samplerList),n.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(t,i){if(i)for(const s in i)this._codeInjectionPoints[t]||(this._codeInjectionPoints[t]={}),this._codeInjectionPoints[t][s]=!0}_injectCustomCode(t){return(i,s)=>{var n;t&&(s=t(i,s)),this._uboDeclaration&&(s=s.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(s=s.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(s=s.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const o=null===(n=this._codeInjectionPoints)||void 0===n?void 0:n[i];if(!o)return s;for(let a in o){let l="";for(const c of this._activePlugins){const h=c.getCustomCode(i);h?.[a]&&(l+=h[a]+"\r\n")}if(l.length>0)if("!"===a.charAt(0)){a=a.substring(1);let c="g";if("!"===a.charAt(0))c="",a=a.substring(1);else{const f=qse.exec(a);f&&f.length>=2&&(c=f[1],a=a.substring(c.length+1))}c.indexOf("g")<0&&(c+="g");const h=s,u=new RegExp(a,c);let d=u.exec(h);for(;null!==d;){let f=l;for(let p=0;p<d.length;++p)f=f.replace("$"+p,d[p]);s=s.replace(d[0],f),d=u.exec(h)}}else{const c="#define "+a;s=s.replace(c,"\r\n"+l+"\r\n"+c)}}return s}}}return r._MaterialPluginClassToMainDefine={},r._MaterialPluginCounter=0,r})();class Wo{_enable(e){e&&this._pluginManager._activatePlugin(this)}constructor(e,t,i,s,n=!0,o=!1){this.priority=500,this.registerForExtraEvents=!1,this._material=e,this.name=t,this.priority=i,e.pluginManager||(e.pluginManager=new $se(e),e.onDisposeObservable.add(()=>{e.pluginManager=void 0})),this._pluginDefineNames=s,this._pluginManager=e.pluginManager,n&&this._pluginManager._addPlugin(this),o&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,t,i,s){return!0}hardBindForSubMesh(e,t,i,s){}bindForSubMesh(e,t,i,s){}dispose(e){}getCustomCode(e){return null}collectDefines(e){if(this._pluginDefineNames)for(const t of Object.keys(this._pluginDefineNames)){if("_"===t[0])continue;const i=typeof this._pluginDefineNames[t];e[t]={type:"number"===i?"number":"string"===i?"string":"boolean"===i?"boolean":"object",default:this._pluginDefineNames[t]}}}prepareDefinesBeforeAttributes(e,t,i){}prepareDefines(e,t,i){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,i){return i}getSamplers(e){}getAttributes(e,t,i){}getUniformBuffersNames(e){}getUniforms(){return{}}copyTo(e){Ce.Clone(()=>e,this)}serialize(){return Ce.Serialize(this)}parse(e,t,i){Ce.Parse(()=>this,e,t,i)}}E([I()],Wo.prototype,"name",void 0),E([I()],Wo.prototype,"priority",void 0),E([I()],Wo.prototype,"registerForExtraEvents",void 0);class Kse extends Un{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class tc extends Wo{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"DetailMap",140,new Kse,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=ie.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&pe.DetailTextureEnabled&&!this._texture.isReady())}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&pe.DetailTextureEnabled&&this._isEnabled?(ce.PrepareDefinesForMergedUV(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){this._isEnabled&&((!e.useUbo||!this._material.isFrozen||!e.isSync)&&this._texture&&pe.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),ce.BindTextureMatrix(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&pe.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture))}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){var t;e&&(null===(t=this._texture)||void 0===t||t.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}E([ht("detailTexture"),ne("_markAllSubMeshesAsTexturesDirty")],tc.prototype,"texture",void 0),E([I()],tc.prototype,"diffuseBlendLevel",void 0),E([I()],tc.prototype,"roughnessBlendLevel",void 0),E([I()],tc.prototype,"bumpLevel",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],tc.prototype,"normalBlendMethod",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],tc.prototype,"isEnabled",void 0);const WE={effect:null,subMesh:null};class Qse extends Un{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.rebuild()}setReflectionMode(e){const t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const i of t)this[i]=i===e}}class fe extends gp{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}constructor(e,t){super(e,t),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new re(0,0,0),this.diffuseColor=new re(1,1,1),this.specularColor=new re(1,1,1),this.emissiveColor=new re(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._renderTargets=new ws(16),this._worldViewProjectionMatrix=F.Zero(),this._globalAmbientColor=new re(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new tc(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new $u,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),fe.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),fe.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return!!(fe.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||fe.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this._markAllSubMeshesAsMiscDirty()}needAlphaBlending(){return!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled)}needAlphaTesting(){return!!this._forceAlphaTest||this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===ie.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==ie.MATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(Ns.GetDefineNames,this._eventInfo),t.materialDefines=new Qse(this._eventInfo.defineNames));const s=this.getScene(),n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=s.getEngine();n._needNormals=ce.PrepareDefinesForLights(s,e,n,!0,this._maxSimultaneousLights,this._disableLighting),ce.PrepareDefinesForMultiview(s,n);const a=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(ce.PrepareDefinesForPrePass(s,n,this.canRenderToMRT&&!a),ce.PrepareDefinesForOIT(s,n,a),n._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,n._needUVs=!1;for(let c=1;c<=6;++c)n["MAINUV"+c]=!1;if(s.texturesEnabled){if(n.DIFFUSEDIRECTUV=0,n.BUMPDIRECTUV=0,n.AMBIENTDIRECTUV=0,n.OPACITYDIRECTUV=0,n.EMISSIVEDIRECTUV=0,n.SPECULARDIRECTUV=0,n.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&fe.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;ce.PrepareDefinesForMergedUV(this._diffuseTexture,n,"DIFFUSE")}else n.DIFFUSE=!1;if(this._ambientTexture&&fe.AmbientTextureEnabled){if(!this._ambientTexture.isReadyOrNotBlocking())return!1;ce.PrepareDefinesForMergedUV(this._ambientTexture,n,"AMBIENT")}else n.AMBIENT=!1;if(this._opacityTexture&&fe.OpacityTextureEnabled){if(!this._opacityTexture.isReadyOrNotBlocking())return!1;ce.PrepareDefinesForMergedUV(this._opacityTexture,n,"OPACITY"),n.OPACITYRGB=this._opacityTexture.getAlphaFromRGB}else n.OPACITY=!1;if(this._reflectionTexture&&fe.ReflectionTextureEnabled){if(!this._reflectionTexture.isReadyOrNotBlocking())return!1;switch(n._needNormals=!0,n.REFLECTION=!0,n.ROUGHNESS=this._roughness>0,n.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,n.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===U.INVCUBIC_MODE,n.REFLECTIONMAP_3D=this._reflectionTexture.isCube,n.REFLECTIONMAP_OPPOSITEZ=n.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,n.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case U.EXPLICIT_MODE:n.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case U.PLANAR_MODE:n.setReflectionMode("REFLECTIONMAP_PLANAR");break;case U.PROJECTION_MODE:n.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case U.SKYBOX_MODE:n.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case U.SPHERICAL_MODE:n.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case U.EQUIRECTANGULAR_MODE:n.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case U.FIXED_EQUIRECTANGULAR_MODE:n.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case U.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:n.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;default:n.setReflectionMode("REFLECTIONMAP_CUBIC")}n.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else n.REFLECTION=!1,n.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&fe.EmissiveTextureEnabled){if(!this._emissiveTexture.isReadyOrNotBlocking())return!1;ce.PrepareDefinesForMergedUV(this._emissiveTexture,n,"EMISSIVE")}else n.EMISSIVE=!1;if(this._lightmapTexture&&fe.LightmapTextureEnabled){if(!this._lightmapTexture.isReadyOrNotBlocking())return!1;ce.PrepareDefinesForMergedUV(this._lightmapTexture,n,"LIGHTMAP"),n.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,n.RGBDLIGHTMAP=this._lightmapTexture.isRGBD}else n.LIGHTMAP=!1;if(this._specularTexture&&fe.SpecularTextureEnabled){if(!this._specularTexture.isReadyOrNotBlocking())return!1;ce.PrepareDefinesForMergedUV(this._specularTexture,n,"SPECULAR"),n.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha}else n.SPECULAR=!1;if(s.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&fe.BumpTextureEnabled){if(!this._bumpTexture.isReady())return!1;ce.PrepareDefinesForMergedUV(this._bumpTexture,n,"BUMP"),n.PARALLAX=this._useParallax,n.PARALLAXOCCLUSION=this._useParallaxOcclusion,n.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else n.BUMP=!1,n.PARALLAX=!1,n.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&fe.RefractionTextureEnabled){if(!this._refractionTexture.isReadyOrNotBlocking())return!1;n._needUVs=!0,n.REFRACTION=!0,n.REFRACTIONMAP_3D=this._refractionTexture.isCube,n.RGBDREFRACTION=this._refractionTexture.isRGBD,n.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize}else n.REFRACTION=!1;n.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else n.DIFFUSE=!1,n.AMBIENT=!1,n.OPACITY=!1,n.REFLECTION=!1,n.EMISSIVE=!1,n.LIGHTMAP=!1,n.BUMP=!1,n.REFRACTION=!1;n.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),n.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,n.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,n.SPECULAROVERALPHA=this._useSpecularOverAlpha,n.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,n.ALPHATEST_AFTERALLALPHACOMPUTATIONS=null!==this.transparencyMode,n.ALPHABLEND=null===this.transparencyMode||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(n._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(n),n.IS_REFLECTION_LINEAR=null!=this.reflectionTexture&&!this.reflectionTexture.gammaSpace,n.IS_REFRACTION_LINEAR=null!=this.refractionTexture&&!this.refractionTexture.gammaSpace}n._areFresnelDirty&&(fe.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(n.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,n.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,n.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,n.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,n.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,n.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,n._needNormals=!0,n.FRESNEL=!0):n.FRESNEL=!1),ce.PrepareDefinesForMisc(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,n),ce.PrepareDefinesForFrameBoundValues(s,o,this,n,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=n,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),ce.PrepareDefinesForAttributes(e,n,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let l=!1;if(n.isDirty){const c=n._areLightsDisposed;n.markAsProcessed();const h=new oh;n.REFLECTION&&h.addFallback(0,"REFLECTION"),n.SPECULAR&&h.addFallback(0,"SPECULAR"),n.BUMP&&h.addFallback(0,"BUMP"),n.PARALLAX&&h.addFallback(1,"PARALLAX"),n.PARALLAXOCCLUSION&&h.addFallback(0,"PARALLAXOCCLUSION"),n.SPECULAROVERALPHA&&h.addFallback(0,"SPECULAROVERALPHA"),n.FOG&&h.addFallback(1,"FOG"),n.POINTSIZE&&h.addFallback(0,"POINTSIZE"),n.LOGARITHMICDEPTH&&h.addFallback(0,"LOGARITHMICDEPTH"),ce.HandleFallbacksForShadows(n,h,this._maxSimultaneousLights),n.SPECULARTERM&&h.addFallback(0,"SPECULARTERM"),n.DIFFUSEFRESNEL&&h.addFallback(1,"DIFFUSEFRESNEL"),n.OPACITYFRESNEL&&h.addFallback(2,"OPACITYFRESNEL"),n.REFLECTIONFRESNEL&&h.addFallback(3,"REFLECTIONFRESNEL"),n.EMISSIVEFRESNEL&&h.addFallback(4,"EMISSIVEFRESNEL"),n.FRESNEL&&h.addFallback(4,"FRESNEL"),n.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");const u=[A.PositionKind];n.NORMAL&&u.push(A.NormalKind),n.TANGENT&&u.push(A.TangentKind);for(let T=1;T<=6;++T)n["UV"+T]&&u.push(`uv${1===T?"":T}`);n.VERTEXCOLOR&&u.push(A.ColorKind),ce.PrepareAttributesForBones(u,e,n,h),ce.PrepareAttributesForInstances(u,n),ce.PrepareAttributesForMorphTargets(u,e,n),ce.PrepareAttributesForBakedVertexAnimation(u,e,n);let d="default";const f=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],p=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],_=["Material","Scene","Mesh"];this._eventInfo.fallbacks=h,this._eventInfo.fallbackRank=0,this._eventInfo.defines=n,this._eventInfo.uniforms=f,this._eventInfo.attributes=u,this._eventInfo.samplers=p,this._eventInfo.uniformBuffersNames=_,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._callbackPluginEventGeneric(Ns.PrepareEffect,this._eventInfo),$u.AddUniforms(f),$u.AddSamplers(p),at&&(at.PrepareUniforms(f,n),at.PrepareSamplers(p,n)),ce.PrepareUniformsAndSamplersList({uniformsNames:f,uniformBuffersNames:_,samplers:p,defines:n,maxSimultaneousLights:this._maxSimultaneousLights}),Uo(f);const m={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,f,_,p,n,u,m));const g=n.toString(),b=t.effect;let y=s.getEngine().createEffect(d,{attributes:u,uniformsNames:f,uniformBuffersNames:_,samplers:p,defines:g,fallbacks:h,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:n.NUM_MORPH_INFLUENCERS},processFinalCode:m.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:n.PREPASS},o);if(this._eventInfo.customCode=void 0,y)if(this._onEffectCreatedObservable&&(WE.effect=y,WE.subMesh=t,this._onEffectCreatedObservable.notifyObservers(WE)),this.allowShaderHotSwapping&&b&&!y.isReady()){if(y=b,n.markAsUnprocessed(),l=this.isFrozen,c)return n._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(y,n,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(n._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!l,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var s;const n=this.getScene(),o=i.materialDefines;if(!o)return;const a=i.effect;if(!a)return;this._activeEffect=a,t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(a,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,n,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),o.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const l=a._forceRebindOnNextCall||this._mustRebind(n,a,t.visibility);ce.BindBonesParameters(t,a);const c=this._uniformBuffer;if(l){if(this.bindViewProjection(a),!c.useUbo||!this.isFrozen||!c.isSync||a._forceRebindOnNextCall){if(fe.FresnelEnabled&&o.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(c.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),c.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&c.updateColor4("opacityParts",new re(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(c.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),c.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(c.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),c.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(c.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),c.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),n.texturesEnabled){if(this._diffuseTexture&&fe.DiffuseTextureEnabled&&(c.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),ce.BindTextureMatrix(this._diffuseTexture,c,"diffuse")),this._ambientTexture&&fe.AmbientTextureEnabled&&(c.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),ce.BindTextureMatrix(this._ambientTexture,c,"ambient")),this._opacityTexture&&fe.OpacityTextureEnabled&&(c.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),ce.BindTextureMatrix(this._opacityTexture,c,"opacity")),this._hasAlphaChannel()&&c.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&fe.ReflectionTextureEnabled&&(c.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),c.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){const h=this._reflectionTexture;c.updateVector3("vReflectionPosition",h.boundingBoxPosition),c.updateVector3("vReflectionSize",h.boundingBoxSize)}if(this._emissiveTexture&&fe.EmissiveTextureEnabled&&(c.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),ce.BindTextureMatrix(this._emissiveTexture,c,"emissive")),this._lightmapTexture&&fe.LightmapTextureEnabled&&(c.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),ce.BindTextureMatrix(this._lightmapTexture,c,"lightmap")),this._specularTexture&&fe.SpecularTextureEnabled&&(c.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),ce.BindTextureMatrix(this._specularTexture,c,"specular")),this._bumpTexture&&n.getEngine().getCaps().standardDerivatives&&fe.BumpTextureEnabled&&(c.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),ce.BindTextureMatrix(this._bumpTexture,c,"bump"),n._mirroredCameraPosition?c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&fe.RefractionTextureEnabled){let h=1;if(this._refractionTexture.isCube||(c.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(h=this._refractionTexture.depth)),c.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,h,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const u=this._refractionTexture;c.updateVector3("vRefractionPosition",u.boundingBoxPosition),c.updateVector3("vRefractionSize",u.boundingBoxSize)}}}this.pointsCloud&&c.updateFloat("pointSize",this.pointSize),o.SPECULARTERM&&c.updateColor4("vSpecularColor",this.specularColor,this.specularPower),c.updateColor3("vEmissiveColor",fe.EmissiveTextureEnabled?this.emissiveColor:re.BlackReadOnly),c.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),n.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),c.updateColor3("vAmbientColor",this._globalAmbientColor)}n.texturesEnabled&&(this._diffuseTexture&&fe.DiffuseTextureEnabled&&a.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&fe.AmbientTextureEnabled&&a.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&fe.OpacityTextureEnabled&&a.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&fe.ReflectionTextureEnabled&&a.setTexture(this._reflectionTexture.isCube?"reflectionCubeSampler":"reflection2DSampler",this._reflectionTexture),this._emissiveTexture&&fe.EmissiveTextureEnabled&&a.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&fe.LightmapTextureEnabled&&a.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&fe.SpecularTextureEnabled&&a.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&n.getEngine().getCaps().standardDerivatives&&fe.BumpTextureEnabled&&a.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&fe.RefractionTextureEnabled&&a.setTexture(this._refractionTexture.isCube?"refractionCubeSampler":"refraction2DSampler",this._refractionTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(a),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),fo(a,this,n),this.bindEyePosition(a)}else n.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(n.lightsEnabled&&!this._disableLighting&&ce.BindLights(n,t,a,o,this._maxSimultaneousLights),(n.fogEnabled&&t.applyFog&&n.fogMode!==ge.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||o.PREPASS)&&this.bindView(a),ce.BindFogParameters(n,t,a),o.NUM_MORPH_INFLUENCERS&&ce.BindMorphTargetParameters(t,a),o.BAKED_VERTEX_ANIMATION_TEXTURE&&(null===(s=t.bakedVertexAnimationManager)||void 0===s||s.bind(a,o.INSTANCES)),this.useLogarithmicDepth&&ce.BindLogDepth(o,a,n),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),c.update()}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!(!super.hasTexture(e)&&this._diffuseTexture!==e&&this._ambientTexture!==e&&this._opacityTexture!==e&&this._reflectionTexture!==e&&this._emissiveTexture!==e&&this._specularTexture!==e&&this._bumpTexture!==e&&this._lightmapTexture!==e&&this._refractionTexture!==e)}dispose(e,t){var i,s,n,o,a,l,c,h,u;t&&(null===(i=this._diffuseTexture)||void 0===i||i.dispose(),null===(s=this._ambientTexture)||void 0===s||s.dispose(),null===(n=this._opacityTexture)||void 0===n||n.dispose(),null===(o=this._reflectionTexture)||void 0===o||o.dispose(),null===(a=this._emissiveTexture)||void 0===a||a.dispose(),null===(l=this._specularTexture)||void 0===l||l.dispose(),null===(c=this._bumpTexture)||void 0===c||c.dispose(),null===(h=this._lightmapTexture)||void 0===h||h.dispose(),null===(u=this._refractionTexture)||void 0===u||u.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e){const t=Ce.Clone(()=>new fe(e,this.getScene()),this);return t.name=e,t.id=e,this.stencil.copyTo(t.stencil),t}static Parse(e,t,i){const s=Ce.Parse(()=>new fe(e.name,t),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),s}static get DiffuseTextureEnabled(){return pe.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){pe.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return pe.DetailTextureEnabled}static set DetailTextureEnabled(e){pe.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return pe.AmbientTextureEnabled}static set AmbientTextureEnabled(e){pe.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return pe.OpacityTextureEnabled}static set OpacityTextureEnabled(e){pe.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return pe.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){pe.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return pe.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){pe.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return pe.SpecularTextureEnabled}static set SpecularTextureEnabled(e){pe.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return pe.BumpTextureEnabled}static set BumpTextureEnabled(e){pe.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return pe.LightmapTextureEnabled}static set LightmapTextureEnabled(e){pe.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return pe.RefractionTextureEnabled}static set RefractionTextureEnabled(e){pe.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return pe.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){pe.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return pe.FresnelEnabled}static set FresnelEnabled(e){pe.FresnelEnabled=e}}E([ht("diffuseTexture")],fe.prototype,"_diffuseTexture",void 0),E([ne("_markAllSubMeshesAsTexturesAndMiscDirty")],fe.prototype,"diffuseTexture",void 0),E([ht("ambientTexture")],fe.prototype,"_ambientTexture",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"ambientTexture",void 0),E([ht("opacityTexture")],fe.prototype,"_opacityTexture",void 0),E([ne("_markAllSubMeshesAsTexturesAndMiscDirty")],fe.prototype,"opacityTexture",void 0),E([ht("reflectionTexture")],fe.prototype,"_reflectionTexture",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"reflectionTexture",void 0),E([ht("emissiveTexture")],fe.prototype,"_emissiveTexture",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"emissiveTexture",void 0),E([ht("specularTexture")],fe.prototype,"_specularTexture",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"specularTexture",void 0),E([ht("bumpTexture")],fe.prototype,"_bumpTexture",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"bumpTexture",void 0),E([ht("lightmapTexture")],fe.prototype,"_lightmapTexture",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"lightmapTexture",void 0),E([ht("refractionTexture")],fe.prototype,"_refractionTexture",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"refractionTexture",void 0),E([us("ambient")],fe.prototype,"ambientColor",void 0),E([us("diffuse")],fe.prototype,"diffuseColor",void 0),E([us("specular")],fe.prototype,"specularColor",void 0),E([us("emissive")],fe.prototype,"emissiveColor",void 0),E([I()],fe.prototype,"specularPower",void 0),E([I("useAlphaFromDiffuseTexture")],fe.prototype,"_useAlphaFromDiffuseTexture",void 0),E([ne("_markAllSubMeshesAsTexturesAndMiscDirty")],fe.prototype,"useAlphaFromDiffuseTexture",void 0),E([I("useEmissiveAsIllumination")],fe.prototype,"_useEmissiveAsIllumination",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"useEmissiveAsIllumination",void 0),E([I("linkEmissiveWithDiffuse")],fe.prototype,"_linkEmissiveWithDiffuse",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"linkEmissiveWithDiffuse",void 0),E([I("useSpecularOverAlpha")],fe.prototype,"_useSpecularOverAlpha",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"useSpecularOverAlpha",void 0),E([I("useReflectionOverAlpha")],fe.prototype,"_useReflectionOverAlpha",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"useReflectionOverAlpha",void 0),E([I("disableLighting")],fe.prototype,"_disableLighting",void 0),E([ne("_markAllSubMeshesAsLightsDirty")],fe.prototype,"disableLighting",void 0),E([I("useObjectSpaceNormalMap")],fe.prototype,"_useObjectSpaceNormalMap",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"useObjectSpaceNormalMap",void 0),E([I("useParallax")],fe.prototype,"_useParallax",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"useParallax",void 0),E([I("useParallaxOcclusion")],fe.prototype,"_useParallaxOcclusion",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"useParallaxOcclusion",void 0),E([I()],fe.prototype,"parallaxScaleBias",void 0),E([I("roughness")],fe.prototype,"_roughness",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"roughness",void 0),E([I()],fe.prototype,"indexOfRefraction",void 0),E([I()],fe.prototype,"invertRefractionY",void 0),E([I()],fe.prototype,"alphaCutOff",void 0),E([I("useLightmapAsShadowmap")],fe.prototype,"_useLightmapAsShadowmap",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"useLightmapAsShadowmap",void 0),E([tp("diffuseFresnelParameters")],fe.prototype,"_diffuseFresnelParameters",void 0),E([ne("_markAllSubMeshesAsFresnelDirty")],fe.prototype,"diffuseFresnelParameters",void 0),E([tp("opacityFresnelParameters")],fe.prototype,"_opacityFresnelParameters",void 0),E([ne("_markAllSubMeshesAsFresnelAndMiscDirty")],fe.prototype,"opacityFresnelParameters",void 0),E([tp("reflectionFresnelParameters")],fe.prototype,"_reflectionFresnelParameters",void 0),E([ne("_markAllSubMeshesAsFresnelDirty")],fe.prototype,"reflectionFresnelParameters",void 0),E([tp("refractionFresnelParameters")],fe.prototype,"_refractionFresnelParameters",void 0),E([ne("_markAllSubMeshesAsFresnelDirty")],fe.prototype,"refractionFresnelParameters",void 0),E([tp("emissiveFresnelParameters")],fe.prototype,"_emissiveFresnelParameters",void 0),E([ne("_markAllSubMeshesAsFresnelDirty")],fe.prototype,"emissiveFresnelParameters",void 0),E([I("useReflectionFresnelFromSpecular")],fe.prototype,"_useReflectionFresnelFromSpecular",void 0),E([ne("_markAllSubMeshesAsFresnelDirty")],fe.prototype,"useReflectionFresnelFromSpecular",void 0),E([I("useGlossinessFromSpecularMapAlpha")],fe.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"useGlossinessFromSpecularMapAlpha",void 0),E([I("maxSimultaneousLights")],fe.prototype,"_maxSimultaneousLights",void 0),E([ne("_markAllSubMeshesAsLightsDirty")],fe.prototype,"maxSimultaneousLights",void 0),E([I("invertNormalMapX")],fe.prototype,"_invertNormalMapX",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"invertNormalMapX",void 0),E([I("invertNormalMapY")],fe.prototype,"_invertNormalMapY",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"invertNormalMapY",void 0),E([I("twoSidedLighting")],fe.prototype,"_twoSidedLighting",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],fe.prototype,"twoSidedLighting",void 0),E([I()],fe.prototype,"useLogarithmicDepth",null),le("BABYLON.StandardMaterial",fe),ge.DefaultMaterialFactory=r=>new fe("default material",r),we.prototype.createDynamicTexture=function(r,e,t,i){const s=new zt(this,Ye.Dynamic);return s.baseWidth=r,s.baseHeight=e,t&&(r=this.needPOTTextures?we.GetExponentOfTwo(r,this._caps.maxTextureSize):r,e=this.needPOTTextures?we.GetExponentOfTwo(e,this._caps.maxTextureSize):e),s.width=r,s.height=e,s.isReady=!1,s.generateMipMaps=t,s.samplingMode=i,this.updateTextureSamplingMode(i,s),this._internalTexturesCache.push(s),s},we.prototype.updateDynamicTexture=function(r,e,t,i=!1,s,n=!1,o=!1){if(!r)return;const a=this._gl,l=a.TEXTURE_2D,c=this._bindTextureDirectly(l,r,!0,n);this._unpackFlipY(void 0===t?r.invertY:t),i&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const h=this._getWebGLTextureType(r.type),u=this._getInternalFormat(s||r.format),d=this._getRGBABufferInternalSizedFormat(r.type,u);a.texImage2D(l,0,d,u,h,e),r.generateMipMaps&&a.generateMipmap(l),c||this._bindTextureDirectly(l,null),i&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),r.isReady=!0};class ic extends U{constructor(e,t,i=null,s=!1,n=3,o=5,a){super(null,i,!s,a,n,void 0,void 0,void 0,void 0,o),this.name=e,this.wrapU=U.CLAMP_ADDRESSMODE,this.wrapV=U.CLAMP_ADDRESSMODE,this._generateMipMaps=s;const l=this._getEngine();if(!l)return;t.getContext?(this._canvas=t,this._texture=l.createDynamicTexture(t.width,t.height,s,n)):(this._canvas=l.createCanvas(1,1),this._texture=t.width||0===t.width?l.createDynamicTexture(t.width,t.height,s,n):l.createDynamicTexture(t,t,s,n));const c=this.getSize();this._canvas.width!==c.width&&(this._canvas.width=c.width),this._canvas.height!==c.height&&(this._canvas.height=c.height),this._context=this._canvas.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}_recreate(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)}scale(e){const t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)}scaleTo(e,t){const i=this.getSize();i.width=e,i.height=t,this._recreate(i)}getContext(){return this._context}clear(){const e=this.getSize();this._context.fillRect(0,0,e.width,e.height)}update(e,t=!1,i=!1){this._getEngine().updateDynamicTexture(this._texture,this._canvas,void 0===e||e,t,this._format||void 0,void 0,i)}drawText(e,t,i,s,n,o,a,l=!0){const c=this.getSize();if(o&&(this._context.fillStyle=o,this._context.fillRect(0,0,c.width,c.height)),this._context.font=s,null==t){const h=this._context.measureText(e);t=(c.width-h.width)/2}if(null==i){const h=parseInt(s.replace(/\D/g,""));i=c.height/2+h/3.65}this._context.fillStyle=n||"",this._context.fillText(e,t,i),l&&this.update(a)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new ic(this.name,t,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i}serialize(){const e=this.getScene();e&&!e.isReady()&&V.Warn("The scene must be ready before serializing the dynamic texture");const t=super.serialize();return ic._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t}static _IsCanvasElement(e){return void 0!==e.toDataURL}_rebuild(){this.update()}}j.ShadersStore.imageProcessingPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec4 result=texture2D(textureSampler,vUV);\n#ifdef IMAGEPROCESSING\n#ifndef FROMLINEARSPACE\nresult.rgb=toLinearSpace(result.rgb);\n#endif\nresult=applyImageProcessing(result);\n#else\n#ifdef FROMLINEARSPACE\nresult=applyImageProcessing(result);\n#endif\n#endif\ngl_FragColor=result;\n}";class Av extends Pe{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){e.applyByPostProcess=!0,this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e,t=!1){if(e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{let i=null;const s=this.getEngine(),n=this.getCamera();if(n)i=n.getScene();else if(s&&s.scenes){const o=s.scenes;i=o[o.length-1]}else i=be.LastCreatedScene;this._imageProcessingConfiguration=i?i.imageProcessingConfiguration:new at}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateParameters()})),t||this._updateParameters()}}get isSupported(){const e=this.getEffect();return!e||e.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e}get fromLinearSpace(){return this._fromLinearSpace}set fromLinearSpace(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())}constructor(e,t,i=null,s,n,o,a=0,l){super(e,"imageProcessing",[],[],t,i,s,n,o,null,a,"postprocess",null,!0),this._fromLinearSpace=!0,this._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:!1,TONEMAPPING_ACES:!1,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,DITHER:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1},l?(l.applyByPostProcess=!0,this._attachImageProcessingConfiguration(l,!0),this._updateParameters()):(this._attachImageProcessingConfiguration(null,!0),this.imageProcessingConfiguration.applyByPostProcess=!0),this.onApply=c=>{this.imageProcessingConfiguration.bind(c,this.aspectRatio)}}getClassName(){return"ImageProcessingPostProcess"}_updateParameters(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);let e="";for(const s in this._defines)this._defines[s]&&(e+=`#define ${s};\r\n`);const t=["textureSampler"],i=["scale"];at&&(at.PrepareSamplers(t,this._defines),at.PrepareUniforms(i,this._defines)),this.updateEffect(e,i,t)}dispose(e){super.dispose(e),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}}E([I()],Av.prototype,"_fromLinearSpace",void 0);class XE{get isFixedFoveationSupported(){return"XRWebGLLayer"==this.layerType&&"number"==typeof this.layer.fixedFoveation}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){if(this.isFixedFoveationSupported){const t=Math.max(0,Math.min(1,e||0));this.layer.fixedFoveation=t}}constructor(e,t,i,s,n){this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=s,this.createRenderTargetTextureProvider=n}}class jE{constructor(e,t){this._scene=e,this.layerWrapper=t,this._renderTargetTextures=new Array,this._engine=e.getEngine()}_createInternalTexture(e,t){const i=new zt(this._engine,Ye.Unknown,!0);return i.width=e.width,i.height=e.height,i._hardwareTexture=new lp(t,this._engine._gl),i.isReady=!0,i}_createRenderTargetTexture(e,t,i,s,n,o){if(!this._engine)throw new Error("Engine is disposed");const a={width:e,height:t},l=o?new kE(this._scene,a):new Ss("XR renderTargetTexture",a,this._scene),c=l.renderTarget;if(c._samples=l.samples,(i||!s)&&(c._framebuffer=i),s)if(o)c._colorTextureArray=s;else{const h=this._createInternalTexture(a,s);c.setTexture(h,0),l._texture=h}return n&&(o?c._depthStencilTextureArray=n:c._depthStencilTexture=this._createInternalTexture(a,n)),l.disableRescaling(),typeof XRWebGLBinding<"u"&&(l.skipInitialClear=!0),this._renderTargetTextures.push(l),l}_destroyRenderTargetTexture(e){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(e),1),e.dispose()}getFramebufferDimensions(){return this._framebufferDimensions}dispose(){this._renderTargetTextures.forEach(e=>e.dispose()),this._renderTargetTextures.length=0}}class YE extends XE{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new Zse(t.scene,this)),this.layer=e}}class Zse extends jE{constructor(e,t){super(e,t),this.layerWrapper=t,this._layer=t.layer,this._framebufferDimensions={framebufferWidth:this._layer.framebufferWidth,framebufferHeight:this._layer.framebufferHeight}}trySetViewportForView(e,t){const i=this._layer.getViewport(t);if(!i)return!1;const s=this._framebufferDimensions.framebufferWidth,n=this._framebufferDimensions.framebufferHeight;return e.x=i.x/s,e.y=i.y/n,e.width=i.width/s,e.height=i.height/n,!0}getRenderTargetTextureForEye(e){const t=this._layer.framebufferWidth,i=this._layer.framebufferHeight,s=this._layer.framebuffer;return(!this._rtt||t!==this._framebufferDimensions.framebufferWidth||i!==this._framebufferDimensions.framebufferHeight||s!==this._framebuffer)&&(this._rtt=this._createRenderTargetTexture(t,i,s),this._framebufferDimensions.framebufferWidth=t,this._framebufferDimensions.framebufferHeight=i,this._framebuffer=s),this._rtt}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}}class Rv{static GetDefaults(e){const t=new Rv;return t.canvasOptions={antialias:!0,depth:!0,stencil:!e||e.isStencilEnable,alpha:!0,framebufferScaleFactor:1},t.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",t}}class Jse{constructor(e,t=Rv.GetDefaults()){if(this._options=t,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new z,this._engine=e.scene.getEngine(),this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),t.canvasElement)this._setManagedOutputCanvas(t.canvasElement);else{const i=document.createElement("canvas");i.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(i)}e.onXRSessionInit.add(()=>{this._addCanvas()}),e.onXRSessionEnded.add(()=>{this._removeCanvas()})}dispose(){this._removeCanvas(),this._setManagedOutputCanvas(null)}initializeXRLayerAsync(e){var t=this;return Qt(function*(){const i=()=>(t.xrLayer=new XRWebGLLayer(e,t.canvasContext,t._options.canvasOptions),t._xrLayerWrapper=new YE(t.xrLayer),t.onXRLayerInitObservable.notifyObservers(t.xrLayer),t.xrLayer);return t.canvasContext.makeXRCompatible?t.canvasContext.makeXRCompatible().then(()=>{},()=>{q.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly.")}).then(()=>i()):Promise.resolve(i())})()}_addCanvas(){this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce(()=>{this._setCanvasSize(!0)})}_removeCanvas(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)}_setCanvasSize(e=!0,t=this._xrLayerWrapper){!this._canvas||!this._engine||(e?t&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=t.getWidth()+"px",this._canvas.style.height=t.getHeight()+"px"):this._engine.setSize(t.getWidth(),t.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))}_setManagedOutputCanvas(e){this._removeCanvas(),e?(this._originalCanvasSize={width:e.offsetWidth,height:e.offsetHeight},this._canvas=e,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)}}class ere extends XE{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new tre(t,this)),this.layer=e}}class tre extends jE{constructor(e,t){super(e.scene,t),this.layerWrapper=t,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=t.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}}class ire{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}initializeXRLayerAsync(e){var t=this;return Qt(function*(){return yield t._nativeRenderTarget.initializeXRLayerAsync(e),t.xrLayer=t._nativeRenderTarget.xrLayer,t.xrLayer})()}dispose(){}}class Iv{constructor(e){this.scene=e,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new z,this.onXRReferenceSpaceChanged=new z,this.onXRSessionEnded=new z,this.onXRSessionInit=new z,this.inXRFrameLoop=!1,this.inXRSession=!1,this._engine=e.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),e.onDisposeObservable.addOnce(()=>{this.dispose()})}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)}get sessionMode(){return this._sessionMode}dispose(){var e;this.inXRSession&&this.exitXRAsync(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),null===(e=this._engine)||void 0===e||e.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null}exitXRAsync(){return this.session&&this.inXRSession?(this.inXRSession=!1,this.session.end().catch(()=>{V.Warn("Could not end XR session.")})):Promise.resolve()}trySetViewportForView(e,t){var i;return(null===(i=this._baseLayerRTTProvider)||void 0===i?void 0:i.trySetViewportForView(e,t))||!1}getRenderTargetTextureForEye(e){var t;return(null===(t=this._baseLayerRTTProvider)||void 0===t?void 0:t.getRenderTargetTextureForEye(e))||null}getRenderTargetTextureForView(e){var t;return(null===(t=this._baseLayerRTTProvider)||void 0===t?void 0:t.getRenderTargetTextureForView(e))||null}getWebXRRenderTarget(e){const t=this.scene.getEngine();return this._xrNavigator.xr.native?new ire(this):((e=e||Rv.GetDefaults(t)).canvasElement=e.canvasElement||t.getRenderingCanvas()||void 0,new Jse(this,e))}initializeAsync(){return this._xrNavigator=navigator,this._xrNavigator.xr?Promise.resolve():Promise.reject("WebXR not available")}initializeSessionAsync(e="immersive-vr",t={}){return this._xrNavigator.xr.requestSession(e,t).then(i=>(this.session=i,this._sessionMode=e,this.onXRSessionInit.notifyObservers(i),this.inXRSession=!0,this.session.addEventListener("end",()=>{var s;this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this._engine&&(this._engine.framebufferDimensionsObject=null,this._engine.restoreDefaultFramebuffer(),this._engine.customAnimationFrameRequester=null,this._engine._renderLoop()),this.isNative&&(null===(s=this._baseLayerRTTProvider)||void 0===s||s.dispose()),this._baseLayerRTTProvider=null,this._baseLayerWrapper=null},{once:!0}),this.session))}isSessionSupportedAsync(e){return Iv.IsSessionSupportedAsync(e)}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){var e;!this.inXRSession||!this._engine||(this._engine.customAnimationFrameRequester={requestAnimationFrame:this.session.requestAnimationFrame.bind(this.session),renderFunction:(t,i)=>{var s;!this.inXRSession||!this._engine||(this.currentFrame=i,this.currentTimestamp=t,i&&(this.inXRFrameLoop=!0,this._engine.framebufferDimensionsObject=(null===(s=this._baseLayerRTTProvider)||void 0===s?void 0:s.getFramebufferDimensions())||null,this.onXRFrameObservable.notifyObservers(i),this._engine._renderLoop(),this._engine.framebufferDimensionsObject=null,this.inXRFrameLoop=!1))}},this._engine.framebufferDimensionsObject=(null===(e=this._baseLayerRTTProvider)||void 0===e?void 0:e.getFramebufferDimensions())||null,typeof window<"u"&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())}setReferenceSpaceTypeAsync(e="local-floor"){return this.session.requestReferenceSpace(e).then(t=>t,t=>(V.Error("XR.requestReferenceSpace failed for the following reason: "),V.Error(t),V.Log('Defaulting to universally-supported "viewer" reference space type.'),this.session.requestReferenceSpace("viewer").then(i=>{const s=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return i.getOffsetReferenceSpace(s)},i=>{throw V.Error(i),'XR initialization failed: required "viewer" reference space type not supported.'}))).then(t=>this.session.requestReferenceSpace("viewer").then(i=>(this.viewerReferenceSpace=i,t))).then(t=>(this.referenceSpace=this.baseReferenceSpace=t,this.referenceSpace))}updateRenderStateAsync(e){return Promise.resolve(this.session.updateRenderState(e))}_setBaseLayerWrapper(e){var t,i;this.isNative&&(null===(t=this._baseLayerRTTProvider)||void 0===t||t.dispose()),this._baseLayerWrapper=e,this._baseLayerRTTProvider=(null===(i=this._baseLayerWrapper)||void 0===i?void 0:i.createRenderTargetTextureProvider(this))||null}updateRenderState(e){e.baseLayer&&this._setBaseLayerWrapper(this.isNative?new ere(e.baseLayer):new YE(e.baseLayer)),this.session.updateRenderState(e)}static IsSessionSupportedAsync(e){if(!navigator.xr)return Promise.resolve(!1);const t=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return t?t.call(navigator.xr,e).then(i=>Promise.resolve(typeof i>"u"||i)).catch(i=>(V.Warn(i),Promise.resolve(!1))):Promise.resolve(!1)}get isNative(){var e;return null!==(e=this._xrNavigator.xr.native)&&void 0!==e&&e}get currentFrameRate(){var e;return null===(e=this.session)||void 0===e?void 0:e.frameRate}get supportedFrameRates(){var e;return null===(e=this.session)||void 0===e?void 0:e.supportedFrameRates}updateTargetFrameRate(e){return this.session.updateTargetFrameRate(e)}runInXRFrame(e,t=!0){this.inXRFrameLoop?e():(this.inXRSession||!t)&&this.onXRFrameObservable.addOnce(e)}get isFixedFoveationSupported(){var e;return(null===(e=this._baseLayerWrapper)||void 0===e?void 0:e.isFixedFoveationSupported)||!1}get fixedFoveation(){var e;return(null===(e=this._baseLayerWrapper)||void 0===e?void 0:e.fixedFoveation)||null}set fixedFoveation(e){const t=Math.max(0,Math.min(1,e||0));this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=t)}}var rs=(()=>{return(r=rs||(rs={}))[r.ENTERING_XR=0]="ENTERING_XR",r[r.EXITING_XR=1]="EXITING_XR",r[r.IN_XR=2]="IN_XR",r[r.NOT_IN_XR=3]="NOT_IN_XR",rs;var r})(),mh=(()=>{return(r=mh||(mh={}))[r.NOT_TRACKING=0]="NOT_TRACKING",r[r.TRACKING_LOST=1]="TRACKING_LOST",r[r.TRACKING=2]="TRACKING",mh;var r})();function L2(r){const e=r.height||2;let t=0===r.diameterTop?0:r.diameterTop||r.diameter||1,i=0===r.diameterBottom?0:r.diameterBottom||r.diameter||1;t=t||1e-5,i=i||1e-5;const s=r.tessellation||24,n=r.subdivisions||1,o=!!r.hasRings,a=!!r.enclose,l=0===r.cap?0:r.cap||G.CAP_ALL,c=r.arc&&(r.arc<=0||r.arc>1)?1:r.arc||1,h=0===r.sideOrientation?0:r.sideOrientation||ue.DEFAULTSIDE,u=r.faceUV||new Array(3),d=r.faceColors,_=2+(1+(1!==c&&a?2:0))*(o?n:1);let m;for(m=0;m<_;m++)d&&void 0===d[m]&&(d[m]=new Te(1,1,1,1));for(m=0;m<_;m++)u&&void 0===u[m]&&(u[m]=new vt(0,0,1,1));const g=new Array,b=new Array,y=new Array,T=new Array,x=new Array,S=2*Math.PI*c/s;let C,D,P;const M=(i-t)/2/e,w=v.Zero(),k=v.Zero(),X=v.Zero(),te=v.Zero(),J=v.Zero(),Q=fs.Y;let me,ae,W,K=1,O=1,H=0,Y=0;for(me=0;me<=n;me++)for(D=me/n,P=(D*(t-i)+i)/2,K=o&&0!==me&&me!==n?2:1,W=0;W<K;W++){for(o&&(O+=W),a&&(O+=2*W),ae=0;ae<=s;ae++)C=ae*S,w.x=Math.cos(-C)*P,w.y=-e/2+D*e,w.z=Math.sin(-C)*P,0===t&&me===n?(k.x=y[y.length-3*(s+1)],k.y=y[y.length-3*(s+1)+1],k.z=y[y.length-3*(s+1)+2]):(k.x=w.x,k.z=w.z,k.y=Math.sqrt(k.x*k.x+k.z*k.z)*M,k.normalize()),0===ae&&(X.copyFrom(w),te.copyFrom(k)),b.push(w.x,w.y,w.z),y.push(k.x,k.y,k.z),Y=o?H!==O?u[O].y:u[O].w:u[O].y+(u[O].w-u[O].y)*D,T.push(u[O].x+(u[O].z-u[O].x)*ae/s,It.UseOpenGLOrientationForUV?1-Y:Y),d&&x.push(d[O].r,d[O].g,d[O].b,d[O].a);1!==c&&a&&(b.push(w.x,w.y,w.z),b.push(0,w.y,0),b.push(0,w.y,0),b.push(X.x,X.y,X.z),v.CrossToRef(Q,k,J),J.normalize(),y.push(J.x,J.y,J.z,J.x,J.y,J.z),v.CrossToRef(te,Q,J),J.normalize(),y.push(J.x,J.y,J.z,J.x,J.y,J.z),Y=o?H!==O?u[O+1].y:u[O+1].w:u[O+1].y+(u[O+1].w-u[O+1].y)*D,T.push(u[O+1].x,It.UseOpenGLOrientationForUV?1-Y:Y),T.push(u[O+1].z,It.UseOpenGLOrientationForUV?1-Y:Y),Y=o?H!==O?u[O+2].y:u[O+2].w:u[O+2].y+(u[O+2].w-u[O+2].y)*D,T.push(u[O+2].x,It.UseOpenGLOrientationForUV?1-Y:Y),T.push(u[O+2].z,It.UseOpenGLOrientationForUV?1-Y:Y),d&&(x.push(d[O+1].r,d[O+1].g,d[O+1].b,d[O+1].a),x.push(d[O+1].r,d[O+1].g,d[O+1].b,d[O+1].a),x.push(d[O+2].r,d[O+2].g,d[O+2].b,d[O+2].a),x.push(d[O+2].r,d[O+2].g,d[O+2].b,d[O+2].a))),H!==O&&(H=O)}const he=1!==c&&a?s+4:s;for(me=0,O=0;O<n;O++){let se=0,_e=0,rt=0,Ze=0;for(ae=0;ae<s;ae++)se=me*(he+1)+ae,_e=(me+1)*(he+1)+ae,rt=me*(he+1)+(ae+1),Ze=(me+1)*(he+1)+(ae+1),g.push(se,_e,rt),g.push(Ze,rt,_e);1!==c&&a&&(g.push(se+2,_e+2,rt+2),g.push(Ze+2,rt+2,_e+2),g.push(se+4,_e+4,rt+4),g.push(Ze+4,rt+4,_e+4)),me=o?me+2:me+1}const Le=se=>{const _e=se?t/2:i/2;if(0===_e)return;let rt,Ze,Ae;const Ie=se?u[_-1]:u[0];let ct=null;d&&(ct=se?d[_-1]:d[0]);const Ct=b.length/3,Mt=se?e/2:-e/2,Ke=new v(0,Mt,0);b.push(Ke.x,Ke.y,Ke.z),y.push(0,se?1:-1,0);const as=Ie.y+.5*(Ie.w-Ie.y);T.push(Ie.x+.5*(Ie.z-Ie.x),It.UseOpenGLOrientationForUV?1-as:as),ct&&x.push(ct.r,ct.g,ct.b,ct.a);const Xi=new de(.5,.5);for(Ae=0;Ae<=s;Ae++){rt=2*Math.PI*Ae*c/s;const gr=Math.cos(-rt),ri=Math.sin(-rt);Ze=new v(gr*_e,Mt,ri*_e);const ni=new de(gr*Xi.x+.5,ri*Xi.y+.5);b.push(Ze.x,Ze.y,Ze.z),y.push(0,se?1:-1,0);const bi=Ie.y+(Ie.w-Ie.y)*ni.y;T.push(Ie.x+(Ie.z-Ie.x)*ni.x,It.UseOpenGLOrientationForUV?1-bi:bi),ct&&x.push(ct.r,ct.g,ct.b,ct.a)}for(Ae=0;Ae<s;Ae++)se?(g.push(Ct),g.push(Ct+(Ae+2)),g.push(Ct+(Ae+1))):(g.push(Ct),g.push(Ct+(Ae+1)),g.push(Ct+(Ae+2)))};(l===G.CAP_START||l===G.CAP_ALL)&&Le(!1),(l===G.CAP_END||l===G.CAP_ALL)&&Le(!0),ue._ComputeSides(h,b,g,y,T,r.frontUVs,r.backUVs);const Fe=new ue;return Fe.indices=g,Fe.positions=b,Fe.normals=y,Fe.uvs=T,d&&(Fe.colors=x),Fe}function sc(r,e={},t){const i=new G(r,t);return e.sideOrientation=G._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,L2(e).applyToMesh(i,e.updatable),i}function B2(r){const e=[],t=[],i=[],s=[],n=r.diameter||1,o=r.thickness||.5,a=r.tessellation||16,l=0===r.sideOrientation?0:r.sideOrientation||ue.DEFAULTSIDE,c=a+1;for(let u=0;u<=a;u++){const d=u/a,f=u*Math.PI*2/a-Math.PI/2,p=F.Translation(n/2,0,0).multiply(F.RotationY(f));for(let _=0;_<=a;_++){const m=1-_/a,g=_*Math.PI*2/a+Math.PI,b=Math.cos(g),y=Math.sin(g);let T=new v(b,y,0),x=T.scale(o/2);const S=new de(d,m);x=v.TransformCoordinates(x,p),T=v.TransformNormal(T,p),t.push(x.x,x.y,x.z),i.push(T.x,T.y,T.z),s.push(S.x,It.UseOpenGLOrientationForUV?1-S.y:S.y);const C=(u+1)%c,D=(_+1)%c;e.push(u*c+_),e.push(u*c+D),e.push(C*c+_),e.push(u*c+D),e.push(C*c+D),e.push(C*c+_)}}ue._ComputeSides(l,t,e,i,s,r.frontUVs,r.backUVs);const h=new ue;return h.indices=e,h.positions=t,h.normals=i,h.uvs=s,h}function pa(r,e={},t){const i=new G(r,t);return e.sideOrientation=G._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,B2(e).applyToMesh(i,e.updatable),i}ue.CreateCylinder=L2,G.CreateCylinder=(r,e,t,i,s,n,o,a,l)=>((void 0===o||!(o instanceof ge))&&(void 0!==o&&(l=a||G.DEFAULTSIDE,a=o),o=n,n=1),sc(r,{height:e,diameterTop:t,diameterBottom:i,tessellation:s,subdivisions:n,sideOrientation:l,updatable:a},o)),ue.CreateTorus=B2,G.CreateTorus=(r,e,t,i,s,n,o)=>pa(r,{diameter:e,thickness:t,tessellation:i,sideOrientation:o,updatable:n},s),G._GroundMeshParser=(r,e)=>Sp.Parse(r,e);class Sp extends G{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e),this.createOrUpdateSubmeshesOctree&&this.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){const i=this.getWorldMatrix(),s=L.Matrix[5];i.invertToRef(s);const n=L.Vector3[8];if(v.TransformCoordinatesFromFloatsToRef(e,0,t,s,n),t=n.z,(e=n.x)<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;(!this._heightQuads||0==this._heightQuads.length)&&(this._initHeightQuads(),this._computeHeightQuads());const o=this._getFacetAt(e,t);return v.TransformCoordinatesFromFloatsToRef(0,-(o.x*e+o.z*t+o.w)/o.y,0,i,n),n.y}getNormalAtCoordinates(e,t){const i=new v(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){const s=this.getWorldMatrix(),n=L.Matrix[5];s.invertToRef(n);const o=L.Vector3[8];if(v.TransformCoordinatesFromFloatsToRef(e,0,t,n,o),t=o.z,(e=o.x)<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;(!this._heightQuads||0==this._heightQuads.length)&&(this._initHeightQuads(),this._computeHeightQuads());const a=this._getFacetAt(e,t);return v.TransformNormalFromFloatsToRef(a.x,a.y,a.z,s,i),this}updateCoordinateHeights(){return(!this._heightQuads||0==this._heightQuads.length)&&this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){const i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),s=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),n=this._heightQuads[s*this._subdivisionsX+i];let o;return o=t<n.slope.x*e+n.slope.y?n.facet1:n.facet2,o}_initHeightQuads(){const e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=new Array;for(let i=0;i<t;i++)for(let s=0;s<e;s++){const n={slope:de.Zero(),facet1:new vt(0,0,0,0),facet2:new vt(0,0,0,0)};this._heightQuads[i*e+s]=n}return this}_computeHeightQuads(){const e=this.getVerticesData(A.PositionKind);if(!e)return this;const t=L.Vector3[3],i=L.Vector3[2],s=L.Vector3[1],n=L.Vector3[0],o=L.Vector3[4],a=L.Vector3[5],l=L.Vector3[6],c=L.Vector3[7],h=L.Vector3[8];let u=0,d=0,f=0,p=0,_=0,m=0,g=0;const b=this._subdivisionsX,y=this._subdivisionsY;for(let T=0;T<y;T++)for(let x=0;x<b;x++){u=3*x,d=T*(b+1)*3,f=(T+1)*(b+1)*3,t.x=e[d+u],t.y=e[d+u+1],t.z=e[d+u+2],i.x=e[d+u+3],i.y=e[d+u+4],i.z=e[d+u+5],s.x=e[f+u],s.y=e[f+u+1],s.z=e[f+u+2],n.x=e[f+u+3],n.y=e[f+u+4],n.z=e[f+u+5],p=(n.z-t.z)/(n.x-t.x),_=t.z-p*t.x,i.subtractToRef(t,o),s.subtractToRef(t,a),n.subtractToRef(t,l),v.CrossToRef(l,a,c),v.CrossToRef(o,l,h),c.normalize(),h.normalize(),m=-(c.x*t.x+c.y*t.y+c.z*t.z),g=-(h.x*i.x+h.y*i.y+h.z*i.z);const S=this._heightQuads[T*b+x];S.slope.copyFromFloats(p,_),S.facet1.copyFromFloats(c.x,c.y,c.z,m),S.facet2.copyFromFloats(h.x,h.y,h.z,g)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){const i=new Sp(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}}function V2(r){const e=[],t=[],i=[],s=[];let n,o;const a=r.width||1,l=r.height||1,c=r.subdivisionsX||r.subdivisions||1,h=r.subdivisionsY||r.subdivisions||1;for(n=0;n<=h;n++)for(o=0;o<=c;o++){const d=new v(o*a/c-a/2,0,(h-n)*l/h-l/2),f=new v(0,1,0);t.push(d.x,d.y,d.z),i.push(f.x,f.y,f.z),s.push(o/c,It.UseOpenGLOrientationForUV?n/h:1-n/h)}for(n=0;n<h;n++)for(o=0;o<c;o++)e.push(o+1+(n+1)*(c+1)),e.push(o+1+n*(c+1)),e.push(o+n*(c+1)),e.push(o+(n+1)*(c+1)),e.push(o+1+(n+1)*(c+1)),e.push(o+n*(c+1));const u=new ue;return u.indices=e,u.positions=t,u.normals=i,u.uvs=s,u}function U2(r){const e=null!=r.xmin?r.xmin:-1,t=null!=r.zmin?r.zmin:-1,i=null!=r.xmax?r.xmax:1,s=null!=r.zmax?r.zmax:1,n=r.subdivisions||{w:1,h:1},o=r.precision||{w:1,h:1},a=new Array,l=new Array,c=new Array,h=new Array;let u,d,f,p;n.h=n.h<1?1:n.h,n.w=n.w<1?1:n.w,o.w=o.w<1?1:o.w,o.h=o.h<1?1:o.h;const __w=(i-e)/n.w,__h=(s-t)/n.h;function m(b,y,T,x){const S=l.length/3,C=o.w+1;for(u=0;u<o.h;u++)for(d=0;d<o.w;d++){const M=[S+d+u*C,S+(d+1)+u*C,S+(d+1)+(u+1)*C,S+d+(u+1)*C];a.push(M[1]),a.push(M[2]),a.push(M[3]),a.push(M[0]),a.push(M[1]),a.push(M[3])}const D=v.Zero(),P=new v(0,1,0);for(u=0;u<=o.h;u++)for(D.z=u*(x-y)/o.h+y,d=0;d<=o.w;d++)D.x=d*(T-b)/o.w+b,D.y=0,l.push(D.x,D.y,D.z),c.push(P.x,P.y,P.z),h.push(d/o.w,u/o.h)}for(f=0;f<n.h;f++)for(p=0;p<n.w;p++)m(e+p*__w,t+f*__h,e+(p+1)*__w,t+(f+1)*__h);const g=new ue;return g.indices=a,g.positions=l,g.normals=c,g.uvs=h,g}function k2(r){const e=[],t=[],i=[],s=[];let n,o;const a=r.colorFilter||new re(.3,.59,.11),l=r.alphaFilter||0;let c=!1;if(r.minHeight>r.maxHeight){c=!0;const u=r.maxHeight;r.maxHeight=r.minHeight,r.minHeight=u}for(n=0;n<=r.subdivisions;n++)for(o=0;o<=r.subdivisions;o++){const u=new v(o*r.width/r.subdivisions-r.width/2,0,(r.subdivisions-n)*r.height/r.subdivisions-r.height/2),p=4*(((u.x+r.width/2)/r.width*(r.bufferWidth-1)|0)+((1-(u.z+r.height/2)/r.height)*(r.bufferHeight-1)|0)*r.bufferWidth);let _=r.buffer[p]/255,m=r.buffer[p+1]/255,g=r.buffer[p+2]/255;c&&(_=1-_,m=1-m,g=1-g);const y=_*a.r+m*a.g+g*a.b;u.y=r.buffer[p+3]/255>=l?r.minHeight+(r.maxHeight-r.minHeight)*y:r.minHeight-ot,t.push(u.x,u.y,u.z),i.push(0,0,0),s.push(o/r.subdivisions,1-n/r.subdivisions)}for(n=0;n<r.subdivisions;n++)for(o=0;o<r.subdivisions;o++){const u=o+1+(n+1)*(r.subdivisions+1),d=o+1+n*(r.subdivisions+1),f=o+n*(r.subdivisions+1),p=o+(n+1)*(r.subdivisions+1),_=t[3*u+1]>=r.minHeight,m=t[3*d+1]>=r.minHeight,g=t[3*f+1]>=r.minHeight;_&&m&&g&&(e.push(u),e.push(d),e.push(f)),t[3*p+1]>=r.minHeight&&_&&g&&(e.push(p),e.push(u),e.push(f))}ue.ComputeNormals(t,e,i);const h=new ue;return h.indices=e,h.positions=t,h.normals=i,h.uvs=s,h}function Ep(r,e={},t){const i=new Sp(r,t);return i._setReady(!1),i._subdivisionsX=e.subdivisionsX||e.subdivisions||1,i._subdivisionsY=e.subdivisionsY||e.subdivisions||1,i._width=e.width||1,i._height=e.height||1,i._maxX=i._width/2,i._maxZ=i._height/2,i._minX=-i._maxX,i._minZ=-i._maxZ,V2(e).applyToMesh(i,e.updatable),i._setReady(!0),i}function qE(r,e,t=null){const i=new G(r,t);return U2(e).applyToMesh(i,e.updatable),i}function $E(r,e,t={},i=null){const s=t.width||10,n=t.height||10,o=t.subdivisions||1,a=t.minHeight||0,l=t.maxHeight||1,c=t.colorFilter||new re(.3,.59,.11),h=t.alphaFilter||0,u=t.updatable,d=t.onReady,f=new Sp(r,i=i||be.LastCreatedScene);return f._subdivisionsX=o,f._subdivisionsY=o,f._width=s,f._height=n,f._maxX=f._width/2,f._maxZ=f._height/2,f._minX=-f._maxX,f._minZ=-f._maxZ,f._setReady(!1),q.LoadImage(e,_=>{const m=_.width,g=_.height;if(i.isDisposed)return;const b=i?.getEngine().resizeImageBitmap(_,m,g);k2({width:s,height:n,subdivisions:o,minHeight:a,maxHeight:l,colorFilter:c,buffer:b,bufferWidth:m,bufferHeight:g,alphaFilter:h}).applyToMesh(f,u),d&&d(f),f._setReady(!0)},()=>{},i.offlineProvider),f}ue.CreateGround=V2,ue.CreateTiledGround=U2,ue.CreateGroundFromHeightMap=k2,G.CreateGround=(r,e,t,i,s,n)=>Ep(r,{width:e,height:t,subdivisions:i,updatable:n},s),G.CreateTiledGround=(r,e,t,i,s,n,o,a,l)=>qE(r,{xmin:e,zmin:t,xmax:i,zmax:s,subdivisions:n,precision:o,updatable:l},a),G.CreateGroundFromHeightMap=(r,e,t,i,s,n,o,a,l,c,h)=>$E(r,e,{width:t,height:i,subdivisions:s,minHeight:n,maxHeight:o,updatable:l,onReady:c,alphaFilter:h},a);let G2=(()=>{class r{constructor(t,i=null){if(this.scene=t,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=r._IdCounter++,i)this._gazeTracker=i.clone("gazeTracker");else{this._gazeTracker=pa("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},t),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;const s=new fe("targetMat",t);s.specularColor=re.Black(),s.emissiveColor=new re(.7,.7,.7),s.backFaceCulling=!1,this._gazeTracker.material=s}}_getForwardRay(t){return new Qe(v.Zero(),new v(0,0,t))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(t=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}return r._IdCounter=0,r})();class sre extends G2{constructor(e,t,i){super(t,i),this.webVRController=e,this._laserPointer=sc("laserPointer",{updatable:!1,height:1,diameterTop:.004,diameterBottom:2e-4,tessellation:20,subdivisions:1},t);const s=new fe("laserPointerMat",t);if(s.emissiveColor=new re(.7,.7,.7),s.alpha=.6,this._laserPointer.material=s,this._laserPointer.rotation.x=Math.PI/2,this._laserPointer.position.z=-.5,this._laserPointer.isVisible=!1,this._laserPointer.isPickable=!1,!e.mesh){const n=new G("preloadControllerMesh",t),o=new G(Sv.POINTING_POSE,t);o.rotation.x=-.7,n.addChild(o),e.attachToMesh(n)}this._setLaserPointerParent(e.mesh),this._meshAttachedObserver=e._meshAttachedObservable.add(n=>{this._setLaserPointerParent(n)})}_getForwardRay(e){return this.webVRController.getForwardRay(e)}_activatePointer(){super._activatePointer(),this._laserPointer.isVisible=!0}_deactivatePointer(){super._deactivatePointer(),this._laserPointer.isVisible=!1}_setLaserPointerColor(e){this._laserPointer.material.emissiveColor=e}_setLaserPointerLightingDisabled(e){this._laserPointer.material.disableLighting=e}_setLaserPointerParent(e){const t=n=>{n.isPickable=!1,n.getChildMeshes().forEach(o=>{t(o)})};t(e);const i=e.getChildren(void 0,!1);let s=e;this.webVRController._pointingPoseNode=null;for(let n=0;n<i.length;n++)if(i[n].name&&i[n].name.indexOf(Sv.POINTING_POSE)>=0){s=i[n],this.webVRController._pointingPoseNode=s;break}this._laserPointer.parent=s}_updatePointerDistance(e=100){this._laserPointer.scaling.y=e,this._laserPointer.position.z=-e/2}dispose(){super.dispose(),this._laserPointer.dispose(),this._meshAttachedObserver&&this.webVRController._meshAttachedObservable.remove(this._meshAttachedObserver)}}class z2 extends G2{constructor(e,t){super(t),this._getCamera=e}_getForwardRay(e){const t=this._getCamera();return t?t.getForwardRay(e):new Qe(v.Zero(),v.Forward())}}let rre=(()=>{class r{get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get onControllerMeshLoaded(){return this.onControllerMeshLoadedObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(t){t&&(t.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=t)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(t){t&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._leftController&&this._leftController._gazeTracker&&this._leftController._gazeTracker.dispose(),this._rightController&&this._rightController._gazeTracker&&this._rightController._gazeTracker.dispose(),this._cameraGazer._gazeTracker=t,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker",this._leftController&&(this._leftController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")),this._rightController&&(this._rightController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")))}get leftControllerGazeTrackerMesh(){return this._leftController?this._leftController._gazeTracker:null}get rightControllerGazeTrackerMesh(){return this._rightController?this._rightController._gazeTracker:null}get displayGaze(){return this._displayGaze}set displayGaze(t){this._displayGaze=t,t||(this._cameraGazer._gazeTracker.isVisible=!1,this._leftController&&(this._leftController._gazeTracker.isVisible=!1),this._rightController&&(this._rightController._gazeTracker.isVisible=!1))}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(t){this._displayLaserPointer=t,t?(this._rightController&&this._rightController._activatePointer(),this._leftController&&this._leftController._activatePointer()):(this._rightController&&(this._rightController._deactivatePointer(),this._rightController._gazeTracker.isVisible=!1),this._leftController&&(this._leftController._deactivatePointer(),this._leftController._gazeTracker.isVisible=!1))}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._webVRready?this._webVRCamera:this._scene.activeCamera}get webVRCamera(){return this._webVRCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated||null!==this._leftController&&this._leftController._teleportationRequestInitiated||null!==this._rightController&&this._rightController._teleportationRequestInitiated}constructor(t,i={}){if(this.webVROptions=i,this._webVRsupported=!1,this._webVRready=!1,this._webVRrequesting=!1,this._webVRpresenting=!1,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new z,this.onAfterEnteringVRObservable=new z,this.onExitingVRObservable=new z,this.onControllerMeshLoadedObservable=new z,this._useCustomVRButton=!1,this._teleportationRequested=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=r.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new v(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new v(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._leftController=null,this._rightController=null,this._gazeColor=new re(.7,.7,.7),this._laserColor=new re(.7,.7,.7),this._pickedLaserColor=new re(.2,.2,1),this._pickedGazeColor=new re(0,0,1),this.onNewMeshSelected=new z,this.onMeshSelectedWithController=new z,this.onNewMeshPicked=new z,this.onBeforeCameraTeleport=new z,this.onAfterCameraTeleport=new z,this.onSelectedMeshUnselected=new z,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._interactionsRequested=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight(),this._fullscreenVRpresenting&&this._webVRready&&this.exitVR()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._leftController&&this._leftController._activePointer&&this._castRayAndSelectObject(this._leftController),this._rightController&&this._rightController._activePointer&&this._castRayAndSelectObject(this._rightController),this._noControllerIsActive&&(this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock)?this._castRayAndSelectObject(this._cameraGazer):this._cameraGazer._gazeTracker.isVisible=!1},this._onNewGamepadConnected=n=>{if(n.type!==ar.POSE_ENABLED)n.leftStick&&n.onleftstickchanged(o=>{this._teleportationInitialized&&this.teleportationEnabled&&(!this._leftController&&!this._rightController||this._leftController&&!this._leftController._activePointer&&this._rightController&&!this._rightController._activePointer)&&(this._checkTeleportWithRay(o,this._cameraGazer),this._checkTeleportBackwards(o,this._cameraGazer))}),n.rightStick&&n.onrightstickchanged(o=>{this._teleportationInitialized&&this._checkRotate(o,this._cameraGazer)}),n.type===ar.XBOX&&(n.onbuttondown(o=>{this._interactionsEnabled&&o===en.A&&this._cameraGazer._selectionPointerDown()}),n.onbuttonup(o=>{this._interactionsEnabled&&o===en.A&&this._cameraGazer._selectionPointerUp()}));else{const o=n,a=new sre(o,this._scene,this._cameraGazer._gazeTracker);"right"===o.hand||this._leftController&&this._leftController.webVRController!=o?this._rightController=a:this._leftController=a,this._tryEnableInteractionOnController(a)}},this._tryEnableInteractionOnController=n=>{this._interactionsRequested&&!n._interactionsEnabled&&this._enableInteractionOnController(n),this._teleportationRequested&&!n._teleportationEnabled&&this._enableTeleportationOnController(n)},this._onNewGamepadDisconnected=n=>{n instanceof ph&&("left"===n.hand&&null!=this._leftController&&(this._leftController.dispose(),this._leftController=null),"right"===n.hand&&null!=this._rightController&&(this._rightController.dispose(),this._rightController=null))},this._workingVector=v.Zero(),this._workingQuaternion=Z.Identity(),this._workingMatrix=F.Identity(),V.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=t,this._inputElement=t.getEngine().getInputElement(),!("getVRDisplays"in navigator)&&void 0===i.useXR&&(i.useXR=!0),void 0===i.createFallbackVRDeviceOrientationFreeCamera&&(i.createFallbackVRDeviceOrientationFreeCamera=!0),void 0===i.createDeviceOrientationCamera&&(i.createDeviceOrientationCamera=!0),void 0===i.laserToggle&&(i.laserToggle=!0),void 0===i.defaultHeight&&(i.defaultHeight=1.7),i.useCustomVRButton&&(this._useCustomVRButton=!0,i.customVRButton&&(this._btnVR=i.customVRButton)),i.rayLength&&(this._rayLength=i.rayLength),this._defaultHeight=i.defaultHeight,i.positionScale&&(this._rayLength*=i.positionScale,this._defaultHeight*=i.positionScale),this._hasEnteredVR=!1,this._position=this._scene.activeCamera?this._scene.activeCamera.position.clone():new v(0,this._defaultHeight,0),i.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new VE("deviceOrientationVRHelper",this._position.clone(),t),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof Gi&&this._scene.activeCamera.rotation)){const n=this._scene.activeCamera;this._deviceOrientationCamera.rotationQuaternion.copyFrom(n.rotationQuaternion?n.rotationQuaternion:Z.RotationYawPitchRoll(n.rotation.y,n.rotation.x,n.rotation.z)),this._deviceOrientationCamera.rotation=n.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?Iv.IsSessionSupportedAsync("immersive-vr").then(n=>{n?(V.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),t.createDefaultXRExperienceAsync({floorMeshes:i.floorMeshes||[]}).then(o=>{this.xr=o,this.xrTestDone=!0,this._cameraGazer=new z2(()=>this.xr.baseExperience.camera,t),this.xr.baseExperience.onStateChangedObservable.add(a=>{switch(a){case rs.ENTERING_XR:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case rs.EXITING_XR:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case rs.IN_XR:this._hasEnteredVR=!0;break;case rs.NOT_IN_XR:this._hasEnteredVR=!1}})})):this._completeVRInit(t,i)}):this._completeVRInit(t,i)}_completeVRInit(t,i){if(this.xrTestDone=!0,i.createFallbackVRDeviceOrientationFreeCamera&&(i.useMultiview&&(i.vrDeviceOrientationCameraMetrics||(i.vrDeviceOrientationCameraMetrics=fh.GetDefault()),i.vrDeviceOrientationCameraMetrics.multiviewEnabled=!0),this._vrDeviceOrientationCamera=new zE("VRDeviceOrientationVRHelper",this._position,this._scene,!0,i.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._webVRCamera=new HE("WebVRHelper",this._position,this._scene,i),this._webVRCamera.useStandingMatrix(),this._cameraGazer=new z2(()=>this.currentVRCamera,t),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";let o=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";o+=".babylonVRicon.vrdisplaypresenting { display: none; }";const a=document.createElement("style");a.appendChild(document.createTextNode(o)),document.getElementsByTagName("head")[0].appendChild(a),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",()=>{this.isInVRMode?this._scene.getEngine().disableVR():this.enterVR()});const s=this._scene.getEngine().getHostWindow();!s||(s.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),i.createFallbackVRDeviceOrientationFreeCamera?this._displayVRButton():this._scene.getEngine().onVRDisplayChangedObservable.add(n=>{n.vrDisplay&&this._displayVRButton()}),this._onKeyDown=n=>{27===n.keyCode&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add(()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())},Re.POINTERDOUBLETAP,!1),this._onVRDisplayChangedBind=n=>this._onVRDisplayChanged(n),this._onVrDisplayPresentChangeBind=()=>this._onVrDisplayPresentChange(),this._onVRRequestPresentStart=()=>{this._webVRrequesting=!0,this._updateButtonVisibility()},this._onVRRequestPresentComplete=()=>{this._webVRrequesting=!1,this._updateButtonVisibility()},t.getEngine().onVRDisplayChangedObservable.add(this._onVRDisplayChangedBind),t.getEngine().onVRRequestPresentStart.add(this._onVRRequestPresentStart),t.getEngine().onVRRequestPresentComplete.add(this._onVRRequestPresentComplete),s.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),t.onDisposeObservable.add(()=>{this.dispose()}),this._webVRCamera.onControllerMeshLoadedObservable.add(n=>this._onDefaultMeshLoaded(n)),this._scene.gamepadManager.onGamepadConnectedObservable.add(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.add(this._onNewGamepadDisconnected),this._updateButtonVisibility(),this._circleEase=new qie,this._circleEase.setEasingMode(Bo.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,t.onPointerObservable.add(n=>{this._interactionsEnabled&&t.activeCamera===this.vrDeviceOrientationCamera&&"mouse"===n.event.pointerType&&(n.type===Re.POINTERDOWN?this._cameraGazer._selectionPointerDown():n.type===Re.POINTERUP&&this._cameraGazer._selectionPointerUp())}),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}_onDefaultMeshLoaded(t){this._leftController&&this._leftController.webVRController==t&&t.mesh&&this._leftController._setLaserPointerParent(t.mesh),this._rightController&&this._rightController.webVRController==t&&t.mesh&&this._rightController._setLaserPointerParent(t.mesh);try{this.onControllerMeshLoadedObservable.notifyObservers(t)}catch(i){V.Warn("Error in your custom logic onControllerMeshLoaded: "+i)}}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&this.xr.baseExperience.state===rs.IN_XR||this._webVRpresenting||this._fullscreenVRpresenting}_onVrDisplayPresentChange(){const t=this._scene.getEngine().getVRDevice();if(t){const i=this._webVRpresenting;this._webVRpresenting=t.isPresenting,i&&!this._webVRpresenting&&this.exitVR()}else V.Warn("Detected VRDisplayPresentChange on an unknown VRDisplay. Did you can enterVR on the vrExperienceHelper?");this._updateButtonVisibility()}_onVRDisplayChanged(t){this._webVRsupported=t.vrSupported,this._webVRready=!!t.vrDisplay,this._webVRpresenting=t.vrDisplay&&t.vrDisplay.isPresenting,this._updateButtonVisibility()}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){const t=this._inputElement.getBoundingClientRect();this._btnVR.style.top=t.top+t.height-70+"px",this._btnVR.style.left=t.left+t.width-100+"px"}}_displayVRButton(){!this._useCustomVRButton&&!this._btnVRDisplayed&&this._btnVR&&(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){!this._btnVR||this._useCustomVRButton||(this._btnVR.className="babylonVRicon",this.isInVRMode?this._btnVR.className+=" vrdisplaypresenting":(this._webVRready&&(this._btnVR.className+=" vrdisplayready"),this._webVRsupported&&(this._btnVR.className+=" vrdisplaysupported"),this._webVRrequesting&&(this._btnVR.className+=" vrdisplayrequesting")))}enterVR(){if(this.xr)this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);else{if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(t){V.Warn("Error in your custom logic onEnteringVR: "+t)}if(this._scene.activeCamera){if(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=Z.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this.webVRCamera){const t=this.webVRCamera.deviceRotationQuaternion.toEulerAngles().y,s=Z.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles().y-t,n=this.webVRCamera.rotationQuaternion.toEulerAngles().y;this.webVRCamera.rotationQuaternion=Z.FromEulerAngles(0,n+s,0)}this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)}this._webVRrequesting||(this._webVRready?this._webVRpresenting||(this._scene.getEngine().onVRRequestPresentComplete.addOnce(t=>{this.onAfterEnteringVRObservable.notifyObservers({success:t})}),this._webVRCamera.position=this._position,this._scene.activeCamera=this._webVRCamera):this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce(()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})})),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._displayLaserPointer&&[this._leftController,this._rightController].forEach(t=>{t&&t._activatePointer()}),this._hasEnteredVR=!0)}}exitVR(){if(this.xr)this.xr.baseExperience.exitXRAsync();else if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(i){V.Warn("Error in your custom logic onExitingVR: "+i)}this._webVRpresenting&&this._scene.getEngine().disableVR(),this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1,this._leftController&&(this._leftController._gazeTracker.isVisible=!1),this._rightController&&(this._rightController._gazeTracker.isVisible=!1)),this._scene.getEngine().resize(),[this._leftController,this._rightController].forEach(i=>{i&&i._deactivatePointer()}),this._hasEnteredVR=!1;const t=this._scene.getEngine();t._onVrDisplayPresentChange&&t._onVrDisplayPresentChange()}}get position(){return this._position}set position(t){this._position=t,this._scene.activeCamera&&(this._scene.activeCamera.position=t)}enableInteractions(){if(!this._interactionsEnabled){if(this._interactionsRequested=!0,this.xr)return void(this.xr.baseExperience.state===rs.IN_XR&&this.xr.pointerSelection.attach());this._leftController&&this._enableInteractionOnController(this._leftController),this._rightController&&this._enableInteractionOnController(this._rightController),this.raySelectionPredicate=t=>t.isVisible&&(t.isPickable||t.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=t=>!!(this._isTeleportationFloor(t)||-1===t.name.indexOf("gazeTracker")&&-1===t.name.indexOf("teleportationTarget")&&-1===t.name.indexOf("torusTeleportation"))&&this.raySelectionPredicate(t),this._interactionsEnabled=!0}}get _noControllerIsActive(){return!(this._leftController&&this._leftController._activePointer||this._rightController&&this._rightController._activePointer)}_isTeleportationFloor(t){for(let i=0;i<this._floorMeshesCollection.length;i++)if(this._floorMeshesCollection[i].id===t.id)return!0;return!(!this._floorMeshName||t.name!==this._floorMeshName)}addFloorMesh(t){!this._floorMeshesCollection||this._floorMeshesCollection.indexOf(t)>-1||this._floorMeshesCollection.push(t)}removeFloorMesh(t){if(!this._floorMeshesCollection)return;const i=this._floorMeshesCollection.indexOf(t);-1!==i&&this._floorMeshesCollection.splice(i,1)}enableTeleportation(t={}){if(!this._teleportationInitialized){if(this._teleportationRequested=!0,this.enableInteractions(),this.webVROptions.useXR&&(t.floorMeshes||t.floorMeshName)){const s=t.floorMeshes||[];if(!s.length){const n=this._scene.getMeshByName(t.floorMeshName);n&&s.push(n)}if(this.xr)return s.forEach(n=>{this.xr.teleportation.addFloorMesh(n)}),void(this.xr.teleportation.attached||this.xr.teleportation.attach());if(!this.xrTestDone){const n=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(n),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(t))};return void this._scene.registerBeforeRender(n)}}t.floorMeshName&&(this._floorMeshName=t.floorMeshName),t.floorMeshes&&(this._floorMeshesCollection=t.floorMeshes),t.teleportationMode&&(this._teleportationMode=t.teleportationMode),t.teleportationTime&&t.teleportationTime>0&&(this._teleportationTime=t.teleportationTime),t.teleportationSpeed&&t.teleportationSpeed>0&&(this._teleportationSpeed=t.teleportationSpeed),void 0!==t.easingFunction&&(this._teleportationEasing=t.easingFunction),null!=this._leftController&&this._enableTeleportationOnController(this._leftController),null!=this._rightController&&this._enableTeleportationOnController(this._rightController);const i=new at;i.vignetteColor=new Te(0,0,0,0),i.vignetteEnabled=!0,this._postProcessMove=new Av("postProcessMove",1,this._webVRCamera,void 0,void 0,void 0,void 0,i),this._webVRCamera.detachPostProcess(this._postProcessMove),this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&(this._createTeleportationCircles(),this._teleportationTarget.scaling.scaleInPlace(this._webVRCamera.deviceScaleFactor))}}_enableInteractionOnController(t){t.webVRController.mesh&&(t._interactionsEnabled=!0,this.isInVRMode&&this._displayLaserPointer&&t._activatePointer(),this.webVROptions.laserToggle&&t.webVRController.onMainButtonStateChangedObservable.add(s=>{this._displayLaserPointer&&1===s.value&&(t._activePointer?t._deactivatePointer():t._activatePointer(),this.displayGaze&&(t._gazeTracker.isVisible=t._activePointer))}),t.webVRController.onTriggerStateChangedObservable.add(s=>{let n=t;this._noControllerIsActive&&(n=this._cameraGazer),n._pointerDownOnMeshAsked?s.value<this._padSensibilityDown&&n._selectionPointerUp():s.value>this._padSensibilityUp&&n._selectionPointerDown()}))}_checkTeleportWithRay(t,i){this._teleportationRequestInitiated&&!i._teleportationRequestInitiated||(i._teleportationRequestInitiated?Math.sqrt(t.y*t.y+t.x*t.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),i._teleportationRequestInitiated=!1):t.y<-this._padSensibilityUp&&i._dpadPressed&&(i._activatePointer(),i._teleportationRequestInitiated=!0))}_checkRotate(t,i){i._teleportationRequestInitiated||(i._rotationLeftAsked?t.x>-this._padSensibilityDown&&(i._rotationLeftAsked=!1):t.x<-this._padSensibilityUp&&i._dpadPressed&&(i._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),i._rotationRightAsked?t.x<this._padSensibilityDown&&(i._rotationRightAsked=!1):t.x>this._padSensibilityUp&&i._dpadPressed&&(i._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(t,i){if(!i._teleportationRequestInitiated)if(t.y>this._padSensibilityUp&&i._dpadPressed){if(!i._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;let s=Z.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),n=this.currentVRCamera.position;this.currentVRCamera.devicePosition&&this.currentVRCamera.deviceRotationQuaternion&&(s=this.currentVRCamera.deviceRotationQuaternion,n=this.currentVRCamera.devicePosition),s.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,Z.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),v.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);const o=new Qe(n,this._workingVector),a=this._scene.pickWithRay(o,this._raySelectionPredicate);a&&a.pickedPoint&&a.pickedMesh&&this._isTeleportationFloor(a.pickedMesh)&&a.distance<5&&this.teleportCamera(a.pickedPoint),i._teleportationBackRequestInitiated=!0}}else i._teleportationBackRequestInitiated=!1}_enableTeleportationOnController(t){t.webVRController.mesh&&(t._interactionsEnabled||this._enableInteractionOnController(t),t._interactionsEnabled=!0,t._teleportationEnabled=!0,t.webVRController.controllerType===Ho.VIVE&&(t._dpadPressed=!1,t.webVRController.onPadStateChangedObservable.add(s=>{t._dpadPressed=s.pressed,t._dpadPressed||(t._rotationLeftAsked=!1,t._rotationRightAsked=!1,t._teleportationBackRequestInitiated=!1)})),t.webVRController.onPadValuesChangedObservable.add(s=>{this.teleportationEnabled&&(this._checkTeleportBackwards(s,t),this._checkTeleportWithRay(s,t)),this._checkRotate(s,t)}))}_createTeleportationCircles(){this._teleportationTarget=Ep("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;const i=new ic("DynamicTexture",512,this._scene,!0);i.hasAlpha=!0;const s=i.getContext();s.beginPath(),s.arc(256,256,200,0,2*Math.PI,!1),s.fillStyle=this._teleportationFillColor,s.fill(),s.lineWidth=10,s.strokeStyle=this._teleportationBorderColor,s.stroke(),s.closePath(),i.update();const l=new fe("TextPlaneMaterial",this._scene);l.diffuseTexture=i,this._teleportationTarget.material=l;const c=pa("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);c.isPickable=!1,c.parent=this._teleportationTarget;const h=new $("animationInnerCircle","position.y",30,$.ANIMATIONTYPE_FLOAT,$.ANIMATIONLOOPMODE_CYCLE),u=[];u.push({frame:0,value:0}),u.push({frame:30,value:.4}),u.push({frame:60,value:0}),h.setKeys(u);const d=new v1;d.setEasingMode(Bo.EASINGMODE_EASEINOUT),h.setEasingFunction(d),c.animations=[],c.animations.push(h),this._scene.beginAnimation(c,0,60,!0),this._hideTeleportationTarget()}_displayTeleportationTarget(){this._teleportActive=!0,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!0,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!0))}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(t){if(!(this.currentVRCamera instanceof lr))return;t?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];const i=Z.FromRotationMatrix(F.RotationY(Math.PI/4*this._rotationAngle)),s=new $("animationRotation","rotationQuaternion",90,$.ANIMATIONTYPE_QUATERNION,$.ANIMATIONLOOPMODE_CONSTANT),n=[];n.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),n.push({frame:6,value:i}),s.setKeys(n),s.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(s),this._postProcessMove.animations=[];const o=new $("animationPP","vignetteWeight",90,$.ANIMATIONTYPE_FLOAT,$.ANIMATIONLOOPMODE_CONSTANT),a=[];a.push({frame:0,value:0}),a.push({frame:3,value:4}),a.push({frame:6,value:0}),o.setKeys(a),o.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(o);const l=new $("animationPP2","vignetteStretch",90,$.ANIMATIONTYPE_FLOAT,$.ANIMATIONLOOPMODE_CONSTANT),c=[];c.push({frame:0,value:0}),c.push({frame:3,value:10}),c.push({frame:6,value:0}),l.setKeys(c),l.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(l),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,6,!1,1,()=>{this._webVRCamera.detachPostProcess(this._postProcessMove)}),this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}_moveTeleportationSelectorTo(t,i,s){if(t.pickedPoint){i._teleportationRequestInitiated&&(this._displayTeleportationTarget(),this._haloCenter.copyFrom(t.pickedPoint),this._teleportationTarget.position.copyFrom(t.pickedPoint));const n=this._convertNormalToDirectionOfRay(t.getNormal(!0,!1),s);if(n){const o=v.Cross(fs.Y,n),a=v.Cross(n,o);v.RotationFromAxisToRef(a,n,o,this._teleportationTarget.rotation)}this._teleportationTarget.position.y+=.1}}teleportCamera(t){if(!(this.currentVRCamera instanceof lr))return;let s,n;if(this.webVRCamera.leftCamera?(this._workingVector.copyFrom(this.webVRCamera.leftCamera.globalPosition),this._workingVector.subtractInPlace(this.webVRCamera.position),t.subtractToRef(this._workingVector,this._workingVector)):this._workingVector.copyFrom(t),this._workingVector.y+=this.isInVRMode?this.webVRCamera.deviceDistanceToRoomGround()*this._webVRCamera.deviceScaleFactor:this._defaultHeight,this.onBeforeCameraTeleport.notifyObservers(this._workingVector),this._teleportationMode==r.TELEPORTATIONMODE_CONSTANTSPEED){n=90;const f=v.Distance(this.currentVRCamera.position,this._workingVector);s=this._teleportationSpeed/f}else n=Math.round(90*this._teleportationTime/1e3),s=1;this.currentVRCamera.animations=[];const o=new $("animationCameraTeleportation","position",90,$.ANIMATIONTYPE_VECTOR3,$.ANIMATIONLOOPMODE_CONSTANT);o.setKeys([{frame:0,value:this.currentVRCamera.position},{frame:n,value:this._workingVector}]),o.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(o),this._postProcessMove.animations=[];const l=Math.round(n/2),c=new $("animationPP","vignetteWeight",90,$.ANIMATIONTYPE_FLOAT,$.ANIMATIONLOOPMODE_CONSTANT),h=[];h.push({frame:0,value:0}),h.push({frame:l,value:8}),h.push({frame:n,value:0}),c.setKeys(h),this._postProcessMove.animations.push(c);const u=new $("animationPP2","vignetteStretch",90,$.ANIMATIONTYPE_FLOAT,$.ANIMATIONLOOPMODE_CONSTANT),d=[];d.push({frame:0,value:0}),d.push({frame:l,value:10}),d.push({frame:n,value:0}),u.setKeys(d),this._postProcessMove.animations.push(u),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,n,!1,s,()=>{this._webVRCamera.detachPostProcess(this._postProcessMove)}),this._scene.beginAnimation(this.currentVRCamera,0,n,!1,s,()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)}),this._hideTeleportationTarget()}_convertNormalToDirectionOfRay(t,i){return t&&Math.acos(v.Dot(t,i.direction))<Math.PI/2&&t.scaleInPlace(-1),t}_castRayAndSelectObject(t){if(!(this.currentVRCamera instanceof lr))return;const i=t._getForwardRay(this._rayLength),s=this._scene.pickWithRay(i,this._raySelectionPredicate);if(s&&this._scene.simulatePointerMove(s,{pointerId:t._id}),t._currentHit=s,s&&s.pickedPoint){if(this._displayGaze){let n=1;t._gazeTracker.isVisible=!0,t._isActionableMesh&&(n=3),this.updateGazeTrackerScale&&(t._gazeTracker.scaling.x=s.distance*n,t._gazeTracker.scaling.y=s.distance*n,t._gazeTracker.scaling.z=s.distance*n);const o=this._convertNormalToDirectionOfRay(s.getNormal(),i),a=.002;if(o){const l=v.Cross(fs.Y,o),c=v.Cross(o,l);v.RotationFromAxisToRef(c,o,l,t._gazeTracker.rotation)}t._gazeTracker.position.copyFrom(s.pickedPoint),t._gazeTracker.position.x<0?t._gazeTracker.position.x+=a:t._gazeTracker.position.x-=a,t._gazeTracker.position.y<0?t._gazeTracker.position.y+=a:t._gazeTracker.position.y-=a,t._gazeTracker.position.z<0?t._gazeTracker.position.z+=a:t._gazeTracker.position.z-=a}t._updatePointerDistance(s.distance)}else t._updatePointerDistance(),t._gazeTracker.isVisible=!1;if(s&&s.pickedMesh){if(this._teleportationInitialized&&this._isTeleportationFloor(s.pickedMesh)&&s.pickedPoint)return t._currentMeshSelected&&!this._isTeleportationFloor(t._currentMeshSelected)&&this._notifySelectedMeshUnselected(t._currentMeshSelected),t._currentMeshSelected=null,void(t._teleportationRequestInitiated&&this._moveTeleportationSelectorTo(s,t,i));if(s.pickedMesh!==t._currentMeshSelected)if(this.meshSelectionPredicate(s.pickedMesh)){this.onNewMeshPicked.notifyObservers(s),t._currentMeshSelected=s.pickedMesh,s.pickedMesh.isPickable&&s.pickedMesh.actionManager?(this.changeGazeColor(this._pickedGazeColor),this.changeLaserColor(this._pickedLaserColor),t._isActionableMesh=!0):(this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor),t._isActionableMesh=!1);try{this.onNewMeshSelected.notifyObservers(s.pickedMesh);const n=t;n.webVRController&&this.onMeshSelectedWithController.notifyObservers({mesh:s.pickedMesh,controller:n.webVRController})}catch(n){V.Warn("Error while raising onNewMeshSelected or onMeshSelectedWithController: "+n)}}else this._notifySelectedMeshUnselected(t._currentMeshSelected),t._currentMeshSelected=null,this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor)}else this._notifySelectedMeshUnselected(t._currentMeshSelected),t._currentMeshSelected=null,this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor)}_notifySelectedMeshUnselected(t){t&&this.onSelectedMeshUnselected.notifyObservers(t)}setLaserColor(t,i=this._pickedLaserColor){this._laserColor=t,this._pickedLaserColor=i}setLaserLightingState(t=!0){this._leftController&&this._leftController._setLaserPointerLightingDisabled(!t),this._rightController&&this._rightController._setLaserPointerLightingDisabled(!t)}setGazeColor(t,i=this._pickedGazeColor){this._gazeColor=t,this._pickedGazeColor=i}changeLaserColor(t){!this.updateControllerLaserColor||(this._leftController&&this._leftController._setLaserPointerColor(t),this._rightController&&this._rightController._setLaserPointerColor(t))}changeGazeColor(t){!this.updateGazeTrackerColor||!this._cameraGazer._gazeTracker.material||(this._cameraGazer._gazeTracker.material.emissiveColor=t,this._leftController&&(this._leftController._gazeTracker.material.emissiveColor=t),this._rightController&&(this._rightController._gazeTracker.material.emissiveColor=t))}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._webVRCamera&&this._webVRCamera.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._leftController&&this._leftController.dispose(),this._rightController&&this._rightController.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.getEngine().onVRDisplayChangedObservable.removeCallback(this._onVRDisplayChangedBind),this._scene.getEngine().onVRRequestPresentStart.removeCallback(this._onVRRequestPresentStart),this._scene.getEngine().onVRRequestPresentComplete.removeCallback(this._onVRRequestPresentComplete),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.removeCallback(this._onNewGamepadDisconnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}return r.TELEPORTATIONMODE_CONSTANTTIME=0,r.TELEPORTATIONMODE_CONSTANTSPEED=1,r})();const Ku=function(){const r={root:0,found:!1};return function(e,t,i,s){r.root=0,r.found=!1;const n=t*t-4*e*i;if(n<0)return r;const o=Math.sqrt(n);let a=(-t-o)/(2*e),l=(-t+o)/(2*e);if(a>l){const c=l;l=a,a=c}return a>0&&a<s?(r.root=a,r.found=!0,r):(l>0&&l<s&&(r.root=l,r.found=!0),r)}}();let ore=(()=>{class r{constructor(){this._collisionPoint=v.Zero(),this._planeIntersectionPoint=v.Zero(),this._tempVector=v.Zero(),this._tempVector2=v.Zero(),this._tempVector3=v.Zero(),this._tempVector4=v.Zero(),this._edge=v.Zero(),this._baseToVertex=v.Zero(),this._destinationPoint=v.Zero(),this._slidePlaneNormal=v.Zero(),this._displacementVector=v.Zero(),this._radius=v.One(),this._retry=0,this._basePointWorld=v.Zero(),this._velocityWorld=v.Zero(),this._normalizedVelocity=v.Zero(),this._collisionMask=-1}get collisionMask(){return this._collisionMask}set collisionMask(t){this._collisionMask=isNaN(t)?-1:t}get slidePlaneNormal(){return this._slidePlaneNormal}_initialize(t,i,s){this._velocity=i,this._velocitySquaredLength=this._velocity.lengthSquared();const n=Math.sqrt(this._velocitySquaredLength);0===n||1===n?this._normalizedVelocity.copyFromFloats(i._x,i._y,i._z):i.scaleToRef(1/n,this._normalizedVelocity),this._basePoint=t,t.multiplyToRef(this._radius,this._basePointWorld),i.multiplyToRef(this._radius,this._velocityWorld),this._velocityWorldLength=this._velocityWorld.length(),this._epsilon=s,this.collisionFound=!1}_checkPointInTriangle(t,i,s,n,o){i.subtractToRef(t,this._tempVector),s.subtractToRef(t,this._tempVector2),v.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);let a=v.Dot(this._tempVector4,o);return!(a<0||(n.subtractToRef(t,this._tempVector3),v.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),a=v.Dot(this._tempVector4,o),a<0))&&(v.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),a=v.Dot(this._tempVector4,o),a>=0)}_canDoCollision(t,i,s,n){const o=v.Distance(this._basePointWorld,t),a=Math.max(this._radius.x,this._radius.y,this._radius.z);return!(o>this._velocityWorldLength+a+i||!((r,e,t,i)=>!(r.x>t.x+i||t.x-i>e.x||r.y>t.y+i||t.y-i>e.y||r.z>t.z+i||t.z-i>e.z))(s,n,this._basePointWorld,this._velocityWorldLength+a))}_testTriangle(t,i,s,n,o,a,l){let c,h=!1;i||(i=[]),i[t]||(i[t]=new Dr(0,0,0,0),i[t].copyFromPoints(s,n,o));const u=i[t];if(!a&&!u.isFrontFacingTo(this._normalizedVelocity,0))return;const d=u.signedDistanceTo(this._basePoint),f=v.Dot(u.normal,this._velocity);if(r.DoubleSidedCheck&&f>1e-4)return;if(0==f){if(Math.abs(d)>=1)return;h=!0,c=0}else{c=(-1-d)/f;let m=(1-d)/f;if(c>m){const g=m;m=c,c=g}if(c>1||m<0)return;c<0&&(c=0),c>1&&(c=1)}this._collisionPoint.copyFromFloats(0,0,0);let p=!1,_=1;if(h||(this._basePoint.subtractToRef(u.normal,this._planeIntersectionPoint),this._velocity.scaleToRef(c,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,s,n,o,u.normal)&&(p=!0,_=c,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!p){let m=this._velocitySquaredLength;this._basePoint.subtractToRef(s,this._tempVector);let g=2*v.Dot(this._velocity,this._tempVector),b=this._tempVector.lengthSquared()-1,y=Ku(m,g,b,_);y.found&&(_=y.root,p=!0,this._collisionPoint.copyFrom(s)),this._basePoint.subtractToRef(n,this._tempVector),g=2*v.Dot(this._velocity,this._tempVector),b=this._tempVector.lengthSquared()-1,y=Ku(m,g,b,_),y.found&&(_=y.root,p=!0,this._collisionPoint.copyFrom(n)),this._basePoint.subtractToRef(o,this._tempVector),g=2*v.Dot(this._velocity,this._tempVector),b=this._tempVector.lengthSquared()-1,y=Ku(m,g,b,_),y.found&&(_=y.root,p=!0,this._collisionPoint.copyFrom(o)),n.subtractToRef(s,this._edge),s.subtractToRef(this._basePoint,this._baseToVertex);let T=this._edge.lengthSquared(),x=v.Dot(this._edge,this._velocity),S=v.Dot(this._edge,this._baseToVertex);if(m=T*-this._velocitySquaredLength+x*x,g=2*(T*v.Dot(this._velocity,this._baseToVertex)-x*S),b=T*(1-this._baseToVertex.lengthSquared())+S*S,y=Ku(m,g,b,_),y.found){const C=(x*y.root-S)/T;C>=0&&C<=1&&(_=y.root,p=!0,this._edge.scaleInPlace(C),s.addToRef(this._edge,this._collisionPoint))}if(o.subtractToRef(n,this._edge),n.subtractToRef(this._basePoint,this._baseToVertex),T=this._edge.lengthSquared(),x=v.Dot(this._edge,this._velocity),S=v.Dot(this._edge,this._baseToVertex),m=T*-this._velocitySquaredLength+x*x,g=2*(T*v.Dot(this._velocity,this._baseToVertex)-x*S),b=T*(1-this._baseToVertex.lengthSquared())+S*S,y=Ku(m,g,b,_),y.found){const C=(x*y.root-S)/T;C>=0&&C<=1&&(_=y.root,p=!0,this._edge.scaleInPlace(C),n.addToRef(this._edge,this._collisionPoint))}if(s.subtractToRef(o,this._edge),o.subtractToRef(this._basePoint,this._baseToVertex),T=this._edge.lengthSquared(),x=v.Dot(this._edge,this._velocity),S=v.Dot(this._edge,this._baseToVertex),m=T*-this._velocitySquaredLength+x*x,g=2*(T*v.Dot(this._velocity,this._baseToVertex)-x*S),b=T*(1-this._baseToVertex.lengthSquared())+S*S,y=Ku(m,g,b,_),y.found){const C=(x*y.root-S)/T;C>=0&&C<=1&&(_=y.root,p=!0,this._edge.scaleInPlace(C),o.addToRef(this._edge,this._collisionPoint))}}if(p){const m=_*_*this._velocitySquaredLength;(!this.collisionFound||m<this._nearestDistanceSquared)&&(l.collisionResponse&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this._nearestDistanceSquared=m,this._nearestDistance=Math.sqrt(m),this.collisionFound=!0),this.collidedMesh=l)}}_collide(t,i,s,n,o,a,l,c,h,u=!1){if(u)if(s&&0!==s.length)for(let d=n;d<o-2;d+=1){const f=s[d],p=s[d+1],_=s[d+2];if(4294967295===_){d+=2;continue}const m=i[f],g=i[p],b=i[_];!m||!g||!b||((h?1:0)^d%2?this._testTriangle(d,t,m,g,b,l,c):this._testTriangle(d,t,g,m,b,l,c))}else for(let d=0;d<i.length-2;d+=1){const f=i[d],p=i[d+1],_=i[d+2];!f||!p||!_||((h?1:0)^d%2?this._testTriangle(d,t,f,p,_,l,c):this._testTriangle(d,t,p,f,_,l,c))}else if(s&&0!==s.length)for(let d=n;d<o;d+=3){const f=i[s[d]-a],p=i[s[d+1]-a],_=i[s[d+2]-a];h?this._testTriangle(d,t,f,p,_,l,c):this._testTriangle(d,t,_,p,f,l,c)}else for(let d=0;d<i.length;d+=3){const f=i[d],p=i[d+1],_=i[d+2];h?this._testTriangle(d,t,f,p,_,l,c):this._testTriangle(d,t,_,p,f,l,c)}}_getResponse(t,i){t.addToRef(i,this._destinationPoint),i.scaleInPlace(this._nearestDistance/i.length()),this._basePoint.addToRef(i,t),t.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this._epsilon,this._displacementVector),t.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(Dr.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,i)}}return r.DoubleSidedCheck=!1,r})();class are{constructor(){this._scaledPosition=v.Zero(),this._scaledVelocity=v.Zero(),this._finalPosition=v.Zero()}getNewPosition(e,t,i,s,n,o,a){e.divideToRef(i._radius,this._scaledPosition),t.divideToRef(i._radius,this._scaledVelocity),i.collidedMesh=null,i._retry=0,i._initialVelocity=this._scaledVelocity,i._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,s,this._finalPosition,n),this._finalPosition.multiplyInPlace(i._radius),o(a,this._finalPosition,i.collidedMesh)}createCollider(){return new ore}init(e){this._scene=e}_collideWithWorld(e,t,i,s,n,o=null){const a=10*ee.CollisionsEpsilon;if(i._retry>=s)return void n.copyFrom(e);const l=o?o.collisionMask:i.collisionMask;i._initialize(e,t,a);const c=o&&o.surroundingMeshes||this._scene.meshes;for(let h=0;h<c.length;h++){const u=c[h];u.isEnabled()&&u.checkCollisions&&u.subMeshes&&u!==o&&0!=(l&u.collisionGroup)&&u._checkCollision(i)}i.collisionFound?((0!==t.x||0!==t.y||0!==t.z)&&i._getResponse(e,t),t.length()<=a?n.copyFrom(e):(i._retry++,this._collideWithWorld(e,t,i,s,n,o))):e.addToRef(t,n)}}ge.CollisionCoordinatorFactory=()=>new are;let lre=(()=>{class r{constructor(t,i,s,n=""){var o,a;let l;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.uniqueId=0,this.onCompileObservable=new z,this.onErrorObservable=new z,this.onBindObservable=new z,this._wasPreviouslyReady=!1,this._isReady=!1,this._compilationError="",this._key="",this._computeSourceCodeOverride="",this._pipelineContext=null,this._computeSourceCode="",this._rawComputeSourceCode="",this._shaderLanguage=ui.WGSL,this.name=t,this._key=n,this._engine=s,this.uniqueId=r._UniqueIdSeed++,this.defines=null!==(o=i.defines)&&void 0!==o?o:"",this.onError=i.onError,this.onCompiled=i.onCompiled,this._entryPoint=null!==(a=i.entryPoint)&&void 0!==a?a:"main",this._shaderStore=j.GetShadersStore(this._shaderLanguage),this._shaderRepository=j.GetShadersRepository(this._shaderLanguage),this._includeShaderStore=j.GetIncludesShadersStore(this._shaderLanguage);const c=qi()?this._engine.getHostDocument():null;t.computeSource?l="source:"+t.computeSource:t.computeElement?(l=c?c.getElementById(t.computeElement):null,l||(l=t.computeElement)):l=t.compute||t;const h={defines:this.defines.split("\n"),indexParameters:void 0,isFragment:!1,shouldUseHighPrecisionShader:!1,processor:null,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:this._shaderRepository,includesShadersStore:this._includeShaderStore,version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:null,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer};this._loadShader(l,"Compute","",u=>{ha.Initialize(h),ha.PreProcess(u,h,d=>{this._rawComputeSourceCode=u,i.processFinalCode&&(d=i.processFinalCode(d));const f=ha.Finalize(d,"",h);this._useFinalCode(f.vertexCode,t)},this._engine)})}_useFinalCode(t,i){this._computeSourceCode=i?"//#define SHADER_NAME compute:"+(i.computeElement||i.compute||i.spectorName||i)+"\n"+t:t,this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getCompilationError(){return this._compilationError}executeWhenCompiled(t){this.isReady()?t(this):(this.onCompileObservable.add(i=>{t(i)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16))}_checkIsReady(t){try{if(this._isReadyInternal())return}catch(i){return void this._processCompilationErrors(i,t)}setTimeout(()=>{this._checkIsReady(t)},16)}_loadShader(t,i,s,n){if(typeof HTMLElement<"u"&&t instanceof HTMLElement)return void n(Hg(t));if("source:"===t.substr(0,7))return void n(t.substr(7));if("base64:"===t.substr(0,7))return void n(window.atob(t.substr(7)));if(this._shaderStore[t+i+"Shader"])return void n(this._shaderStore[t+i+"Shader"]);if(s&&this._shaderStore[t+s+"Shader"])return void n(this._shaderStore[t+s+"Shader"]);let o;o="."===t[0]||"/"===t[0]||t.indexOf("http")>-1?t:this._shaderRepository+t,this._engine._loadFile(o+"."+i.toLowerCase()+".fx",n)}get computeSourceCode(){var t,i;return this._computeSourceCodeOverride?this._computeSourceCodeOverride:null!==(i=null===(t=this._pipelineContext)||void 0===t?void 0:t._getComputeShaderCode())&&void 0!==i?i:this._computeSourceCode}get rawComputeSourceCode(){return this._rawComputeSourceCode}_prepareEffect(){const t=this.defines,i=this._pipelineContext;this._isReady=!1;try{const s=this._engine;this._pipelineContext=s.createComputePipelineContext(),this._pipelineContext._name=this._key,s._prepareComputePipelineContext(this._pipelineContext,this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._computeSourceCode,this._rawComputeSourceCode,this._computeSourceCodeOverride?null:t,this._entryPoint),s._executeWhenComputeStateIsCompiled(this._pipelineContext,()=>{this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),i&&this.getEngine()._deleteComputePipelineContext(i)}),this._pipelineContext.isAsync&&this._checkIsReady(i)}catch(s){this._processCompilationErrors(s,i)}}_getShaderCodeAndErrorLine(t,i){let n=null;if(i&&t){const o=i.match(/COMPUTE SHADER ERROR: 0:(\d+?):/);if(o&&2===o.length){const a=parseInt(o[1]),l=t.split("\n",-1);l.length>=a&&(n=`Offending line [${a}] in compute code: ${l[a-1]}`)}}return[t,n]}_processCompilationErrors(t,i=null){var s;if(this._compilationError=t.message,V.Error("Unable to compile compute effect:"),V.Error("Defines:\r\n"+this.defines),r.LogShaderCodeOnCompilationError){let n=null,o=null;!(null===(s=this._pipelineContext)||void 0===s)&&s._getComputeShaderCode()&&([o,n]=this._getShaderCodeAndErrorLine(this._pipelineContext._getComputeShaderCode(),this._compilationError),o&&(V.Error("Compute code:"),V.Error(o))),n&&V.Error(n)}V.Error("Error: "+this._compilationError),i&&(this._pipelineContext=i,this._isReady=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this))}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseComputeEffect(this)}static RegisterShader(t,i){j.GetShadersStore(ui.WGSL)[`${t}ComputeShader`]=i}}return r._UniqueIdSeed=0,r.LogShaderCodeOnCompilationError=!0,r})();var Ii=(()=>{return(r=Ii||(Ii={}))[r.Texture=0]="Texture",r[r.StorageTexture=1]="StorageTexture",r[r.UniformBuffer=2]="UniformBuffer",r[r.StorageBuffer=3]="StorageBuffer",r[r.TextureWithoutSampler=4]="TextureWithoutSampler",r[r.Sampler=5]="Sampler",Ii;var r})();we.prototype.createComputeEffect=function(r,e){throw new Error("createComputeEffect: This engine does not support compute shaders!")},we.prototype.createComputePipelineContext=function(){throw new Error("createComputePipelineContext: This engine does not support compute shaders!")},we.prototype.createComputeContext=function(){},we.prototype.computeDispatch=function(r,e,t,i,s,n,o){throw new Error("computeDispatch: This engine does not support compute shaders!")},we.prototype.areAllComputeEffectsReady=function(){return!0},we.prototype.releaseComputeEffects=function(){},we.prototype._prepareComputePipelineContext=function(r,e,t,i,s){},we.prototype._rebuildComputeEffects=function(){},we.prototype._executeWhenComputeStateIsCompiled=function(r,e){e()},we.prototype._releaseComputeEffect=function(r){},we.prototype._deleteComputePipelineContext=function(r){};class Cp{get options(){return this._options}get shaderPath(){return this._shaderPath}constructor(e,t,i,s={}){this._bindings={},this._samplers={},this._contextIsDirty=!1,this.onCompiled=null,this.onError=null,this.name=e,this._engine=t,this.uniqueId=gE.UniqueId,this._engine.getCaps().supportComputeShaders?s.bindingsMapping?(this._context=t.createComputeContext(),this._shaderPath=i,this._options={bindingsMapping:{},defines:[],...s}):V.Error("You must provide the binding mappings as browsers don't support reflection for wgsl shaders yet!"):V.Error("This engine does not support compute shaders!")}getClassName(){return"ComputeShader"}setTexture(e,t,i=!0){const s=this._bindings[e];this._bindings[e]={type:i?Ii.Texture:Ii.TextureWithoutSampler,object:t,indexInGroupEntries:s?.indexInGroupEntries},this._contextIsDirty||(this._contextIsDirty=!s||s.object!==t||s.type!==this._bindings[e].type)}setStorageTexture(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:Ii.StorageTexture,object:t,indexInGroupEntries:i?.indexInGroupEntries}}setUniformBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:Ii.UniformBuffer,object:t,indexInGroupEntries:i?.indexInGroupEntries}}setStorageBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:Ii.StorageBuffer,object:t,indexInGroupEntries:i?.indexInGroupEntries}}setTextureSampler(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||!t.compareSampler(i.object)),this._bindings[e]={type:Ii.Sampler,object:t,indexInGroupEntries:i?.indexInGroupEntries}}isReady(){let e=this._effect;for(const n in this._bindings){const o=this._bindings[n],l=o.object;switch(o.type){case Ii.Texture:case Ii.TextureWithoutSampler:case Ii.StorageTexture:if(!l.isReady())return!1}}const t=[],i=this._shaderPath;if(this._options.defines)for(let n=0;n<this._options.defines.length;n++)t.push(this._options.defines[n]);const s=t.join("\n");return this._cachedDefines!==s&&(this._cachedDefines=s,e=this._engine.createComputeEffect(i,{defines:s,entryPoint:this._options.entryPoint,onCompiled:this.onCompiled,onError:this.onError}),this._effect=e),!!e.isReady()}dispatch(e,t,i){var s;if(!this.isReady())return!1;for(const n in this._bindings){const o=this._bindings[n];if(!this._options.bindingsMapping[n])throw new Error("ComputeShader ('"+this.name+"'): No binding mapping has been provided for the property '"+n+"'");if(o.type!==Ii.Texture)continue;const a=this._samplers[n],l=o.object;(!a||!l._texture||!a.compareSampler(l._texture))&&(this._samplers[n]=(new r1).setParameters(l.wrapU,l.wrapV,l.wrapR,l.anisotropicFilteringLevel,l._texture.samplingMode,null===(s=l._texture)||void 0===s?void 0:s._comparisonFunction),this._contextIsDirty=!0)}return this._contextIsDirty&&(this._contextIsDirty=!1,this._context.clear()),this._engine.computeDispatch(this._effect,this._context,this._bindings,e,t,i,this._options.bindingsMapping),!0}dispatchWhenReady(e,t,i,s=10){return new Promise(n=>{const o=()=>{this.dispatch(e,t,i)?n():setTimeout(o,s)};o()})}serialize(){const e=Ce.Serialize(this);e.options=this._options,e.shaderPath=this._shaderPath,e.bindings={},e.textures={};for(const t in this._bindings){const i=this._bindings[t],s=i.object;switch(i.type){case Ii.Texture:case Ii.TextureWithoutSampler:case Ii.StorageTexture:{const n=s.serialize();n&&(e.textures[t]=n,e.bindings[t]={type:i.type});break}}}return e}static Parse(e,t,i){const s=Ce.Parse(()=>new Cp(e.name,t.getEngine(),e.shaderPath,e.options),e,t,i);for(const n in e.textures){const o=e.bindings[n],a=U.Parse(e.textures[n],t,i);o.type===Ii.Texture?s.setTexture(n,a):o.type===Ii.TextureWithoutSampler?s.setTexture(n,a,!1):s.setStorageTexture(n,a)}return s}}E([I()],Cp.prototype,"name",void 0),le("BABYLON.ComputeShader",Cp);class Mv{constructor(e,t,i,s,n,o){this.entries=new Array,this._boundingVectors=new Array,this._capacity=i,this._depth=s,this._maxDepth=n,this._creationFunc=o,this._minPoint=e,this._maxPoint=t,this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors[2].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[3].y=t.y,this._boundingVectors.push(e.clone()),this._boundingVectors[4].z=t.z,this._boundingVectors.push(t.clone()),this._boundingVectors[5].z=e.z,this._boundingVectors.push(t.clone()),this._boundingVectors[6].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[7].y=e.y}get capacity(){return this._capacity}get minPoint(){return this._minPoint}get maxPoint(){return this._maxPoint}addEntry(e){if(this.blocks)for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e);else this._creationFunc(e,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()}removeEntry(e){if(this.blocks){for(let i=0;i<this.blocks.length;i++)this.blocks[i].removeEntry(e);return}const t=this.entries.indexOf(e);t>-1&&this.entries.splice(t,1)}addEntries(e){for(let t=0;t<e.length;t++)this.addEntry(e[t])}select(e,t,i){if(Vo.IsInFrustum(this._boundingVectors,e)){if(this.blocks){for(let s=0;s<this.blocks.length;s++)this.blocks[s].select(e,t,i);return}i?t.concat(this.entries):t.concatWithNoDuplicate(this.entries)}}intersects(e,t,i,s){if(Vo.IntersectsSphere(this._minPoint,this._maxPoint,e,t)){if(this.blocks){for(let n=0;n<this.blocks.length;n++)this.blocks[n].intersects(e,t,i,s);return}s?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}}intersectsRay(e,t){if(e.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(let i=0;i<this.blocks.length;i++)this.blocks[i].intersectsRay(e,t);return}t.concatWithNoDuplicate(this.entries)}}createInnerBlocks(){Mv._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc),this.entries.splice(0)}static _CreateBlocks(e,t,i,s,n,o,a,l){a.blocks=new Array;const c=new v((t.x-e.x)/2,(t.y-e.y)/2,(t.z-e.z)/2);for(let h=0;h<2;h++)for(let u=0;u<2;u++)for(let d=0;d<2;d++){const f=e.add(c.multiplyByFloats(h,u,d)),p=e.add(c.multiplyByFloats(h+1,u+1,d+1)),_=new Mv(f,p,s,n+1,o,l);_.addEntries(i),a.blocks.push(_)}}}let Pv=(()=>{class r{constructor(t,i,s=2){this.maxDepth=s,this.dynamicContent=new Array,this._maxBlockCapacity=i||64,this._selectionContent=new $l(1024),this._creationFunc=t}update(t,i,s){Mv._CreateBlocks(t,i,s,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)}addMesh(t){for(let i=0;i<this.blocks.length;i++)this.blocks[i].addEntry(t)}removeMesh(t){for(let i=0;i<this.blocks.length;i++)this.blocks[i].removeEntry(t)}select(t,i){this._selectionContent.reset();for(let s=0;s<this.blocks.length;s++)this.blocks[s].select(t,this._selectionContent,i);return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersects(t,i,s){this._selectionContent.reset();for(let n=0;n<this.blocks.length;n++)this.blocks[n].intersects(t,i,this._selectionContent,s);return s?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersectsRay(t){this._selectionContent.reset();for(let i=0;i<this.blocks.length;i++)this.blocks[i].intersectsRay(t,this._selectionContent);return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}}return r.CreationFuncForMeshes=(e,t)=>{const i=e.getBoundingInfo();!e.isBlocked&&i.boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)},r.CreationFuncForSubMeshes=(e,t)=>{e.getBoundingInfo().boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)},r})();ge.prototype.createOrUpdateSelectionOctree=function(r=64,e=2){let t=this._getComponent(Me.NAME_OCTREE);t||(t=new H2(this),this._addComponent(t)),this._selectionOctree||(this._selectionOctree=new Pv(Pv.CreationFuncForMeshes,r,e));const i=this.getWorldExtends();return this._selectionOctree.update(i.min,i.max,this.meshes),this._selectionOctree},Object.defineProperty(ge.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0}),Zt.prototype.createOrUpdateSubmeshesOctree=function(r=64,e=2){const t=this.getScene();let i=t._getComponent(Me.NAME_OCTREE);i||(i=new H2(t),t._addComponent(i)),this._submeshesOctree||(this._submeshesOctree=new Pv(Pv.CreationFuncForSubMeshes,r,e)),this.computeWorldMatrix(!0);const n=this.getBoundingInfo().boundingBox;return this._submeshesOctree.update(n.minimumWorld,n.maximumWorld,this.subMeshes),this._submeshesOctree};class H2{constructor(e){this.name=Me.NAME_OCTREE,this.checksIsEnabled=!0,this._tempRay=new Qe(v.Zero(),new v(1,1,1)),(e=e||be.LastCreatedScene)&&(this.scene=e,this.scene.getActiveMeshCandidates=this.getActiveMeshCandidates.bind(this),this.scene.getActiveSubMeshCandidates=this.getActiveSubMeshCandidates.bind(this),this.scene.getCollidingSubMeshCandidates=this.getCollidingSubMeshCandidates.bind(this),this.scene.getIntersectingSubMeshCandidates=this.getIntersectingSubMeshCandidates.bind(this))}register(){this.scene.onMeshRemovedObservable.add(e=>{const t=this.scene.selectionOctree;if(null!=t){const i=t.dynamicContent.indexOf(e);-1!==i&&t.dynamicContent.splice(i,1)}}),this.scene.onMeshImportedObservable.add(e=>{this.scene.selectionOctree?.addMesh(e)})}getActiveMeshCandidates(){var e;return(null===(e=this.scene._selectionOctree)||void 0===e?void 0:e.select(this.scene.frustumPlanes))||this.scene._getDefaultMeshCandidates()}getActiveSubMeshCandidates(e){return e._submeshesOctree&&e.useOctreeForRenderingSelection?e._submeshesOctree.select(this.scene.frustumPlanes):this.scene._getDefaultSubMeshCandidates(e)}getIntersectingSubMeshCandidates(e,t){return e._submeshesOctree&&e.useOctreeForPicking?(Qe.TransformToRef(t,e.getWorldMatrix(),this._tempRay),e._submeshesOctree.intersectsRay(this._tempRay)):this.scene._getDefaultSubMeshCandidates(e)}getCollidingSubMeshCandidates(e,t){if(e._submeshesOctree&&e.useOctreeForCollisions){const i=t._velocityWorldLength+Math.max(t._radius.x,t._radius.y,t._radius.z);return e._submeshesOctree.intersects(t._basePointWorld,i)}return this.scene._getDefaultSubMeshCandidates(e)}rebuild(){}dispose(){}}let nl=(()=>{class r{getRenderCamera(t){if(this._renderCamera)return this._renderCamera;{let i;return i=this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:this.originalScene.activeCamera,t&&i&&i.isRigCamera?i.rigParent:i}}setRenderCamera(t){this._renderCamera=t}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new jn("shared gizmo light",new v(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=re.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return r._DefaultUtilityLayer??r._CreateDefaultUtilityLayerFromScene(be.LastCreatedScene)}static _CreateDefaultUtilityLayerFromScene(t){return r._DefaultUtilityLayer=new r(t),r._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{r._DefaultUtilityLayer=null}),r._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return null==r._DefaultKeepDepthUtilityLayer&&(r._DefaultKeepDepthUtilityLayer=new r(be.LastCreatedScene),r._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,r._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{r._DefaultKeepDepthUtilityLayer=null})),r._DefaultKeepDepthUtilityLayer}constructor(t,i=!0){this.originalScene=t,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new z,this.utilityLayerScene=new ge(t.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=t.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),i&&(this._originalPointerObserver=t.onPrePointerObservable.add(s=>{if(!this.utilityLayerScene.activeCamera||!this.pickingEnabled||!this.processAllEvents&&s.type!==Re.POINTERMOVE&&s.type!==Re.POINTERUP&&s.type!==Re.POINTERDOWN&&s.type!==Re.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=t.pointerX,this.utilityLayerScene.pointerY=t.pointerY;const n=s.event;if(t.isPointerCaptured(n.pointerId))return void(this._pointerCaptures[n.pointerId]=!1);const o=l=>{let c=null;if(s.nearInteractionPickingInfo)c=s.nearInteractionPickingInfo.pickedMesh.getScene()==l?s.nearInteractionPickingInfo:new Os;else if(l!==this.utilityLayerScene&&s.originalPickingInfo)c=s.originalPickingInfo;else{let h=null;this._renderCamera&&(h=l._activeCamera,l._activeCamera=this._renderCamera,s.ray=null),c=s.ray?l.pickWithRay(s.ray):l.pick(t.pointerX,t.pointerY),h&&(l._activeCamera=h)}return c},a=o(this.utilityLayerScene);if(!s.ray&&a&&(s.ray=a.ray),this.utilityLayerScene.onPrePointerObservable.notifyObservers(s),this.onlyCheckPointerDownEvents&&s.type!=Re.POINTERDOWN)return s.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new uo(s.type,s.event,a),s.type),void(s.type===Re.POINTERUP&&this._pointerCaptures[n.pointerId]&&(this._pointerCaptures[n.pointerId]=!1));if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)a&&a.hit&&(s.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new uo(s.type,s.event,a),s.type),s.skipOnPointerObservable=!0);else{const l=o(t),c=s.event;l&&a&&(0===a.distance&&l.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(l.pickedMesh)?(this._notifyObservers(s,l,c),s.skipOnPointerObservable=!0):s.type===Re.POINTERDOWN?this._pointerCaptures[c.pointerId]=!0:(s.type===Re.POINTERMOVE||s.type===Re.POINTERUP)&&(this._lastPointerEvents[c.pointerId]&&(this.onPointerOutObservable.notifyObservers(c.pointerId),delete this._lastPointerEvents[c.pointerId]),this._notifyObservers(s,l,c)):!this._pointerCaptures[c.pointerId]&&(a.distance<l.distance||0===l.distance)?(this._notifyObservers(s,a,c),s.skipOnPointerObservable||(s.skipOnPointerObservable=a.distance>0)):!this._pointerCaptures[c.pointerId]&&a.distance>=l.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(l.pickedMesh)?(this._notifyObservers(s,l,c),s.skipOnPointerObservable=!0):((s.type===Re.POINTERMOVE||s.type===Re.POINTERUP)&&this._lastPointerEvents[c.pointerId]&&(this.onPointerOutObservable.notifyObservers(c.pointerId),delete this._lastPointerEvents[c.pointerId]),this._notifyObservers(s,a,c))),s.type===Re.POINTERUP&&this._pointerCaptures[c.pointerId]&&(this._pointerCaptures[c.pointerId]=!1))}}),this._originalPointerObserver&&t.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add(s=>{this.shouldRender&&s==this.getRenderCamera()&&this.render()}),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(()=>{this.dispose()}),this._updateCamera()}_notifyObservers(t,i,s){t.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new uo(t.type,t.event,i),t.type),this._lastPointerEvents[s.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){const t=this.utilityLayerScene.activeCamera.getScene(),i=this.utilityLayerScene.activeCamera;i._scene=this.utilityLayerScene,i.leftCamera&&(i.leftCamera._scene=this.utilityLayerScene),i.rightCamera&&(i.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),i._scene=t,i.leftCamera&&(i.leftCamera._scene=t),i.rightCamera&&(i.rightCamera._scene=t)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}return r._DefaultUtilityLayer=null,r._DefaultKeepDepthUtilityLayer=null,r})(),Dv=(()=>{class r{set scaleRatio(t){this._scaleRatio=t}get scaleRatio(){return this._scaleRatio}get isHovered(){return this._isHovered}get attachedMesh(){return this._attachedMesh}set attachedMesh(t){this._attachedMesh=t,t&&(this._attachedNode=t),this._rootMesh.setEnabled(!!t),this._attachedNodeChanged(t)}get attachedNode(){return this._attachedNode}set attachedNode(t){this._attachedNode=t,this._attachedMesh=null,this._rootMesh.setEnabled(!!t),this._attachedNodeChanged(t)}setCustomMesh(t){if(t.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._rootMesh.getChildMeshes().forEach(i=>{i.dispose()}),t.parent=this._rootMesh,this._customMeshSet=!0}set updateGizmoRotationToMatchAttachedMesh(t){this._updateGizmoRotationToMatchAttachedMesh=t}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(t){this._updateGizmoPositionToMatchAttachedMesh=t}get updateGizmoPositionToMatchAttachedMesh(){return this._updateGizmoPositionToMatchAttachedMesh}set updateScale(t){this._updateScale=t}get updateScale(){return this._updateScale}_attachedNodeChanged(t){}constructor(t=nl.DefaultUtilityLayer){this.gizmoLayer=t,this._attachedMesh=null,this._attachedNode=null,this._customRotationQuaternion=null,this._scaleRatio=1,this._isHovered=!1,this._customMeshSet=!1,this._updateGizmoRotationToMatchAttachedMesh=!0,this._updateGizmoPositionToMatchAttachedMesh=!0,this._updateScale=!0,this._interactionsEnabled=!0,this._rightHandtoLeftHandMatrix=F.RotationY(Math.PI),this._rootMesh=new G("gizmoRootNode",t.utilityLayerScene),this._rootMesh.rotationQuaternion=Z.Identity(),this._beforeRenderObserver=this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.add(()=>{this._update()})}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(t){this._customRotationQuaternion=t}_update(){if(this.attachedNode){let t=this.attachedNode;if(this.attachedMesh&&(t=this.attachedMesh||this.attachedNode),this.updateGizmoPositionToMatchAttachedMesh){const i=t.getWorldMatrix().getRow(3),s=i?i.toVector3():new v(0,0,0);this._rootMesh.position.copyFrom(s)}if(this.updateGizmoRotationToMatchAttachedMesh){const s=t._isMesh||"AbstractMesh"===t.getClassName()||"TransformNode"===t.getClassName()||"InstancedMesh"===t.getClassName()?t:void 0;t.getWorldMatrix().decompose(void 0,this._rootMesh.rotationQuaternion,void 0,r.PreserveScaling?s:void 0)}else this._customRotationQuaternion?this._rootMesh.rotationQuaternion.copyFrom(this._customRotationQuaternion):this._rootMesh.rotationQuaternion.set(0,0,0,1);if(this.updateScale){const i=this.gizmoLayer.utilityLayerScene.activeCamera;let s=i.globalPosition;i.devicePosition&&(s=i.devicePosition),this._rootMesh.position.subtractToRef(s,L.Vector3[0]);let n=this.scaleRatio;if(i.mode==ve.ORTHOGRAPHIC_CAMERA)i.orthoTop&&i.orthoBottom&&(n*=i.orthoTop-i.orthoBottom);else{const o=i.getScene().useRightHandedSystem?v.RightHandedForwardReadOnly:v.LeftHandedForwardReadOnly,a=i.getDirection(o);n*=v.Dot(L.Vector3[0],a)}this._rootMesh.scaling.setAll(n),t._getWorldMatrixDeterminant()<0&&!r.PreserveScaling&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}}_handlePivot(){const t=this._attachedNode;t.isUsingPivotMatrix&&t.isUsingPivotMatrix()&&t.position&&t.getWorldMatrix().setTranslation(t.position)}_matrixChanged(){if(this._attachedNode)if(this._attachedNode._isCamera){const t=this._attachedNode;let i,s;if(t.parent){const o=L.Matrix[1];t.parent._worldMatrix.invertToRef(o),this._attachedNode._worldMatrix.multiplyToRef(o,L.Matrix[0]),i=L.Matrix[0]}else i=this._attachedNode._worldMatrix;if(t.getScene().useRightHandedSystem?(this._rightHandtoLeftHandMatrix.multiplyToRef(i,L.Matrix[1]),s=L.Matrix[1]):s=i,s.decompose(L.Vector3[1],L.Quaternion[0],L.Vector3[0]),"FreeCamera"===this._attachedNode.getClassName()||"FlyCamera"===this._attachedNode.getClassName()||"ArcFollowCamera"===this._attachedNode.getClassName()||"TargetCamera"===this._attachedNode.getClassName()||"TouchCamera"===this._attachedNode.getClassName()||"UniversalCamera"===this._attachedNode.getClassName()){const o=this._attachedNode;o.rotation=L.Quaternion[0].toEulerAngles(),o.rotationQuaternion&&(o.rotationQuaternion.copyFrom(L.Quaternion[0]),o.rotationQuaternion.normalize())}t.position.copyFrom(L.Vector3[0])}else if(this._attachedNode._isMesh||"AbstractMesh"===this._attachedNode.getClassName()||"TransformNode"===this._attachedNode.getClassName()||"InstancedMesh"===this._attachedNode.getClassName()){const t=this._attachedNode;if(t.parent){const i=L.Matrix[0],s=L.Matrix[1];t.parent.getWorldMatrix().invertToRef(i),this._attachedNode.getWorldMatrix().multiplyToRef(i,s),s.decompose(L.Vector3[0],L.Quaternion[0],t.position,r.PreserveScaling?t:void 0)}else this._attachedNode._worldMatrix.decompose(L.Vector3[0],L.Quaternion[0],t.position,r.PreserveScaling?t:void 0);t.scaling.copyFrom(L.Vector3[0]),t.billboardMode||(t.rotationQuaternion?(t.rotationQuaternion.copyFrom(L.Quaternion[0]),t.rotationQuaternion.normalize()):t.rotation=L.Quaternion[0].toEulerAngles())}else if("Bone"===this._attachedNode.getClassName()){const t=this._attachedNode,i=t.getParent();if(i){const s=L.Matrix[0],n=L.Matrix[1];i.getWorldMatrix().invertToRef(s),t.getWorldMatrix().multiplyToRef(s,n),t.getLocalMatrix().copyFrom(n)}else t.getLocalMatrix().copyFrom(t.getWorldMatrix());t.markAsDirty()}else{const t=this._attachedNode;if(t.getTypeID){const i=t.getTypeID();if(i===Je.LIGHTTYPEID_DIRECTIONALLIGHT||i===Je.LIGHTTYPEID_SPOTLIGHT||i===Je.LIGHTTYPEID_POINTLIGHT){const s=t.parent;if(s){const n=L.Matrix[0],o=L.Matrix[1];s.getWorldMatrix().invertToRef(n),t.getWorldMatrix().multiplyToRef(n,o),o.decompose(void 0,L.Quaternion[0],L.Vector3[0])}else this._attachedNode._worldMatrix.decompose(void 0,L.Quaternion[0],L.Vector3[0]);t.position=new v(L.Vector3[0].x,L.Vector3[0].y,L.Vector3[0].z),t.direction&&(t.direction=new v(t.direction.x,t.direction.y,t.direction.z))}}}}_setGizmoMeshMaterial(t,i){t&&t.forEach(s=>{s.material=i,s.color&&(s.color=i.diffuseColor)})}static GizmoAxisPointerObserver(t,i){let s=!1;return t.utilityLayerScene.onPointerObservable.add(o=>{var a,l;if(o.pickInfo){if(o.type===Re.POINTERMOVE){if(s)return;i.forEach(c=>{var h,u;if(c.colliderMeshes&&c.gizmoMeshes){const d=-1!=(null===(h=c.colliderMeshes)||void 0===h?void 0:h.indexOf(null===(u=o?.pickInfo)||void 0===u?void 0:u.pickedMesh)),f=c.dragBehavior.enabled?d||c.active?c.hoverMaterial:c.material:c.disableMaterial;c.gizmoMeshes.forEach(p=>{p.material=f,p.color&&(p.color=f.diffuseColor)})}})}o.type===Re.POINTERDOWN&&i.has(null===(a=o.pickInfo.pickedMesh)||void 0===a?void 0:a.parent)&&(s=!0,i.get(null===(l=o.pickInfo.pickedMesh)||void 0===l?void 0:l.parent).active=!0,i.forEach(h=>{var u,d;const p=(-1!=(null===(u=h.colliderMeshes)||void 0===u?void 0:u.indexOf(null===(d=o?.pickInfo)||void 0===d?void 0:d.pickedMesh))||h.active)&&h.dragBehavior.enabled?h.hoverMaterial:h.disableMaterial;h.gizmoMeshes.forEach(_=>{_.material=p,_.color&&(_.color=p.diffuseColor)})})),o.type===Re.POINTERUP&&i.forEach(c=>{c.active=!1,s=!1,c.gizmoMeshes.forEach(h=>{h.material=c.dragBehavior.enabled?c.material:c.disableMaterial,h.color&&(h.color=c.material.diffuseColor)})})}})}dispose(){this._rootMesh.dispose(),this._beforeRenderObserver&&this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.remove(this._beforeRenderObserver)}}return r.PreserveScaling=!1,r})();Object.defineProperty(ge.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new wv(this)),this._debugLayer},enumerable:!0,configurable:!0});class wv{get onPropertyChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this._onPropertyChangedObservable||(this._onPropertyChangedObservable=new z),this._onPropertyChangedObservable)}get onSelectionChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable:(this._onSelectionChangedObservable||(this._onSelectionChangedObservable=new z),this._onSelectionChangedObservable)}constructor(e){this.BJSINSPECTOR=this._getGlobalInspector(),this._scene=e||be.LastCreatedScene,this._scene&&this._scene.onDisposeObservable.add(()=>{this._scene._debugLayer&&this._scene._debugLayer.hide()})}_createInspector(e){if(this.isVisible())return;if(this._onPropertyChangedObservable){for(const i of this._onPropertyChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(i);this._onPropertyChangedObservable.clear(),this._onPropertyChangedObservable=void 0}if(this._onSelectionChangedObservable){for(const i of this._onSelectionChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnSelectionChangedObservable.add(i);this._onSelectionChangedObservable.clear(),this._onSelectionChangedObservable=void 0}const t={overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0,...e};this.BJSINSPECTOR=this.BJSINSPECTOR||this._getGlobalInspector(),this.BJSINSPECTOR.Inspector.Show(this._scene,t)}select(e,t){this.BJSINSPECTOR&&(t&&("[object String]"==Object.prototype.toString.call(t)?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(t):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(t)),this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(e))}_getGlobalInspector(){return typeof INSPECTOR<"u"?INSPECTOR:typeof BABYLON<"u"&&typeof BABYLON.Inspector<"u"?BABYLON:void 0}isVisible(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible}hide(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()}setAsActiveScene(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector._SetNewScene(this._scene)}show(e){return new Promise(t=>{typeof this.BJSINSPECTOR>"u"?q.LoadScript(e&&e.inspectorURL?e.inspectorURL:wv.InspectorURL,()=>{this._createInspector(e),t(this)}):(this._createInspector(e),t(this))})}}function QE(r){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],s=[];let n=[];const o=r.width||r.size||1,a=r.height||r.size||1,l=r.depth||r.size||1;let h=void 0===r.topBaseAt?1:r.topBaseAt,u=void 0===r.bottomBaseAt?0:r.bottomBaseAt;h=(h+4)%4,u=(u+4)%4;let p=[2,0,3,1][h],_=[2,0,1,3][u],m=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(r.wrap){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],m=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let C=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],D=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const P=[17,18,19,16],M=[22,23,20,21];for(;p>0;)C.unshift(C.pop()),P.unshift(P.pop()),p--;for(;_>0;)D.unshift(D.pop()),M.unshift(M.pop()),_--;C=C.flat(),D=D.flat(),m=m.concat(C).concat(D),t.push(P[0],P[2],P[3],P[0],P[1],P[2]),t.push(M[0],M[2],M[3],M[0],M[1],M[2])}const g=[o/2,a/2,l/2];n=m.reduce((C,D,P)=>C.concat(D*g[P%3]),[]);const b=0===r.sideOrientation?0:r.sideOrientation||ue.DEFAULTSIDE,y=r.faceUV||new Array(6),T=r.faceColors,x=[];for(let C=0;C<6;C++)void 0===y[C]&&(y[C]=new vt(0,0,1,1)),T&&void 0===T[C]&&(T[C]=new Te(1,1,1,1));for(let C=0;C<6;C++)if(s.push(y[C].z,It.UseOpenGLOrientationForUV?1-y[C].w:y[C].w),s.push(y[C].x,It.UseOpenGLOrientationForUV?1-y[C].w:y[C].w),s.push(y[C].x,It.UseOpenGLOrientationForUV?1-y[C].y:y[C].y),s.push(y[C].z,It.UseOpenGLOrientationForUV?1-y[C].y:y[C].y),T)for(let D=0;D<4;D++)x.push(T[C].r,T[C].g,T[C].b,T[C].a);ue._ComputeSides(b,n,t,i,s,r.frontUVs,r.backUVs);const S=new ue;if(S.indices=t,S.positions=n,S.normals=i,S.uvs=s,T){const C=b===ue.DOUBLESIDE?x.concat(x):x;S.colors=C}return S}function Rp(r,e={},t=null){const i=new G(r,t);return e.sideOrientation=G._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,QE(e).applyToMesh(i,e.updatable),i}function W2(r){const e=r.segments||32,n=r.arc&&(r.arc<=0||r.arc>1)?1:r.arc||1,o=r.slice&&r.slice<=0?1:r.slice||1,a=0===r.sideOrientation?0:r.sideOrientation||ue.DEFAULTSIDE,l=!!r.dedupTopBottomIndices,c=new v((r.diameterX||r.diameter||1)/2,(r.diameterY||r.diameter||1)/2,(r.diameterZ||r.diameter||1)/2),h=2+e,u=2*h,d=[],f=[],p=[],_=[];for(let g=0;g<=h;g++){const b=g/h,y=b*Math.PI*o;for(let T=0;T<=u;T++){const x=T/u,S=x*Math.PI*2*n,C=F.RotationZ(-y),D=F.RotationY(S),P=v.TransformCoordinates(v.Up(),C),M=v.TransformCoordinates(P,D),w=M.multiply(c),k=M.divide(c).normalize();f.push(w.x,w.y,w.z),p.push(k.x,k.y,k.z),_.push(x,It.UseOpenGLOrientationForUV?1-b:b)}if(g>0){const T=f.length/3;for(let x=T-2*(u+1);x+u+2<T;x++)l?(g>1&&(d.push(x),d.push(x+1),d.push(x+u+1)),(g<h||o<1)&&(d.push(x+u+1),d.push(x+1),d.push(x+u+2))):(d.push(x),d.push(x+1),d.push(x+u+1),d.push(x+u+1),d.push(x+1),d.push(x+u+2))}}ue._ComputeSides(a,f,d,p,_,r.frontUVs,r.backUVs);const m=new ue;return m.indices=d,m.positions=f,m.normals=p,m.uvs=_,m}function po(r,e={},t=null){const i=new G(r,t);return e.sideOrientation=G._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,W2(e).applyToMesh(i,e.updatable),i}function X2(r={subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){const e=Math.max(r.subdivisions?r.subdivisions:2,1),t=Math.max(r.tessellation?r.tessellation:16,3),i=Math.max(r.height?r.height:1,0),s=Math.max(r.radius?r.radius:.25,0),n=Math.max(r.capSubdivisions?r.capSubdivisions:6,1),o=t,a=e,l=Math.max(r.radiusTop?r.radiusTop:s,0),c=Math.max(r.radiusBottom?r.radiusBottom:s,0),h=i-(l+c),d=2*Math.PI,f=Math.max(r.topCapSubdivisions?r.topCapSubdivisions:n,1),p=Math.max(r.bottomCapSubdivisions?r.bottomCapSubdivisions:n,1),_=Math.acos((c-l)/i);let m=[];const g=[],b=[],y=[];let T=0;const x=[],S=.5*h,C=.5*Math.PI;let D,P;const M=v.Zero(),w=v.Zero(),k=Math.cos(_),X=Math.sin(_),te=new de(l*X,S+l*k).subtract(new de(c*X,c*k-S)).length(),J=l*_+te+c*(C-_);let Q=0;for(P=0;P<=f;P++){const K=[],O=C-_*(P/f);Q+=l*_/f;const H=Math.cos(O),Y=Math.sin(O),he=H*l;for(D=0;D<=o;D++){const Le=D/o,Fe=Le*d+0,se=Math.sin(Fe),_e=Math.cos(Fe);w.x=he*se,w.y=S+Y*l,w.z=he*_e,g.push(w.x,w.y,w.z),M.set(H*se,Y,H*_e),b.push(M.x,M.y,M.z),y.push(Le,It.UseOpenGLOrientationForUV?Q/J:1-Q/J),K.push(T),T++}x.push(K)}const me=i-l-c+k*l-k*c,ae=X*(c-l)/me;for(P=1;P<=a;P++){const K=[];Q+=te/a;const O=X*(P*(c-l)/a+l);for(D=0;D<=o;D++){const H=D/o,Y=H*d+0,he=Math.sin(Y),Le=Math.cos(Y);w.x=O*he,w.y=S+k*l-P*me/a,w.z=O*Le,g.push(w.x,w.y,w.z),M.set(he,ae,Le).normalize(),b.push(M.x,M.y,M.z),y.push(H,It.UseOpenGLOrientationForUV?Q/J:1-Q/J),K.push(T),T++}x.push(K)}for(P=1;P<=p;P++){const K=[],O=C-_-(Math.PI-_)*(P/p);Q+=c*_/p;const H=Math.cos(O),Y=Math.sin(O),he=H*c;for(D=0;D<=o;D++){const Le=D/o,Fe=Le*d+0,se=Math.sin(Fe),_e=Math.cos(Fe);w.x=he*se,w.y=Y*c-S,w.z=he*_e,g.push(w.x,w.y,w.z),M.set(H*se,Y,H*_e),b.push(M.x,M.y,M.z),y.push(Le,It.UseOpenGLOrientationForUV?Q/J:1-Q/J),K.push(T),T++}x.push(K)}for(D=0;D<o;D++)for(P=0;P<f+a+p;P++){const O=x[P+1][D],H=x[P+1][D+1],Y=x[P][D+1];m.push(x[P][D]),m.push(O),m.push(Y),m.push(O),m.push(H),m.push(Y)}if(m=m.reverse(),r.orientation&&!r.orientation.equals(v.Up())){const K=new F;r.orientation.clone().scale(.5*Math.PI).cross(v.Up()).toQuaternion().toRotationMatrix(K);const O=v.Zero();for(let H=0;H<g.length;H+=3)O.set(g[H],g[H+1],g[H+2]),v.TransformCoordinatesToRef(O.clone(),K,O),g[H]=O.x,g[H+1]=O.y,g[H+2]=O.z}const W=new ue;return W.positions=g,W.normals=b,W.uvs=y,W.indices=m,W}function ZE(r,e={orientation:v.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6,updatable:!1},t=null){const i=new G(r,t);return X2(e).applyToMesh(i,e.updatable),i}wv.InspectorURL=`https://unpkg.com/babylonjs-inspector@${ee.Version}/babylon.inspector.bundle.js`,ue.CreateBox=QE,G.CreateBox=(r,e,t=null,i,s)=>Rp(r,{size:e,sideOrientation:s,updatable:i},t),ue.CreateSphere=W2,G.CreateSphere=(r,e,t,i,s,n)=>po(r,{segments:e,diameterX:t,diameterY:t,diameterZ:t,sideOrientation:n,updatable:s},i),G.CreateCapsule=(r,e,t)=>ZE(r,e,t),ue.CreateCapsule=X2;const JE={effect:null,subMesh:null};class mn extends gp{constructor(e,t,i,s={},n=!0){super(e,t,n),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new F,this._cachedWorldViewProjectionMatrix=new F,this._multiview=!1,this._shaderPath=i,this._options={needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1,...s}}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){-1===this._options.uniforms.indexOf(e)&&this._options.uniforms.push(e)}setTexture(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._textures[e]=t,this}setTextureArray(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return-1===this._options.externalTextures.indexOf(e)&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce((i,s)=>(s.toArray(i,i.length),i),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce((i,s)=>(s.toArray(i,i.length),i),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce((i,s)=>(s.toArray(i,i.length),i),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);const i=new Float32Array(16*t.length);for(let s=0;s<t.length;s++)t[s].copyToArray(i,16*s);return this._matrixArrays[e]=i,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return-1===this._options.uniformBuffers.indexOf(e)&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return-1===this._options.samplerObjects.indexOf(e)&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return-1===this._options.storageBuffers.indexOf(e)&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}isReadyForSubMesh(e,t,i){return this.isReady(e,i,t)}isReady(e,t,i){var s,n,o,a;const l=i&&this._storeEffectOnSubMeshes;if(this.isFrozen)if(l){if(i.effect&&i.effect._wasPreviouslyReady)return!0}else{const P=this._drawWrapper.effect;if(P&&P._wasPreviouslyReady&&P._wasPreviouslyUsingInstances===t)return!0}const c=this.getScene(),h=c.getEngine(),u=[],d=[],f=new oh;let p=this._shaderPath,_=this._options.uniforms,m=this._options.uniformBuffers,g=this._options.samplers;h.getCaps().multiview&&c.activeCamera&&c.activeCamera.outputRenderTarget&&c.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,u.push("#define MULTIVIEW"),-1!==this._options.uniforms.indexOf("viewProjection")&&-1===this._options.uniforms.indexOf("viewProjectionR")&&this._options.uniforms.push("viewProjectionR"));for(let P=0;P<this._options.defines.length;P++){const M=0===this._options.defines[P].indexOf("#define")?this._options.defines[P]:`#define ${this._options.defines[P]}`;u.push(M)}for(let P=0;P<this._options.attributes.length;P++)d.push(this._options.attributes[P]);if(e&&e.isVerticesDataPresent(A.ColorKind)&&(d.push(A.ColorKind),u.push("#define VERTEXCOLOR")),t&&(u.push("#define INSTANCES"),ce.PushAttributesForInstances(d),e?.hasThinInstances&&(u.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(A.ColorInstanceKind)&&(d.push(A.ColorInstanceKind),u.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){d.push(A.MatricesIndicesKind),d.push(A.MatricesWeightsKind),e.numBoneInfluencers>4&&(d.push(A.MatricesIndicesExtraKind),d.push(A.MatricesWeightsExtraKind));const P=e.skeleton;u.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),f.addCPUSkinningFallback(0,e),P.isUsingTextureForMatrices?(u.push("#define BONETEXTURE"),-1===this._options.uniforms.indexOf("boneTextureWidth")&&this._options.uniforms.push("boneTextureWidth"),-1===this._options.samplers.indexOf("boneSampler")&&this._options.samplers.push("boneSampler")):(u.push("#define BonesPerMesh "+(P.bones.length+1)),-1===this._options.uniforms.indexOf("mBones")&&this._options.uniforms.push("mBones"))}else u.push("#define NUM_BONE_INFLUENCERS 0");let b=0;const y=e?e.morphTargetManager:null;if(y){const P=y.supportsUVs&&-1!==u.indexOf("#define UV1"),M=y.supportsTangents&&-1!==u.indexOf("#define TANGENT"),w=y.supportsNormals&&-1!==u.indexOf("#define NORMAL");b=y.numInfluencers,P&&u.push("#define MORPHTARGETS_UV"),M&&u.push("#define MORPHTARGETS_TANGENT"),w&&u.push("#define MORPHTARGETS_NORMAL"),b>0&&u.push("#define MORPHTARGETS"),y.isUsingTextureForTargets&&(u.push("#define MORPHTARGETS_TEXTURE"),-1===this._options.uniforms.indexOf("morphTargetTextureIndices")&&this._options.uniforms.push("morphTargetTextureIndices"),-1===this._options.samplers.indexOf("morphTargets")&&this._options.samplers.push("morphTargets")),u.push("#define NUM_MORPH_INFLUENCERS "+b);for(let k=0;k<b;k++)d.push(A.PositionKind+k),w&&d.push(A.NormalKind+k),M&&d.push(A.TangentKind+k),P&&d.push(A.UVKind+"_"+k);b>0&&(_=_.slice(),_.push("morphTargetInfluences"),_.push("morphTargetTextureInfo"),_.push("morphTargetTextureIndices"))}else u.push("#define NUM_MORPH_INFLUENCERS 0");if(e){const P=e.bakedVertexAnimationManager;P&&P.isEnabled&&(u.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),-1===this._options.uniforms.indexOf("bakedVertexAnimationSettings")&&this._options.uniforms.push("bakedVertexAnimationSettings"),-1===this._options.uniforms.indexOf("bakedVertexAnimationTextureSizeInverted")&&this._options.uniforms.push("bakedVertexAnimationTextureSizeInverted"),-1===this._options.uniforms.indexOf("bakedVertexAnimationTime")&&this._options.uniforms.push("bakedVertexAnimationTime"),-1===this._options.samplers.indexOf("bakedVertexAnimationTexture")&&this._options.samplers.push("bakedVertexAnimationTexture")),ce.PrepareAttributesForBakedVertexAnimation(d,e,u)}for(const P in this._textures)if(!this._textures[P].isReady())return!1;e&&this._shouldTurnAlphaTestOn(e)&&u.push("#define ALPHATEST"),!1!==this._options.useClipPlane&&(Uo(_),Za(this,c,u)),this.customShaderNameResolve&&(_=_.slice(),m=m.slice(),g=g.slice(),p=this.customShaderNameResolve(p,_,m,g,u,d));const T=l?i._getDrawWrapper():this._drawWrapper,x=null!==(s=T?.effect)&&void 0!==s?s:null,S=null!==(n=T?.defines)&&void 0!==n?n:null,C=u.join("\n");let D=x;return S!==C&&(D=h.createEffect(p,{attributes:d,uniformsNames:_,uniformBuffersNames:m,samplers:g,defines:C,fallbacks:f,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:b},shaderLanguage:this._options.shaderLanguage},h),l?i.setEffect(D,C,this._materialContext):T&&T.setEffect(D,C),this._onEffectCreatedObservable&&(JE.effect=D,JE.subMesh=null!==(o=i??e?.subMeshes[0])&&void 0!==o?o:null,this._onEffectCreatedObservable.notifyObservers(JE))),D._wasPreviouslyUsingInstances=!!t,null!==(a=!D?.isReady())&&void 0!==a&&!a&&(x!==D&&c.resetCachedMaterial(),D._wasPreviouslyReady=!0,!0)}bindOnlyWorldMatrix(e,t){const i=this.getScene(),s=t??this.getEffect();!s||(-1!==this._options.uniforms.indexOf("world")&&s.setMatrix("world",e),-1!==this._options.uniforms.indexOf("worldView")&&(e.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),s.setMatrix("worldView",this._cachedWorldViewMatrix)),-1!==this._options.uniforms.indexOf("worldViewProjection")&&(e.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),s.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)))}bindForSubMesh(e,t,i){var s;this.bind(e,t,null===(s=i._drawWrapperOverride)||void 0===s?void 0:s.effect,i)}bind(e,t,i,s){var n;const o=s&&this._storeEffectOnSubMeshes,a=i??(o?s.effect:this.getEffect());if(!a)return;this._activeEffect=a,this.bindOnlyWorldMatrix(e,i);const l=this._options.uniformBuffers;let c=!1;if(a&&l&&l.length>0&&this.getScene().getEngine().supportsUniformBuffers)for(let u=0;u<l.length;++u)switch(l[u]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e));break;case"Scene":ce.BindSceneUniformBuffer(a,this.getScene().getSceneUniformBuffer()),this.getScene().finalizeSceneUbo(),c=!0}const h=t&&o?this._mustRebind(this.getScene(),a,t.visibility):this.getScene().getCachedMaterial()!==this;if(a&&h){let u;for(u in!c&&-1!==this._options.uniforms.indexOf("view")&&a.setMatrix("view",this.getScene().getViewMatrix()),!c&&-1!==this._options.uniforms.indexOf("projection")&&a.setMatrix("projection",this.getScene().getProjectionMatrix()),!c&&-1!==this._options.uniforms.indexOf("viewProjection")&&(a.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._multiview&&a.setMatrix("viewProjectionR",this.getScene()._transformMatrixR)),this.getScene().activeCamera&&-1!==this._options.uniforms.indexOf("cameraPosition")&&a.setVector3("cameraPosition",this.getScene().activeCamera.globalPosition),ce.BindBonesParameters(t,a),fo(a,this,this.getScene()),this._textures)a.setTexture(u,this._textures[u]);for(u in this._textureArrays)a.setTextureArray(u,this._textureArrays[u]);for(u in this._externalTextures)a.setExternalTexture(u,this._externalTextures[u]);for(u in this._ints)a.setInt(u,this._ints[u]);for(u in this._uints)a.setUInt(u,this._uints[u]);for(u in this._floats)a.setFloat(u,this._floats[u]);for(u in this._floatsArrays)a.setArray(u,this._floatsArrays[u]);for(u in this._colors3)a.setColor3(u,this._colors3[u]);for(u in this._colors3Arrays)a.setArray3(u,this._colors3Arrays[u]);for(u in this._colors4){const d=this._colors4[u];a.setFloat4(u,d.r,d.g,d.b,d.a)}for(u in this._colors4Arrays)a.setArray4(u,this._colors4Arrays[u]);for(u in this._vectors2)a.setVector2(u,this._vectors2[u]);for(u in this._vectors3)a.setVector3(u,this._vectors3[u]);for(u in this._vectors4)a.setVector4(u,this._vectors4[u]);for(u in this._quaternions)a.setQuaternion(u,this._quaternions[u]);for(u in this._matrices)a.setMatrix(u,this._matrices[u]);for(u in this._matrixArrays)a.setMatrices(u,this._matrixArrays[u]);for(u in this._matrices3x3)a.setMatrix3x3(u,this._matrices3x3[u]);for(u in this._matrices2x2)a.setMatrix2x2(u,this._matrices2x2[u]);for(u in this._vectors2Arrays)a.setArray2(u,this._vectors2Arrays[u]);for(u in this._vectors3Arrays)a.setArray3(u,this._vectors3Arrays[u]);for(u in this._vectors4Arrays)a.setArray4(u,this._vectors4Arrays[u]);for(u in this._quaternionsArrays)a.setArray4(u,this._quaternionsArrays[u]);for(u in this._uniformBuffers){const d=this._uniformBuffers[u].getBuffer();d&&a.bindUniformBuffer(d,u)}for(u in this._textureSamplers)a.setTextureSampler(u,this._textureSamplers[u]);for(u in this._storageBuffers)a.setStorageBuffer(u,this._storageBuffers[u])}if(a&&t&&(h||!this.isFrozen)){const u=t.morphTargetManager;u&&u.numInfluencers>0&&ce.BindMorphTargetParameters(t,a);const d=t.bakedVertexAnimationManager;d&&d.isEnabled&&(null===(n=t.bakedVertexAnimationManager)||void 0===n||n.bind(a,!!a._wasPreviouslyUsingInstances))}this._afterBind(t,a)}getActiveTextures(){const e=super.getActiveTextures();for(const t in this._textures)e.push(this._textures[t]);for(const t in this._textureArrays){const i=this._textureArrays[t];for(let s=0;s<i.length;s++)e.push(i[s])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(const t in this._textures)if(this._textures[t]===e)return!0;for(const t in this._textureArrays){const i=this._textureArrays[t];for(let s=0;s<i.length;s++)if(i[s]===e)return!0}return!1}clone(e){const t=Ce.Clone(()=>new mn(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes),this);t.name=e,t.id=e,"object"==typeof t._shaderPath&&(t._shaderPath={...t._shaderPath}),this._options={...this._options},Object.keys(this._options).forEach(i=>{const s=this._options[i];Array.isArray(s)&&(this._options[i]=s.slice(0))}),this.stencil.copyTo(t.stencil);for(const i in this._textures)t.setTexture(i,this._textures[i]);for(const i in this._textureArrays)t.setTextureArray(i,this._textureArrays[i]);for(const i in this._externalTextures)t.setExternalTexture(i,this._externalTextures[i]);for(const i in this._ints)t.setInt(i,this._ints[i]);for(const i in this._uints)t.setUInt(i,this._uints[i]);for(const i in this._floats)t.setFloat(i,this._floats[i]);for(const i in this._floatsArrays)t.setFloats(i,this._floatsArrays[i]);for(const i in this._colors3)t.setColor3(i,this._colors3[i]);for(const i in this._colors3Arrays)t._colors3Arrays[i]=this._colors3Arrays[i];for(const i in this._colors4)t.setColor4(i,this._colors4[i]);for(const i in this._colors4Arrays)t._colors4Arrays[i]=this._colors4Arrays[i];for(const i in this._vectors2)t.setVector2(i,this._vectors2[i]);for(const i in this._vectors3)t.setVector3(i,this._vectors3[i]);for(const i in this._vectors4)t.setVector4(i,this._vectors4[i]);for(const i in this._quaternions)t.setQuaternion(i,this._quaternions[i]);for(const i in this._quaternionsArrays)t._quaternionsArrays[i]=this._quaternionsArrays[i];for(const i in this._matrices)t.setMatrix(i,this._matrices[i]);for(const i in this._matrixArrays)t._matrixArrays[i]=this._matrixArrays[i].slice();for(const i in this._matrices3x3)t.setMatrix3x3(i,this._matrices3x3[i]);for(const i in this._matrices2x2)t.setMatrix2x2(i,this._matrices2x2[i]);for(const i in this._vectors2Arrays)t.setArray2(i,this._vectors2Arrays[i]);for(const i in this._vectors3Arrays)t.setArray3(i,this._vectors3Arrays[i]);for(const i in this._vectors4Arrays)t.setArray4(i,this._vectors4Arrays[i]);for(const i in this._uniformBuffers)t.setUniformBuffer(i,this._uniformBuffers[i]);for(const i in this._textureSamplers)t.setTextureSampler(i,this._textureSamplers[i]);for(const i in this._storageBuffers)t.setStorageBuffer(i,this._storageBuffers[i]);return t}dispose(e,t,i){if(t){let s;for(s in this._textures)this._textures[s].dispose();for(s in this._textureArrays){const n=this._textureArrays[s];for(let o=0;o<n.length;o++)n[o].dispose()}}this._textures={},super.dispose(e,t,i)}serialize(){const e=Ce.Serialize(this);let t;for(t in e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes,e.stencil=this.stencil.serialize(),e.textures={},this._textures)e.textures[t]=this._textures[t].serialize();for(t in e.textureArrays={},this._textureArrays){e.textureArrays[t]=[];const i=this._textureArrays[t];for(let s=0;s<i.length;s++)e.textureArrays[t].push(i[s].serialize())}for(t in e.ints={},this._ints)e.ints[t]=this._ints[t];for(t in e.uints={},this._uints)e.uints[t]=this._uints[t];for(t in e.floats={},this._floats)e.floats[t]=this._floats[t];for(t in e.FloatArrays={},this._floatsArrays)e.FloatArrays[t]=this._floatsArrays[t];for(t in e.colors3={},this._colors3)e.colors3[t]=this._colors3[t].asArray();for(t in e.colors3Arrays={},this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];for(t in e.colors4={},this._colors4)e.colors4[t]=this._colors4[t].asArray();for(t in e.colors4Arrays={},this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];for(t in e.vectors2={},this._vectors2)e.vectors2[t]=this._vectors2[t].asArray();for(t in e.vectors3={},this._vectors3)e.vectors3[t]=this._vectors3[t].asArray();for(t in e.vectors4={},this._vectors4)e.vectors4[t]=this._vectors4[t].asArray();for(t in e.quaternions={},this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();for(t in e.matrices={},this._matrices)e.matrices[t]=this._matrices[t].asArray();for(t in e.matrixArray={},this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];for(t in e.matrices3x3={},this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];for(t in e.matrices2x2={},this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];for(t in e.vectors2Arrays={},this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];for(t in e.vectors3Arrays={},this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];for(t in e.vectors4Arrays={},this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];for(t in e.quaternionsArrays={},this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,i){const s=Ce.Parse(()=>new mn(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes),e,t,i);let n;for(n in e.stencil&&s.stencil.parse(e.stencil,t,i),e.textures)s.setTexture(n,U.Parse(e.textures[n],t,i));for(n in e.textureArrays){const o=e.textureArrays[n],a=new Array;for(let l=0;l<o.length;l++)a.push(U.Parse(o[l],t,i));s.setTextureArray(n,a)}for(n in e.ints)s.setInt(n,e.ints[n]);for(n in e.uints)s.setUInt(n,e.uints[n]);for(n in e.floats)s.setFloat(n,e.floats[n]);for(n in e.floatsArrays)s.setFloats(n,e.floatsArrays[n]);for(n in e.colors3)s.setColor3(n,re.FromArray(e.colors3[n]));for(n in e.colors3Arrays){const o=e.colors3Arrays[n].reduce((a,l,c)=>(c%3==0?a.push([l]):a[a.length-1].push(l),a),[]).map(a=>re.FromArray(a));s.setColor3Array(n,o)}for(n in e.colors4)s.setColor4(n,Te.FromArray(e.colors4[n]));for(n in e.colors4Arrays){const o=e.colors4Arrays[n].reduce((a,l,c)=>(c%4==0?a.push([l]):a[a.length-1].push(l),a),[]).map(a=>Te.FromArray(a));s.setColor4Array(n,o)}for(n in e.vectors2)s.setVector2(n,de.FromArray(e.vectors2[n]));for(n in e.vectors3)s.setVector3(n,v.FromArray(e.vectors3[n]));for(n in e.vectors4)s.setVector4(n,vt.FromArray(e.vectors4[n]));for(n in e.quaternions)s.setQuaternion(n,Z.FromArray(e.quaternions[n]));for(n in e.matrices)s.setMatrix(n,F.FromArray(e.matrices[n]));for(n in e.matrixArray)s._matrixArrays[n]=new Float32Array(e.matrixArray[n]);for(n in e.matrices3x3)s.setMatrix3x3(n,e.matrices3x3[n]);for(n in e.matrices2x2)s.setMatrix2x2(n,e.matrices2x2[n]);for(n in e.vectors2Arrays)s.setArray2(n,e.vectors2Arrays[n]);for(n in e.vectors3Arrays)s.setArray3(n,e.vectors3Arrays[n]);for(n in e.vectors4Arrays)s.setArray4(n,e.vectors4Arrays[n]);for(n in e.quaternionsArrays)s.setArray4(n,e.quaternionsArrays[n]);return s}static ParseFromFileAsync(e,t,i,s=""){return new Promise((n,o)=>{const a=new Yi;a.addEventListener("readystatechange",()=>{if(4==a.readyState)if(200==a.status){const l=JSON.parse(a.responseText),c=this.Parse(l,i||be.LastCreatedScene,s);e&&(c.name=e),n(c)}else o("Unable to load the ShaderMaterial")}),a.open("GET",t),a.send()})}static ParseFromSnippetAsync(e,t,i=""){return new Promise((s,n)=>{const o=new Yi;o.addEventListener("readystatechange",()=>{if(4==o.readyState)if(200==o.status){const a=JSON.parse(JSON.parse(o.responseText).jsonPayload),l=JSON.parse(a.shaderMaterial),c=this.Parse(l,t||be.LastCreatedScene,i);c.snippetId=e,s(c)}else n("Unable to load the snippet "+e)}),o.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),o.send()})}}mn.SnippetUrl="https://snippet.babylonjs.com",mn.CreateFromSnippetAsync=mn.ParseFromSnippetAsync,le("BABYLON.ShaderMaterial",mn);j.ShadersStore.colorPixelShader="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\n#define VERTEXCOLOR\nvarying vec4 vColor;\n#else\nuniform vec4 color;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\ngl_FragColor=vColor;\n#else\ngl_FragColor=color;\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}";j.ShadersStore.colorVertexShader="attribute vec3 position;\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(position,1.0);\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*worldPos;\n} else {\ngl_Position=viewProjectionR*worldPos;\n}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#include<clipPlaneVertex>\n#include<vertexColorMixing>\n#define CUSTOM_VERTEX_MAIN_END\n}",G._LinesMeshParser=(r,e)=>rc.Parse(r,e);class rc extends G{_isShaderMaterial(e){return"ShaderMaterial"===e.getClassName()}constructor(e,t=null,i=null,s=null,n,o,a,l){super(e,t,i,s,n),this.useVertexColor=o,this.useVertexAlpha=a,this.color=new re(1,1,1),this.alpha=1,s&&(this.color=s.color.clone(),this.alpha=s.alpha,this.useVertexColor=s.useVertexColor,this.useVertexAlpha=s.useVertexAlpha),this.intersectionThreshold=.1;const h={attributes:[A.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:[],useClipPlane:null};!1===a?h.needAlphaBlending=!1:h.defines.push("#define VERTEXALPHA"),o?(h.defines.push("#define VERTEXCOLOR"),h.attributes.push(A.ColorKind)):(h.uniforms.push("color"),this._color4=new Te),l?this.material=l:(this.material=new mn("colorShader",this.getScene(),"color",h,!1),this.material.doNotSerialize=!0)}isReady(){return!!this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage)&&super.isReady()}getClassName(){return"LinesMesh"}get material(){return this._lineMaterial}set material(e){this._lineMaterial=e,this._lineMaterial.fillMode=ie.LineListDrawMode}get checkCollisions(){return!1}set checkCollisions(e){}_bind(e,t){if(!this._geometry)return this;const i=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(this._userInstancedBuffersStorage?this._geometry._bind(t,i,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(t,i),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){const{r:s,g:n,b:o}=this.color;this._color4.set(s,n,o,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const s=this.getScene().getEngine();return this._unIndexed?s.drawArraysType(ie.LineListDrawMode,e.verticesStart,e.verticesCount,i):s.drawElementsType(ie.LineListDrawMode,e.indexStart,e.indexCount,i),this}dispose(e,t=!1,i){i||this._lineMaterial.dispose(!1,!1,!0),super.dispose(e)}clone(e,t=null,i){return new rc(e,this.getScene(),t,this,i)}createInstance(e){const t=new K2(e,this);if(this.instancedBuffers){t.instancedBuffers={};for(const i in this.instancedBuffers)t.instancedBuffers[i]=this.instancedBuffers[i]}return t}serialize(e){super.serialize(e),e.color=this.color.asArray(),e.alpha=this.alpha}static Parse(e,t){const i=new rc(e.name,t);return i.color=re.FromArray(e.color),i.alpha=e.alpha,i}}class K2 extends AE{constructor(e,t){super(e,t),this.intersectionThreshold=t.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}}function Q2(r){const e=[],t=[],i=r.lines,s=r.colors,n=[];let o=0;for(let l=0;l<i.length;l++){const c=i[l];for(let h=0;h<c.length;h++){if(t.push(c[h].x,c[h].y,c[h].z),s){const u=s[l];n.push(u[h].r,u[h].g,u[h].b,u[h].a)}h>0&&(e.push(o-1),e.push(o)),o++}}const a=new ue;return a.indices=e,a.positions=t,s&&(a.colors=n),a}function Z2(r){const e=r.dashSize||3,t=r.gapSize||1,i=r.dashNb||200,s=r.points,n=new Array,o=new Array,a=v.Zero();let l=0,c=0,h=0,u=0,d=0,f=0,p=0;for(p=0;p<s.length-1;p++)s[p+1].subtractToRef(s[p],a),l+=a.length();for(h=l/i,u=e*h/(e+t),p=0;p<s.length-1;p++){s[p+1].subtractToRef(s[p],a),c=Math.floor(a.length()/h),a.normalize();for(let m=0;m<c;m++)d=h*m,n.push(s[p].x+d*a.x,s[p].y+d*a.y,s[p].z+d*a.z),n.push(s[p].x+(d+u)*a.x,s[p].y+(d+u)*a.y,s[p].z+(d+u)*a.z),o.push(f,f+1),f+=2}const _=new ue;return _.positions=n,_.indices=o,_}function eC(r,e,t){const i=e.instance,s=e.lines,n=e.colors;if(i){const c=i.getVerticesData(A.PositionKind);let h,u;n&&(h=i.getVerticesData(A.ColorKind));let d=0,f=0;for(let p=0;p<s.length;p++){const _=s[p];for(let m=0;m<_.length;m++)c[d]=_[m].x,c[d+1]=_[m].y,c[d+2]=_[m].z,n&&h&&(u=n[p],h[f]=u[m].r,h[f+1]=u[m].g,h[f+2]=u[m].b,h[f+3]=u[m].a,f+=4),d+=3}return i.updateVerticesData(A.PositionKind,c,!1,!1),n&&h&&i.updateVerticesData(A.ColorKind,h,!1,!1),i}const a=new rc(r,t,null,void 0,void 0,!!n,e.useVertexAlpha,e.material);return Q2(e).applyToMesh(a,e.updatable),a}function Ip(r,e,t=null){return eC(r,{lines:[e.points],updatable:e.updatable,instance:e.instance,colors:e.colors?[e.colors]:null,useVertexAlpha:e.useVertexAlpha,material:e.material},t)}function tC(r,e,t=null){const i=e.points,s=e.instance,n=e.gapSize||1,o=e.dashSize||3;if(s){const c=h=>{const u=v.Zero(),d=h.length/6;let f=0,p=0,_=0,m=0,g=0,b=0,y=0,T=0;for(y=0;y<i.length-1;y++)i[y+1].subtractToRef(i[y],u),f+=u.length();_=f/d;const x=s._creationDataStorage.dashSize;for(m=x*_/(x+s._creationDataStorage.gapSize),y=0;y<i.length-1;y++)for(i[y+1].subtractToRef(i[y],u),p=Math.floor(u.length()/_),u.normalize(),T=0;T<p&&b<h.length;)g=_*T,h[b]=i[y].x+g*u.x,h[b+1]=i[y].y+g*u.y,h[b+2]=i[y].z+g*u.z,h[b+3]=i[y].x+(g+m)*u.x,h[b+4]=i[y].y+(g+m)*u.y,h[b+5]=i[y].z+(g+m)*u.z,b+=6,T++;for(;b<h.length;)h[b]=i[y].x,h[b+1]=i[y].y,h[b+2]=i[y].z,b+=3};return(e.dashNb||e.dashSize||e.gapSize||e.useVertexAlpha||e.material)&&V.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),s.updateMeshPositions(c,!1),s}const a=new rc(r,t,null,void 0,void 0,void 0,e.useVertexAlpha,e.material);return Z2(e).applyToMesh(a,e.updatable),a._creationDataStorage=new T1,a._creationDataStorage.dashSize=o,a._creationDataStorage.gapSize=n,a}function eV(r){let e=r.pathArray;const t=r.closeArray||!1,i=r.closePath||!1,s=r.invertUV||!1,n=Math.floor(e[0].length/2);let o=r.offset||n;o=o>n?n:Math.floor(o);const a=0===r.sideOrientation?0:r.sideOrientation||ue.DEFAULTSIDE,l=r.uvs,c=r.colors,h=[],u=[],d=[],f=[],p=[],_=[],m=[],g=[];let b;const y=[],T=[];let x,S,C;if(e.length<2){const Ae=[],Ie=[];for(S=0;S<e[0].length-o;S++)Ae.push(e[0][S]),Ie.push(e[0][S+o]);e=[Ae,Ie]}let D=0;const P=i?1:0;let M,w,k,X;for(b=e[0].length,x=0;x<e.length;x++){for(m[x]=0,p[x]=[0],M=e[x],w=M.length,b=b<w?b:w,C=0;C<w;)h.push(M[C].x,M[C].y,M[C].z),C>0&&(k=M[C].subtract(M[C-1]).length(),X=k+m[x],p[x].push(X),m[x]=X),C++;i&&(C--,h.push(M[0].x,M[0].y,M[0].z),k=M[C].subtract(M[0]).length(),X=k+m[x],p[x].push(X),m[x]=X),y[x]=w+P,T[x]=D,D+=w+P}let te,J,ae,W,Q=null,me=null;for(S=0;S<b+P;S++){for(g[S]=0,_[S]=[0],x=0;x<e.length-1;x++)te=e[x],J=e[x+1],S===b?(Q=te[0],me=J[0]):(Q=te[S],me=J[S]),k=me.subtract(Q).length(),X=k+g[S],_[S].push(X),g[S]=X;t&&me&&Q&&(te=e[x],J=e[0],S===b&&(me=J[0]),k=me.subtract(Q).length(),X=k+g[S],g[S]=X)}if(l)for(x=0;x<l.length;x++)f.push(l[x].x,It.UseOpenGLOrientationForUV?1-l[x].y:l[x].y);else for(x=0;x<e.length;x++)for(S=0;S<b+P;S++)ae=0!=m[x]?p[x][S]/m[x]:0,W=0!=g[S]?_[S][x]/g[S]:0,s?f.push(W,ae):f.push(ae,It.UseOpenGLOrientationForUV?1-W:W);x=0;let K=0,O=y[x]-1,H=y[x+1]-1,Y=O<H?O:H,he=T[1]-T[0];const Le=t?y.length:y.length-1;for(;K<=Y&&x<Le;)u.push(K,K+he,K+1),u.push(K+he+1,K+1,K+he),K+=1,K===Y&&(x++,x===y.length-1?(he=T[0]-T[x],O=y[x]-1,H=y[0]-1):(he=T[x+1]-T[x],O=y[x]-1,H=y[x+1]-1),K=T[x],Y=O<H?O+K:H+K);if(ue.ComputeNormals(h,u,d),i){let Ae=0,Ie=0;for(x=0;x<e.length;x++)Ae=3*T[x],Ie=x+1<e.length?3*(T[x+1]-1):d.length-3,d[Ae]=.5*(d[Ae]+d[Ie]),d[Ae+1]=.5*(d[Ae+1]+d[Ie+1]),d[Ae+2]=.5*(d[Ae+2]+d[Ie+2]),d[Ie]=d[Ae],d[Ie+1]=d[Ae+1],d[Ie+2]=d[Ae+2]}ue._ComputeSides(a,h,u,d,f,r.frontUVs,r.backUVs);let Fe=null;if(c){Fe=new Float32Array(4*c.length);for(let Ae=0;Ae<c.length;Ae++)Fe[4*Ae]=c[Ae].r,Fe[4*Ae+1]=c[Ae].g,Fe[4*Ae+2]=c[Ae].b,Fe[4*Ae+3]=c[Ae].a}const se=new ue,_e=new Float32Array(h),rt=new Float32Array(d),Ze=new Float32Array(f);return se.indices=u,se.positions=_e,se.normals=rt,se.uvs=Ze,Fe&&se.set(Fe,A.ColorKind),i&&(se._idx=T),se}function nc(r,e,t=null){const i=e.pathArray,s=e.closeArray,n=e.closePath,o=G._GetDefaultSideOrientation(e.sideOrientation),a=e.instance,l=e.updatable;if(a){const c=L.Vector3[0].setAll(Number.MAX_VALUE),h=L.Vector3[1].setAll(-Number.MAX_VALUE),u=f=>{let p=i[0].length;const _=a;let m=0;const g=_._originalBuilderSideOrientation===G.DOUBLESIDE?2:1;for(let b=1;b<=g;++b)for(let y=0;y<i.length;++y){const T=i[y],x=T.length;p=p<x?p:x;for(let S=0;S<p;++S){const C=T[S];f[m]=C.x,f[m+1]=C.y,f[m+2]=C.z,c.minimizeInPlaceFromFloats(C.x,C.y,C.z),h.maximizeInPlaceFromFloats(C.x,C.y,C.z),m+=3}if(_._creationDataStorage&&_._creationDataStorage.closePath){const S=T[0];f[m]=S.x,f[m+1]=S.y,f[m+2]=S.z,m+=3}}},d=a.getVerticesData(A.PositionKind);if(u(d),a.hasBoundingInfo?a.getBoundingInfo().reConstruct(c,h,a._worldMatrix):a.buildBoundingInfo(c,h,a._worldMatrix),a.updateVerticesData(A.PositionKind,d,!1,!1),e.colors){const f=a.getVerticesData(A.ColorKind);for(let p=0,_=0;p<e.colors.length;p++,_+=4){const m=e.colors[p];f[_]=m.r,f[_+1]=m.g,f[_+2]=m.b,f[_+3]=m.a}a.updateVerticesData(A.ColorKind,f,!1,!1)}if(e.uvs){const f=a.getVerticesData(A.UVKind);for(let p=0;p<e.uvs.length;p++)f[2*p]=e.uvs[p].x,f[2*p+1]=It.UseOpenGLOrientationForUV?1-e.uvs[p].y:e.uvs[p].y;a.updateVerticesData(A.UVKind,f,!1,!1)}if(!a.areNormalsFrozen||a.isFacetDataEnabled){const f=a.getIndices(),p=a.getVerticesData(A.NormalKind),_=a.isFacetDataEnabled?a.getFacetDataParameters():null;if(ue.ComputeNormals(d,f,p,_),a._creationDataStorage&&a._creationDataStorage.closePath){let m=0,g=0;for(let b=0;b<i.length;b++)m=3*a._creationDataStorage.idx[b],g=b+1<i.length?3*(a._creationDataStorage.idx[b+1]-1):p.length-3,p[m]=.5*(p[m]+p[g]),p[m+1]=.5*(p[m+1]+p[g+1]),p[m+2]=.5*(p[m+2]+p[g+2]),p[g]=p[m],p[g+1]=p[m+1],p[g+2]=p[m+2]}a.areNormalsFrozen||a.updateVerticesData(A.NormalKind,p,!1,!1)}return a}{const c=new G(r,t);c._originalBuilderSideOrientation=o,c._creationDataStorage=new T1;const h=eV(e);return n&&(c._creationDataStorage.idx=h._idx),c._creationDataStorage.closePath=n,c._creationDataStorage.closeArray=s,h.applyToMesh(c,l),c}}function Ov(r,e,t=null){const i=e.path,s=e.shape,n=e.scale||1,o=e.rotation||0,a=0===e.cap?0:e.cap||G.NO_CAP,l=e.updatable,c=G._GetDefaultSideOrientation(e.sideOrientation);return tV(r,s,i,n,o,null,null,e.closePath||!1,e.closeShape||!1,a,!1,t,!!l,c,e.instance||null,e.invertUV||!1,e.frontUVs||null,e.backUVs||null,e.firstNormal||null,!!e.adjustFrame)}function iC(r,e,t=null){const u=e.firstNormal||null,d=e.adjustFrame||!1;return tV(r,e.shape,e.path,null,null,e.scaleFunction||(()=>1),e.rotationFunction||(()=>0),e.closePath||e.ribbonCloseArray||!1,e.closeShape||e.ribbonClosePath||!1,0===e.cap?0:e.cap||G.NO_CAP,!0,t,!!e.updatable,G._GetDefaultSideOrientation(e.sideOrientation),e.instance||null,e.invertUV||!1,e.frontUVs||null,e.backUVs||null,u,d)}function tV(r,e,t,i,s,n,o,a,l,c,h,u,d,f,p,_,m,g,b,y){const T=(P,M,w,k,X,te,J,Q,me,ae,W)=>{const K=w.getTangents(),O=w.getNormals(),H=w.getBinormals(),Y=w.getDistances();if(W)for(let Ie=0;Ie<K.length;Ie++)if(0==K[Ie].x&&0==K[Ie].y&&0==K[Ie].z&&K[Ie].copyFrom(K[Ie-1]),0==O[Ie].x&&0==O[Ie].y&&0==O[Ie].z&&O[Ie].copyFrom(O[Ie-1]),0==H[Ie].x&&0==H[Ie].y&&0==H[Ie].z&&H[Ie].copyFrom(H[Ie-1]),Ie>0){let ct=K[Ie-1];v.Dot(ct,K[Ie])<0&&K[Ie].scaleInPlace(-1),ct=O[Ie-1],v.Dot(ct,O[Ie])<0&&O[Ie].scaleInPlace(-1),ct=H[Ie-1],v.Dot(ct,H[Ie])<0&&H[Ie].scaleInPlace(-1)}let he=0;const se=ae&&Q?Q:()=>null!==te?te:0,_e=ae&&J?J:()=>null!==X?X:1;let rt=me===G.NO_CAP||me===G.CAP_END?0:2;const Ze=L.Matrix[0];for(let Ie=0;Ie<M.length;Ie++){const ct=new Array,Ct=se(Ie,Y[Ie]),Mt=_e(Ie,Y[Ie]);F.RotationAxisToRef(K[Ie],he,Ze);for(let Ke=0;Ke<P.length;Ke++){const as=K[Ie].scale(P[Ke].z).add(O[Ie].scale(P[Ke].x)).add(H[Ie].scale(P[Ke].y)),Xi=v.Zero();v.TransformCoordinatesToRef(as,Ze,Xi),Xi.scaleInPlace(Mt).addInPlace(M[Ie]),ct[Ke]=Xi}k[rt]=ct,he+=Ct,rt++}const Ae=Ie=>{const ct=Array(),Ct=v.Zero();let Mt;for(Mt=0;Mt<Ie.length;Mt++)Ct.addInPlace(Ie[Mt]);for(Ct.scaleInPlace(1/Ie.length),Mt=0;Mt<Ie.length;Mt++)ct.push(Ct);return ct};switch(me){case G.NO_CAP:break;case G.CAP_START:k[0]=Ae(k[2]),k[1]=k[2];break;case G.CAP_END:k[rt]=k[rt-1],k[rt+1]=Ae(k[rt-1]);break;case G.CAP_ALL:k[0]=Ae(k[2]),k[1]=k[2],k[rt]=k[rt-1],k[rt+1]=Ae(k[rt-1])}return k};let x,S;if(p){const P=p._creationDataStorage;return x=b?P.path3D.update(t,b):P.path3D.update(t),S=T(e,t,P.path3D,P.pathArray,i,s,n,o,P.cap,h,y),nc("",{pathArray:S,closeArray:!1,closePath:!1,offset:0,updatable:!1,sideOrientation:0,instance:p},u||void 0)}x=b?new pp(t,b):new pp(t),S=T(e,t,x,new Array,i,s,n,o,c=c<0||c>3?0:c,h,y);const D=nc(r,{pathArray:S,closeArray:a,closePath:l,updatable:d,sideOrientation:f,invertUV:_,frontUVs:m||void 0,backUVs:g||void 0},u);return D._creationDataStorage.pathArray=S,D._creationDataStorage.path3D=x,D._creationDataStorage.cap=c,D}ue.CreateLineSystem=Q2,ue.CreateDashedLines=Z2,G.CreateLines=(r,e,t=null,i=!1,s=null)=>Ip(r,{points:e,updatable:i,instance:s},t),G.CreateDashedLines=(r,e,t,i,s,n=null,o,a)=>tC(r,{points:e,dashSize:t,gapSize:i,dashNb:s,updatable:o,instance:a},n),ue.CreateRibbon=eV,G.CreateRibbon=(r,e,t=!1,i,s,n,o=!1,a,l)=>nc(r,{pathArray:e,closeArray:t,closePath:i,offset:s,updatable:o,sideOrientation:a,instance:l},n),G.ExtrudeShape=(r,e,t,i,s,n,o=null,a,l,c)=>Ov(r,{shape:e,path:t,scale:i,rotation:s,cap:0===n?0:n||G.NO_CAP,sideOrientation:l,instance:c,updatable:a},o),G.ExtrudeShapeCustom=(r,e,t,i,s,n,o,a,l,c,h,u)=>iC(r,{shape:e,path:t,scaleFunction:i,rotationFunction:s,ribbonCloseArray:n,ribbonClosePath:o,cap:0===a?0:a||G.NO_CAP,sideOrientation:h,instance:u,updatable:c},l);let gh=(()=>{class r{}return r.ALPHA_DISABLE=0,r.ALPHA_ADD=1,r.ALPHA_COMBINE=2,r.ALPHA_SUBTRACT=3,r.ALPHA_MULTIPLY=4,r.ALPHA_MAXIMIZED=5,r.ALPHA_ONEONE=6,r.ALPHA_PREMULTIPLIED=7,r.ALPHA_PREMULTIPLIED_PORTERDUFF=8,r.ALPHA_INTERPOLATE=9,r.ALPHA_SCREENMODE=10,r.ALPHA_ONEONE_ONEONE=11,r.ALPHA_ALPHATOCOLOR=12,r.ALPHA_REVERSEONEMINUS=13,r.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,r.ALPHA_ONEONE_ONEZERO=15,r.ALPHA_EXCLUSION=16,r.ALPHA_LAYER_ACCUMULATE=17,r.ALPHA_EQUATION_ADD=0,r.ALPHA_EQUATION_SUBSTRACT=1,r.ALPHA_EQUATION_REVERSE_SUBTRACT=2,r.ALPHA_EQUATION_MAX=3,r.ALPHA_EQUATION_MIN=4,r.ALPHA_EQUATION_DARKEN=5,r.DELAYLOADSTATE_NONE=0,r.DELAYLOADSTATE_LOADED=1,r.DELAYLOADSTATE_LOADING=2,r.DELAYLOADSTATE_NOTLOADED=4,r.NEVER=512,r.ALWAYS=519,r.LESS=513,r.EQUAL=514,r.LEQUAL=515,r.GREATER=516,r.GEQUAL=518,r.NOTEQUAL=517,r.KEEP=7680,r.ZERO=0,r.REPLACE=7681,r.INCR=7682,r.DECR=7683,r.INVERT=5386,r.INCR_WRAP=34055,r.DECR_WRAP=34056,r.TEXTURE_CLAMP_ADDRESSMODE=0,r.TEXTURE_WRAP_ADDRESSMODE=1,r.TEXTURE_MIRROR_ADDRESSMODE=2,r.TEXTURE_CREATIONFLAG_STORAGE=1,r.TEXTUREFORMAT_ALPHA=0,r.TEXTUREFORMAT_LUMINANCE=1,r.TEXTUREFORMAT_LUMINANCE_ALPHA=2,r.TEXTUREFORMAT_RGB=4,r.TEXTUREFORMAT_RGBA=5,r.TEXTUREFORMAT_RED=6,r.TEXTUREFORMAT_R=6,r.TEXTUREFORMAT_RG=7,r.TEXTUREFORMAT_RED_INTEGER=8,r.TEXTUREFORMAT_R_INTEGER=8,r.TEXTUREFORMAT_RG_INTEGER=9,r.TEXTUREFORMAT_RGB_INTEGER=10,r.TEXTUREFORMAT_RGBA_INTEGER=11,r.TEXTUREFORMAT_BGRA=12,r.TEXTUREFORMAT_DEPTH24_STENCIL8=13,r.TEXTUREFORMAT_DEPTH32_FLOAT=14,r.TEXTUREFORMAT_DEPTH16=15,r.TEXTUREFORMAT_DEPTH24=16,r.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17,r.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18,r.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493,r.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,r.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,r.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917,r.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916,r.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840,r.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196,r.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493,r.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494,r.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495,r.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497,r.TEXTURETYPE_UNSIGNED_BYTE=0,r.TEXTURETYPE_UNSIGNED_INT=0,r.TEXTURETYPE_FLOAT=1,r.TEXTURETYPE_HALF_FLOAT=2,r.TEXTURETYPE_BYTE=3,r.TEXTURETYPE_SHORT=4,r.TEXTURETYPE_UNSIGNED_SHORT=5,r.TEXTURETYPE_INT=6,r.TEXTURETYPE_UNSIGNED_INTEGER=7,r.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,r.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,r.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,r.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,r.TEXTURETYPE_UNSIGNED_INT_24_8=12,r.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,r.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,r.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,r.TEXTURETYPE_UNDEFINED=16,r.TEXTURE_NEAREST_SAMPLINGMODE=1,r.TEXTURE_NEAREST_NEAREST=1,r.TEXTURE_BILINEAR_SAMPLINGMODE=2,r.TEXTURE_LINEAR_LINEAR=2,r.TEXTURE_TRILINEAR_SAMPLINGMODE=3,r.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,r.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,r.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,r.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,r.TEXTURE_NEAREST_LINEAR=7,r.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,r.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,r.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,r.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,r.TEXTURE_LINEAR_NEAREST=12,r.TEXTURE_EXPLICIT_MODE=0,r.TEXTURE_SPHERICAL_MODE=1,r.TEXTURE_PLANAR_MODE=2,r.TEXTURE_CUBIC_MODE=3,r.TEXTURE_PROJECTION_MODE=4,r.TEXTURE_SKYBOX_MODE=5,r.TEXTURE_INVCUBIC_MODE=6,r.TEXTURE_EQUIRECTANGULAR_MODE=7,r.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,r.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,r.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,r.TEXTURE_FILTERING_QUALITY_HIGH=64,r.TEXTURE_FILTERING_QUALITY_MEDIUM=16,r.TEXTURE_FILTERING_QUALITY_LOW=8,r.SCALEMODE_FLOOR=1,r.SCALEMODE_NEAREST=2,r.SCALEMODE_CEILING=3,r.MATERIAL_TextureDirtyFlag=1,r.MATERIAL_LightDirtyFlag=2,r.MATERIAL_FresnelDirtyFlag=4,r.MATERIAL_AttributesDirtyFlag=8,r.MATERIAL_MiscDirtyFlag=16,r.MATERIAL_PrePassDirtyFlag=32,r.MATERIAL_AllDirtyFlag=63,r.MATERIAL_TriangleFillMode=0,r.MATERIAL_WireFrameFillMode=1,r.MATERIAL_PointFillMode=2,r.MATERIAL_PointListDrawMode=3,r.MATERIAL_LineListDrawMode=4,r.MATERIAL_LineLoopDrawMode=5,r.MATERIAL_LineStripDrawMode=6,r.MATERIAL_TriangleStripDrawMode=7,r.MATERIAL_TriangleFanDrawMode=8,r.MATERIAL_ClockWiseSideOrientation=0,r.MATERIAL_CounterClockWiseSideOrientation=1,r.ACTION_NothingTrigger=0,r.ACTION_OnPickTrigger=1,r.ACTION_OnLeftPickTrigger=2,r.ACTION_OnRightPickTrigger=3,r.ACTION_OnCenterPickTrigger=4,r.ACTION_OnPickDownTrigger=5,r.ACTION_OnDoublePickTrigger=6,r.ACTION_OnPickUpTrigger=7,r.ACTION_OnPickOutTrigger=16,r.ACTION_OnLongPressTrigger=8,r.ACTION_OnPointerOverTrigger=9,r.ACTION_OnPointerOutTrigger=10,r.ACTION_OnEveryFrameTrigger=11,r.ACTION_OnIntersectionEnterTrigger=12,r.ACTION_OnIntersectionExitTrigger=13,r.ACTION_OnKeyDownTrigger=14,r.ACTION_OnKeyUpTrigger=15,r.PARTICLES_BILLBOARDMODE_Y=2,r.PARTICLES_BILLBOARDMODE_ALL=7,r.PARTICLES_BILLBOARDMODE_STRETCHED=8,r.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9,r.MESHES_CULLINGSTRATEGY_STANDARD=0,r.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,r.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,r.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,r.SCENELOADER_NO_LOGGING=0,r.SCENELOADER_MINIMAL_LOGGING=1,r.SCENELOADER_SUMMARY_LOGGING=2,r.SCENELOADER_DETAILED_LOGGING=3,r.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,r.PREPASS_POSITION_TEXTURE_TYPE=1,r.PREPASS_VELOCITY_TEXTURE_TYPE=2,r.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,r.PREPASS_COLOR_TEXTURE_TYPE=4,r.PREPASS_DEPTH_TEXTURE_TYPE=5,r.PREPASS_NORMAL_TEXTURE_TYPE=6,r.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7,r.BUFFER_CREATIONFLAG_READ=1,r.BUFFER_CREATIONFLAG_WRITE=2,r.BUFFER_CREATIONFLAG_READWRITE=3,r.BUFFER_CREATIONFLAG_UNIFORM=4,r.BUFFER_CREATIONFLAG_VERTEX=8,r.BUFFER_CREATIONFLAG_INDEX=16,r.BUFFER_CREATIONFLAG_STORAGE=32,r.RENDERPASS_MAIN=0,r.INPUT_ALT_KEY=18,r.INPUT_CTRL_KEY=17,r.INPUT_META_KEY1=91,r.INPUT_META_KEY2=92,r.INPUT_META_KEY3=93,r.INPUT_SHIFT_KEY=16,r.SNAPSHOTRENDERING_STANDARD=0,r.SNAPSHOTRENDERING_FAST=1,r.PERSPECTIVE_CAMERA=0,r.ORTHOGRAPHIC_CAMERA=1,r.FOVMODE_VERTICAL_FIXED=0,r.FOVMODE_HORIZONTAL_FIXED=1,r.RIG_MODE_NONE=0,r.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,r.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,r.RIG_MODE_STEREOSCOPIC_INTERLACED=14,r.RIG_MODE_VR=20,r.RIG_MODE_WEBVR=21,r.RIG_MODE_CUSTOM=22,r.MAX_SUPPORTED_UV_SETS=6,r.GL_ALPHA_EQUATION_ADD=32774,r.GL_ALPHA_EQUATION_MIN=32775,r.GL_ALPHA_EQUATION_MAX=32776,r.GL_ALPHA_EQUATION_SUBTRACT=32778,r.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779,r.GL_ALPHA_FUNCTION_SRC=768,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769,r.GL_ALPHA_FUNCTION_SRC_ALPHA=770,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771,r.GL_ALPHA_FUNCTION_DST_ALPHA=772,r.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773,r.GL_ALPHA_FUNCTION_DST_COLOR=774,r.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775,r.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776,r.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769,r.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770,r.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771,r.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772,r.SnippetUrl="https://snippet.babylonjs.com",r})();we.prototype._debugPushGroup=function(r,e){},we.prototype._debugPopGroup=function(r){},we.prototype._debugInsertMarker=function(r,e){},we.prototype._debugFlushPendingCommands=function(){};class hre{constructor(){this._timeElapsedQueryEnded=!1}}class ure{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=Zt.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=Zt.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}}ee.prototype.createQuery=function(){const r=this._gl.createQuery();if(!r)throw new Error("Unable to create Occlusion Query");return r},ee.prototype.deleteQuery=function(r){return this._gl.deleteQuery(r),this},ee.prototype.isQueryResultAvailable=function(r){return this._gl.getQueryParameter(r,this._gl.QUERY_RESULT_AVAILABLE)},ee.prototype.getQueryResult=function(r){return this._gl.getQueryParameter(r,this._gl.QUERY_RESULT)},ee.prototype.beginOcclusionQuery=function(r,e){const t=this._getGlAlgorithmType(r);return this._gl.beginQuery(t,e),!0},ee.prototype.endOcclusionQuery=function(r){const e=this._getGlAlgorithmType(r);return this._gl.endQuery(e),this},ee.prototype._createTimeQuery=function(){const r=this.getCaps().timerQuery;return r.createQueryEXT?r.createQueryEXT():this.createQuery()},ee.prototype._deleteTimeQuery=function(r){const e=this.getCaps().timerQuery;e.deleteQueryEXT?e.deleteQueryEXT(r):this.deleteQuery(r)},ee.prototype._getTimeQueryResult=function(r){const e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(r,e.QUERY_RESULT_EXT):this.getQueryResult(r)},ee.prototype._getTimeQueryAvailability=function(r){const e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(r,e.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(r)},ee.prototype.startTimeQuery=function(){const r=this.getCaps(),e=r.timerQuery;if(!e)return null;const t=new hre;if(this._gl.getParameter(e.GPU_DISJOINT_EXT),r.canUseTimestampForTimerQuery)t._startTimeQuery=this._createTimeQuery(),e.queryCounterEXT(t._startTimeQuery,e.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;t._timeElapsedQuery=this._createTimeQuery(),e.beginQueryEXT?e.beginQueryEXT(e.TIME_ELAPSED_EXT,t._timeElapsedQuery):this._gl.beginQuery(e.TIME_ELAPSED_EXT,t._timeElapsedQuery),this._currentNonTimestampToken=t}return t},ee.prototype.endTimeQuery=function(r){const e=this.getCaps(),t=e.timerQuery;if(!t||!r)return-1;if(e.canUseTimestampForTimerQuery){if(!r._startTimeQuery)return-1;r._endTimeQuery||(r._endTimeQuery=this._createTimeQuery(),t.queryCounterEXT(r._endTimeQuery,t.TIMESTAMP_EXT))}else if(!r._timeElapsedQueryEnded){if(!r._timeElapsedQuery)return-1;t.endQueryEXT?t.endQueryEXT(t.TIME_ELAPSED_EXT):(this._gl.endQuery(t.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),r._timeElapsedQueryEnded=!0}const i=this._gl.getParameter(t.GPU_DISJOINT_EXT);let s=!1;if(r._endTimeQuery?s=this._getTimeQueryAvailability(r._endTimeQuery):r._timeElapsedQuery&&(s=this._getTimeQueryAvailability(r._timeElapsedQuery)),s&&!i){let n=0;if(e.canUseTimestampForTimerQuery){if(!r._startTimeQuery||!r._endTimeQuery)return-1;const o=this._getTimeQueryResult(r._startTimeQuery);n=this._getTimeQueryResult(r._endTimeQuery)-o,this._deleteTimeQuery(r._startTimeQuery),this._deleteTimeQuery(r._endTimeQuery),r._startTimeQuery=null,r._endTimeQuery=null}else{if(!r._timeElapsedQuery)return-1;n=this._getTimeQueryResult(r._timeElapsedQuery),this._deleteTimeQuery(r._timeElapsedQuery),r._timeElapsedQuery=null,r._timeElapsedQueryEnded=!1}return n}return-1},ee.prototype._captureGPUFrameTime=!1,ee.prototype._gpuFrameTime=new eh,ee.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime},ee.prototype.captureGPUFrameTime=function(r){r!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=r,r?(this._onBeginFrameObserver=this.onBeginFrameObservable.add(()=>{this._gpuFrameTimeToken||(this._gpuFrameTimeToken=this.startTimeQuery())}),this._onEndFrameObserver=this.onEndFrameObservable.add(()=>{if(!this._gpuFrameTimeToken)return;const e=this.endTimeQuery(this._gpuFrameTimeToken);e>-1&&(this._gpuFrameTimeToken=null,this._gpuFrameTime.fetchNewFrame(),this._gpuFrameTime.addCount(e,!0))})):(this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null))},ee.prototype._getGlAlgorithmType=function(r){return r===Zt.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED},Object.defineProperty(Zt.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(r){this._occlusionDataStorage.isOcclusionQueryInProgress=r},enumerable:!1,configurable:!0}),Object.defineProperty(Zt.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new ure),this.__occlusionDataStorage},enumerable:!1,configurable:!0}),Object.defineProperty(Zt.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(r){this._occlusionDataStorage.isOccluded=r},enumerable:!0,configurable:!0}),Object.defineProperty(Zt.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(r){this._occlusionDataStorage.occlusionQueryAlgorithmType=r},enumerable:!0,configurable:!0}),Object.defineProperty(Zt.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(r){this._occlusionDataStorage.occlusionType=r},enumerable:!0,configurable:!0}),Object.defineProperty(Zt.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(r){this._occlusionDataStorage.occlusionRetryCount=r},enumerable:!0,configurable:!0}),Object.defineProperty(Zt.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(r){this._occlusionDataStorage.forceRenderingWhenOccluded=r},enumerable:!0,configurable:!0}),Zt.prototype._checkOcclusionQuery=function(){const r=this._occlusionDataStorage;if(r.occlusionType===Zt.OCCLUSION_TYPE_NONE)return r.isOccluded=!1,!1;const e=this.getEngine();if(!e.getCaps().supportOcclusionQuery||!e.isQueryResultAvailable)return r.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this._occlusionQuery)if(e.isQueryResultAvailable(this._occlusionQuery)){const s=e.getQueryResult(this._occlusionQuery);r.isOcclusionQueryInProgress=!1,r.occlusionInternalRetryCounter=0,r.isOccluded=!(s>0)}else{if(r.occlusionInternalRetryCounter++,!(-1!==r.occlusionRetryCount&&r.occlusionInternalRetryCounter>r.occlusionRetryCount))return r.occlusionType!==Zt.OCCLUSION_TYPE_OPTIMISTIC&&r.isOccluded;r.isOcclusionQueryInProgress=!1,r.occlusionInternalRetryCounter=0,r.isOccluded=r.occlusionType!==Zt.OCCLUSION_TYPE_OPTIMISTIC&&r.isOccluded}const t=this.getScene();if(t.getBoundingBoxRenderer){const i=t.getBoundingBoxRenderer();null===this._occlusionQuery&&(this._occlusionQuery=e.createQuery()),e.beginOcclusionQuery(r.occlusionQueryAlgorithmType,this._occlusionQuery)&&(i.renderOcclusionBoundingBox(this),e.endOcclusionQuery(r.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return r.isOccluded},ee.prototype.createTransformFeedback=function(){const r=this._gl.createTransformFeedback();if(!r)throw new Error("Unable to create Transform Feedback");return r},ee.prototype.deleteTransformFeedback=function(r){this._gl.deleteTransformFeedback(r)},ee.prototype.bindTransformFeedback=function(r){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,r)},ee.prototype.beginTransformFeedback=function(r=!0){this._gl.beginTransformFeedback(r?this._gl.POINTS:this._gl.TRIANGLES)},ee.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()},ee.prototype.setTranformFeedbackVaryings=function(r,e){this._gl.transformFeedbackVaryings(r,e,this._gl.INTERLEAVED_ATTRIBS)},ee.prototype.bindTransformFeedbackBuffer=function(r){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,r?r.underlyingResource:null)},we.prototype.createExternalTexture=function(r){return null},we.prototype.setExternalTexture=function(r,e){throw new Error("setExternalTexture: This engine does not support external textures!")},we.prototype.updateVideoTexture=function(r,e,t){if(!r||r._isDisabled)return;const i=this._getInternalFormat(r.format),s=this._getRGBABufferInternalSizedFormat(0,r.format),n=this._bindTextureDirectly(this._gl.TEXTURE_2D,r,!0);this._unpackFlipY(!t);try{if(void 0===this._videoTextureSupported&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,s,i,this._gl.UNSIGNED_BYTE,e),this._videoTextureSupported=0===this._gl.getError()),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,s,i,this._gl.UNSIGNED_BYTE,e);else{if(!r._workingCanvas){r._workingCanvas=this.createCanvas(r.width,r.height);const o=r._workingCanvas.getContext("2d");if(!o)throw new Error("Unable to get 2d context");r._workingContext=o,r._workingCanvas.width=r.width,r._workingCanvas.height=r.height}r._workingContext.clearRect(0,0,r.width,r.height),r._workingContext.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,r.width,r.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,s,i,this._gl.UNSIGNED_BYTE,r._workingCanvas)}r.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),n||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),r.isReady=!0}catch{r._isDisabled=!0}},we.prototype.restoreSingleAttachment=function(){this.bindAttachments([this._gl.BACK])},we.prototype.restoreSingleAttachmentForRenderTarget=function(){this.bindAttachments([this._gl.COLOR_ATTACHMENT0])},we.prototype.buildTextureLayout=function(r){const e=this._gl,t=[];for(let i=0;i<r.length;i++)t.push(r[i]?e["COLOR_ATTACHMENT"+i]:e.NONE);return t},we.prototype.bindAttachments=function(r){this._gl.drawBuffers(r)},we.prototype.unBindMultiColorAttachmentFramebuffer=function(r,e=!1,t){this._currentRenderTarget=null;const i=this._gl,s=r._attachments,n=s.length;if(r._MSAAFramebuffer){i.bindFramebuffer(i.READ_FRAMEBUFFER,r._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,r._framebuffer);for(let o=0;o<n;o++){const a=r.textures[o];for(let l=0;l<n;l++)s[l]=i.NONE;s[o]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+o:"COLOR_ATTACHMENT"+o+"_WEBGL"],i.readBuffer(s[o]),i.drawBuffers(s),i.blitFramebuffer(0,0,a.width,a.height,0,0,a.width,a.height,i.COLOR_BUFFER_BIT,i.NEAREST)}for(let o=0;o<n;o++)s[o]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+o:"COLOR_ATTACHMENT"+o+"_WEBGL"];i.drawBuffers(s)}for(let o=0;o<n;o++){const a=r.textures[o];a.generateMipMaps&&!e&&!a.isCube&&(this._bindTextureDirectly(i.TEXTURE_2D,a,!0),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null))}t&&(r._MSAAFramebuffer&&this._bindUnboundFramebuffer(r._framebuffer),t()),this._bindUnboundFramebuffer(null)},we.prototype.createMultipleRenderTarget=function(r,e,t=!0){let i=!1,s=!0,n=!1,o=!1,a=15,l=1,d=new Array,f=new Array,p=new Array;const _=this._createHardwareRenderTargetWrapper(!0,!1,r);void 0!==e&&(i=void 0!==e.generateMipMaps&&e.generateMipMaps,s=void 0===e.generateDepthBuffer||e.generateDepthBuffer,n=void 0!==e.generateStencilBuffer&&e.generateStencilBuffer,o=void 0!==e.generateDepthTexture&&e.generateDepthTexture,l=e.textureCount||1,e.types&&(d=e.types),e.samplingModes&&(f=e.samplingModes),e.useSRGBBuffers&&(p=e.useSRGBBuffers),this.webGLVersion>1&&(13===e.depthTextureFormat||17===e.depthTextureFormat||16===e.depthTextureFormat||14===e.depthTextureFormat||18===e.depthTextureFormat)&&(a=e.depthTextureFormat));const m=this._gl,g=m.createFramebuffer();this._bindUnboundFramebuffer(g);const b=r.width||r,y=r.height||r,T=[],x=[],S=this.webGLVersion>1&&o&&(13===e.depthTextureFormat||17===e.depthTextureFormat||18===e.depthTextureFormat),C=this._setupFramebufferDepthAttachments(!S&&n,!o&&s,b,y);_._framebuffer=g,_._depthStencilBuffer=C,_._generateDepthBuffer=!o&&s,_._generateStencilBuffer=!S&&n,_._attachments=x;for(let D=0;D<l;D++){let P=f[D]||3,M=d[D]||0,w=p[D]||!1;(1===M&&!this._caps.textureFloatLinearFiltering||2===M&&!this._caps.textureHalfFloatLinearFiltering)&&(P=1);const k=this._getSamplingParameters(P,i);1===M&&!this._caps.textureFloat&&(M=0,V.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),w=w&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const X=new zt(this,Ye.MultiRenderTarget),te=m[this.webGLVersion>1?"COLOR_ATTACHMENT"+D:"COLOR_ATTACHMENT"+D+"_WEBGL"];T.push(X),x.push(te),m.activeTexture(m["TEXTURE"+D]),m.bindTexture(m.TEXTURE_2D,X._hardwareTexture.underlyingResource),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,k.mag),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,k.min),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.CLAMP_TO_EDGE),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.CLAMP_TO_EDGE);const J=this._getRGBABufferInternalSizedFormat(M,5,w);m.texImage2D(m.TEXTURE_2D,0,J,b,y,0,m.RGBA,this._getWebGLTextureType(M),null),m.framebufferTexture2D(m.DRAW_FRAMEBUFFER,te,m.TEXTURE_2D,X._hardwareTexture.underlyingResource,0),i&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(m.TEXTURE_2D,null),X.baseWidth=b,X.baseHeight=y,X.width=b,X.height=y,X.isReady=!0,X.samples=1,X.generateMipMaps=i,X.samplingMode=P,X.type=M,X._useSRGBBuffer=w,this._internalTexturesCache.push(X)}if(o&&this._caps.depthTextureExtension){const D=new zt(this,Ye.Depth);let P=5,M=m.DEPTH_COMPONENT16,w=m.DEPTH_COMPONENT,k=m.UNSIGNED_SHORT,X=m.DEPTH_ATTACHMENT;this.webGLVersion<2?M=m.DEPTH_COMPONENT:14===a?(P=1,k=m.FLOAT,M=m.DEPTH_COMPONENT32F):18===a?(P=0,k=m.FLOAT_32_UNSIGNED_INT_24_8_REV,M=m.DEPTH32F_STENCIL8,w=m.DEPTH_STENCIL,X=m.DEPTH_STENCIL_ATTACHMENT):16===a?(P=0,k=m.UNSIGNED_INT,M=m.DEPTH_COMPONENT24,X=m.DEPTH_ATTACHMENT):(13===a||17===a)&&(P=12,k=m.UNSIGNED_INT_24_8,M=m.DEPTH24_STENCIL8,w=m.DEPTH_STENCIL,X=m.DEPTH_STENCIL_ATTACHMENT),m.activeTexture(m.TEXTURE0),m.bindTexture(m.TEXTURE_2D,D._hardwareTexture.underlyingResource),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,m.NEAREST),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.NEAREST),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.CLAMP_TO_EDGE),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.CLAMP_TO_EDGE),m.texImage2D(m.TEXTURE_2D,0,M,b,y,0,w,k,null),m.framebufferTexture2D(m.FRAMEBUFFER,X,m.TEXTURE_2D,D._hardwareTexture.underlyingResource,0),D.baseWidth=b,D.baseHeight=y,D.width=b,D.height=y,D.isReady=!0,D.samples=1,D.generateMipMaps=i,D.samplingMode=1,D.format=a,D.type=P,T.push(D),this._internalTexturesCache.push(D)}return _.setTextures(T),t&&m.drawBuffers(x),this._bindUnboundFramebuffer(null),this.resetTextureCache(),_},we.prototype.updateMultipleRenderTargetTextureSampleCount=function(r,e,t=!0){if(this.webGLVersion<2||!r||!r.texture)return 1;if(r.samples===e)return e;const i=r._attachments.length;if(0===i)return 1;const s=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples);const n=!!r._depthStencilBuffer;if(n&&(s.deleteRenderbuffer(r._depthStencilBuffer),r._depthStencilBuffer=null),r._MSAAFramebuffer&&(s.deleteFramebuffer(r._MSAAFramebuffer),r._MSAAFramebuffer=null),e>1&&"function"==typeof s.renderbufferStorageMultisample){const o=s.createFramebuffer();if(!o)throw new Error("Unable to create multi sampled framebuffer");r._MSAAFramebuffer=o,this._bindUnboundFramebuffer(o);const a=[];for(let l=0;l<i;l++){const c=r.textures[l],h=c._hardwareTexture,u=s[this.webGLVersion>1?"COLOR_ATTACHMENT"+l:"COLOR_ATTACHMENT"+l+"_WEBGL"],d=h._MSAARenderBuffer?this._updateRenderBuffer(h._MSAARenderBuffer,c.width,c.height,e,-1,this._getRGBAMultiSampleBufferFormat(c.type),u):this._createRenderBuffer(c.width,c.height,e,-1,this._getRGBAMultiSampleBufferFormat(c.type),u);if(!d)throw new Error("Unable to create multi sampled framebuffer");h._MSAARenderBuffer=d,c.samples=e,a.push(u)}t&&s.drawBuffers(a)}else this._bindUnboundFramebuffer(r._framebuffer);return n&&(r._depthStencilBuffer=this._setupFramebufferDepthAttachments(r._generateStencilBuffer,r._generateDepthBuffer,r.texture.width,r.texture.height,e)),this._bindUnboundFramebuffer(null),e},we.prototype._createDepthStencilCubeTexture=function(r,e,t){const i=new zt(this,Ye.DepthStencil);if(i.isCube=!0,1===this.webGLVersion)return V.Error("Depth cube texture is not supported by WebGL 1."),i;const s={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e},n=this._gl;this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,i,!0),this._setupDepthStencilTexture(i,r,s.generateStencil,s.bilinearFiltering,s.comparisonFunction),t._depthStencilTexture=i,t._depthStencilTextureWithStencil=s.generateStencil;for(let o=0;o<6;o++)s.generateStencil?n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,n.DEPTH24_STENCIL8,r,r,0,n.DEPTH_STENCIL,n.UNSIGNED_INT_24_8,null):n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,n.DEPTH_COMPONENT24,r,r,0,n.DEPTH_COMPONENT,n.UNSIGNED_INT,null);return this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(i),i},we.prototype._partialLoadFile=function(r,e,t,i,s=null){this._loadFile(r,a=>{t[e]=a,t._internalCount++,6===t._internalCount&&i(t)},void 0,void 0,!0,(a,l)=>{s&&a&&s(a.status+" "+a.statusText,l)})},we.prototype._cascadeLoadFiles=function(r,e,t,i=null){const s=[];s._internalCount=0;for(let n=0;n<6;n++)this._partialLoadFile(t[n],n,s,e,i)},we.prototype._cascadeLoadImgs=function(r,e,t,i,s=null,n){const o=[];o._internalCount=0;for(let a=0;a<6;a++)this._partialLoadImg(i[a],a,o,r,e,t,s,n)},we.prototype._partialLoadImg=function(r,e,t,i,s,n,o=null,a){const l=Qg();qg(r,u=>{t[e]=u,t._internalCount++,i&&i.removePendingData(l),6===t._internalCount&&n&&n(s,t)},(u,d)=>{i&&i.removePendingData(l),o&&o(u,d)},i?i.offlineProvider:null,a),i&&i.addPendingData(l)},we.prototype._setCubeMapTextureParams=function(r,e,t){const i=this._gl;i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,e?i.LINEAR_MIPMAP_LINEAR:i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),r.samplingMode=e?3:2,e&&this.getCaps().textureMaxLevel&&void 0!==t&&t>0&&(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_LEVEL,t),r._maxLodLevel=t),this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)},we.prototype.createCubeTextureBase=function(r,e,t,i,s=null,n=null,o,a=null,l=!1,c=0,h=0,u=null,d=null,f=null,p=!1){const _=u||new zt(this,Ye.Cube);_.isCube=!0,_.url=r,_.generateMipMaps=!i,_._lodGenerationScale=c,_._lodGenerationOffset=h,_._useSRGBBuffer=!!p&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||!!i),this._doNotHandleContextLost||(_._extension=a,_._files=t);const m=r;this._transformTextureUrl&&!u&&(r=this._transformTextureUrl(r));const g=r.split("?")[0],b=g.lastIndexOf("."),y=a||(b>-1?g.substring(b).toLowerCase():"");let T=null;for(const S of we._TextureLoaders)if(S.canLoad(y)){T=S;break}const x=(S,C)=>{r===m?n&&S&&n(S.status+" "+S.statusText,C):(V.Warn(`Failed to load ${r}, falling back to the ${m}`),this.createCubeTextureBase(m,e,t,!!i,s,n,o,a,l,c,h,_,d,f,p))};if(T){const S=C=>{d&&d(_,C),T.loadCubeData(C,_,l,s,n)};t&&6===t.length?T.supportCascades?this._cascadeLoadFiles(e,C=>S(C.map(D=>new Uint8Array(D))),t,n):n?n("Textures type does not support cascades."):V.Warn("Texture loader does not support cascades."):this._loadFile(r,C=>S(new Uint8Array(C)),void 0,void 0,!0,x)}else{if(!t)throw new Error("Cannot load cubemap because files were not defined");this._cascadeLoadImgs(e,_,(S,C)=>{f&&f(S,C)},t,n)}return this._internalTexturesCache.push(_),_},we.prototype.createCubeTexture=function(r,e,t,i,s=null,n=null,o,a=null,l=!1,c=0,h=0,u=null,d,f=!1){const p=this._gl;return this.createCubeTextureBase(r,e,t,!!i,s,n,o,a,l,c,h,u,_=>this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,_,!0),(_,m)=>{const g=this.needPOTTextures?we.GetExponentOfTwo(m[0].width,this._caps.maxCubemapTextureSize):m[0].width,b=g,y=[p.TEXTURE_CUBE_MAP_POSITIVE_X,p.TEXTURE_CUBE_MAP_POSITIVE_Y,p.TEXTURE_CUBE_MAP_POSITIVE_Z,p.TEXTURE_CUBE_MAP_NEGATIVE_X,p.TEXTURE_CUBE_MAP_NEGATIVE_Y,p.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,_,!0),this._unpackFlipY(!1);const T=o?this._getInternalFormat(o,_._useSRGBBuffer):_._useSRGBBuffer?p.SRGB8_ALPHA8:p.RGBA;let x=o?this._getInternalFormat(o):p.RGBA;_._useSRGBBuffer&&1===this.webGLVersion&&(x=T);for(let S=0;S<y.length;S++)if(m[S].width!==g||m[S].height!==b){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void V.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=g,this._workingCanvas.height=b,this._workingContext.drawImage(m[S],0,0,m[S].width,m[S].height,0,0,g,b),p.texImage2D(y[S],0,T,x,p.UNSIGNED_BYTE,this._workingCanvas)}else p.texImage2D(y[S],0,T,x,p.UNSIGNED_BYTE,m[S]);i||p.generateMipmap(p.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(_,!i),_.width=g,_.height=b,_.isReady=!0,o&&(_.format=o),_.onLoadedObservable.notifyObservers(_),_.onLoadedObservable.clear(),s&&s()},!!f)},we.prototype.setTextureSampler=function(r,e){throw new Error("setTextureSampler: This engine does not support separate texture sampler objects!")};const iV=new z,sV=new z;function dre(r){if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some(n=>r&&(r===n||r.match(new RegExp("\\b"+n+"\\b","g")))))return r;const t=r.lastIndexOf("."),i=r.lastIndexOf("?"),s=i>-1?r.substring(i,r.length):"";return(t>-1?r.substring(0,t):r)+this._textureFormatInUse+s}Object.defineProperty(ee.prototype,"onBeforeViewRenderObservable",{get:function(){return iV}}),Object.defineProperty(ee.prototype,"onAfterViewRenderObservable",{get:function(){return sV}}),Object.defineProperty(ee.prototype,"inputElement",{get:function(){return this._inputElement},set:function(r){var e;this._inputElement!==r&&(this._inputElement=r,null===(e=this._onEngineViewChanged)||void 0===e||e.call(this))}}),ee.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()},ee.prototype.registerView=function(r,e,t){this.views||(this.views=[]);for(const n of this.views)if(n.target===r)return n;const i=this.getRenderingCanvas();i&&(r.width=i.width,r.height=i.height);const s={target:r,camera:e,clearBeforeCopy:t,enabled:!0,id:(1e5*Math.random()).toFixed()};return this.views.push(s),e&&e.onDisposeObservable.add(()=>{this.unRegisterView(r)}),s},ee.prototype.unRegisterView=function(r){if(!this.views||0===this.views.length)return this;for(const e of this.views)if(e.target===r){const t=this.views.indexOf(e);-1!==t&&this.views.splice(t,1);break}return this},ee.prototype._renderViewStep=function(r){const e=r.target,t=e.getContext("2d");if(!t)return!0;const i=this.getRenderingCanvas();iV.notifyObservers(r);const s=r.camera;let n=null,o=null;if(s){if(o=s.getScene(),!o||o.activeCameras&&o.activeCameras.length)return!0;this.activeView=r,n=o.activeCamera,o.activeCamera=s}if(r.customResize)r.customResize(e);else{const a=Math.floor(e.clientWidth/this._hardwareScalingLevel),l=Math.floor(e.clientHeight/this._hardwareScalingLevel),c=a!==e.width||i.width!==e.width||l!==e.height||i.height!==e.height;e.clientWidth&&e.clientHeight&&c&&(e.width=a,e.height=l,this.setSize(a,l))}return!(!i.width||!i.height||(this._renderFrame(),this.flushFramebuffer(),r.clearBeforeCopy&&t.clearRect(0,0,i.width,i.height),t.drawImage(i,0,0),n&&o&&(o.activeCamera=n),sV.notifyObservers(r),0))},ee.prototype._renderViews=function(){if(!this.views||0===this.views.length||!this.getRenderingCanvas())return!1;let e;for(const t of this.views)if(t.enabled)if(t.target!==this.inputElement){if(!this._renderViewStep(t))return!1}else e=t;return!(e&&!this._renderViewStep(e)||(this.activeView=null,0))},we.prototype.createStorageBuffer=function(r,e){throw new Error("createStorageBuffer: Unsupported method in this engine!")},we.prototype.updateStorageBuffer=function(r,e,t,i){},we.prototype.readFromStorageBuffer=function(r,e,t,i){throw new Error("readFromStorageBuffer: Unsupported method in this engine!")},we.prototype.setStorageBuffer=function(r,e){throw new Error("setStorageBuffer: Unsupported method in this engine!")},Object.defineProperty(ee.prototype,"texturesSupported",{get:function(){const r=new Array;return this._caps.astc&&r.push("-astc.ktx"),this._caps.s3tc&&r.push("-dxt.ktx"),this._caps.pvrtc&&r.push("-pvrtc.ktx"),this._caps.etc2&&r.push("-etc2.ktx"),this._caps.etc1&&r.push("-etc1.ktx"),r},enumerable:!0,configurable:!0}),Object.defineProperty(ee.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0}),ee.prototype.setCompressedTextureExclusions=function(r){this._excludedCompressedTextures=r},ee.prototype.setTextureFormatToUse=function(r){const e=this.texturesSupported;for(let t=0,i=e.length;t<i;t++)for(let s=0,n=r.length;s<n;s++)if(e[t]===r[s].toLowerCase())return this._transformTextureUrl=dre.bind(this),this._textureFormatInUse=e[t];return this._textureFormatInUse="",this._transformTextureUrl=null,null};let sC=(()=>{class r{constructor(){const t=new ArrayBuffer(r.DEFAULT_BUFFER_SIZE);this._uint32s=new Uint32Array(t),this._int32s=new Int32Array(t),this._float32s=new Float32Array(t),this._length=r.DEFAULT_BUFFER_SIZE/4,this._position=0,this._nativeDataStream=new _native.NativeDataStream(()=>{this._flush()})}writeUint32(t){this._flushIfNecessary(1),this._uint32s[this._position++]=t}writeInt32(t){this._flushIfNecessary(1),this._int32s[this._position++]=t}writeFloat32(t){this._flushIfNecessary(1),this._float32s[this._position++]=t}writeUint32Array(t){this._flushIfNecessary(1+t.length),this._uint32s[this._position++]=t.length,this._uint32s.set(t,this._position),this._position+=t.length}writeInt32Array(t){this._flushIfNecessary(1+t.length),this._uint32s[this._position++]=t.length,this._int32s.set(t,this._position),this._position+=t.length}writeFloat32Array(t){this._flushIfNecessary(1+t.length),this._uint32s[this._position++]=t.length,this._float32s.set(t,this._position),this._position+=t.length}writeNativeData(t){this._flushIfNecessary(t.length),this._uint32s.set(t,this._position),this._position+=t.length}writeBoolean(t){this.writeUint32(t?1:0)}_flushIfNecessary(t){this._position+t>this._length&&this._flush()}_flush(){this._nativeDataStream.writeBuffer(this._uint32s.buffer,this._position),this._position=0}}return r.DEFAULT_BUFFER_SIZE=65536,r})();const _a=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],fre=[()=>1,r=>r.y,r=>r.z,r=>r.x,r=>r.x*r.y,r=>r.y*r.z,r=>3*r.z*r.z-1,r=>r.x*r.z,r=>r.x*r.x-r.y*r.y],ol=(r,e)=>_a[r]*fre[r](e),al=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class vh{constructor(){this.preScaled=!1,this.l00=v.Zero(),this.l1_1=v.Zero(),this.l10=v.Zero(),this.l11=v.Zero(),this.l2_2=v.Zero(),this.l2_1=v.Zero(),this.l20=v.Zero(),this.l21=v.Zero(),this.l22=v.Zero()}addLight(e,t,i){L.Vector3[0].set(t.r,t.g,t.b);const n=L.Vector3[1];L.Vector3[0].scaleToRef(i,n),n.scaleToRef(ol(0,e),L.Vector3[2]),this.l00.addInPlace(L.Vector3[2]),n.scaleToRef(ol(1,e),L.Vector3[2]),this.l1_1.addInPlace(L.Vector3[2]),n.scaleToRef(ol(2,e),L.Vector3[2]),this.l10.addInPlace(L.Vector3[2]),n.scaleToRef(ol(3,e),L.Vector3[2]),this.l11.addInPlace(L.Vector3[2]),n.scaleToRef(ol(4,e),L.Vector3[2]),this.l2_2.addInPlace(L.Vector3[2]),n.scaleToRef(ol(5,e),L.Vector3[2]),this.l2_1.addInPlace(L.Vector3[2]),n.scaleToRef(ol(6,e),L.Vector3[2]),this.l20.addInPlace(L.Vector3[2]),n.scaleToRef(ol(7,e),L.Vector3[2]),this.l21.addInPlace(L.Vector3[2]),n.scaleToRef(ol(8,e),L.Vector3[2]),this.l22.addInPlace(L.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(al[0]),this.l1_1.scaleInPlace(al[1]),this.l10.scaleInPlace(al[2]),this.l11.scaleInPlace(al[3]),this.l2_2.scaleInPlace(al[4]),this.l2_1.scaleInPlace(al[5]),this.l20.scaleInPlace(al[6]),this.l21.scaleInPlace(al[7]),this.l22.scaleInPlace(al[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(_a[0]),this.l1_1.scaleInPlace(_a[1]),this.l10.scaleInPlace(_a[2]),this.l11.scaleInPlace(_a[3]),this.l2_2.scaleInPlace(_a[4]),this.l2_1.scaleInPlace(_a[5]),this.l20.scaleInPlace(_a[6]),this.l21.scaleInPlace(_a[7]),this.l22.scaleInPlace(_a[8])}updateFromArray(e){return v.FromArrayToRef(e[0],0,this.l00),v.FromArrayToRef(e[1],0,this.l1_1),v.FromArrayToRef(e[2],0,this.l10),v.FromArrayToRef(e[3],0,this.l11),v.FromArrayToRef(e[4],0,this.l2_2),v.FromArrayToRef(e[5],0,this.l2_1),v.FromArrayToRef(e[6],0,this.l20),v.FromArrayToRef(e[7],0,this.l21),v.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return v.FromFloatsToRef(e[0],e[1],e[2],this.l00),v.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),v.FromFloatsToRef(e[6],e[7],e[8],this.l10),v.FromFloatsToRef(e[9],e[10],e[11],this.l11),v.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),v.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),v.FromFloatsToRef(e[18],e[19],e[20],this.l20),v.FromFloatsToRef(e[21],e[22],e[23],this.l21),v.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return(new vh).updateFromArray(e)}static FromPolynomial(e){const t=new vh;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}}class ll{constructor(){this.x=v.Zero(),this.y=v.Zero(),this.z=v.Zero(),this.xx=v.Zero(),this.yy=v.Zero(),this.zz=v.Zero(),this.xy=v.Zero(),this.yz=v.Zero(),this.zx=v.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=vh.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){L.Vector3[0].copyFromFloats(e.r,e.g,e.b);const t=L.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),L.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),L.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(L.Vector3[0]).addInPlace(L.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(L.Vector3[0]).subtractInPlace(L.Vector3[1]),this.zz.copyFrom(e.l00),L.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(L.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return(new ll).updateFromHarmonics(e)}static FromArray(e){const t=new ll;return v.FromArrayToRef(e[0],0,t.x),v.FromArrayToRef(e[1],0,t.y),v.FromArrayToRef(e[2],0,t.z),v.FromArrayToRef(e[3],0,t.xx),v.FromArrayToRef(e[4],0,t.yy),v.FromArrayToRef(e[5],0,t.zz),v.FromArrayToRef(e[6],0,t.yz),v.FromArrayToRef(e[7],0,t.zx),v.FromArrayToRef(e[8],0,t.xy),t}}let Nv,aV;function ma(r){Nv||(Nv=new Float32Array(1),aV=new Int32Array(Nv.buffer)),Nv[0]=r;const e=aV[0];let t=e>>16&32768,i=e>>12&2047;const s=e>>23&255;return s<103?t:s>142?(t|=31744,t|=(255==s?0:1)&&8388607&e,t):s<113?(i|=2048,t|=(i>>114-s)+(i>>113-s&1),t):(t|=s-112<<10|i>>1,t+=1&i,t)}function ga(r){const e=(32768&r)>>15,t=(31744&r)>>10,i=1023&r;return 0===t?(e?-1:1)*Math.pow(2,-14)*(i/Math.pow(2,10)):31==t?i?NaN:1/0*(e?-1:1):(e?-1:1)*Math.pow(2,t-15)*(1+i/Math.pow(2,10))}j.ShadersStore.rgbdDecodePixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\ngl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);\n}";class rC{static ExpandRGBDTexture(e){const t=e._texture;if(!t||!e.isRGBD)return;const i=t.getEngine(),s=i.getCaps(),n=t.isReady;let o=!1;s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering?(o=!0,t.type=2):s.textureFloatRender&&s.textureFloatLinearFiltering&&(o=!0,t.type=1),o&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);const a=()=>{if(o){const l=new Pe("rgbdDecode","rgbdDecode",null,null,1,null,3,i,!1,void 0,t.type,void 0,null,!1);l.externalTextureSamplerBinding=!0;const c=i.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});l.getEffect().executeWhenCompiled(()=>{l.onApply=h=>{h._bindTexture("textureSampler",t),h.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([l],c,!0),i.restoreDefaultFramebuffer(),i._releaseTexture(t),l&&l.dispose(),c._swapAndDie(t),t.isReady=!0})}};n?a():e.onLoadObservable.addOnce(a)}static EncodeTextureToRGBD(e,t,i=0){return function oV(r,e,t,i,s,n){const o=e.getEngine();return e.isReady=!1,s=s??e.samplingMode,n=n??e.format,-1===(i=i??e.type)&&(i=0),new Promise(a=>{const l=new Pe("postprocess",r,null,null,1,null,s,o,!1,void 0,i,void 0,null,!1,n);l.externalTextureSamplerBinding=!0;const c=o.createRenderTargetTexture({width:e.width,height:e.height},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:s,type:i,format:n});l.getEffect().executeWhenCompiled(()=>{l.onApply=h=>{h._bindTexture("textureSampler",e),h.setFloat2("scale",1,1)},t.postProcessManager.directRender([l],c,!0),o.restoreDefaultFramebuffer(),o._releaseTexture(e),l&&l.dispose(),c._swapAndDie(e),e.type=i,e.format=5,e.isReady=!0,a(e)})})}("rgbdEncode",e,t,i,1,5)}}class Qu{constructor(e,t,i,s){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=i,this.worldAxisForFileY=s}}class Fv{static ConvertCubeMapTextureToSphericalPolynomial(e){var t;if(!e.isCube)return null;null===(t=e.getScene())||void 0===t||t.getEngine().flushFramebuffer();const i=e.getSize().width,s=e.readPixels(0,void 0,void 0,!1),n=e.readPixels(1,void 0,void 0,!1);let o,a;e.isRenderTarget?(o=e.readPixels(3,void 0,void 0,!1),a=e.readPixels(2,void 0,void 0,!1)):(o=e.readPixels(2,void 0,void 0,!1),a=e.readPixels(3,void 0,void 0,!1));const l=e.readPixels(4,void 0,void 0,!1),c=e.readPixels(5,void 0,void 0,!1),h=e.gammaSpace;let d=0;return(1==e.textureType||2==e.textureType)&&(d=1),new Promise(f=>{Promise.all([n,s,o,a,l,c]).then(([p,_,m,g,b,y])=>{f(this.ConvertCubeMapToSphericalPolynomial({size:i,right:_,left:p,up:m,down:g,front:b,back:y,format:5,type:d,gammaSpace:h}))})})}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new vh;let i=0;const s=2/e.size,n=s,o=.5*s,a=o-1;for(let d=0;d<6;d++){const f=this._FileFaces[d],p=e[f.name];let _=a;const m=5===e.format?4:3;for(let g=0;g<e.size;g++){let b=a;for(let y=0;y<e.size;y++){const T=f.worldAxisForFileX.scale(b).add(f.worldAxisForFileY.scale(_)).add(f.worldAxisForNormal);T.normalize();const x=this._AreaElement(b-o,_-o)-this._AreaElement(b-o,_+o)-this._AreaElement(b+o,_-o)+this._AreaElement(b+o,_+o);let S=p[g*e.size*m+y*m+0],C=p[g*e.size*m+y*m+1],D=p[g*e.size*m+y*m+2];isNaN(S)&&(S=0),isNaN(C)&&(C=0),isNaN(D)&&(D=0),0===e.type&&(S/=255,C/=255,D/=255),e.gammaSpace&&(S=Math.pow(oe.Clamp(S),2.2),C=Math.pow(oe.Clamp(C),2.2),D=Math.pow(oe.Clamp(D),2.2));const P=4096;S=oe.Clamp(S,0,P),C=oe.Clamp(C,0,P),D=oe.Clamp(D,0,P);const M=new re(S,C,D);t.addLight(T,M,x),i+=x,b+=s}_+=n}}const u=4*Math.PI*6/6/i;return t.scaleInPlace(u),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),ll.FromHarmonics(t)}}Fv._FileFaces=[new Qu("right",new v(1,0,0),new v(0,0,-1),new v(0,-1,0)),new Qu("left",new v(-1,0,0),new v(0,0,1),new v(0,-1,0)),new Qu("up",new v(0,1,0),new v(1,0,0),new v(0,0,1)),new Qu("down",new v(0,-1,0),new v(1,0,0),new v(0,0,-1)),new Qu("front",new v(0,0,1),new v(1,0,0),new v(0,-1,0)),new Qu("back",new v(0,0,-1),new v(-1,0,0),new v(0,-1,0))],kt.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(kt.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=Fv.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(r=>{this._texture._sphericalPolynomial=r,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(r){this._texture&&(this._texture._sphericalPolynomial=r)},enumerable:!0,configurable:!0});j.ShadersStore.rgbdEncodePixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\ngl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);\n}";const nC="image/png",Mp=[134,22,135,150,246,214,150,54];function aC(r){const e=new DataView(r.buffer,r.byteOffset,r.byteLength);let t=0;for(let o=0;o<Mp.length;o++)if(e.getUint8(t++)!==Mp[o])return V.Error("Not a babylon environment map"),null;let i="",s=0;for(;s=e.getUint8(t++);)i+=String.fromCharCode(s);let n=JSON.parse(i);return n=Lv(n),n.specular&&(n.specular.specularDataPosition=t,n.specular.lodGenerationScale=n.specular.lodGenerationScale||.8),n}function Lv(r){if(r.version>2)throw new Error(`Unsupported babylon environment map version "${r.version}". Latest supported version is "2".`);return 2===r.version||(r={...r,version:2,imageType:nC}),r}function cC(r,e){const t=(e=Lv(e)).specular;let i=oe.Log2(e.width);if(i=Math.round(i)+1,t.mipmaps.length!==6*i)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);const s=new Array(i);for(let n=0;n<i;n++){s[n]=new Array(6);for(let o=0;o<6;o++){const a=t.mipmaps[6*n+o];s[n][o]=new Uint8Array(r.buffer,r.byteOffset+t.specularDataPosition+a.position,a.length)}}return s}function uV(r,e,t,i,s,n,o,a,l,c,h){return new Promise((u,d)=>{if(t){const f=e.createTexture(null,!0,!0,null,1,null,p=>{d(p)},r);i.getEffect().executeWhenCompiled(()=>{i.externalTextureSamplerBinding=!0,i.onApply=p=>{p._bindTexture("textureSampler",f),p.setFloat2("scale",1,e._features.needsInvertingBitmap&&r instanceof ImageBitmap?-1:1)},e.scenes.length&&(e.scenes[0].postProcessManager.directRender([i],c,!0,n,o),e.restoreDefaultFramebuffer(),f.dispose(),URL.revokeObjectURL(s),u())})}else{if(e._uploadImageToTexture(h,r,n,o),a){const f=l[o];f&&e._uploadImageToTexture(f._texture,r,n,0)}u()}})}function Bv(r,e,t=nC){if(!q.IsExponentOfTwo(r.width))throw new Error("Texture size must be a power of two");const i=oe.ILog2(r.width)+1,s=r.getEngine();let n=!1,o=!1,a=null,l=null,c=null;const h=s.getCaps();if(r.format=5,r.type=0,r.generateMipMaps=!0,r._cachedAnisotropicFilteringLevel=null,s.updateTextureSamplingMode(3,r),h.textureLOD?s._features.supportRenderAndCopyToLodForFloatTextures?h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?(n=!0,r.type=2):h.textureFloatRender&&h.textureFloatLinearFiltering&&(n=!0,r.type=1):n=!1:(n=!1,o=!0,c={}),n)a=new Pe("rgbdDecode","rgbdDecode",null,null,1,null,3,s,!1,void 0,r.type,void 0,null,!1),r._isRGBD=!1,r.invertY=!1,l=s.createRenderTargetCubeTexture(r.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:r.type,format:5});else if(r._isRGBD=!0,r.invertY=!0,o){const f=r._lodGenerationScale,p=r._lodGenerationOffset;for(let _=0;_<3;_++){const y=(i-1)*f+p,x=Math.round(Math.min(Math.max(p+(y-p)*(1-_/2),0),y)),S=new zt(s,Ye.Temp);S.isCube=!0,S.invertY=!0,S.generateMipMaps=!1,s.updateTextureSamplingMode(2,S);const C=new kt(null);switch(C._isCube=!0,C._texture=S,c[x]=C,_){case 0:r._lodTextureLow=C;break;case 1:r._lodTextureMid=C;break;case 2:r._lodTextureHigh=C}}}const u=[];for(let d=0;d<e.length;d++)for(let f=0;f<6;f++){const _=new Blob([e[d][f]],{type:t}),m=URL.createObjectURL(_);let g;if(typeof Image>"u"||s._features.forceBitmapOverHTMLImageElement)g=s.createImageBitmap(_,{premultiplyAlpha:"none"}).then(b=>uV(b,s,n,a,m,f,d,o,c,l,r));else{const b=new Image;b.src=m,g=new Promise((y,T)=>{b.onload=()=>{uV(b,s,n,a,m,f,d,o,c,l,r).then(()=>y()).catch(x=>{T(x)})},b.onerror=x=>{T(x)}})}u.push(g)}if(e.length<i){let d;const f=Math.pow(2,i-1-e.length),p=f*f*4;switch(r.type){case 0:d=new Uint8Array(p);break;case 2:d=new Uint16Array(p);break;case 1:d=new Float32Array(p)}for(let _=e.length;_<i;_++)for(let m=0;m<6;m++)s._uploadArrayBufferViewToTexture(r,d,m,_)}return Promise.all(u).then(()=>{l&&(s._releaseTexture(r),l._swapAndDie(r)),a&&a.dispose(),o&&(r._lodTextureHigh&&r._lodTextureHigh._texture&&(r._lodTextureHigh._texture.isReady=!0),r._lodTextureMid&&r._lodTextureMid._texture&&(r._lodTextureMid._texture.isReady=!0),r._lodTextureLow&&r._lodTextureLow._texture&&(r._lodTextureLow._texture.isReady=!0))})}function hC(r,e){const t=(e=Lv(e)).irradiance;if(!t)return;const i=new ll;v.FromArrayToRef(t.x,0,i.x),v.FromArrayToRef(t.y,0,i.y),v.FromArrayToRef(t.z,0,i.z),v.FromArrayToRef(t.xx,0,i.xx),v.FromArrayToRef(t.yy,0,i.yy),v.FromArrayToRef(t.zz,0,i.zz),v.FromArrayToRef(t.yz,0,i.yz),v.FromArrayToRef(t.zx,0,i.zx),v.FromArrayToRef(t.xy,0,i.xy),r._sphericalPolynomial=i}function Vv(r,e,t,i){let s=i,n=0,o="";for(;s<t.length;){const a=t.charAt(s);if(o)a===o?'"'===o||"'"===o?"\\"!==t.charAt(s-1)&&(o=""):o="":"*/"===o&&"*"===a&&s+1<t.length&&("/"===t.charAt(s+1)&&(o=""),""===o&&s++);else switch(a){case r:n++;break;case e:n--;break;case'"':case"'":case"`":o=a;break;case"/":if(s+1<t.length){const l=t.charAt(s+1);"/"===l?o="\n":"*"===l&&(o="*/")}}if(s++,0===n)break}return 0===n?s-1:-1}function dV(r,e){for(;e<r.length;){const t=r[e];if(" "!==t&&"\n"!==t&&"\r"!==t&&"\t"!==t&&"\n"!==t&&"\xa0"!==t)break;e++}return e}function uC(r){const e=r.charCodeAt(0);return e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||95==e}function dC(r){let e=0,t="",i=!1;const s=[];for(;e<r.length;){const n=r.charAt(e);if(t)n===t?'"'===t||"'"===t?("\\"!==r.charAt(e-1)&&(t=""),s.push(n)):(t="",i=!1):"*/"===t&&"*"===n&&e+1<r.length?("/"===r.charAt(e+1)&&(t=""),""===t&&(i=!1,e++)):i||s.push(n);else{switch(n){case'"':case"'":case"`":t=n;break;case"/":if(e+1<r.length){const o=r.charAt(e+1);"/"===o?(t="\n",i=!0):"*"===o&&(t="*/",i=!0)}}i||s.push(n)}e++}return s.join("")}function vre(r,e,t){for(;e>=0&&r.charAt(e)!==t;)e--;return e}function bre(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}let Uv=(()=>{class r{get code(){return this._sourceCode}constructor(t,i=20){this.debug=!1,this._sourceCode=t,this._numMaxIterations=i,this._functionDescr=[],this.inlineToken="#define inline"}processCode(){this.debug&&console.log(`Start inlining process (code size=${this._sourceCode.length})...`),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&console.log("End of inlining process.")}_collectFunctions(){let t=0;for(;t<this._sourceCode.length;){const i=this._sourceCode.indexOf(this.inlineToken,t);if(i<0)break;const s=this._sourceCode.indexOf("(",i+this.inlineToken.length);if(s<0){this.debug&&console.warn(`Could not find the opening parenthesis after the token. startIndex=${t}`),t=i+this.inlineToken.length;continue}const n=r._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(i+this.inlineToken.length,s));if(!n){this.debug&&console.warn(`Could not extract the name/type of the function from: ${this._sourceCode.substring(i+this.inlineToken.length,s)}`),t=i+this.inlineToken.length;continue}const[o,a]=[n[3],n[4]],l=Vv("(",")",this._sourceCode,s);if(l<0){this.debug&&console.warn(`Could not extract the parameters the function '${a}' (type=${o}). funcParamsStartIndex=${s}`),t=i+this.inlineToken.length;continue}const c=this._sourceCode.substring(s+1,l),h=dV(this._sourceCode,l+1);if(h===this._sourceCode.length){this.debug&&console.warn(`Could not extract the body of the function '${a}' (type=${o}). funcParamsEndIndex=${l}`),t=i+this.inlineToken.length;continue}const u=Vv("{","}",this._sourceCode,h);if(u<0){this.debug&&console.warn(`Could not extract the body of the function '${a}' (type=${o}). funcBodyStartIndex=${h}`),t=i+this.inlineToken.length;continue}const d=this._sourceCode.substring(h,u+1),f=dC(c).split(","),p=[];for(let g=0;g<f.length;++g){const b=f[g].trim(),y=b.lastIndexOf(" ");y>=0&&p.push(b.substring(y+1))}"void"!==o&&p.push("return"),this._functionDescr.push({name:a,type:o,parameters:p,body:d,callIndex:0}),t=u+1;const _=i>0?this._sourceCode.substring(0,i):"",m=u+1<this._sourceCode.length-1?this._sourceCode.substring(u+1):"";this._sourceCode=_+m,t-=u+1-i}this.debug&&console.log(`Collect functions: ${this._functionDescr.length} functions found. functionDescr=`,this._functionDescr)}_processInlining(t=20){for(;t-- >=0&&this._replaceFunctionCallsByCode(););return this.debug&&console.log(`numMaxIterations is ${t} after inlining process`),t>=0}_replaceFunctionCallsByCode(){let t=!1;for(const i of this._functionDescr){const{name:s,type:n,parameters:o,body:a}=i;let l=0;for(;l<this._sourceCode.length;){const c=this._sourceCode.indexOf(s,l);if(c<0)break;if(0===c||uC(this._sourceCode.charAt(c-1))){l=c+s.length;continue}const h=dV(this._sourceCode,c+s.length);if(h===this._sourceCode.length||"("!==this._sourceCode.charAt(h)){l=c+s.length;continue}const u=Vv("(",")",this._sourceCode,h);if(u<0){this.debug&&console.warn(`Could not extract the parameters of the function call. Function '${s}' (type=${n}). callParamsStartIndex=${h}`),l=c+s.length;continue}const d=this._sourceCode.substring(h+1,u),p=(T=>{const x=[];let S=0,C=0;for(;S<T.length;){if("("===T.charAt(S)){const D=Vv("(",")",T,S);if(D<0)return null;S=D}else","===T.charAt(S)&&(x.push(T.substring(C,S)),C=S+1);S++}return C<S&&x.push(T.substring(C,S)),x})(dC(d));if(null===p){this.debug&&console.warn(`Invalid function call: can't extract the parameters of the function call. Function '${s}' (type=${n}). callParamsStartIndex=${h}, callParams=`+d),l=c+s.length;continue}const _=[];for(let T=0;T<p.length;++T){const x=p[T].trim();_.push(x)}const m="void"!==n?s+"_"+i.callIndex++:null;if(m&&_.push(m+" ="),_.length!==o.length){this.debug&&console.warn(`Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '${s}' (type=${n}). function parameters=${o}, call parameters=${_}`),l=c+s.length;continue}l=u+1;const g=this._replaceNames(a,o,_);let b=c>0?this._sourceCode.substring(0,c):"";const y=u+1<this._sourceCode.length-1?this._sourceCode.substring(u+1):"";if(m){const T=vre(this._sourceCode,c-1,"\n");b=this._sourceCode.substring(0,T+1);const x=this._sourceCode.substring(T+1,c);this._sourceCode=b+n+" "+m+";\n"+g+"\n"+x+m+y,this.debug&&console.log(`Replace function call by code. Function '${s}' (type=${n}). injectDeclarationIndex=${T}, call parameters=${_}`)}else this._sourceCode=b+g+y,l+=g.length-(u+1-c),this.debug&&console.log(`Replace function call by code. Function '${s}' (type=${n}). functionCallIndex=${c}, call parameters=${_}`);t=!0}}return t}_replaceNames(t,i,s){for(let n=0;n<i.length;++n){const o=new RegExp(bre(i[n]),"g"),a=i[n].length,l=s[n];t=t.replace(o,(c,...h)=>{const u=h[0];return uC(t.charAt(u-1))||uC(t.charAt(u+a))?i[n]:l})}return t}}return r._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/,r})();class yre{get isAsync(){return this.isParallelCompiled}get isReady(){if(this.compilationError){const e=this.compilationError.message;throw new Error("SHADER ERROR"+("string"==typeof e?"\n"+e:""))}return this.isCompiled}_getVertexShaderCode(){return null}_getFragmentShaderCode(){return null}_handlesSpectorRebuildCallback(e){throw new Error("Not implemented")}constructor(e){this.isParallelCompiled=!0,this.isCompiled=!1,this._valueCache={},this._engine=e}_fillEffectInformation(e,t,i,s,n,o,a,l){const c=this._engine;if(c.supportsUniformBuffers)for(const d in t)e.bindUniformBlock(d,t[d]);let u;for(this._engine.getUniforms(this,i).forEach((d,f)=>{s[i[f]]=d}),this._uniforms=s,u=0;u<n.length;u++)null==e.getUniform(n[u])&&(n.splice(u,1),u--);n.forEach((d,f)=>{o[d]=f}),l.push(...c.getAttributes(this,a))}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],s=t.updateFlag;return(void 0===i||i!==s)&&(this._valueCache[e]=s,!0)}_cacheFloat2(e,t,i){let s=this._valueCache[e];if(!s)return s=[t,i],this._valueCache[e]=s,!0;let n=!1;return s[0]!==t&&(s[0]=t,n=!0),s[1]!==i&&(s[1]=i,n=!0),n}_cacheFloat3(e,t,i,s){let n=this._valueCache[e];if(!n)return n=[t,i,s],this._valueCache[e]=n,!0;let o=!1;return n[0]!==t&&(n[0]=t,o=!0),n[1]!==i&&(n[1]=i,o=!0),n[2]!==s&&(n[2]=s,o=!0),o}_cacheFloat4(e,t,i,s,n){let o=this._valueCache[e];if(!o)return o=[t,i,s,n],this._valueCache[e]=o,!0;let a=!1;return o[0]!==t&&(o[0]=t,a=!0),o[1]!==i&&(o[1]=i,a=!0),o[2]!==s&&(o[2]=s,a=!0),o[3]!==n&&(o[3]=n,a=!0),a}setInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this._engine.setInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setInt4(e,t,i,s,n){this._cacheFloat4(e,t,i,s,n)&&(this._engine.setInt4(this._uniforms[e],t,i,s,n)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this._engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this._engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this._engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this._engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this._engine.setUInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setUInt4(e,t,i,s,n){this._cacheFloat4(e,t,i,s,n)&&(this._engine.setUInt4(this._uniforms[e],t,i,s,n)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this._engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this._engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this._engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this._engine.setUIntArray4(this._uniforms[e],t)}setFloatArray(e,t){this._valueCache[e]=null,this._engine.setFloatArray(this._uniforms[e],t)}setFloatArray2(e,t){this._valueCache[e]=null,this._engine.setFloatArray2(this._uniforms[e],t)}setFloatArray3(e,t){this._valueCache[e]=null,this._engine.setFloatArray3(this._uniforms[e],t)}setFloatArray4(e,t){this._valueCache[e]=null,this._engine.setFloatArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){!t||(this._valueCache[e]=null,this._engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this._engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this._engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this._engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setBool(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setInt(this._uniforms[e],t?1:0)&&(this._valueCache[e]=t?1:0)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this._engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this._engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this._engine.setFloat3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,s,n){this._cacheFloat4(e,t,i,s,n)&&(this._engine.setFloat4(this._uniforms[e],t,i,s,n)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this._engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}}class xre extends DE{get _framebuffer(){return this.__framebuffer}set _framebuffer(e){this.__framebuffer&&this._engine._releaseFramebufferObjects(this.__framebuffer),this.__framebuffer=e}get _framebufferDepthStencil(){return this.__framebufferDepthStencil}set _framebufferDepthStencil(e){this.__framebufferDepthStencil&&this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil),this.__framebufferDepthStencil=e}constructor(e,t,i,s){super(e,t,i,s),this.__framebuffer=null,this.__framebufferDepthStencil=null,this._engine=s}dispose(e=!1){this._framebuffer=null,this._framebufferDepthStencil=null,super.dispose(e)}}class fV{get underlyingResource(){return this._nativeTexture}constructor(e,t){this._engine=t,this.set(e)}setUsage(){}set(e){this._nativeTexture=e}reset(){this._nativeTexture=null}release(){this._nativeTexture&&this._engine.deleteTexture(this._nativeTexture),this.reset()}}const pV=new z;if(typeof self<"u"&&!Object.prototype.hasOwnProperty.call(self,"_native")){let r;Object.defineProperty(self,"_native",{get:()=>r,set:e=>{r=e,r&&pV.notifyObservers(r)}})}function Tre(){return new Promise(r=>{typeof _native>"u"?pV.addOnce(e=>r(e)):r(_native)})}function fC(){return(fC=Qt(function*(r,e){(yield Tre())[r]=e})).apply(this,arguments)}class _V extends jg{}class Ere{constructor(e){this._engine=e,this._pending=new Array,this._isCommandBufferScopeActive=!1,this._commandStream=mV._createNativeDataStream(),this._engine.setCommandDataStream(this._commandStream)}beginCommandScope(){if(this._isCommandBufferScopeActive)throw new Error("Command scope already active.");this._isCommandBufferScopeActive=!0}endCommandScope(){if(!this._isCommandBufferScopeActive)throw new Error("Command scope is not active.");this._isCommandBufferScopeActive=!1,this._submit()}startEncodingCommand(e){this._commandStream.writeNativeData(e)}encodeCommandArgAsUInt32(e){this._commandStream.writeUint32(e)}encodeCommandArgAsUInt32s(e){this._commandStream.writeUint32Array(e)}encodeCommandArgAsInt32(e){this._commandStream.writeInt32(e)}encodeCommandArgAsInt32s(e){this._commandStream.writeInt32Array(e)}encodeCommandArgAsFloat32(e){this._commandStream.writeFloat32(e)}encodeCommandArgAsFloat32s(e){this._commandStream.writeFloat32Array(e)}encodeCommandArgAsNativeData(e){this._commandStream.writeNativeData(e),this._pending.push(e)}finishEncodingCommand(){this._isCommandBufferScopeActive||this._submit()}_submit(){this._engine.submitCommands(),this._pending.length=0}}let mV=(()=>{class r extends ee{setHardwareScalingLevel(t){super.setHardwareScalingLevel(t),this._engine.setHardwareScalingLevel(t)}constructor(t={}){if(super(null,!1,void 0,t.adaptToDeviceRatio),this._engine=new _native.Engine,this._camera=_native.Camera?new _native.Camera:null,this._commandBufferEncoder=new Ere(this._engine),this._boundBuffersVertexArray=null,this._currentDepthTest=_native.Engine.DEPTH_TEST_LEQUAL,this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=519,this._stencilFuncRef=0,this._stencilFuncMask=255,this._stencilOpStencilFail=7680,this._stencilOpDepthFail=7680,this._stencilOpStencilDepthPass=7681,this._zOffset=0,this._zOffsetUnits=0,this._depthWrite=!0,_native.Engine.PROTOCOL_VERSION!==r.PROTOCOL_VERSION)throw new Error(`Protocol version mismatch: ${_native.Engine.PROTOCOL_VERSION} (Native) !== ${r.PROTOCOL_VERSION} (JS)`);this._webGLVersion=2,this.disableUniformBuffers=!0,this._shaderPlatformName="NATIVE",this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_SIZE,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,textureFloat:!0,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloat:!1,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!1,textureLOD:!0,texelFetch:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!0,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:1,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!1,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_LAYERS},this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!1,supportSSAO2:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,_collectUbosUpdatedInFrame:!1},q.Log("Babylon Native (v"+ee.Version+") launched"),q.LoadScript=function(n,o,a,l){q.LoadFile(n,c=>{Function(c).apply(null),o&&o()},void 0,void 0,!1,(c,h)=>{a&&a("LoadScript Error",h)})},typeof URL>"u"&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),typeof Blob>"u"&&(window.Blob=function(n){return n}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function n(){const o=isNaN(arguments[0])?1:Number(arguments[0]);return o?Array.prototype.reduce.call(this,function(a,l){return Array.isArray(l)?a.push.apply(a,n.call(l,o-1)):a.push(l),a},[]):Array.prototype.slice.call(this)},writable:!0});const i=window&&window.devicePixelRatio||1;this._hardwareScalingLevel=t.adaptToDeviceRatio?1/i:1,this._engine.setHardwareScalingLevel(this._hardwareScalingLevel),this._lastDevicePixelRatio=i,this.resize();const s=this.getDepthFunction();s&&this.setDepthFunction(s),this._shaderProcessor=new n1,this.onNewSceneAddedObservable.add(n=>{const o=n.render;n.render=(...a)=>{this._commandBufferEncoder.beginCommandScope(),o.apply(n,a),this._commandBufferEncoder.endCommandScope()}})}dispose(){super.dispose(),this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._engine.dispose()}static _createNativeDataStream(){return new sC}_queueNewFrame(t,i){return i.requestAnimationFrame&&i!==window?i.requestAnimationFrame(t):this._engine.requestAnimationFrame(t),0}_bindUnboundFramebuffer(t){this._currentFramebuffer!==t&&(this._currentFramebuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(this._currentFramebuffer),this._commandBufferEncoder.finishEncodingCommand()),t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()),this._currentFramebuffer=t)}getHostDocument(){return null}clear(t,i,s,n=!1){if(this.useReverseDepthBuffer)throw new Error("reverse depth buffer is not currently implemented");this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_CLEAR),this._commandBufferEncoder.encodeCommandArgAsUInt32(i&&t?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.r:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.g:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.b:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.a:1),this._commandBufferEncoder.encodeCommandArgAsUInt32(s?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(1),this._commandBufferEncoder.encodeCommandArgAsUInt32(n?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(0),this._commandBufferEncoder.finishEncodingCommand()}createIndexBuffer(t,i){const s=this._normalizeIndexData(t),n=new _V;return n.references=1,n.is32Bits=4===s.BYTES_PER_ELEMENT,s.byteLength&&(n.nativeIndexBuffer=this._engine.createIndexBuffer(s.buffer,s.byteOffset,s.byteLength,n.is32Bits,i??!1)),n}createVertexBuffer(t,i){const s=ArrayBuffer.isView(t)?t:new Float32Array(t),n=new _V;return n.references=1,s.byteLength&&(n.nativeVertexBuffer=this._engine.createVertexBuffer(s.buffer,s.byteOffset,s.byteLength,i??!1)),n}_recordVertexArrayObject(t,i,s,n,o){s&&this._engine.recordIndexBuffer(t,s.nativeIndexBuffer);const a=n.getAttributesNames();for(let l=0;l<a.length;l++){const c=n.getAttributeLocation(l);if(c>=0){const h=a[l];let u=null;if(o&&(u=o[h]),u||(u=i[h]),u){const d=u.getBuffer();d&&d.nativeVertexBuffer&&this._engine.recordVertexBuffer(t,d.nativeVertexBuffer,c,u.byteOffset,u.byteStride,u.getSize(),this._getNativeAttribType(u.type),u.normalized,u.getInstanceDivisor())}}}}bindBuffers(t,i,s){this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._boundBuffersVertexArray=this._engine.createVertexArray(),this._recordVertexArrayObject(this._boundBuffersVertexArray,t,i,s),this.bindVertexArrayObject(this._boundBuffersVertexArray)}recordVertexArrayObject(t,i,s,n){const o=this._engine.createVertexArray();return this._recordVertexArrayObject(o,t,i,s,n),o}_deleteVertexArray(t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()}bindVertexArrayObject(t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()}releaseVertexArrayObject(t){this._deleteVertexArray(t)}getAttributes(t,i){return this._engine.getAttributes(t.nativeProgram,i)}drawElementsType(t,i,s,n){this._drawCalls.addCount(1,!1),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.finishEncodingCommand()}drawArraysType(t,i,s,n){this._drawCalls.addCount(1,!1),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAW),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.finishEncodingCommand()}createPipelineContext(){return new yre(this)}createMaterialContext(){}createDrawContext(){}_preparePipelineContext(t,i,s,n,o,a,l,c){t.nativeProgram=n?this.createRawShaderProgram():this.createShaderProgram(t,i,s,c)}isAsync(t){return!(!t.isAsync||!this._engine.createProgramAsync)}_executeWhenRenderingStateIsCompiled(t,i){const s=t;if(!this.isAsync(t))return void i();const n=s.onCompiled;s.onCompiled=n?()=>{n(),i()}:i}createRawShaderProgram(){throw new Error("Not Supported")}createShaderProgram(t,i,s,n){const o=t;if(o.nativeProgram)throw new Error("Tried to create a second program in the same NativePipelineContext");this.onBeforeShaderCompilationObservable.notifyObservers(this);const a=new Uv(i);a.processCode(),i=a.code;const l=new Uv(s);l.processCode(),s=l.code,i=we._ConcatenateShader(i,n),s=we._ConcatenateShader(s,n);const c=()=>{var h;o.isCompiled=!0,null===(h=o.onCompiled)||void 0===h||h.call(o),this.onAfterShaderCompilationObservable.notifyObservers(this)};if(this.isAsync(t))return this._engine.createProgramAsync(i,s,c,h=>{o.compilationError=h});try{const h=o.nativeProgram=this._engine.createProgram(i,s);return c(),h}catch(h){const u=h?.message;throw new Error("SHADER ERROR"+("string"==typeof u?"\n"+u:""))}}inlineShaderCode(t){const i=new Uv(t);return i.debug=!1,i.processCode(),i.code}_setProgram(t){this._currentProgram!==t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand(),this._currentProgram=t)}_deletePipelineContext(t){const i=t;i&&i.nativeProgram&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(i.nativeProgram),this._commandBufferEncoder.finishEncodingCommand())}getUniforms(t,i){return this._engine.getUniforms(t.nativeProgram,i)}bindUniformBlock(t,i,s){throw new Error("Not Implemented")}bindSamplers(t){const i=t.getPipelineContext();this._setProgram(i.nativeProgram);const s=t.getSamplers();for(let n=0;n<s.length;n++){const o=t.getUniform(s[n]);o&&(this._boundUniforms[n]=o)}this._currentEffect=null}getRenderWidth(t=!1){return!t&&this._currentRenderTarget?this._currentRenderTarget.width:this._engine.getRenderWidth()}getRenderHeight(t=!1){return!t&&this._currentRenderTarget?this._currentRenderTarget.height:this._engine.getRenderHeight()}setViewport(t,i,s){this._cachedViewport=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETVIEWPORT),this._commandBufferEncoder.encodeCommandArgAsFloat32(t.x),this._commandBufferEncoder.encodeCommandArgAsFloat32(t.y),this._commandBufferEncoder.encodeCommandArgAsFloat32(t.width),this._commandBufferEncoder.encodeCommandArgAsFloat32(t.height),this._commandBufferEncoder.finishEncodingCommand()}setState(t,i=0,s,n=!1,o,a,l=0){var c,h;this._zOffset=i,this._zOffsetUnits=l,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTATE),this._commandBufferEncoder.encodeCommandArgAsUInt32(t?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(l),this._commandBufferEncoder.encodeCommandArgAsUInt32(null===(h=null!==(c=this.cullBackFaces)&&void 0!==c?c:o)||void 0===h||h?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(n?1:0),this._commandBufferEncoder.finishEncodingCommand()}getInputElementClientRect(){return{bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth(),x:0,y:0,toJSON:()=>{}}}setZOffset(t){t!==this._zOffset&&(this._zOffset=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-t:t),this._commandBufferEncoder.finishEncodingCommand())}getZOffset(){return this._zOffset}setZOffsetUnits(t){t!==this._zOffsetUnits&&(this._zOffsetUnits=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-t:t),this._commandBufferEncoder.finishEncodingCommand())}getZOffsetUnits(){return this._zOffsetUnits}setDepthBuffer(t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(t?this._currentDepthTest:_native.Engine.DEPTH_TEST_ALWAYS),this._commandBufferEncoder.finishEncodingCommand()}getDepthWrite(){return this._depthWrite}getDepthFunction(){switch(this._currentDepthTest){case _native.Engine.DEPTH_TEST_NEVER:return 512;case _native.Engine.DEPTH_TEST_ALWAYS:return 519;case _native.Engine.DEPTH_TEST_GREATER:return 516;case _native.Engine.DEPTH_TEST_GEQUAL:return 518;case _native.Engine.DEPTH_TEST_NOTEQUAL:return 517;case _native.Engine.DEPTH_TEST_EQUAL:return 514;case _native.Engine.DEPTH_TEST_LESS:return 513;case _native.Engine.DEPTH_TEST_LEQUAL:return 515}return null}setDepthFunction(t){let i=0;switch(t){case 512:i=_native.Engine.DEPTH_TEST_NEVER;break;case 519:i=_native.Engine.DEPTH_TEST_ALWAYS;break;case 516:i=_native.Engine.DEPTH_TEST_GREATER;break;case 518:i=_native.Engine.DEPTH_TEST_GEQUAL;break;case 517:i=_native.Engine.DEPTH_TEST_NOTEQUAL;break;case 514:i=_native.Engine.DEPTH_TEST_EQUAL;break;case 513:i=_native.Engine.DEPTH_TEST_LESS;break;case 515:i=_native.Engine.DEPTH_TEST_LEQUAL}this._currentDepthTest=i,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(this._currentDepthTest),this._commandBufferEncoder.finishEncodingCommand()}setDepthWrite(t){this._depthWrite=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(t)),this._commandBufferEncoder.finishEncodingCommand()}setColorWrite(t){this._colorWrite=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(t)),this._commandBufferEncoder.finishEncodingCommand()}getColorWrite(){return this._colorWrite}applyStencil(){this._setStencil(this._stencilMask,this._getStencilOpFail(this._stencilOpStencilFail),this._getStencilDepthFail(this._stencilOpDepthFail),this._getStencilDepthPass(this._stencilOpStencilDepthPass),this._getStencilFunc(this._stencilFunc),this._stencilFuncRef)}_setStencil(t,i,s,n,o,a){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.encodeCommandArgAsUInt32(o),this._commandBufferEncoder.encodeCommandArgAsUInt32(a),this._commandBufferEncoder.finishEncodingCommand()}setStencilBuffer(t){this._stencilTest=t,t?this.applyStencil():this._setStencil(255,_native.Engine.STENCIL_OP_FAIL_S_KEEP,_native.Engine.STENCIL_OP_FAIL_Z_KEEP,_native.Engine.STENCIL_OP_PASS_Z_KEEP,_native.Engine.STENCIL_TEST_ALWAYS,0)}getStencilBuffer(){return this._stencilTest}getStencilOperationPass(){return this._stencilOpStencilDepthPass}setStencilOperationPass(t){this._stencilOpStencilDepthPass=t,this.applyStencil()}setStencilMask(t){this._stencilMask=t,this.applyStencil()}setStencilFunction(t){this._stencilFunc=t,this.applyStencil()}setStencilFunctionReference(t){this._stencilFuncRef=t,this.applyStencil()}setStencilFunctionMask(t){this._stencilFuncMask=t}setStencilOperationFail(t){this._stencilOpStencilFail=t,this.applyStencil()}setStencilOperationDepthFail(t){this._stencilOpDepthFail=t,this.applyStencil()}getStencilMask(){return this._stencilMask}getStencilFunction(){return this._stencilFunc}getStencilFunctionReference(){return this._stencilFuncRef}getStencilFunctionMask(){return this._stencilFuncMask}getStencilOperationFail(){return this._stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilOpDepthFail}setAlphaConstants(t,i,s,n){throw new Error("Setting alpha blend constant color not yet implemented.")}setAlphaMode(t,i=!1){if(this._alphaMode===t)return;const s=this._getNativeAlphaMode(t);this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.finishEncodingCommand(),i||this.setDepthWrite(0===t),this._alphaMode=t}getAlphaMode(){return this._alphaMode}setInt(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINT),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray2(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray3(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray4(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray2(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray3(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray4(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setArray(t,i){return!!t&&this.setFloatArray(t,new Float32Array(i))}setArray2(t,i){return!!t&&this.setFloatArray2(t,new Float32Array(i))}setArray3(t,i){return!!t&&this.setFloatArray3(t,new Float32Array(i))}setArray4(t,i){return!!t&&this.setFloatArray4(t,new Float32Array(i))}setMatrices(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setMatrix3x3(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setMatrix2x2(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat2(t,i,s){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat3(t,i,s,n){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.encodeCommandArgAsFloat32(n),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat4(t,i,s,n,o){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.encodeCommandArgAsFloat32(n),this._commandBufferEncoder.encodeCommandArgAsFloat32(o),this._commandBufferEncoder.finishEncodingCommand(),!0)}setColor3(t,i){return!!t&&(this.setFloat3(t,i.r,i.g,i.b),!0)}setColor4(t,i,s){return!!t&&(this.setFloat4(t,i.r,i.g,i.b,s),!0)}wipeCaches(t){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,t&&(this._currentProgram=null,this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}_createTexture(){return this._engine.createTexture()}_deleteTexture(t){t&&this._engine.deleteTexture(t)}updateDynamicTexture(t,i,s,n=!1,o){if(void 0===n&&(n=!1),t&&t._hardwareTexture){const a=i.getCanvasTexture();this._engine.copyTexture(t._hardwareTexture.underlyingResource,a),t.isReady=!0}}createDynamicTexture(t,i,s,n){return t=Math.max(t,1),i=Math.max(i,1),this.createRawTexture(new Uint8Array(t*i*4),t,i,5,!1,!1,n)}createVideoElement(t){return this._camera?this._camera.createVideo(t):null}updateVideoTexture(t,i,s){t&&t._hardwareTexture&&this._camera&&this._camera.updateVideoTexture(t._hardwareTexture.underlyingResource,i,s)}createRawTexture(t,i,s,n,o,a,l,c=null,h=0,u=0,d=!1){const f=new zt(this,Ye.Raw);if(f.format=n,f.generateMipMaps=o,f.samplingMode=l,f.invertY=a,f.baseWidth=i,f.baseHeight=s,f.width=f.baseWidth,f.height=f.baseHeight,f._compression=c,f.type=h,f._useSRGBBuffer=this._getUseSRGBBuffer(d,!o),this.updateRawTexture(f,t,n,a,c,h,f._useSRGBBuffer),f._hardwareTexture){const p=f._hardwareTexture.underlyingResource,_=this._getNativeSamplingMode(l);this._setTextureSampling(p,_)}return this._internalTexturesCache.push(f),f}createRawTexture2DArray(t,i,s,n,o,a,l,c,h=null,u=0){const d=new zt(this,Ye.Raw2DArray);if(d.baseWidth=i,d.baseHeight=s,d.baseDepth=n,d.width=i,d.height=s,d.depth=n,d.format=o,d.type=u,d.generateMipMaps=a,d.samplingMode=c,d.is2DArray=!0,d._hardwareTexture){const f=d._hardwareTexture.underlyingResource;this._engine.loadRawTexture2DArray(f,t,i,s,n,this._getNativeTextureFormat(o,u),a,l);const p=this._getNativeSamplingMode(c);this._setTextureSampling(f,p)}return d.isReady=!0,this._internalTexturesCache.push(d),d}updateRawTexture(t,i,s,n,o=null,a=0,l=!1){t&&(i&&t._hardwareTexture&&this._engine.loadRawTexture(t._hardwareTexture.underlyingResource,i,t.width,t.height,this._getNativeTextureFormat(s,a),t.generateMipMaps,t.invertY),t.isReady=!0)}createTexture(t,i,s,n,o=3,a=null,l=null,c=null,h=null,u=null,d=null,f,p,_,m=!1){const g="data:"===(t=t||"").substr(0,5),b=g&&-1!==t.indexOf(";base64,"),y=h||new zt(this,Ye.Url),T=t;this._transformTextureUrl&&!b&&!h&&!c&&(t=this._transformTextureUrl(t));const x=t.lastIndexOf("."),S=d||(x>-1?t.substring(x).toLowerCase():"");let C=null;for(const M of ee._TextureLoaders)if(M.canLoad(S)){C=M;break}n&&n.addPendingData(y),y.url=t,y.generateMipMaps=!i,y.samplingMode=o,y.invertY=s,y._useSRGBBuffer=this._getUseSRGBBuffer(m,i),this.doNotHandleContextLost||(y._buffer=c);let D=null;a&&!h&&(D=y.onLoadedObservable.add(a)),h||this._internalTexturesCache.push(y);const P=(M,w)=>{n&&n.removePendingData(y),t===T?(D&&y.onLoadedObservable.remove(D),be.UseFallbackTexture&&this.createTexture(be.FallbackTexture,i,y.invertY,n,o,null,l,c,y),l&&l((M||"Unknown error")+(be.UseFallbackTexture?" - Fallback texture was used":""),w)):(V.Warn(`Failed to load ${t}, falling back to ${T}`),this.createTexture(T,i,y.invertY,n,o,a,l,c,y,u,d,f,p))};if(C)throw new Error("Loading textures from IInternalTextureLoader not yet implemented.");{const M=w=>{if(!y._hardwareTexture)return void(n&&n.removePendingData(y));const k=y._hardwareTexture.underlyingResource;this._engine.loadTexture(k,w,!i,s,m,()=>{y.baseWidth=this._engine.getTextureWidth(k),y.baseHeight=this._engine.getTextureHeight(k),y.width=y.baseWidth,y.height=y.baseHeight,y.isReady=!0;const X=this._getNativeSamplingMode(o);this._setTextureSampling(k,X),n&&n.removePendingData(y),y.onLoadedObservable.notifyObservers(y),y.onLoadedObservable.clear()},()=>{throw new Error("Could not load a native texture.")})};if(g&&c)if(c instanceof ArrayBuffer)M(new Uint8Array(c));else if(ArrayBuffer.isView(c))M(c);else{if("string"!=typeof c)throw new Error("Unsupported buffer type");M(new Uint8Array(q.DecodeBase64(c)))}else b?M(new Uint8Array(q.DecodeBase64(t))):this._loadFile(t,w=>M(new Uint8Array(w)),void 0,void 0,!0,(w,k)=>{P("Unable to load "+k)})}return y}wrapNativeTexture(t,i=!1,s=3){const n=new fV(t,this._engine),o=new zt(this,Ye.Unknown,!0);return o._hardwareTexture=n,o.isReady=!0,o.useMipMaps=i,this.updateTextureSamplingMode(s,o),o}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapNativeTexture instead.")}_createDepthStencilTexture(t,i,s){const n=s,o=new zt(this,Ye.DepthStencil),c=this._engine.createFrameBuffer(o._hardwareTexture.underlyingResource,t.width||t,t.height||t,!0,!0);return n._framebufferDepthStencil=c,o}_releaseFramebufferObjects(t){t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand())}_createImageBitmapFromSource(t,i){return new Promise((n,o)=>{const a=this.createCanvasImage();a.onload=()=>{try{const l=this._engine.createImageBitmap(a);n(l)}catch(l){o(`Error loading image ${a.src} with exception: ${l}`)}},a.onerror=l=>{o(`Error loading image ${a.src} with exception: ${l}`)},a.src=t})}createImageBitmap(t,i){return new Promise((s,n)=>{if(Array.isArray(t)){const o=t;if(o.length){const a=this._engine.createImageBitmap(o[0]);if(a)return void s(a)}}n("Unsupported data for createImageBitmap.")})}resizeImageBitmap(t,i,s){return this._engine.resizeImageBitmap(t,i,s)}createCubeTexture(t,i,s,n,o=null,a=null,l,c=null,h=!1,u=0,d=0,f=null,p,_=!1){const m=f||new zt(this,Ye.Cube);m.isCube=!0,m.url=t,m.generateMipMaps=!n,m._lodGenerationScale=u,m._lodGenerationOffset=d,this._doNotHandleContextLost||(m._extension=c,m._files=s);const g=t.lastIndexOf(".");if(".env"===(c||(g>-1?t.substring(g).toLowerCase():""))){const y=T=>{const x=aC(T);m.width=x.width,m.height=x.width,hC(m,x);const S=x.specular;if(!S)throw new Error("Nothing else parsed so far");m._lodGenerationScale=S.lodGenerationScale;const C=cC(T,x);m.format=5,m.type=0,m.generateMipMaps=!0,m.getEngine().updateTextureSamplingMode(U.TRILINEAR_SAMPLINGMODE,m),m._isRGBD=!0,m.invertY=!0,this._engine.loadCubeTextureWithMips(m._hardwareTexture.underlyingResource,C,!1,_,()=>{m.isReady=!0,o&&o()},()=>{throw new Error("Could not load a native cube texture.")})};if(s&&6===s.length)throw new Error("Multi-file loading not allowed on env files.");this._loadFile(t,x=>y(new Uint8Array(x)),void 0,void 0,!0,(x,S)=>{a&&x&&a(x.status+" "+x.statusText,S)})}else{if(!s||6!==s.length)throw new Error("Cannot load cubemap because 6 files were not defined");Promise.all([s[0],s[3],s[1],s[4],s[2],s[5]].map(T=>q.LoadFileAsync(T).then(x=>new Uint8Array(x)))).then(T=>new Promise((x,S)=>{this._engine.loadCubeTexture(m._hardwareTexture.underlyingResource,T,!n,!0,_,x,S)})).then(()=>{m.isReady=!0,o&&o()},T=>{a&&a(`Failed to load cubemap: ${T.message}`,T)})}return this._internalTexturesCache.push(m),m}_createHardwareTexture(){return new fV(this._createTexture(),this._engine)}_createHardwareRenderTargetWrapper(t,i,s){const n=new xre(t,i,s,this);return this._renderTargetWrapperCache.push(n),n}_createInternalTexture(t,i,s=!0,n=Ye.Unknown){var o;let a=!1,l=0,c=3,h=5,u=!1,d=1;void 0!==i&&"object"==typeof i?(a=!!i.generateMipMaps,l=void 0===i.type?0:i.type,c=void 0===i.samplingMode?3:i.samplingMode,h=void 0===i.format?5:i.format,u=void 0!==i.useSRGBBuffer&&i.useSRGBBuffer,d=null!==(o=i.samples)&&void 0!==o?o:1):a=!!i,u&&(u=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1===l&&!this._caps.textureFloatLinearFiltering||2===l&&!this._caps.textureHalfFloatLinearFiltering)&&(c=1),1===l&&!this._caps.textureFloat&&(l=0,V.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const f=new zt(this,n),p=t.width||t,_=t.height||t,m=t.layers||0;if(0!==m)throw new Error("Texture layers are not supported in Babylon Native");const g=f._hardwareTexture.underlyingResource,b=this._getNativeTextureFormat(h,l);return this._engine.initializeTexture(g,p,_,a,b,!0,u),this._setTextureSampling(g,this._getNativeSamplingMode(c)),f._useSRGBBuffer=u,f.baseWidth=p,f.baseHeight=_,f.width=p,f.height=_,f.depth=m,f.isReady=!0,f.samples=d,f.generateMipMaps=a,f.samplingMode=c,f.type=l,f.format=h,this._internalTexturesCache.push(f),f}createRenderTargetTexture(t,i){var s;const n=this._createHardwareRenderTargetWrapper(!1,!1,t);let c,o=!0,a=!1,l=!1;void 0!==i&&"object"==typeof i&&(o=null===(s=i.generateDepthBuffer)||void 0===s||s,a=!!i.generateStencilBuffer,l=!!i.noColorAttachment,c=i.colorAttachment);const h=c||(l?null:this._createInternalTexture(t,i,!0,Ye.RenderTarget)),f=this._engine.createFrameBuffer(h?h._hardwareTexture.underlyingResource:null,t.width||t,t.height||t,a,o);return n._framebuffer=f,n._generateDepthBuffer=o,n._generateStencilBuffer=a,n.setTextures(h),n}updateTextureSamplingMode(t,i){if(i._hardwareTexture){const s=this._getNativeSamplingMode(t);this._setTextureSampling(i._hardwareTexture.underlyingResource,s)}i.samplingMode=t}bindFramebuffer(t,i,s,n,o){const a=t;if(this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=t,i)throw new Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(s||n)throw new Error("Required width/height for frame buffers not yet supported in NativeEngine.");this._bindUnboundFramebuffer(a._framebufferDepthStencil?a._framebufferDepthStencil:a._framebuffer)}unBindFramebuffer(t,i=!1,s){this._currentRenderTarget=null,s&&s(),this._bindUnboundFramebuffer(null)}createDynamicVertexBuffer(t){return this.createVertexBuffer(t,!0)}updateDynamicIndexBuffer(t,i,s=0){const n=t,o=this._normalizeIndexData(i);n.is32Bits=4===o.BYTES_PER_ELEMENT,this._engine.updateDynamicIndexBuffer(n.nativeIndexBuffer,o.buffer,o.byteOffset,o.byteLength,s)}updateDynamicVertexBuffer(t,i,s,n){const o=t,a=ArrayBuffer.isView(i)?i:new Float32Array(i);this._engine.updateDynamicVertexBuffer(o.nativeVertexBuffer,a.buffer,a.byteOffset+(s??0),n??a.byteLength)}_setTexture(t,i,s=!1,n=!1){const o=this._boundUniforms[t];if(!o)return!1;if(!i)return null!=this._boundTexturesCache[t]&&(this._activeChannel=t,this._boundTexturesCache[t]=null),!1;if(i.video)this._activeChannel=t,i.update();else if(4===i.delayLoadState)return i.delayLoad(),!1;let a;return a=n?i.depthStencilTexture:i.isReady()?i.getInternalTexture():i.isCube?this.emptyCubeTexture:i.is3D?this.emptyTexture3D:i.is2DArray?this.emptyTexture2DArray:this.emptyTexture,this._activeChannel=t,!(!a||!a._hardwareTexture||(this._setTextureWrapMode(a._hardwareTexture.underlyingResource,this._getAddressMode(i.wrapU),this._getAddressMode(i.wrapV),this._getAddressMode(i.wrapR)),this._updateAnisotropicLevel(i),this._setTextureCore(o,a._hardwareTexture.underlyingResource),0))}_setTextureSampling(t,i){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand()}_setTextureWrapMode(t,i,s,n){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand()}_setTextureCore(t,i){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsNativeData(i),this._commandBufferEncoder.finishEncodingCommand()}_updateAnisotropicLevel(t){const i=t.getInternalTexture(),s=t.anisotropicFilteringLevel;!i||!i._hardwareTexture||i._cachedAnisotropicFilteringLevel!==s&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL),this._commandBufferEncoder.encodeCommandArgAsNativeData(i._hardwareTexture.underlyingResource),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.finishEncodingCommand(),i._cachedAnisotropicFilteringLevel=s)}_getAddressMode(t){switch(t){case 1:return _native.Engine.ADDRESS_MODE_WRAP;case 0:return _native.Engine.ADDRESS_MODE_CLAMP;case 2:return _native.Engine.ADDRESS_MODE_MIRROR;default:throw new Error("Unexpected wrap mode: "+t+".")}}_bindTexture(t,i){const s=this._boundUniforms[t];s&&i&&i._hardwareTexture&&this._setTextureCore(s,i._hardwareTexture.underlyingResource)}_deleteBuffer(t){t.nativeIndexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.nativeIndexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete t.nativeIndexBuffer),t.nativeVertexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.nativeVertexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete t.nativeVertexBuffer)}createCanvas(t,i){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");const s=new _native.Canvas;return s.width=t,s.height=i,s}createCanvasImage(){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");return new _native.Image}updateTextureData(t,i,s,n,o,a,l=0,c=0,h=!1){throw new Error("updateTextureData not implemented.")}_uploadCompressedDataToTextureDirectly(t,i,s,n,o,a=0,l=0){throw new Error("_uploadCompressedDataToTextureDirectly not implemented.")}_uploadDataToTextureDirectly(t,i,s=0,n=0){throw new Error("_uploadDataToTextureDirectly not implemented.")}_uploadArrayBufferViewToTexture(t,i,s=0,n=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_uploadImageToTexture(t,i,s=0,n=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_getNativeSamplingMode(t){switch(t){case 1:return _native.Engine.TEXTURE_NEAREST_NEAREST;case 2:return _native.Engine.TEXTURE_LINEAR_LINEAR;case 3:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return _native.Engine.TEXTURE_NEAREST_LINEAR;case 8:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return _native.Engine.TEXTURE_LINEAR_NEAREST;default:throw new Error(`Unsupported sampling mode: ${t}.`)}}_getStencilFunc(t){switch(t){case 513:return _native.Engine.STENCIL_TEST_LESS;case 515:return _native.Engine.STENCIL_TEST_LEQUAL;case 514:return _native.Engine.STENCIL_TEST_EQUAL;case 518:return _native.Engine.STENCIL_TEST_GEQUAL;case 516:return _native.Engine.STENCIL_TEST_GREATER;case 517:return _native.Engine.STENCIL_TEST_NOTEQUAL;case 512:return _native.Engine.STENCIL_TEST_NEVER;case 519:return _native.Engine.STENCIL_TEST_ALWAYS;default:throw new Error(`Unsupported stencil func mode: ${t}.`)}}_getStencilOpFail(t){switch(t){case 7680:return _native.Engine.STENCIL_OP_FAIL_S_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_S_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_S_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_S_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_S_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;default:throw new Error(`Unsupported stencil OpFail mode: ${t}.`)}}_getStencilDepthFail(t){switch(t){case 7680:return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;default:throw new Error(`Unsupported stencil depthFail mode: ${t}.`)}}_getStencilDepthPass(t){switch(t){case 7680:return _native.Engine.STENCIL_OP_PASS_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_PASS_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_PASS_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_PASS_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_PASS_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;default:throw new Error(`Unsupported stencil opPass mode: ${t}.`)}}_getNativeTextureFormat(t,i){if(4==t&&0==i)return _native.Engine.TEXTURE_FORMAT_RGB8;if(5==t&&0==i)return _native.Engine.TEXTURE_FORMAT_RGBA8;if(5==t&&2==i)return _native.Engine.TEXTURE_FORMAT_RGBA16F;if(5==t&&1==i)return _native.Engine.TEXTURE_FORMAT_RGBA32F;throw new No(`Unsupported texture format or type: format ${t}, type ${i}.`,1e3)}_getNativeAlphaMode(t){switch(t){case 0:return _native.Engine.ALPHA_DISABLE;case 1:return _native.Engine.ALPHA_ADD;case 2:return _native.Engine.ALPHA_COMBINE;case 3:return _native.Engine.ALPHA_SUBTRACT;case 4:return _native.Engine.ALPHA_MULTIPLY;case 5:return _native.Engine.ALPHA_MAXIMIZED;case 6:return _native.Engine.ALPHA_ONEONE;case 7:return _native.Engine.ALPHA_PREMULTIPLIED;case 8:return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return _native.Engine.ALPHA_INTERPOLATE;case 10:return _native.Engine.ALPHA_SCREENMODE;default:throw new Error(`Unsupported alpha mode: ${t}.`)}}_getNativeAttribType(t){switch(t){case A.BYTE:return _native.Engine.ATTRIB_TYPE_INT8;case A.UNSIGNED_BYTE:return _native.Engine.ATTRIB_TYPE_UINT8;case A.SHORT:return _native.Engine.ATTRIB_TYPE_INT16;case A.UNSIGNED_SHORT:return _native.Engine.ATTRIB_TYPE_UINT16;case A.FLOAT:return _native.Engine.ATTRIB_TYPE_FLOAT;default:throw new Error(`Unsupported attribute type: ${t}.`)}}getFontOffset(t){return{ascent:0,height:0,descent:0}}_readTexturePixels(t,i,s,n,o,a,l,c,h,u){var d,f,p,_;if(void 0!==n&&-1!==n)throw new Error(`Reading cubemap faces is not supported, but faceIndex is ${n}.`);return this._engine.readTexture(null===(d=t._hardwareTexture)||void 0===d?void 0:d.underlyingResource,o??0,h??0,u??0,i,s,null!==(f=a?.buffer)&&void 0!==f?f:null,null!==(p=a?.byteOffset)&&void 0!==p?p:0,null!==(_=a?.byteLength)&&void 0!==_?_:0).then(m=>(a||(a=new Uint8Array(m)),a))}}return r.PROTOCOL_VERSION=8,r})();mV._createNativeDataStream=function(){return _native.NativeDataStream.VALIDATION_ENABLED?new Cre:new sC};class Cre extends sC{constructor(){super()}writeUint32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32),super.writeUint32(e)}writeInt32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32),super.writeInt32(e)}writeFloat32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32),super.writeFloat32(e)}writeUint32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32_ARRAY),super.writeUint32Array(e)}writeInt32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32_ARRAY),super.writeInt32Array(e)}writeFloat32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32_ARRAY),super.writeFloat32Array(e)}writeNativeData(e){super.writeUint32(_native.NativeDataStream.VALIDATION_NATIVE_DATA),super.writeNativeData(e)}writeBoolean(e){super.writeUint32(_native.NativeDataStream.VALIDATION_BOOLEAN),super.writeBoolean(e)}}var oc=(()=>{return(r=oc||(oc={})).DepthClipControl="depth-clip-control",r.Depth24UnormStencil8="depth24unorm-stencil8",r.Depth32FloatStencil8="depth32float-stencil8",r.TextureCompressionBC="texture-compression-bc",r.TextureCompressionETC2="texture-compression-etc2",r.TextureCompressionASTC="texture-compression-astc",r.TimestampQuery="timestamp-query",r.IndirectFirstInstance="indirect-first-instance",r.ShaderF16="shader-f16",r.BGRA8UnormStorage="bgra8unorm-storage",oc;var r})(),ei=(()=>{return(r=ei||(ei={}))[r.MapRead=1]="MapRead",r[r.MapWrite=2]="MapWrite",r[r.CopySrc=4]="CopySrc",r[r.CopyDst=8]="CopyDst",r[r.Index=16]="Index",r[r.Vertex=32]="Vertex",r[r.Uniform=64]="Uniform",r[r.Storage=128]="Storage",r[r.Indirect=256]="Indirect",r[r.QueryResolve=512]="QueryResolve",ei;var r})(),ac=(()=>{return(r=ac||(ac={}))[r.Read=1]="Read",r[r.Write=2]="Write",ac;var r})(),cl=(()=>{return(r=cl||(cl={})).E1d="1d",r.E2d="2d",r.E3d="3d",cl;var r})(),ci=(()=>{return(r=ci||(ci={}))[r.CopySrc=1]="CopySrc",r[r.CopyDst=2]="CopyDst",r[r.TextureBinding=4]="TextureBinding",r[r.StorageBinding=8]="StorageBinding",r[r.RenderAttachment=16]="RenderAttachment",ci;var r})(),Kt=(()=>{return(r=Kt||(Kt={})).E1d="1d",r.E2d="2d",r.E2dArray="2d-array",r.Cube="cube",r.CubeArray="cube-array",r.E3d="3d",Kt;var r})(),hl=(()=>{return(r=hl||(hl={})).All="all",r.StencilOnly="stencil-only",r.DepthOnly="depth-only",hl;var r})(),N=(()=>{return(r=N||(N={})).R8Unorm="r8unorm",r.R8Snorm="r8snorm",r.R8Uint="r8uint",r.R8Sint="r8sint",r.R16Uint="r16uint",r.R16Sint="r16sint",r.R16Float="r16float",r.RG8Unorm="rg8unorm",r.RG8Snorm="rg8snorm",r.RG8Uint="rg8uint",r.RG8Sint="rg8sint",r.R32Uint="r32uint",r.R32Sint="r32sint",r.R32Float="r32float",r.RG16Uint="rg16uint",r.RG16Sint="rg16sint",r.RG16Float="rg16float",r.RGBA8Unorm="rgba8unorm",r.RGBA8UnormSRGB="rgba8unorm-srgb",r.RGBA8Snorm="rgba8snorm",r.RGBA8Uint="rgba8uint",r.RGBA8Sint="rgba8sint",r.BGRA8Unorm="bgra8unorm",r.BGRA8UnormSRGB="bgra8unorm-srgb",r.RGB9E5UFloat="rgb9e5ufloat",r.RGB10A2Unorm="rgb10a2unorm",r.RG11B10UFloat="rg11b10ufloat",r.RG32Uint="rg32uint",r.RG32Sint="rg32sint",r.RG32Float="rg32float",r.RGBA16Uint="rgba16uint",r.RGBA16Sint="rgba16sint",r.RGBA16Float="rgba16float",r.RGBA32Uint="rgba32uint",r.RGBA32Sint="rgba32sint",r.RGBA32Float="rgba32float",r.Stencil8="stencil8",r.Depth16Unorm="depth16unorm",r.Depth24Plus="depth24plus",r.Depth24PlusStencil8="depth24plus-stencil8",r.Depth32Float="depth32float",r.BC1RGBAUnorm="bc1-rgba-unorm",r.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",r.BC2RGBAUnorm="bc2-rgba-unorm",r.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",r.BC3RGBAUnorm="bc3-rgba-unorm",r.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",r.BC4RUnorm="bc4-r-unorm",r.BC4RSnorm="bc4-r-snorm",r.BC5RGUnorm="bc5-rg-unorm",r.BC5RGSnorm="bc5-rg-snorm",r.BC6HRGBUFloat="bc6h-rgb-ufloat",r.BC6HRGBFloat="bc6h-rgb-float",r.BC7RGBAUnorm="bc7-rgba-unorm",r.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",r.ETC2RGB8Unorm="etc2-rgb8unorm",r.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",r.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",r.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",r.ETC2RGBA8Unorm="etc2-rgba8unorm",r.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",r.EACR11Unorm="eac-r11unorm",r.EACR11Snorm="eac-r11snorm",r.EACRG11Unorm="eac-rg11unorm",r.EACRG11Snorm="eac-rg11snorm",r.ASTC4x4Unorm="astc-4x4-unorm",r.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",r.ASTC5x4Unorm="astc-5x4-unorm",r.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",r.ASTC5x5Unorm="astc-5x5-unorm",r.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",r.ASTC6x5Unorm="astc-6x5-unorm",r.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",r.ASTC6x6Unorm="astc-6x6-unorm",r.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",r.ASTC8x5Unorm="astc-8x5-unorm",r.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",r.ASTC8x6Unorm="astc-8x6-unorm",r.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",r.ASTC8x8Unorm="astc-8x8-unorm",r.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",r.ASTC10x5Unorm="astc-10x5-unorm",r.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",r.ASTC10x6Unorm="astc-10x6-unorm",r.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",r.ASTC10x8Unorm="astc-10x8-unorm",r.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",r.ASTC10x10Unorm="astc-10x10-unorm",r.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",r.ASTC12x10Unorm="astc-12x10-unorm",r.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",r.ASTC12x12Unorm="astc-12x12-unorm",r.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",r.Depth24UnormStencil8="depth24unorm-stencil8",r.Depth32FloatStencil8="depth32float-stencil8",N;var r})(),bh=(()=>{return(r=bh||(bh={})).ClampToEdge="clamp-to-edge",r.Repeat="repeat",r.MirrorRepeat="mirror-repeat",bh;var r})(),mt=(()=>{return(r=mt||(mt={})).Nearest="nearest",r.Linear="linear",mt;var r})(),Es=(()=>{return(r=Es||(Es={})).Never="never",r.Less="less",r.Equal="equal",r.LessEqual="less-equal",r.Greater="greater",r.NotEqual="not-equal",r.GreaterEqual="greater-equal",r.Always="always",Es;var r})(),ul=(()=>{return(r=ul||(ul={}))[r.Vertex=1]="Vertex",r[r.Fragment=2]="Fragment",r[r.Compute=4]="Compute",ul;var r})(),dl=(()=>{return(r=dl||(dl={})).Uniform="uniform",r.Storage="storage",r.ReadOnlyStorage="read-only-storage",dl;var r})(),fl=(()=>{return(r=fl||(fl={})).Filtering="filtering",r.NonFiltering="non-filtering",r.Comparison="comparison",fl;var r})(),tn=(()=>{return(r=tn||(tn={})).Float="float",r.UnfilterableFloat="unfilterable-float",r.Depth="depth",r.Sint="sint",r.Uint="uint",tn;var r})(),kv=(()=>((kv||(kv={})).WriteOnly="write-only",kv))(),Zu=(()=>((Zu||(Zu={})).Auto="auto",Zu))(),sn=(()=>{return(r=sn||(sn={})).PointList="point-list",r.LineList="line-list",r.LineStrip="line-strip",r.TriangleList="triangle-list",r.TriangleStrip="triangle-strip",sn;var r})(),Pp=(()=>{return(r=Pp||(Pp={})).CCW="ccw",r.CW="cw",Pp;var r})(),Ju=(()=>{return(r=Ju||(Ju={})).None="none",r.Front="front",r.Back="back",Ju;var r})(),cr=(()=>{return(r=cr||(cr={})).Zero="zero",r.One="one",r.Src="src",r.OneMinusSrc="one-minus-src",r.SrcAlpha="src-alpha",r.OneMinusSrcAlpha="one-minus-src-alpha",r.Dst="dst",r.OneMinusDst="one-minus-dst",r.DstAlpha="dst-alpha",r.OneMinusDstAlpha="one-minus-dst-alpha",r.SrcAlphaSaturated="src-alpha-saturated",r.Constant="constant",r.OneMinusConstant="one-minus-constant",cr;var r})(),pl=(()=>{return(r=pl||(pl={})).Add="add",r.Subtract="subtract",r.ReverseSubtract="reverse-subtract",r.Min="min",r.Max="max",pl;var r})(),_o=(()=>{return(r=_o||(_o={})).Keep="keep",r.Zero="zero",r.Replace="replace",r.Invert="invert",r.IncrementClamp="increment-clamp",r.DecrementClamp="decrement-clamp",r.IncrementWrap="increment-wrap",r.DecrementWrap="decrement-wrap",_o;var r})(),_l=(()=>{return(r=_l||(_l={})).Uint16="uint16",r.Uint32="uint32",_l;var r})(),pi=(()=>{return(r=pi||(pi={})).Uint8x2="uint8x2",r.Uint8x4="uint8x4",r.Sint8x2="sint8x2",r.Sint8x4="sint8x4",r.Unorm8x2="unorm8x2",r.Unorm8x4="unorm8x4",r.Snorm8x2="snorm8x2",r.Snorm8x4="snorm8x4",r.Uint16x2="uint16x2",r.Uint16x4="uint16x4",r.Sint16x2="sint16x2",r.Sint16x4="sint16x4",r.Unorm16x2="unorm16x2",r.Unorm16x4="unorm16x4",r.Snorm16x2="snorm16x2",r.Snorm16x4="snorm16x4",r.Float16x2="float16x2",r.Float16x4="float16x4",r.Float32="float32",r.Float32x2="float32x2",r.Float32x3="float32x3",r.Float32x4="float32x4",r.Uint32="uint32",r.Uint32x2="uint32x2",r.Uint32x3="uint32x3",r.Uint32x4="uint32x4",r.Sint32="sint32",r.Sint32x2="sint32x2",r.Sint32x3="sint32x3",r.Sint32x4="sint32x4",pi;var r})(),Dp=(()=>{return(r=Dp||(Dp={})).Vertex="vertex",r.Instance="instance",Dp;var r})(),ns=(()=>{return(r=ns||(ns={})).Load="load",r.Clear="clear",ns;var r})(),gn=(()=>{return(r=gn||(gn={})).Store="store",r.Discard="discard",gn;var r})(),wp=(()=>{return(r=wp||(wp={})).Occlusion="occlusion",r.Timestamp="timestamp",wp;var r})(),Op=(()=>{return(r=Op||(Op={})).Opaque="opaque",r.Premultiplied="premultiplied",Op;var r})();class _i{constructor(){this.shaderLanguage=ui.GLSL}_addUniformToLeftOverUBO(e,t,i){let s=0;[e,t,s]=this._getArraySize(e,t,i);for(let n=0;n<this._webgpuProcessingContext.leftOverUniforms.length;n++)if(this._webgpuProcessingContext.leftOverUniforms[n].name===e)return;this._webgpuProcessingContext.leftOverUniforms.push({name:e,type:t,length:s})}_buildLeftOverUBO(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return"";const e=_i.LeftOvertUBOName;let t=this._webgpuProcessingContext.availableBuffers[e];return t||(t={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[e]=t,this._addBufferBindingDescription(e,t,dl.Uniform,!0),this._addBufferBindingDescription(e,t,dl.Uniform,!1)),this._generateLeftOverUBOCode(e,t)}_collectBindingNames(){for(let e=0;e<this._webgpuProcessingContext.bindGroupLayoutEntries.length;e++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e];if(void 0!==t)for(let i=0;i<t.length;i++){const s=this._webgpuProcessingContext.bindGroupLayoutEntries[e][i],n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][s.binding].name,o=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][s.binding].nameInArrayOfTexture;s&&(s.texture||s.externalTexture||s.storageTexture?this._webgpuProcessingContext.textureNames.push(o):s.sampler?this._webgpuProcessingContext.samplerNames.push(n):s.buffer&&this._webgpuProcessingContext.bufferNames.push(n))}else this._webgpuProcessingContext.bindGroupLayoutEntries[e]=[]}}_preCreateBindGroupEntries(){const e=this._webgpuProcessingContext.bindGroupEntries;for(let t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){const i=this._webgpuProcessingContext.bindGroupLayoutEntries[t],s=[];for(let n=0;n<i.length;n++){const o=this._webgpuProcessingContext.bindGroupLayoutEntries[t][n];o.sampler||o.texture||o.storageTexture||o.externalTexture?s.push({binding:o.binding,resource:void 0}):o.buffer&&s.push({binding:o.binding,resource:{buffer:void 0,offset:0,size:0}})}e[t]=s}}_addTextureBindingDescription(e,t,i,s,n,o){let{groupIndex:a,bindingIndex:l}=t.textures[i];if(this._webgpuProcessingContext.bindGroupLayoutEntries[a]||(this._webgpuProcessingContext.bindGroupLayoutEntries[a]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][l]){let c;c=this._webgpuProcessingContext.bindGroupLayoutEntries[a].push(null===s?{binding:l,visibility:0,externalTexture:{}}:n?{binding:l,visibility:0,storageTexture:{access:kv.WriteOnly,format:n,viewDimension:s}}:{binding:l,visibility:0,texture:{sampleType:t.sampleType,viewDimension:s,multisampled:!1}}),this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][l]={name:e,index:c-1,nameInArrayOfTexture:t.isTextureArray?e+i:e}}l=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][l].index,this._webgpuProcessingContext.bindGroupLayoutEntries[a][l].visibility|=o?ul.Vertex:ul.Fragment}_addSamplerBindingDescription(e,t,i){let{groupIndex:s,bindingIndex:n}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[s]||(this._webgpuProcessingContext.bindGroupLayoutEntries[s]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][n]){const o=this._webgpuProcessingContext.bindGroupLayoutEntries[s].push({binding:n,visibility:0,sampler:{type:t.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][n]={name:e,index:o-1}}n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][n].index,this._webgpuProcessingContext.bindGroupLayoutEntries[s][n].visibility|=i?ul.Vertex:ul.Fragment}_addBufferBindingDescription(e,t,i,s){let{groupIndex:n,bindingIndex:o}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[n]||(this._webgpuProcessingContext.bindGroupLayoutEntries[n]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][o]){const a=this._webgpuProcessingContext.bindGroupLayoutEntries[n].push({binding:o,visibility:0,buffer:{type:i}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][o]={name:e,index:a-1}}o=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][o].index,this._webgpuProcessingContext.bindGroupLayoutEntries[n][o].visibility|=s?ul.Vertex:ul.Fragment}_injectStartingAndEndingCode(e,t,i,s){let n=e.indexOf(t);if(n<0)return console.error('No "main" function found in shader code! Processing aborted.'),e;if(i){for(;n++<e.length&&"{"!=e.charAt(n););if(n<e.length){const o=e.substring(0,n+1),a=e.substring(n+1);e=o+i+a}}if(s){const o=e.lastIndexOf("}");e=e.substring(0,o),e+=s+"\n}"}return e}}_i.AutoSamplerSuffix="Sampler",_i.LeftOvertUBOName="LeftOver",_i.InternalsUBOName="Internals",_i.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,vec3:3,ivec3:3,vec4:4,ivec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16},_i._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"},_i._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"},_i._GpuTextureViewDimensionByWebGPUTextureType={textureCube:Kt.Cube,textureCubeArray:Kt.CubeArray,texture2D:Kt.E2d,texture2DArray:Kt.E2dArray,texture3D:Kt.E3d},_i._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"},_i._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1};class Are{get isAsync(){return!1}get isReady(){return!!this.stages}constructor(e,t){this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t}_handlesSpectorRebuildCallback(){}_fillEffectInformation(e,t,i,s,n,o,a,l){const c=this.engine;e._fragmentSourceCode="",e._vertexSourceCode="";const h=this.shaderProcessingContext.availableTextures;let u;for(u=0;u<n.length;u++){const p=n[u],_=h[n[u]];null==_||null==_?(n.splice(u,1),u--):o[p]=u}for(const p of c.getAttributes(this,a))l.push(p);this.buildUniformLayout();const d=[],f=[];for(u=0;u<a.length;u++){const p=l[u];p>=0&&(d.push(a[u]),f.push(p))}this.shaderProcessingContext.attributeNamesFromEffect=d,this.shaderProcessingContext.attributeLocationsFromEffect=f}buildUniformLayout(){if(this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer=new Se(this.engine,void 0,void 0,"leftOver-"+this._name);for(const e of this.shaderProcessingContext.leftOverUniforms){const t=e.type.replace(/^(.*?)(<.*>)?$/,"$1");this.uniformBuffer.addUniform(e.name,_i.UniformSizes[t],e.length),this._leftOverUniformsByName[e.name]=e.type}this.uniformBuffer.create()}}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose()}setInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt(e,t)}setInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt2(e,t,i)}setInt3(e,t,i,s){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt3(e,t,i,s)}setInt4(e,t,i,s,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt4(e,t,i,s,n)}setIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateIntArray(e,t)}setIntArray2(e,t){this.setIntArray(e,t)}setIntArray3(e,t){this.setIntArray(e,t)}setIntArray4(e,t){this.setIntArray(e,t)}setUInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt(e,t)}setUInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt2(e,t,i)}setUInt3(e,t,i,s){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt3(e,t,i,s)}setUInt4(e,t,i,s,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt4(e,t,i,s,n)}setUIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUIntArray(e,t)}setUIntArray2(e,t){this.setUIntArray(e,t)}setUIntArray3(e,t){this.setUIntArray(e,t)}setUIntArray4(e,t){this.setUIntArray(e,t)}setArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateArray(e,t)}setArray2(e,t){this.setArray(e,t)}setArray3(e,t){this.setArray(e,t)}setArray4(e,t){this.setArray(e,t)}setMatrices(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrices(e,t)}setMatrix(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix(e,t)}setMatrix3x3(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix3x3(e,t)}setMatrix2x2(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix2x2(e,t)}setFloat(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat(e,t)}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setFloat2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat2(e,t,i)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setFloat3(e,t,i,s){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat3(e,t,i,s)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setFloat4(e,t,i,s,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat4(e,t,i,s,n)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){var e;return null===(e=this.sources)||void 0===e?void 0:e.vertex}_getFragmentShaderCode(){var e;return null===(e=this.sources)||void 0===e?void 0:e.fragment}}const gV={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4};let Np=(()=>{class r{static get KnownUBOs(){return r._SimplifiedKnownBindings?r._SimplifiedKnownUBOs:r._KnownUBOs}constructor(t){this.shaderLanguage=t,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],this._findStartingGroupBinding()}_findStartingGroupBinding(){const t=r.KnownUBOs,i=[];for(const s in t){const n=t[s].binding;-1!==n.groupIndex&&(i[n.groupIndex]=void 0===i[n.groupIndex]?n.bindingIndex:Math.max(i[n.groupIndex],n.bindingIndex))}this.freeGroupIndex=i.length-1,0===this.freeGroupIndex?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=i[i.length-1]+1}getAttributeNextLocation(t,i=0){var s;const n=this._attributeNextLocation;return this._attributeNextLocation+=(null!==(s=gV[t])&&void 0!==s?s:1)*(i||1),n}getVaryingNextLocation(t,i=0){var s;const n=this._varyingNextLocation;return this._varyingNextLocation+=(null!==(s=gV[t])&&void 0!==s?s:1)*(i||1),n}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(t){if(this.freeBindingIndex>65536-t&&(this.freeGroupIndex++,this.freeBindingIndex=0),4===this.freeGroupIndex)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";const i={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=t,i}}return r._SimplifiedKnownBindings=!0,r._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}},r._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}},r})();class Mre extends _i{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this._vertexIsGLES3=!1,this._fragmentIsGLES3=!1,this.shaderLanguage=ui.GLSL,this.parseGLES3=!0}_getArraySize(e,t,i){let s=0;const n=e.indexOf("["),o=e.indexOf("]");if(n>0&&o>0){const a=e.substring(n+1,o);s=+a,isNaN(s)&&(s=+i[a.trim()]),e=e.substr(0,n)}return[e,t,s]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0}preProcessShaderCode(e,t){const i=`// Internals UBO\r\nuniform ${_i.InternalsUBOName} {\nfloat yFactor_;\nfloat textureOutputHeight_;\n};\n`,s=-1!==e.indexOf("// Internals UBO");return t?(this._fragmentIsGLES3=-1!==e.indexOf("#version 3"),this._fragmentIsGLES3&&(this.varyingFragmentKeywordName="in"),s?e:i+"##INJECTCODE##\n"+e):(this._vertexIsGLES3=-1!==e.indexOf("#version 3"),this._vertexIsGLES3&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),s?e:i+e)}varyingProcessor(e,t,i){this._preProcessors=i;const l=(t&&this._fragmentIsGLES3?/\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:!t&&this._vertexIsGLES3?/\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==l){const c=l[1],h=l[2];let u;t?(u=this._webgpuProcessingContext.availableVaryings[h],this._missingVaryings[u]="",void 0===u&&V.Warn(`Invalid fragment shader: The varying named "${h}" is not declared in the vertex shader! This declaration will be ignored.`)):(u=this._webgpuProcessingContext.getVaryingNextLocation(c,this._getArraySize(h,c,i)[2]),this._webgpuProcessingContext.availableVaryings[h]=u,this._missingVaryings[u]=`layout(location = ${u}) in ${c} ${h};`),e=e.replace(l[0],void 0===u?"":`layout(location = ${u}) ${t?"in":"out"} ${c} ${h};`)}return e}attributeProcessor(e,t){this._preProcessors=t;const o=(this._vertexIsGLES3?/\s*in\s+(\S+)\s+(\S+)\s*;/gm:/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==o){const a=o[1],l=o[2],c=this._webgpuProcessingContext.getAttributeNextLocation(a,this._getArraySize(l,a,t)[2]);this._webgpuProcessingContext.availableAttributes[l]=c,this._webgpuProcessingContext.orderedAttributes[c]=l,e=e.replace(o[0],`layout(location = ${c}) in ${a} ${l};`)}return e}uniformProcessor(e,t,i){var s;this._preProcessors=i;const o=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(null!==o){let a=o[1],l=o[2];if(0===a.indexOf("sampler")||1===a.indexOf("sampler")){let c=0;[l,a,c]=this._getArraySize(l,a,i);let h=this._webgpuProcessingContext.availableTextures[l];if(!h){h={autoBindSampler:!0,isTextureArray:c>0,isStorageTexture:!1,textures:[],sampleType:tn.Float};for(let D=0;D<(c||1);++D)h.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}const u=null!==(s=_i._SamplerTypeByWebGLSamplerType[a])&&void 0!==s?s:"sampler",d=!!_i._IsComparisonSamplerByWebGPUSamplerType[u],f=d?fl.Comparison:fl.Filtering,p=l+_i.AutoSamplerSuffix;let _=this._webgpuProcessingContext.availableSamplers[p];_||(_={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:f});const m="u"===a.charAt(0)?"u":"i"===a.charAt(0)?"i":"";m&&(a=a.substr(1)),h.sampleType=d?tn.Depth:"u"===m?tn.Uint:"i"===m?tn.Sint:tn.Float;const y=_.binding.groupIndex,T=_.binding.bindingIndex,x=_i._SamplerFunctionByWebGLSamplerType[a],S=_i._TextureTypeByWebGLSamplerType[a],C=_i._GpuTextureViewDimensionByWebGPUTextureType[S];if(c>0){const D=[];D.push(`layout(set = ${y}, binding = ${T}) uniform ${m}${u} ${p};`),e="\r\n";for(let P=0;P<c;++P)D.push(`layout(set = ${h.textures[P].groupIndex}, binding = ${h.textures[P].bindingIndex}) uniform ${S} ${l}Texture${P};`),e+=`${P>0?"\r\n":""}#define ${l}${P} ${m}${x}(${l}Texture${P}, ${p})`;e=D.join("\r\n")+e,this._textureArrayProcessing.push(l)}else c=1,e=`layout(set = ${y}, binding = ${T}) uniform ${m}${u} ${p};\n                        layout(set = ${h.textures[0].groupIndex}, binding = ${h.textures[0].bindingIndex}) uniform ${S} ${l}Texture;\n                        #define ${l} ${m}${x}(${l}Texture, ${p})`;this._webgpuProcessingContext.availableTextures[l]=h,this._webgpuProcessingContext.availableSamplers[p]=_,this._addSamplerBindingDescription(p,_,!t);for(let D=0;D<c;++D)this._addTextureBindingDescription(l,h,D,C,null,!t)}else this._addUniformToLeftOverUBO(l,a,i),e=""}return e}uniformBufferProcessor(e,t){const s=/uniform\s+(\w+)/gm.exec(e);if(null!==s){const n=s[1];let o=this._webgpuProcessingContext.availableBuffers[n];if(!o){const a=Np.KnownUBOs[n];let l;l=a&&-1!==a.binding.groupIndex?a.binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),o={binding:l},this._webgpuProcessingContext.availableBuffers[n]=o}this._addBufferBindingDescription(n,o,dl.Uniform,!t),e=e.replace("uniform",`layout(set = ${o.binding.groupIndex}, binding = ${o.binding.bindingIndex}) uniform`)}return e}postProcessor(e,t,i,s,n){const o=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i){const l=e.indexOf("gl_FragCoord")>=0,c="\n                glFragCoord_ = gl_FragCoord;\n                if (yFactor_ == 1.) {\n                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;\n                }\n            ",h=l?"vec4 glFragCoord_;\n":"";if(e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/gl_FragCoord/g,"glFragCoord_"),this._fragmentIsGLES3){const u=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(e);null!==u&&(e=e.substring(0,u.index)+"layout(location = 0) "+e.substring(u.index))}else e=e.replace(/void\s+?main\s*\(/g,(o?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(");e=(e=e.replace(/dFdy/g,"(-yFactor_)*dFdy")).replace("##INJECTCODE##",h),l&&(e=this._injectStartingAndEndingCode(e,"void main",c))}else if(e=(e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex")).replace(/gl_VertexID/g,"gl_VertexIndex"),-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;if(!i){const l=e.lastIndexOf("}");e=e.substring(0,l),e+="gl_Position.y *= yFactor_;\n",n.isNDCHalfZRange||(e+="gl_Position.z = (gl_Position.z + gl_Position.w) / 2.0;\n"),e+="}"}return e}_applyTextureArrayProcessing(e,t){const i=new RegExp(t+"\\s*\\[(.+)?\\]","gm");let s=i.exec(e);for(;null!==s;){const n=s[1];let o=+n;this._preProcessors&&isNaN(o)&&(o=+this._preProcessors[n.trim()]),e=e.replace(s[0],t+o),s=i.exec(e)}return e}_generateLeftOverUBOCode(e,t){let i=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {\n    `;for(const s of this._webgpuProcessingContext.leftOverUniforms)i+=s.length>0?`    ${s.type} ${s.name}[${s.length}];\n`:`    ${s.type} ${s.name};\n`;return i+="};\n\n",i}finalizeShaders(e,t){for(let s=0;s<this._textureArrayProcessing.length;++s){const n=this._textureArrayProcessing[s];e=this._applyTextureArrayProcessing(e,n),t=this._applyTextureArrayProcessing(t,n)}for(let s=0;s<this._missingVaryings.length;++s){const n=this._missingVaryings[s];n&&n.length>0&&(t=n+"\n"+t)}const i=this._buildLeftOverUBO();return e=i+e,t=i+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,{vertexCode:e,fragmentCode:t}}}j.IncludesShadersStoreWGSL.bonesDeclaration="#if NUM_BONE_INFLUENCERS>0\nattribute matricesIndices : vec4<f32>;\nattribute matricesWeights : vec4<f32>;\n#if NUM_BONE_INFLUENCERS>4\nattribute matricesIndicesExtra : vec4<f32>;\nattribute matricesWeightsExtra : vec4<f32>;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nvar boneSampler : texture_2d<f32>;\nuniform boneTextureWidth : f32;\n#else\nuniform mBones : array<mat4x4,BonesPerMesh>;\n#ifdef BONES_VELOCITY_ENABLED\nuniform mPreviousBones : array<mat4x4,BonesPerMesh>;\n#endif\n#endif\n#ifdef BONETEXTURE\nfn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>\n{\nlet offset=i32(index) *4; \nlet m0=textureLoad(smp,vec2<i32>(offset+0,0),0);\nlet m1=textureLoad(smp,vec2<i32>(offset+1,0),0);\nlet m2=textureLoad(smp,vec2<i32>(offset+2,0),0);\nlet m3=textureLoad(smp,vec2<i32>(offset+3,0),0);\nreturn mat4x4<f32>(m0,m1,m2,m3);\n}\n#endif\n#endif\n#endif\n";j.IncludesShadersStoreWGSL.bonesVertex="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nvar influence : mat4x4<f32>;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];\n#endif \n#else \ninfluence=uniforms.mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+uniforms.mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+uniforms.mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+uniforms.mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence=influence+uniforms.mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+uniforms.mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+uniforms.mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+uniforms.mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif \n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n";j.IncludesShadersStoreWGSL.bakedVertexAnimationDeclaration="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform bakedVertexAnimationTime: f32;\nuniform bakedVertexAnimationTextureSizeInverted: vec2<f32>;\nuniform bakedVertexAnimationSettings: vec4<f32>;\nvar bakedVertexAnimationTexture : texture_2d<f32>;\n#ifdef INSTANCES\nattribute bakedVertexAnimationSettingsInstanced : vec4<f32>;\n#endif\nfn readMatrixFromRawSamplerVAT(smp : texture_2d<f32>,index : f32,frame : f32)->mat4x4<f32>\n{\nlet offset=i32(index)*4;\nlet frameUV=i32(frame);\nlet m0=textureLoad(smp,vec2<i32>(offset+0,frameUV),0);\nlet m1=textureLoad(smp,vec2<i32>(offset+1,frameUV),0);\nlet m2=textureLoad(smp,vec2<i32>(offset+2,frameUV),0);\nlet m3=textureLoad(smp,vec2<i32>(offset+3,frameUV),0);\nreturn mat4x4<f32>(m0,m1,m2,m3);\n}\n#endif\n";j.IncludesShadersStoreWGSL.bakedVertexAnimation="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\nlet VATStartFrame: f32=bakedVertexAnimationSettingsInstanced.x;\nlet VATEndFrame: f32=bakedVertexAnimationSettingsInstanced.y;\nlet VATOffsetFrame: f32=bakedVertexAnimationSettingsInstanced.z;\nlet VATSpeed: f32=bakedVertexAnimationSettingsInstanced.w;\n#else\nlet VATStartFrame: f32=uniforms.bakedVertexAnimationSettings.x;\nlet VATEndFrame: f32=uniforms.bakedVertexAnimationSettings.y;\nlet VATOffsetFrame: f32=uniforms.bakedVertexAnimationSettings.z;\nlet VATSpeed: f32=uniforms.bakedVertexAnimationSettings.w;\n#endif\nlet totalFrames: f32=VATEndFrame-VATStartFrame+1.0;\nlet time: f32=uniforms.bakedVertexAnimationTime*VATSpeed/totalFrames;\nlet frameCorrection: f32=select(1.0,0.0,time<1.0);\nlet numOfFrames: f32=totalFrames-frameCorrection;\nvar VATFrameNum: f32=fract(time)*numOfFrames;\nVATFrameNum=(VATFrameNum+VATOffsetFrame) % numOfFrames;\nVATFrameNum=floor(VATFrameNum);\nVATFrameNum=VATFrameNum+VATStartFrame+frameCorrection;\nvar VATInfluence : mat4x4<f32>;\nVATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;\n}\n#endif\n";j.IncludesShadersStoreWGSL.clipPlaneFragment="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fClipDistance>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE2\nelse if (fClipDistance2>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE3\nelse if (fClipDistance3>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE4\nelse if (fClipDistance4>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE5\nelse if (fClipDistance5>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE6\nelse if (fClipDistance6>0.0)\n{\ndiscard;\n}\n#endif\n";j.IncludesShadersStoreWGSL.clipPlaneFragmentDeclaration="#ifdef CLIPPLANE\nvarying fClipDistance: f32;\n#endif\n#ifdef CLIPPLANE2\nvarying fClipDistance2: f32;\n#endif\n#ifdef CLIPPLANE3\nvarying fClipDistance3: f32;\n#endif\n#ifdef CLIPPLANE4\nvarying fClipDistance4: f32;\n#endif\n#ifdef CLIPPLANE5\nvarying fClipDistance5: f32;\n#endif\n#ifdef CLIPPLANE6\nvarying fClipDistance6: f32;\n#endif\n";j.IncludesShadersStoreWGSL.clipPlaneVertex="#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,uniforms.vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nfClipDistance2=dot(worldPos,uniforms.vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nfClipDistance3=dot(worldPos,uniforms.vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nfClipDistance4=dot(worldPos,uniforms.vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nfClipDistance5=dot(worldPos,uniforms.vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nfClipDistance6=dot(worldPos,uniforms.vClipPlane6);\n#endif\n";j.IncludesShadersStoreWGSL.clipPlaneVertexDeclaration="#ifdef CLIPPLANE\nuniform vClipPlane: vec4<f32>;\nvarying fClipDistance: f32;\n#endif\n#ifdef CLIPPLANE2\nuniform vClipPlane2: vec4<f32>;\nvarying fClipDistance2: f32;\n#endif\n#ifdef CLIPPLANE3\nuniform vClipPlane3: vec4<f32>;\nvarying fClipDistance3: f32;\n#endif\n#ifdef CLIPPLANE4\nuniform vClipPlane4: vec4<f32>;\nvarying fClipDistance4: f32;\n#endif\n#ifdef CLIPPLANE5\nuniform vClipPlane5: vec4<f32>;\nvarying fClipDistance5: f32;\n#endif\n#ifdef CLIPPLANE6\nuniform vClipPlane6: vec4<f32>;\nvarying fClipDistance6: f32;\n#endif\n";j.IncludesShadersStoreWGSL.instancesDeclaration="#ifdef INSTANCES\nattribute world0 : vec4<f32>;\nattribute world1 : vec4<f32>;\nattribute world2 : vec4<f32>;\nattribute world3 : vec4<f32>;\n#ifdef INSTANCESCOLOR\nattribute instanceColor : vec4<f32>;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nattribute previousWorld0 : vec4<f32>;\nattribute previousWorld1 : vec4<f32>;\nattribute previousWorld2 : vec4<f32>;\nattribute previousWorld3 : vec4<f32>;\n#ifdef THIN_INSTANCES\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n";j.IncludesShadersStoreWGSL.instancesVertex="#ifdef INSTANCES\nvar finalWorld=mat4x4<f32>(world0,world1,world2,world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nvar finalPreviousWorld=mat4x4<f32>(previousWorld0,previousWorld1,previousWorld2,previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\n#if !defined(WORLD_UBO)\nfinalWorld=uniforms.world*finalWorld;\n#else\nfinalWorld=mesh.world*finalWorld;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nfinalPreviousWorld=previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nvar finalWorld=uniforms.world;\n#else\nvar finalWorld=mesh.world;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nvar finalPreviousWorld=previousWorld;\n#endif\n#endif\n";j.IncludesShadersStoreWGSL.meshUboDeclaration="struct Mesh {\nworld : mat4x4<f32>,\nvisibility : f32,\n};\nvar<uniform> mesh : Mesh;\n#define WORLD_UBO\n";j.IncludesShadersStoreWGSL.morphTargetsVertex="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE \nvertexID=f32(gl_VertexID)*uniforms.morphTargetTextureInfo.x;\npositionUpdated=positionUpdated+(readVector3FromRawSampler({X},vertexID)-position)*uniforms.morphTargetInfluences[{X}];\nvertexID=vertexID+1.0;\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated=normalUpdated+(readVector3FromRawSampler({X},vertexID) -normal)*uniforms.morphTargetInfluences[{X}];\nvertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated=uvUpdated+(readVector3FromRawSampler({X},vertexID).xy-uv)*uniforms.morphTargetInfluences[{X}];\nvertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz=tangentUpdated.xyz+(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*uniforms.morphTargetInfluences[{X}];\n#endif\n#else\npositionUpdated=positionUpdated+(position{X}-position)*uniforms.morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-normal)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz=tangentUpdated.xyz+(tangent{X}-tangent.xyz)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated=uvUpdated+(uv_{X}-uv)*uniforms.morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n";j.IncludesShadersStoreWGSL.morphTargetsVertexDeclaration="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\nattribute position{X} : vec3<f32>;\n#ifdef MORPHTARGETS_NORMAL\nattribute normal{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute tangent{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_UV\nattribute uv_{X} : vec2<f32>;\n#endif\n#endif\n#endif\n";j.IncludesShadersStoreWGSL.morphTargetsVertexGlobal="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nvar vertexID : f32;\n#endif\n#endif\n";j.IncludesShadersStoreWGSL.morphTargetsVertexGlobalDeclaration="#ifdef MORPHTARGETS\nuniform morphTargetInfluences : array<f32,NUM_MORPH_INFLUENCERS>;\n#ifdef MORPHTARGETS_TEXTURE \nuniform morphTargetTextureIndices : array<f32,NUM_MORPH_INFLUENCERS>;\nuniform morphTargetTextureInfo : vec3<f32>;\nvar morphTargets : texture_2d_array<f32>;\nvar morphTargetsSampler : sampler;\nfn readVector3FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec3<f32>\n{ \nlet y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);\nlet x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;\nlet textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);\nreturn textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0).xyz;\n}\n#endif\n#endif\n";j.IncludesShadersStoreWGSL.sceneUboDeclaration="struct Scene {\nviewProjection : mat4x4<f32>,\n#ifdef MULTIVIEW\nviewProjectionR : mat4x4<f32>,\n#endif \nview : mat4x4<f32>,\nprojection : mat4x4<f32>,\nvEyePosition : vec4<f32>,\n};\nvar<uniform> scene : Scene;\n";const KV="gl_VertexID",QV="gl_InstanceID",ZV="gl_Position",JV="gl_FragCoord",eU="gl_FrontFacing",Gv="gl_FragDepth",tU="gl_FragColor",wre={texture_1d:Kt.E1d,texture_2d:Kt.E2d,texture_2d_array:Kt.E2dArray,texture_3d:Kt.E3d,texture_cube:Kt.Cube,texture_cube_array:Kt.CubeArray,texture_multisampled_2d:Kt.E2d,texture_depth_2d:Kt.E2d,texture_depth_2d_array:Kt.E2dArray,texture_depth_cube:Kt.Cube,texture_depth_cube_array:Kt.CubeArray,texture_depth_multisampled_2d:Kt.E2d,texture_storage_1d:Kt.E1d,texture_storage_2d:Kt.E2d,texture_storage_2d_array:Kt.E2dArray,texture_storage_3d:Kt.E3d,texture_external:null};class Ore extends _i{constructor(){super(...arguments),this.shaderLanguage=ui.WGSL,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0}_getArraySize(e,t,i){let s=0;const n=t.lastIndexOf(">");if(t.indexOf("array")>=0&&n>0){let o=n;for(;o>0&&" "!==t.charAt(o)&&","!==t.charAt(o);)o--;const a=t.substring(o+1,n);for(s=+a,isNaN(s)&&(s=+i[a.trim()]);o>0&&(" "===t.charAt(o)||","===t.charAt(o));)o--;t=t.substring(t.indexOf("<")+1,o+1)}return[e,t,s]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesWGSL=[],this._attributesDeclWGSL=[],this._attributeNamesWGSL=[],this._varyingsWGSL=[],this._varyingsDeclWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]}preProcessShaderCode(e){return`struct ${_i.InternalsUBOName} {\nyFactor_: f32,\ntextureOutputHeight_: f32,\n};\nvar<uniform> internals : ${_i.InternalsUBOName};\n`+dC(e)}varyingProcessor(e,t,i){const n=/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==n){const o=n[2],a=n[1];let l;t?(l=this._webgpuProcessingContext.availableVaryings[a],void 0===l&&V.Warn(`Invalid fragment shader: The varying named "${a}" is not declared in the vertex shader! This declaration will be ignored.`)):(l=this._webgpuProcessingContext.getVaryingNextLocation(o,this._getArraySize(a,o,i)[2]),this._webgpuProcessingContext.availableVaryings[a]=l,this._varyingsWGSL.push(`@location(${l}) ${a} : ${o},`),this._varyingsDeclWGSL.push(`var<private> ${a} : ${o};`),this._varyingNamesWGSL.push(a)),e=""}return e}attributeProcessor(e,t){const s=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==s){const n=s[2],o=s[1],a=this._webgpuProcessingContext.getAttributeNextLocation(n,this._getArraySize(o,n,t)[2]);this._webgpuProcessingContext.availableAttributes[o]=a,this._webgpuProcessingContext.orderedAttributes[a]=o,this._attributesWGSL.push(`@location(${a}) ${o} : ${n},`),this._attributesDeclWGSL.push(`var<private> ${o} : ${n};`),this._attributeNamesWGSL.push(o),e=""}return e}uniformProcessor(e,t,i){const s=this.uniformRegexp.exec(e);return null!==s&&(this._addUniformToLeftOverUBO(s[1],s[2],i),e=""),e}textureProcessor(e,t,i){const s=this.textureRegexp.exec(e);if(null!==s){const n=s[1],o=s[2],a=!!s[3],l=s[4],c=l.indexOf("storage")>0,h=s[6],u=c?h.substring(0,h.indexOf(",")).trim():null;let d=a?this._getArraySize(n,o,i)[2]:0,f=this._webgpuProcessingContext.availableTextures[n];if(f)d=f.textures.length;else{f={isTextureArray:d>0,isStorageTexture:c,textures:[],sampleType:tn.Float},d=d||1;for(let g=0;g<d;++g)f.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[n]=f;const p=l.indexOf("depth")>0,_=wre[l];if(f.sampleType=p?tn.Depth:"u32"===h?tn.Uint:"i32"===h?tn.Sint:tn.Float,void 0===_)throw`Can't get the texture dimension corresponding to the texture function "${l}"!`;for(let g=0;g<d;++g){const{groupIndex:b,bindingIndex:y}=f.textures[g];0===g&&(e=`@group(${b}) @binding(${y}) ${e}`),this._addTextureBindingDescription(n,f,g,_,u,!t)}}return e}postProcessor(e){return e}finalizeShaders(e,t){const i=t.indexOf("gl_FragCoord")>=0?"\n            if (internals.yFactor_ == 1.) {\n                gl_FragCoord.y = internals.textureOutputHeight_ - gl_FragCoord.y;\n            }\n        ":"";e=this._processSamplers(e,!0),t=this._processSamplers(t,!1),e=this._processCustomBuffers(e,!0),t=this._processCustomBuffers(t,!1);const s=this._buildLeftOverUBO();t=s+t,e=(e=s+e).replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);const n=this._varyingsDeclWGSL.join("\n")+"\n",o=`var<private> ${KV} : u32;\nvar<private> ${QV} : u32;\nvar<private> ${ZV} : vec4<f32>;\n`,a=this._attributesDeclWGSL.join("\n")+"\n";let l="struct VertexInputs {\n  @builtin(vertex_index) vertexIndex : u32,\n  @builtin(instance_index) instanceIndex : u32,\n";this._attributesWGSL.length>0&&(l+=this._attributesWGSL.join("\n")),l+="\n};\n";let c="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n";this._varyingsWGSL.length>0&&(c+=this._varyingsWGSL.join("\n")),c+="\n};\n",e=o+l+a+c+n+e;let h=`  var output : FragmentInputs;\n  ${KV} = input.vertexIndex;\n  ${QV} = input.instanceIndex;\n`;for(let y=0;y<this._attributeNamesWGSL.length;++y){const T=this._attributeNamesWGSL[y];h+=`  ${T} = input.${T};\n`}let u=`  output.position = ${ZV};\n  output.position.y = output.position.y * internals.yFactor_;\n`;for(let y=0;y<this._varyingNamesWGSL.length;++y){const T=this._varyingNamesWGSL[y];u+=`  output.${T} = ${T};\n`}u+="  return output;",e=this._injectStartingAndEndingCode(e,"fn main",h,u),t=t.replace(/#define /g,"//#define "),t=(t=this._processStridedUniformArrays(t)).replace(/dpdy/g,"(-internals.yFactor_)*dpdy");const d=`var<private> ${JV} : vec4<f32>;\nvar<private> ${eU} : bool;\nvar<private> ${tU} : vec4<f32>;\nvar<private> ${Gv} : f32;\n`;let f="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n  @builtin(front_facing) frontFacing : bool,\n";this._varyingsWGSL.length>0&&(f+=this._varyingsWGSL.join("\n")),f+="\n};\n";let p="struct FragmentOutputs {\n  @location(0) color : vec4<f32>,\n",_=!1,m=0;for(;!(_||(m=t.indexOf(Gv,m),m<0));){const y=m;for(_=!0;m>1&&"\n"!==t.charAt(m);){if("/"===t.charAt(m)&&"/"===t.charAt(m-1)){_=!1;break}m--}m=y+Gv.length}_&&(p+="  @builtin(frag_depth) fragDepth: f32,\n"),p+="};\n",t=d+f+n+p+t;let g=`  var output : FragmentOutputs;\n  ${JV} = input.position;\n  ${eU} = input.frontFacing;\n`+i;for(let y=0;y<this._varyingNamesWGSL.length;++y){const T=this._varyingNamesWGSL[y];g+=`  ${T} = input.${T};\n`}let b=`  output.color = ${tU};\n`;return _&&(b+=`  output.fragDepth = ${Gv};\n`),b+="  return output;",t=this._injectStartingAndEndingCode(t,"fn main",g,b),this._collectBindingNames(),this._preCreateBindGroupEntries(),{vertexCode:e,fragmentCode:t}}_generateLeftOverUBOCode(e,t){let i="",s=`struct ${e} {\n`;for(const n of this._webgpuProcessingContext.leftOverUniforms){const o=n.type.replace(/^(.*?)(<.*>)?$/,"$1"),a=_i.UniformSizes[o];if(n.length>0)if(a<=2){const l=`${e}_${this._stridedUniformArrays.length}_strided_arr`;i+=`struct ${l} {\n                        @size(16)\n                        el: ${o},\n                    }`,this._stridedUniformArrays.push(n.name),s+=` @align(16) ${n.name} : array<${l}, ${n.length}>,\n`}else s+=` ${n.name} : array<${n.type}, ${n.length}>,\n`;else s+=`  ${n.name} : ${n.type},\n`}return s+="};\n",s=`${i}\n${s}`,s+=`@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> uniforms : ${e};\n`,s}_processSamplers(e,t){const i=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){const s=i.exec(e);if(null===s)break;const n=s[1],o=s[2],a=n.indexOf(_i.AutoSamplerSuffix)===n.length-_i.AutoSamplerSuffix.length?n.substring(0,n.indexOf(_i.AutoSamplerSuffix)):null,l="sampler_comparison"===o?fl.Comparison:fl.Filtering;if(a){const f=this._webgpuProcessingContext.availableTextures[a];f&&(f.autoBindSampler=!0)}let c=this._webgpuProcessingContext.availableSamplers[n];c||(c={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:l},this._webgpuProcessingContext.availableSamplers[n]=c),this._addSamplerBindingDescription(n,c,t);const h=e.substring(0,s.index),u=`@group(${c.binding.groupIndex}) @binding(${c.binding.bindingIndex}) `,d=e.substring(s.index);e=h+u+d,i.lastIndex+=u.length}return e}_processCustomBuffers(e,t){const i=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){const s=i.exec(e);if(null===s)break;const n=s[1],o=s[3];let a=s[4];const l=s[5];let c=this._webgpuProcessingContext.availableBuffers[a];if(!c){const _="uniform"===n?Np.KnownUBOs[l]:null;let m;_?(a=l,m=_.binding,-1===m.groupIndex&&(m=this._webgpuProcessingContext.getNextFreeUBOBinding())):m=this._webgpuProcessingContext.getNextFreeUBOBinding(),c={binding:m},this._webgpuProcessingContext.availableBuffers[a]=c}this._addBufferBindingDescription(a,this._webgpuProcessingContext.availableBuffers[a],"read_write"===o?dl.Storage:"storage"===n?dl.ReadOnlyStorage:dl.Uniform,t);const h=c.binding.groupIndex,u=c.binding.bindingIndex,d=e.substring(0,s.index),f=`@group(${h}) @binding(${u}) `,p=e.substring(s.index);e=d+f+p,i.lastIndex+=f.length}return e}_processStridedUniformArrays(e){for(const t of this._stridedUniformArrays)e=e.replace(new RegExp(`${t}\\s*\\[(.*)\\]`,"g"),`${t}[$1].el`);return e}}class zv{get underlyingResource(){return this._webgpuTexture}get msaaTexture(){return this._webgpuMSAATexture}set msaaTexture(e){this._webgpuMSAATexture=e}constructor(e=null){this.format=N.RGBA8Unorm,this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=e,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}set(e){this._webgpuTexture=e}setUsage(e,t,i,s,n){this.createView({format:this.format,dimension:i?Kt.Cube:Kt.E2d,mipLevelCount:(t=e!==Ye.RenderTarget&&t)?oe.ILog2(Math.max(s,n))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:i?6:1,aspect:hl.All})}createView(e,t=!1){if(this.view=this._webgpuTexture.createView(e),t&&e){const i=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=i}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}release(){var e,t,i;null===(e=this._webgpuTexture)||void 0===e||e.destroy(),null===(t=this._webgpuMSAATexture)||void 0===t||t.destroy(),null===(i=this._copyInvertYTempTexture)||void 0===i||i.destroy(),this.reset()}}var Yn=(()=>{return(r=Yn||(Yn={}))[r.MipMap=0]="MipMap",r[r.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",r[r.Clear=2]="Clear",r[r.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst",Yn;var r})(),yh=(()=>{return(r=yh||(yh={}))[r.DontInvertY=0]="DontInvertY",r[r.InvertY=1]="InvertY",yh;var r})();const sU=[{vertex:"\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n\n    layout(location = 0) out vec2 vTex;\n\n    void main() {\n        vTex = tex[gl_VertexIndex];\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    layout(set = 0, binding = 0) uniform sampler imgSampler;\n    layout(set = 0, binding = 1) uniform texture2D img;\n\n    layout(location = 0) in vec2 vTex;\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        outColor = texture(sampler2D(img, imgSampler), vTex);\n    }\n    "},{vertex:"\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n\n    #ifdef INVERTY\n        layout(location = 0) out flat ivec2 vTextureSize;\n    #endif\n\n    void main() {\n        #ifdef INVERTY\n            vTextureSize = textureSize(img, 0);\n        #endif\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n\n    #ifdef INVERTY\n        layout(location = 0) in flat ivec2 vTextureSize;\n    #endif\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n    #ifdef INVERTY\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, vTextureSize.y - gl_FragCoord.y), 0);\n    #else\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color.rgb *= color.a;\n    #endif\n        outColor = color;\n    }\n    "},{vertex:"\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n\n    void main() {\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    layout(set = 0, binding = 0) uniform Uniforms {\n        uniform vec4 color;\n    };\n\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        outColor = color;\n    }\n    "},{vertex:"\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n\n    #ifdef INVERTY\n        layout(location = 0) out flat ivec2 vTextureSize;\n    #endif\n\n    void main() {\n        #ifdef INVERTY\n            vTextureSize = textureSize(img, 0);\n        #endif\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n    layout(set = 0, binding = 1) uniform Params {\n        float ofstX;\n        float ofstY;\n        float width;\n        float height;\n    };\n\n    #ifdef INVERTY\n        layout(location = 0) in flat ivec2 vTextureSize;\n    #endif\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        if (gl_FragCoord.x < ofstX || gl_FragCoord.x >= ofstX + width) {\n            discard;\n        }\n        if (gl_FragCoord.y < ofstY || gl_FragCoord.y >= ofstY + height) {\n            discard;\n        }\n    #ifdef INVERTY\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, ofstY + height - (gl_FragCoord.y - ofstY)), 0);\n    #else\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color.rgb *= color.a;\n    #endif\n        outColor = color;\n    }\n    "}],Fp={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2unorm:22,rg32uint:23,rg32sint:24,rg32float:25,rgba16uint:26,rgba16sint:27,rgba16float:28,rgba32uint:29,rgba32sint:30,rgba32float:31,stencil8:32,depth16unorm:33,depth24plus:34,"depth24plus-stencil8":35,depth32float:36,"depth24unorm-stencil8":37,"depth32float-stencil8":38};class vi{static ComputeNumMipmapLevels(e,t){return oe.ILog2(Math.max(e,t))+1}constructor(e,t,i,s){this._pipelines={},this._compiledShaders=[],this._videoPipelines={},this._videoCompiledShaders=[],this._deferredReleaseTextures=[],this._device=e,this._glslang=t,this._tintWASM=i,this._bufferManager=s,this._mipmapSampler=e.createSampler({minFilter:mt.Linear}),this._videoSampler=e.createSampler({minFilter:mt.Linear}),this._ubCopyWithOfst=this._bufferManager.createBuffer(16,ei.Uniform|ei.CopyDst).underlyingResource,this._getPipeline(N.RGBA8Unorm),this._getVideoPipeline(N.RGBA8Unorm)}_getPipeline(e,t=Yn.MipMap,i){const s=t===Yn.MipMap?1:t===Yn.InvertYPremultiplyAlpha?((i.invertY?1:0)<<1)+((i.premultiplyAlpha?1:0)<<2):t===Yn.Clear?8:t===Yn.InvertYPremultiplyAlphaWithOfst?((i.invertY?1:0)<<4)+((i.premultiplyAlpha?1:0)<<5):0;this._pipelines[e]||(this._pipelines[e]=[]);let n=this._pipelines[e][s];if(!n){let o="#version 450\r\n";(t===Yn.InvertYPremultiplyAlpha||t===Yn.InvertYPremultiplyAlphaWithOfst)&&(i.invertY&&(o+="#define INVERTY\r\n"),i.premultiplyAlpha&&(o+="#define PREMULTIPLYALPHA\r\n"));let a=this._compiledShaders[s];if(!a){let c=this._glslang.compileGLSL(o+sU[t].vertex,"vertex"),h=this._glslang.compileGLSL(o+sU[t].fragment,"fragment");this._tintWASM&&(c=this._tintWASM.convertSpirV2WGSL(c),h=this._tintWASM.convertSpirV2WGSL(h));const u=this._device.createShaderModule({code:c}),d=this._device.createShaderModule({code:h});a=this._compiledShaders[s]=[u,d]}const l=this._device.createRenderPipeline({layout:Zu.Auto,vertex:{module:a[0],entryPoint:"main"},fragment:{module:a[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:sn.TriangleStrip,stripIndexFormat:_l.Uint16}});n=this._pipelines[e][s]=[l,l.getBindGroupLayout(0)]}return n}_getVideoPipeline(e,t=yh.DontInvertY){const i=t===yh.InvertY?1:0;this._videoPipelines[e]||(this._videoPipelines[e]=[]);let s=this._videoPipelines[e][i];if(!s){let n=this._videoCompiledShaders[i];if(!n){const a=this._device.createShaderModule({code:"\n    struct VertexOutput {\n        @builtin(position) Position : vec4<f32>,\n        @location(0) fragUV : vec2<f32>\n    }\n  \n    @vertex\n    fn main(\n        @builtin(vertex_index) VertexIndex : u32\n    ) -> VertexOutput {\n        var pos = array<vec2<f32>, 4>(\n            vec2(-1.0,  1.0),\n            vec2( 1.0,  1.0),\n            vec2(-1.0, -1.0),\n            vec2( 1.0, -1.0)\n        );\n        var tex = array<vec2<f32>, 4>(\n            vec2(0.0, 0.0),\n            vec2(1.0, 0.0),\n            vec2(0.0, 1.0),\n            vec2(1.0, 1.0)\n        );\n\n        var output: VertexOutput;\n\n        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n        output.fragUV = tex[VertexIndex];\n\n        return output;\n    }\n    "}),l=this._device.createShaderModule({code:0===i?"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);\n    }\n    ":"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));\n    }\n    "});n=this._videoCompiledShaders[i]=[a,l]}const o=this._device.createRenderPipeline({label:`CopyVideoToTexture_${e}_${0===i?"DontInvertY":"InvertY"}`,layout:Zu.Auto,vertex:{module:n[0],entryPoint:"main"},fragment:{module:n[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:sn.TriangleStrip,stripIndexFormat:_l.Uint16}});s=this._videoPipelines[e][i]=[o,o.getBindGroupLayout(0)]}return s}static _GetTextureTypeFromFormat(e){switch(e){case N.R8Unorm:case N.R8Snorm:case N.R8Uint:case N.R8Sint:case N.RG8Unorm:case N.RG8Snorm:case N.RG8Uint:case N.RG8Sint:case N.RGBA8Unorm:case N.RGBA8UnormSRGB:case N.RGBA8Snorm:case N.RGBA8Uint:case N.RGBA8Sint:case N.BGRA8Unorm:case N.BGRA8UnormSRGB:case N.RGB10A2Unorm:case N.RGB9E5UFloat:case N.RG11B10UFloat:case N.Depth24UnormStencil8:case N.Depth32FloatStencil8:case N.BC7RGBAUnorm:case N.BC7RGBAUnormSRGB:case N.BC6HRGBUFloat:case N.BC6HRGBFloat:case N.BC5RGUnorm:case N.BC5RGSnorm:case N.BC3RGBAUnorm:case N.BC3RGBAUnormSRGB:case N.BC2RGBAUnorm:case N.BC2RGBAUnormSRGB:case N.BC4RUnorm:case N.BC4RSnorm:case N.BC1RGBAUnorm:case N.BC1RGBAUnormSRGB:case N.ETC2RGB8Unorm:case N.ETC2RGB8UnormSRGB:case N.ETC2RGB8A1Unorm:case N.ETC2RGB8A1UnormSRGB:case N.ETC2RGBA8Unorm:case N.ETC2RGBA8UnormSRGB:case N.EACR11Unorm:case N.EACR11Snorm:case N.EACRG11Unorm:case N.EACRG11Snorm:case N.ASTC4x4Unorm:case N.ASTC4x4UnormSRGB:case N.ASTC5x4Unorm:case N.ASTC5x4UnormSRGB:case N.ASTC5x5Unorm:case N.ASTC5x5UnormSRGB:case N.ASTC6x5Unorm:case N.ASTC6x5UnormSRGB:case N.ASTC6x6Unorm:case N.ASTC6x6UnormSRGB:case N.ASTC8x5Unorm:case N.ASTC8x5UnormSRGB:case N.ASTC8x6Unorm:case N.ASTC8x6UnormSRGB:case N.ASTC8x8Unorm:case N.ASTC8x8UnormSRGB:case N.ASTC10x5Unorm:case N.ASTC10x5UnormSRGB:case N.ASTC10x6Unorm:case N.ASTC10x6UnormSRGB:case N.ASTC10x8Unorm:case N.ASTC10x8UnormSRGB:case N.ASTC10x10Unorm:case N.ASTC10x10UnormSRGB:case N.ASTC12x10Unorm:case N.ASTC12x10UnormSRGB:case N.ASTC12x12Unorm:case N.ASTC12x12UnormSRGB:return 0;case N.R16Uint:case N.R16Sint:case N.RG16Uint:case N.RG16Sint:case N.RGBA16Uint:case N.RGBA16Sint:case N.Depth16Unorm:return 5;case N.R16Float:case N.RG16Float:case N.RGBA16Float:return 2;case N.R32Uint:case N.R32Sint:case N.RG32Uint:case N.RG32Sint:case N.RGBA32Uint:case N.RGBA32Sint:return 7;case N.R32Float:case N.RG32Float:case N.RGBA32Float:case N.Depth32Float:return 1;case N.Stencil8:throw"No fixed size for Stencil8 format!";case N.Depth24Plus:throw"No fixed size for Depth24Plus format!";case N.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!"}return 0}static _GetBlockInformationFromFormat(e){switch(e){case N.R8Unorm:case N.R8Snorm:case N.R8Uint:case N.R8Sint:return{width:1,height:1,length:1};case N.R16Uint:case N.R16Sint:case N.R16Float:case N.RG8Unorm:case N.RG8Snorm:case N.RG8Uint:case N.RG8Sint:return{width:1,height:1,length:2};case N.R32Uint:case N.R32Sint:case N.R32Float:case N.RG16Uint:case N.RG16Sint:case N.RG16Float:case N.RGBA8Unorm:case N.RGBA8UnormSRGB:case N.RGBA8Snorm:case N.RGBA8Uint:case N.RGBA8Sint:case N.BGRA8Unorm:case N.BGRA8UnormSRGB:case N.RGB9E5UFloat:case N.RGB10A2Unorm:case N.RG11B10UFloat:return{width:1,height:1,length:4};case N.RG32Uint:case N.RG32Sint:case N.RG32Float:case N.RGBA16Uint:case N.RGBA16Sint:case N.RGBA16Float:return{width:1,height:1,length:8};case N.RGBA32Uint:case N.RGBA32Sint:case N.RGBA32Float:return{width:1,height:1,length:16};case N.Stencil8:throw"No fixed size for Stencil8 format!";case N.Depth16Unorm:return{width:1,height:1,length:2};case N.Depth24Plus:throw"No fixed size for Depth24Plus format!";case N.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!";case N.Depth32Float:case N.Depth24UnormStencil8:return{width:1,height:1,length:4};case N.Depth32FloatStencil8:return{width:1,height:1,length:5};case N.BC7RGBAUnorm:case N.BC7RGBAUnormSRGB:case N.BC6HRGBUFloat:case N.BC6HRGBFloat:case N.BC5RGUnorm:case N.BC5RGSnorm:case N.BC3RGBAUnorm:case N.BC3RGBAUnormSRGB:case N.BC2RGBAUnorm:case N.BC2RGBAUnormSRGB:return{width:4,height:4,length:16};case N.BC4RUnorm:case N.BC4RSnorm:case N.BC1RGBAUnorm:case N.BC1RGBAUnormSRGB:case N.ETC2RGB8Unorm:case N.ETC2RGB8UnormSRGB:case N.ETC2RGB8A1Unorm:case N.ETC2RGB8A1UnormSRGB:case N.EACR11Unorm:case N.EACR11Snorm:return{width:4,height:4,length:8};case N.ETC2RGBA8Unorm:case N.ETC2RGBA8UnormSRGB:case N.EACRG11Unorm:case N.EACRG11Snorm:case N.ASTC4x4Unorm:case N.ASTC4x4UnormSRGB:return{width:4,height:4,length:16};case N.ASTC5x4Unorm:case N.ASTC5x4UnormSRGB:return{width:5,height:4,length:16};case N.ASTC5x5Unorm:case N.ASTC5x5UnormSRGB:return{width:5,height:5,length:16};case N.ASTC6x5Unorm:case N.ASTC6x5UnormSRGB:return{width:6,height:5,length:16};case N.ASTC6x6Unorm:case N.ASTC6x6UnormSRGB:return{width:6,height:6,length:16};case N.ASTC8x5Unorm:case N.ASTC8x5UnormSRGB:return{width:8,height:5,length:16};case N.ASTC8x6Unorm:case N.ASTC8x6UnormSRGB:return{width:8,height:6,length:16};case N.ASTC8x8Unorm:case N.ASTC8x8UnormSRGB:return{width:8,height:8,length:16};case N.ASTC10x5Unorm:case N.ASTC10x5UnormSRGB:return{width:10,height:5,length:16};case N.ASTC10x6Unorm:case N.ASTC10x6UnormSRGB:return{width:10,height:6,length:16};case N.ASTC10x8Unorm:case N.ASTC10x8UnormSRGB:return{width:10,height:8,length:16};case N.ASTC10x10Unorm:case N.ASTC10x10UnormSRGB:return{width:10,height:10,length:16};case N.ASTC12x10Unorm:case N.ASTC12x10UnormSRGB:return{width:12,height:10,length:16};case N.ASTC12x12Unorm:case N.ASTC12x12UnormSRGB:return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static _IsHardwareTexture(e){return!!e.release}static _IsInternalTexture(e){return!!e.dispose}static IsImageBitmap(e){return void 0!==e.close}static IsImageBitmapArray(e){return Array.isArray(e)&&void 0!==e[0].close}setCommandEncoder(e){this._commandEncoderForCreation=e}static IsCompressedFormat(e){switch(e){case N.BC7RGBAUnormSRGB:case N.BC7RGBAUnorm:case N.BC6HRGBFloat:case N.BC6HRGBUFloat:case N.BC5RGSnorm:case N.BC5RGUnorm:case N.BC4RSnorm:case N.BC4RUnorm:case N.BC3RGBAUnormSRGB:case N.BC3RGBAUnorm:case N.BC2RGBAUnormSRGB:case N.BC2RGBAUnorm:case N.BC1RGBAUnormSRGB:case N.BC1RGBAUnorm:case N.ETC2RGB8Unorm:case N.ETC2RGB8UnormSRGB:case N.ETC2RGB8A1Unorm:case N.ETC2RGB8A1UnormSRGB:case N.ETC2RGBA8Unorm:case N.ETC2RGBA8UnormSRGB:case N.EACR11Unorm:case N.EACR11Snorm:case N.EACRG11Unorm:case N.EACRG11Snorm:case N.ASTC4x4Unorm:case N.ASTC4x4UnormSRGB:case N.ASTC5x4Unorm:case N.ASTC5x4UnormSRGB:case N.ASTC5x5Unorm:case N.ASTC5x5UnormSRGB:case N.ASTC6x5Unorm:case N.ASTC6x5UnormSRGB:case N.ASTC6x6Unorm:case N.ASTC6x6UnormSRGB:case N.ASTC8x5Unorm:case N.ASTC8x5UnormSRGB:case N.ASTC8x6Unorm:case N.ASTC8x6UnormSRGB:case N.ASTC8x8Unorm:case N.ASTC8x8UnormSRGB:case N.ASTC10x5Unorm:case N.ASTC10x5UnormSRGB:case N.ASTC10x6Unorm:case N.ASTC10x6UnormSRGB:case N.ASTC10x8Unorm:case N.ASTC10x8UnormSRGB:case N.ASTC10x10Unorm:case N.ASTC10x10UnormSRGB:case N.ASTC12x10Unorm:case N.ASTC12x10UnormSRGB:case N.ASTC12x12Unorm:case N.ASTC12x12UnormSRGB:return!0}return!1}static GetWebGPUTextureFormat(e,t,i=!1){switch(t){case 15:return N.Depth16Unorm;case 16:return N.Depth24Plus;case 13:return N.Depth24PlusStencil8;case 14:return N.Depth32Float;case 17:return N.Depth24UnormStencil8;case 18:return N.Depth32FloatStencil8;case 36492:return i?N.BC7RGBAUnormSRGB:N.BC7RGBAUnorm;case 36495:return N.BC6HRGBUFloat;case 36494:return N.BC6HRGBFloat;case 33779:return i?N.BC3RGBAUnormSRGB:N.BC3RGBAUnorm;case 33778:return i?N.BC2RGBAUnormSRGB:N.BC2RGBAUnorm;case 33777:case 33776:return i?N.BC1RGBAUnormSRGB:N.BC1RGBAUnorm;case 37808:return i?N.ASTC4x4UnormSRGB:N.ASTC4x4Unorm;case 36196:case 37492:return i?N.ETC2RGB8UnormSRGB:N.ETC2RGB8Unorm;case 37496:return i?N.ETC2RGBA8UnormSRGB:N.ETC2RGBA8Unorm}switch(e){case 3:switch(t){case 6:return N.R8Snorm;case 7:return N.RG8Snorm;case 4:throw"RGB format not supported in WebGPU";case 8:return N.R8Sint;case 9:return N.RG8Sint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return N.RGBA8Sint;default:return N.RGBA8Snorm}case 0:switch(t){case 6:return N.R8Unorm;case 7:return N.RG8Unorm;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return i?N.RGBA8UnormSRGB:N.RGBA8Unorm;case 12:return i?N.BGRA8UnormSRGB:N.BGRA8Unorm;case 8:return N.R8Uint;case 9:return N.RG8Uint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return N.RGBA8Uint;case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return N.RGBA8Unorm}case 4:switch(t){case 8:return N.R16Sint;case 9:return N.RG16Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return N.RGBA16Sint}case 5:switch(t){case 8:return N.R16Uint;case 9:return N.RG16Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return N.RGBA16Uint}case 6:switch(t){case 8:return N.R32Sint;case 9:return N.RG32Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return N.RGBA32Sint}case 7:switch(t){case 8:return N.R32Uint;case 9:return N.RG32Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return N.RGBA32Uint}case 1:switch(t){case 6:return N.R32Float;case 7:return N.RG32Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return N.RGBA32Float}case 2:switch(t){case 6:return N.R16Float;case 7:return N.RG16Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return N.RGBA16Float}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:throw"TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV format not supported in WebGPU";case 14:throw"TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV format not supported in WebGPU";case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:default:return N.RGB10A2Unorm;case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV"}}return i?N.RGBA8UnormSRGB:N.RGBA8Unorm}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case N.R8Unorm:case N.R8Snorm:case N.R8Uint:case N.R8Sint:case N.BC4RUnorm:case N.BC4RSnorm:case N.R16Uint:case N.R16Sint:case N.Depth16Unorm:case N.R16Float:case N.R32Uint:case N.R32Sint:case N.R32Float:case N.Depth32Float:case N.Stencil8:case N.Depth24Plus:case N.EACR11Unorm:case N.EACR11Snorm:return 1;case N.RG8Unorm:case N.RG8Snorm:case N.RG8Uint:case N.RG8Sint:case N.Depth24UnormStencil8:case N.Depth32FloatStencil8:case N.BC5RGUnorm:case N.BC5RGSnorm:case N.RG16Uint:case N.RG16Sint:case N.RG16Float:case N.RG32Uint:case N.RG32Sint:case N.RG32Float:case N.Depth24PlusStencil8:case N.EACRG11Unorm:case N.EACRG11Snorm:return 2;case N.RGB9E5UFloat:case N.RG11B10UFloat:case N.BC6HRGBUFloat:case N.BC6HRGBFloat:case N.ETC2RGB8Unorm:case N.ETC2RGB8UnormSRGB:return 3;case N.RGBA8Unorm:case N.RGBA8UnormSRGB:case N.RGBA8Snorm:case N.RGBA8Uint:case N.RGBA8Sint:case N.BGRA8Unorm:case N.BGRA8UnormSRGB:case N.RGB10A2Unorm:case N.BC7RGBAUnorm:case N.BC7RGBAUnormSRGB:case N.BC3RGBAUnorm:case N.BC3RGBAUnormSRGB:case N.BC2RGBAUnorm:case N.BC2RGBAUnormSRGB:case N.BC1RGBAUnorm:case N.BC1RGBAUnormSRGB:case N.RGBA16Uint:case N.RGBA16Sint:case N.RGBA16Float:case N.RGBA32Uint:case N.RGBA32Sint:case N.RGBA32Float:case N.ETC2RGB8A1Unorm:case N.ETC2RGB8A1UnormSRGB:case N.ETC2RGBA8Unorm:case N.ETC2RGBA8UnormSRGB:case N.ASTC4x4Unorm:case N.ASTC4x4UnormSRGB:case N.ASTC5x4Unorm:case N.ASTC5x4UnormSRGB:case N.ASTC5x5Unorm:case N.ASTC5x5UnormSRGB:case N.ASTC6x5Unorm:case N.ASTC6x5UnormSRGB:case N.ASTC6x6Unorm:case N.ASTC6x6UnormSRGB:case N.ASTC8x5Unorm:case N.ASTC8x5UnormSRGB:case N.ASTC8x6Unorm:case N.ASTC8x6UnormSRGB:case N.ASTC8x8Unorm:case N.ASTC8x8UnormSRGB:case N.ASTC10x5Unorm:case N.ASTC10x5UnormSRGB:case N.ASTC10x6Unorm:case N.ASTC10x6UnormSRGB:case N.ASTC10x8Unorm:case N.ASTC10x8UnormSRGB:case N.ASTC10x10Unorm:case N.ASTC10x10UnormSRGB:case N.ASTC12x10Unorm:case N.ASTC12x10UnormSRGB:case N.ASTC12x12Unorm:case N.ASTC12x12UnormSRGB:return 4}throw`Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case N.Stencil8:case N.Depth24UnormStencil8:case N.Depth32FloatStencil8:case N.Depth24PlusStencil8:return!0}return!1}static HasDepthAndStencilAspects(e){switch(e){case N.Depth24UnormStencil8:case N.Depth32FloatStencil8:case N.Depth24PlusStencil8:return!0}return!1}copyVideoToTexture(e,t,i,s=!1,n){var o,a,l,c;const h=void 0===n,[u,d]=this._getVideoPipeline(i,s?yh.InvertY:yh.DontInvertY);h&&(n=this._device.createCommandEncoder({})),null===(a=(o=n).pushDebugGroup)||void 0===a||a.call(o,`copy video to texture - invertY=${s}`);const p={colorAttachments:[{view:t._hardwareTexture.underlyingResource.createView({format:i,dimension:Kt.E2d,mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:hl.All}),loadOp:ns.Load,storeOp:gn.Store}]},_=n.beginRenderPass(p),m={layout:d,entries:[{binding:0,resource:this._videoSampler},{binding:1,resource:this._device.importExternalTexture({source:e.underlyingResource})}]},g=this._device.createBindGroup(m);_.setPipeline(u),_.setBindGroup(0,g),_.draw(4,1,0,0),_.end(),null===(c=(l=n).popDebugGroup)||void 0===c||c.call(l),h&&(this._device.queue.submit([n.finish()]),n=null)}invertYPreMultiplyAlpha(e,t,i,s,n=!1,o=!1,a=0,l=0,c=1,h=0,u=0,d=0,f=0,p,_){var m,g,b,y,T,x;const S=0!==d,C=void 0===p,[D,P]=this._getPipeline(s,S?Yn.InvertYPremultiplyAlphaWithOfst:Yn.InvertYPremultiplyAlpha,{invertY:n,premultiplyAlpha:o});let M;if(a=Math.max(a,0),C&&(p=this._device.createCommandEncoder({})),null===(g=(m=p).pushDebugGroup)||void 0===g||g.call(m,`internal process texture - invertY=${n} premultiplyAlpha=${o}`),vi._IsHardwareTexture(e)?(M=e.underlyingResource,n&&!o&&1===c&&0===a||(e=void 0)):(M=e,e=void 0),!M)return;S&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([h,u,d,f]),0,16);const w=e,k=null!==(b=w?._copyInvertYTempTexture)&&void 0!==b?b:this.createTexture({width:t,height:i,layers:1},!1,!1,!1,!1,!1,s,1,p,ci.CopySrc|ci.RenderAttachment|ci.TextureBinding),X=null!==(y=w?._copyInvertYRenderPassDescr)&&void 0!==y?y:{colorAttachments:[{view:k.createView({format:s,dimension:Kt.E2d,baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:ns.Load,storeOp:gn.Store}]},te=p.beginRenderPass(X);let J=S?w?._copyInvertYBindGroupWithOfst:w?._copyInvertYBindGroup;if(!J){const Q={layout:P,entries:[{binding:0,resource:M.createView({format:s,dimension:Kt.E2d,baseMipLevel:l,mipLevelCount:1,arrayLayerCount:c,baseArrayLayer:a})}]};S&&Q.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),J=this._device.createBindGroup(Q)}te.setPipeline(D),te.setBindGroup(0,J),te.draw(4,1,0,0),te.end(),p.copyTextureToTexture({texture:k},{texture:M,mipLevel:l,origin:{x:0,y:0,z:a}},{width:t,height:i,depthOrArrayLayers:1}),w?(w._copyInvertYTempTexture=k,w._copyInvertYRenderPassDescr=X,S?w._copyInvertYBindGroupWithOfst=J:w._copyInvertYBindGroup=J):this._deferredReleaseTextures.push([k,null]),null===(x=(T=p).popDebugGroup)||void 0===x||x.call(T),C&&(this._device.queue.submit([p.finish()]),p=null)}copyWithInvertY(e,t,i,s){var n,o,a,l;const c=void 0===s,[h,u]=this._getPipeline(t,Yn.InvertYPremultiplyAlpha,{invertY:!0,premultiplyAlpha:!1});c&&(s=this._device.createCommandEncoder({})),null===(o=(n=s).pushDebugGroup)||void 0===o||o.call(n,"internal copy texture with invertY");const d=s.beginRenderPass(i),f=this._device.createBindGroup({layout:u,entries:[{binding:0,resource:e}]});d.setPipeline(h),d.setBindGroup(0,f),d.draw(4,1,0,0),d.end(),null===(l=(a=s).popDebugGroup)||void 0===l||l.call(a),c&&(this._device.queue.submit([s.finish()]),s=null)}createTexture(e,t=!1,i=!1,s=!1,n=!1,o=!1,a=N.RGBA8Unorm,l=1,c,h=-1,u=0){l>1&&(l=4);const d=e.layers||1,f={width:e.width,height:e.height,depthOrArrayLayers:d},p=vi.IsCompressedFormat(a),_=t?vi.ComputeNumMipmapLevels(e.width,e.height):1;u|=t&&!p?ci.CopySrc|ci.RenderAttachment:0,!p&&!o&&(u|=ci.RenderAttachment|ci.CopyDst);const g=this._device.createTexture({label:`Texture_${f.width}x${f.height}x${f.depthOrArrayLayers}_${t?"wmips":"womips"}_${a}_samples${l}`,size:f,dimension:o?cl.E3d:cl.E2d,format:a,usage:(h>=0?h:ci.CopySrc|ci.CopyDst|ci.TextureBinding)|u,sampleCount:l,mipLevelCount:_});return vi.IsImageBitmap(e)&&(this.updateTexture(e,g,e.width,e.height,d,a,0,0,s,n,0,0),t&&i&&this.generateMipmaps(g,a,_,0,c)),g}createCubeTexture(e,t=!1,i=!1,s=!1,n=!1,o=N.RGBA8Unorm,a=1,l,c=-1,h=0){a>1&&(a=4);const u=vi.IsImageBitmapArray(e)?e[0].width:e.width,d=vi.IsImageBitmapArray(e)?e[0].height:e.height,f=vi.IsCompressedFormat(o),p=t?vi.ComputeNumMipmapLevels(u,d):1;h|=t&&!f?ci.CopySrc|ci.RenderAttachment:0,f||(h|=ci.RenderAttachment|ci.CopyDst);const m=this._device.createTexture({label:`TextureCube_${u}x${d}x6_${t?"wmips":"womips"}_${o}_samples${a}`,size:{width:u,height:d,depthOrArrayLayers:6},dimension:cl.E2d,format:o,usage:(c>=0?c:ci.CopySrc|ci.CopyDst|ci.TextureBinding)|h,sampleCount:a,mipLevelCount:p});return vi.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,m,u,d,o,s,n,0,0),t&&i&&this.generateCubeMipmaps(m,o,p,l)),m}generateCubeMipmaps(e,t,i,s){var n,o,a,l;const c=void 0===s;c&&(s=this._device.createCommandEncoder({})),null===(o=(n=s).pushDebugGroup)||void 0===o||o.call(n,`create cube mipmaps - ${i} levels`);for(let h=0;h<6;++h)this.generateMipmaps(e,t,i,h,s);null===(l=(a=s).popDebugGroup)||void 0===l||l.call(a),c&&(this._device.queue.submit([s.finish()]),s=null)}generateMipmaps(e,t,i,s=0,n){var o,a,l,c,h,u,d,f;const p=void 0===n,[_,m]=this._getPipeline(t);let g;if(s=Math.max(s,0),p&&(n=this._device.createCommandEncoder({})),null===(a=(o=n).pushDebugGroup)||void 0===a||a.call(o,`create mipmaps for face #${s} - ${i} levels`),vi._IsHardwareTexture(e)?(g=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(g=e,e=void 0),!g)return;const b=e;for(let y=1;y<i;++y){const T=null!==(c=null===(l=b?._mipmapGenRenderPassDescr[s])||void 0===l?void 0:l[y-1])&&void 0!==c?c:{colorAttachments:[{view:g.createView({format:t,dimension:Kt.E2d,baseMipLevel:y,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:s}),loadOp:ns.Load,storeOp:gn.Store}]};b&&(b._mipmapGenRenderPassDescr[s]=b._mipmapGenRenderPassDescr[s]||[],b._mipmapGenRenderPassDescr[s][y-1]=T);const x=n.beginRenderPass(T),S=null!==(u=null===(h=b?._mipmapGenBindGroup[s])||void 0===h?void 0:h[y-1])&&void 0!==u?u:this._device.createBindGroup({layout:m,entries:[{binding:0,resource:this._mipmapSampler},{binding:1,resource:g.createView({format:t,dimension:Kt.E2d,baseMipLevel:y-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:s})}]});b&&(b._mipmapGenBindGroup[s]=b._mipmapGenBindGroup[s]||[],b._mipmapGenBindGroup[s][y-1]=S),x.setPipeline(_),x.setBindGroup(0,S),x.draw(4,1,0,0),x.end()}null===(f=(d=n).popDebugGroup)||void 0===f||f.call(d),p&&(this._device.queue.submit([n.finish()]),n=null)}createGPUTextureForInternalTexture(e,t,i,s,n){e._hardwareTexture||(e._hardwareTexture=new zv),void 0===t&&(t=e.width),void 0===i&&(i=e.height),void 0===s&&(s=e.depth);const o=e._hardwareTexture,a=0!=(1&(n??0));o.format=vi.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),o.textureUsages=e._source===Ye.RenderTarget||e.source===Ye.MultiRenderTarget?ci.TextureBinding|ci.CopySrc|ci.RenderAttachment:e._source===Ye.DepthStencil?ci.TextureBinding|ci.RenderAttachment:-1,o.textureAdditionalUsages=a?ci.StorageBinding:0;const c=s||1;let h;if(h=null!==e._maxLodLevel?e._maxLodLevel:e.generateMipMaps?vi.ComputeNumMipmapLevels(t,i):1,e.isCube){const u=this.createCubeTexture({width:t,height:i},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages);o.set(u),o.createView({format:o.format,dimension:Kt.Cube,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:hl.All},a)}else{const u=this.createTexture({width:t,height:i,layers:c},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages);o.set(u),o.createView({format:o.format,dimension:e.is2DArray?Kt.E2dArray:e.is3D?cl.E3d:Kt.E2d,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:e.is3D?1:c,aspect:hl.All},a)}return e.width=e.baseWidth=t,e.height=e.baseHeight=i,e.depth=e.baseDepth=s,this.createMSAATexture(e,e.samples),o}createMSAATexture(e,t){const i=e._hardwareTexture;if(i?.msaaTexture&&(this.releaseTexture(i.msaaTexture),i.msaaTexture=null),!i||(t??1)<=1)return;const s=e.width,n=e.height,o=e.depth||1;if(e.isCube){const a=this.createCubeTexture({width:s,height:n},!1,!1,e.invertY,!1,i.format,t,this._commandEncoderForCreation,i.textureUsages,i.textureAdditionalUsages);i.msaaTexture=a}else{const a=this.createTexture({width:s,height:n,layers:o},!1,!1,e.invertY,!1,e.is3D,i.format,t,this._commandEncoderForCreation,i.textureUsages,i.textureAdditionalUsages);i.msaaTexture=a}}updateCubeTextures(e,t,i,s,n,o=!1,a=!1,l=0,c=0){const h=[0,3,1,4,2,5];for(let u=0;u<h.length;++u)this.updateTexture(e[h[u]],t,i,s,1,n,u,0,o,a,l,c)}updateTexture(e,t,i,s,n,o,a=0,l=0,c=!1,h=!1,u=0,d=0,f){const p=vi._IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,_=vi._GetBlockInformationFromFormat(o),m=vi._IsInternalTexture(t)?t._hardwareTexture:t,g={texture:p,origin:{x:u,y:d,z:Math.max(a,0)},mipLevel:l,premultipliedAlpha:h},b={width:Math.ceil(i/_.width)*_.width,height:Math.ceil(s/_.height)*_.height,depthOrArrayLayers:n||1};if(void 0!==e.byteLength){const y=Math.ceil(i/_.width)*_.length;if(256*Math.ceil(y/256)===y){const x=this._device.createCommandEncoder({}),S=this._bufferManager.createRawBuffer(e.byteLength,ei.MapWrite|ei.CopySrc,!0),C=S.getMappedRange();new Uint8Array(C).set(e),S.unmap(),x.copyBufferToTexture({buffer:S,offset:0,bytesPerRow:y,rowsPerImage:s},g,b),this._device.queue.submit([x.finish()]),this._bufferManager.releaseBuffer(S)}else this._device.queue.writeTexture(g,e,{offset:0,bytesPerRow:y,rowsPerImage:s},b);if(c||h){if(!vi._IsInternalTexture(t))throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!";{const x=0===u&&0===d&&i===t.width&&s===t.height;this.invertYPreMultiplyAlpha(m,t.width,t.height,o,c,h,a,l,n||1,u,d,x?0:i,x?0:s,void 0,f)}}}else if(c)if(g.premultipliedAlpha=!1,vi._IsInternalTexture(t)&&0===u&&0===d&&i===t.width&&s===t.height)this._device.queue.copyExternalImageToTexture({source:e},g,b),this.invertYPreMultiplyAlpha(m,i,s,o,c,h,a,l,n||1,0,0,0,0,void 0,f);else{const y=this._device.createCommandEncoder({}),T=this.createTexture({width:i,height:s,layers:1},!1,!1,!1,!1,!1,o,1,y,ci.CopySrc|ci.TextureBinding);this._deferredReleaseTextures.push([T,null]),b.depthOrArrayLayers=1,this._device.queue.copyExternalImageToTexture({source:e},{texture:T},b),b.depthOrArrayLayers=n||1,this.invertYPreMultiplyAlpha(T,i,s,o,c,h,a,l,n||1,0,0,0,0,y,f),y.copyTextureToTexture({texture:T},g,b),this._device.queue.submit([y.finish()])}else this._device.queue.copyExternalImageToTexture({source:e},g,b)}readPixels(e,t,i,s,n,o,a=0,l=0,c=null,h=!1){const u=vi._GetBlockInformationFromFormat(o),d=Math.ceil(s/u.width)*u.length,f=256*Math.ceil(d/256),p=f*n,_=this._bufferManager.createRawBuffer(p,ei.MapRead|ei.CopyDst),m=this._device.createCommandEncoder({});return m.copyTextureToBuffer({texture:e,mipLevel:l,origin:{x:t,y:i,z:Math.max(a,0)}},{buffer:_,offset:0,bytesPerRow:f},{width:s,height:n,depthOrArrayLayers:1}),this._device.queue.submit([m.finish()]),this._bufferManager.readDataFromBuffer(_,p,s,n,d,f,vi._GetTextureTypeFromFormat(o),0,c,!0,h)}releaseTexture(e){vi._IsInternalTexture(e)?this._deferredReleaseTextures.push([e._hardwareTexture,e._irradianceTexture]):this._deferredReleaseTextures.push([e,null])}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){const[t,i]=this._deferredReleaseTextures[e];t&&(vi._IsHardwareTexture(t)?t.release():t.destroy()),i?.dispose()}this._deferredReleaseTextures.length=0}}class Wre extends jg{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}class pC{static _IsGPUBuffer(e){return void 0===e.underlyingResource}constructor(e){this._deferredReleaseBuffers=[],this._device=e}createRawBuffer(e,t,i=!1){return this._device.createBuffer({mappedAtCreation:i,size:void 0!==e.byteLength?e.byteLength+3&-4:e+3&-4,usage:t})}createBuffer(e,t){const i=void 0!==e.byteLength,s=this.createRawBuffer(e,t),n=new Wre(s);return n.references=1,n.capacity=i?e.byteLength:e,i&&this.setSubData(n,0,e),n}setRawData(e,t,i,s,n){this._device.queue.writeBuffer(e,t,i.buffer,s,n)}setSubData(e,t,i,s=0,n=0){const o=e.underlyingResource;n=n||i.byteLength,n=Math.min(n,e.capacity-t);let a=i.byteOffset+s,l=a+n;const c=n+3&-4;if(c!==n){const d=new Uint8Array(i.buffer.slice(a,l));(i=new Uint8Array(c)).set(d),s=0,a=0,l=c,n=c}const h=15728640;let u=0;for(;l-(a+u)>h;)this._device.queue.writeBuffer(o,t+u,i.buffer,a+u,h),u+=h;this._device.queue.writeBuffer(o,t+u,i.buffer,a+u,n-u)}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,i){i||(i=new Float32Array(e));const s=new Uint16Array(t);for(;e--;)i[e]=ga(s[e]);return i}readDataFromBuffer(e,t,i,s,n,o,a=0,l=0,c=null,h=!0,u=!1){const d=1===a?2:2===a?1:0;return new Promise((f,p)=>{e.mapAsync(ac.Read,l,t).then(()=>{const _=e.getMappedRange(l,t);let m=c;if(u)m=null===m?CE(a,t,!0,_):CE(a,m.buffer,void 0,_);else if(null===m)switch(d){case 0:m=new Uint8Array(t),m.set(new Uint8Array(_));break;case 1:m=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,_);break;case 2:m=new Float32Array(t/4),m.set(new Float32Array(_))}else switch(d){case 0:m=new Uint8Array(m.buffer),m.set(new Uint8Array(_));break;case 1:m=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,_,c);break;case 2:m=new Float32Array(m.buffer),m.set(new Float32Array(_))}if(n!==o){1===d&&!u&&(n*=2,o*=2);const g=new Uint8Array(m.buffer);let b=n,y=0;for(let T=1;T<s;++T){y=T*o;for(let x=0;x<n;++x)g[b++]=g[y++]}m=0===d||u?new Uint8Array(g.buffer,0,b):new Float32Array(g.buffer,0,b/4)}e.unmap(),h&&this.releaseBuffer(e),f(m)},_=>p(_))})}releaseBuffer(e){return pC._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,0===e.references&&(this._deferredReleaseBuffers.push(e.underlyingResource),!0))}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0}}class rU{constructor(){this.colorAttachmentGPUTextures=[],this.reset()}reset(e=!1){this.renderPass=null,e&&(this.renderPassDescriptor=null,this.colorAttachmentViewDescriptor=null,this.depthAttachmentViewDescriptor=null,this.colorAttachmentGPUTextures=[],this.depthTextureFormat=void 0)}}const Xre=[0,0,3,7,0,2,6,2,4,1,5,3,1],jre=[0,64,32,96,16,80,48,112,8],Yre=[0,128,128,0,0,0,0,128,0,0,0,0,128];class xh{constructor(e){this._samplers={},this._device=e,this.disabled=!1}static GetSamplerHashCode(e){var t,i,s;return Xre[e.samplingMode]+jre[(e._comparisonFunction||514)-512+1]+Yre[e.samplingMode]+((null!==(t=e._cachedWrapU)&&void 0!==t?t:1)<<8)+((null!==(i=e._cachedWrapV)&&void 0!==i?i:1)<<10)+((null!==(s=e._cachedWrapR)&&void 0!==s?s:1)<<12)+((e.useMipMaps?1:0)<<14)+((e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1)<<15)}static _GetSamplerFilterDescriptor(e,t){let i,s,n,o,a;const l=e.useMipMaps;switch(e.samplingMode){case 11:i=mt.Linear,s=mt.Linear,n=mt.Nearest,l||(o=a=0);break;case 3:case 3:i=mt.Linear,s=mt.Linear,l?n=mt.Linear:(n=mt.Nearest,o=a=0);break;case 8:i=mt.Nearest,s=mt.Nearest,l?n=mt.Linear:(n=mt.Nearest,o=a=0);break;case 4:i=mt.Nearest,s=mt.Nearest,n=mt.Nearest,l||(o=a=0);break;case 5:i=mt.Nearest,s=mt.Linear,n=mt.Nearest,l||(o=a=0);break;case 6:i=mt.Nearest,s=mt.Linear,l?n=mt.Linear:(n=mt.Nearest,o=a=0);break;case 7:i=mt.Nearest,s=mt.Linear,n=mt.Nearest,o=a=0;break;case 1:case 1:default:i=mt.Nearest,s=mt.Nearest,n=mt.Nearest,o=a=0;break;case 9:i=mt.Linear,s=mt.Nearest,n=mt.Nearest,l||(o=a=0);break;case 10:i=mt.Linear,s=mt.Nearest,l?n=mt.Linear:(n=mt.Nearest,o=a=0);break;case 2:case 2:i=mt.Linear,s=mt.Linear,n=mt.Nearest,o=a=0;break;case 12:i=mt.Linear,s=mt.Nearest,n=mt.Nearest,o=a=0}return t>1&&(0!==o||0!==a)?{magFilter:mt.Linear,minFilter:mt.Linear,mipmapFilter:mt.Linear,anisotropyEnabled:!0}:{magFilter:i,minFilter:s,mipmapFilter:n,lodMinClamp:o,lodMaxClamp:a}}static _GetWrappingMode(e){switch(e){case 1:return bh.Repeat;case 0:return bh.ClampToEdge;case 2:return bh.MirrorRepeat}return bh.Repeat}static _GetSamplerWrappingDescriptor(e){return{addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}}static _GetSamplerDescriptor(e){const t=e.useMipMaps&&e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1,i=this._GetSamplerFilterDescriptor(e,t);return{...i,...this._GetSamplerWrappingDescriptor(e),compare:e._comparisonFunction?xh.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:i.anisotropyEnabled?t:1}}static GetCompareFunction(e){switch(e){case 519:return Es.Always;case 514:return Es.Equal;case 516:return Es.Greater;case 518:return Es.GreaterEqual;case 513:default:return Es.Less;case 515:return Es.LessEqual;case 512:return Es.Never;case 517:return Es.NotEqual}}getSampler(e,t=!1,i=0){if(this.disabled)return this._device.createSampler(xh._GetSamplerDescriptor(e));t?i=0:0===i&&(i=xh.GetSamplerHashCode(e));let s=t?void 0:this._samplers[i];return s||(s=this._device.createSampler(xh._GetSamplerDescriptor(e)),t||(this._samplers[i]=s)),s}}var Oi=(()=>{return(r=Oi||(Oi={}))[r.StencilReadMask=0]="StencilReadMask",r[r.StencilWriteMask=1]="StencilWriteMask",r[r.DepthBias=2]="DepthBias",r[r.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",r[r.DepthStencilState=4]="DepthStencilState",r[r.MRTAttachments1=5]="MRTAttachments1",r[r.MRTAttachments2=6]="MRTAttachments2",r[r.RasterizationState=7]="RasterizationState",r[r.ColorStates=8]="ColorStates",r[r.ShaderStage=9]="ShaderStage",r[r.TextureStage=10]="TextureStage",r[r.VertexState=11]="VertexState",r[r.NumStates=12]="NumStates",Oi;var r})();const Hv={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:12,32772:13},ed={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7};let qre=(()=>{class r{constructor(t,i,s){this.mrtTextureCount=0,this._device=t,this._useTextureStage=s,this._states=new Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=i,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this._kMaxVertexBufferStride=t.limits.maxVertexBufferArrayStride||2048,this.reset()}reset(){this._isDirty=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this._webgpuColorFormat=[N.BGRA8Unorm],this.setColorFormat(N.BGRA8Unorm),this.setMRT([]),this.setAlphaBlendEnabled(!1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat(N.Depth24PlusStencil8),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0)}get colorFormats(){return this._mrtAttachments1>0?this._mrtFormats:this._webgpuColorFormat}getRenderPipeline(t,i,s,n=0){if(s>1&&(s=4),this.disabled){const a=r._GetTopology(t);return this._setVertexState(i),this._parameter.pipeline=this._createRenderPipeline(i,a,s),r.NumCacheMiss++,r._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(i.uniqueId),this._setRasterizationState(t,s),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(i),this._setTextureState(n),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,r.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return r.NumCacheHitWithHash++,this._parameter.pipeline;const o=r._GetTopology(t);return this._parameter.pipeline=this._createRenderPipeline(i,o,s),this._setRenderPipeline(this._parameter),r.NumCacheMiss++,r._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}endFrame(){r.NumPipelineCreationLastFrame=r._NumPipelineCreationCurrentFrame,r._NumPipelineCreationCurrentFrame=0}setAlphaToCoverage(t){this._alphaToCoverageEnabled=t}setFrontFace(t){this._frontFace=t}setCullEnabled(t){this._cullEnabled=t}setCullFace(t){this._cullFace=t}setClampDepth(t){this._clampDepth=t}resetDepthCullingState(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)}setDepthCullingState(t,i,s,n,o,a,l,c){this._depthWriteEnabled=l,this._depthTestEnabled=a,this._depthCompare=(c??519)-512,this._cullFace=s,this._cullEnabled=t,this._frontFace=i,this.setDepthBiasSlopeScale(n),this.setDepthBias(o)}setDepthBias(t){this._depthBias!==t&&(this._depthBias=t,this._states[Oi.DepthBias]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Oi.DepthBias))}setDepthBiasSlopeScale(t){this._depthBiasSlopeScale!==t&&(this._depthBiasSlopeScale=t,this._states[Oi.DepthBiasSlopeScale]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Oi.DepthBiasSlopeScale))}setColorFormat(t){this._webgpuColorFormat[0]=t,this._colorFormat=Fp[t??""]}setMRTAttachments(t){this.mrtAttachments=t;let i=0;for(let s=0;s<t.length;++s)0!==t[s]&&(i+=1<<s);this._mrtEnabledMask!==i&&(this._mrtEnabledMask=i,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Oi.MRTAttachments1))}setMRT(t,i){var s,n;if((i=i??t.length)>10)throw"Can't handle more than 10 attachments for a MRT in cache render pipeline!";this.mrtTextureArray=t,this.mrtTextureCount=i,this._mrtEnabledMask=65535;const o=[0,0];let a=0,l=0,c=0;for(let h=0;h<i;++h){const d=t[h]?._hardwareTexture;this._mrtFormats[c]=null!==(s=d?.format)&&void 0!==s?s:this._webgpuColorFormat[0],o[a]+=Fp[null!==(n=this._mrtFormats[c])&&void 0!==n?n:""]<<l,l+=6,c++,l>=32&&(l=0,a++)}this._mrtFormats.length=c,(this._mrtAttachments1!==o[0]||this._mrtAttachments2!==o[1])&&(this._mrtAttachments1=o[0],this._mrtAttachments2=o[1],this._states[Oi.MRTAttachments1]=o[0],this._states[Oi.MRTAttachments2]=o[1],this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Oi.MRTAttachments1))}setAlphaBlendEnabled(t){this._alphaBlendEnabled=t}setAlphaBlendFactors(t,i){this._alphaBlendFuncParams=t,this._alphaBlendEqParams=i}setWriteMask(t){this._writeMask=t}setDepthStencilFormat(t){this._webgpuDepthStencilFormat=t,this._depthStencilFormat=void 0===t?0:Fp[t]}setDepthTestEnabled(t){this._depthTestEnabled=t}setDepthWriteEnabled(t){this._depthWriteEnabled=t}setDepthCompare(t){this._depthCompare=(t??519)-512}setStencilEnabled(t){this._stencilEnabled=t}setStencilCompare(t){this._stencilFrontCompare=(t??519)-512}setStencilDepthFailOp(t){this._stencilFrontDepthFailOp=null===t?1:ed[t]}setStencilPassOp(t){this._stencilFrontPassOp=null===t?2:ed[t]}setStencilFailOp(t){this._stencilFrontFailOp=null===t?1:ed[t]}setStencilReadMask(t){this._stencilReadMask!==t&&(this._stencilReadMask=t,this._states[Oi.StencilReadMask]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Oi.StencilReadMask))}setStencilWriteMask(t){this._stencilWriteMask!==t&&(this._stencilWriteMask=t,this._states[Oi.StencilWriteMask]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Oi.StencilWriteMask))}resetStencilState(){this.setStencilState(!1,519,7680,7681,7680,255,255)}setStencilState(t,i,s,n,o,a,l){this._stencilEnabled=t,this._stencilFrontCompare=(i??519)-512,this._stencilFrontDepthFailOp=null===s?1:ed[s],this._stencilFrontPassOp=null===n?2:ed[n],this._stencilFrontFailOp=null===o?1:ed[o],this.setStencilReadMask(a),this.setStencilWriteMask(l)}setBuffers(t,i,s){this._vertexBuffers=t,this._overrideVertexBuffers=s,this._indexBuffer=i}static _GetTopology(t){switch(t){case 0:default:return sn.TriangleList;case 2:case 3:return sn.PointList;case 1:case 4:return sn.LineList;case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return sn.LineStrip;case 7:return sn.TriangleStrip;case 8:throw"TriangleFan is an unsupported fillmode in WebGPU"}}static _GetAphaBlendOperation(t){switch(t){case 32774:default:return pl.Add;case 32778:return pl.Subtract;case 32779:return pl.ReverseSubtract;case 32775:return pl.Min;case 32776:return pl.Max}}static _GetAphaBlendFactor(t){switch(t){case 0:return cr.Zero;case 1:default:return cr.One;case 768:return cr.Src;case 769:return cr.OneMinusSrc;case 770:return cr.SrcAlpha;case 771:return cr.OneMinusSrcAlpha;case 772:return cr.DstAlpha;case 773:return cr.OneMinusDstAlpha;case 774:return cr.Dst;case 775:return cr.OneMinusDst;case 776:return cr.SrcAlphaSaturated;case 32769:case 32771:return cr.Constant;case 32770:case 32772:return cr.OneMinusConstant}}static _GetCompareFunction(t){switch(t){case 0:return Es.Never;case 1:return Es.Less;case 2:return Es.Equal;case 3:return Es.LessEqual;case 4:return Es.Greater;case 5:return Es.NotEqual;case 6:return Es.GreaterEqual;case 7:return Es.Always}return Es.Never}static _GetStencilOpFunction(t){switch(t){case 0:return _o.Zero;case 1:return _o.Keep;case 2:return _o.Replace;case 3:return _o.IncrementClamp;case 4:return _o.DecrementClamp;case 5:return _o.Invert;case 6:return _o.IncrementWrap;case 7:return _o.DecrementWrap}return _o.Keep}static _GetVertexInputDescriptorFormat(t){const i=t.type,s=t.normalized,n=t.getSize();switch(i){case A.BYTE:switch(n){case 1:case 2:return s?pi.Snorm8x2:pi.Sint8x2;case 3:case 4:return s?pi.Snorm8x4:pi.Sint8x4}break;case A.UNSIGNED_BYTE:switch(n){case 1:case 2:return s?pi.Unorm8x2:pi.Uint8x2;case 3:case 4:return s?pi.Unorm8x4:pi.Uint8x4}break;case A.SHORT:switch(n){case 1:case 2:return s?pi.Snorm16x2:pi.Sint16x2;case 3:case 4:return s?pi.Snorm16x4:pi.Sint16x4}break;case A.UNSIGNED_SHORT:switch(n){case 1:case 2:return s?pi.Unorm16x2:pi.Uint16x2;case 3:case 4:return s?pi.Unorm16x4:pi.Uint16x4}break;case A.INT:switch(n){case 1:return pi.Sint32;case 2:return pi.Sint32x2;case 3:return pi.Sint32x3;case 4:return pi.Sint32x4}break;case A.UNSIGNED_INT:switch(n){case 1:return pi.Uint32;case 2:return pi.Uint32x2;case 3:return pi.Uint32x3;case 4:return pi.Uint32x4}break;case A.FLOAT:switch(n){case 1:return pi.Float32;case 2:return pi.Float32x2;case 3:return pi.Float32x3;case 4:return pi.Float32x4}}throw new Error(`Invalid Format '${t.getKind()}' - type=${i}, normalized=${s}, size=${n}`)}_getAphaBlendState(){return this._alphaBlendEnabled?{srcFactor:r._GetAphaBlendFactor(this._alphaBlendFuncParams[2]),dstFactor:r._GetAphaBlendFactor(this._alphaBlendFuncParams[3]),operation:r._GetAphaBlendOperation(this._alphaBlendEqParams[1])}:null}_getColorBlendState(){return this._alphaBlendEnabled?{srcFactor:r._GetAphaBlendFactor(this._alphaBlendFuncParams[0]),dstFactor:r._GetAphaBlendFactor(this._alphaBlendFuncParams[1]),operation:r._GetAphaBlendOperation(this._alphaBlendEqParams[0])}:null}_setShaderStage(t){this._shaderId!==t&&(this._shaderId=t,this._states[Oi.ShaderStage]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Oi.ShaderStage))}_setRasterizationState(t,i){const l=this._frontFace-1+((this._cullEnabled?this._cullFace:0)<<1)+((this._clampDepth?1:0)<<3)+((this._alphaToCoverageEnabled?1:0)<<4)+(t<<5)+(i<<8);this._rasterizationState!==l&&(this._rasterizationState=l,this._states[Oi.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Oi.RasterizationState))}_setColorStates(){let t=((this._writeMask?1:0)<<22)+(this._colorFormat<<23)+((this._depthWriteEnabled?1:0)<<29);this._alphaBlendEnabled&&(t+=((null===this._alphaBlendFuncParams[0]?2:Hv[this._alphaBlendFuncParams[0]])<<0)+((null===this._alphaBlendFuncParams[1]?2:Hv[this._alphaBlendFuncParams[1]])<<4)+((null===this._alphaBlendFuncParams[2]?2:Hv[this._alphaBlendFuncParams[2]])<<8)+((null===this._alphaBlendFuncParams[3]?2:Hv[this._alphaBlendFuncParams[3]])<<12)+((null===this._alphaBlendEqParams[0]?1:this._alphaBlendEqParams[0]-32773)<<16)+((null===this._alphaBlendEqParams[1]?1:this._alphaBlendEqParams[1]-32773)<<19)),t!==this._colorStates&&(this._colorStates=t,this._states[Oi.ColorStates]=this._colorStates,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Oi.ColorStates))}_setDepthStencilState(){const i=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+((this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9):591)<<10);this._depthStencilState!==i&&(this._depthStencilState=i,this._states[Oi.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Oi.DepthStencilState))}_setVertexState(t){var i,s;const n=this._statesLength;let o=Oi.VertexState;const a=t._pipelineContext,l=a.shaderProcessingContext.attributeNamesFromEffect,c=a.shaderProcessingContext.attributeLocationsFromEffect;let h,u=0;for(let d=0;d<l.length;d++){const f=c[d];let p=null!==(i=this._overrideVertexBuffers&&this._overrideVertexBuffers[l[d]])&&void 0!==i?i:this._vertexBuffers[l[d]];p||(p=this._emptyVertexBuffer);const _=null===(s=p.getBuffer())||void 0===s?void 0:s.underlyingResource;if(void 0===p._validOffsetRange){const g=p.byteOffset,b=p.getSize(!0),y=p.byteStride;p._validOffsetRange=g<=this._kMaxVertexBufferStride-b&&(0===y||g+b<=y)}h&&h===_&&p._validOffsetRange||(this.vertexBuffers[u++]=p,h=p._validOffsetRange?_:null);const m=p.hashCode+(f<<7);this._isDirty=this._isDirty||this._states[o]!==m,this._states[o++]=m}this.vertexBuffers.length=u,this._statesLength=o,this._isDirty=this._isDirty||o!==n,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Oi.VertexState))}_setTextureState(t){this._textureState!==t&&(this._textureState=t,this._states[Oi.TextureStage]=this._textureState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Oi.TextureStage))}_createPipelineLayout(t){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(t);const i=[],s=t.shaderProcessingContext.bindGroupLayoutEntries;for(let n=0;n<s.length;n++)i[n]=this._device.createBindGroupLayout({entries:s[n]});return t.bindGroupLayouts=i,this._device.createPipelineLayout({bindGroupLayouts:i})}_createPipelineLayoutWithTextureStage(t){var i;const s=t.shaderProcessingContext,n=s.bindGroupLayoutEntries;let o=1;for(let l=0;l<n.length;l++){const c=n[l];for(let h=0;h<c.length;h++){const u=n[l][h];if(u.texture){const d=s.bindGroupLayoutEntryInfo[l][u.binding].name,f=s.availableTextures[d],p=f.autoBindSampler?s.availableSamplers[d+_i.AutoSamplerSuffix]:null;let _=f.sampleType,m=null!==(i=p?.type)&&void 0!==i?i:fl.Filtering;this._textureState&o&&_!==tn.Depth&&(f.autoBindSampler&&(m=fl.NonFiltering),_=tn.UnfilterableFloat),u.texture.sampleType=_,p&&(n[p.binding.groupIndex][s.bindGroupLayoutEntryInfo[p.binding.groupIndex][p.binding.bindingIndex].index].sampler.type=m),o<<=1}}}const a=[];for(let l=0;l<n.length;++l)a[l]=this._device.createBindGroupLayout({entries:n[l]});return t.bindGroupLayouts=a,this._device.createPipelineLayout({bindGroupLayouts:a})}_getVertexInputDescriptor(t){var i,s;const n=[],o=t._pipelineContext,a=o.shaderProcessingContext.attributeNamesFromEffect,l=o.shaderProcessingContext.attributeLocationsFromEffect;let c,h;for(let u=0;u<a.length;u++){const d=l[u];let f=null!==(i=this._overrideVertexBuffers&&this._overrideVertexBuffers[a[u]])&&void 0!==i?i:this._vertexBuffers[a[u]];f||(f=this._emptyVertexBuffer);let p=null===(s=f.getBuffer())||void 0===s?void 0:s.underlyingResource,_=f.byteOffset;const m=!f._validOffsetRange;if(!c||!h||c!==p||m){const g={arrayStride:f.byteStride,stepMode:f.getIsInstanced()?Dp.Instance:Dp.Vertex,attributes:[]};n.push(g),h=g.attributes,m&&(_=0,p=null)}h.push({shaderLocation:d,offset:_,format:r._GetVertexInputDescriptorFormat(f)}),c=p}return n}_createRenderPipeline(t,i,s){var n,o,a;const l=t._pipelineContext,c=this._getVertexInputDescriptor(t),h=this._createPipelineLayout(l),u=[],d=this._getAphaBlendState(),f=this._getColorBlendState();if(this._mrtAttachments1>0)for(let g=0;g<this._mrtFormats.length;++g){const b=this._mrtFormats[g];if(b){const y={format:b,writeMask:0!=(this._mrtEnabledMask&1<<g)?this._writeMask:0};d&&f&&(y.blend={alpha:d,color:f}),u.push(y)}else u.push(null)}else if(this._webgpuColorFormat[0]){const g={format:this._webgpuColorFormat[0],writeMask:this._writeMask};d&&f&&(g.blend={alpha:d,color:f}),u.push(g)}else u.push(null);const p={compare:r._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:r._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:r._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:r._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)};let _;(i===sn.LineStrip||i===sn.TriangleStrip)&&(_=!this._indexBuffer||this._indexBuffer.is32Bits?_l.Uint32:_l.Uint16);const m=!!this._webgpuDepthStencilFormat&&vi.HasStencilAspect(this._webgpuDepthStencilFormat);return this._device.createRenderPipeline({label:`RenderPipeline_${null!==(o=null===(n=u[0])||void 0===n?void 0:n.format)&&void 0!==o?o:"nooutput"}_${null!==(a=this._webgpuDepthStencilFormat)&&void 0!==a?a:"nodepth"}_samples${s}`,layout:h,vertex:{module:l.stages.vertexStage.module,entryPoint:l.stages.vertexStage.entryPoint,buffers:c},primitive:{topology:i,stripIndexFormat:_,frontFace:1===this._frontFace?Pp.CCW:Pp.CW,cullMode:this._cullEnabled?2===this._cullFace?Ju.Front:Ju.Back:Ju.None},fragment:l.stages.fragmentStage?{module:l.stages.fragmentStage.module,entryPoint:l.stages.fragmentStage.entryPoint,targets:u}:void 0,multisample:{count:s},depthStencil:void 0===this._webgpuDepthStencilFormat?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?r._GetCompareFunction(this._depthCompare):Es.Always,format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&m?p:void 0,stencilBack:this._stencilEnabled&&m?p:void 0,stencilReadMask:this._stencilEnabled&&m?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&m?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:this._depthBiasClamp,depthBiasSlopeScale:this._depthBiasSlopeScale}})}}return r.NumCacheHitWithoutHash=0,r.NumCacheHitWithHash=0,r.NumCacheMiss=0,r.NumPipelineCreationLastFrame=0,r._NumPipelineCreationCurrentFrame=0,r})();class nU{constructor(){this.values={}}count(){let e=0,t=this.pipeline?1:0;for(const i in this.values){const s=this.values[i],[n,o]=s.count();e+=n,t+=o,e++}return[e,t]}}class ml extends qre{static GetNodeCounts(){const e=ml._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}}static _GetPipelines(e,t,i,s){if(e.pipeline){const n=i.slice();n.length=s,t.push(n)}for(const n in e.values){const o=e.values[n];i[s]=parseInt(n),ml._GetPipelines(o,t,i,s+1)}}static GetPipelines(){const e=[];return ml._GetPipelines(ml._Cache,e,[],0),e}constructor(e,t,i){super(e,t,i),this._nodeStack=[],this._nodeStack[0]=ml._Cache}_getRenderPipeline(e){let t=this._nodeStack[this._stateDirtyLowestIndex];for(let i=this._stateDirtyLowestIndex;i<this._statesLength;++i){let s=t.values[this._states[i]];s||(s=new nU,t.values[this._states[i]]=s),t=s,this._nodeStack[i+1]=t}e.token=t,e.pipeline=t.pipeline}_setRenderPipeline(e){e.token.pipeline=e.pipeline}}ml._Cache=new nU;class $re extends o1{constructor(e){super(!1),this._cache=e,this.reset()}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e))}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e))}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e))}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e))}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e))}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e))}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e))}reset(){super.reset(),this._cache.resetStencilState()}apply(){var e;const t=null===(e=this.stencilMaterial)||void 0===e?void 0:e.enabled;this.enabled=t?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.func=t?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=t?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=t?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=t?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=t?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=t?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=t?this.stencilMaterial.mask:this.stencilGlobal.mask)}}class Kre extends s1{constructor(e){super(!1),this._cache=e,this.reset()}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0,this._cache.setDepthBias(e))}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(e??1))}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(e??2))}reset(){super.reset(),this._cache.resetDepthCullingState()}apply(){}}class oU{static IsExternalTexture(e){return void 0!==e.underlyingResource}getClassName(){return"ExternalTexture"}get underlyingResource(){return this._video}constructor(e){this.useMipMaps=!1,this.type=16,this._video=e,this.uniqueId=zt._Counter++}isReady(){return this._video.readyState>=this._video.HAVE_CURRENT_DATA}dispose(){}}let Qre=(()=>{class r{get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatTextures(){return this._numFloatTextures>0}constructor(){this.uniqueId=r._Counter++,this.updateId=0,this.reset()}reset(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatTextures=0,this._numExternalTextures=0}setSampler(t,i){let s=this.samplers[t],n=-1;s?n=s.hashCode:this.samplers[t]=s={sampler:i,hashCode:0},s.sampler=i,s.hashCode=i?xh.GetSamplerHashCode(i):0;const o=n!==s.hashCode;o&&this.updateId++,this.isDirty||(this.isDirty=o)}setTexture(t,i){var s,n,o;let a=this.textures[t],l=-1;a?l=null!==(n=null===(s=a.texture)||void 0===s?void 0:s.uniqueId)&&void 0!==n?n:-1:this.textures[t]=a={texture:i,isFloatTexture:!1,isExternalTexture:!1},a.isExternalTexture&&this._numExternalTextures--,a.isFloatTexture&&this._numFloatTextures--,i?(a.isFloatTexture=1===i.type,a.isExternalTexture=oU.IsExternalTexture(i),a.isFloatTexture&&this._numFloatTextures++,a.isExternalTexture&&this._numExternalTextures++):(a.isFloatTexture=!1,a.isExternalTexture=!1),a.texture=i;const c=l!==(null!==(o=i?.uniqueId)&&void 0!==o?o:-1);c&&this.updateId++,this.isDirty||(this.isDirty=c)}}return r._Counter=0,r})(),Zre=(()=>{class r{isDirty(t){return this._isDirty||this._materialContextUpdateId!==t}resetIsDirty(t){this._isDirty=!1,this._materialContextUpdateId=t}get useInstancing(){return this._useInstancing}set useInstancing(t){this._useInstancing!==t&&(t?(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(40,ei.CopyDst|ei.Indirect),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0):(this.indirectDrawBuffer&&this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this._useInstancing=t,this._currentInstanceCount=-1)}constructor(t){this._bufferManager=t,this.uniqueId=r._Counter++,this._useInstancing=!1,this._currentInstanceCount=0,this.reset()}reset(){this.buffers={},this._isDirty=!0,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0}setBuffer(t,i){var s;this._isDirty||(this._isDirty=i?.uniqueId!==(null===(s=this.buffers[t])||void 0===s?void 0:s.uniqueId)),this.buffers[t]=i}setIndirectData(t,i,s){i===this._currentInstanceCount||!this.indirectDrawBuffer||!this._indirectDrawData||(this._currentInstanceCount=i,this._indirectDrawData[0]=t,this._indirectDrawData[1]=i,this._indirectDrawData[2]=s,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20))}dispose(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0}}return r._Counter=0,r})();class Wv{constructor(){this.values={}}}class Mi{static get Statistics(){return{totalCreated:Mi.NumBindGroupsCreatedTotal,lastFrameCreated:Mi.NumBindGroupsCreatedLastFrame,lookupLastFrame:Mi.NumBindGroupsLookupLastFrame,noLookupLastFrame:Mi.NumBindGroupsNoLookupLastFrame}}constructor(e,t,i){this.disabled=!1,this._device=e,this._cacheSampler=t,this._engine=i}endFrame(){Mi.NumBindGroupsCreatedLastFrame=Mi._NumBindGroupsCreatedCurrentFrame,Mi.NumBindGroupsLookupLastFrame=Mi._NumBindGroupsLookupCurrentFrame,Mi.NumBindGroupsNoLookupLastFrame=Mi._NumBindGroupsNoLookupCurrentFrame,Mi._NumBindGroupsCreatedCurrentFrame=0,Mi._NumBindGroupsLookupCurrentFrame=0,Mi._NumBindGroupsNoLookupCurrentFrame=0}getBindGroups(e,t,i){var s,n,o,a,l,c,h,u,d,f;let p,_=Mi._Cache;const m=this.disabled||i.forceBindGroupCreation;if(!m){if(!t.isDirty(i.updateId)&&!i.isDirty)return Mi._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(const b of e.shaderProcessingContext.bufferNames){const y=null!==(n=null===(s=t.buffers[b])||void 0===s?void 0:s.uniqueId)&&void 0!==n?n:0;let T=_.values[y];T||(T=new Wv,_.values[y]=T),_=T}for(const b of e.shaderProcessingContext.samplerNames){const y=null!==(a=null===(o=i.samplers[b])||void 0===o?void 0:o.hashCode)&&void 0!==a?a:0;let T=_.values[y];T||(T=new Wv,_.values[y]=T),_=T}for(const b of e.shaderProcessingContext.textureNames){const y=null!==(h=null===(c=null===(l=i.textures[b])||void 0===l?void 0:l.texture)||void 0===c?void 0:c.uniqueId)&&void 0!==h?h:0;let T=_.values[y];T||(T=new Wv,_.values[y]=T),_=T}p=_.bindGroups}if(t.resetIsDirty(i.updateId),i.isDirty=!1,p)return t.bindGroups=p,Mi._NumBindGroupsLookupCurrentFrame++,p;p=[],t.bindGroups=p,m||(_.bindGroups=p),Mi.NumBindGroupsCreatedTotal++,Mi._NumBindGroupsCreatedCurrentFrame++;const g=e.bindGroupLayouts;for(let b=0;b<e.shaderProcessingContext.bindGroupLayoutEntries.length;b++){const y=e.shaderProcessingContext.bindGroupLayoutEntries[b],T=e.shaderProcessingContext.bindGroupEntries[b];for(let S=0;S<y.length;S++){const C=e.shaderProcessingContext.bindGroupLayoutEntries[b][S],D=e.shaderProcessingContext.bindGroupLayoutEntryInfo[b][C.binding],P=null!==(u=D.nameInArrayOfTexture)&&void 0!==u?u:D.name;if(C.sampler){const M=i.samplers[P];if(M){const w=M.sampler;if(!w){this._engine.dbgSanityChecks&&V.Error(`Trying to bind a null sampler! entry=${JSON.stringify(C)}, name=${P}, bindingInfo=${JSON.stringify(M,(k,X)=>"texture"===k?"<no dump>":X)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}T[S].resource=this._cacheSampler.getSampler(w,!1,M.hashCode)}else V.Error(`Sampler "${P}" could not be bound. entry=${JSON.stringify(C)}, materialContext=${JSON.stringify(i,(w,k)=>"texture"===w||"sampler"===w?"<no dump>":k)}`,50)}else if(C.texture||C.storageTexture){const M=i.textures[P];if(M){if(this._engine.dbgSanityChecks&&null===M.texture){V.Error(`Trying to bind a null texture! entry=${JSON.stringify(C)}, bindingInfo=${JSON.stringify(M,(k,X)=>"texture"===k?"<no dump>":X)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const w=M.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!w||C.texture&&!w.view||C.storageTexture&&!w.viewForWriting)){V.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(C)}, name=${P}, bindingInfo=${JSON.stringify(M,(k,X)=>"texture"===k?"<no dump>":X)}, isReady=${null===(d=M.texture)||void 0===d?void 0:d.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}T[S].resource=C.storageTexture?w.viewForWriting:w.view}else V.Error(`Texture "${P}" could not be bound. entry=${JSON.stringify(C)}, materialContext=${JSON.stringify(i,(w,k)=>"texture"===w||"sampler"===w?"<no dump>":k)}`,50)}else if(C.externalTexture){const M=i.textures[P];if(M){if(this._engine.dbgSanityChecks&&null===M.texture){V.Error(`Trying to bind a null external texture! entry=${JSON.stringify(C)}, name=${P}, bindingInfo=${JSON.stringify(M,(k,X)=>"texture"===k?"<no dump>":X)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const w=M.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!w){V.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(C)}, name=${P}, bindingInfo=${JSON.stringify(M,(k,X)=>"texture"===k?"<no dump>":X)}, isReady=${null===(f=M.texture)||void 0===f?void 0:f.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}T[S].resource=this._device.importExternalTexture({source:w})}else V.Error(`Texture "${P}" could not be bound. entry=${JSON.stringify(C)}, materialContext=${JSON.stringify(i,(w,k)=>"texture"===w||"sampler"===w?"<no dump>":k)}`,50)}else if(C.buffer){const M=t.buffers[P];M?(T[S].resource.buffer=M.underlyingResource,T[S].resource.size=M.capacity):V.Error(`Can't find buffer "${P}". entry=${JSON.stringify(C)}, buffers=${JSON.stringify(t.buffers)}, drawContext.uniqueId=${t.uniqueId}`,50)}}p[b]=this._device.createBindGroup({layout:g[b],entries:T})}return p}}Mi.NumBindGroupsCreatedTotal=0,Mi.NumBindGroupsCreatedLastFrame=0,Mi.NumBindGroupsLookupLastFrame=0,Mi.NumBindGroupsNoLookupLastFrame=0,Mi._Cache=new Wv,Mi._NumBindGroupsCreatedCurrentFrame=0,Mi._NumBindGroupsLookupCurrentFrame=0,Mi._NumBindGroupsNoLookupCurrentFrame=0;j.ShadersStore.clearQuadVertexShader="uniform float depthValue;\nconst vec2 pos[4]={\nvec2(-1.0,1.0),\nvec2(1.0,1.0),\nvec2(-1.0,-1.0),\nvec2(1.0,-1.0)\n};\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\ngl_Position=vec4(pos[gl_VertexID],depthValue,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}\n";j.ShadersStore.clearQuadPixelShader="uniform vec4 color;\nvoid main() {\ngl_FragColor=color;\n}\n";class Jre{setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e)}setMRTAttachments(e,t,i){this._cacheRenderPipeline.setMRT(t,i),this._cacheRenderPipeline.setMRTAttachments(e)}constructor(e,t,i){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new ml(this._device,i,!t._caps.textureFloatLinearFiltering),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"])}clear(e,t,i,s,n=1){var o,a;let l,h,c=null;const u=!!this._engine._currentRenderTarget;if(e)l=e;else{let b=0;this._keyTemp.length=0;for(let T=0;T<this._cacheRenderPipeline.colorFormats.length;++T)this._keyTemp[b++]=Fp[null!==(o=this._cacheRenderPipeline.colorFormats[T])&&void 0!==o?o:""];const y=Fp[null!==(a=this._depthTextureFormat)&&void 0!==a?a:0];if(this._keyTemp[b]=(t?t.r+256*t.g+256*t.b*256+256*t.a*256*256:0)+(i?2**32:0)+(s?2**33:0)+(this._engine.useReverseDepthBuffer?2**34:0)+(u?2**35:0)+(n>1?2**36:0)+y*2**37,h=this._keyTemp.join("_"),c=this._bundleCache[h],c)return c;l=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:n})}this._cacheRenderPipeline.setDepthWriteEnabled(!!i),this._cacheRenderPipeline.setStencilEnabled(!!s&&!!this._depthTextureFormat&&vi.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(s?255:0),this._cacheRenderPipeline.setStencilCompare(s?519:512),this._cacheRenderPipeline.setStencilPassOp(s?7681:7680),this._cacheRenderPipeline.setWriteMask(t?15:0);const d=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,n),f=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),f.uniformBuffer.update();const p=u?this._engine._ubInvertY:this._engine._ubDontInvertY,_=f.uniformBuffer.getBuffer(),m=_.uniqueId+"-"+p.uniqueId;let g=this._bindGroups[m];if(!g){const b=f.bindGroupLayouts;g=this._bindGroups[m]=[],g.push(this._device.createBindGroup({layout:b[0],entries:[]})),Np._SimplifiedKnownBindings||g.push(this._device.createBindGroup({layout:b[1],entries:[]})),g.push(this._device.createBindGroup({layout:b[Np._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:p.underlyingResource,size:p.capacity}},{binding:1,resource:{buffer:_.underlyingResource,size:_.capacity}}]}))}l.setPipeline(d);for(let b=0;b<g.length;++b)l.setBindGroup(b,g[b]);return l.draw(4,1,0,0),e||(c=l.finish(),this._bundleCache[h]=c),c}}class _C{constructor(e,t,i,s){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(i),this.h=Math.floor(s)}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new _C(this.x,this.y,this.w,this.h)}}class Lp{constructor(e,t,i,s){this.x=e,this.y=t,this.w=i,this.h=s}run(e){e.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new Lp(this.x,this.y,this.w,this.h)}}class Bp{constructor(e){this.ref=e}run(e){e.setStencilReference(this.ref)}clone(){return new Bp(this.ref)}}class mC{constructor(e){this.color=e}run(e){e.setBlendConstant(this.color)}clone(){return new mC(this.color)}}class gC{constructor(e){this.query=e}run(e){e.beginOcclusionQuery(this.query)}clone(){return new gC(this.query)}}class vC{constructor(){}run(e){e.endOcclusionQuery()}clone(){return new vC}}class bC{constructor(){this.bundles=[]}run(e){e.executeBundles(this.bundles)}clone(){const e=new bC;return e.bundles=this.bundles,e}}class Xv{constructor(e){this.numDrawCalls=0,this._device=e,this._list=new Array(10),this._listLength=0}addBundle(e){if(!this._currentItemIsBundle){const t=new bC;this._list[this._listLength++]=t,this._currentBundleList=t.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1}getBundleEncoder(e,t,i){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:i})),this._bundleEncoder}close(){this._finishBundle()}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e)}reset(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0}clone(){this.close();const e=new Xv(this._device);e._list=new Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}}class uU{get querySet(){return this._querySet}constructor(e,t,i,s,n=!0){this._dstBuffers=[],this._device=i,this._bufferManager=s,this._count=e,this._canUseMultipleBuffers=n,this._querySet=i.createQuerySet({type:t,count:e}),this._queryBuffer=s.createRawBuffer(8*e,ei.QueryResolve|ei.CopySrc),n||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,ei.MapRead|ei.CopyDst))}_getBuffer(e,t){if(!this._canUseMultipleBuffers&&0===this._dstBuffers.length)return null;const i=this._device.createCommandEncoder();let s;return 0===this._dstBuffers.length?s=this._bufferManager.createRawBuffer(8*this._count,ei.MapRead|ei.CopyDst):(s=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),i.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),i.copyBufferToBuffer(this._queryBuffer,0,s,0,8*t),this._device.queue.submit([i.finish()]),s}readValues(e=0,t=1){var i=this;return Qt(function*(){const s=i._getBuffer(e,t);if(null===s)return null;yield s.mapAsync(ac.Read);const n=new BigUint64Array(s.getMappedRange()).slice();return s.unmap(),i._dstBuffers[i._dstBuffers.length]=s,n})()}readValue(e=0){var t=this;return Qt(function*(){const i=t._getBuffer(e,1);if(null===i)return null;yield i.mapAsync(ac.Read);const s=new BigUint64Array(i.getMappedRange()),n=Number(s[0]);return i.unmap(),t._dstBuffers[t._dstBuffers.length]=i,n})()}readTwoValuesAndSubtract(e=0){var t=this;return Qt(function*(){const i=t._getBuffer(e,2);if(null===i)return null;yield i.mapAsync(ac.Read);const s=new BigUint64Array(i.getMappedRange()),n=Number(s[1]-s[0]);return i.unmap(),t._dstBuffers[t._dstBuffers.length]=i,n})()}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])}}class ene{get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}constructor(e,t){this._enabled=!1,this._gpuFrameTimeCounter=new eh,this._measureDurationState=0,this._device=e,this._bufferManager=t}get enable(){return this._enabled}set enable(e){this._enabled!==e&&(this._enabled=e,this._measureDurationState=0,e?this._measureDuration=new tne(this._device,this._bufferManager):this._measureDuration.dispose())}startFrame(e){this._enabled&&0===this._measureDurationState&&(this._measureDuration.start(e),this._measureDurationState=1)}endFrame(e){1===this._measureDurationState&&(this._measureDurationState=2,this._measureDuration.stop(e).then(t=>{null!==t&&t>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(t,!0)),this._measureDurationState=0}))}}class tne{constructor(e,t){this._querySet=new uU(2,wp.Timestamp,e,t)}start(e){e.writeTimestamp(this._querySet.querySet,0)}stop(e){var t=this;return Qt(function*(){return e.writeTimestamp(t._querySet.querySet,1),t._querySet.readTwoValuesAndSubtract(0)})()}dispose(){this._querySet.dispose()}}class ine{get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}get canBeginQuery(){switch(this._engine._getCurrentRenderPassIndex()){case 0:return void 0!==this._engine._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet;case 1:return void 0!==this._engine._rttRenderPassWrapper.renderPassDescriptor.occlusionQuerySet}return!1}constructor(e,t,i,s=50,n=100){this._availableIndices=[],this._engine=e,this._device=t,this._bufferManager=i,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=n,this._allocateNewIndices(s)}createQuery(){0===this._availableIndices.length&&this._allocateNewIndices();const e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length-1]=e}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){var t,i;return Number(null!==(i=null===(t=this._lastBuffer)||void 0===t?void 0:t[e])&&void 0!==i?i:-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then(e=>{this._lastBuffer=e}))}_allocateNewIndices(e){e=e??this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new uU(this._currentTotalIndices,wp.Occlusion,this._device,this._bufferManager,!1)}_delayQuerySetDispose(){const e=this._querySet;e&&setTimeout(()=>e.dispose,1e3)}dispose(){var e;null===(e=this._querySet)||void 0===e||e.dispose(),this._availableIndices.length=0}}let sne=(()=>{class r{constructor(){this._twgsl=null}initTwgsl(t){var i=this;return Qt(function*(){return t=t||{},(t={...r._TWgslDefaultOptions,...t}).twgsl?(i._twgsl=t.twgsl,Promise.resolve()):(t.jsPath&&t.wasmPath&&(qi()?yield q.LoadScriptAsync(t.jsPath):importScripts(t.jsPath)),self.twgsl?(i._twgsl=yield self.twgsl(t.wasmPath),Promise.resolve()):Promise.reject("twgsl is not available."))})()}convertSpirV2WGSL(t){const i=this._twgsl.convertSpirV2WGSL(t);return r.ShowWGSLShaderCode&&(console.log(i),console.log("***********************************************")),"diagnostic(off, derivative_uniformity);\n"+i}}return r._TWgslDefaultOptions={jsPath:"https://preview.babylonjs.com/twgsl/twgsl.js",wasmPath:"https://preview.babylonjs.com/twgsl/twgsl.wasm"},r.ShowWGSLShaderCode=!1,r})();class rne{constructor(e,t,i,s){this._record=!1,this._play=!1,this._mainPassBundleList=[],this._enabled=!1,this._engine=e,this._mode=t,this._bundleList=i,this._bundleListRenderTarget=s}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._mainPassBundleList.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e}endMainRenderPass(){this._record&&this._mainPassBundleList.push(this._bundleList.clone())}endRenderTargetPass(e,t){var i,s,n,o;if(this._play)null===(s=null===(i=t._bundleLists)||void 0===i?void 0:i[t._currentLayer])||void 0===s||s.run(e),1===this._mode&&this._engine._reportDrawCall(null===(o=null===(n=t._bundleLists)||void 0===n?void 0:n[t._currentLayer])||void 0===o?void 0:o.numDrawCalls);else{if(!this._record)return!1;t._bundleLists||(t._bundleLists=[]),t._bundleLists[t._currentLayer]=this._bundleListRenderTarget.clone(),t._bundleLists[t._currentLayer].run(e),this._bundleListRenderTarget.reset()}return!0}endFrame(e){if(this._record&&(this._mainPassBundleList.push(this._bundleList.clone()),this._record=!1,this._play=!0,this._mode=this._modeSaved),null!==e&&this._play)for(let t=0;t<this._mainPassBundleList.length;++t)this._mainPassBundleList[t].run(e),1===this._mode&&this._engine._reportDrawCall(this._mainPassBundleList[t].numDrawCalls)}reset(){this.enabled=!1,this.enabled=!0}}let je=(()=>{class r extends ee{get snapshotRenderingMode(){return this._snapshotRendering.mode}set snapshotRenderingMode(t){this._snapshotRendering.mode=t}snapshotRenderingReset(){this._snapshotRendering.reset()}get snapshotRendering(){return this._snapshotRendering.enabled}set snapshotRendering(t){this._snapshotRendering.enabled=t}get disableCacheSamplers(){return!!this._cacheSampler&&this._cacheSampler.disabled}set disableCacheSamplers(t){this._cacheSampler&&(this._cacheSampler.disabled=t)}get disableCacheRenderPipelines(){return!!this._cacheRenderPipeline&&this._cacheRenderPipeline.disabled}set disableCacheRenderPipelines(t){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=t)}get disableCacheBindGroups(){return!!this._cacheBindGroups&&this._cacheBindGroups.disabled}set disableCacheBindGroups(t){this._cacheBindGroups&&(this._cacheBindGroups.disabled=t)}static get IsSupportedAsync(){return navigator.gpu?navigator.gpu.requestAdapter().then(t=>!!t,()=>!1).catch(()=>!1):Promise.resolve(!1)}static get IsSupported(){return V.Warn("You must call IsSupportedAsync for WebGPU!"),!1}get supportsUniformBuffers(){return!0}get supportedExtensions(){return this._adapterSupportedExtensions}get enabledExtensions(){return this._deviceEnabledExtensions}get description(){return this.name+this.version}get version(){return 1}getInfo(){return{vendor:"unknown vendor",renderer:"unknown renderer",version:"unknown version"}}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(t){this._compatibilityMode=t}get currentSampleCount(){return this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount}static CreateAsync(t,i={}){const s=new r(t,i);return new Promise(n=>{s.initAsync(i.glslangOptions,i.twgslOptions).then(()=>n(s))})}constructor(t,i={}){var s,n;super(null,null===(s=i.antialias)||void 0===s||s,i),this._uploadEncoderDescriptor={label:"upload"},this._renderEncoderDescriptor={label:"render"},this._renderTargetEncoderDescriptor={label:"renderTarget"},this._clearDepthValue=1,this._clearReverseDepthValue=0,this._clearStencilValue=0,this._defaultSampleCount=4,this._glslang=null,this._tintWASM=null,this._compiledComputeEffects={},this._counters={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.countersLastFrame={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.numMaxUncapturedErrors=20,this._commandBuffers=[null,null,null],this._currentRenderPass=null,this._mainRenderPassWrapper=new rU,this._rttRenderPassWrapper=new rU,this._pendingDebugCommands=[],this._onAfterUnbindFrameBufferObservable=new z,this._currentOverrideVertexBuffers=null,this._currentIndexBuffer=null,this._colorWriteLocal=!0,this._forceEnableEffect=!1,this.dbgShowShaderCode=!1,this.dbgSanityChecks=!0,this.dbgVerboseLogsForFirstFrames=!1,this.dbgVerboseLogsNumFrames=10,this.dbgLogIfNotDrawWrapper=!0,this.dbgShowEmptyEnableEffectCalls=!0,this.isNDCHalfZRange=!0,this.hasOriginBottomLeft=!1,this._viewportsCurrent=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],this._scissorsCurrent=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],this._scissorCached={x:0,y:0,z:0,w:0},this._stencilRefsCurrent=[-1,-1],this._blendColorsCurrent=[[null,null,null,null],[null,null,null,null]],this._name="WebGPU",i.deviceDescriptor=i.deviceDescriptor||{},i.enableGPUDebugMarkers=null!==(n=i.enableGPUDebugMarkers)&&void 0!==n&&n,V.Log(`Babylon.js v${ee.Version} - ${this.description} engine`),navigator.gpu?(i.swapChainFormat=i.swapChainFormat||navigator.gpu.getPreferredCanvasFormat(),this._isWebGPU=!0,this._shaderPlatformName="WEBGPU",this._canvas=t,this._options=i,this._mainPassSampleCount=i.antialias?this._defaultSampleCount:1,this._setupMobileChecks(),this._sharedInit(t),this._shaderProcessor=new Mre,this._shaderProcessorWGSL=new Ore):V.Error("WebGPU is not supported by your browser.")}initAsync(t,i){var s;return this._initGlslang(t??(null===(s=this._options)||void 0===s?void 0:s.glslangOptions)).then(n=>{var o;return this._glslang=n,this._tintWASM=r.UseTWGSL?new sne:null,this._tintWASM?this._tintWASM.initTwgsl(i??(null===(o=this._options)||void 0===o?void 0:o.twgslOptions)).then(()=>navigator.gpu.requestAdapter(this._options),a=>{throw V.Error("Can not initialize twgsl!"),V.Error(a),Error("WebGPU initializations stopped.")}):navigator.gpu.requestAdapter(this._options)},n=>{throw V.Error("Can not initialize glslang!"),V.Error(n),Error("WebGPU initializations stopped.")}).then(n=>{var o;if(n){this._adapter=n,this._adapterSupportedExtensions=[],null===(o=this._adapter.features)||void 0===o||o.forEach(l=>this._adapterSupportedExtensions.push(l));const a=this._options.deviceDescriptor;if(a?.requiredFeatures){const l=a.requiredFeatures,c=[];for(const h of l)-1!==this._adapterSupportedExtensions.indexOf(h)&&c.push(h);a.requiredFeatures=c}return this._adapter.requestDevice(this._options.deviceDescriptor)}throw"Could not retrieve a WebGPU adapter (adapter is null)."}).then(n=>{var o,a;this._device=n,this._deviceEnabledExtensions=[],null===(o=this._device.features)||void 0===o||o.forEach(c=>this._deviceEnabledExtensions.push(c));let l=-1;this._device.addEventListener("uncapturederror",c=>{++l<this.numMaxUncapturedErrors?V.Warn(`WebGPU uncaptured error (${l+1}): ${c.error} - ${c.error.message}`):l++===this.numMaxUncapturedErrors&&V.Warn(`WebGPU uncaptured error: too many warnings (${this.numMaxUncapturedErrors}), no more warnings will be reported to the console for this engine.`)}),this._doNotHandleContextLost||null===(a=this._device.lost)||void 0===a||a.then(c=>{this._contextWasLost=!0,V.Warn("WebGPU context lost. "+c),this.onContextLostObservable.notifyObservers(this),this._restoreEngineAfterContextLost(this.initAsync.bind(this))})},n=>{V.Error("Could not retrieve a WebGPU device."),V.Error(n)}).then(()=>{this._bufferManager=new pC(this._device),this._textureHelper=new vi(this._device,this._glslang,this._tintWASM,this._bufferManager),this._cacheSampler=new xh(this._device),this._cacheBindGroups=new Mi(this._device,this._cacheSampler,this),this._timestampQuery=new ene(this._device,this._bufferManager),this._occlusionQuery=this._device.createQuerySet?new ine(this,this._device,this._bufferManager):void 0,this._bundleList=new Xv(this._device),this._bundleListRenderTarget=new Xv(this._device),this._snapshotRendering=new rne(this,this._snapshotRenderingMode,this._bundleList,this._bundleListRenderTarget),this._ubInvertY=this._bufferManager.createBuffer(new Float32Array([-1,0]),ei.Uniform|ei.CopyDst),this._ubDontInvertY=this._bufferManager.createBuffer(new Float32Array([1,0]),ei.Uniform|ei.CopyDst),this.dbgVerboseLogsForFirstFrames&&void 0===this._count&&(this._count=0,console.log("%c frame #"+this._count+" - begin","background: #ffff00")),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._renderTargetEncoder=this._device.createCommandEncoder(this._renderTargetEncoderDescriptor),this._emptyVertexBuffer=new A(this,[0],"",!1,!1,1,!1,0,1),this._initializeLimits(),this._cacheRenderPipeline=new ml(this._device,this._emptyVertexBuffer,!this._caps.textureFloatLinearFiltering),this._depthCullingState=new Kre(this._cacheRenderPipeline),this._stencilStateComposer=new $re(this._cacheRenderPipeline),this._stencilStateComposer.stencilGlobal=this._stencilState,this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=515,this._depthCullingState.depthMask=!0,this._textureHelper.setCommandEncoder(this._uploadEncoder),this._clearQuad=new Jre(this._device,this,this._emptyVertexBuffer),this._defaultDrawContext=this.createDrawContext(),this._currentDrawContext=this._defaultDrawContext,this._defaultMaterialContext=this.createMaterialContext(),this._currentMaterialContext=this._defaultMaterialContext,this._initializeContextAndSwapChain(),this._initializeMainAttachments(),this.resize()}).catch(n=>{V.Error("Can not create WebGPU Device and/or context."),V.Error(n),console.trace&&console.trace()})}_initGlslang(t){return t=t||{},(t={...r._GLSLslangDefaultOptions,...t}).glslang?Promise.resolve(t.glslang):self.glslang?self.glslang(t.wasmPath):t.jsPath&&t.wasmPath?qi()?q.LoadScriptAsync(t.jsPath).then(()=>self.glslang(t.wasmPath)):(importScripts(t.jsPath),self.glslang(t.wasmPath)):Promise.reject("gslang is not available.")}_initializeLimits(){this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:8192,maxCubemapTextureSize:2048,maxRenderTextureSize:8192,maxVertexAttribs:16,maxVaryingVectors:15,maxFragmentUniformVectors:1024,maxVertexUniformVectors:1024,standardDerivatives:!0,astc:this._deviceEnabledExtensions.indexOf(oc.TextureCompressionASTC)>=0||void 0,s3tc:this._deviceEnabledExtensions.indexOf(oc.TextureCompressionBC)>=0||void 0,pvrtc:null,etc1:null,etc2:this._deviceEnabledExtensions.indexOf(oc.TextureCompressionETC2)>=0||void 0,bptc:this._deviceEnabledExtensions.indexOf(oc.TextureCompressionBC)>=0||void 0,maxAnisotropy:4,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,textureFloat:!0,textureFloatLinearFiltering:!1,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:typeof BigUint64Array<"u"&&-1!==this.enabledExtensions.indexOf(oc.TimestampQuery)||void 0,supportOcclusionQuery:typeof BigUint64Array<"u",canUseTimestampForTimerQuery:!0,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!0,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!0,texture2DArrayMaxLayerCount:2048},this._caps.parallelShaderCompile=null,this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!0,trackUbosInFrame:!0,checkUbosContentBeforeUpload:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!0,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!0,supportRenderPasses:!0,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}}_initializeContextAndSwapChain(){this._context=this._canvas.getContext("webgpu"),this._configureContext(),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new zv],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat}_initializeMainAttachments(){if(!this._bufferManager)return;this.flushFramebuffer(!1),this._mainTextureExtends={width:this.getRenderWidth(),height:this.getRenderHeight(),depthOrArrayLayers:1};const t=new Float32Array([this.getRenderHeight()]);let i;if(this._bufferManager.setSubData(this._ubInvertY,4,t),this._bufferManager.setSubData(this._ubDontInvertY,4,t),this._options.antialias){const o={label:"Texture_MainColor_antialiasing",size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:cl.E2d,format:this._options.swapChainFormat,usage:ci.RenderAttachment};this._mainTexture&&this._textureHelper.releaseTexture(this._mainTexture),this._mainTexture=this._device.createTexture(o),i=[{view:this._mainTexture.createView(),clearValue:new Te(0,0,0,1),loadOp:ns.Clear,storeOp:gn.Store}]}else i=[{view:void 0,clearValue:new Te(0,0,0,1),loadOp:ns.Clear,storeOp:gn.Store}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?N.Depth24PlusStencil8:N.Depth32Float,this._setDepthTextureFormat(this._mainRenderPassWrapper);const s={label:"Texture_MainDepthStencil",size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:cl.E2d,format:this._mainRenderPassWrapper.depthTextureFormat,usage:ci.RenderAttachment};this._depthTexture&&this._textureHelper.releaseTexture(this._depthTexture),this._depthTexture=this._device.createTexture(s);const n={view:this._depthTexture.createView(),depthClearValue:this._clearDepthValue,depthLoadOp:ns.Clear,depthStoreOp:gn.Store,stencilClearValue:this._clearStencilValue,stencilLoadOp:this.isStencilEnable?ns.Clear:void 0,stencilStoreOp:this.isStencilEnable?gn.Store:void 0};this._mainRenderPassWrapper.renderPassDescriptor={colorAttachments:i,depthStencilAttachment:n}}_configureContext(){this._context.configure({device:this._device,format:this._options.swapChainFormat,usage:ci.RenderAttachment|ci.CopySrc,alphaMode:this.premultipliedAlpha?Op.Premultiplied:Op.Opaque})}setSize(t,i,s=!1){return!!super.setSize(t,i,s)&&(this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - setSize called -",t,i)),this._initializeMainAttachments(),this.snapshotRendering&&this.snapshotRenderingReset(),!0)}_getShaderProcessor(t){return t===ui.WGSL?this._shaderProcessorWGSL:this._shaderProcessor}_getShaderProcessingContext(t){return new Np(t)}applyStates(){this._stencilStateComposer.apply(),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend)}wipeCaches(t){this.preventCacheWipeBetweenFrames&&!t||(this._forceEnableEffect=!0,this._currentIndexBuffer=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),t&&(this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=515,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(!1),this.setColorWrite(!0)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}setColorWrite(t){this._colorWriteLocal=t,this._cacheRenderPipeline.setWriteMask(t?15:0)}getColorWrite(){return this._colorWriteLocal}_resetCurrentViewport(t){this._viewportsCurrent[t].x=0,this._viewportsCurrent[t].y=0,this._viewportsCurrent[t].w=0,this._viewportsCurrent[t].h=0,1===t&&(this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0)}_mustUpdateViewport(t){const i=t===this._mainRenderPassWrapper.renderPass?0:1,l=this._viewportsCurrent[i].x!==this._viewportCached.x||this._viewportsCurrent[i].y!==this._viewportCached.y||this._viewportsCurrent[i].w!==this._viewportCached.z||this._viewportsCurrent[i].h!==this._viewportCached.w;return l&&(this._viewportsCurrent[i].x=this._viewportCached.x,this._viewportsCurrent[i].y=this._viewportCached.y,this._viewportsCurrent[i].w=this._viewportCached.z,this._viewportsCurrent[i].h=this._viewportCached.w),l}_applyViewport(t){let i=Math.floor(this._viewportCached.y);const s=Math.floor(this._viewportCached.w);this._currentRenderTarget||(i=this.getRenderHeight()-i-s),t.setViewport(Math.floor(this._viewportCached.x),i,Math.floor(this._viewportCached.z),s,0,1),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - viewport applied - (",this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w,") current pass is main pass="+(t===this._mainRenderPassWrapper.renderPass)))}_viewport(t,i,s,n){this._viewportCached.x=t,this._viewportCached.y=i,this._viewportCached.z=s,this._viewportCached.w=n}_resetCurrentScissor(t){this._scissorsCurrent[t].x=0,this._scissorsCurrent[t].y=0,this._scissorsCurrent[t].w=0,this._scissorsCurrent[t].h=0}_mustUpdateScissor(t){const i=t===this._mainRenderPassWrapper.renderPass?0:1,l=this._scissorsCurrent[i].x!==this._scissorCached.x||this._scissorsCurrent[i].y!==this._scissorCached.y||this._scissorsCurrent[i].w!==this._scissorCached.z||this._scissorsCurrent[i].h!==this._scissorCached.w;return l&&(this._scissorsCurrent[i].x=this._scissorCached.x,this._scissorsCurrent[i].y=this._scissorCached.y,this._scissorsCurrent[i].w=this._scissorCached.z,this._scissorsCurrent[i].h=this._scissorCached.w),l}_applyScissor(t){t.setScissorRect(this._scissorCached.x,this._currentRenderTarget?this._scissorCached.y:this.getRenderHeight()-this._scissorCached.w-this._scissorCached.y,this._scissorCached.z,this._scissorCached.w),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - scissor applied - (",this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w,") current pass is main pass="+(t===this._mainRenderPassWrapper.renderPass)))}_scissorIsActive(){return 0!==this._scissorCached.x||0!==this._scissorCached.y||0!==this._scissorCached.z||0!==this._scissorCached.w}enableScissor(t,i,s,n){this._scissorCached.x=t,this._scissorCached.y=i,this._scissorCached.z=s,this._scissorCached.w=n}disableScissor(){this._scissorCached.x=0,this._scissorCached.y=0,this._scissorCached.z=0,this._scissorCached.w=0,this._resetCurrentScissor(0),this._resetCurrentScissor(1)}_resetCurrentStencilRef(t){this._stencilRefsCurrent[t]=-1}_mustUpdateStencilRef(t){const i=t===this._mainRenderPassWrapper.renderPass?0:1,s=this._stencilStateComposer.funcRef!==this._stencilRefsCurrent[i];return s&&(this._stencilRefsCurrent[i]=this._stencilStateComposer.funcRef),s}_applyStencilRef(t){var i;t.setStencilReference(null!==(i=this._stencilStateComposer.funcRef)&&void 0!==i?i:0)}_resetCurrentColorBlend(t){this._blendColorsCurrent[t][0]=this._blendColorsCurrent[t][1]=this._blendColorsCurrent[t][2]=this._blendColorsCurrent[t][3]=null}_mustUpdateBlendColor(t){const i=t===this._mainRenderPassWrapper.renderPass?0:1,s=this._alphaState._blendConstants,n=s[0]!==this._blendColorsCurrent[i][0]||s[1]!==this._blendColorsCurrent[i][1]||s[2]!==this._blendColorsCurrent[i][2]||s[3]!==this._blendColorsCurrent[i][3];return n&&(this._blendColorsCurrent[i][0]=s[0],this._blendColorsCurrent[i][1]=s[1],this._blendColorsCurrent[i][2]=s[2],this._blendColorsCurrent[i][3]=s[3]),n}_applyBlendColor(t){t.setBlendConstant(this._alphaState._blendConstants)}clear(t,i,s,n=!1){t&&void 0===t.a&&(t.a=1);const o=this._scissorIsActive();this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - clear called - backBuffer=",i," depth=",s," stencil=",n," scissor is active=",o)),this._currentRenderTarget?o?(this._rttRenderPassWrapper.renderPass||this._startRenderTargetRenderPass(this._currentRenderTarget,!1,i?t:null,s,n),this.compatibilityMode?this._applyScissor(this._currentRenderPass):this._bundleListRenderTarget.addItem(new Lp(this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w)),this._clearFullQuad(i?t:null,s,n)):(this._currentRenderPass&&this._endRenderTargetRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,!0,i?t:null,s,n)):((!this._mainRenderPassWrapper.renderPass||!o)&&this._startMainRenderPass(!o,i?t:null,s,n),o&&(this.compatibilityMode?this._applyScissor(this._currentRenderPass):this._bundleList.addItem(new Lp(this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w)),this._clearFullQuad(i?t:null,s,n)))}_clearFullQuad(t,i,s){var n,o,a;const l=this.compatibilityMode?this._getCurrentRenderPass():null,h=0===this._getCurrentRenderPassIndex()?this._bundleList:this._bundleListRenderTarget;this._clearQuad.setColorFormat(this._colorFormat),this._clearQuad.setDepthStencilFormat(this._depthTextureFormat),this._clearQuad.setMRTAttachments(null!==(n=this._cacheRenderPipeline.mrtAttachments)&&void 0!==n?n:[],null!==(o=this._cacheRenderPipeline.mrtTextureArray)&&void 0!==o?o:[],this._cacheRenderPipeline.mrtTextureCount),this.compatibilityMode?l.setStencilReference(this._clearStencilValue):h.addItem(new Bp(this._clearStencilValue));const u=this._clearQuad.clear(l,t,i,s,this.currentSampleCount);this.compatibilityMode?this._applyStencilRef(l):(h.addBundle(u),h.addItem(new Bp(null!==(a=this._stencilStateComposer.funcRef)&&void 0!==a?a:0)),this._reportDrawCall())}createVertexBuffer(t){let i;return i=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,this._bufferManager.createBuffer(i,ei.Vertex|ei.CopyDst)}createDynamicVertexBuffer(t){return this.createVertexBuffer(t)}createIndexBuffer(t){let s,i=!0;t instanceof Uint32Array||t instanceof Int32Array?s=t:t instanceof Uint16Array?(s=t,i=!1):t.length>65535?s=new Uint32Array(t):(s=new Uint16Array(t),i=!1);const n=this._bufferManager.createBuffer(s,ei.Index|ei.CopyDst);return n.is32Bits=i,n}_createBuffer(t,i){let s;s=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t;let n=0;return 1&i&&(n|=ei.CopySrc),2&i&&(n|=ei.CopyDst),4&i&&(n|=ei.Uniform),8&i&&(n|=ei.Vertex),16&i&&(n|=ei.Index),32&i&&(n|=ei.Storage),this._bufferManager.createBuffer(s,n)}bindBuffersDirectly(){throw"Not implemented on WebGPU"}updateAndBindInstancesBuffer(){throw"Not implemented on WebGPU"}bindBuffers(t,i,s,n){this._currentIndexBuffer=i,this._currentOverrideVertexBuffers=n??null,this._cacheRenderPipeline.setBuffers(t,i,this._currentOverrideVertexBuffers)}_releaseBuffer(t){return this._bufferManager.releaseBuffer(t)}createEffect(t,i,s,n,o,a,l,c,h,u=ui.GLSL){var d;const f=t.vertexElement||t.vertex||t.vertexToken||t.vertexSource||t,p=t.fragmentElement||t.fragment||t.fragmentToken||t.fragmentSource||t,_=this._getGlobalDefines();let m=null!==(d=o??i.defines)&&void 0!==d?d:"";_&&(m+="\n"+_);const g=f+"+"+p+"@"+m;if(this._compiledEffects[g]){const y=this._compiledEffects[g];return l&&y.isReady()&&l(y),y}const b=new Ot(t,i,s,n,this,o,a,l,c,h,g,u);return this._compiledEffects[g]=b,b}_compileRawShaderToSpirV(t,i){return this._glslang.compileGLSL(t,i)}_compileShaderToSpirV(t,i,s,n){return this._compileRawShaderToSpirV(n+(s?s+"\n":"")+t,i)}_getWGSLShader(t,i,s){return(s=s?"//"+s.split("\n").join("\n//")+"\n":"")+t}_createPipelineStageDescriptor(t,i,s){return this._tintWASM&&s===ui.GLSL&&(t=this._tintWASM.convertSpirV2WGSL(t),i=this._tintWASM.convertSpirV2WGSL(i)),{vertexStage:{module:this._device.createShaderModule({code:t}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({code:i}),entryPoint:"main"}}}_compileRawPipelineStageDescriptor(t,i,s){const n=s===ui.GLSL?this._compileRawShaderToSpirV(t,"vertex"):t,o=s===ui.GLSL?this._compileRawShaderToSpirV(i,"fragment"):i;return this._createPipelineStageDescriptor(n,o,s)}_compilePipelineStageDescriptor(t,i,s,n){this.onBeforeShaderCompilationObservable.notifyObservers(this);const o="#version 450\n",a=n===ui.GLSL?this._compileShaderToSpirV(t,"vertex",s,o):this._getWGSLShader(t,"vertex",s),l=n===ui.GLSL?this._compileShaderToSpirV(i,"fragment",s,o):this._getWGSLShader(i,"fragment",s),c=this._createPipelineStageDescriptor(a,l,n);return this.onAfterShaderCompilationObservable.notifyObservers(this),c}createRawShaderProgram(){throw"Not available on WebGPU"}createShaderProgram(){throw"Not available on WebGPU"}inlineShaderCode(t){const i=new Uv(t);return i.debug=!1,i.processCode(),i.code}createPipelineContext(t){return new Are(t,this)}createMaterialContext(){return new Qre}createDrawContext(){return new Zre(this._bufferManager)}_preparePipelineContext(t,i,s,n,o,a,l,c){const h=t,u=h.shaderProcessingContext.shaderLanguage;this.dbgShowShaderCode&&(console.log(c),console.log(i),console.log(s),console.log("***********************************************")),h.sources={fragment:s,vertex:i,rawVertex:o,rawFragment:a},h.stages=n?this._compileRawPipelineStageDescriptor(i,s,u):this._compilePipelineStageDescriptor(i,s,c,u)}getAttributes(t,i){const s=new Array(i.length),n=t;for(let o=0;o<i.length;o++){const l=n.shaderProcessingContext.availableAttributes[i[o]];void 0!==l&&(s[o]=l)}return s}enableEffect(t){if(!t)return;let i=!0;if($i.IsWrapper(t)){if(!t.effect||t.effect===this._currentEffect&&t.materialContext===this._currentMaterialContext&&t.drawContext===this._currentDrawContext&&!this._forceEnableEffect){if(!t.effect&&this.dbgShowEmptyEnableEffectCalls)throw console.error("drawWrapper=",t),"Invalid call to enableEffect: the effect property is empty!";return}if(i=t.effect!==this._currentEffect,this._currentEffect=t.effect,this._currentMaterialContext=t.materialContext,this._currentDrawContext=t.drawContext,this._counters.numEnableDrawWrapper++,!this._currentMaterialContext)throw console.error("drawWrapper=",t),"Invalid call to enableEffect: the materialContext property is empty!"}else i=t!==this._currentEffect,this._currentEffect=t,this._currentMaterialContext=this._defaultMaterialContext,this._currentDrawContext=this._defaultDrawContext,this._counters.numEnableEffects++,this.dbgLogIfNotDrawWrapper&&V.Warn(`enableEffect has been called with an Effect and not a Wrapper! effect.uniqueId=${t.uniqueId}, effect.name=${t.name}, effect.name.vertex=${t.name.vertex}, effect.name.fragment=${t.name.fragment}`,10);this._stencilStateComposer.stencilMaterial=void 0,this._forceEnableEffect=!i&&!this._forceEnableEffect&&this._forceEnableEffect,i&&(this._currentEffect.onBind&&this._currentEffect.onBind(this._currentEffect),this._currentEffect._onBindObservable&&this._currentEffect._onBindObservable.notifyObservers(this._currentEffect))}_releaseEffect(t){this._compiledEffects[t._key]&&(delete this._compiledEffects[t._key],this._deletePipelineContext(t.getPipelineContext()))}releaseEffects(){for(const t in this._compiledEffects){const i=this._compiledEffects[t].getPipelineContext();this._deletePipelineContext(i)}this._compiledEffects={}}_deletePipelineContext(t){t&&t.dispose()}get needPOTTextures(){return!1}_createHardwareTexture(){return new zv}_releaseTexture(t){const i=this._internalTexturesCache.indexOf(t);-1!==i&&this._internalTexturesCache.splice(i,1),this._textureHelper.releaseTexture(t)}_getRGBABufferInternalSizedFormat(){return 5}updateTextureComparisonFunction(t,i){t._comparisonFunction=i}_createInternalTexture(t,i,s=!0,n=Ye.Unknown){var o,a,l;const c={};void 0!==i&&"object"==typeof i?(c.generateMipMaps=i.generateMipMaps,c.type=void 0===i.type?0:i.type,c.samplingMode=void 0===i.samplingMode?3:i.samplingMode,c.format=void 0===i.format?5:i.format,c.samples=null!==(o=i.samples)&&void 0!==o?o:1,c.creationFlags=null!==(a=i.creationFlags)&&void 0!==a?a:0,c.useSRGBBuffer=null!==(l=i.useSRGBBuffer)&&void 0!==l&&l):(c.generateMipMaps=i,c.type=0,c.samplingMode=3,c.format=5,c.samples=1,c.creationFlags=0,c.useSRGBBuffer=!1),(1===c.type&&!this._caps.textureFloatLinearFiltering||2===c.type&&!this._caps.textureHalfFloatLinearFiltering)&&(c.samplingMode=1),1===c.type&&!this._caps.textureFloat&&(c.type=0,V.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const h=new zt(this,n),u=t.width||t,d=t.height||t,f=t.layers||0;return h.baseWidth=u,h.baseHeight=d,h.width=u,h.height=d,h.depth=f,h.isReady=!0,h.samples=c.samples,h.generateMipMaps=!!c.generateMipMaps,h.samplingMode=c.samplingMode,h.type=c.type,h.format=c.format,h.is2DArray=f>0,h._cachedWrapU=0,h._cachedWrapV=0,h._useSRGBBuffer=c.useSRGBBuffer,this._internalTexturesCache.push(h),s||this._textureHelper.createGPUTextureForInternalTexture(h,u,d,f||1,c.creationFlags),h}createTexture(t,i,s,n,o=3,a=null,l=null,c=null,h=null,u=null,d=null,f,p,_,m){return this._createTextureBase(t,i,s,n,o,a,l,(g,b,y,T,x,S,C,D)=>{var P;const M=T;if(g.baseWidth=M.width,g.baseHeight=M.height,g.width=M.width,g.height=M.height,g.format=u??-1,D(g.width,g.height,M,b,g,()=>{}),null!==(P=g._hardwareTexture)&&void 0!==P&&P.underlyingResource)!S&&!C&&this._generateMipmaps(g,this._uploadEncoder);else{const w=this._textureHelper.createGPUTextureForInternalTexture(g,M.width,M.height,void 0,_);vi.IsImageBitmap(M)&&(this._textureHelper.updateTexture(M,g,M.width,M.height,g.depth,w.format,0,0,x,!1,0,0),!S&&!C&&this._generateMipmaps(g,this._uploadEncoder))}y&&y.removePendingData(g),g.isReady=!0,g.onLoadedObservable.notifyObservers(g),g.onLoadedObservable.clear()},()=>!1,c,h,u,d,f,p,m)}wrapWebGPUTexture(t){const i=new zv(t),s=new zt(this,Ye.Unknown,!0);return s._hardwareTexture=i,s.isReady=!0,s}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapWebGPUTexture instead.")}generateMipMapsForCubemap(t){var i;t.generateMipMaps&&(!(null===(i=t._hardwareTexture)||void 0===i)&&i.underlyingResource||this._textureHelper.createGPUTextureForInternalTexture(t),this._generateMipmaps(t,t.source===Ye.RenderTarget||t.source===Ye.MultiRenderTarget?this._renderTargetEncoder:void 0))}updateTextureSamplingMode(t,i,s=!1){s&&(i.generateMipMaps=!0,this._generateMipmaps(i)),i.samplingMode=t}updateTextureWrappingMode(t,i,s=null,n=null){null!==i&&(t._cachedWrapU=i),null!==s&&(t._cachedWrapV=s),(t.is2DArray||t.is3D)&&null!==n&&(t._cachedWrapR=n)}updateTextureDimensions(t,i,s,n=1){if(!t._hardwareTexture||t.width===i&&t.height===s&&t.depth===n)return;const o=t._hardwareTexture.textureAdditionalUsages;t._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(t,i,s,n,o)}_setInternalTexture(t,i,s){if(s=s??t,this._currentEffect){const o=this._currentEffect._pipelineContext.shaderProcessingContext.availableTextures[s];this._currentMaterialContext.setTexture(t,i),o&&o.autoBindSampler&&this._currentMaterialContext.setSampler(s+_i.AutoSamplerSuffix,i)}}setTexture(t,i,s,n){this._setTexture(t,s,!1,!1,n,n)}setTextureArray(t,i,s,n){for(let o=0;o<s.length;o++)this._setTexture(-1,s[o],!0,!1,n+o.toString(),n)}_setTexture(t,i,s=!1,n=!1,o="",a){if(a=a??o,this._currentEffect){if(!i)return this._currentMaterialContext.setTexture(o,null),!1;if(i.video)i.update();else if(4===i.delayLoadState)return i.delayLoad(),!1;let l=null;if(l=n?i.depthStencilTexture:i.isReady()?i.getInternalTexture():i.isCube?this.emptyCubeTexture:i.is3D?this.emptyTexture3D:i.is2DArray?this.emptyTexture2DArray:this.emptyTexture,l&&!l.isMultiview){if(l.isCube&&l._cachedCoordinatesMode!==i.coordinatesMode){l._cachedCoordinatesMode=i.coordinatesMode;const c=3!==i.coordinatesMode&&5!==i.coordinatesMode?1:0;i.wrapU=c,i.wrapV=c}l._cachedWrapU=i.wrapU,l._cachedWrapV=i.wrapV,l.is3D&&(l._cachedWrapR=i.wrapR),this._setAnisotropicLevel(0,l,i.anisotropicFilteringLevel)}this._setInternalTexture(o,l,a)}else this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",i));return!0}_setAnisotropicLevel(t,i,s){i._cachedAnisotropicFilteringLevel!==s&&(i._cachedAnisotropicFilteringLevel=Math.min(s,this._caps.maxAnisotropy))}_bindTexture(t,i,s){void 0!==t&&this._setInternalTexture(s,i)}generateMipmaps(t){this._generateMipmaps(t,this._renderTargetEncoder)}_generateMipmaps(t,i){const s=t._hardwareTexture;if(!s)return;i=i??(this._currentRenderTarget&&!this._currentRenderPass?this._renderTargetEncoder:this._currentRenderPass?this._uploadEncoder:this._renderEncoder);const n=t._hardwareTexture.format,o=vi.ComputeNumMipmapLevels(t.width,t.height);this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - generate mipmaps called - width=",t.width,"height=",t.height,"isCube=",t.isCube)),t.isCube?this._textureHelper.generateCubeMipmaps(s,n,o,i):this._textureHelper.generateMipmaps(s,n,o,0,i)}updateTextureData(t,i,s,n,o,a,l=0,c=0,h=!1){var u;let d=t._hardwareTexture;null!==(u=t._hardwareTexture)&&void 0!==u&&u.underlyingResource||(d=this._textureHelper.createGPUTextureForInternalTexture(t));const f=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(f,t,o,a,t.depth,d.format,l,c,t.invertY,!1,s,n),h&&this._generateMipmaps(t,this._renderTargetEncoder)}_uploadCompressedDataToTextureDirectly(t,i,s,n,o,a=0,l=0){var c;let h=t._hardwareTexture;null!==(c=t._hardwareTexture)&&void 0!==c&&c.underlyingResource||(t.format=i,h=this._textureHelper.createGPUTextureForInternalTexture(t,s,n));const u=new Uint8Array(o.buffer,o.byteOffset,o.byteLength);this._textureHelper.updateTexture(u,t,s,n,t.depth,h.format,a,l,!1,!1,0,0)}_uploadDataToTextureDirectly(t,i,s=0,n=0,o,a=!1){var l;const c=Math.round(Math.log(t.width)*Math.LOG2E),h=Math.round(Math.log(t.height)*Math.LOG2E),u=a?t.width:Math.pow(2,Math.max(c-n,0)),d=a?t.height:Math.pow(2,Math.max(h-n,0));let f=t._hardwareTexture;null!==(l=t._hardwareTexture)&&void 0!==l&&l.underlyingResource||(f=this._textureHelper.createGPUTextureForInternalTexture(t,u,d));const p=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(p,t,u,d,t.depth,f.format,s,n,t.invertY,!1,0,0)}_uploadArrayBufferViewToTexture(t,i,s=0,n=0){this._uploadDataToTextureDirectly(t,i,s,n)}_uploadImageToTexture(t,i,s=0,n=0){var o;let a=t._hardwareTexture;if(!(null===(o=t._hardwareTexture)||void 0===o)&&o.underlyingResource||(a=this._textureHelper.createGPUTextureForInternalTexture(t)),i instanceof HTMLImageElement)throw"WebGPU engine: HTMLImageElement not supported in _uploadImageToTexture!";const l=i,c=Math.ceil(t.width/(1<<n)),h=Math.ceil(t.height/(1<<n));this._textureHelper.updateTexture(l,t,c,h,t.depth,a.format,s,n,t.invertY,!1,0,0)}readPixels(t,i,s,n,o=!0,a=!0){const c=(this._rttRenderPassWrapper.renderPass?this._rttRenderPassWrapper:this._mainRenderPassWrapper).colorAttachmentGPUTextures[0];if(!c)return Promise.resolve(new Uint8Array(0));const h=c.underlyingResource,u=c.format;return h?(a&&this.flushFramebuffer(),this._textureHelper.readPixels(h,t,i,s,n,u)):Promise.resolve(new Uint8Array(0))}beginFrame(){super.beginFrame()}endFrame(){if(this._snapshotRendering.endFrame(this._mainRenderPassWrapper.renderPass),this._endMainRenderPass(),this._timestampQuery.endFrame(this._renderEncoder),this.flushFramebuffer(!1),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - counters")),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const t=[];for(const i in Se._UpdatedUbosInFrame)t.push(i+":"+Se._UpdatedUbosInFrame[i]);console.log("frame #"+this._count+" - updated ubos -",t.join(", "))}Se._UpdatedUbosInFrame={}}this.countersLastFrame.numEnableEffects=this._counters.numEnableEffects,this.countersLastFrame.numEnableDrawWrapper=this._counters.numEnableDrawWrapper,this.countersLastFrame.numBundleCreationNonCompatMode=this._counters.numBundleCreationNonCompatMode,this.countersLastFrame.numBundleReuseNonCompatMode=this._counters.numBundleReuseNonCompatMode,this._counters.numEnableEffects=0,this._counters.numEnableDrawWrapper=0,this._counters.numBundleCreationNonCompatMode=0,this._counters.numBundleReuseNonCompatMode=0,this._cacheRenderPipeline.endFrame(),this._cacheBindGroups.endFrame(),this._pendingDebugCommands.length=0,super.endFrame(),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - end","background: #ffff00"),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - begin","background: #ffff00")))}flushFramebuffer(t=!0){const i=!this._currentRenderPass;let s=0;this._currentRenderPass&&this._currentRenderTarget&&(s|=1,this._endRenderTargetRenderPass()),this._mainRenderPassWrapper.renderPass&&(s|=2,this._endMainRenderPass()),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderTargetEncoder.finish(),this._commandBuffers[2]=this._renderEncoder.finish(),this._device.queue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._renderTargetEncoder=this._device.createCommandEncoder(this._renderTargetEncoderDescriptor),this._timestampQuery.startFrame(this._uploadEncoder),this._textureHelper.setCommandEncoder(this._uploadEncoder),this._bundleList.reset(),this._bundleListRenderTarget.reset(),t&&(2&s&&this._startMainRenderPass(!1),1&s&&this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1),i&&this._currentRenderTarget&&(this._currentRenderPass=null))}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentRenderTarget}_startRenderTargetRenderPass(t,i,s,n,o){var a,l,c;const h=t,u=h._depthStencilTexture,d=u?._hardwareTexture,f=d?.underlyingResource,p=d?.msaaTexture,_=f?.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),m=p?.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),g=!!d&&vi.HasStencilAspect(d.format),b=[];this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const y=i&&s,T=i&&n,x=i&&o;if(h._attachments&&h.isMulti){(!this._mrtAttachments||0===this._mrtAttachments.length)&&(this._mrtAttachments=h._defaultAttachments);for(let S=0;S<this._mrtAttachments.length;++S){const C=this._mrtAttachments[S],P=h.textures[S]?._hardwareTexture,M=P?.underlyingResource;if(P&&M){const w={...this._rttRenderPassWrapper.colorAttachmentViewDescriptor,format:P.format},k=P.msaaTexture,X=M.createView(w),te=k?.createView(w);b.push({view:te||X,resolveTarget:k?X:void 0,clearValue:0!==C&&y?s:void 0,loadOp:0!==C&&y?ns.Clear:ns.Load,storeOp:gn.Store})}}this._cacheRenderPipeline.setMRT(h.textures,this._mrtAttachments.length),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}else{const S=h.texture;if(S){const C=S._hardwareTexture,P=C.msaaTexture,M=C.underlyingResource.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),w=P?.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor);b.push({view:w||M,resolveTarget:P?M:void 0,clearValue:y?s:void 0,loadOp:y?ns.Clear:ns.Load,storeOp:gn.Store})}else b.push(null)}if(null===(a=this._debugPushGroup)||void 0===a||a.call(this,"render target pass",1),this._rttRenderPassWrapper.renderPassDescriptor={colorAttachments:b,depthStencilAttachment:u&&f?{view:m||_,depthClearValue:T?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,depthLoadOp:T?ns.Clear:ns.Load,depthStoreOp:gn.Store,stencilClearValue:h._depthStencilTextureWithStencil&&x?this._clearStencilValue:void 0,stencilLoadOp:g?h._depthStencilTextureWithStencil&&x?ns.Clear:ns.Load:void 0,stencilStoreOp:g?gn.Store:void 0}:void 0,occlusionQuerySet:null!==(l=this._occlusionQuery)&&void 0!==l&&l.hasQueries?this._occlusionQuery.querySet:void 0},this._rttRenderPassWrapper.renderPass=this._renderTargetEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const S=h.texture;console.log("frame #"+this._count+" - render target begin pass - internalTexture.uniqueId=",S.uniqueId,"width=",S.width,"height=",S.height,this._rttRenderPassWrapper.renderPassDescriptor)}this._currentRenderPass=this._rttRenderPassWrapper.renderPass,null===(c=this._debugFlushPendingCommands)||void 0===c||c.call(this),this._resetCurrentViewport(1),this._resetCurrentScissor(1),this._resetCurrentStencilRef(1),this._resetCurrentColorBlend(1),(!d||!vi.HasStencilAspect(d.format))&&(this._stencilStateComposer.enabled=!1)}_endRenderTargetRenderPass(){var t,i,s,n;if(this._currentRenderPass){const o=null===(t=this._currentRenderTarget.texture)||void 0===t?void 0:t._hardwareTexture;o&&!this._snapshotRendering.endRenderTargetPass(this._currentRenderPass,o)&&!this.compatibilityMode&&(this._bundleListRenderTarget.run(this._currentRenderPass),this._bundleListRenderTarget.reset()),this._currentRenderPass.end(),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - render target end pass - internalTexture.uniqueId=",null===(s=null===(i=this._currentRenderTarget)||void 0===i?void 0:i.texture)||void 0===s?void 0:s.uniqueId)),null===(n=this._debugPopGroup)||void 0===n||n.call(this,1),this._resetCurrentViewport(1),this._resetCurrentScissor(1),this._resetCurrentStencilRef(1),this._resetCurrentColorBlend(1),this._currentRenderPass=null,this._rttRenderPassWrapper.reset()}}_getCurrentRenderPass(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1):this._currentRenderPass||this._startMainRenderPass(!1),this._currentRenderPass}_getCurrentRenderPassIndex(){return null===this._currentRenderPass?-1:this._currentRenderPass===this._mainRenderPassWrapper.renderPass?0:1}_startMainRenderPass(t,i,s,n){var o,a,l;this._mainRenderPassWrapper.renderPass&&this.flushFramebuffer(!1),this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const c=t&&i,h=t&&s,u=t&&n;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].clearValue=c?i:void 0,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadOp=c?ns.Clear:ns.Load,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthClearValue=h?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadOp=h?ns.Clear:ns.Load,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilClearValue=u?this._clearStencilValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadOp=this.isStencilEnable?u?ns.Clear:ns.Load:void 0,this._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet=null!==(o=this._occlusionQuery)&&void 0!==o&&o.hasQueries?this._occlusionQuery.querySet:void 0;const d=this._context.getCurrentTexture();this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(d),this._options.antialias?this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=d.createView():this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].view=d.createView(),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height,this._mainRenderPassWrapper.renderPassDescriptor)),null===(a=this._debugPushGroup)||void 0===a||a.call(this,"main pass",0),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._mainRenderPassWrapper.renderPass=this._currentRenderPass,null===(l=this._debugFlushPendingCommands)||void 0===l||l.call(this),this._resetCurrentViewport(0),this._resetCurrentScissor(0),this._resetCurrentStencilRef(0),this._resetCurrentColorBlend(0),this._isStencilEnable||(this._stencilStateComposer.enabled=!1)}_endMainRenderPass(){var t;null!==this._mainRenderPassWrapper.renderPass&&(this._snapshotRendering.endMainRenderPass(),!this.compatibilityMode&&!this._snapshotRendering.play&&(this._bundleList.run(this._mainRenderPassWrapper.renderPass),this._bundleList.reset()),this._mainRenderPassWrapper.renderPass.end(),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - main end pass")),null===(t=this._debugPopGroup)||void 0===t||t.call(this,0),this._resetCurrentViewport(0),this._resetCurrentScissor(0),this._resetCurrentStencilRef(0),this._resetCurrentColorBlend(0),this._mainRenderPassWrapper.renderPass===this._currentRenderPass&&(this._currentRenderPass=null),this._mainRenderPassWrapper.reset(!1))}bindFramebuffer(t,i=0,s,n,o,a=0,l=0){var c,h;const u=null===(c=t.texture)||void 0===c?void 0:c._hardwareTexture;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=t,u&&(u._currentLayer=t.isCube?6*l+i:l),this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=u,this._rttRenderPassWrapper.depthTextureFormat=this._currentRenderTarget._depthStencilTexture?vi.GetWebGPUTextureFormat(-1,this._currentRenderTarget._depthStencilTexture.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={format:this._colorFormat,dimension:Kt.E2d,mipLevelCount:1,baseArrayLayer:t.isCube?6*l+i:l,baseMipLevel:a,arrayLayerCount:1,aspect:hl.All},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={format:this._depthTextureFormat,dimension:Kt.E2d,mipLevelCount:1,baseArrayLayer:t.isCube?6*l+i:l,baseMipLevel:0,arrayLayerCount:1,aspect:hl.All},this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - bindFramebuffer called - internalTexture.uniqueId=",null===(h=t.texture)||void 0===h?void 0:h.uniqueId,"face=",i,"lodLevel=",a,"layer=",l,this._rttRenderPassWrapper.colorAttachmentViewDescriptor,this._rttRenderPassWrapper.depthAttachmentViewDescriptor)),this._currentRenderPass=null,this.snapshotRendering&&1===this.snapshotRenderingMode&&this._getCurrentRenderPass(),this._cachedViewport&&!o?this.setViewport(this._cachedViewport,s,n):(s||(s=t.width,a&&(s/=Math.pow(2,a))),n||(n=t.height,a&&(n/=Math.pow(2,a))),this._viewport(0,0,s,n)),this.wipeCaches()}unBindFramebuffer(t,i=!1,s){var n,o;const a=this._currentRenderTarget;this._currentRenderTarget=null,s&&s(),this._currentRenderTarget=a,this._currentRenderPass&&this._currentRenderPass!==this._mainRenderPassWrapper.renderPass&&this._endRenderTargetRenderPass(),(null===(n=t.texture)||void 0===n?void 0:n.generateMipMaps)&&!i&&!t.isCube&&this._generateMipmaps(t.texture),this._currentRenderTarget=null,this._onAfterUnbindFrameBufferObservable.notifyObservers(this),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - unBindFramebuffer called - internalTexture.uniqueId=",null===(o=t.texture)||void 0===o?void 0:o.uniqueId)),this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments),this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):(this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)),this._currentRenderPass&&this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_setColorFormat(t){var i,s;const n=null!==(s=null===(i=t.colorAttachmentGPUTextures[0])||void 0===i?void 0:i.format)&&void 0!==s?s:null;this._cacheRenderPipeline.setColorFormat(n),this._colorFormat!==n&&(this._colorFormat=n)}_setDepthTextureFormat(t){this._cacheRenderPipeline.setDepthStencilFormat(t.depthTextureFormat),this._depthTextureFormat!==t.depthTextureFormat&&(this._depthTextureFormat=t.depthTextureFormat)}setDitheringState(){}setRasterizerState(){}setState(t,i=0,s,n=!1,o,a,l=0){var c,h;(this._depthCullingState.cull!==t||s)&&(this._depthCullingState.cull=t);const u=null===(h=null!==(c=this.cullBackFaces)&&void 0!==c?c:o)||void 0===h||h?1:2;(this._depthCullingState.cullFace!==u||s)&&(this._depthCullingState.cullFace=u),this.setZOffset(i),this.setZOffsetUnits(l);const d=n?this._currentRenderTarget?1:2:this._currentRenderTarget?2:1;(this._depthCullingState.frontFace!==d||s)&&(this._depthCullingState.frontFace=d),this._stencilStateComposer.stencilMaterial=a}_applyRenderPassChanges(t,i){var s;const n=this._mustUpdateViewport(t),o=this._mustUpdateScissor(t),a=!!this._stencilStateComposer.enabled&&this._mustUpdateStencilRef(t),l=!!this._alphaState.alphaBlend&&this._mustUpdateBlendColor(t);i?(n&&i.addItem(new _C(this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w)),o&&i.addItem(new Lp(this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w)),a&&i.addItem(new Bp(null!==(s=this._stencilStateComposer.funcRef)&&void 0!==s?s:0)),l&&i.addItem(new mC(this._alphaState._blendConstants.slice()))):(n&&this._applyViewport(t),o&&this._applyScissor(t),a&&this._applyStencilRef(t),l&&this._applyBlendColor(t))}_draw(t,i,s,n,o){var a;const l=this._getCurrentRenderPass(),h=0===this._getCurrentRenderPassIndex()?this._bundleList:this._bundleListRenderTarget;this.applyStates();const u=this._currentEffect._pipelineContext;if(this.bindUniformBufferBase(this._currentRenderTarget?this._ubInvertY:this._ubDontInvertY,0,_i.InternalsUBOName),u.uniformBuffer&&(u.uniformBuffer.update(),this.bindUniformBufferBase(u.uniformBuffer.getBuffer(),0,_i.LeftOvertUBOName)),this._snapshotRendering.play)return void this._reportDrawCall();!this.compatibilityMode&&(this._currentDrawContext.isDirty(this._currentMaterialContext.updateId)||this._currentMaterialContext.isDirty||this._currentMaterialContext.forceBindGroupCreation)&&(this._currentDrawContext.fastBundle=void 0);let f=l;if(!this.compatibilityMode&&this._currentDrawContext.fastBundle||this._snapshotRendering.record){if(this._applyRenderPassChanges(l,h),!this._snapshotRendering.record)return this._counters.numBundleReuseNonCompatMode++,this._currentDrawContext.indirectDrawBuffer&&this._currentDrawContext.setIndirectData(n,o||1,s),h.addBundle(this._currentDrawContext.fastBundle),void this._reportDrawCall();f=h.getBundleEncoder(this._cacheRenderPipeline.colorFormats,this._depthTextureFormat,this.currentSampleCount),h.numDrawCalls++}let p=0;if(!this._caps.textureFloatLinearFiltering&&this._currentMaterialContext.hasFloatTextures){let y=1;for(let T=0;T<u.shaderProcessingContext.textureNames.length;++T)1===(null===(a=this._currentMaterialContext.textures[u.shaderProcessingContext.textureNames[T]])||void 0===a?void 0:a.texture)?.type&&(p|=y),y<<=1}const _=this._cacheRenderPipeline.getRenderPipeline(i,this._currentEffect,this.currentSampleCount,p),m=this._cacheBindGroups.getBindGroups(u,this._currentDrawContext,this._currentMaterialContext);this._snapshotRendering.record||(this._applyRenderPassChanges(l,this.compatibilityMode?null:h),this.compatibilityMode||(this._counters.numBundleCreationNonCompatMode++,f=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:this.currentSampleCount}))),f.setPipeline(_),this._currentIndexBuffer&&f.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?_l.Uint32:_l.Uint16,0);const g=this._cacheRenderPipeline.vertexBuffers;for(let y=0;y<g.length;y++){const T=g[y],x=T.getBuffer();x&&f.setVertexBuffer(y,x.underlyingResource,T._validOffsetRange?0:T.byteOffset)}for(let y=0;y<m.length;y++)f.setBindGroup(y,m[y]);const b=!this.compatibilityMode&&!this._snapshotRendering.record;b&&this._currentDrawContext.indirectDrawBuffer?(this._currentDrawContext.setIndirectData(n,o||1,s),0===t?f.drawIndexedIndirect(this._currentDrawContext.indirectDrawBuffer,0):f.drawIndirect(this._currentDrawContext.indirectDrawBuffer,0)):0===t?f.drawIndexed(n,o||1,s,0,0):f.draw(n,o||1,s,0),b&&(this._currentDrawContext.fastBundle=f.finish(),h.addBundle(this._currentDrawContext.fastBundle)),this._reportDrawCall()}drawElementsType(t,i,s,n=1){this._draw(0,t,i,s,n)}drawArraysType(t,i,s,n=1){this._currentIndexBuffer=null,this._draw(1,t,i,s,n)}dispose(){var t,i;null===(t=this._mainTexture)||void 0===t||t.destroy(),null===(i=this._depthTexture)||void 0===i||i.destroy(),super.dispose()}getRenderWidth(t=!1){return!t&&this._currentRenderTarget?this._currentRenderTarget.width:this._canvas.width}getRenderHeight(t=!1){return!t&&this._currentRenderTarget?this._currentRenderTarget.height:this._canvas.height}getRenderingCanvas(){return this._canvas}getError(){return 0}bindSamplers(){}_bindTextureDirectly(){return!1}areAllEffectsReady(){return!0}_executeWhenRenderingStateIsCompiled(t,i){i()}_isRenderingStateCompiled(){return!0}_getUnpackAlignement(){return 1}_unpackFlipY(){}_bindUnboundFramebuffer(){throw"_bindUnboundFramebuffer is not implementedin WebGPU! You probably want to use restoreDefaultFramebuffer or unBindFramebuffer instead"}_getSamplingParameters(){throw"_getSamplingParameters is not available in WebGPU"}getUniforms(){return[]}setIntArray(){return!1}setIntArray2(){return!1}setIntArray3(){return!1}setIntArray4(){return!1}setArray(){return!1}setArray2(){return!1}setArray3(){return!1}setArray4(){return!1}setMatrices(){return!1}setMatrix3x3(){return!1}setMatrix2x2(){return!1}setFloat(){return!1}setFloat2(){return!1}setFloat3(){return!1}setFloat4(){return!1}}return r._GLSLslangDefaultOptions={jsPath:"https://preview.babylonjs.com/glslang/glslang.js",wasmPath:"https://preview.babylonjs.com/glslang/glslang.wasm"},r.UseTWGSL=!0,r})();je.prototype.setAlphaMode=function(r,e=!1){if(this._alphaMode===r&&(0===r&&!this._alphaState.alphaBlend||0!==r&&this._alphaState.alphaBlend)){if(!e){const t=0===r;this.depthCullingState.depthMask!==t&&(this.setDepthWrite(t),this._cacheRenderPipeline.setDepthWriteEnabled(t))}}else{switch(r){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,1),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,1),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(1,1,0,1),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(770,1,0,1),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(0,769,1,1),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(774,0,1,1),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(770,769,1,1),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(32769,32770,32771,32772),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(1,769,1,771),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,1),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(772,1,0,0),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(775,769,773,771),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,0),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(775,769,0,1),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,771),this._alphaState.alphaBlend=!0}e||(this.setDepthWrite(r===ee.ALPHA_DISABLE),this._cacheRenderPipeline.setDepthWriteEnabled(r===ee.ALPHA_DISABLE)),this._alphaMode=r,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)}},je.prototype.setAlphaEquation=function(r){ee.prototype.setAlphaEquation.call(this,r),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};let nne=(()=>{class r{getBindGroups(t,i,s){if(!s)throw new Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(0===this._bindGroups.length){const n=this._bindGroupEntries.length>0;for(const o in t){const a=t[o],l=s[o],c=l.group,h=l.binding,u=a.type,d=a.object;let f=a.indexInGroupEntries,p=this._bindGroupEntries[c];switch(p||(p=this._bindGroupEntries[c]=[]),u){case Ii.Sampler:{const _=d;void 0!==f&&n?p[f].resource=this._cacheSampler.getSampler(_):(a.indexInGroupEntries=p.length,p.push({binding:h,resource:this._cacheSampler.getSampler(_)}));break}case Ii.Texture:case Ii.TextureWithoutSampler:{const _=d,m=_._texture._hardwareTexture;void 0!==f&&n?(u===Ii.Texture&&(p[f++].resource=this._cacheSampler.getSampler(_._texture)),p[f].resource=m.view):(a.indexInGroupEntries=p.length,u===Ii.Texture&&p.push({binding:h-1,resource:this._cacheSampler.getSampler(_._texture)}),p.push({binding:h,resource:m.view}));break}case Ii.StorageTexture:{const _=d,m=_._texture._hardwareTexture;0==(m.textureAdditionalUsages&ci.StorageBinding)&&V.Error(`computeDispatch: The texture (name=${_.name}, uniqueId=${_.uniqueId}) is not a storage texture!`,50),void 0!==f&&n?p[f].resource=m.viewForWriting:(a.indexInGroupEntries=p.length,p.push({binding:h,resource:m.viewForWriting}));break}case Ii.UniformBuffer:case Ii.StorageBuffer:{const m=d.getBuffer(),g=m.underlyingResource;void 0!==f&&n?(p[f].resource.buffer=g,p[f].resource.size=m.capacity):(a.indexInGroupEntries=p.length,p.push({binding:h,resource:{buffer:g,offset:0,size:m.capacity}}));break}}}for(let o=0;o<this._bindGroupEntries.length;++o){const a=this._bindGroupEntries[o];this._bindGroups[o]=a?this._device.createBindGroup({layout:i.getBindGroupLayout(o),entries:a}):void 0}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups}constructor(t,i){this._device=t,this._cacheSampler=i,this.uniqueId=r._Counter++,this._bindGroupEntries=[],this.clear()}clear(){this._bindGroups=[]}}return r._Counter=0,r})();class one{get isAsync(){return!1}get isReady(){return!!this.stage}constructor(e){this._name="unnamed",this.engine=e}_getComputeShaderCode(){var e;return null===(e=this.sources)||void 0===e?void 0:e.compute}dispose(){}}je.prototype.createComputeContext=function(){return new nne(this._device,this._cacheSampler)},je.prototype.createComputeEffect=function(r,e){const i=(r.computeElement||r.compute||r.computeToken||r.computeSource||r)+"@"+e.defines;if(this._compiledComputeEffects[i]){const n=this._compiledComputeEffects[i];return e.onCompiled&&n.isReady()&&e.onCompiled(n),n}const s=new lre(r,e,this,i);return this._compiledComputeEffects[i]=s,s},je.prototype.createComputePipelineContext=function(){return new one(this)},je.prototype.areAllComputeEffectsReady=function(){for(const r in this._compiledComputeEffects)if(!this._compiledComputeEffects[r].isReady())return!1;return!0},je.prototype.computeDispatch=function(r,e,t,i,s,n,o){if(this._currentRenderTarget)return void this._onAfterUnbindFrameBufferObservable.addOnce(()=>{this.computeDispatch(r,e,t,i,s,n,o)});const a=r._pipelineContext,l=e;a.computePipeline||(a.computePipeline=this._device.createComputePipeline({layout:Zu.Auto,compute:a.stage}));const h=this._renderTargetEncoder.beginComputePass();h.setPipeline(a.computePipeline);const u=l.getBindGroups(t,a.computePipeline,o);for(let d=0;d<u.length;++d){const f=u[d];!f||h.setBindGroup(d,f)}h.dispatchWorkgroups(i,s,n),h.end()},je.prototype.releaseComputeEffects=function(){for(const r in this._compiledComputeEffects){const e=this._compiledComputeEffects[r].getPipelineContext();this._deleteComputePipelineContext(e)}this._compiledComputeEffects={}},je.prototype._prepareComputePipelineContext=function(r,e,t,i,s){const n=r;this.dbgShowShaderCode&&(console.log(i),console.log(e)),n.sources={compute:e,rawCompute:t},n.stage=this._createComputePipelineStageDescriptor(e,i,s)},je.prototype._releaseComputeEffect=function(r){this._compiledComputeEffects[r._key]&&(delete this._compiledComputeEffects[r._key],this._deleteComputePipelineContext(r.getPipelineContext()))},je.prototype._rebuildComputeEffects=function(){for(const r in this._compiledComputeEffects){const e=this._compiledComputeEffects[r];e._pipelineContext=null,e._wasPreviouslyReady=!1,e._prepareEffect()}},je.prototype._deleteComputePipelineContext=function(r){r&&r.dispose()},je.prototype._createComputePipelineStageDescriptor=function(r,e,t){return e=e?"//"+e.split("\n").join("\n//")+"\n":"",{module:this._device.createShaderModule({code:e+r}),entryPoint:t}},je.prototype._createDepthStencilCubeTexture=function(r,e){const t=new zt(this,Ye.DepthStencil);t.isCube=!0;const i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,...e};return t.format=i.generateStencil?13:14,this._setupDepthStencilTexture(t,r,i.generateStencil,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t),this._internalTexturesCache.push(t),t},je.prototype.createCubeTexture=function(r,e,t,i,s=null,n=null,o,a=null,l=!1,c=0,h=0,u=null,d=!1){return this.createCubeTextureBase(r,e,t,!!i,s,n,o,a,l,c,h,u,null,(f,p)=>{const _=p,m=_[0].width,g=m;this._setCubeMapTextureParams(f,!i),f.format=o??-1;const b=this._textureHelper.createGPUTextureForInternalTexture(f,m,g);this._textureHelper.updateCubeTextures(_,b.underlyingResource,m,g,b.format,!1,!1,0,0),i||this._generateMipmaps(f,this._uploadEncoder),f.isReady=!0,f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),s&&s()},!!d)},je.prototype._setCubeMapTextureParams=function(r,e,t){r.samplingMode=e?3:2,r._cachedWrapU=0,r._cachedWrapV=0,t&&(r._maxLodLevel=t)},je.prototype._debugPushGroup=function(r,e){!this._options.enableGPUDebugMarkers||(0===e||1===e?(0===e?this._renderEncoder:this._renderTargetEncoder).pushDebugGroup(r):this._currentRenderPass?this._currentRenderPass.pushDebugGroup(r):this._pendingDebugCommands.push(["push",r]))},je.prototype._debugPopGroup=function(r){!this._options.enableGPUDebugMarkers||(0===r||1===r?(0===r?this._renderEncoder:this._renderTargetEncoder).popDebugGroup():this._currentRenderPass?this._currentRenderPass.popDebugGroup():this._pendingDebugCommands.push(["pop",null]))},je.prototype._debugInsertMarker=function(r,e){!this._options.enableGPUDebugMarkers||(0===e||1===e?(0===e?this._renderEncoder:this._renderTargetEncoder).insertDebugMarker(r):this._currentRenderPass?this._currentRenderPass.insertDebugMarker(r):this._pendingDebugCommands.push(["insert",r]))},je.prototype._debugFlushPendingCommands=function(){for(let r=0;r<this._pendingDebugCommands.length;++r){const[e,t]=this._pendingDebugCommands[r];switch(e){case"push":this._debugPushGroup(t);break;case"pop":this._debugPopGroup();break;case"insert":this._debugInsertMarker(t)}}this._pendingDebugCommands.length=0},je.prototype.updateDynamicIndexBuffer=function(r,e,t=0){const i=r;let s;s=r.is32Bits?e instanceof Uint32Array?e:new Uint32Array(e):e instanceof Uint16Array?e:new Uint16Array(e),this._bufferManager.setSubData(i,t,s)},je.prototype.updateDynamicVertexBuffer=function(r,e,t,i){const s=r;let n;void 0===t&&(t=0),void 0===i?(n=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e,i=n.byteLength):n=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e,this._bufferManager.setSubData(s,t,n,0,i)},je.prototype.updateDynamicTexture=function(r,e,t,i=!1,s,n,o){var a;if(!r)return;const l=e.width,c=e.height;let h=r._hardwareTexture;!(null===(a=r._hardwareTexture)||void 0===a)&&a.underlyingResource||(h=this._textureHelper.createGPUTextureForInternalTexture(r,l,c)),this._textureHelper.updateTexture(e,r,l,c,r.depth,h.format,0,0,t,i,0,0,o),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder),r.isReady=!0};class ane extends oU{constructor(e){super(e)}}function Vp(r,e,t,i){let s,n=1;1===i?s=new Float32Array(e*t*4):2===i?(s=new Uint16Array(e*t*4),n=15360):s=7===i?new Uint32Array(e*t*4):new Uint8Array(e*t*4);for(let o=0;o<e;o++)for(let a=0;a<t;a++){const l=3*(a*e+o),c=4*(a*e+o);s[c+0]=r[l+0],s[c+1]=r[l+1],s[c+2]=r[l+2],s[c+3]=n}return s}Ot.prototype.setExternalTexture=function(r,e){this._engine.setExternalTexture(r,e)},je.prototype.createExternalTexture=function(r){return new ane(r)},je.prototype.setExternalTexture=function(r,e){e?this._setInternalTexture(r,e):this._currentMaterialContext.setTexture(r,null)},je.prototype.unBindMultiColorAttachmentFramebuffer=function(r,e=!1,t){t&&t();const s=r._attachments.length;this._currentRenderPass&&this._currentRenderPass!==this._mainRenderPassWrapper.renderPass&&this._endRenderTargetRenderPass();for(let n=0;n<s;n++){const o=r.textures[n];o.generateMipMaps&&!e&&!o.isCube&&this._generateMipmaps(o)}this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments),this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)},je.prototype.createMultipleRenderTarget=function(r,e,t){var i;let s=!1,n=!0,o=!1,a=!1,l=15,c=1,f=new Array,p=new Array,_=new Array;const m=this._createHardwareRenderTargetWrapper(!0,!1,r);void 0!==e&&(s=void 0!==e.generateMipMaps&&e.generateMipMaps,n=void 0===e.generateDepthBuffer||e.generateDepthBuffer,o=void 0!==e.generateStencilBuffer&&e.generateStencilBuffer,a=void 0!==e.generateDepthTexture&&e.generateDepthTexture,c=e.textureCount||1,l=null!==(i=e.depthTextureFormat)&&void 0!==i?i:15,e.types&&(f=e.types),e.samplingModes&&(p=e.samplingModes),e.useSRGBBuffers&&(_=e.useSRGBBuffers));const g=r.width||r,b=r.height||r;let y=null;(n||o||a)&&(y=m.createDepthStencilTexture(0,!1,o,1,l));const T=[],x=[],S=[];m._generateDepthBuffer=n,m._generateStencilBuffer=o,m._attachments=x,m._defaultAttachments=S;for(let C=0;C<c;C++){let D=p[C]||3,P=f[C]||0;const M=_[C]||!1;(1===P&&!this._caps.textureFloatLinearFiltering||2===P&&!this._caps.textureHalfFloatLinearFiltering)&&(D=1),1===P&&!this._caps.textureFloat&&(P=0,V.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));const w=new zt(this,Ye.MultiRenderTarget);T.push(w),x.push(C+1),S.push(t?C+1:0===C?1:0),w.baseWidth=g,w.baseHeight=b,w.width=g,w.height=b,w.isReady=!0,w.samples=1,w.generateMipMaps=s,w.samplingMode=D,w.type=P,w._cachedWrapU=0,w._cachedWrapV=0,w._useSRGBBuffer=M,this._internalTexturesCache.push(w),this._textureHelper.createGPUTextureForInternalTexture(w)}return y&&(y.incrementReferences(),T.push(y),this._internalTexturesCache.push(y)),m.setTextures(T),m},je.prototype.updateMultipleRenderTargetTextureSampleCount=function(r,e){if(!r||!r.textures||r.textures[0].samples===e)return e;const t=r.textures.length;if(0===t)return 1;e=Math.min(e,this.getCaps().maxMSAASamples);for(let i=0;i<t;++i){const s=r.textures[i];this._textureHelper.createMSAATexture(s,e),s.samples=e}return r._depthStencilTexture&&r._depthStencilTexture!==r.textures[r.textures.length-1]&&(this._textureHelper.createMSAATexture(r._depthStencilTexture,e),r._depthStencilTexture.samples=e),e},je.prototype.bindAttachments=function(r){0===r.length||!this._currentRenderTarget||(this._mrtAttachments=r,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(r))},je.prototype.buildTextureLayout=function(r){const e=[];for(let t=0;t<r.length;t++)e.push(r[t]?t+1:0);return e},je.prototype.restoreSingleAttachment=function(){},je.prototype.restoreSingleAttachmentForRenderTarget=function(){},je.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter},je.prototype.captureGPUFrameTime=function(r){this._timestampQuery.enable=r&&!!this._caps.timerQuery},je.prototype.createQuery=function(){return this._occlusionQuery.createQuery()},je.prototype.deleteQuery=function(r){return this._occlusionQuery.deleteQuery(r),this},je.prototype.isQueryResultAvailable=function(r){return this._occlusionQuery.isQueryResultAvailable(r)},je.prototype.getQueryResult=function(r){return this._occlusionQuery.getQueryResult(r)},je.prototype.beginOcclusionQuery=function(r,e){var t;return this.compatibilityMode?!!this._occlusionQuery.canBeginQuery&&(null===(t=this._currentRenderPass)||void 0===t||t.beginOcclusionQuery(e),!0):((0===this._getCurrentRenderPassIndex()?this._bundleList:this._bundleListRenderTarget).addItem(new gC(e)),!0)},je.prototype.endOcclusionQuery=function(){var r;return this.compatibilityMode?null===(r=this._currentRenderPass)||void 0===r||r.endOcclusionQuery():(0===this._getCurrentRenderPassIndex()?this._bundleList:this._bundleListRenderTarget).addItem(new vC),this},je.prototype.createRawTexture=function(r,e,t,i,s,n,o,a=null,l=0,c=0,h=!1){const u=new zt(this,Ye.Raw);return u.baseWidth=e,u.baseHeight=t,u.width=e,u.height=t,u.format=i,u.generateMipMaps=s,u.samplingMode=o,u.invertY=n,u._compression=a,u.type=l,u._useSRGBBuffer=h,this._doNotHandleContextLost||(u._bufferView=r),this._textureHelper.createGPUTextureForInternalTexture(u,e,t,void 0,c),this.updateRawTexture(u,r,i,n,a,l,h),this._internalTexturesCache.push(u),u},je.prototype.updateRawTexture=function(r,e,t,i,s=null,n=0,o=!1){if(r){if(this._doNotHandleContextLost||(r._bufferView=e,r.invertY=i,r._compression=s,r._useSRGBBuffer=o),e){const a=r._hardwareTexture;4===t&&(e=Vp(e,r.width,r.height,n));const c=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(c,r,r.width,r.height,r.depth,a.format,0,0,i,!1,0,0),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder)}r.isReady=!0}},je.prototype.createRawCubeTexture=function(r,e,t,i,s,n,o,a=null){const l=new zt(this,Ye.CubeRaw);return 1!==i||this._caps.textureFloatLinearFiltering?2!==i||this._caps.textureHalfFloatLinearFiltering?1!==i||this._caps.textureFloatRender?2===i&&!this._caps.colorBufferFloat&&(s=!1,V.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(s=!1,V.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(s=!1,o=1,V.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(s=!1,o=1,V.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")),l.isCube=!0,l.format=4===t?5:t,l.type=i,l.generateMipMaps=s,l.width=e,l.height=e,l.samplingMode=o,this._doNotHandleContextLost||(l._bufferViewArray=r),l.invertY=n,l._compression=a,l._cachedWrapU=0,l._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(l),r&&this.updateRawCubeTexture(l,r,t,i,n,a),l.isReady=!0,l},je.prototype.updateRawCubeTexture=function(r,e,t,i,s,n=null){r._bufferViewArray=e,r.invertY=s,r._compression=n;const o=r._hardwareTexture,a=4===t,l=[];for(let c=0;c<e.length;++c){let h=e[c];a&&(h=Vp(e[c],r.width,r.height,i)),l.push(new Uint8Array(h.buffer,h.byteOffset,h.byteLength))}this._textureHelper.updateCubeTextures(l,o.underlyingResource,r.width,r.height,o.format,s,!1,0,0),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder),r.isReady=!0},je.prototype.createRawCubeTextureFromUrl=function(r,e,t,i,s,n,o,a,l=null,c=null,h=3,u=!1){const d=this.createRawCubeTexture(null,t,i,s,!n,u,h,null);e?.addPendingData(d),d.url=r,this._internalTexturesCache.push(d);const p=_=>{const m=d.width,g=o(_);if(!g)return;const b=[0,2,4,1,3,5];if(a){const y=4===i,T=a(g),x=d._hardwareTexture,S=[0,1,2,3,4,5];for(let C=0;C<T.length;C++){const D=m>>C,P=[];for(let M=0;M<6;M++){let w=T[C][S[M]];y&&(w=Vp(w,D,D,s)),P.push(new Uint8Array(w.buffer,w.byteOffset,w.byteLength))}this._textureHelper.updateCubeTextures(P,x.underlyingResource,D,D,x.format,u,!1,0,0)}}else{const y=[];for(let T=0;T<6;T++)y.push(g[b[T]]);this.updateRawCubeTexture(d,y,i,s,u)}d.isReady=!0,e?.removePendingData(d),l&&l()};return this._loadFile(r,_=>{p(_)},void 0,e?.offlineProvider,!0,(_,m)=>{e?.removePendingData(d),c&&_&&c(_.status+" "+_.statusText,m)}),d},je.prototype.createRawTexture3D=function(r,e,t,i,s,n,o,a,l=null,c=0,h=0){const d=new zt(this,Ye.Raw3D);return d.baseWidth=e,d.baseHeight=t,d.baseDepth=i,d.width=e,d.height=t,d.depth=i,d.format=s,d.type=c,d.generateMipMaps=n,d.samplingMode=a,d.is3D=!0,this._doNotHandleContextLost||(d._bufferView=r),this._textureHelper.createGPUTextureForInternalTexture(d,e,t,void 0,h),this.updateRawTexture3D(d,r,s,o,l,c),this._internalTexturesCache.push(d),d},je.prototype.updateRawTexture3D=function(r,e,t,i,s=null,n=0){if(this._doNotHandleContextLost||(r._bufferView=e,r.format=t,r.invertY=i,r._compression=s),e){const o=r._hardwareTexture;4===t&&(e=Vp(e,r.width,r.height,n));const l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,r,r.width,r.height,r.depth,o.format,0,0,i,!1,0,0),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder)}r.isReady=!0},je.prototype.createRawTexture2DArray=function(r,e,t,i,s,n,o,a,l=null,c=0,h=0){const d=new zt(this,Ye.Raw2DArray);return d.baseWidth=e,d.baseHeight=t,d.baseDepth=i,d.width=e,d.height=t,d.depth=i,d.format=s,d.type=c,d.generateMipMaps=n,d.samplingMode=a,d.is2DArray=!0,this._doNotHandleContextLost||(d._bufferView=r),this._textureHelper.createGPUTextureForInternalTexture(d,e,t,i,h),this.updateRawTexture2DArray(d,r,s,o,l,c),this._internalTexturesCache.push(d),d},je.prototype.updateRawTexture2DArray=function(r,e,t,i,s=null,n=0){if(this._doNotHandleContextLost||(r._bufferView=e,r.format=t,r.invertY=i,r._compression=s),e){const o=r._hardwareTexture;4===t&&(e=Vp(e,r.width,r.height,n));const l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,r,r.width,r.height,r.depth,o.format,0,0,i,!1,0,0),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder)}r.isReady=!0},je.prototype._readTexturePixels=function(r,e,t,i=-1,s=0,n=null,o=!0,a=!1,l=0,c=0){const h=r._hardwareTexture;return o&&this.flushFramebuffer(),this._textureHelper.readPixels(h.underlyingResource,l,c,e,t,h.format,i,s,n,a)},je.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"};class lne extends DE{}je.prototype._createHardwareRenderTargetWrapper=function(r,e,t){const i=new lne(r,e,t,this);return this._renderTargetWrapperCache.push(i),i},je.prototype.createRenderTargetTexture=function(r,e){var t,i;const s=this._createHardwareRenderTargetWrapper(!1,!1,r),n={};void 0!==e&&"object"==typeof e?(n.generateMipMaps=e.generateMipMaps,n.generateDepthBuffer=void 0===e.generateDepthBuffer||e.generateDepthBuffer,n.generateStencilBuffer=n.generateDepthBuffer&&e.generateStencilBuffer,n.samplingMode=void 0===e.samplingMode?3:e.samplingMode,n.creationFlags=null!==(t=e.creationFlags)&&void 0!==t?t:0,n.noColorAttachment=!!e.noColorAttachment,n.samples=e.samples):(n.generateMipMaps=e,n.generateDepthBuffer=!0,n.generateStencilBuffer=!1,n.samplingMode=3,n.creationFlags=0,n.noColorAttachment=!1);const o=n.noColorAttachment?null:this._createInternalTexture(r,e,!0,Ye.RenderTarget);return s._samples=null!==(i=n.samples)&&void 0!==i?i:1,s._generateDepthBuffer=n.generateDepthBuffer,s._generateStencilBuffer=!!n.generateStencilBuffer,s.setTextures(o),(s._generateDepthBuffer||s._generateStencilBuffer)&&s.createDepthStencilTexture(0,this._caps.textureFloatLinearFiltering&&(void 0===n.samplingMode||2===n.samplingMode||2===n.samplingMode||3===n.samplingMode||3===n.samplingMode||5===n.samplingMode||6===n.samplingMode||7===n.samplingMode||11===n.samplingMode),s._generateStencilBuffer,s.samples,n.generateStencilBuffer?13:14),o&&(void 0!==e&&"object"==typeof e&&e.createMipMaps&&!n.generateMipMaps&&(o.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(o,void 0,void 0,void 0,n.creationFlags),void 0!==e&&"object"==typeof e&&e.createMipMaps&&!n.generateMipMaps&&(o.generateMipMaps=!1)),s},je.prototype._createDepthStencilTexture=function(r,e){const t=new zt(this,Ye.DepthStencil),i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:e.generateStencil?13:14,...e};return t.format=i.depthTextureFormat,this._setupDepthStencilTexture(t,r,i.generateStencil,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t),this._internalTexturesCache.push(t),t},je.prototype._setupDepthStencilTexture=function(r,e,t,i,s,n=1){const o=e.width||e,a=e.height||e,l=e.layers||0;r.baseWidth=o,r.baseHeight=a,r.width=o,r.height=a,r.is2DArray=l>0,r.depth=l,r.isReady=!0,r.samples=n,r.generateMipMaps=!1,r.samplingMode=i?2:1,r.type=1,r._comparisonFunction=s,r._cachedWrapU=0,r._cachedWrapV=0},je.prototype.updateRenderTargetTextureSampleCount=function(r,e){return!r||!r.texture||r.samples===e||(e=Math.min(e,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(r.texture,e),r._depthStencilTexture&&(this._textureHelper.createMSAATexture(r._depthStencilTexture,e),r._depthStencilTexture.samples=e),r._samples=e,r.texture.samples=e),e},je.prototype.createRenderTargetCubeTexture=function(r,e){const t=this._createHardwareRenderTargetWrapper(!1,!0,r),i={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1,...e};i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer;const s=new zt(this,Ye.RenderTarget);return s.width=r,s.height=r,s.depth=0,s.isReady=!0,s.isCube=!0,s.samples=i.samples,s.generateMipMaps=i.generateMipMaps,s.samplingMode=i.samplingMode,s.type=i.type,s.format=i.format,this._internalTexturesCache.push(s),t.setTextures(s),(t._generateDepthBuffer||t._generateStencilBuffer)&&t.createDepthStencilTexture(0,void 0===i.samplingMode||2===i.samplingMode||2===i.samplingMode||3===i.samplingMode||3===i.samplingMode||5===i.samplingMode||6===i.samplingMode||7===i.samplingMode||11===i.samplingMode,t._generateStencilBuffer,t.samples),e&&e.createMipMaps&&!i.generateMipMaps&&(s.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(s),e&&e.createMipMaps&&!i.generateMipMaps&&(s.generateMipMaps=!1),t},Ot.prototype.setTextureSampler=function(r,e){this._engine.setTextureSampler(r,e)},je.prototype.setTextureSampler=function(r,e){var t;null===(t=this._currentMaterialContext)||void 0===t||t.setSampler(r,e)},Ot.prototype.setStorageBuffer=function(r,e){this._engine.setStorageBuffer(r,e)},je.prototype.createStorageBuffer=function(r,e){return this._createBuffer(r,32|e)},je.prototype.updateStorageBuffer=function(r,e,t,i){const s=r;let n;void 0===t&&(t=0),void 0===i?(n=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e,i=n.byteLength):n=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e,this._bufferManager.setSubData(s,t,n,0,i)},je.prototype.readFromStorageBuffer=function(r,e,t,i){const s=this._bufferManager.createRawBuffer(t=t||r.capacity,ei.MapRead|ei.CopyDst);return this._renderTargetEncoder.copyBufferToBuffer(r.underlyingResource,e??0,s,0,t),new Promise((n,o)=>{this.onEndFrameObservable.addOnce(()=>{s.mapAsync(ac.Read,0,t).then(()=>{const a=s.getMappedRange(0,t);let l=i;if(void 0===l)l=new Uint8Array(t),l.set(new Uint8Array(a));else{const c=l.constructor;l=new c(l.buffer),l.set(new c(a))}s.unmap(),this._bufferManager.releaseBuffer(s),n(l)},a=>o(a))})})},je.prototype.setStorageBuffer=function(r,e){var t,i;null===(t=this._currentDrawContext)||void 0===t||t.setBuffer(r,null!==(i=e?.getBuffer())&&void 0!==i?i:null)},je.prototype.createUniformBuffer=function(r){let e;return e=r instanceof Array?new Float32Array(r):r,this._bufferManager.createBuffer(e,ei.Uniform|ei.CopyDst)},je.prototype.createDynamicUniformBuffer=function(r){return this.createUniformBuffer(r)},je.prototype.updateUniformBuffer=function(r,e,t,i){void 0===t&&(t=0);const s=r;let n;void 0===i?(n=e instanceof Float32Array?e:new Float32Array(e),i=n.byteLength):n=e instanceof Float32Array?e:new Float32Array(e),this._bufferManager.setSubData(s,t,n,0,i)},je.prototype.bindUniformBufferBase=function(r,e,t){this._currentDrawContext.setBuffer(t,r)},je.prototype.bindUniformBlock=function(){},je.prototype.updateVideoTexture=function(r,e,t){var i;if(!r||r._isDisabled)return;void 0===this._videoTextureSupported&&(this._videoTextureSupported=!0);let s=r._hardwareTexture;!(null===(i=r._hardwareTexture)||void 0===i)&&i.underlyingResource||(s=this._textureHelper.createGPUTextureForInternalTexture(r)),function cne(r){return!(!r||void 0===r.underlyingResource)}(e)?(this._textureHelper.copyVideoToTexture(e,r,s.format,!t),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder),r.isReady=!0):e&&this.createImageBitmap(e).then(n=>{this._textureHelper.updateTexture(n,r,r.width,r.height,r.depth,s.format,0,0,!t,!1,0,0),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder),r.isReady=!0}).catch(()=>{r.isReady=!0})};let dU=(()=>{class r extends ph{constructor(t){super(t),this.controllerType=Ho.DAYDREAM}initControllerMesh(t,i){ke.ImportMesh("",r.MODEL_BASE_URL,r.MODEL_FILENAME,t,s=>{this._defaultModel=s[1],this.attachToMesh(this._defaultModel),i&&i(this._defaultModel)})}_handleButtonChange(t,i){if(0===t){const s=this.onTriggerStateChangedObservable;s&&s.notifyObservers(i)}else V.Warn(`Unrecognized Daydream button index: ${t}`)}}return r.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/",r.MODEL_FILENAME="generic.babylon",r.GAMEPAD_ID_PREFIX="Daydream",r})();hh._ControllerFactories.push({canCreate:r=>0===r.id.indexOf(dU.GAMEPAD_ID_PREFIX),create:r=>new dU(r)});let fU=(()=>{class r extends ph{constructor(t){super(t),this._buttonIndexToObservableNameMap=["onPadStateChangedObservable","onTriggerStateChangedObservable"],this.controllerType=Ho.GEAR_VR,this._calculatedPosition=new v("left"==this.hand?-.15:.15,-.5,.25),this._disableTrackPosition(this._calculatedPosition)}initControllerMesh(t,i){ke.ImportMesh("",r.MODEL_BASE_URL,r.MODEL_FILENAME,t,s=>{const n=new G("",t);s[1].parent=n,s[1].position.z=-.15,this._defaultModel=n,this.attachToMesh(this._defaultModel),i&&i(this._defaultModel)})}_handleButtonChange(t,i){if(t<this._buttonIndexToObservableNameMap.length){const n=this[this._buttonIndexToObservableNameMap[t]];n&&n.notifyObservers(i)}}}return r.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/",r.MODEL_FILENAME="generic.babylon",r.GAMEPAD_ID_PREFIX="Gear VR",r})();hh._ControllerFactories.push({canCreate:r=>0===r.id.indexOf(fU.GAMEPAD_ID_PREFIX)||-1!==r.id.indexOf("Oculus Go")||-1!==r.id.indexOf("Vive Focus"),create:r=>new fU(r)});let xC=(()=>{class r extends ph{constructor(t){super(t)}initControllerMesh(t,i){ke.ImportMesh("",r.MODEL_BASE_URL,r.MODEL_FILENAME,t,s=>{this._defaultModel=s[1],this.attachToMesh(this._defaultModel),i&&i(this._defaultModel)})}_handleButtonChange(t,i){console.log("Button id: "+t+"state: "),console.dir(i)}}return r.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/",r.MODEL_FILENAME="generic.babylon",r})();hh._DefaultControllerFactory=r=>new xC(r);let pU=(()=>{class r extends ph{constructor(t){super(t),this.onSecondaryTriggerStateChangedObservable=new z,this.onThumbRestChangedObservable=new z,this.controllerType=Ho.OCULUS}initControllerMesh(t,i){let s;s="left"===this.hand?r.MODEL_LEFT_FILENAME:r.MODEL_RIGHT_FILENAME,ke.ImportMesh("",r._IsQuest?r.QUEST_MODEL_BASE_URL:r.MODEL_BASE_URL,s,t,n=>{this._defaultModel=r._IsQuest?n[0]:n[1],this.attachToMesh(this._defaultModel),i&&i(this._defaultModel)})}get onAButtonStateChangedObservable(){if("right"===this.hand)return this.onMainButtonStateChangedObservable;throw new Error("No A button on left hand")}get onBButtonStateChangedObservable(){if("right"===this.hand)return this.onSecondaryButtonStateChangedObservable;throw new Error("No B button on left hand")}get onXButtonStateChangedObservable(){if("left"===this.hand)return this.onMainButtonStateChangedObservable;throw new Error("No X button on right hand")}get onYButtonStateChangedObservable(){if("left"===this.hand)return this.onSecondaryButtonStateChangedObservable;throw new Error("No Y button on right hand")}_handleButtonChange(t,i){const s=i,n="right"===this.hand?-1:1;switch(t){case 0:return void this.onPadStateChangedObservable.notifyObservers(s);case 1:return!r._IsQuest&&this._defaultModel&&(this._defaultModel.getChildren()[3].rotation.x=.2*-s.value,this._defaultModel.getChildren()[3].position.y=.005*-s.value,this._defaultModel.getChildren()[3].position.z=.005*-s.value),void this.onTriggerStateChangedObservable.notifyObservers(s);case 2:return!r._IsQuest&&this._defaultModel&&(this._defaultModel.getChildren()[4].position.x=n*s.value*.0035),void this.onSecondaryTriggerStateChangedObservable.notifyObservers(s);case 3:return!r._IsQuest&&this._defaultModel&&(this._defaultModel.getChildren()[1].position.y=s.pressed?-.001:0),void this.onMainButtonStateChangedObservable.notifyObservers(s);case 4:return!r._IsQuest&&this._defaultModel&&(this._defaultModel.getChildren()[2].position.y=s.pressed?-.001:0),void this.onSecondaryButtonStateChangedObservable.notifyObservers(s);case 5:return void this.onThumbRestChangedObservable.notifyObservers(s)}}}return r.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/",r.MODEL_LEFT_FILENAME="left.babylon",r.MODEL_RIGHT_FILENAME="right.babylon",r.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/",r._IsQuest=!1,r})();hh._ControllerFactories.push({canCreate:r=>(be.LastCreatedEngine&&be.LastCreatedEngine._vrDisplay&&"Oculus Quest"===be.LastCreatedEngine._vrDisplay.displayName&&(pU._IsQuest=!0),-1!==r.id.indexOf("Oculus Touch")),create:r=>new pU(r)});let hne=(()=>{class r extends ph{constructor(t){super(t),this.controllerType=Ho.VIVE,this._invertLeftStickY=!0}initControllerMesh(t,i){ke.ImportMesh("",r.MODEL_BASE_URL,r.MODEL_FILENAME,t,s=>{this._defaultModel=s[1],this.attachToMesh(this._defaultModel),i&&i(this._defaultModel)})}get onLeftButtonStateChangedObservable(){return this.onMainButtonStateChangedObservable}get onRightButtonStateChangedObservable(){return this.onMainButtonStateChangedObservable}get onMenuButtonStateChangedObservable(){return this.onSecondaryButtonStateChangedObservable}_handleButtonChange(t,i){const s=i;switch(t){case 0:return void this.onPadStateChangedObservable.notifyObservers(s);case 1:return this._defaultModel&&(this._defaultModel.getChildren()[6].rotation.x=.15*-s.value),void this.onTriggerStateChangedObservable.notifyObservers(s);case 2:return void this.onMainButtonStateChangedObservable.notifyObservers(s);case 3:return this._defaultModel&&(this._defaultModel.getChildren()[2].position.y=s.pressed?-.001:0),void this.onSecondaryButtonStateChangedObservable.notifyObservers(s)}}}return r.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/",r.MODEL_FILENAME="wand.babylon",r})();hh._ControllerFactories.push({canCreate:r=>-1!==r.id.toLowerCase().indexOf("openvr"),create:r=>new hne(r)});class une{constructor(){this.buttonMeshes={},this.axisMeshes={}}}let _U=(()=>{class r extends ph{constructor(t){super(t),this._mapping={buttons:["thumbstick","trigger","grip","menu","trackpad"],buttonMeshNames:{trigger:"SELECT",menu:"MENU",grip:"GRASP",thumbstick:"THUMBSTICK_PRESS",trackpad:"TOUCHPAD_PRESS"},buttonObservableNames:{trigger:"onTriggerStateChangedObservable",menu:"onSecondaryButtonStateChangedObservable",grip:"onMainButtonStateChangedObservable",thumbstick:"onPadStateChangedObservable",trackpad:"onTrackpadChangedObservable"},axisMeshNames:["THUMBSTICK_X","THUMBSTICK_Y","TOUCHPAD_TOUCH_X","TOUCHPAD_TOUCH_Y"],pointingPoseMeshName:Sv.POINTING_POSE},this.onTrackpadChangedObservable=new z,this.onTrackpadValuesChangedObservable=new z,this.trackpad={x:0,y:0},this.controllerType=Ho.WINDOWS,this._loadedMeshInfo=null}get onTriggerButtonStateChangedObservable(){return this.onTriggerStateChangedObservable}get onMenuButtonStateChangedObservable(){return this.onSecondaryButtonStateChangedObservable}get onGripButtonStateChangedObservable(){return this.onMainButtonStateChangedObservable}get onThumbstickButtonStateChangedObservable(){return this.onPadStateChangedObservable}get onTouchpadButtonStateChangedObservable(){return this.onTrackpadChangedObservable}get onTouchpadValuesChangedObservable(){return this.onTrackpadValuesChangedObservable}_updateTrackpad(){this.browserGamepad.axes&&(this.browserGamepad.axes[2]!=this.trackpad.x||this.browserGamepad.axes[3]!=this.trackpad.y)&&(this.trackpad.x=this.browserGamepad.axes[this._mapping.axisMeshNames.indexOf("TOUCHPAD_TOUCH_X")],this.trackpad.y=this.browserGamepad.axes[this._mapping.axisMeshNames.indexOf("TOUCHPAD_TOUCH_Y")],this.onTrackpadValuesChangedObservable.notifyObservers(this.trackpad))}update(){if(super.update(),this.browserGamepad.axes&&(this._updateTrackpad(),this._loadedMeshInfo))for(let t=0;t<this._mapping.axisMeshNames.length;t++)this._lerpAxisTransform(t,this.browserGamepad.axes[t])}_handleButtonChange(t,i){const s=this._mapping.buttons[t];if(!s)return;this._updateTrackpad();const n=this[this._mapping.buttonObservableNames[s]];n&&n.notifyObservers(i),this._lerpButtonTransform(s,i.value)}_lerpButtonTransform(t,i){if(!this._loadedMeshInfo)return;const s=this._loadedMeshInfo.buttonMeshes[t];!s||!s.unpressed.rotationQuaternion||!s.pressed.rotationQuaternion||!s.value.rotationQuaternion||(Z.SlerpToRef(s.unpressed.rotationQuaternion,s.pressed.rotationQuaternion,i,s.value.rotationQuaternion),v.LerpToRef(s.unpressed.position,s.pressed.position,i,s.value.position))}_lerpAxisTransform(t,i){if(!this._loadedMeshInfo)return;const s=this._loadedMeshInfo.axisMeshes[t];if(!(s&&s.min.rotationQuaternion&&s.max.rotationQuaternion&&s.value.rotationQuaternion))return;const n=.5*i+.5;Z.SlerpToRef(s.min.rotationQuaternion,s.max.rotationQuaternion,n,s.value.rotationQuaternion),v.LerpToRef(s.min.position,s.max.position,n,s.value.position)}initControllerMesh(t,i,s=!1){let n,o;if(ke.IsPluginForExtensionAvailable(".glb")){let a="default";if(this.id&&!s){const l=this.id.match(r.GAMEPAD_ID_PATTERN);a=l&&l[0]||a}o="left"===this.hand?r.MODEL_LEFT_FILENAME:r.MODEL_RIGHT_FILENAME,n=r.MODEL_BASE_URL+a+"/"}else V.Warn("You need to reference GLTF loader to load Windows Motion Controllers model. Falling back to generic models"),n=xC.MODEL_BASE_URL,o=xC.MODEL_FILENAME;ke.ImportMesh("",n,o,t,a=>{this._loadedMeshInfo=this._processModel(t,a),this._loadedMeshInfo&&(this._defaultModel=this._loadedMeshInfo.rootNode,this.attachToMesh(this._defaultModel),i&&i(this._defaultModel))},null,(a,l)=>{V.Log(l),V.Warn("Failed to retrieve controller model from the remote server: "+n+o),s||this.initControllerMesh(a,i,!0)})}_processModel(t,i){let s=null;const n=new G(this.id+" "+this.hand,t);let o=null;for(let a=0;a<i.length;a++){const l=i[a];if(!l.parent){l.isPickable=!1,o=l;break}}return o?(o.setParent(n),s=this._createMeshInfo(n)):V.Warn("Could not find root node in model file."),s}_createMeshInfo(t){const i=new une;let s;for(i.rootNode=t,i.buttonMeshes={},i.axisMeshes={},s=0;s<this._mapping.buttons.length;s++){const a=this._mapping.buttonMeshNames[this._mapping.buttons[s]];if(!a){V.Log("Skipping unknown button at index: "+s+" with mapped name: "+this._mapping.buttons[s]);continue}const l=n(t,a);if(!l){V.Warn("Missing button mesh with name: "+a);continue}const c={index:s,value:o(l,"VALUE"),pressed:o(l,"PRESSED"),unpressed:o(l,"UNPRESSED")};c.value&&c.pressed&&c.unpressed?i.buttonMeshes[this._mapping.buttons[s]]=c:V.Warn("Missing button submesh under mesh with name: "+a+"(VALUE: "+!!c.value+", PRESSED: "+!!c.pressed+", UNPRESSED:"+!!c.unpressed+")")}for(s=0;s<this._mapping.axisMeshNames.length;s++){const a=this._mapping.axisMeshNames[s];if(!a){V.Log("Skipping unknown axis at index: "+s);continue}const l=n(t,a);if(!l){V.Warn("Missing axis mesh with name: "+a);continue}const c={index:s,value:o(l,"VALUE"),min:o(l,"MIN"),max:o(l,"MAX")};c.value&&c.min&&c.max?i.axisMeshes[s]=c:V.Warn("Missing axis submesh under mesh with name: "+a+"(VALUE: "+!!c.value+", MIN: "+!!c.min+", MAX:"+!!c.max+")")}return i.pointingPoseNode=n(t,this._mapping.pointingPoseMeshName),i.pointingPoseNode?this._pointingPoseNode=i.pointingPoseNode:V.Warn("Missing pointing pose mesh with name: "+this._mapping.pointingPoseMeshName),i;function n(a,l){return a.getChildren(c=>c.name===l,!1)[0]}function o(a,l){return a.getChildren(c=>c.name==l,!0)[0]}}getForwardRay(t=100){if(!this._loadedMeshInfo||!this._loadedMeshInfo.pointingPoseNode)return super.getForwardRay(t);const i=this._loadedMeshInfo.pointingPoseNode.getWorldMatrix(),s=i.getTranslation(),n=new v(0,0,-1),o=v.TransformNormal(n,i),a=v.Normalize(o);return new Qe(s,a,t)}dispose(){super.dispose(),this.onTrackpadChangedObservable.clear(),this.onTrackpadValuesChangedObservable.clear()}}return r.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/",r.MODEL_LEFT_FILENAME="left.glb",r.MODEL_RIGHT_FILENAME="right.glb",r.GAMEPAD_ID_PREFIX="Spatial Controller (Spatial Interaction Source) ",r.GAMEPAD_ID_PATTERN=/([0-9a-zA-Z]+-[0-9a-zA-Z]+)$/,r})();hh._ControllerFactories.push({canCreate:r=>0===r.id.indexOf(_U.GAMEPAD_ID_PREFIX),create:r=>new _U(r)});class lc extends Dv{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}constructor(e,t=re.Gray(),i=nl.DefaultUtilityLayer,s=32,n=null,o=!1,a=1){var l;super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new z,this.angle=0,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._angles=new v,this._parent=n,this._coloredMaterial=new fe("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new re(.1,.1,.1)),this._hoverMaterial=new fe("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=re.Yellow(),this._disableMaterial=new fe("",i.utilityLayerScene),this._disableMaterial.diffuseColor=re.Gray(),this._disableMaterial.alpha=.4,this._gizmoMesh=new G("",i.utilityLayerScene);const{rotationMesh:c,collider:h}=this._createGizmoMesh(this._gizmoMesh,a,s);this._rotationDisplayPlane=rh("rotationDisplay",{size:.6,updatable:!1},this.gizmoLayer.utilityLayerScene),this._rotationDisplayPlane.rotation.z=.5*Math.PI,this._rotationDisplayPlane.parent=this._gizmoMesh,this._rotationDisplayPlane.setEnabled(!1),Ot.ShadersStore.rotationGizmoVertexShader=lc._RotationGizmoVertexShader,Ot.ShadersStore.rotationGizmoFragmentShader=lc._RotationGizmoFragmentShader,this._rotationShaderMaterial=new mn("shader",this.gizmoLayer.utilityLayerScene,{vertex:"rotationGizmo",fragment:"rotationGizmo"},{attributes:["position","uv"],uniforms:["worldViewProjection","angles"]}),this._rotationShaderMaterial.backFaceCulling=!1,this._rotationDisplayPlane.material=this._rotationShaderMaterial,this._rotationDisplayPlane.visibility=.999,this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._rootMesh.addChild(this._gizmoMesh,Dv.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3),this.dragBehavior=new gse({dragPlaneNormal:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.maxDragAngle=lc.MaxDragAngle,this.dragBehavior._useAlternatePickedPointAboveMaxDragAngle=!0,this._rootMesh.addBehavior(this.dragBehavior);const u=new v,d=new F,f=new v;let p=new v;this.dragBehavior.onDragStartObservable.add(x=>{this.attachedNode&&(u.copyFrom(x.dragPlanePoint),this._rotationDisplayPlane.setEnabled(!0),this._rotationDisplayPlane.getWorldMatrix().invertToRef(d),v.TransformCoordinatesToRef(x.dragPlanePoint,d,u),this._angles.x=Math.atan2(u.y,u.x)+Math.PI,this._angles.y=0,this._angles.z=this.updateGizmoRotationToMatchAttachedMesh?1:0,this._dragging=!0,u.copyFrom(x.dragPlanePoint),this._rotationShaderMaterial.setVector3("angles",this._angles),this.angle=0)}),this.dragBehavior.onDragEndObservable.add(()=>{this._dragging=!1,this._rotationDisplayPlane.setEnabled(!1)});const _={snapDistance:0};let m=0;const g=new F,b=new Z;this.dragBehavior.onDragObservable.add(x=>{if(this.attachedNode){const S=new v(1,1,1),C=new Z(0,0,0,1),D=new v(0,0,0);if(this._handlePivot(),this.attachedNode.getWorldMatrix().decompose(S,C,D),!(Math.abs(Math.abs(S.x)-Math.abs(S.y))<=ot&&Math.abs(Math.abs(S.x)-Math.abs(S.z))<=ot)&&this.updateGizmoRotationToMatchAttachedMesh)return void V.Warn("Unable to use a rotation gizmo matching mesh rotation with non uniform scaling. Use uniform scaling or set updateGizmoRotationToMatchAttachedMesh to false.");C.normalize();const M=this.updateGizmoPositionToMatchAttachedMesh?D:this._rootMesh.absolutePosition,w=x.dragPlanePoint.subtract(M).normalize(),k=u.subtract(M).normalize(),X=v.Cross(w,k),te=v.Dot(w,k);let J=Math.atan2(X.length(),te);f.copyFrom(e),p.copyFrom(e),this.updateGizmoRotationToMatchAttachedMesh&&(C.toRotationMatrix(d),p=v.TransformCoordinates(f,d));let Q=!1;if(i.utilityLayerScene.activeCamera){const K=i.utilityLayerScene.activeCamera.position.subtract(M).normalize();v.Dot(K,p)>0&&(f.scaleInPlace(-1),p.scaleInPlace(-1),Q=!0)}v.Dot(p,X)>0&&(J=-J);let ae=!1;if(0!=this.snapDistance)if(m+=J,Math.abs(m)>this.snapDistance){let K=Math.floor(Math.abs(m)/this.snapDistance);m<0&&(K*=-1),m%=this.snapDistance,J=this.snapDistance*K,ae=!0}else J=0;const W=Math.sin(J/2);if(b.set(f.x*W,f.y*W,f.z*W,Math.cos(J/2)),g.determinant()>0){const K=new v;b.toEulerAnglesToRef(K),Z.RotationYawPitchRollToRef(K.y,-K.x,-K.z,b)}this.updateGizmoRotationToMatchAttachedMesh?(C.multiplyToRef(b,C),F.ComposeToRef(S,C,D,this.attachedNode.getWorldMatrix())):(b.toRotationMatrix(L.Matrix[0]),L.Matrix[0].multiplyToRef(this.attachedNode.getWorldMatrix(),this.attachedNode.getWorldMatrix())),u.copyFrom(x.dragPlanePoint),ae&&(_.snapDistance=J,this.onSnapObservable.notifyObservers(_)),this._angles.y+=J,this.angle+=Q?-J:J,this._rotationShaderMaterial.setVector3("angles",this._angles),this._matrixChanged()}});const y=i._getSharedGizmoLight();y.includedOnlyMeshes=y.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));const T={colliderMeshes:[h],gizmoMeshes:[c],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};null===(l=this._parent)||void 0===l||l.addToAxisCache(this._gizmoMesh,T),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add(x=>{var S;this._customMeshSet||(this.dragBehavior.maxDragAngle=lc.MaxDragAngle,this._isHovered=-1!=T.colliderMeshes.indexOf(null===(S=x?.pickInfo)||void 0===S?void 0:S.pickedMesh),this._parent)||this._setGizmoMeshMaterial(T.gizmoMeshes,T.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial)}),this.dragBehavior.onEnabledObservable.add(x=>{this._setGizmoMeshMaterial(T.gizmoMeshes,x?this._coloredMaterial:this._disableMaterial)})}_createGizmoMesh(e,t,i){const s=pa("ignore",{diameter:.6,thickness:.03*t,tessellation:i},this.gizmoLayer.utilityLayerScene);s.visibility=0;const n=pa("",{diameter:.6,thickness:.005*t,tessellation:i},this.gizmoLayer.utilityLayerScene);return n.material=this._coloredMaterial,n.rotation.x=Math.PI/2,s.rotation.x=Math.PI/2,e.addChild(n,Dv.PreserveScaling),e.addChild(s,Dv.PreserveScaling),{rotationMesh:n,collider:s}}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh):this.attachedMesh=null}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),this._rotationDisplayPlane&&this._rotationDisplayPlane.dispose(),this._rotationShaderMaterial&&this._rotationShaderMaterial.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(e=>{e&&e.dispose()}),super.dispose()}}function gU(r){const e=[];e[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},e[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},e[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},e[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},e[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},e[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},e[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},e[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},e[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},e[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},e[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},e[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},e[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},e[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},e[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};const i=r.size,s=r.sizeX||i||1,n=r.sizeY||i||1,o=r.sizeZ||i||1,a=r.custom||e[r.type&&(r.type<0||r.type>=e.length)?0:r.type||0],l=a.face.length,c=r.faceUV||new Array(l),h=r.faceColors,u=void 0===r.flat||r.flat,d=0===r.sideOrientation?0:r.sideOrientation||ue.DEFAULTSIDE,f=new Array,p=new Array,_=new Array,m=new Array,g=new Array;let b=0,y=0;const T=new Array;let C,D,P,M,w,k,x=0,S=0;if(u)for(S=0;S<l;S++)h&&void 0===h[S]&&(h[S]=new Te(1,1,1,1)),c&&void 0===c[S]&&(c[S]=new vt(0,0,1,1));if(u)for(S=0;S<l;S++){const te=a.face[S].length;for(P=2*Math.PI/te,M=.5*Math.tan(P/2),w=.5,x=0;x<te;x++)f.push(a.vertex[a.face[S][x]][0]*s,a.vertex[a.face[S][x]][1]*n,a.vertex[a.face[S][x]][2]*o),T.push(b),b++,C=c[S].x+(c[S].z-c[S].x)*(.5+M),D=c[S].y+(c[S].w-c[S].y)*(w-.5),m.push(C,It.UseOpenGLOrientationForUV?1-D:D),k=M*Math.cos(P)-w*Math.sin(P),w=M*Math.sin(P)+w*Math.cos(P),M=k,h&&g.push(h[S].r,h[S].g,h[S].b,h[S].a);for(x=0;x<te-2;x++)p.push(T[0+y],T[x+2+y],T[x+1+y]);y+=te}else{for(x=0;x<a.vertex.length;x++)f.push(a.vertex[x][0]*s,a.vertex[x][1]*n,a.vertex[x][2]*o),m.push(0,It.UseOpenGLOrientationForUV?1:0);for(S=0;S<l;S++)for(x=0;x<a.face[S].length-2;x++)p.push(a.face[S][0],a.face[S][x+2],a.face[S][x+1])}ue.ComputeNormals(f,p,_),ue._ComputeSides(d,f,p,_,m,r.frontUVs,r.backUVs);const X=new ue;return X.positions=f,X.indices=p,X.normals=_,X.uvs=m,h&&u&&(X.colors=g),X}function jv(r,e={},t=null){const i=new G(r,t);return e.sideOrientation=G._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,gU(e).applyToMesh(i,e.updatable),i}lc.MaxDragAngle=9*Math.PI/20,lc._RotationGizmoVertexShader="\n        precision highp float;\n        attribute vec3 position;\n        attribute vec2 uv;\n        uniform mat4 worldViewProjection;\n        varying vec3 vPosition;\n        varying vec2 vUV;\n        void main(void) {\n            gl_Position = worldViewProjection * vec4(position, 1.0);\n            vUV = uv;\n        }",lc._RotationGizmoFragmentShader="\n        precision highp float;\n        varying vec2 vUV;\n        varying vec3 vPosition;\n        uniform vec3 angles;\n        #define twopi 6.283185307\n        void main(void) {\n            vec2 uv = vUV - vec2(0.5);\n            float angle = atan(uv.y, uv.x) + 3.141592;\n            float delta = gl_FrontFacing ? angles.y : -angles.y;\n            float begin = angles.x - delta * angles.z;\n            float start = (begin < (begin + delta)) ? begin : (begin + delta);\n            float end = (begin > (begin + delta)) ? begin : (begin + delta);\n            float len = sqrt(dot(uv,uv));\n            float opacity = 1. - step(0.5, len);\n\n            float base = abs(floor(start / twopi)) * twopi;\n            start += base;\n            end += base;\n\n            float intensity = 0.;\n            for (int i = 0; i < 5; i++)\n            {\n                intensity += max(step(start, angle) - step(end, angle), 0.);\n                angle += twopi;\n            }\n            gl_FragColor = vec4(1.,1.,0., min(intensity * 0.25, 0.8)) * opacity;\n        }",ue.CreatePolyhedron=gU,G.CreatePolyhedron=(r,e,t)=>jv(r,e,t);class Th extends Je{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return!(!this.parent||!this.parent.getWorldMatrix||(this.transformedPosition||(this.transformedPosition=v.Zero()),v.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=v.Zero()),v.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),0))}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=v.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const e=v.Cross(this.direction,fs.Y),t=v.Cross(e,this.direction);return v.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=v.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=F.Identity()),F.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return void 0!==this.shadowMinZ?this.shadowMinZ:e.minZ}getDepthMaxZ(e){return void 0!==this.shadowMaxZ?this.shadowMaxZ:e.maxZ}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)}}E([Ws()],Th.prototype,"position",null),E([Ws()],Th.prototype,"direction",null),E([I()],Th.prototype,"shadowMinZ",null),E([I()],Th.prototype,"shadowMaxZ",null),Rt.AddNodeConstructor("Light_Type_1",(r,e)=>()=>new qn(r,v.Zero(),e));class qn extends Th{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return Je.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){const t=this.getScene().activeCamera;!t||F.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,void 0!==this.shadowMinZ?this.shadowMinZ:t.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const h=v.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE;let u=Number.MAX_VALUE,d=Number.MIN_VALUE;for(let f=0;f<i.length;f++){const p=i[f];if(!p)continue;const m=p.getBoundingInfo().boundingBox;for(let g=0;g<m.vectorsWorld.length;g++)v.TransformCoordinatesToRef(m.vectorsWorld[g],t,h),h.x<this._orthoLeft&&(this._orthoLeft=h.x),h.y<this._orthoBottom&&(this._orthoBottom=h.y),h.x>this._orthoRight&&(this._orthoRight=h.x),h.y>this._orthoTop&&(this._orthoTop=h.y),this.autoCalcShadowZBounds&&(h.z<u&&(u=h.z),h.z>d&&(d=h.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=u,this._shadowMaxZ=d)}const n=this._orthoRight-this._orthoLeft,o=this._orthoTop-this._orthoBottom,a=void 0!==this.shadowMinZ?this.shadowMinZ:s.minZ,l=void 0!==this.shadowMaxZ?this.shadowMaxZ:s.maxZ,c=this.getScene().getEngine().useReverseDepthBuffer;F.OrthoOffCenterLHToRef(this._orthoLeft-n*this.shadowOrthoScale,this._orthoRight+n*this.shadowOrthoScale,this._orthoBottom-o*this.shadowOrthoScale,this._orthoTop+o*this.shadowOrthoScale,c?l:a,c?a:l,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}}function vU(r){const e=new Array,t=new Array,i=new Array,s=new Array,n=r.radius||.5,o=r.tessellation||64,a=r.arc&&(r.arc<=0||r.arc>1)?1:r.arc||1,l=0===r.sideOrientation?0:r.sideOrientation||ue.DEFAULTSIDE;e.push(0,0,0),s.push(.5,.5);const c=2*Math.PI*a,h=1===a?c/o:c/(o-1);let u=0;for(let p=0;p<o;p++){const _=Math.cos(u),m=Math.sin(u),g=(_+1)/2,b=(1-m)/2;e.push(n*_,n*m,0),s.push(g,It.UseOpenGLOrientationForUV?1-b:b),u+=h}1===a&&(e.push(e[3],e[4],e[5]),s.push(s[2],It.UseOpenGLOrientationForUV?1-s[3]:s[3]));const d=e.length/3;for(let p=1;p<d-1;p++)t.push(p+1,0,p);ue.ComputeNormals(e,t,i),ue._ComputeSides(l,e,t,i,s,r.frontUVs,r.backUVs);const f=new ue;return f.indices=t,f.positions=e,f.normals=i,f.uvs=s,f}function Yv(r,e={},t=null){const i=new G(r,t);return e.sideOrientation=G._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,vU(e).applyToMesh(i,e.updatable),i}E([I()],qn.prototype,"shadowFrustumSize",null),E([I()],qn.prototype,"shadowOrthoScale",null),E([I()],qn.prototype,"autoUpdateExtends",void 0),E([I()],qn.prototype,"autoCalcShadowZBounds",void 0),E([I("orthoLeft")],qn.prototype,"_orthoLeft",void 0),E([I("orthoRight")],qn.prototype,"_orthoRight",void 0),E([I("orthoTop")],qn.prototype,"_orthoTop",void 0),E([I("orthoBottom")],qn.prototype,"_orthoBottom",void 0),ue.CreateDisc=vU,G.CreateDisc=(r,e,t,i=null,s,n)=>Yv(r,{radius:e,tessellation:t,sideOrientation:n,updatable:s},i),G.CreateHemisphere=(r,e,t,i)=>function bU(r,e={},t){e.diameter||(e.diameter=1),e.segments||(e.segments=16);const i=po("",{slice:.5,diameter:e.diameter,segments:e.segments},t),s=Yv("",{radius:e.diameter/2,tessellation:3*e.segments+(4-e.segments)},t);s.rotation.x=-Math.PI/2,s.parent=i;const n=G.MergeMeshes([s,i],!0);return n.name=r,n}(r,{segments:e,diameter:t},i),Rt.AddNodeConstructor("Light_Type_2",(r,e)=>()=>new rn(r,v.Zero(),v.Zero(),0,0,e));class rn extends Th{get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(.5*e),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(rn._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(()=>{this._markMeshesAsLightDirty()}):rn._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()})))}static _IsProceduralTexture(e){return void 0!==e.onGeneratedObservable}static _IsTexture(e){return void 0!==e.onLoadObservable}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,t,i,s,n,o){super(e,o),this._innerAngle=0,this._projectionTextureMatrix=F.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=v.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=v.Zero(),this._projectionTextureViewLightMatrix=F.Zero(),this._projectionTextureProjectionLightMatrix=F.Zero(),this._projectionTextureScalingMatrix=F.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=i,this.angle=s,this.exponent=n}getClassName(){return"SpotLight"}getTypeID(){return Je.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;this._shadowAngleScale=this._shadowAngleScale||1;const n=this._shadowAngleScale*this._angle,o=void 0!==this.shadowMinZ?this.shadowMinZ:s.minZ,a=void 0!==this.shadowMaxZ?this.shadowMaxZ:s.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;F.PerspectiveFovLHToRef(n,1,l?a:o,l?o:a,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,l)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.position.addToRef(this.direction,this._projectionTextureViewTargetVector),F.LookAtLHToRef(this.position,this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;const e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),s=-i*t,n=1/Math.tan(this._angle/2);F.FromValuesToRef(n/1,0,0,0,0,n,0,0,0,0,i,1,0,0,s,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof U&&F.FromValuesToRef(this._projectionTexture.uScale/2,0,0,0,0,this._projectionTexture.vScale/2,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix),this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(.5*this._innerAngle)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightSampler"+t,this.projectionTexture)),this}transferToEffect(e,t){let i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),i=v.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),i=v.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let i;return i=this.computeTransformedInformation()?v.Normalize(this.transformedDirection):v.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose()}getDepthMinZ(e){const t=this._scene.getEngine(),i=void 0!==this.shadowMinZ?this.shadowMinZ:e.minZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:void 0!==this.shadowMaxZ?this.shadowMaxZ:e.maxZ}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!(!this.projectionTexture||!this.projectionTexture.isReady())}}E([I()],rn.prototype,"angle",null),E([I()],rn.prototype,"innerAngle",null),E([I()],rn.prototype,"shadowAngleScale",null),E([I()],rn.prototype,"exponent",void 0),E([I()],rn.prototype,"projectionTextureLightNear",null),E([I()],rn.prototype,"projectionTextureLightFar",null),E([I()],rn.prototype,"projectionTextureUpDirection",null),E([ht("projectedLightTexture")],rn.prototype,"_projectionTexture",void 0);j.IncludesShadersStore.kernelBlurVaryingDeclaration="varying vec2 sampleCoord{X};";j.IncludesShadersStore.packingFunctions="vec4 pack(float depth)\n{\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(depth*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}";j.IncludesShadersStore.kernelBlurFragment="#ifdef DOF\nfactor=sampleCoC(sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;\nsumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;\n#endif\n";j.IncludesShadersStore.kernelBlurFragment2="#ifdef DOF\nfactor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});\ncomputedWeight=KERNEL_DEP_WEIGHT{X}*factor;\nsumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n";j.ShadersStore.kernelBlurPixelShader="uniform sampler2D textureSampler;\nuniform vec2 delta;\nvarying vec2 sampleCenter;\n#ifdef DOF\nuniform sampler2D circleOfConfusionSampler;\nfloat sampleCoC(in vec2 offset) {\nfloat coc=texture2D(circleOfConfusionSampler,offset).r;\nreturn coc; \n}\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nfloat computedWeight=0.0;\n#ifdef PACKEDFLOAT\nfloat blend=0.;\n#else\nvec4 blend=vec4(0.);\n#endif\n#ifdef DOF\nfloat sumOfWeights=CENTER_WEIGHT; \nfloat factor=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\ngl_FragColor=pack(blend);\n#else\ngl_FragColor=blend;\n#endif\n#ifdef DOF\ngl_FragColor/=sumOfWeights;\n#endif\n}";j.IncludesShadersStore.kernelBlurVertex="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";j.ShadersStore.kernelBlurVertexShader="attribute vec2 position;\nuniform vec2 delta;\nvarying vec2 sampleCenter;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nsampleCenter=(position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class _s extends Pe{set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this._blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this._blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,i,s,n,o=U.BILINEAR_SAMPLINGMODE,a,l,c=0,h="",u=!1,d=5){super(e,"kernelBlur",["delta","direction"],["circleOfConfusionSampler"],s,n,o,a,l,null,c,"kernelBlur",{varyingCount:0,depCount:0},!0,d),this._blockCompilation=u,this._packedFloat=!1,this._staticDefines="",this._staticDefines=h,this.direction=t,this.onApplyObservable.add(f=>{this._outputTexture?f.setFloat2("delta",1/this._outputTexture.width*this.direction.x,1/this._outputTexture.height*this.direction.y):f.setFloat2("delta",1/this.width*this.direction.x,1/this.height*this.direction.y)}),this.kernel=i}updateEffect(e=null,t=null,i=null,s,n,o){this._updateParameters(n,o)}_updateParameters(e,t){const i=this._kernel,s=(i-1)/2;let n=[],o=[],a=0;for(let m=0;m<i;m++){const b=this._gaussianWeight(m/(i-1)*2-1);n[m]=m-s,o[m]=b,a+=b}for(let m=0;m<o.length;m++)o[m]/=a;const l=[],c=[],h=[];for(let m=0;m<=s;m+=2){const g=Math.min(m+1,Math.floor(s));if(m===g)h.push({o:n[m],w:o[m]});else{const T=o[m]+o[g]*(g===s?.5:1),x=n[m]+1/(1+o[m]/o[g]);0===x?(h.push({o:n[m],w:o[m]}),h.push({o:n[m+1],w:o[m+1]})):(h.push({o:x,w:T}),h.push({o:-x,w:T}))}}for(let m=0;m<h.length;m++)c[m]=h[m].o,l[m]=h[m].w;n=c,o=l;const u=this.getEngine().getCaps().maxVaryingVectors,d=Math.max(u,0)-1;let f=Math.min(n.length,d),p="";p+=this._staticDefines,-1!=this._staticDefines.indexOf("DOF")&&(p+=`#define CENTER_WEIGHT ${this._glslFloat(o[f-1])}\r\n`,f--);for(let m=0;m<f;m++)p+=`#define KERNEL_OFFSET${m} ${this._glslFloat(n[m])}\r\n`,p+=`#define KERNEL_WEIGHT${m} ${this._glslFloat(o[m])}\r\n`;let _=0;for(let m=d;m<n.length;m++)p+=`#define KERNEL_DEP_OFFSET${_} ${this._glslFloat(n[m])}\r\n`,p+=`#define KERNEL_DEP_WEIGHT${_} ${this._glslFloat(o[m])}\r\n`,_++;this.packedFloat&&(p+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,super.updateEffect(p,null,null,{varyingCount:f,depCount:_},e,t)}_nearestBestKernel(e){const t=Math.round(e);for(const i of[t,t-1,t+1,t-2,t+2])if(i%2!=0&&Math.floor(i/2)%2==0&&i>0)return Math.max(i,3);return Math.max(t,3)}_gaussianWeight(e){const t=.3333333333333333;return 1/(Math.sqrt(2*Math.PI)*t)*Math.exp(-e*e/(2*t*t))}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}static _Parse(e,t,i,s){return Ce.Parse(()=>new _s(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1),e,i,s)}}E([I("kernel")],_s.prototype,"_kernel",void 0),E([I("packedFloat")],_s.prototype,"_packedFloat",void 0),E([iE()],_s.prototype,"direction",void 0),le("BABYLON.BlurPostProcess",_s);class qv extends Ss{set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){const e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){const e=this.getScene();!e||(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,t,i,s,n=0,o=U.BILINEAR_SAMPLINGMODE,a=!0){if(super(e,t,i,s,!0,n,!1,o,a),this.mirrorPlane=new Dr(0,1,0,1),this._transformMatrix=F.Zero(),this._mirrorMatrix=F.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,!(i=this.getScene()))return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateGammaSpace()});const l=i.getEngine();let c;l.supportsUniformBuffers&&(this._sceneUBO=i.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`)),this.onBeforeBindObservable.add(()=>{var h;null===(h=l._debugPushGroup)||void 0===h||h.call(l,`mirror generation for ${e}`,1)}),this.onAfterUnbindObservable.add(()=>{var h;null===(h=l._debugPopGroup)||void 0===h||h.call(l,1)}),this.onBeforeRenderObservable.add(()=>{this._sceneUBO&&(this._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(this._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),F.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(i.getViewMatrix(),this._transformMatrix),i.setTransformMatrix(this._transformMatrix,i.getProjectionMatrix()),c=i.clipPlane,i.clipPlane=this.mirrorPlane,i._mirroredCameraPosition=v.TransformCoordinates(i.activeCamera.globalPosition,this._mirrorMatrix)}),this.onAfterRenderObservable.add(()=>{this._sceneUBO&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(),i._mirroredCameraPosition=null,i.clipPlane=c})}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){const e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new _s("horizontal blur",new de(1,0),this._blurKernelX,this._blurRatio,null,U.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,1===this._blurRatio&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new _s("vertical blur",new de(0,1),this._blurKernelY,this._blurRatio,null,U.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=1!==this._blurRatio,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new qv(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){var e;super.dispose();const t=this.getScene();t&&t.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),null===(e=this._sceneUBO)||void 0===e||e.dispose()}}U._CreateMirror=(r,e,t,i)=>new qv(r,e,t,i);class os extends kt{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(F.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let s="";return e.forEach(n=>s+=n),new os(s,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,s=!0){const n=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const o=new os(e,t,null,!1,null,null,null,void 0,!0,i,s);return t.useDelayedTextureLoading=n,o}constructor(e,t,i=null,s=!1,n=null,o=null,a=null,l=5,c=!1,h=null,u=!1,d=.8,f=0,p,_){var m;super(t),this._lodScale=.8,this._lodOffset=0,this.onLoadObservable=new z,this.boundingBoxPosition=v.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this.name=e,this.url=e,this._noMipmap=s,this.hasAlpha=!1,this._format=l,this.isCube=!0,this._textureMatrix=F.Identity(),this._createPolynomials=u,this.coordinatesMode=U.CUBIC_MODE,this._extensions=i,this._files=n,this._forcedExtension=h,this._loaderOptions=p,this._useSRGBBuffer=_,this._lodScale=d,this._lodOffset=f,(e||n)&&this.updateURL(e,h,o,c,a,i,null===(m=this.getScene())||void 0===m?void 0:m.useDelayedTextureLoading,n)}getClassName(){return"CubeTexture"}updateURL(e,t,i=null,s=!1,n=null,o=null,a=!1,l=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);const c=e.lastIndexOf("."),h=t||(c>-1?e.substring(c).toLowerCase():""),u=0===h.indexOf(".dds"),d=0===h.indexOf(".env"),f=0===h.indexOf(".basis");if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=s,s&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(!f&&!d&&!u&&!o&&(o=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,o){for(let p=0;p<o.length;p++)this._files.push(e+o[p]);this._extensions=o}a?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=n):this._loadTexture(i,n)}delayLoad(e){4===this.delayLoadState&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t;e.updateFlag!==this._textureMatrix.updateFlag&&(e.isIdentity()!==this._textureMatrix.isIdentity()&&(null===(t=this.getScene())||void 0===t||t.markAllMaterialsAsDirty(1,i=>-1!==i.getActiveTextures().indexOf(this))),this._textureMatrix=e)}_loadTexture(e=null,t=null){var i;const s=this.getScene(),n=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const o=()=>{var l;this.onLoadObservable.notifyObservers(this),n&&(n.dispose(),null===(l=this.getScene())||void 0===l||l.markAllMaterialsAsDirty(1)),e&&e()},a=(l,c)=>{this._loadingError=!0,this._errorObject={message:l,exception:c},t&&t(l,c),U.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?q.SetImmediate(()=>o()):this._texture.onLoadedObservable.add(()=>o()):(this._texture=this._prefiltered?this._getEngine().createPrefilteredCubeTexture(this.url,s,this._lodScale,this._lodOffset,e,a,this._format,this._forcedExtension,this._createPolynomials):this._getEngine().createCubeTexture(this.url,s,this._files,this._noMipmap,e,a,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer),null===(i=this._texture)||void 0===i||i.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,i){const s=Ce.Parse(()=>{let n=!1;return e.prefiltered&&(n=e.prefiltered),new os(i+e.name,t,e.extensions,!1,e.files||null,null,null,void 0,n,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(s.boundingBoxPosition=v.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(s.boundingBoxSize=v.FromArray(e.boundingBoxSize)),e.animations)for(let n=0;n<e.animations.length;n++){const o=e.animations[n],a=hs("BABYLON.Animation");a&&s.animations.push(a.Parse(o))}return s}clone(){let e=0;const t=Ce.Clone(()=>{const i=new os(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=i.uniqueId,i},this);return t.uniqueId=e,t}}E([I()],os.prototype,"url",void 0),E([Ws()],os.prototype,"boundingBoxPosition",void 0),E([Ws()],os.prototype,"boundingBoxSize",null),E([I("rotationY")],os.prototype,"rotationY",null),E([I("files")],os.prototype,"_files",void 0),E([I("forcedExtension")],os.prototype,"_forcedExtension",void 0),E([I("extensions")],os.prototype,"_extensions",void 0),E([KF("textureMatrix")],os.prototype,"_textureMatrix",void 0),U._CubeTextureParser=os.Parse,le("BABYLON.CubeTexture",os);j.IncludesShadersStore.backgroundFragmentDeclaration="uniform vec4 vEyePosition;\nuniform vec4 vPrimaryColor;\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nuniform vec4 vPrimaryColorShadow;\n#endif\nuniform float shadowLevel;\nuniform float alpha;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\n#endif\n#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)\nuniform vec3 vBackgroundCenter;\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 vReflectionControl;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n";j.IncludesShadersStore.backgroundUboDeclaration="layout(std140,column_major) uniform;\nuniform Material\n{\nuniform vec4 vPrimaryColor;\nuniform vec4 vPrimaryColorShadow;\nuniform vec2 vDiffuseInfos;\nuniform vec2 vReflectionInfos;\nuniform mat4 diffuseMatrix;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\nuniform float fFovMultiplier;\nuniform float pointSize;\nuniform float shadowLevel;\nuniform float alpha;\n#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)\nuniform vec3 vBackgroundCenter;\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 vReflectionControl;\n#endif\n};\n#include<sceneUboDeclaration>\n";j.ShadersStore.backgroundPixelShader="#ifdef TEXTURELODSUPPORT\n#extension GL_EXT_shader_texture_lod : enable\n#endif\nprecision highp float;\n#include<__decl__backgroundFragment>\n#include<helperFunctions>\n#define RECIPROCAL_PI2 0.15915494\nvarying vec3 vPositionW;\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif \n#ifdef MAINUV2 \nvarying vec2 vMainUV2; \n#endif \n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV==1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV==2\n#define vDiffuseUV vMainUV2\n#else\nvarying vec2 vDiffuseUV;\n#endif\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n#ifndef SHADOWONLY\n#define SHADOWONLY;\n#endif\n#include<imageProcessingDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<imageProcessingFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#ifdef REFLECTIONFRESNEL\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\nvec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{\nfloat weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);\nreturn reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));\n}\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(0.0,1.0,0.0);\n#endif\nfloat shadow=1.;\nfloat globalShadow=0.;\nfloat shadowLightCount=0.;\n#include<lightFragment>[0..maxSimultaneousLights]\n#ifdef SHADOWINUSE\nglobalShadow/=shadowLightCount;\n#else\nglobalShadow=1.0;\n#endif\n#ifndef BACKMAT_SHADOWONLY\nvec4 reflectionColor=vec4(1.,1.,1.,1.);\n#ifdef REFLECTION\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=reflectionVector;\n#else\nvec2 reflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#ifdef REFLECTIONBLUR\nfloat reflectionLOD=vReflectionInfos.y;\n#ifdef TEXTURELODSUPPORT\nreflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\nreflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD);\nfloat lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;\nvec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);\nif(lodReflectionNormalizedDoubled<1.0){\nreflectionColor=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nreflectionSpecularMid,\nlodReflectionNormalizedDoubled\n);\n} else {\nreflectionColor=mix(\nreflectionSpecularMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);\n}\n#endif\n#else\nvec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);\nreflectionColor=reflectionSample;\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef GAMMAREFLECTION\nreflectionColor.rgb=toLinearSpace(reflectionColor.rgb);\n#endif\n#ifdef REFLECTIONBGR\nreflectionColor.rgb=reflectionColor.bgr;\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#endif\nvec3 diffuseColor=vec3(1.,1.,1.);\nfloat finalAlpha=alpha;\n#ifdef DIFFUSE\nvec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);\n#ifdef GAMMADIFFUSE\ndiffuseMap.rgb=toLinearSpace(diffuseMap.rgb);\n#endif\ndiffuseMap.rgb*=vDiffuseInfos.y;\n#ifdef DIFFUSEHASALPHA\nfinalAlpha*=diffuseMap.a;\n#endif\ndiffuseColor=diffuseMap.rgb;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 colorBase=diffuseColor;\n#else\nvec3 colorBase=reflectionColor.rgb*diffuseColor;\n#endif\ncolorBase=max(colorBase,0.0);\n#ifdef USERGBCOLOR\nvec3 finalColor=colorBase;\n#else\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nvec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);\n#else\nvec3 mainColor=vPrimaryColor.rgb;\n#endif\nvec3 finalColor=colorBase*mainColor;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 reflectionAmount=vReflectionControl.xxx;\nvec3 reflectionReflectance0=vReflectionControl.yyy;\nvec3 reflectionReflectance90=vReflectionControl.zzz;\nfloat VdotN=dot(normalize(vEyePosition.xyz),normalW);\nvec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);\nreflectionAmount*=planarReflectionFresnel;\n#ifdef REFLECTIONFALLOFF\nfloat reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);\nreflectionDistanceFalloff*=reflectionDistanceFalloff;\nreflectionAmount*=reflectionDistanceFalloff;\n#endif\nfinalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));\n#endif\n#ifdef OPACITYFRESNEL\nfloat viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));\nconst float startAngle=0.1;\nfloat fadeFactor=saturate(viewAngleToFloor/startAngle);\nfinalAlpha*=fadeFactor*fadeFactor;\n#endif\n#ifdef SHADOWINUSE\nfinalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);\n#endif\nvec4 color=vec4(finalColor,finalAlpha);\n#else\nvec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);\n#endif\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n#if !defined(SKIPFINALCOLORCLAMP)\ncolor.rgb=clamp(color.rgb,0.,30.0);\n#endif\n#else\ncolor=applyImageProcessing(color);\n#endif\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#ifdef NOISE\ncolor.rgb+=dither(vPositionW.xy,0.5);\ncolor=max(color,0.0);\n#endif\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";j.IncludesShadersStore.backgroundVertexDeclaration="uniform mat4 view;\nuniform mat4 viewProjection;\nuniform float shadowLevel;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\nuniform float fFovMultiplier;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n";j.ShadersStore.backgroundVertexShader="precision highp float;\n#include<__decl__backgroundVertex>\n#include<helperFunctions>\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nvarying vec2 vDiffuseUV;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=position;\n#endif\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n} else {\ngl_Position=viewProjectionR*finalWorld*vec4(position,1.0);\n}\n#else\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#endif\nvec4 worldPos=finalWorld*vec4(position,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normal);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));\n#ifdef EQUIRECTANGULAR_RELFECTION_FOV\nmat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));\nvec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));\nif (fFovMultiplier<=1.0) {\nvDirectionW=normalize(segment);\n} else {\nvDirectionW=normalize(vDirectionW+(vDirectionW-segment));\n}\n#endif\n#endif\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nif (vDiffuseInfos.x==0.)\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}\n";class dne extends Un{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class ft extends gp{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t*=2,this.reflectionReflectance0=ft.StandardReflectance0*t,this.reflectionReflectance90=ft.StandardReflectance90*t):(t=2*t-1,this.reflectionReflectance0=ft.StandardReflectance0+(1-ft.StandardReflectance0)*t,this.reflectionReflectance90=ft.StandardReflectance90+(1-ft.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()})))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}constructor(e,t){super(e,t),this.primaryColor=re.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=v.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._renderTargets=new ws(16),this._reflectionControls=vt.Zero(),this._white=re.White(),this._primaryShadowColor=re.Black(),this._primaryHighlightColor=re.Black(),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,i=!1){if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new dne);const s=this.getScene(),n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=s.getEngine();if(ce.PrepareDefinesForLights(s,e,n,!1,this._maxSimultaneousLights),n._needNormals=!0,ce.PrepareDefinesForMultiview(s,n),n._areTexturesDirty){if(n._needUVs=!1,s.texturesEnabled){if(s.getEngine().getCaps().textureLOD&&(n.TEXTURELODSUPPORT=!0),this._diffuseTexture&&pe.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;ce.PrepareDefinesForMergedUV(this._diffuseTexture,n,"DIFFUSE"),n.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,n.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,n.OPACITYFRESNEL=this._opacityFresnel}else n.DIFFUSE=!1,n.DIFFUSEDIRECTUV=0,n.DIFFUSEHASALPHA=!1,n.GAMMADIFFUSE=!1,n.OPACITYFRESNEL=!1;const a=this._reflectionTexture;if(a&&pe.ReflectionTextureEnabled){if(!a.isReadyOrNotBlocking())return!1;switch(n.REFLECTION=!0,n.GAMMAREFLECTION=a.gammaSpace,n.RGBDREFLECTION=a.isRGBD,n.REFLECTIONBLUR=this._reflectionBlur>0,n.LODINREFLECTIONALPHA=a.lodLevelInAlpha,n.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,n.REFLECTIONBGR=this.switchToBGR,a.coordinatesMode===U.INVCUBIC_MODE&&(n.INVERTCUBICMAP=!0),n.REFLECTIONMAP_3D=a.isCube,n.REFLECTIONMAP_OPPOSITEZ=n.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!a.invertZ:a.invertZ,a.coordinatesMode){case U.EXPLICIT_MODE:n.REFLECTIONMAP_EXPLICIT=!0;break;case U.PLANAR_MODE:n.REFLECTIONMAP_PLANAR=!0;break;case U.PROJECTION_MODE:n.REFLECTIONMAP_PROJECTION=!0;break;case U.SKYBOX_MODE:n.REFLECTIONMAP_SKYBOX=!0;break;case U.SPHERICAL_MODE:n.REFLECTIONMAP_SPHERICAL=!0;break;case U.EQUIRECTANGULAR_MODE:n.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case U.FIXED_EQUIRECTANGULAR_MODE:n.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case U.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:n.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;default:n.REFLECTIONMAP_CUBIC=!0}this.reflectionFresnel?(n.REFLECTIONFRESNEL=!0,n.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(n.REFLECTIONFRESNEL=!1,n.REFLECTIONFALLOFF=!1)}else n.REFLECTION=!1,n.REFLECTIONFRESNEL=!1,n.REFLECTIONFALLOFF=!1,n.REFLECTIONBLUR=!1,n.REFLECTIONMAP_3D=!1,n.REFLECTIONMAP_SPHERICAL=!1,n.REFLECTIONMAP_PLANAR=!1,n.REFLECTIONMAP_CUBIC=!1,n.REFLECTIONMAP_PROJECTION=!1,n.REFLECTIONMAP_SKYBOX=!1,n.REFLECTIONMAP_EXPLICIT=!1,n.REFLECTIONMAP_EQUIRECTANGULAR=!1,n.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,n.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,n.INVERTCUBICMAP=!1,n.REFLECTIONMAP_OPPOSITEZ=!1,n.LODINREFLECTIONALPHA=!1,n.GAMMAREFLECTION=!1,n.RGBDREFLECTION=!1}n.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,n.USERGBCOLOR=this._useRGBColor,n.NOISE=this._enableNoise}if(n._areLightsDirty&&(n.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(0!==this._primaryColorShadowLevel||0!==this._primaryColorHighlightLevel),n.BACKMAT_SHADOWONLY=this._shadowOnly),n._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(n)}if(ce.PrepareDefinesForMisc(e,s,!1,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),n),ce.PrepareDefinesForFrameBoundValues(s,o,this,n,i,null,t.getRenderingMesh().hasThinInstances),ce.PrepareDefinesForAttributes(e,n,!1,!0,!1)&&e&&!s.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(A.NormalKind)&&(e.createNormals(!0),V.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),n.isDirty){n.markAsProcessed(),s.resetCachedMaterial();const a=new oh;n.FOG&&a.addFallback(0,"FOG"),n.POINTSIZE&&a.addFallback(1,"POINTSIZE"),n.MULTIVIEW&&a.addFallback(0,"MULTIVIEW"),ce.HandleFallbacksForShadows(n,a,this._maxSimultaneousLights);const l=[A.PositionKind];n.NORMAL&&l.push(A.NormalKind),n.UV1&&l.push(A.UVKind),n.UV2&&l.push(A.UV2Kind),ce.PrepareAttributesForBones(l,e,n,a),ce.PrepareAttributesForInstances(l,n);const c=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix"];Uo(c);const h=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],u=["Material","Scene"];at&&(at.PrepareUniforms(c,n),at.PrepareSamplers(h,n)),ce.PrepareUniformsAndSamplersList({uniformsNames:c,uniformBuffersNames:u,samplers:h,defines:n,maxSimultaneousLights:this._maxSimultaneousLights});const d=n.toString(),f=s.getEngine().createEffect("background",{attributes:l,uniformsNames:c,uniformBuffersNames:u,samplers:h,defines:d,fallbacks:a,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights}},o);t.setEffect(f,n,this._materialContext),this.buildUniformLayout()}return!(!t.effect||!t.effect.isReady()||(n._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}_computePrimaryColorFromPerceptualColor(){!this.__perceptualColor||(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){0===this._primaryColorShadowLevel&&0===this._primaryColorHighlightLevel||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){const s=this.getScene(),n=i.materialDefines;if(!n)return;const o=i.effect;if(!o)return;this._activeEffect=o,this.bindOnlyWorldMatrix(e),ce.BindBonesParameters(t,this._activeEffect);const a=this._mustRebind(s,o,t.visibility);if(a){this._uniformBuffer.bindToEffect(o,"Material"),this.bindViewProjection(o);const l=this._reflectionTexture;(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync)&&(s.texturesEnabled&&(this._diffuseTexture&&pe.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),ce.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse")),l&&pe.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",l.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",l.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),n.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),s.texturesEnabled&&(this._diffuseTexture&&pe.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),l&&pe.ReflectionTextureEnabled&&(n.REFLECTIONBLUR&&n.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",l):n.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",l._lodTextureMid||l),this._uniformBuffer.setTexture("reflectionSamplerLow",l._lodTextureLow||l),this._uniformBuffer.setTexture("reflectionSamplerHigh",l._lodTextureHigh||l)):this._uniformBuffer.setTexture("reflectionSampler",l),n.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w)))),fo(this._activeEffect,this,s),s.bindEyePosition(o)}else s.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(o,"Material"),this._needToBindSceneUbo=!0);(a||!this.isFrozen)&&(s.lightsEnabled&&ce.BindLights(s,t,this._activeEffect,n,this._maxSimultaneousLights),this.bindView(o),ce.BindFogParameters(s,t,this._activeEffect,!0),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),this._uniformBuffer.update()}hasTexture(e){return!(!super.hasTexture(e)&&this._reflectionTexture!==e&&this._diffuseTexture!==e)}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return Ce.Clone(()=>new ft(e,this.getScene()),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return Ce.Parse(()=>new ft(e.name,t),e,t,i)}}ft.StandardReflectance0=.05,ft.StandardReflectance90=.5,E([us()],ft.prototype,"_primaryColor",void 0),E([ne("_markAllSubMeshesAsLightsDirty")],ft.prototype,"primaryColor",void 0),E([us()],ft.prototype,"__perceptualColor",void 0),E([I()],ft.prototype,"_primaryColorShadowLevel",void 0),E([I()],ft.prototype,"_primaryColorHighlightLevel",void 0),E([ne("_markAllSubMeshesAsLightsDirty")],ft.prototype,"primaryColorHighlightLevel",null),E([ht()],ft.prototype,"_reflectionTexture",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"reflectionTexture",void 0),E([I()],ft.prototype,"_reflectionBlur",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"reflectionBlur",void 0),E([ht()],ft.prototype,"_diffuseTexture",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"diffuseTexture",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"shadowLights",void 0),E([I()],ft.prototype,"_shadowLevel",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"shadowLevel",void 0),E([Ws()],ft.prototype,"_sceneCenter",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"sceneCenter",void 0),E([I()],ft.prototype,"_opacityFresnel",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"opacityFresnel",void 0),E([I()],ft.prototype,"_reflectionFresnel",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"reflectionFresnel",void 0),E([I()],ft.prototype,"_reflectionFalloffDistance",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"reflectionFalloffDistance",void 0),E([I()],ft.prototype,"_reflectionAmount",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"reflectionAmount",void 0),E([I()],ft.prototype,"_reflectionReflectance0",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"reflectionReflectance0",void 0),E([I()],ft.prototype,"_reflectionReflectance90",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"reflectionReflectance90",void 0),E([I()],ft.prototype,"_useRGBColor",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"useRGBColor",void 0),E([I()],ft.prototype,"_enableNoise",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"enableNoise",void 0),E([I()],ft.prototype,"_maxSimultaneousLights",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"maxSimultaneousLights",void 0),E([I()],ft.prototype,"_shadowOnly",void 0),E([ne("_markAllSubMeshesAsLightsDirty")],ft.prototype,"shadowOnly",void 0),E([$F()],ft.prototype,"_imageProcessingConfiguration",void 0),le("BABYLON.BackgroundMaterial",ft);let WU=(()=>{class r{static _GetDefaultOptions(t){return{createGround:!0,groundSize:15,groundTexture:this._GroundTextureCDNUrl,groundColor:new re(.2,.2,.3).toLinearSpace(t.getEngine().useExactSrgbConversions).scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this._SkyboxTextureCDNUrl,skyboxColor:new re(.2,.2,.3).toLinearSpace(t.getEngine().useExactSrgbConversions).scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:v.Zero(),setupImageProcessing:!0,environmentTexture:this._EnvironmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this._rootMesh}get skybox(){return this._skybox}get skyboxTexture(){return this._skyboxTexture}get skyboxMaterial(){return this._skyboxMaterial}get ground(){return this._ground}get groundTexture(){return this._groundTexture}get groundMirror(){return this._groundMirror}get groundMirrorRenderList(){return this._groundMirror?this._groundMirror.renderList:null}get groundMaterial(){return this._groundMaterial}constructor(t,i){this._errorHandler=(s,n)=>{this.onErrorObservable.notifyObservers({message:s,exception:n})},this._options={...r._GetDefaultOptions(i),...t},this._scene=i,this.onErrorObservable=new z,this._setupBackground(),this._setupImageProcessing()}updateOptions(t){const i={...this._options,...t};this._ground&&!i.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!i.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=i.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!i.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!i.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=i.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!i.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=i.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=i,this._setupBackground(),this._setupImageProcessing()}setMainColor(t){this.groundMaterial&&(this.groundMaterial.primaryColor=t),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=t),this.groundMirror&&(this.groundMirror.clearColor=new Te(t.r,t.g,t.b,1))}_setupImageProcessing(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())}_setupEnvironmentTexture(){if(this._scene.environmentTexture)return;if(this._options.environmentTexture instanceof kt)return void(this._scene.environmentTexture=this._options.environmentTexture);const t=os.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=t}_setupBackground(){this._rootMesh||(this._rootMesh=new G("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;const t=this._getSceneSize();this._options.createGround&&(this._setupGround(t),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(t),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(t),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=t.rootPosition.x,this._rootMesh.position.z=t.rootPosition.z,this._rootMesh.position.y=t.rootPosition.y}_getSceneSize(){let t=this._options.groundSize,i=this._options.skyboxSize,s=this._options.rootPosition;if(!this._scene.meshes||1===this._scene.meshes.length)return{groundSize:t,skyboxSize:i,rootPosition:s};const n=this._scene.getWorldExtends(a=>a!==this._ground&&a!==this._rootMesh&&a!==this._skybox),o=n.max.subtract(n.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof si&&this._scene.activeCamera.upperRadiusLimit&&(t=2*this._scene.activeCamera.upperRadiusLimit,i=t);const a=o.length();a>t&&(t=2*a,i=t),t*=1.1,i*=1.5,s=n.min.add(o.scale(.5)),s.y=n.min.y-this._options.groundYBias}return{groundSize:t,skyboxSize:i,rootPosition:s}}_setupGround(t){(!this._ground||this._ground.isDisposed())&&(this._ground=rh("BackgroundPlane",{size:t.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add(()=>{this._ground=null})),this._ground.receiveShadows=this._options.enableGroundShadow}_setupGroundMaterial(){this._groundMaterial||(this._groundMaterial=new ft("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)}_setupGroundDiffuseTexture(){if(this._groundMaterial&&!this._groundTexture){if(this._options.groundTexture instanceof kt)return void(this._groundMaterial.diffuseTexture=this._options.groundTexture);this._groundTexture=new U(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture}}_setupGroundMirrorTexture(t){const i=U.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new qv("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,U.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new Dr(0,-1,0,t.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=i,this._groundMirror.wrapV=i,this._groundMirror.renderList))for(let n=0;n<this._scene.meshes.length;n++){const o=this._scene.meshes[n];o!==this._ground&&o!==this._skybox&&o!==this._rootMesh&&this._groundMirror.renderList.push(o)}const s=this._options.groundColor.toGammaSpace(this._scene.getEngine().useExactSrgbConversions);this._groundMirror.clearColor=new Te(s.r,s.g,s.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel}_setupMirrorInGroundMaterial(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)}_setupSkybox(t){(!this._skybox||this._skybox.isDisposed())&&(this._skybox=Rp("BackgroundSkybox",{size:t.skyboxSize,sideOrientation:G.BACKSIDE},this._scene),this._skybox.onDisposeObservable.add(()=>{this._skybox=null})),this._skybox.parent=this._rootMesh}_setupSkyboxMaterial(){!this._skybox||(this._skyboxMaterial||(this._skyboxMaterial=new ft("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)}_setupSkyboxReflectionTexture(){if(this._skyboxMaterial&&!this._skyboxTexture){if(this._options.skyboxTexture instanceof kt)return void(this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture);this._skyboxTexture=new os(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=U.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture}}dispose(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)}}return r._GroundTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundGround.png",r._SkyboxTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundSkybox.dds",r._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/environments/environmentSpecular.env",r})(),cc=(()=>{class r extends We{get texture(){return this._texture}set texture(t){this._texture!==t&&(this._texture=t,this._useDirectMapping?(this._texture.wrapU=U.CLAMP_ADDRESSMODE,this._texture.wrapV=U.CLAMP_ADDRESSMODE,this._material.diffuseTexture=this._texture):(this._texture.coordinatesMode=U.FIXED_EQUIRECTANGULAR_MIRRORED_MODE,this._texture.wrapV=U.CLAMP_ADDRESSMODE,this._material.reflectionTexture=this._texture),this._changeTextureMode(this._textureMode))}get mesh(){return this._mesh}get fovMultiplier(){return this._material.fovMultiplier}set fovMultiplier(t){this._material.fovMultiplier=t}get textureMode(){return this._textureMode}set textureMode(t){this._textureMode!==t&&this._changeTextureMode(t)}get halfDome(){return this._halfDome}set halfDome(t){this._halfDome=t,this._halfDomeMask.setEnabled(t),this._changeTextureMode(this._textureMode)}set crossEye(t){this._crossEye=t,this._changeTextureMode(this._textureMode)}get crossEye(){return this._crossEye}get material(){return this._material}constructor(t,i,s,n,o=null){super(t,n),this.onError=o,this._halfDome=!1,this._crossEye=!1,this._useDirectMapping=!1,this._textureMode=r.MODE_MONOSCOPIC,this._onBeforeCameraRenderObserver=null,this.onLoadErrorObservable=new z,this.onLoadObservable=new z,n=this.getScene(),t=t||"textureDome",s.resolution=0|Math.abs(s.resolution)||32,s.clickToPlay=Boolean(s.clickToPlay),s.autoPlay=void 0===s.autoPlay||Boolean(s.autoPlay),s.loop=void 0===s.loop||Boolean(s.loop),s.size=Math.abs(s.size)||(n.activeCamera?.48*n.activeCamera.maxZ:1e3),this._useDirectMapping=void 0===s.useDirectMapping||s.useDirectMapping,void 0===s.faceForward&&(s.faceForward=!0),this._setReady(!1),this._mesh=s.mesh?s.mesh:po(t+"_mesh",{segments:s.resolution,diameter:s.size,updatable:!1,sideOrientation:G.BACKSIDE},n);const a=this._material=new ft(t+"_material",n);a.useEquirectangularFOV=!0,a.fovMultiplier=1,a.opacityFresnel=!1;const l=this._initTexture(i,n,s);if(this.texture=l,this._mesh.material=a,this._mesh.parent=this,this._halfDomeMask=po("",{slice:.5,diameter:.98*s.size,segments:2*s.resolution,sideOrientation:G.BACKSIDE},n),this._halfDomeMask.rotate(fs.X,-Math.PI/2),this._halfDomeMask.parent=this._mesh,this._halfDome=!!s.halfDomeMode,this._halfDomeMask.setEnabled(this._halfDome),this._crossEye=!!s.crossEyeMode,this._texture.anisotropicFilteringLevel=1,this._texture.onLoadObservable.addOnce(()=>{this._setReady(!0)}),s.faceForward&&n.activeCamera){const c=n.activeCamera,h=v.Forward(),u=v.TransformNormal(h,c.getViewMatrix());u.normalize(),this.rotation.y=Math.acos(v.Dot(h,u))}this._changeTextureMode(this._textureMode)}_changeTextureMode(t){switch(this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._textureMode=t,this._texture.uScale=1,this._texture.vScale=1,this._texture.uOffset=0,this._texture.vOffset=0,this._texture.vAng=0,t){case r.MODE_MONOSCOPIC:this._halfDome&&(this._texture.uScale=2,this._texture.uOffset=-1);break;case r.MODE_SIDEBYSIDE:{this._texture.uScale=this._halfDome?.99999:.5;const i=this._halfDome?0:.5,s=this._halfDome?-.5:0;this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(n=>{let o=n.isRightCamera;this._crossEye&&(o=!o),this._texture.uOffset=o?i:s});break}case r.MODE_TOPBOTTOM:this._texture.vScale=this._halfDome?.99999:.5,this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(i=>{let s=i.isRightCamera;this._crossEye&&(s=!s),this._texture.vOffset=s?.5:0})}}dispose(t,i=!1){this._texture.dispose(),this._mesh.dispose(),this._material.dispose(),this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this.onLoadErrorObservable.clear(),this.onLoadObservable.clear(),super.dispose(t,i)}}return r.MODE_MONOSCOPIC=0,r.MODE_TOPBOTTOM=1,r.MODE_SIDEBYSIDE=2,r})();class TC extends cc{get photoTexture(){return this.texture}set photoTexture(e){this.texture=e}get imageMode(){return this.textureMode}set imageMode(e){this.textureMode=e}_initTexture(e,t,i){return new U(e,t,!i.generateMipMaps,!this._useDirectMapping,void 0,()=>{this.onLoadObservable.notifyObservers()},(s,n)=>{this.onLoadErrorObservable.notifyObservers(s||"Unknown error occured"),this.onError&&this.onError(s,n)})}}TC.MODE_MONOSCOPIC=cc.MODE_MONOSCOPIC,TC.MODE_TOPBOTTOM=cc.MODE_TOPBOTTOM,TC.MODE_SIDEBYSIDE=cc.MODE_SIDEBYSIDE;let pne=0;const $v=r=>{if(!r.environmentBRDFTexture){const e=r.useDelayedTextureLoading;r.useDelayedTextureLoading=!1;const t=r._blockEntityCollection;r._blockEntityCollection=!1;const i=U.CreateFromBase64String("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==","EnvironmentBRDFTexture"+pne++,r,!0,!1,U.BILINEAR_SAMPLINGMODE);r._blockEntityCollection=t;const s=r.getEngine().getLoadedTexturesCache(),n=s.indexOf(i.getInternalTexture());-1!==n&&s.splice(n,1),i.isRGBD=!0,i.wrapU=U.CLAMP_ADDRESSMODE,i.wrapV=U.CLAMP_ADDRESSMODE,r.environmentBRDFTexture=i,r.useDelayedTextureLoading=e,rC.ExpandRGBDTexture(i);const o=r.getEngine().onContextRestoredObservable.add(()=>{i.isRGBD=!0;const a=()=>{i.isReady()?rC.ExpandRGBDTexture(i):q.SetImmediate(a)};a()});r.onDisposeObservable.add(()=>{r.getEngine().onContextRestoredObservable.remove(o)})}return r.environmentBRDFTexture};class _ne extends Un{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1}}class mr extends Wo{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}constructor(e,t=!0){super(e,"PBRBRDF",90,new _ne,t),this._useEnergyConservation=mr.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=mr.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=mr.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=mr.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=mr.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=mr.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=mr.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=mr.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation}getClassName(){return"PBRBRDFConfiguration"}}mr.DEFAULT_USE_ENERGY_CONSERVATION=!0,mr.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0,mr.DEFAULT_USE_SPHERICAL_HARMONICS=!0,mr.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0,E([I(),ne("_markAllSubMeshesAsMiscDirty")],mr.prototype,"useEnergyConservation",void 0),E([I(),ne("_markAllSubMeshesAsMiscDirty")],mr.prototype,"useSmithVisibilityHeightCorrelated",void 0),E([I(),ne("_markAllSubMeshesAsMiscDirty")],mr.prototype,"useSphericalHarmonics",void 0),E([I(),ne("_markAllSubMeshesAsMiscDirty")],mr.prototype,"useSpecularGlossinessInputEnergyConservation",void 0);j.IncludesShadersStore.pbrFragmentDeclaration="uniform vec4 vEyePosition;\nuniform vec3 vReflectionColor;\nuniform vec4 vAlbedoColor;\nuniform vec4 vLightingIntensity;\nuniform vec4 vReflectivityColor;\nuniform vec4 vMetallicReflectanceFactors;\nuniform vec3 vEmissiveColor;\nuniform float visibility;\nuniform vec3 vAmbientColor;\n#ifdef ALBEDO\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform vec4 vAmbientInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#ifdef OPACITY\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REALTIME_FILTERING\nuniform vec2 vReflectionFilteringInfo;\n#endif\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize; \n#endif\n#endif\n#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)\nuniform vec3 vRefractionPosition;\nuniform vec3 vRefractionSize; \n#endif\n#ifdef CLEARCOAT\nuniform vec2 vClearCoatParams;\nuniform vec4 vClearCoatRefractionParams;\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;\nuniform vec2 vClearCoatTangentSpaceParams;\nuniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT\nuniform vec4 vClearCoatTintParams;\nuniform float clearCoatColorAtDistance;\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;\nuniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#endif\n#ifdef IRIDESCENCE\nuniform vec4 vIridescenceParams;\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\nuniform vec3 vAnisotropy;\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;\nuniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\nuniform vec4 vSheenColor;\n#ifdef SHEEN_ROUGHNESS\nuniform float vSheenRoughness;\n#endif\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionMicrosurfaceInfos;\nuniform vec4 vRefractionInfos;\nuniform mat4 refractionMatrix;\n#ifdef REALTIME_FILTERING\nuniform vec2 vRefractionFilteringInfo;\n#endif\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;\nuniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;\nuniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;\nuniform mat4 translucencyIntensityMatrix;\n#endif\nuniform vec2 vThicknessParam;\nuniform vec3 vDiffusionDistance;\nuniform vec4 vTintColor;\nuniform vec3 vSubSurfaceIntensity;\n#endif\n#ifdef PREPASS\n#ifdef SS_SCATTERING\nuniform float scatteringDiffusionProfile;\n#endif\n#endif\n#if DEBUGMODE>0\nuniform vec2 vDebugMode;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#include<decalFragmentDeclaration>\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;\nuniform vec3 vSphericalL1_1;\nuniform vec3 vSphericalL10;\nuniform vec3 vSphericalL11;\nuniform vec3 vSphericalL2_2;\nuniform vec3 vSphericalL2_1;\nuniform vec3 vSphericalL20;\nuniform vec3 vSphericalL21;\nuniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;\nuniform vec3 vSphericalY;\nuniform vec3 vSphericalZ;\nuniform vec3 vSphericalXX_ZZ;\nuniform vec3 vSphericalYY_ZZ;\nuniform vec3 vSphericalZZ;\nuniform vec3 vSphericalXY;\nuniform vec3 vSphericalYZ;\nuniform vec3 vSphericalZX;\n#endif\n#endif\n#define ADDITIONAL_FRAGMENT_DECLARATION\n";j.IncludesShadersStore.pbrUboDeclaration="layout(std140,column_major) uniform;\nuniform Material {\nvec2 vAlbedoInfos;\nvec4 vAmbientInfos;\nvec2 vOpacityInfos;\nvec2 vEmissiveInfos;\nvec2 vLightmapInfos;\nvec3 vReflectivityInfos;\nvec2 vMicroSurfaceSamplerInfos;\nvec2 vReflectionInfos;\nvec2 vReflectionFilteringInfo;\nvec3 vReflectionPosition;\nvec3 vReflectionSize;\nvec3 vBumpInfos;\nmat4 albedoMatrix;\nmat4 ambientMatrix;\nmat4 opacityMatrix;\nmat4 emissiveMatrix;\nmat4 lightmapMatrix;\nmat4 reflectivityMatrix;\nmat4 microSurfaceSamplerMatrix;\nmat4 bumpMatrix;\nvec2 vTangentSpaceParams;\nmat4 reflectionMatrix;\nvec3 vReflectionColor;\nvec4 vAlbedoColor;\nvec4 vLightingIntensity;\nvec3 vReflectionMicrosurfaceInfos;\nfloat pointSize;\nvec4 vReflectivityColor;\nvec3 vEmissiveColor;\nvec3 vAmbientColor;\nvec2 vDebugMode;\nvec4 vMetallicReflectanceFactors;\nvec2 vMetallicReflectanceInfos;\nmat4 metallicReflectanceMatrix;\nvec2 vReflectanceInfos;\nmat4 reflectanceMatrix;\nvec3 vSphericalL00;\nvec3 vSphericalL1_1;\nvec3 vSphericalL10;\nvec3 vSphericalL11;\nvec3 vSphericalL2_2;\nvec3 vSphericalL2_1;\nvec3 vSphericalL20;\nvec3 vSphericalL21;\nvec3 vSphericalL22;\nvec3 vSphericalX;\nvec3 vSphericalY;\nvec3 vSphericalZ;\nvec3 vSphericalXX_ZZ;\nvec3 vSphericalYY_ZZ;\nvec3 vSphericalZZ;\nvec3 vSphericalXY;\nvec3 vSphericalYZ;\nvec3 vSphericalZX;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";j.IncludesShadersStore.pbrFragmentExtraDeclaration="varying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n";j.IncludesShadersStore.samplerFragmentAlternateDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n#endif\n";j.IncludesShadersStore.pbrFragmentSamplersDeclaration="#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef CLEARCOAT\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL)\nuniform sampler2D clearCoatRoughnessSampler;\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL)\nuniform sampler2D sheenRoughnessSampler;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform samplerCube irradianceSampler;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D reflectionSamplerLow;\nuniform sampler2D reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform sampler2D irradianceSampler;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#endif\n#ifdef ENVIRONMENTBRDF\nuniform sampler2D environmentBrdfSampler;\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#ifdef SS_REFRACTIONMAP_3D\n#define sampleRefraction(s,c) textureCube(s,c)\nuniform samplerCube refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube refractionSamplerLow;\nuniform samplerCube refractionSamplerHigh;\n#endif\n#else\n#define sampleRefraction(s,c) texture2D(s,c)\nuniform sampler2D refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D refractionSamplerLow;\nuniform sampler2D refractionSamplerHigh;\n#endif\n#endif\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)\n#endif\n";j.IncludesShadersStore.subSurfaceScatteringFunctions="bool testLightingForSSS(float diffusionProfile)\n{\nreturn diffusionProfile<1.;\n}";j.IncludesShadersStore.importanceSampling="vec3 hemisphereCosSample(vec2 u) {\nfloat phi=2.*PI*u.x;\nfloat cosTheta2=1.-u.y;\nfloat cosTheta=sqrt(cosTheta2);\nfloat sinTheta=sqrt(1.-cosTheta2);\nreturn vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);\n}\nvec3 hemisphereImportanceSampleDggx(vec2 u,float a) {\nfloat phi=2.*PI*u.x;\nfloat cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));\nfloat cosTheta=sqrt(cosTheta2);\nfloat sinTheta=sqrt(1.-cosTheta2);\nreturn vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);\n}\nvec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { \nfloat phi=2.*PI*u.x;\nfloat sinTheta=pow(u.y,a/(2.*a+1.));\nfloat cosTheta=sqrt(1.-sinTheta*sinTheta);\nreturn vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);\n}";j.IncludesShadersStore.pbrHelperFunctions="#define RECIPROCAL_PI2 0.15915494\n#define RECIPROCAL_PI 0.31830988618\n#define MINIMUMVARIANCE 0.0005\nfloat convertRoughnessToAverageSlope(float roughness)\n{\nreturn square(roughness)+MINIMUMVARIANCE;\n}\nfloat fresnelGrazingReflectance(float reflectance0) {\nfloat reflectance90=saturate(reflectance0*25.0);\nreturn reflectance90;\n}\nvec2 getAARoughnessFactors(vec3 normalVector) {\n#ifdef SPECULARAA\nvec3 nDfdx=dFdx(normalVector.xyz);\nvec3 nDfdy=dFdy(normalVector.xyz);\nfloat slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));\nfloat geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);\nfloat geometricAlphaGFactor=sqrt(slopeSquare);\ngeometricAlphaGFactor*=0.75;\nreturn vec2(geometricRoughnessFactor,geometricAlphaGFactor);\n#else\nreturn vec2(0.);\n#endif\n}\n#ifdef ANISOTROPIC\nvec2 getAnisotropicRoughness(float alphaG,float anisotropy) {\nfloat alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);\nfloat alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);\nreturn vec2(alphaT,alphaB);\n}\nvec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy) {\nvec3 anisotropicFrameDirection=anisotropy>=0.0 ? B : T;\nvec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);\nvec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);\nvec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));\nreturn anisotropicNormal;\n}\n#endif\n#if defined(CLEARCOAT) || defined(SS_REFRACTION)\nvec3 cocaLambert(vec3 alpha,float distance) {\nreturn exp(-alpha*distance);\n}\nvec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {\nreturn cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));\n}\nvec3 computeColorAtDistanceInMedia(vec3 color,float distance) {\nreturn -log(color)/distance;\n}\nvec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {\nvec3 clearCoatAbsorption=mix(vec3(1.0),\ncocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),\nclearCoatIntensity);\nreturn clearCoatAbsorption;\n}\n#endif\n#ifdef MICROSURFACEAUTOMATIC\nfloat computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)\n{\nconst float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;\nfloat reflectivityLuminance=getLuminance(reflectivityColor);\nfloat reflectivityLuma=sqrt(reflectivityLuminance);\nmicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;\nreturn microSurface;\n}\n#endif\n";j.IncludesShadersStore.harmonicsFunctions="#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nvec3 computeEnvironmentIrradiance(vec3 normal) {\nreturn vSphericalL00\n+ vSphericalL1_1*(normal.y)\n+ vSphericalL10*(normal.z)\n+ vSphericalL11*(normal.x)\n+ vSphericalL2_2*(normal.y*normal.x)\n+ vSphericalL2_1*(normal.y*normal.z)\n+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)\n+ vSphericalL21*(normal.z*normal.x)\n+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));\n}\n#else\nvec3 computeEnvironmentIrradiance(vec3 normal) {\nfloat Nx=normal.x;\nfloat Ny=normal.y;\nfloat Nz=normal.z;\nvec3 C1=vSphericalZZ.rgb;\nvec3 Cx=vSphericalX.rgb;\nvec3 Cy=vSphericalY.rgb;\nvec3 Cz=vSphericalZ.rgb;\nvec3 Cxx_zz=vSphericalXX_ZZ.rgb;\nvec3 Cyy_zz=vSphericalYY_ZZ.rgb;\nvec3 Cxy=vSphericalXY.rgb;\nvec3 Cyz=vSphericalYZ.rgb;\nvec3 Czx=vSphericalZX.rgb;\nvec3 a1=Cyy_zz*Ny+Cy;\nvec3 a2=Cyz*Nz+a1;\nvec3 b1=Czx*Nz+Cx;\nvec3 b2=Cxy*Ny+b1;\nvec3 b3=Cxx_zz*Nx+b2;\nvec3 t1=Cz *Nz+C1;\nvec3 t2=a2 *Ny+t1;\nvec3 t3=b3 *Nx+t2;\nreturn t3;\n}\n#endif\n#endif\n";j.IncludesShadersStore.pbrDirectLightingSetupFunctions="struct preLightingInfo\n{\nvec3 lightOffset;\nfloat lightDistanceSquared;\nfloat lightDistance;\nfloat attenuation;\nvec3 L;\nvec3 H;\nfloat NdotV;\nfloat NdotLUnclamped;\nfloat NdotL;\nfloat VdotH;\nfloat roughness;\n#ifdef IRIDESCENCE\nfloat iridescenceIntensity;\n#endif\n};\npreLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {\npreLightingInfo result;\nresult.lightOffset=lightData.xyz-vPositionW;\nresult.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);\nresult.lightDistance=sqrt(result.lightDistanceSquared);\nresult.L=normalize(result.lightOffset);\nresult.H=normalize(V+result.L);\nresult.VdotH=saturate(dot(V,result.H));\nresult.NdotLUnclamped=dot(N,result.L);\nresult.NdotL=saturateEps(result.NdotLUnclamped);\nreturn result;\n}\npreLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {\npreLightingInfo result;\nresult.lightDistance=length(-lightData.xyz);\nresult.L=normalize(-lightData.xyz);\nresult.H=normalize(V+result.L);\nresult.VdotH=saturate(dot(V,result.H));\nresult.NdotLUnclamped=dot(N,result.L);\nresult.NdotL=saturateEps(result.NdotLUnclamped);\nreturn result;\n}\npreLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {\npreLightingInfo result;\nresult.NdotL=dot(N,lightData.xyz)*0.5+0.5;\nresult.NdotL=saturateEps(result.NdotL);\nresult.NdotLUnclamped=result.NdotL;\n#ifdef SPECULARTERM\nresult.L=normalize(lightData.xyz);\nresult.H=normalize(V+result.L);\nresult.VdotH=saturate(dot(V,result.H));\n#endif\nreturn result;\n}";j.IncludesShadersStore.pbrDirectLightingFalloffFunctions="float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)\n{\nreturn max(0.,1.0-length(lightOffset)/range);\n}\nfloat computeDistanceLightFalloff_Physical(float lightDistanceSquared)\n{\nreturn 1.0/maxEps(lightDistanceSquared);\n}\nfloat computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)\n{\nfloat lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);\nfloat factor=lightDistanceSquared*inverseSquaredRange;\nfloat attenuation=saturate(1.0-factor*factor);\nattenuation*=attenuation;\nlightDistanceFalloff*=attenuation;\nreturn lightDistanceFalloff;\n}\nfloat computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDistanceLightFalloff_Physical(lightDistanceSquared);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);\n#else\nreturn computeDistanceLightFalloff_Standard(lightOffset,range);\n#endif\n}\nfloat computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)\n{\nfloat falloff=0.0;\nfloat cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));\nif (cosAngle>=cosHalfAngle)\n{\nfalloff=max(0.,pow(cosAngle,exponent));\n}\nreturn falloff;\n}\nfloat computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)\n{\nconst float kMinusLog2ConeAngleIntensityRatio=6.64385618977; \nfloat concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);\nvec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);\nfloat falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));\nreturn falloff;\n}\nfloat computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)\n{\nfloat cd=dot(-lightDirection,directionToLightCenterW);\nfloat falloff=saturate(cd*lightAngleScale+lightAngleOffset);\nfalloff*=falloff;\nreturn falloff;\n}\nfloat computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);\n#else\nreturn computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);\n#endif\n}";j.IncludesShadersStore.pbrBRDFFunctions="#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {\nreturn 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);\n}\n#endif\n#ifdef ENVIRONMENTBRDF\nvec3 getBRDFLookup(float NdotV,float perceptualRoughness) {\nvec2 UV=vec2(NdotV,perceptualRoughness);\nvec4 brdfLookup=texture2D(environmentBrdfSampler,UV);\n#ifdef ENVIRONMENTBRDF_RGBD\nbrdfLookup.rgb=fromRGBD(brdfLookup.rgba);\n#endif\nreturn brdfLookup.rgb;\n}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;\n#endif\nreturn reflectance;\n}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#endif\nreturn reflectance;\n}\n#endif\n/* NOT USED\n#if defined(SHEEN) && defined(SHEEN_SOFTER)\nfloat getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)\n{\nfloat c=1.0-NdotV;\nfloat c3=c*c*c;\nreturn 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));\n}\n#endif\n*/\n#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)\nvec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{\nfloat weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);\nreturn reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));\n}\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\n/**\n* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.\n* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table\n*/\nvec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {\nvec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;\nreturn sheenEnvironmentReflectance;\n}\n#endif\nvec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)\n{\nreturn reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);\n}\nfloat fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)\n{\nreturn reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);\n}\n#ifdef CLEARCOAT\nvec3 getR0RemappedForClearCoat(vec3 f0) {\n#ifdef CLEARCOAT_DEFAULTIOR\n#ifdef MOBILE\nreturn saturate(f0*(f0*0.526868+0.529324)-0.0482256);\n#else\nreturn saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);\n#endif\n#else\nvec3 s=sqrt(f0);\nvec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);\nreturn square(t);\n#endif\n}\n#endif\n#ifdef IRIDESCENCE\nconst mat3 XYZ_TO_REC709=mat3(\n3.2404542,-0.9692660, 0.0556434,\n-1.5371385, 1.8760108,-0.2040259,\n-0.4985314, 0.0415560, 1.0572252\n);\nvec3 getIORTfromAirToSurfaceR0(vec3 f0) {\nvec3 sqrtF0=sqrt(f0);\nreturn (1.+sqrtF0)/(1.-sqrtF0);\n}\nvec3 getR0fromIORs(vec3 iorT,float iorI) {\nreturn square((iorT-vec3(iorI))/(iorT+vec3(iorI)));\n}\nfloat getR0fromIORs(float iorT,float iorI) {\nreturn square((iorT-iorI)/(iorT+iorI));\n}\nvec3 evalSensitivity(float opd,vec3 shift) {\nfloat phase=2.0*PI*opd*1.0e-9;\nconst vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);\nconst vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);\nconst vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);\nvec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);\nxyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));\nxyz/=1.0685e-7;\nvec3 srgb=XYZ_TO_REC709*xyz;\nreturn srgb;\n}\nvec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {\nvec3 I=vec3(1.0);\nfloat iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));\nfloat sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));\nfloat cosTheta2Sq=1.0-sinTheta2Sq;\nif (cosTheta2Sq<0.0) {\nreturn I;\n}\nfloat cosTheta2=sqrt(cosTheta2Sq);\nfloat R0=getR0fromIORs(iridescenceIOR,outsideIOR);\nfloat R12=fresnelSchlickGGX(cosTheta1,R0,1.);\nfloat R21=R12;\nfloat T121=1.0-R12;\nfloat phi12=0.0;\nif (iridescenceIOR<outsideIOR) phi12=PI;\nfloat phi21=PI-phi12;\nvec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); \nvec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);\nvec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));\nvec3 phi23=vec3(0.0);\nif (baseIOR[0]<iridescenceIOR) phi23[0]=PI;\nif (baseIOR[1]<iridescenceIOR) phi23[1]=PI;\nif (baseIOR[2]<iridescenceIOR) phi23[2]=PI;\nfloat opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;\nvec3 phi=vec3(phi21)+phi23;\nvec3 R123=clamp(R12*R23,1e-5,0.9999);\nvec3 r123=sqrt(R123);\nvec3 Rs=square(T121)*R23/(vec3(1.0)-R123);\nvec3 C0=R12+Rs;\nI=C0;\nvec3 Cm=Rs-T121;\nfor (int m=1; m<=2; ++m)\n{\nCm*=r123;\nvec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);\nI+=Cm*Sm;\n}\nreturn max(I,vec3(0.0));\n}\n#endif\nfloat normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)\n{\nfloat a2=square(alphaG);\nfloat d=NdotH*NdotH*(a2-1.0)+1.0;\nreturn a2/(PI*d*d);\n}\n#ifdef SHEEN\nfloat normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)\n{\nfloat invR=1./alphaG;\nfloat cos2h=NdotH*NdotH;\nfloat sin2h=1.-cos2h;\nreturn (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);\n}\n#endif\n#ifdef ANISOTROPIC\nfloat normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {\nfloat a2=alphaTB.x*alphaTB.y;\nvec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);\nfloat v2=dot(v,v);\nfloat w2=a2/v2;\nreturn a2*w2*w2*RECIPROCAL_PI;\n}\n#endif\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {\n#ifdef MOBILE\nfloat GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);\nfloat GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);\nreturn 0.5/(GGXV+GGXL);\n#else\nfloat a2=alphaG*alphaG;\nfloat GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);\nfloat GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);\nreturn 0.5/(GGXV+GGXL);\n#endif\n}\n#else\nfloat smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)\n{\n#ifdef MOBILE\nreturn 1.0/(dot+alphaG+(1.0-alphaG)*dot ));\n#else\nfloat alphaSquared=alphaG*alphaG;\nreturn 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));\n#endif\n}\nfloat smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)\n{\nfloat visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);\nreturn visibility;\n}\n#endif\n#ifdef ANISOTROPIC\nfloat smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {\nfloat lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));\nfloat lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));\nfloat v=0.5/(lambdaV+lambdaL);\nreturn v;\n}\n#endif\n#ifdef CLEARCOAT\nfloat visibility_Kelemen(float VdotH) {\nreturn 0.25/(VdotH*VdotH); \n}\n#endif\n#ifdef SHEEN\nfloat visibility_Ashikhmin(float NdotL,float NdotV)\n{\nreturn 1./(4.*(NdotL+NdotV-NdotL*NdotV));\n}\n/* NOT USED\n#ifdef SHEEN_SOFTER\nfloat l(float x,float alphaG)\n{\nfloat oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);\nfloat a=mix(21.5473,25.3245,oneMinusAlphaSq);\nfloat b=mix(3.82987,3.32435,oneMinusAlphaSq);\nfloat c=mix(0.19823,0.16801,oneMinusAlphaSq);\nfloat d=mix(-1.97760,-1.27393,oneMinusAlphaSq);\nfloat e=mix(-4.32054,-4.85967,oneMinusAlphaSq);\nreturn a/(1.0+b*pow(x,c))+d*x+e;\n}\nfloat lambdaSheen(float cosTheta,float alphaG)\n{\nreturn abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));\n}\nfloat visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)\n{\nfloat G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));\nreturn G/(4.0*NdotV*NdotL);\n}\n#endif\n*/\n#endif\nfloat diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {\nfloat diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));\nfloat diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));\nfloat diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;\nfloat fresnel =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);\nreturn fresnel/PI;\n}\n#ifdef SS_TRANSLUCENCY\nvec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {\nvec3 S=1./maxEps(diffusionDistance);\nvec3 temp=exp((-0.333333333*thickness)*S);\nreturn tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);\n}\nfloat computeWrappedDiffuseNdotL(float NdotL,float w) {\nfloat t=1.0+w;\nfloat invt2=1.0/square(t);\nreturn saturate((NdotL+w)*invt2);\n}\n#endif\n";j.IncludesShadersStore.hdrFilteringFunctions="#ifdef NUM_SAMPLES\n#if NUM_SAMPLES>0\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfloat radicalInverse_VdC(uint bits) \n{\nbits=(bits<<16u) | (bits>>16u);\nbits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);\nbits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);\nbits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);\nbits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);\nreturn float(bits)*2.3283064365386963e-10; \n}\nvec2 hammersley(uint i,uint N)\n{\nreturn vec2(float(i)/float(N),radicalInverse_VdC(i));\n}\n#else\nfloat vanDerCorpus(int n,int base)\n{\nfloat invBase=1.0/float(base);\nfloat denom =1.0;\nfloat result =0.0;\nfor(int i=0; i<32; ++i)\n{\nif(n>0)\n{\ndenom =mod(float(n),2.0);\nresult+=denom*invBase;\ninvBase=invBase/2.0;\nn =int(float(n)/2.0);\n}\n}\nreturn result;\n}\nvec2 hammersley(int i,int N)\n{\nreturn vec2(float(i)/float(N),vanDerCorpus(i,2));\n}\n#endif\nfloat log4(float x) {\nreturn log2(x)/2.;\n}\nconst float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);\nconst float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;\nconst float K=4.;\n#define inline\nvec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)\n{\nvec3 n=normalize(inputN);\nvec3 result=vec3(0.0);\nvec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);\ntangent=normalize(cross(tangent,n));\nvec3 bitangent=cross(n,tangent);\nmat3 tbn=mat3(tangent,bitangent,n);\nfloat maxLevel=filteringInfo.y;\nfloat dim0=filteringInfo.x;\nfloat omegaP=(4.*PI)/(6.*dim0*dim0);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{\nvec2 Xi=hammersley(i,NUM_SAMPLES);\nvec3 Ls=hemisphereCosSample(Xi);\nLs=normalize(Ls);\nvec3 Ns=vec3(0.,0.,1.);\nfloat NoL=dot(Ns,Ls);\nif (NoL>0.) {\nfloat pdf_inversed=PI/NoL;\nfloat omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;\nfloat l=log4(omegaS)-log4(omegaP)+log4(K);\nfloat mipLevel=clamp(l,0.0,maxLevel);\nvec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c;\n}\n}\nresult=result*NUM_SAMPLES_FLOAT_INVERSED;\nreturn result;\n}\n#define inline\nvec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)\n{\nvec3 n=normalize(inputN);\nif (alphaG==0.) {\nvec3 c=textureCube(inputTexture,n).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nreturn c;\n} else {\nvec3 result=vec3(0.);\nvec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);\ntangent=normalize(cross(tangent,n));\nvec3 bitangent=cross(n,tangent);\nmat3 tbn=mat3(tangent,bitangent,n);\nfloat maxLevel=filteringInfo.y;\nfloat dim0=filteringInfo.x;\nfloat omegaP=(4.*PI)/(6.*dim0*dim0);\nfloat weight=0.;\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{\nvec2 Xi=hammersley(i,NUM_SAMPLES);\nvec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);\nfloat NoV=1.;\nfloat NoH=H.z;\nfloat NoH2=H.z*H.z;\nfloat NoL=2.*NoH2-1.;\nvec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);\nL=normalize(L);\nif (NoL>0.) {\nfloat pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);\nfloat omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;\nfloat l=log4(omegaS)-log4(omegaP)+log4(K);\nfloat mipLevel=clamp(float(l),0.0,maxLevel);\nweight+=NoL;\nvec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c*NoL;\n}\n}\nresult=result/weight;\nreturn result;\n}\n}\n#endif\n#endif\n";j.IncludesShadersStore.pbrDirectLightingFunctions="#define CLEARCOATREFLECTANCE90 1.0\nstruct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef CLEARCOAT\nvec4 clearCoat;\n#endif\n#ifdef SHEEN\nvec3 sheen;\n#endif\n};\nfloat adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {\n#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)\nfloat lightRoughness=lightRadius/lightDistance;\nfloat totalRoughness=saturate(lightRoughness+roughness);\nreturn totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nvec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {\nreturn mix(groundColor,lightColor,info.NdotL);\n}\nvec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {\nfloat diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);\nreturn diffuseTerm*info.attenuation*info.NdotL*lightColor;\n}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){\nvec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);\nstrq/=strq.w;\nvec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;\nreturn toLinearSpace(textureColor);\n}\n#ifdef SS_TRANSLUCENCY\nvec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {\nfloat NdotL=absEps(info.NdotLUnclamped);\nfloat wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);\nfloat trAdapt=step(0.,info.NdotLUnclamped);\nvec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);\nfloat diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);\nreturn diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;\n}\n#endif\n#ifdef SPECULARTERM\nvec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {\nfloat NdotH=saturateEps(dot(N,info.H));\nfloat roughness=max(info.roughness,geometricRoughnessFactor);\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nvec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);\n#else\nfloat smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);\n#endif\nvec3 specTerm=fresnel*distribution*smithVisibility;\nreturn specTerm*info.attenuation*info.NdotL*lightColor;\n}\n#endif\n#ifdef ANISOTROPIC\nvec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {\nfloat NdotH=saturateEps(dot(N,info.H));\nfloat TdotH=dot(T,info.H);\nfloat BdotH=dot(B,info.H);\nfloat TdotV=dot(T,V);\nfloat BdotV=dot(B,V);\nfloat TdotL=dot(T,info.L);\nfloat BdotL=dot(B,info.L);\nfloat alphaG=convertRoughnessToAverageSlope(info.roughness);\nvec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);\nalphaTB=max(alphaTB,square(geometricRoughnessFactor));\nvec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);\nfloat smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);\nvec3 specTerm=fresnel*distribution*smithVisibility;\nreturn specTerm*info.attenuation*info.NdotL*lightColor;\n}\n#endif\n#ifdef CLEARCOAT\nvec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {\nfloat NccdotL=saturateEps(dot(Ncc,info.L));\nfloat NccdotH=saturateEps(dot(Ncc,info.H));\nfloat clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);\nfloat alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);\nfloat fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);\nfresnel*=clearCoatIntensity;\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);\nfloat kelemenVisibility=visibility_Kelemen(info.VdotH);\nfloat clearCoatTerm=fresnel*distribution*kelemenVisibility;\nreturn vec4(\nclearCoatTerm*info.attenuation*NccdotL*lightColor,\n1.0-fresnel\n);\n}\nvec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {\nvec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);\nfloat NdotLRefract=saturateEps(dot(Ncc,LRefract));\nvec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);\nreturn absorption;\n}\n#endif\n#ifdef SHEEN\nvec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {\nfloat NdotH=saturateEps(dot(N,info.H));\nfloat roughness=max(info.roughness,geometricRoughnessFactor);\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nfloat fresnel=1.;\nfloat distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);\n/*#ifdef SHEEN_SOFTER\nfloat visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);\n#else */\nfloat visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);\n/* #endif */\nfloat sheenTerm=fresnel*distribution*visibility;\nreturn sheenTerm*info.attenuation*info.NdotL*lightColor;\n}\n#endif\n";j.IncludesShadersStore.pbrIBLFunctions="#if defined(REFLECTION) || defined(SS_REFRACTION)\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {\nfloat microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;\nfloat lod=log2(microsurfaceAverageSlopeTexels);\nreturn lod;\n}\nfloat getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {\nfloat lod=log2(cubeMapDimensionPixels)*roughness;\nreturn lod;\n}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)\nfloat environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {\nfloat temp=NdotVUnclamped+ambientOcclusion;\nreturn saturate(square(temp)-1.0+ambientOcclusion);\n}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)\nfloat environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {\nvec3 reflection=reflect(view,normal);\nfloat temp=saturate(1.0+1.1*dot(reflection,geometricNormal));\nreturn square(temp);\n}\n#endif\n#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)\n#define UNPACK_LOD(x) (1.0-x)*255.0\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {\nfloat microsurfaceAverageSlope=alphaG;\nmicrosurfaceAverageSlope*=sqrt(abs(NdotV));\nreturn getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);\n}\n#endif\n";j.IncludesShadersStore.pbrBlockAlbedoOpacity="struct albedoOpacityOutParams\n{\nvec3 surfaceAlbedo;\nfloat alpha;\n};\n#define pbr_inline\nvoid albedoOpacityBlock(\nin vec4 vAlbedoColor,\n#ifdef ALBEDO\nin vec4 albedoTexture,\nin vec2 albedoInfos,\n#endif\n#ifdef OPACITY\nin vec4 opacityMap,\nin vec2 vOpacityInfos,\n#endif\n#ifdef DETAIL\nin vec4 detailColor,\nin vec4 vDetailInfos,\n#endif\n#ifdef DECAL\nin vec4 decalColor,\nin vec4 vDecalInfos,\n#endif\nout albedoOpacityOutParams outParams\n)\n{\nvec3 surfaceAlbedo=vAlbedoColor.rgb;\nfloat alpha=vAlbedoColor.a;\n#ifdef ALBEDO\n#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)\nalpha*=albedoTexture.a;\n#endif\n#ifdef GAMMAALBEDO\nsurfaceAlbedo*=toLinearSpace(albedoTexture.rgb);\n#else\nsurfaceAlbedo*=albedoTexture.rgb;\n#endif\nsurfaceAlbedo*=albedoInfos.y;\n#endif\n#include<decalFragment>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nsurfaceAlbedo*=vColor.rgb;\n#endif\n#ifdef DETAIL\nfloat detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);\nsurfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; \n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALBEDO\n#ifdef OPACITY\n#ifdef OPACITYRGB\nalpha=getLuminance(opacityMap.rgb);\n#else\nalpha*=opacityMap.a;\n#endif\nalpha*=vOpacityInfos.y;\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)\n#ifdef ALPHATEST\nif (alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo;\noutParams.alpha=alpha;\n}\n";j.IncludesShadersStore.pbrBlockReflectivity="struct reflectivityOutParams\n{\nfloat microSurface;\nfloat roughness;\nvec3 surfaceReflectivityColor;\n#ifdef METALLICWORKFLOW\nvec3 surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nvec3 ambientOcclusionColor;\n#endif\n#if DEBUGMODE>0\nvec4 surfaceMetallicColorMap;\nvec4 surfaceReflectivityColorMap;\nvec2 metallicRoughness;\nvec3 metallicF0;\n#endif\n};\n#define pbr_inline\nvoid reflectivityBlock(\nin vec4 vReflectivityColor,\n#ifdef METALLICWORKFLOW\nin vec3 surfaceAlbedo,\nin vec4 metallicReflectanceFactors,\n#endif\n#ifdef REFLECTIVITY\nin vec3 reflectivityInfos,\nin vec4 surfaceMetallicOrReflectivityColorMap,\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nin vec3 ambientOcclusionColorIn,\n#endif\n#ifdef MICROSURFACEMAP\nin vec4 microSurfaceTexel,\n#endif\n#ifdef DETAIL\nin vec4 detailColor,\nin vec4 vDetailInfos,\n#endif\nout reflectivityOutParams outParams\n)\n{\nfloat microSurface=vReflectivityColor.a;\nvec3 surfaceReflectivityColor=vReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness=surfaceReflectivityColor.rg;\n#ifdef REFLECTIVITY\n#if DEBUGMODE>0\noutParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef AOSTOREINMETALMAPRED\nvec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);\noutParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);\n#endif\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;\n#else\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;\n#endif\n#ifdef ROUGHNESSSTOREINMETALMAPALPHA\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;\n#else\n#ifdef ROUGHNESSSTOREINMETALMAPGREEN\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;\n#endif\n#endif\n#endif\n#ifdef DETAIL\nfloat detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);\nfloat loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);\nfloat hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);\nmetallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));\n#endif\n#ifdef MICROSURFACEMAP\nmetallicRoughness.g*=microSurfaceTexel.r;\n#endif\n#if DEBUGMODE>0\noutParams.metallicRoughness=metallicRoughness;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS\nmicroSurface=1.0-metallicRoughness.g;\nvec3 baseColor=surfaceAlbedo;\n#ifdef FROSTBITE_REFLECTANCE\noutParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);\nsurfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);\n#else\nvec3 metallicF0=metallicReflectanceFactors.rgb;\n#if DEBUGMODE>0\noutParams.metallicF0=metallicF0;\n#endif\noutParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);\nsurfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);\n#endif\n#else\n#ifdef REFLECTIVITY\nsurfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;\n#if DEBUGMODE>0\noutParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface*=surfaceMetallicOrReflectivityColorMap.a;\nmicroSurface*=reflectivityInfos.z;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurface*=microSurfaceTexel.r;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE\n#endif\n#endif\n#endif\nmicroSurface=saturate(microSurface);\nfloat roughness=1.-microSurface;\noutParams.microSurface=microSurface;\noutParams.roughness=roughness;\noutParams.surfaceReflectivityColor=surfaceReflectivityColor;\n}\n";j.IncludesShadersStore.pbrBlockAmbientOcclusion="struct ambientOcclusionOutParams\n{\nvec3 ambientOcclusionColor;\n#if DEBUGMODE>0\nvec3 ambientOcclusionColorMap;\n#endif\n};\n#define pbr_inline\nvoid ambientOcclusionBlock(\n#ifdef AMBIENT\nin vec3 ambientOcclusionColorMap_,\nin vec4 vAmbientInfos,\n#endif\nout ambientOcclusionOutParams outParams\n)\n{\nvec3 ambientOcclusionColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\nambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);\n#if DEBUGMODE>0\noutParams.ambientOcclusionColorMap=ambientOcclusionColorMap;\n#endif\n#endif\noutParams.ambientOcclusionColor=ambientOcclusionColor;\n}\n";j.IncludesShadersStore.pbrBlockAlphaFresnel="#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nstruct alphaFresnelOutParams\n{\nfloat alpha;\n};\n#define pbr_inline\nvoid alphaFresnelBlock(\nin vec3 normalW,\nin vec3 viewDirectionW,\nin float alpha,\nin float microSurface,\nout alphaFresnelOutParams outParams\n)\n{\nfloat opacityPerceptual=alpha;\n#ifdef LINEARALPHAFRESNEL\nfloat opacity0=opacityPerceptual;\n#else\nfloat opacity0=opacityPerceptual*opacityPerceptual;\n#endif\nfloat opacity90=fresnelGrazingReflectance(opacity0);\nvec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);\noutParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;\n#ifdef ALPHATEST\nif (outParams.alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\noutParams.alpha=1.0;\n#endif\n#endif\n}\n#endif\n#endif\n";j.IncludesShadersStore.pbrBlockAnisotropic="#ifdef ANISOTROPIC\nstruct anisotropicOutParams\n{\nfloat anisotropy;\nvec3 anisotropicTangent;\nvec3 anisotropicBitangent;\nvec3 anisotropicNormal;\n#if DEBUGMODE>0\nvec3 anisotropyMapData;\n#endif\n};\n#define pbr_inline\nvoid anisotropicBlock(\nin vec3 vAnisotropy,\n#ifdef ANISOTROPIC_TEXTURE\nin vec3 anisotropyMapData,\n#endif\nin mat3 TBN,\nin vec3 normalW,\nin vec3 viewDirectionW,\nout anisotropicOutParams outParams\n)\n{\nfloat anisotropy=vAnisotropy.b;\nvec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);\n#ifdef ANISOTROPIC_TEXTURE\nanisotropy*=anisotropyMapData.b;\nanisotropyDirection.rg*=anisotropyMapData.rg*2.0-1.0;\n#if DEBUGMODE>0\noutParams.anisotropyMapData=anisotropyMapData;\n#endif\n#endif\nmat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));\nvec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);\nvec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));\noutParams.anisotropy=anisotropy;\noutParams.anisotropicTangent=anisotropicTangent;\noutParams.anisotropicBitangent=anisotropicBitangent;\noutParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy);\n}\n#endif\n";j.IncludesShadersStore.pbrBlockReflection="#ifdef REFLECTION\nstruct reflectionOutParams\n{\nvec4 environmentRadiance;\nvec3 environmentIrradiance;\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords;\n#else\nvec2 reflectionCoords;\n#endif\n#ifdef SS_TRANSLUCENCY\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nvec3 irradianceVector;\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nvoid createReflectionCoords(\nin vec3 vPositionW,\nin vec3 normalW,\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#ifdef REFLECTIONMAP_3D\nout vec3 reflectionCoords\n#else\nout vec2 reflectionCoords\n#endif\n)\n{\n#ifdef ANISOTROPIC\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);\n#else\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionCoords=reflectionVector;\n#else\nreflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n}\n#define pbr_inline\n#define inline\nvoid sampleReflectionTexture(\nin float alphaG,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nin float NdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nin float roughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\nconst vec3 reflectionCoords,\n#else\nin sampler2D reflectionSampler,\nconst vec2 reflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\nout vec4 environmentRadiance\n)\n{\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nfloat reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);\n#else\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef LODINREFLECTIONALPHA\nfloat automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);\nfloat requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);\n#else\nfloat requestedReflectionLOD=reflectionLOD;\n#endif\n#ifdef REALTIME_FILTERING\nenvironmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);\n#else\nenvironmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#endif\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));\nfloat lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;\nvec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);\nif (lodReflectionNormalizedDoubled<1.0){\nenvironmentRadiance=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nenvironmentMid,\nlodReflectionNormalizedDoubled\n);\n} else {\nenvironmentRadiance=mix(\nenvironmentMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);\n}\n#endif\n#ifdef RGBDREFLECTION\nenvironmentRadiance.rgb=fromRGBD(environmentRadiance);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);\n#endif\nenvironmentRadiance.rgb*=vReflectionInfos.x;\nenvironmentRadiance.rgb*=vReflectionColor.rgb;\n}\n#define pbr_inline\n#define inline\nvoid reflectionBlock(\nin vec3 vPositionW,\nin vec3 normalW,\nin float alphaG,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nin float NdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nin float roughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\n#else\nin sampler2D reflectionSampler,\n#endif\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nin vec3 vEnvironmentIrradiance,\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nin mat4 reflectionMatrix,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\nin samplerCube irradianceSampler,\n#else\nin sampler2D irradianceSampler,\n#endif\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\nout reflectionOutParams outParams\n)\n{\nvec4 environmentRadiance=vec4(0.,0.,0.,0.);\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=vec3(0.);\n#else\nvec2 reflectionCoords=vec2(0.);\n#endif\ncreateReflectionCoords(\nvPositionW,\nnormalW,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\nreflectionCoords\n);\nsampleReflectionTexture(\nalphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nroughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionSampler,\nreflectionCoords,\n#else\nreflectionSampler,\nreflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentRadiance\n);\nvec3 environmentIrradiance=vec3(0.,0.,0.);\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradiance;\n#else\n#ifdef ANISOTROPIC\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;\n#else\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#if defined(REALTIME_FILTERING)\nenvironmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);\n#else\nenvironmentIrradiance=computeEnvironmentIrradiance(irradianceVector);\n#endif\n#ifdef SS_TRANSLUCENCY\noutParams.irradianceVector=irradianceVector;\n#endif\n#endif\n#elif defined(USEIRRADIANCEMAP)\nvec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);\nenvironmentIrradiance=environmentIrradiance4.rgb;\n#ifdef RGBDREFLECTION\nenvironmentIrradiance.rgb=fromRGBD(environmentIrradiance4);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);\n#endif\n#endif\nenvironmentIrradiance*=vReflectionColor.rgb;\noutParams.environmentRadiance=environmentRadiance;\noutParams.environmentIrradiance=environmentIrradiance;\noutParams.reflectionCoords=reflectionCoords;\n}\n#endif\n";j.IncludesShadersStore.pbrBlockSheen="#ifdef SHEEN\nstruct sheenOutParams\n{\nfloat sheenIntensity;\nvec3 sheenColor;\nfloat sheenRoughness;\n#ifdef SHEEN_LINKWITHALBEDO\nvec3 surfaceAlbedo;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfloat sheenAlbedoScaling;\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvec3 finalSheenRadianceScaled;\n#endif\n#if DEBUGMODE>0\nvec4 sheenMapData;\nvec3 sheenEnvironmentReflectance;\n#endif\n};\n#define pbr_inline\n#define inline\nvoid sheenBlock(\nin vec4 vSheenColor,\n#ifdef SHEEN_ROUGHNESS\nin float vSheenRoughness,\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nin vec4 sheenMapRoughnessData,\n#endif\n#endif\nin float roughness,\n#ifdef SHEEN_TEXTURE\nin vec4 sheenMapData,\nin float sheenMapLevel,\n#endif\nin float reflectance,\n#ifdef SHEEN_LINKWITHALBEDO\nin vec3 baseColor,\nin vec3 surfaceAlbedo,\n#endif\n#ifdef ENVIRONMENTBRDF\nin float NdotV,\nin vec3 environmentBrdf,\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nin vec2 AARoughnessFactors,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\nin vec4 vLightingIntensity,\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\nin vec3 reflectionCoords,\n#else\nin sampler2D reflectionSampler,\nin vec2 reflectionCoords,\n#endif\nin float NdotVUnclamped,\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nin float seo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nin float eho,\n#endif\n#endif\nout sheenOutParams outParams\n)\n{\nfloat sheenIntensity=vSheenColor.a;\n#ifdef SHEEN_TEXTURE\n#if DEBUGMODE>0\noutParams.sheenMapData=sheenMapData;\n#endif\n#endif\n#ifdef SHEEN_LINKWITHALBEDO\nfloat sheenFactor=pow5(1.0-sheenIntensity);\nvec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);\nfloat sheenRoughness=sheenIntensity;\noutParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#else\nvec3 sheenColor=vSheenColor.rgb;\n#ifdef SHEEN_TEXTURE\n#ifdef SHEEN_GAMMATEXTURE\nsheenColor.rgb*=toLinearSpace(sheenMapData.rgb);\n#else\nsheenColor.rgb*=sheenMapData.rgb;\n#endif\nsheenColor.rgb*=sheenMapLevel;\n#endif\n#ifdef SHEEN_ROUGHNESS\nfloat sheenRoughness=vSheenRoughness;\n#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE\n#if defined(SHEEN_TEXTURE)\nsheenRoughness*=sheenMapData.a;\n#endif\n#elif defined(SHEEN_TEXTURE_ROUGHNESS)\n#ifdef SHEEN_TEXTURE_ROUGHNESS_IDENTICAL\nsheenRoughness*=sheenMapData.a;\n#else\nsheenRoughness*=sheenMapRoughnessData.a;\n#endif\n#endif\n#else\nfloat sheenRoughness=roughness;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#endif\n#if !defined(SHEEN_ALBEDOSCALING)\nsheenIntensity*=(1.-reflectance);\n#endif\nsheenColor*=sheenIntensity;\n#endif\n#ifdef ENVIRONMENTBRDF\n/*#ifdef SHEEN_SOFTER\nvec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));\n#else*/\n#ifdef SHEEN_ROUGHNESS\nvec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);\n#else\nvec3 environmentSheenBrdf=environmentBrdf;\n#endif\n/*#endif*/\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nfloat sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);\n#ifdef SPECULARAA\nsheenAlphaG+=AARoughnessFactors.y;\n#endif\nvec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);\nsampleReflectionTexture(\nsheenAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nsheenRoughness,\n#endif\nreflectionSampler,\nreflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentSheenRadiance\n);\nvec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nsheenEnvironmentReflectance*=seo;\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nsheenEnvironmentReflectance*=eho;\n#endif\n#if DEBUGMODE>0\noutParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;\n#endif\noutParams.finalSheenRadianceScaled=\nenvironmentSheenRadiance.rgb *\nsheenEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\noutParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;\n#endif\noutParams.sheenIntensity=sheenIntensity;\noutParams.sheenColor=sheenColor;\noutParams.sheenRoughness=sheenRoughness;\n}\n#endif\n";j.IncludesShadersStore.pbrBlockClearcoat="struct clearcoatOutParams\n{\nvec3 specularEnvironmentR0;\nfloat conservationFactor;\nvec3 clearCoatNormalW;\nvec2 clearCoatAARoughnessFactors;\nfloat clearCoatIntensity;\nfloat clearCoatRoughness;\n#ifdef REFLECTION\nvec3 finalClearCoatRadianceScaled;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 absorption;\nfloat clearCoatNdotVRefract;\nvec3 clearCoatColor;\nfloat clearCoatThickness;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nvec3 energyConservationFactorClearCoat;\n#endif\n#if DEBUGMODE>0\nmat3 TBNClearCoat;\nvec2 clearCoatMapData;\nvec4 clearCoatTintMapData;\nvec4 environmentClearCoatRadiance;\nfloat clearCoatNdotV;\nvec3 clearCoatEnvironmentReflectance;\n#endif\n};\n#ifdef CLEARCOAT\n#define pbr_inline\n#define inline\nvoid clearcoatBlock(\nin vec3 vPositionW,\nin vec3 geometricNormalW,\nin vec3 viewDirectionW,\nin vec2 vClearCoatParams,\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nin vec4 clearCoatMapRoughnessData,\n#endif\nin vec3 specularEnvironmentR0,\n#ifdef CLEARCOAT_TEXTURE\nin vec2 clearCoatMapData,\n#endif\n#ifdef CLEARCOAT_TINT\nin vec4 vClearCoatTintParams,\nin float clearCoatColorAtDistance,\nin vec4 vClearCoatRefractionParams,\n#ifdef CLEARCOAT_TINT_TEXTURE\nin vec4 clearCoatTintMapData,\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\nin vec2 vClearCoatBumpInfos,\nin vec4 clearCoatBumpMapData,\nin vec2 vClearCoatBumpUV,\n#if defined(TANGENT) && defined(NORMAL)\nin mat3 vTBN,\n#else\nin vec2 vClearCoatTangentSpaceParams,\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nin mat4 normalMatrix,\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nin vec3 faceNormal,\n#endif\n#ifdef REFLECTION\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\nin vec4 vLightingIntensity,\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\n#else\nin sampler2D reflectionSampler,\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\nin float ambientMonochrome,\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\nin float frontFacingMultiplier,\n#endif\nout clearcoatOutParams outParams\n)\n{\nfloat clearCoatIntensity=vClearCoatParams.x;\nfloat clearCoatRoughness=vClearCoatParams.y;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE\nclearCoatRoughness*=clearCoatMapData.y;\n#endif\n#if DEBUGMODE>0\noutParams.clearCoatMapData=clearCoatMapData;\n#endif\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL\nclearCoatRoughness*=clearCoatMapData.y;\n#else\nclearCoatRoughness*=clearCoatMapRoughnessData.y;\n#endif\n#endif\noutParams.clearCoatIntensity=clearCoatIntensity;\noutParams.clearCoatRoughness=clearCoatRoughness;\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatColor=vClearCoatTintParams.rgb;\nfloat clearCoatThickness=vClearCoatTintParams.a;\n#ifdef CLEARCOAT_TINT_TEXTURE\n#ifdef CLEARCOAT_TINT_GAMMATEXTURE\nclearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);\n#else\nclearCoatColor*=clearCoatTintMapData.rgb;\n#endif\nclearCoatThickness*=clearCoatTintMapData.a;\n#if DEBUGMODE>0\noutParams.clearCoatTintMapData=clearCoatTintMapData;\n#endif\n#endif\noutParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);\noutParams.clearCoatThickness=clearCoatThickness;\n#endif\n#ifdef CLEARCOAT_REMAP_F0\nvec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);\n#else\nvec3 specularEnvironmentR0Updated=specularEnvironmentR0;\n#endif\noutParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);\nvec3 clearCoatNormalW=geometricNormalW;\n#ifdef CLEARCOAT_BUMP\n#ifdef NORMALXYSCALE\nfloat clearCoatNormalScale=1.0;\n#else\nfloat clearCoatNormalScale=vClearCoatBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBNClearCoat=vTBN;\n#else\nvec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;\nmat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);\n#endif\n#if DEBUGMODE>0\noutParams.TBNClearCoat=TBNClearCoat;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nclearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);\nclearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);\n#else\nclearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nclearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nclearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;\n#endif\noutParams.clearCoatNormalW=clearCoatNormalW;\noutParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);\nfloat clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);\nfloat clearCoatNdotV=absEps(clearCoatNdotVUnclamped);\n#if DEBUGMODE>0\noutParams.clearCoatNdotV=clearCoatNdotV;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);\noutParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));\n#endif\n#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))\nvec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);\n#endif\n#if defined(REFLECTION)\nfloat clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);\n#ifdef SPECULARAA\nclearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;\n#endif\nvec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);\nvec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nclearCoatReflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 clearCoatReflectionCoords=clearCoatReflectionVector;\n#else\nvec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nclearCoatReflectionCoords/=clearCoatReflectionVector.z;\n#endif\nclearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;\n#endif\nsampleReflectionTexture(\nclearCoatAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nclearCoatNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nclearCoatRoughness,\n#endif\nreflectionSampler,\nclearCoatReflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentClearCoatRadiance\n);\n#if DEBUGMODE>0\noutParams.environmentClearCoatRadiance=environmentClearCoatRadiance;\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);\nclearCoatEnvironmentReflectance*=clearCoatEho;\n#endif\n#endif\n#endif\n#else\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));\n#endif\nclearCoatEnvironmentReflectance*=clearCoatIntensity;\n#if DEBUGMODE>0\noutParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;\n#endif\noutParams.finalClearCoatRadianceScaled=\nenvironmentClearCoatRadiance.rgb *\nclearCoatEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(CLEARCOAT_TINT)\noutParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);\n#endif\nfloat fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);\nfresnelIBLClearCoat*=clearCoatIntensity;\noutParams.conservationFactor=(1.-fresnelIBLClearCoat);\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\noutParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);\n#endif\n}\n#endif\n";j.IncludesShadersStore.pbrBlockIridescence="struct iridescenceOutParams\n{\nfloat iridescenceIntensity;\nfloat iridescenceIOR;\nfloat iridescenceThickness;\nvec3 specularEnvironmentR0;\n};\n#ifdef IRIDESCENCE\n#define pbr_inline\n#define inline\nvoid iridescenceBlock(\nin vec4 vIridescenceParams,\nin float viewAngle,\nin vec3 specularEnvironmentR0,\n#ifdef IRIDESCENCE_TEXTURE\nin vec2 iridescenceMapData,\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nin vec2 iridescenceThicknessMapData,\n#endif\n#ifdef CLEARCOAT\nin float NdotVUnclamped,\n#ifdef CLEARCOAT_TEXTURE\nin vec2 clearCoatMapData,\n#endif\n#endif\nout iridescenceOutParams outParams\n)\n{\nfloat iridescenceIntensity=vIridescenceParams.x;\nfloat iridescenceIOR=vIridescenceParams.y;\nfloat iridescenceThicknessMin=vIridescenceParams.z;\nfloat iridescenceThicknessMax=vIridescenceParams.w;\nfloat iridescenceThicknessWeight=1.;\n#ifdef IRIDESCENCE_TEXTURE\niridescenceIntensity*=iridescenceMapData.x;\n#ifdef IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE\niridescenceThicknessWeight=iridescenceMapData.g;\n#endif\n#endif\n#if defined(IRIDESCENCE_THICKNESS_TEXTURE)\niridescenceThicknessWeight=iridescenceThicknessMapData.g;\n#endif\nfloat iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);\nfloat topIor=1.; \n#ifdef CLEARCOAT\nfloat clearCoatIntensity=vClearCoatParams.x;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#endif\ntopIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);\nviewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));\n#endif\nvec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);\noutParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);\noutParams.iridescenceIntensity=iridescenceIntensity;\noutParams.iridescenceThickness=iridescenceThickness;\noutParams.iridescenceIOR=iridescenceIOR;\n}\n#endif\n";j.IncludesShadersStore.pbrBlockSubSurface="struct subSurfaceOutParams\n{\nvec3 specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nvec3 finalRefraction;\nvec3 surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nfloat alpha;\n#endif\n#ifdef REFLECTION\nfloat refractionFactorForIrradiance;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvec3 transmittance;\nfloat translucencyIntensity;\n#ifdef REFLECTION\nvec3 refractionIrradiance;\n#endif\n#endif\n#if DEBUGMODE>0\nvec4 thicknessMap;\nvec4 environmentRefraction;\nvec3 refractionTransmittance;\n#endif\n};\n#ifdef SUBSURFACE\n#define pbr_inline\n#define inline\nvoid subSurfaceBlock(\nin vec3 vSubSurfaceIntensity,\nin vec2 vThicknessParam,\nin vec4 vTintColor,\nin vec3 normalW,\nin vec3 specularEnvironmentReflectance,\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nin vec4 thicknessMap,\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nin vec4 refractionIntensityMap,\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nin vec4 translucencyIntensityMap,\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\nin mat4 reflectionMatrix,\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nin vec3 irradianceVector_,\n#endif\n#if defined(REALTIME_FILTERING)\nin samplerCube reflectionSampler,\nin vec2 vReflectionFilteringInfo,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\nin samplerCube irradianceSampler,\n#else\nin sampler2D irradianceSampler,\n#endif\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\nin vec3 surfaceAlbedo,\n#endif\n#ifdef SS_REFRACTION\nin vec3 vPositionW,\nin vec3 viewDirectionW,\nin mat4 view,\nin vec4 vRefractionInfos,\nin mat4 refractionMatrix,\nin vec4 vRefractionMicrosurfaceInfos,\nin vec4 vLightingIntensity,\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nin float alpha,\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nin float NdotVUnclamped,\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\nin float roughness,\n#endif\nin float alphaG,\n#ifdef SS_REFRACTIONMAP_3D\nin samplerCube refractionSampler,\n#ifndef LODBASEDMICROSFURACE\nin samplerCube refractionSamplerLow,\nin samplerCube refractionSamplerHigh,\n#endif\n#else\nin sampler2D refractionSampler,\n#ifndef LODBASEDMICROSFURACE\nin sampler2D refractionSamplerLow,\nin sampler2D refractionSamplerHigh,\n#endif\n#endif\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vRefractionFilteringInfo,\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nin vec3 refractionPosition,\nin vec3 refractionSize,\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nin vec3 vDiffusionDistance,\n#endif\nout subSurfaceOutParams outParams\n)\n{\noutParams.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nfloat refractionIntensity=vSubSurfaceIntensity.x;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nrefractionIntensity*=(1.0-alpha);\noutParams.alpha=1.0;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nfloat translucencyIntensity=vSubSurfaceIntensity.y;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n#if defined(SS_USE_GLTF_TEXTURES)\nfloat thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;\n#else\nfloat thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;\n#endif\n#if DEBUGMODE>0\noutParams.thicknessMap=thicknessMap;\n#endif\n#ifdef SS_MASK_FROM_THICKNESS_TEXTURE\n#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE)\n#if defined(SS_USE_GLTF_TEXTURES)\nrefractionIntensity*=thicknessMap.r;\n#else\nrefractionIntensity*=thicknessMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE)\ntranslucencyIntensity*=thicknessMap.b;\n#endif\n#endif\n#else\nfloat thickness=vThicknessParam.y;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=refractionIntensityMap.r;\n#else\nrefractionIntensity*=refractionIntensityMap.g;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\ntranslucencyIntensity*=translucencyIntensityMap.b;\n#endif\n#ifdef SS_TRANSLUCENCY\nthickness=maxEps(thickness);\nvec3 transmittance=transmittanceBRDF_Burley(vTintColor.rgb,vDiffusionDistance,thickness);\ntransmittance*=translucencyIntensity;\noutParams.transmittance=transmittance;\noutParams.translucencyIntensity=translucencyIntensity;\n#endif\n#ifdef SS_REFRACTION\nvec4 environmentRefraction=vec4(0.,0.,0.,0.);\n#ifdef ANISOTROPIC\nvec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,vRefractionInfos.y);\n#else\nvec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);\n#endif\n#ifdef SS_REFRACTIONMAP_OPPOSITEZ\nrefractionVector.z*=-1.0;\n#endif\n#ifdef SS_REFRACTIONMAP_3D\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nvec3 refractionCoords=refractionVector;\nrefractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));\n#else\n#ifdef SS_USE_THICKNESS_AS_DEPTH\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\n#endif\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\n#endif\n#ifdef SS_HAS_THICKNESS\nfloat ior=vRefractionInfos.y;\n#else\nfloat ior=vRefractionMicrosurfaceInfos.w;\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nfloat refractionAlphaG=alphaG;\nrefractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));\nfloat refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);\n#elif defined(SS_LINEARSPECULARREFRACTION)\nfloat refractionRoughness=alphaG;\nrefractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));\nfloat refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);\n#else\nfloat refractionAlphaG=alphaG;\nrefractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));\nfloat refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\nrefractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;\n#ifdef SS_LODINREFRACTIONALPHA\nfloat automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);\nfloat requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);\n#else\nfloat requestedRefractionLOD=refractionLOD;\n#endif\n#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)\nenvironmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);\n#else\nenvironmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);\n#endif\n#else\nfloat lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));\nfloat lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;\nvec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);\nif (lodRefractionNormalizedDoubled<1.0){\nenvironmentRefraction=mix(\nsampleRefraction(refractionSamplerHigh,refractionCoords),\nenvironmentRefractionMid,\nlodRefractionNormalizedDoubled\n);\n} else {\nenvironmentRefraction=mix(\nenvironmentRefractionMid,\nsampleRefraction(refractionSamplerLow,refractionCoords),\nlodRefractionNormalizedDoubled-1.0\n);\n}\n#endif\n#ifdef SS_RGBDREFRACTION\nenvironmentRefraction.rgb=fromRGBD(environmentRefraction);\n#endif\n#ifdef SS_GAMMAREFRACTION\nenvironmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);\n#endif\nenvironmentRefraction.rgb*=vRefractionInfos.x;\n#endif\n#ifdef SS_REFRACTION\nvec3 refractionTransmittance=vec3(refractionIntensity);\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);\nrefractionTransmittance*=cocaLambert(volumeAlbedo,thickness);\n#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)\nfloat maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);\nvec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);\nenvironmentRefraction.rgb*=volumeAlbedo;\n#else\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);\nrefractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);\n#endif\n#ifdef SS_ALBEDOFORREFRACTIONTINT\nenvironmentRefraction.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);\n#ifdef REFLECTION\noutParams.refractionFactorForIrradiance=(1.-refractionIntensity);\n#endif\n#ifdef UNUSED_MULTIPLEBOUNCES\nvec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);\noutParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);\n#endif\nrefractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;\n#if DEBUGMODE>0\noutParams.refractionTransmittance=refractionTransmittance;\n#endif\noutParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;\n#if DEBUGMODE>0\noutParams.environmentRefraction=environmentRefraction;\n#endif\n#endif\n#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#else\nvec3 irradianceVector=irradianceVector_;\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP)\n#if defined(REALTIME_FILTERING)\nvec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);\n#else\nvec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvec3 irradianceCoords=irradianceVector;\n#else\nvec2 irradianceCoords=irradianceVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nirradianceCoords/=irradianceVector.z;\n#endif\nirradianceCoords.y=1.0-irradianceCoords.y;\n#endif\nvec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);\n#ifdef RGBDREFLECTION\nrefractionIrradiance.rgb=fromRGBD(refractionIrradiance);\n#endif\n#ifdef GAMMAREFLECTION\nrefractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);\n#endif\n#else\nvec4 refractionIrradiance=vec4(0.);\n#endif\nrefractionIrradiance.rgb*=transmittance;\n#ifdef SS_ALBEDOFORTRANSLUCENCYTINT\nrefractionIrradiance.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.refractionIrradiance=refractionIrradiance.rgb;\n#endif\n}\n#endif\n";j.IncludesShadersStore.pbrBlockNormalGeometric="vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#endif\nvec3 geometricNormalW=normalW;\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\ngeometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;\n#endif\n";j.IncludesShadersStore.pbrBlockNormalFinal="#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=gl_FrontFacing ? faceNormal : -faceNormal;\n#endif\nnormalW*=sign(dot(normalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n";j.IncludesShadersStore.pbrBlockLightmapInit="#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\n#ifdef GAMMALIGHTMAP\nlightmapColor.rgb=toLinearSpace(lightmapColor.rgb);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n";j.IncludesShadersStore.pbrBlockGeometryInfo="float NdotVUnclamped=dot(normalW,viewDirectionW);\nfloat NdotV=absEps(NdotVUnclamped);\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nvec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);\n#ifdef SPECULARAA\nalphaG+=AARoughnessFactors.y;\n#endif\n#if defined(ENVIRONMENTBRDF)\nvec3 environmentBrdf=getBRDFLookup(NdotV,roughness);\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\n#ifdef AMBIENTINGRAYSCALE\nfloat ambientMonochrome=aoOut.ambientOcclusionColor.r;\n#else\nfloat ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);\n#endif\nfloat seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);\n#endif\n#endif\n#endif\n#endif\n";j.IncludesShadersStore.pbrBlockReflectance0="float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);\nvec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);\n#else \nvec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);\n#endif\n#ifdef ALPHAFRESNEL\nfloat reflectance90=fresnelGrazingReflectance(reflectance);\nspecularEnvironmentR90=specularEnvironmentR90*reflectance90;\n#endif\n";j.IncludesShadersStore.pbrBlockReflectance="#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);\n#ifdef RADIANCEOCCLUSION\nspecularEnvironmentReflectance*=seo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nspecularEnvironmentReflectance*=eho;\n#endif\n#endif\n#endif\n#else\nvec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));\n#endif\n#ifdef CLEARCOAT\nspecularEnvironmentReflectance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nspecularEnvironmentReflectance*=clearcoatOut.absorption;\n#endif\n#endif\n";j.IncludesShadersStore.pbrBlockDirectLighting="vec3 diffuseBase=vec3(0.,0.,0.);\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\n#ifdef CLEARCOAT\nvec3 clearCoatBase=vec3(0.,0.,0.);\n#endif\n#ifdef SHEEN\nvec3 sheenBase=vec3(0.,0.,0.);\n#endif\npreLightingInfo preInfo;\nlightingInfo info;\nfloat shadow=1.; \n#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\nvec3 absorption=vec3(0.);\n#endif\n";j.IncludesShadersStore.pbrBlockFinalLitComponents="#if defined(ENVIRONMENTBRDF)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);\n#endif\n#endif\n#ifndef METALLICWORKFLOW\n#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION\nsurfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;\n#endif\n#endif\n#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)\nsurfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;\n#endif\n#ifdef REFLECTION\nvec3 finalIrradiance=reflectionOut.environmentIrradiance;\n#if defined(CLEARCOAT)\nfinalIrradiance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nfinalIrradiance*=clearcoatOut.absorption;\n#endif\n#endif\n#if defined(SS_REFRACTION)\nfinalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;\n#endif\n#if defined(SS_TRANSLUCENCY)\nfinalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);\nfinalIrradiance+=subSurfaceOut.refractionIrradiance;\n#endif\nfinalIrradiance*=surfaceAlbedo.rgb;\nfinalIrradiance*=vLightingIntensity.z;\nfinalIrradiance*=aoOut.ambientOcclusionColor;\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase;\nfinalSpecular=max(finalSpecular,0.0);\nvec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalSpecularScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalSpecularScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef REFLECTION\nvec3 finalRadiance=reflectionOut.environmentRadiance.rgb;\nfinalRadiance*=subSurfaceOut.specularEnvironmentReflectance;\nvec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalRadianceScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalRadianceScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef SHEEN\nvec3 finalSheen=sheenBase*sheenOut.sheenColor;\nfinalSheen=max(finalSheen,0.0);\nvec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef CLEARCOAT\nvec3 finalClearCoat=clearCoatBase;\nfinalClearCoat=max(finalClearCoat,0.0);\nvec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;\n#ifdef CLEARCOAT_TINT\nsubSurfaceOut.finalRefraction*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef ALPHABLEND\nfloat luminanceOverAlpha=0.0;\n#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalRadianceScaled);\n#if defined(CLEARCOAT)\nluminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);\n#endif\n#endif\n#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)\nluminanceOverAlpha+=getLuminance(finalSpecularScaled);\n#endif\n#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalClearCoatScaled);\n#endif\n#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)\nalpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);\n#endif\n#endif\n";j.IncludesShadersStore.pbrBlockFinalUnlitComponents="vec3 finalDiffuse=diffuseBase;\nfinalDiffuse*=surfaceAlbedo.rgb;\nfinalDiffuse=max(finalDiffuse,0.0);\nfinalDiffuse*=vLightingIntensity.x;\nvec3 finalAmbient=vAmbientColor;\nfinalAmbient*=surfaceAlbedo.rgb;\nvec3 finalEmissive=vEmissiveColor;\n#ifdef EMISSIVE\nvec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;\n#ifdef GAMMAEMISSIVE\nfinalEmissive*=toLinearSpace(emissiveColorTex.rgb);\n#else\nfinalEmissive*=emissiveColorTex.rgb;\n#endif\nfinalEmissive*= vEmissiveInfos.y;\n#endif\nfinalEmissive*=vLightingIntensity.y;\n#ifdef AMBIENT\nvec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);\n#else\nvec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;\n#endif\nfinalAmbient*=aoOut.ambientOcclusionColor;\nfinalDiffuse*=ambientOcclusionForDirectDiffuse;\n";j.IncludesShadersStore.pbrBlockFinalColorComposition="vec4 finalColor=vec4(\n#ifndef UNLIT\n#ifdef REFLECTION\nfinalIrradiance +\n#endif\n#ifdef SPECULARTERM\nfinalSpecularScaled +\n#endif\n#ifdef SHEEN\nfinalSheenScaled +\n#endif\n#ifdef CLEARCOAT\nfinalClearCoatScaled +\n#endif\n#ifdef REFLECTION\nfinalRadianceScaled +\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled +\n#endif\n#ifdef CLEARCOAT\nclearcoatOut.finalClearCoatRadianceScaled +\n#endif\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction +\n#endif\n#endif\nfinalAmbient +\nfinalDiffuse,\nalpha);\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor.rgb*=lightmapColor.rgb;\n#else\nfinalColor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\nfinalColor.rgb+=finalEmissive;\n#define CUSTOM_FRAGMENT_BEFORE_FOG\nfinalColor=max(finalColor,0.0);\n";j.IncludesShadersStore.pbrBlockImageProcessing="#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)\n#if !defined(SKIPFINALCOLORCLAMP)\nfinalColor.rgb=clamp(finalColor.rgb,0.,30.0);\n#endif\n#else\nfinalColor=applyImageProcessing(finalColor);\n#endif\nfinalColor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\nfinalColor.rgb*=finalColor.a;\n#endif\n";j.IncludesShadersStore.pbrDebug="#if DEBUGMODE>0\nif (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {\n#if DEBUGMODE==1\ngl_FragColor.rgb=vPositionW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==2 && defined(NORMAL)\ngl_FragColor.rgb=vNormalW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==5\ngl_FragColor.rgb=normalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==6 && defined(MAINUV1)\ngl_FragColor.rgb=vec3(vMainUV1,0.0);\n#elif DEBUGMODE==7 && defined(MAINUV2)\ngl_FragColor.rgb=vec3(vMainUV2,0.0);\n#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==10 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearcoatOut.clearCoatNormalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==11 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicNormal;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==12 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicTangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==13 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicBitangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==20 && defined(ALBEDO)\ngl_FragColor.rgb=albedoTexture.rgb;\n#elif DEBUGMODE==21 && defined(AMBIENT)\ngl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;\n#elif DEBUGMODE==22 && defined(OPACITY)\ngl_FragColor.rgb=opacityMap.rgb;\n#elif DEBUGMODE==23 && defined(EMISSIVE)\ngl_FragColor.rgb=emissiveColorTex.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==24 && defined(LIGHTMAP)\ngl_FragColor.rgb=lightmapColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;\n#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);\n#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\ngl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;\n#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)\ngl_FragColor.rgb=sheenOut.sheenMapData.rgb;\n#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)\ngl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;\n#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)\ngl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;\n#elif DEBUGMODE==40 && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==41 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)\ngl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==50\ngl_FragColor.rgb=diffuseBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==51 && defined(SPECULARTERM)\ngl_FragColor.rgb=specularBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==52 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearCoatBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==53 && defined(SHEEN)\ngl_FragColor.rgb=sheenBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==54 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==60\ngl_FragColor.rgb=surfaceAlbedo.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==61\ngl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);\n#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.metallicF0;\n#elif DEBUGMODE==63\ngl_FragColor.rgb=vec3(roughness);\n#elif DEBUGMODE==64\ngl_FragColor.rgb=vec3(alphaG);\n#elif DEBUGMODE==65\ngl_FragColor.rgb=vec3(NdotV);\n#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\ngl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==67 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);\n#elif DEBUGMODE==68 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);\n#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)\ngl_FragColor.rgb=subSurfaceOut.transmittance;\n#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.refractionTransmittance;\n#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)\ngl_FragColor.rgb=vec3(seo);\n#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION)\ngl_FragColor.rgb=vec3(eho);\n#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)\ngl_FragColor.rgb=vec3(energyConservationFactor);\n#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=specularEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)\ngl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==86 && defined(ALPHABLEND)\ngl_FragColor.rgb=vec3(luminanceOverAlpha);\n#elif DEBUGMODE==87\ngl_FragColor.rgb=vec3(alpha);\n#endif\ngl_FragColor.rgb*=vDebugMode.y;\n#ifdef DEBUGMODE_NORMALIZE\ngl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;\n#endif\n#ifdef DEBUGMODE_GAMMA\ngl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);\n#endif\ngl_FragColor.a=1.0;\n#ifdef PREPASS\ngl_FragData[0]=toLinearSpace(gl_FragColor); \ngl_FragData[1]=vec4(0.,0.,0.,0.); \n#endif\nreturn;\n}\n#endif\n";j.ShadersStore.pbrPixelShader="#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LODBASEDMICROSFURACE\n#extension GL_EXT_shader_texture_lod : enable\n#endif\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\nprecision highp float;\n#include<oitDeclaration>\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE\n#endif\n#include<__decl__pbrFragment>\n#include<pbrFragmentExtraDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<pbrFragmentSamplersDeclaration>\n#include<imageProcessingDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<importanceSampling>\n#include<pbrHelperFunctions>\n#include<imageProcessingFunctions>\n#include<shadowsFragmentFunctions>\n#include<harmonicsFunctions>\n#include<pbrDirectLightingSetupFunctions>\n#include<pbrDirectLightingFalloffFunctions>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\n#include<pbrDirectLightingFunctions>\n#include<pbrIBLFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#ifdef REFLECTION\n#include<reflectionFunction>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#include<pbrBlockAlbedoOpacity>\n#include<pbrBlockReflectivity>\n#include<pbrBlockAmbientOcclusion>\n#include<pbrBlockAlphaFresnel>\n#include<pbrBlockAnisotropic>\n#include<pbrBlockReflection>\n#include<pbrBlockSheen>\n#include<pbrBlockClearcoat>\n#include<pbrBlockIridescence>\n#include<pbrBlockSubSurface>\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#include<pbrBlockNormalGeometric>\n#include<bumpFragment>\n#include<pbrBlockNormalFinal>\nalbedoOpacityOutParams albedoOpacityOut;\n#ifdef ALBEDO\nvec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#endif\n#ifdef DECAL\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#endif\nalbedoOpacityBlock(\nvAlbedoColor,\n#ifdef ALBEDO\nalbedoTexture,\nvAlbedoInfos,\n#endif\n#ifdef OPACITY\nopacityMap,\nvOpacityInfos,\n#endif\n#ifdef DETAIL\ndetailColor,\nvDetailInfos,\n#endif\n#ifdef DECAL\ndecalColor,\nvDecalInfos,\n#endif\nalbedoOpacityOut\n);\nvec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;\nfloat alpha=albedoOpacityOut.alpha;\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\n#include<depthPrePass>\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nambientOcclusionOutParams aoOut;\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;\n#endif\nambientOcclusionBlock(\n#ifdef AMBIENT\nambientOcclusionColorMap,\nvAmbientInfos,\n#endif\naoOut\n);\n#include<pbrBlockLightmapInit>\n#ifdef UNLIT\nvec3 diffuseBase=vec3(1.,1.,1.);\n#else\nvec3 baseColor=surfaceAlbedo;\nreflectivityOutParams reflectivityOut;\n#if defined(REFLECTIVITY)\nvec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);\nvec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;\n#ifndef METALLICWORKFLOW\n#ifdef REFLECTIVITY_GAMMA\nsurfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);\n#endif\nsurfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;\n#endif\n#endif\n#if defined(MICROSURFACEMAP)\nvec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;\n#endif\n#ifdef METALLICWORKFLOW\nvec4 metallicReflectanceFactors=vMetallicReflectanceFactors;\n#ifdef REFLECTANCE\nvec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);\n#ifdef REFLECTANCE_GAMMA\nreflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);\n#endif\nmetallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;\n#endif\n#ifdef METALLIC_REFLECTANCE\nvec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);\n#ifdef METALLIC_REFLECTANCE_GAMMA\nmetallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);\n#endif\n#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY\nmetallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;\n#endif\nmetallicReflectanceFactors*=metallicReflectanceFactorsMap.a;\n#endif\n#endif\nreflectivityBlock(\nvReflectivityColor,\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo,\nmetallicReflectanceFactors,\n#endif\n#ifdef REFLECTIVITY\nvReflectivityInfos,\nsurfaceMetallicOrReflectivityColorMap,\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor,\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurfaceTexel,\n#endif\n#ifdef DETAIL\ndetailColor,\nvDetailInfos,\n#endif\nreflectivityOut\n);\nfloat microSurface=reflectivityOut.microSurface;\nfloat roughness=reflectivityOut.roughness;\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo=reflectivityOut.surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;\n#endif\n#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nalphaFresnelOutParams alphaFresnelOut;\nalphaFresnelBlock(\nnormalW,\nviewDirectionW,\nalpha,\nmicroSurface,\nalphaFresnelOut\n);\nalpha=alphaFresnelOut.alpha;\n#endif\n#endif\n#include<pbrBlockGeometryInfo>\n#ifdef ANISOTROPIC\nanisotropicOutParams anisotropicOut;\n#ifdef ANISOTROPIC_TEXTURE\nvec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;\n#endif\nanisotropicBlock(\nvAnisotropy,\n#ifdef ANISOTROPIC_TEXTURE\nanisotropyMapData,\n#endif\nTBN,\nnormalW,\nviewDirectionW,\nanisotropicOut\n);\n#endif\n#ifdef REFLECTION\nreflectionOutParams reflectionOut;\n#ifndef USE_CUSTOM_REFLECTION\nreflectionBlock(\nvPositionW,\nnormalW,\nalphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nroughness,\n#endif\nreflectionSampler,\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nvEnvironmentIrradiance,\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nreflectionMatrix,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\nirradianceSampler,\n#endif\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nreflectionOut\n);\n#else\n#define CUSTOM_REFLECTION\n#endif\n#endif\n#include<pbrBlockReflectance0>\n#ifdef SHEEN\nsheenOutParams sheenOut;\n#ifdef SHEEN_TEXTURE\nvec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);\n#endif\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;\n#endif\nsheenBlock(\nvSheenColor,\n#ifdef SHEEN_ROUGHNESS\nvSheenRoughness,\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nsheenMapRoughnessData,\n#endif\n#endif\nroughness,\n#ifdef SHEEN_TEXTURE\nsheenMapData,\nvSheenInfos.y,\n#endif\nreflectance,\n#ifdef SHEEN_LINKWITHALBEDO\nbaseColor,\nsurfaceAlbedo,\n#endif\n#ifdef ENVIRONMENTBRDF\nNdotV,\nenvironmentBrdf,\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nAARoughnessFactors,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\nvLightingIntensity,\nreflectionSampler,\nreflectionOut.reflectionCoords,\nNdotVUnclamped,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nseo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\neho,\n#endif\n#endif\nsheenOut\n);\n#ifdef SHEEN_LINKWITHALBEDO\nsurfaceAlbedo=sheenOut.surfaceAlbedo;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifdef CLEARCOAT_TEXTURE\nvec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;\n#endif\n#endif\n#ifdef IRIDESCENCE\niridescenceOutParams iridescenceOut;\n#ifdef IRIDESCENCE_TEXTURE\nvec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nvec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;\n#endif\niridescenceBlock(\nvIridescenceParams,\nNdotV,\nspecularEnvironmentR0,\n#ifdef IRIDESCENCE_TEXTURE\niridescenceMapData,\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\niridescenceThicknessMapData,\n#endif\n#ifdef CLEARCOAT\nNdotVUnclamped,\n#ifdef CLEARCOAT_TEXTURE\nclearCoatMapData,\n#endif\n#endif\niridescenceOut\n);\nfloat iridescenceIntensity=iridescenceOut.iridescenceIntensity;\nspecularEnvironmentR0=iridescenceOut.specularEnvironmentR0;\n#endif\nclearcoatOutParams clearcoatOut;\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);\n#endif\n#ifdef CLEARCOAT_BUMP\nvec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);\n#endif\nclearcoatBlock(\nvPositionW,\ngeometricNormalW,\nviewDirectionW,\nvClearCoatParams,\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nclearCoatMapRoughnessData,\n#endif\nspecularEnvironmentR0,\n#ifdef CLEARCOAT_TEXTURE\nclearCoatMapData,\n#endif\n#ifdef CLEARCOAT_TINT\nvClearCoatTintParams,\nclearCoatColorAtDistance,\nvClearCoatRefractionParams,\n#ifdef CLEARCOAT_TINT_TEXTURE\nclearCoatTintMapData,\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\nvClearCoatBumpInfos,\nclearCoatBumpMapData,\nvClearCoatBumpUV,\n#if defined(TANGENT) && defined(NORMAL)\nvTBN,\n#else\nvClearCoatTangentSpaceParams,\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nnormalMatrix,\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nfaceNormal,\n#endif\n#ifdef REFLECTION\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\nvLightingIntensity,\nreflectionSampler,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\nambientMonochrome,\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n(gl_FrontFacing ? 1. : -1.),\n#endif\nclearcoatOut\n);\n#else\nclearcoatOut.specularEnvironmentR0=specularEnvironmentR0;\n#endif\n#include<pbrBlockReflectance>\nsubSurfaceOutParams subSurfaceOut;\n#ifdef SUBSURFACE\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nvec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nvec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);\n#endif\nsubSurfaceBlock(\nvSubSurfaceIntensity,\nvThicknessParam,\nvTintColor,\nnormalW,\nspecularEnvironmentReflectance,\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nthicknessMap,\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nrefractionIntensityMap,\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\ntranslucencyIntensityMap,\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\nreflectionMatrix,\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nreflectionOut.irradianceVector,\n#endif\n#if defined(REALTIME_FILTERING)\nreflectionSampler,\nvReflectionFilteringInfo,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\nirradianceSampler,\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\nsurfaceAlbedo,\n#endif\n#ifdef SS_REFRACTION\nvPositionW,\nviewDirectionW,\nview,\nvRefractionInfos,\nrefractionMatrix,\nvRefractionMicrosurfaceInfos,\nvLightingIntensity,\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha,\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nNdotVUnclamped,\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\nroughness,\n#endif\nalphaG,\nrefractionSampler,\n#ifndef LODBASEDMICROSFURACE\nrefractionSamplerLow,\nrefractionSamplerHigh,\n#endif\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\n#ifdef REALTIME_FILTERING\nvRefractionFilteringInfo,\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nvRefractionPosition,\nvRefractionSize,\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvDiffusionDistance,\n#endif\nsubSurfaceOut\n);\n#ifdef SS_REFRACTION\nsurfaceAlbedo=subSurfaceOut.surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha=subSurfaceOut.alpha;\n#endif\n#endif\n#else\nsubSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#endif\n#include<pbrBlockDirectLighting>\n#include<lightFragment>[0..maxSimultaneousLights]\n#include<pbrBlockFinalLitComponents>\n#endif \n#include<pbrBlockFinalUnlitComponents>\n#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION\n#include<pbrBlockFinalColorComposition>\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#include<pbrBlockImageProcessing>\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\nfloat writeGeometryInfo=finalColor.a>0.4 ? 1.0 : 0.0;\n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;\nvec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;\nvec2 velocity=abs(a-b);\nvelocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;\ngl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nvec3 sqAlbedo=sqrt(surfaceAlbedo); \n#endif\n#ifdef PREPASS_IRRADIANCE\nvec3 irradiance=finalDiffuse;\n#ifndef UNLIT\n#ifdef REFLECTION\nirradiance+=finalIrradiance;\n#endif\n#endif\n#ifdef SS_SCATTERING\ngl_FragData[0]=vec4(finalColor.rgb-irradiance,finalColor.a); \nirradiance/=sqAlbedo;\n#else\ngl_FragData[0]=finalColor; \nfloat scatteringDiffusionProfile=255.;\n#endif\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); \n#else\ngl_FragData[0]=vec4(finalColor.rgb,finalColor.a);\n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_NORMAL\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); \n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); \n#endif\n#ifdef PREPASS_REFLECTIVITY\n#ifndef UNLIT\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;\n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;\n#endif\n#endif\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=finalColor;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {\nfrontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;\nfrontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);\n} else {\nbackColor+=finalColor;\n}\n#endif\n#include<pbrDebug>\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";j.IncludesShadersStore.pbrVertexDeclaration="uniform mat4 view;\nuniform mat4 viewProjection;\n#ifdef ALBEDO\nuniform mat4 albedoMatrix;\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;\nuniform vec4 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#ifdef REFLECTIVITY \nuniform vec3 vReflectivityInfos;\nuniform mat4 reflectivityMatrix;\n#endif\n#ifdef METALLIC_REFLECTANCE\nuniform vec2 vMetallicReflectanceInfos;\nuniform mat4 metallicReflectanceMatrix;\n#endif\n#ifdef REFLECTANCE\nuniform vec2 vReflectanceInfos;\nuniform mat4 reflectanceMatrix;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\nuniform mat4 microSurfaceSamplerMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\n#endif\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;\nuniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;\nuniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#ifdef IRIDESCENCE\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;\nuniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionInfos;\nuniform mat4 refractionMatrix;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;\nuniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;\nuniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;\nuniform mat4 translucencyIntensityMatrix;\n#endif\n#endif\n#ifdef NORMAL\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;\nuniform vec3 vSphericalL1_1;\nuniform vec3 vSphericalL10;\nuniform vec3 vSphericalL11;\nuniform vec3 vSphericalL2_2;\nuniform vec3 vSphericalL2_1;\nuniform vec3 vSphericalL20;\nuniform vec3 vSphericalL21;\nuniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;\nuniform vec3 vSphericalY;\nuniform vec3 vSphericalZ;\nuniform vec3 vSphericalXX_ZZ;\nuniform vec3 vSphericalYY_ZZ;\nuniform vec3 vSphericalZZ;\nuniform vec3 vSphericalXY;\nuniform vec3 vSphericalYZ;\nuniform vec3 vSphericalZX;\n#endif\n#endif\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\nuniform mat4 detailMatrix;\n#endif\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n";j.ShadersStore.pbrVertexShader="precision highp float;\n#include<__decl__pbrVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)\n#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\n#ifdef CLEARCOAT\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)\n#endif\nvarying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#include<harmonicsFunctions>\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\nvPositionW=vec3(worldPos);\n#include<prePassVertex>\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));\nvNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*worldPos;\n} else {\ngl_Position=viewProjectionR*worldPos;\n}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvClipSpacePosition=gl_Position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#include<uvVariableDeclaration>[2..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#ifdef CLEARCOAT\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)\n#endif\n#ifdef SHEEN\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.z)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";class mne extends Un{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class Cs extends Wo{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRClearCoat",100,new mne,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=Cs._DefaultIndexOfRefraction,this.indexOfRefraction=Cs._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=re.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;const s=this._material._disableBumpMap;return!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&pe.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&pe.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||i.getCaps().standardDerivatives&&this._bumpTexture&&pe.ClearCoatBumpTextureEnabled&&!s&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&pe.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=null!==this._texture&&this._texture._texture===(null===(i=this._textureRoughness)||void 0===i?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&pe.ClearCoatTextureEnabled?ce.PrepareDefinesForMergedUV(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&pe.ClearCoatTextureEnabled?ce.PrepareDefinesForMergedUV(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&pe.ClearCoatBumpTextureEnabled?ce.PrepareDefinesForMergedUV(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===Cs._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&pe.ClearCoatTintTextureEnabled?(ce.PrepareDefinesForMergedUV(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,s){var n,o,a,l,c,h,u,d;if(!this._isEnabled)return;const f=s.materialDefines,_=this._material._disableBumpMap,m=this._material._invertNormalMapX,g=this._material._invertNormalMapY,b=f.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL;if(!e.useUbo||!this._material.isFrozen||!e.isSync){b&&pe.ClearCoatTextureEnabled?(e.updateFloat4("vClearCoatInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),ce.BindTextureMatrix(this._texture,e,"clearCoat")):(this._texture||this._textureRoughness)&&pe.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",null!==(o=null===(n=this._texture)||void 0===n?void 0:n.coordinatesIndex)&&void 0!==o?o:0,null!==(l=null===(a=this._texture)||void 0===a?void 0:a.level)&&void 0!==l?l:0,null!==(h=null===(c=this._textureRoughness)||void 0===c?void 0:c.coordinatesIndex)&&void 0!==h?h:0,null!==(d=null===(u=this._textureRoughness)||void 0===u?void 0:u.level)&&void 0!==d?d:0),this._texture&&ce.BindTextureMatrix(this._texture,e,"clearCoat"),this._textureRoughness&&!b&&!f.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&ce.BindTextureMatrix(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&pe.ClearCoatTextureEnabled&&!_&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),ce.BindTextureMatrix(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",m?1:-1,g?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",m?-1:1,g?-1:1)),this._tintTexture&&pe.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),ce.BindTextureMatrix(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const y=1-this._indexOfRefraction,T=1+this._indexOfRefraction,x=Math.pow(-y/T,2);e.updateFloat4("vClearCoatRefractionParams",x,1/this._indexOfRefraction,y,T),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&pe.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!b&&!f.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&pe.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&pe.ClearCoatBumpTextureEnabled&&!_&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&pe.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){var t,i,s,n;e&&(null===(t=this._texture)||void 0===t||t.dispose(),null===(i=this._textureRoughness)||void 0===i||i.dispose(),null===(s=this._bumpTexture)||void 0===s||s.dispose(),null===(n=this._tintTexture)||void 0===n||n.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}Cs._DefaultIndexOfRefraction=1.5,E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Cs.prototype,"isEnabled",void 0),E([I()],Cs.prototype,"intensity",void 0),E([I()],Cs.prototype,"roughness",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Cs.prototype,"indexOfRefraction",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Cs.prototype,"texture",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Cs.prototype,"useRoughnessFromMainTexture",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Cs.prototype,"textureRoughness",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Cs.prototype,"remapF0OnInterfaceChange",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Cs.prototype,"bumpTexture",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Cs.prototype,"isTintEnabled",void 0),E([us()],Cs.prototype,"tintColor",void 0),E([I()],Cs.prototype,"tintColorAtDistance",void 0),E([I()],Cs.prototype,"tintThickness",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Cs.prototype,"tintTexture",void 0);class gne extends Un{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0,this.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1}}class xr extends Wo{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRIridescence",110,new gne,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=xr._DefaultMinimumThickness,this.maximumThickness=xr._DefaultMaximumThickness,this.indexOfRefraction=xr._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&pe.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._thicknessTexture&&pe.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.IRIDESCENCE=!0,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=null!==this._texture&&this._texture._texture===(null===(i=this._thicknessTexture)||void 0===i?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._thicknessTexture),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&pe.IridescenceTextureEnabled?ce.PrepareDefinesForMergedUV(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,!e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&this._thicknessTexture&&pe.IridescenceTextureEnabled?ce.PrepareDefinesForMergedUV(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t,i,s){var n,o,a,l,c,h,u,d;if(!this._isEnabled)return;const f=s.materialDefines,_=f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE;(!e.useUbo||!this._material.isFrozen||!e.isSync)&&(_&&pe.IridescenceTextureEnabled?(e.updateFloat4("vIridescenceInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),ce.BindTextureMatrix(this._texture,e,"iridescence")):(this._texture||this._thicknessTexture)&&pe.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",null!==(o=null===(n=this._texture)||void 0===n?void 0:n.coordinatesIndex)&&void 0!==o?o:0,null!==(l=null===(a=this._texture)||void 0===a?void 0:a.level)&&void 0!==l?l:0,null!==(h=null===(c=this._thicknessTexture)||void 0===c?void 0:c.coordinatesIndex)&&void 0!==h?h:0,null!==(d=null===(u=this._thicknessTexture)||void 0===u?void 0:u.level)&&void 0!==d?d:0),this._texture&&ce.BindTextureMatrix(this._texture,e,"iridescence"),this._thicknessTexture&&!_&&!f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&ce.BindTextureMatrix(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&pe.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&!_&&!f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&pe.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){var t,i;e&&(null===(t=this._texture)||void 0===t||t.dispose(),null===(i=this._thicknessTexture)||void 0===i||i.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}xr._DefaultMinimumThickness=100,xr._DefaultMaximumThickness=400,xr._DefaultIndexOfRefraction=1.3,E([I(),ne("_markAllSubMeshesAsTexturesDirty")],xr.prototype,"isEnabled",void 0),E([I()],xr.prototype,"intensity",void 0),E([I()],xr.prototype,"minimumThickness",void 0),E([I()],xr.prototype,"maximumThickness",void 0),E([I()],xr.prototype,"indexOfRefraction",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],xr.prototype,"texture",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],xr.prototype,"thicknessTexture",void 0);class vne extends Un{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.MAINUV1=!1}}class Up extends Wo{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new vne,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new de(1,0),this._texture=null,this.texture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&pe.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking())}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(A.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&pe.AnisotropicTextureEnabled?ce.PrepareDefinesForMergedUV(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.MAINUV1=!1)}bindForSubMesh(e,t){this._isEnabled&&((!e.useUbo||!this._material.isFrozen||!e.isSync)&&(this._texture&&pe.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),ce.BindTextureMatrix(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&pe.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture))}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}}E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Up.prototype,"isEnabled",void 0),E([I()],Up.prototype,"intensity",void 0),E([iE()],Up.prototype,"direction",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Up.prototype,"texture",void 0);class bne extends Un{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1}}class va extends Wo{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"Sheen",120,new bne,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=re.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&pe.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&pe.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=null!==this._roughness,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=null!==this._texture&&this._texture._texture===(null===(i=this._textureRoughness)||void 0===i?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&pe.SheenTextureEnabled?(ce.PrepareDefinesForMergedUV(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&pe.SheenTextureEnabled?ce.PrepareDefinesForMergedUV(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,s){var n,o,a,l,c,h,u,d;if(!this._isEnabled)return;const f=s.materialDefines,_=f.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;(!e.useUbo||!this._material.isFrozen||!e.isSync)&&(_&&pe.SheenTextureEnabled?(e.updateFloat4("vSheenInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),ce.BindTextureMatrix(this._texture,e,"sheen")):(this._texture||this._textureRoughness)&&pe.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",null!==(o=null===(n=this._texture)||void 0===n?void 0:n.coordinatesIndex)&&void 0!==o?o:0,null!==(l=null===(a=this._texture)||void 0===a?void 0:a.level)&&void 0!==l?l:0,null!==(h=null===(c=this._textureRoughness)||void 0===c?void 0:c.coordinatesIndex)&&void 0!==h?h:0,null!==(d=null===(u=this._textureRoughness)||void 0===u?void 0:u.level)&&void 0!==d?d:0),this._texture&&ce.BindTextureMatrix(this._texture,e,"sheen"),this._textureRoughness&&!_&&!f.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&ce.BindTextureMatrix(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),null!==this._roughness&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&pe.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!_&&!f.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&pe.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){var t,i;e&&(null===(t=this._texture)||void 0===t||t.dispose(),null===(i=this._textureRoughness)||void 0===i||i.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}E([I(),ne("_markAllSubMeshesAsTexturesDirty")],va.prototype,"isEnabled",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],va.prototype,"linkSheenWithAlbedo",void 0),E([I()],va.prototype,"intensity",void 0),E([us()],va.prototype,"color",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],va.prototype,"texture",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],va.prototype,"useRoughnessFromMainTexture",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],va.prototype,"roughness",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],va.prototype,"textureRoughness",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],va.prototype,"albedoScaling",void 0);class yne extends Un{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_SCATTERING=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_MASK_FROM_THICKNESS_TEXTURE=!1,this.SS_USE_GLTF_TEXTURES=!1}}class zi extends Wo{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){!this._scene.enableSubSurfaceForPrePass()||e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){this._volumeIndexOfRefraction=e>=1?e:-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}constructor(e,t=!0){super(e,"PBRSubSurface",130,new yne,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=re.White(),this.tintColorAtDistance=1,this.diffusionDistance=re.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this._useGltfStyleTextures=!1,this.useGltfStyleTextures=!1,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&pe.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;const i=this._getRefractionTexture(t);if(i&&pe.RefractionTextureEnabled&&!i.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return e.SUBSURFACE=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,void(e.SS_USE_GLTF_TEXTURES=!1);if(e._areTexturesDirty){e.SUBSURFACE=!0,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1;const i=!!this._thicknessTexture&&!!this._refractionIntensityTexture&&this._refractionIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._refractionIntensityTexture._texture===this._thicknessTexture._texture,s=!!this._thicknessTexture&&!!this._translucencyIntensityTexture&&this._translucencyIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._translucencyIntensityTexture._texture===this._thicknessTexture._texture,n=(i||!this._refractionIntensityTexture)&&(s||!this._translucencyIntensityTexture);if(e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&pe.ThicknessTextureEnabled&&ce.PrepareDefinesForMergedUV(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&pe.RefractionIntensityTextureEnabled&&!n&&ce.PrepareDefinesForMergedUV(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&pe.TranslucencyIntensityTextureEnabled&&!n&&ce.PrepareDefinesForMergedUV(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!=0,e.SS_MASK_FROM_THICKNESS_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture||!!this._translucencyIntensityTexture)&&n,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture)&&n,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._translucencyIntensityTexture)&&n,this._isRefractionEnabled&&t.texturesEnabled){const o=this._getRefractionTexture(t);o&&pe.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=o.isCube,e.SS_GAMMAREFRACTION=o.gammaSpace,e.SS_RGBDREFRACTION=o.isRGBD,e.SS_LINEARSPECULARREFRACTION=o.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=o.invertZ,e.SS_LODINREFRACTIONALPHA=o.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=o.isCube&&o.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,s){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;s.getRenderingMesh().getWorldMatrix().decompose(L.Vector3[0]);const n=Math.max(Math.abs(L.Vector3[0].x),Math.abs(L.Vector3[0].y),Math.abs(L.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*n,(this.maximumThickness-this.minimumThickness)*n)}bindForSubMesh(e,t,i,s){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const n=s.materialDefines,o=this._material.isFrozen,a=this._material.realTimeFiltering,l=n.LODBASEDMICROSFURACE,c=this._getRefractionTexture(t);if(!e.useUbo||!o||!e.isSync){if(this._thicknessTexture&&pe.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),ce.BindTextureMatrix(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&pe.RefractionIntensityTextureEnabled&&n.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),ce.BindTextureMatrix(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyIntensityTexture&&pe.TranslucencyIntensityTextureEnabled&&n.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),ce.BindTextureMatrix(this._translucencyIntensityTexture,e,"translucencyIntensity")),c&&pe.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",c.getReflectionTextureMatrix());let h=1;c.isCube||c.depth&&(h=c.depth);const u=c.getSize().width;if(e.updateFloat4("vRefractionInfos",c.level,1/this.volumeIndexOfRefraction,h,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",u,c.lodGenerationScale,c.lodGenerationOffset,1/this.indexOfRefraction),a&&e.updateFloat2("vRefractionFilteringInfo",u,oe.Log2(u)),c.boundingBoxSize){const f=c;e.updateVector3("vRefractionPosition",f.boundingBoxPosition),e.updateVector3("vRefractionSize",f.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0)}t.texturesEnabled&&(this._thicknessTexture&&pe.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&pe.RefractionIntensityTextureEnabled&&n.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&pe.TranslucencyIntensityTextureEnabled&&n.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),c&&pe.RefractionTextureEnabled&&(l?e.setTexture("refractionSampler",c):(e.setTexture("refractionSampler",c._lodTextureMid||c),e.setTexture("refractionSamplerLow",c._lodTextureLow||c),e.setTexture("refractionSamplerHigh",c._lodTextureHigh||c))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){pe.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e}hasRenderTargetTextures(){return!!(pe.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"}]}}}E([I(),ne("_markAllSubMeshesAsTexturesDirty")],zi.prototype,"isRefractionEnabled",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],zi.prototype,"isTranslucencyEnabled",void 0),E([I(),ne("_markScenePrePassDirty")],zi.prototype,"isScatteringEnabled",void 0),E([I()],zi.prototype,"_scatteringDiffusionProfileIndex",void 0),E([I()],zi.prototype,"refractionIntensity",void 0),E([I()],zi.prototype,"translucencyIntensity",void 0),E([I()],zi.prototype,"useAlbedoToTintRefraction",void 0),E([I()],zi.prototype,"useAlbedoToTintTranslucency",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],zi.prototype,"thicknessTexture",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],zi.prototype,"refractionTexture",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],zi.prototype,"indexOfRefraction",void 0),E([I()],zi.prototype,"_volumeIndexOfRefraction",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],zi.prototype,"volumeIndexOfRefraction",null),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],zi.prototype,"invertRefractionY",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],zi.prototype,"linkRefractionWithTransparency",void 0),E([I()],zi.prototype,"minimumThickness",void 0),E([I()],zi.prototype,"maximumThickness",void 0),E([I()],zi.prototype,"useThicknessAsDepth",void 0),E([us()],zi.prototype,"tintColor",void 0),E([I()],zi.prototype,"tintColorAtDistance",void 0),E([us()],zi.prototype,"diffusionDistance",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],zi.prototype,"useMaskFromThicknessTexture",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],zi.prototype,"refractionIntensityTexture",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],zi.prototype,"translucencyIntensityTexture",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],zi.prototype,"useGltfStyleTextures",void 0);const td={effect:null,subMesh:null};class g3 extends Un{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class Vt extends gp{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}constructor(e,t){super(e,t),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new vt(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=Vt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=re.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new re(0,0,0),this._albedoColor=new re(1,1,1),this._reflectivityColor=new re(1,1,1),this._reflectionColor=new re(1,1,1),this._emissiveColor=new re(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=Vt.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._forceAlphaTest=!1,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new ws(16),this._globalAmbientColor=new re(0,0,0),this._useLogarithmicDepth=!1,this._unlit=!1,this._debugMode=0,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new mr(this),this.clearCoat=new Cs(this),this.iridescence=new xr(this),this.anisotropy=new Up(this),this.sheen=new va(this),this.subSurface=new zi(this),this.detailMap=new tc(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),pe.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=$v(this.getScene()),this.prePassConfiguration=new $u}get hasRenderTargetTextures(){return!!(pe.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}get _disableAlphaBlending(){var e;return this._transparencyMode===Vt.PBRMATERIAL_OPAQUE||this._transparencyMode===Vt.PBRMATERIAL_ALPHATEST||(null===(e=this.subSurface)||void 0===e?void 0:e.disableAlphaBlending)}needAlphaBlending(){return!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromAlbedoTexture())}needAlphaTesting(){var e;return!!this._forceAlphaTest||(null===(e=this.subSurface)||void 0===e||!e.disableAlphaBlending)&&this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===Vt.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==Vt.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(Ns.GetDefineNames,this._eventInfo),t.materialDefines=new g3(this._eventInfo.defineNames));const s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=this.getScene(),o=n.getEngine();if(s._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,n.texturesEnabled)){if(this._albedoTexture&&pe.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._ambientTexture&&pe.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&pe.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;const u=this._getReflectionTexture();if(u&&pe.ReflectionTextureEnabled&&(!u.isReadyOrNotBlocking()||u.irradianceTexture&&!u.irradianceTexture.isReadyOrNotBlocking())||this._lightmapTexture&&pe.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&pe.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(pe.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(o.getCaps().standardDerivatives&&this._bumpTexture&&pe.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&pe.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||s._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;!o.getCaps().standardDerivatives&&!e.isVerticesDataPresent(A.NormalKind)&&(e.createNormals(!0),V.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const a=t.effect,l=s._areLightsDisposed;let c=this._prepareEffect(e,s,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances),h=!1;if(c)if(this._onEffectCreatedObservable&&(td.effect=c,td.subMesh=t,this._onEffectCreatedObservable.notifyObservers(td)),this.allowShaderHotSwapping&&a&&!c.isReady()){if(c=a,s.markAsUnprocessed(),h=this.isFrozen,l)return s._areLightsDisposed=!0,!1}else n.resetCachedMaterial(),t.setEffect(c,s,this._materialContext);return!(!t.effect||!t.effect.isReady()||(s._renderId=n.getRenderId(),t.effect._wasPreviouslyReady=!h,t.effect._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),0))}isMetallicWorkflow(){return!(null==this._metallic&&null==this._roughness&&!this._metallicTexture)}_prepareEffect(e,t,i=null,s=null,n=null,o=null,a){if(this._prepareDefines(e,t,n,o,a),!t.isDirty)return null;t.markAsProcessed();const c=this.getScene().getEngine(),h=new oh;let u=0;t.USESPHERICALINVERTEX&&h.addFallback(u++,"USESPHERICALINVERTEX"),t.FOG&&h.addFallback(u,"FOG"),t.SPECULARAA&&h.addFallback(u,"SPECULARAA"),t.POINTSIZE&&h.addFallback(u,"POINTSIZE"),t.LOGARITHMICDEPTH&&h.addFallback(u,"LOGARITHMICDEPTH"),t.PARALLAX&&h.addFallback(u,"PARALLAX"),t.PARALLAXOCCLUSION&&h.addFallback(u++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&h.addFallback(u++,"ENVIRONMENTBRDF"),t.TANGENT&&h.addFallback(u++,"TANGENT"),t.BUMP&&h.addFallback(u++,"BUMP"),u=ce.HandleFallbacksForShadows(t,h,this._maxSimultaneousLights,u++),t.SPECULARTERM&&h.addFallback(u++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&h.addFallback(u++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&h.addFallback(u++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&h.addFallback(u++,"LIGHTMAP"),t.NORMAL&&h.addFallback(u++,"NORMAL"),t.AMBIENT&&h.addFallback(u++,"AMBIENT"),t.EMISSIVE&&h.addFallback(u++,"EMISSIVE"),t.VERTEXCOLOR&&h.addFallback(u++,"VERTEXCOLOR"),t.MORPHTARGETS&&h.addFallback(u++,"MORPHTARGETS"),t.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");const d=[A.PositionKind];t.NORMAL&&d.push(A.NormalKind),t.TANGENT&&d.push(A.TangentKind);for(let T=1;T<=6;++T)t["UV"+T]&&d.push(`uv${1===T?"":T}`);t.VERTEXCOLOR&&d.push(A.ColorKind),t.INSTANCESCOLOR&&d.push(A.ColorInstanceKind),ce.PrepareAttributesForBones(d,e,t,h),ce.PrepareAttributesForInstances(d,t),ce.PrepareAttributesForMorphTargets(d,e,t),ce.PrepareAttributesForBakedVertexAnimation(d,e,t);let f="pbr";const p=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],_=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],m=["Material","Scene","Mesh"];this._eventInfo.fallbacks=h,this._eventInfo.fallbackRank=u,this._eventInfo.defines=t,this._eventInfo.uniforms=p,this._eventInfo.attributes=d,this._eventInfo.samplers=_,this._eventInfo.uniformBuffersNames=m,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._callbackPluginEventGeneric(Ns.PrepareEffect,this._eventInfo),$u.AddUniforms(p),$u.AddSamplers(_),Uo(p),at&&(at.PrepareUniforms(p,t),at.PrepareSamplers(_,t)),ce.PrepareUniformsAndSamplersList({uniformsNames:p,uniformBuffersNames:m,samplers:_,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});const g={};this.customShaderNameResolve&&(f=this.customShaderNameResolve(f,p,m,_,t,d,g));const b=t.toString(),y=c.createEffect(f,{attributes:d,uniformsNames:p,uniformBuffersNames:m,samplers:_,defines:b,fallbacks:h,onCompiled:i,onError:s,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS},processFinalCode:g.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS},c);return this._eventInfo.customCode=void 0,y}_prepareDefines(e,t,i=null,s=null,n=!1){var o;const a=this.getScene(),l=a.getEngine();ce.PrepareDefinesForLights(a,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,ce.PrepareDefinesForMultiview(a,t);const c=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(ce.PrepareDefinesForPrePass(a,t,this.canRenderToMRT&&!c),ce.PrepareDefinesForOIT(a,t,c),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){if(t._needUVs=!1,a.texturesEnabled){t.ALBEDODIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,l.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&pe.DiffuseTextureEnabled?(ce.PrepareDefinesForMergedUV(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._ambientTexture&&pe.AmbientTextureEnabled?(ce.PrepareDefinesForMergedUV(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&pe.OpacityTextureEnabled?(ce.PrepareDefinesForMergedUV(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;const h=this._getReflectionTexture();if(h&&pe.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=h.gammaSpace,t.RGBDREFLECTION=h.isRGBD,t.LODINREFLECTIONALPHA=h.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=h.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,l._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0):t.REALTIME_FILTERING=!1,t.INVERTCUBICMAP=h.coordinatesMode===U.INVCUBIC_MODE,t.REFLECTIONMAP_3D=h.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!h.invertZ:h.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,h.coordinatesMode){case U.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case U.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case U.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case U.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case U.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case U.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case U.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case U.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!h.boundingBoxSize}h.coordinatesMode!==U.SKYBOX_MODE&&(h.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1):h.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!(this._forceIrradianceInFragment||this.realTimeFiltering||l.getCaps().maxVaryingVectors<=8)))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;if(this._lightmapTexture&&pe.LightmapTextureEnabled?(ce.PrepareDefinesForMergedUV(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&pe.EmissiveTextureEnabled?(ce.PrepareDefinesForMergedUV(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,pe.SpecularTextureEnabled){if(this._metallicTexture?(ce.PrepareDefinesForMergedUV(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(ce.PrepareDefinesForMergedUV(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture){const u=null!==this._metallicReflectanceTexture&&this._metallicReflectanceTexture._texture===(null===(o=this._reflectanceTexture)||void 0===o?void 0:o._texture)&&this._metallicReflectanceTexture.checkTransformsAreIdentical(this._reflectanceTexture);t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture&&!u,this._metallicReflectanceTexture?(ce.PrepareDefinesForMergedUV(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&!u&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(ce.PrepareDefinesForMergedUV(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1}else t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1;this._microSurfaceTexture?ce.PrepareDefinesForMergedUV(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1}else t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1;l.getCaps().standardDerivatives&&this._bumpTexture&&pe.BumpTextureEnabled&&!this._disableBumpMap?(ce.PrepareDefinesForMergedUV(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&pe.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAXOCCLUSION=!1,t.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&pe.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),t.ALPHAFROMALBEDO=!!this._shouldUseAlphaFromAlbedoTexture()}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===Vt.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===Vt.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,t.TWOSIDEDLIGHTING=!(this.backFaceCulling||!this._twoSidedLighting),t.SPECULARAA=l.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1==0?".":""}`,t.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&(ce.PrepareDefinesForMisc(e,a,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(A.NormalKind),t.DEBUGMODE=this._debugMode),ce.PrepareDefinesForFrameBoundValues(a,l,this,t,!!i,s,n),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),ce.PrepareDefinesForAttributes(e,t,!0,!0,!0,this._transparencyMode!==Vt.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){const s={clipPlane:!1,useInstances:!1,...i};this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(Ns.GetDefineNames,this._eventInfo);const n=new g3(this._eventInfo.defineNames),o=this._prepareEffect(e,n,void 0,void 0,s.useInstances,s.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(td.effect=o,td.subMesh=null,this._onEffectCreatedObservable.notifyObservers(td)),o.isReady()?t&&t(this):o.onCompileObservable.add(()=>{t&&t(this)})}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var s,n,o,a;const l=this.getScene(),c=i.materialDefines;if(!c)return;const h=i.effect;if(!h)return;this._activeEffect=h,t.getMeshUniformBuffer().bindToEffect(h,"Mesh"),t.transferToEffect(e);const u=l.getEngine();this._uniformBuffer.bindToEffect(h,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,l,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),c.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const d=h._forceRebindOnNextCall||this._mustRebind(l,h,t.visibility);ce.BindBonesParameters(t,this._activeEffect,this.prePassConfiguration);let f=null;const p=this._uniformBuffer;if(d){if(this.bindViewProjection(h),f=this._getReflectionTexture(),!p.useUbo||!this.isFrozen||!p.isSync||h._forceRebindOnNextCall){if(l.texturesEnabled){if(this._albedoTexture&&pe.DiffuseTextureEnabled&&(p.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),ce.BindTextureMatrix(this._albedoTexture,p,"albedo")),this._ambientTexture&&pe.AmbientTextureEnabled&&(p.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),ce.BindTextureMatrix(this._ambientTexture,p,"ambient")),this._opacityTexture&&pe.OpacityTextureEnabled&&(p.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),ce.BindTextureMatrix(this._opacityTexture,p,"opacity")),f&&pe.ReflectionTextureEnabled){if(p.updateMatrix("reflectionMatrix",f.getReflectionTextureMatrix()),p.updateFloat2("vReflectionInfos",f.level,0),f.boundingBoxSize){const _=f;p.updateVector3("vReflectionPosition",_.boundingBoxPosition),p.updateVector3("vReflectionSize",_.boundingBoxSize)}if(this.realTimeFiltering){const _=f.getSize().width;p.updateFloat2("vReflectionFilteringInfo",_,oe.Log2(_))}if(!c.USEIRRADIANCEMAP){const _=f.sphericalPolynomial;if(c.USESPHERICALFROMREFLECTIONMAP&&_)if(c.SPHERICAL_HARMONICS){const m=_.preScaledHarmonics;p.updateVector3("vSphericalL00",m.l00),p.updateVector3("vSphericalL1_1",m.l1_1),p.updateVector3("vSphericalL10",m.l10),p.updateVector3("vSphericalL11",m.l11),p.updateVector3("vSphericalL2_2",m.l2_2),p.updateVector3("vSphericalL2_1",m.l2_1),p.updateVector3("vSphericalL20",m.l20),p.updateVector3("vSphericalL21",m.l21),p.updateVector3("vSphericalL22",m.l22)}else p.updateFloat3("vSphericalX",_.x.x,_.x.y,_.x.z),p.updateFloat3("vSphericalY",_.y.x,_.y.y,_.y.z),p.updateFloat3("vSphericalZ",_.z.x,_.z.y,_.z.z),p.updateFloat3("vSphericalXX_ZZ",_.xx.x-_.zz.x,_.xx.y-_.zz.y,_.xx.z-_.zz.z),p.updateFloat3("vSphericalYY_ZZ",_.yy.x-_.zz.x,_.yy.y-_.zz.y,_.yy.z-_.zz.z),p.updateFloat3("vSphericalZZ",_.zz.x,_.zz.y,_.zz.z),p.updateFloat3("vSphericalXY",_.xy.x,_.xy.y,_.xy.z),p.updateFloat3("vSphericalYZ",_.yz.x,_.yz.y,_.yz.z),p.updateFloat3("vSphericalZX",_.zx.x,_.zx.y,_.zx.z)}p.updateFloat3("vReflectionMicrosurfaceInfos",f.getSize().width,f.lodGenerationScale,f.lodGenerationOffset)}this._emissiveTexture&&pe.EmissiveTextureEnabled&&(p.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),ce.BindTextureMatrix(this._emissiveTexture,p,"emissive")),this._lightmapTexture&&pe.LightmapTextureEnabled&&(p.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),ce.BindTextureMatrix(this._lightmapTexture,p,"lightmap")),pe.SpecularTextureEnabled&&(this._metallicTexture?(p.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),ce.BindTextureMatrix(this._metallicTexture,p,"reflectivity")):this._reflectivityTexture&&(p.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),ce.BindTextureMatrix(this._reflectivityTexture,p,"reflectivity")),this._metallicReflectanceTexture&&(p.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),ce.BindTextureMatrix(this._metallicReflectanceTexture,p,"metallicReflectance")),this._reflectanceTexture&&c.REFLECTANCE&&(p.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),ce.BindTextureMatrix(this._reflectanceTexture,p,"reflectance")),this._microSurfaceTexture&&(p.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),ce.BindTextureMatrix(this._microSurfaceTexture,p,"microSurfaceSampler"))),this._bumpTexture&&u.getCaps().standardDerivatives&&pe.BumpTextureEnabled&&!this._disableBumpMap&&(p.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),ce.BindTextureMatrix(this._bumpTexture,p,"bump"),l._mirroredCameraPosition?p.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):p.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&p.updateFloat("pointSize",this.pointSize),c.METALLICWORKFLOW){wt.Color3[0].r=this._metallic??1,wt.Color3[0].g=this._roughness??1,p.updateColor4("vReflectivityColor",wt.Color3[0],1);const _=null!==(n=null===(s=this.subSurface)||void 0===s?void 0:s._indexOfRefraction)&&void 0!==n?n:1.5,m=1,g=Math.pow((_-m)/(_+m),2);this._metallicReflectanceColor.scaleToRef(g*this._metallicF0Factor,wt.Color3[0]),p.updateColor4("vMetallicReflectanceFactors",wt.Color3[0],this._metallicF0Factor)}else p.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);p.updateColor3("vEmissiveColor",pe.EmissiveTextureEnabled?this._emissiveColor:re.BlackReadOnly),p.updateColor3("vReflectionColor",this._reflectionColor),!c.SS_REFRACTION&&(null===(o=this.subSurface)||void 0===o?void 0:o._linkRefractionWithTransparency)?p.updateColor4("vAlbedoColor",this._albedoColor,1):p.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*l.environmentIntensity,this._lightingInfos.w=this._specularIntensity,p.updateVector4("vLightingIntensity",this._lightingInfos),l.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),p.updateColor3("vAmbientColor",this._globalAmbientColor),p.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}l.texturesEnabled&&(this._albedoTexture&&pe.DiffuseTextureEnabled&&p.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&pe.AmbientTextureEnabled&&p.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&pe.OpacityTextureEnabled&&p.setTexture("opacitySampler",this._opacityTexture),f&&pe.ReflectionTextureEnabled&&(c.LODBASEDMICROSFURACE?p.setTexture("reflectionSampler",f):(p.setTexture("reflectionSampler",f._lodTextureMid||f),p.setTexture("reflectionSamplerLow",f._lodTextureLow||f),p.setTexture("reflectionSamplerHigh",f._lodTextureHigh||f)),c.USEIRRADIANCEMAP&&p.setTexture("irradianceSampler",f.irradianceTexture)),c.ENVIRONMENTBRDF&&p.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&pe.EmissiveTextureEnabled&&p.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&pe.LightmapTextureEnabled&&p.setTexture("lightmapSampler",this._lightmapTexture),pe.SpecularTextureEnabled&&(this._metallicTexture?p.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&p.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&p.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&c.REFLECTANCE&&p.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&p.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&u.getCaps().standardDerivatives&&pe.BumpTextureEnabled&&!this._disableBumpMap&&p.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(h),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),fo(this._activeEffect,this,l),this.bindEyePosition(h)}else l.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(d||!this.isFrozen)&&(l.lightsEnabled&&!this._disableLighting&&ce.BindLights(l,t,this._activeEffect,c,this._maxSimultaneousLights),(l.fogEnabled&&t.applyFog&&l.fogMode!==ge.FOGMODE_NONE||f||t.receiveShadows||c.PREPASS)&&this.bindView(h),ce.BindFogParameters(l,t,this._activeEffect,!0),c.NUM_MORPH_INFLUENCERS&&ce.BindMorphTargetParameters(t,this._activeEffect),c.BAKED_VERTEX_ANIMATION_TEXTURE&&(null===(a=t.bakedVertexAnimationManager)||void 0===a||a.bind(h,c.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),ce.BindLogDepth(c,this._activeEffect,l)),this._afterBind(t,this._activeEffect),p.update()}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!(!super.hasTexture(e)&&this._albedoTexture!==e&&this._ambientTexture!==e&&this._opacityTexture!==e&&this._reflectionTexture!==e&&this._emissiveTexture!==e&&this._reflectivityTexture!==e&&this._metallicTexture!==e&&this._metallicReflectanceTexture!==e&&this._reflectanceTexture!==e&&this._microSurfaceTexture!==e&&this._bumpTexture!==e&&this._lightmapTexture!==e)}setPrePassRenderer(){var e;if(null===(e=this.subSurface)||void 0===e||!e.isScatteringEnabled)return!1;const t=this.getScene().enableSubSurfaceForPrePass();return t&&(t.enabled=!0),!0}dispose(e,t){var i,s,n,o,a,l,c,h,u,d,f,p;t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),null===(i=this._albedoTexture)||void 0===i||i.dispose(),null===(s=this._ambientTexture)||void 0===s||s.dispose(),null===(n=this._opacityTexture)||void 0===n||n.dispose(),null===(o=this._reflectionTexture)||void 0===o||o.dispose(),null===(a=this._emissiveTexture)||void 0===a||a.dispose(),null===(l=this._metallicTexture)||void 0===l||l.dispose(),null===(c=this._reflectivityTexture)||void 0===c||c.dispose(),null===(h=this._bumpTexture)||void 0===h||h.dispose(),null===(u=this._lightmapTexture)||void 0===u||u.dispose(),null===(d=this._metallicReflectanceTexture)||void 0===d||d.dispose(),null===(f=this._reflectanceTexture)||void 0===f||f.dispose(),null===(p=this._microSurfaceTexture)||void 0===p||p.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}}Vt.PBRMATERIAL_OPAQUE=ie.MATERIAL_OPAQUE,Vt.PBRMATERIAL_ALPHATEST=ie.MATERIAL_ALPHATEST,Vt.PBRMATERIAL_ALPHABLEND=ie.MATERIAL_ALPHABLEND,Vt.PBRMATERIAL_ALPHATESTANDBLEND=ie.MATERIAL_ALPHATESTANDBLEND,Vt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,Vt.LIGHTFALLOFF_PHYSICAL=0,Vt.LIGHTFALLOFF_GLTF=1,Vt.LIGHTFALLOFF_STANDARD=2,E([$F()],Vt.prototype,"_imageProcessingConfiguration",void 0),E([ne("_markAllSubMeshesAsMiscDirty")],Vt.prototype,"debugMode",void 0),E([I()],Vt.prototype,"useLogarithmicDepth",null);class Ee extends Vt{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===Vt.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?Vt.LIGHTFALLOFF_PHYSICAL:Vt.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===Vt.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?Vt.LIGHTFALLOFF_GLTF:Vt.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}constructor(e,t){super(e,t),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=Ee.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=re.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new re(0,0,0),this.albedoColor=new re(1,1,1),this.reflectivityColor=new re(1,1,1),this.reflectionColor=new re(1,1,1),this.emissiveColor=new re(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this._environmentBRDFTexture=$v(this.getScene())}getClassName(){return"PBRMaterial"}clone(e){const t=Ce.Clone(()=>new Ee(e,this.getScene()),this);return t.id=e,t.name=e,this.stencil.copyTo(t.stencil),this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),this.iridescence.copyTo(t.iridescence),t}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const s=Ce.Parse(()=>new Ee(e.name,t),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}function Kv(r){return r.charCodeAt(0)+(r.charCodeAt(1)<<8)+(r.charCodeAt(2)<<16)+(r.charCodeAt(3)<<24)}Ee.PBRMATERIAL_OPAQUE=Vt.PBRMATERIAL_OPAQUE,Ee.PBRMATERIAL_ALPHATEST=Vt.PBRMATERIAL_ALPHATEST,Ee.PBRMATERIAL_ALPHABLEND=Vt.PBRMATERIAL_ALPHABLEND,Ee.PBRMATERIAL_ALPHATESTANDBLEND=Vt.PBRMATERIAL_ALPHATESTANDBLEND,Ee.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=Vt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"directIntensity",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"emissiveIntensity",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"environmentIntensity",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"specularIntensity",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"disableBumpMap",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"albedoTexture",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"ambientTexture",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"ambientTextureStrength",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesAndMiscDirty")],Ee.prototype,"opacityTexture",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"reflectionTexture",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"emissiveTexture",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"reflectivityTexture",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"metallicTexture",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"metallic",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"roughness",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"metallicF0Factor",void 0),E([us(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"metallicReflectanceColor",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"metallicReflectanceTexture",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"reflectanceTexture",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"microSurfaceTexture",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"bumpTexture",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty",null)],Ee.prototype,"lightmapTexture",void 0),E([us("ambient"),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"ambientColor",void 0),E([us("albedo"),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"albedoColor",void 0),E([us("reflectivity"),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"reflectivityColor",void 0),E([us("reflection"),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"reflectionColor",void 0),E([us("emissive"),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"emissiveColor",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"microSurface",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useLightmapAsShadowmap",void 0),E([I(),ne("_markAllSubMeshesAsTexturesAndMiscDirty")],Ee.prototype,"useAlphaFromAlbedoTexture",void 0),E([I(),ne("_markAllSubMeshesAsTexturesAndMiscDirty")],Ee.prototype,"forceAlphaTest",void 0),E([I(),ne("_markAllSubMeshesAsTexturesAndMiscDirty")],Ee.prototype,"alphaCutOff",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useSpecularOverAlpha",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useRoughnessFromMetallicTextureGreen",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useMetallnessFromMetallicTextureBlue",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useAmbientInGrayScale",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),E([I()],Ee.prototype,"usePhysicalLightFalloff",null),E([I()],Ee.prototype,"useGLTFLightFalloff",null),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useRadianceOverAlpha",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useObjectSpaceNormalMap",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useParallax",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useParallaxOcclusion",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"parallaxScaleBias",void 0),E([I(),ne("_markAllSubMeshesAsLightsDirty")],Ee.prototype,"disableLighting",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"forceIrradianceInFragment",void 0),E([I(),ne("_markAllSubMeshesAsLightsDirty")],Ee.prototype,"maxSimultaneousLights",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"invertNormalMapX",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"invertNormalMapY",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"twoSidedLighting",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useAlphaFresnel",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useLinearAlphaFresnel",void 0),E([ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"environmentBRDFTexture",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"forceNormalForward",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"enableSpecularAntiAliasing",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useHorizonOcclusion",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useRadianceOcclusion",void 0),E([I(),ne("_markAllSubMeshesAsMiscDirty")],Ee.prototype,"unlit",void 0),le("BABYLON.PBRMaterial",Ee);const S3=Kv("DXT1"),E3=Kv("DXT3"),C3=Kv("DXT5"),SC=Kv("DX10");let Sh=(()=>{class r{static GetDDSInfo(t){const i=new Int32Array(t.buffer,t.byteOffset,31),s=new Int32Array(t.buffer,t.byteOffset,35);let n=1;131072&i[2]&&(n=Math.max(1,i[7]));const o=i[21],a=o===SC?s[32]:0;let l=0;switch(o){case 113:l=2;break;case 116:l=1;break;case SC:if(10===a){l=2;break}if(2===a){l=1;break}}return{width:i[4],height:i[3],mipmapCount:n,isFourCC:4==(4&i[20]),isRGB:64==(64&i[20]),isLuminance:131072==(131072&i[20]),isCube:512==(512&i[28]),isCompressed:o===S3||o===E3||o===C3,dxgiFormat:a,textureType:l}}static _GetHalfFloatAsFloatRGBAArrayBuffer(t,i,s,n,o,a){const l=new Float32Array(n),c=new Uint16Array(o,s);let h=0;for(let u=0;u<i;u++)for(let d=0;d<t;d++){const f=4*(d+u*t);l[h]=ga(c[f]),l[h+1]=ga(c[f+1]),l[h+2]=ga(c[f+2]),l[h+3]=r.StoreLODInAlphaChannel?a:ga(c[f+3]),h+=4}return l}static _GetHalfFloatRGBAArrayBuffer(t,i,s,n,o,a){if(r.StoreLODInAlphaChannel){const l=new Uint16Array(n),c=new Uint16Array(o,s);let h=0;for(let u=0;u<i;u++)for(let d=0;d<t;d++){const f=4*(d+u*t);l[h]=c[f],l[h+1]=c[f+1],l[h+2]=c[f+2],l[h+3]=ma(a),h+=4}return l}return new Uint16Array(o,s,n)}static _GetFloatRGBAArrayBuffer(t,i,s,n,o,a){if(r.StoreLODInAlphaChannel){const l=new Float32Array(n),c=new Float32Array(o,s);let h=0;for(let u=0;u<i;u++)for(let d=0;d<t;d++){const f=4*(d+u*t);l[h]=c[f],l[h+1]=c[f+1],l[h+2]=c[f+2],l[h+3]=a,h+=4}return l}return new Float32Array(o,s,n)}static _GetFloatAsHalfFloatRGBAArrayBuffer(t,i,s,n,o,a){const l=new Uint16Array(n),c=new Float32Array(o,s);let h=0;for(let u=0;u<i;u++)for(let d=0;d<t;d++)l[h]=ma(c[h]),l[h+1]=ma(c[h+1]),l[h+2]=ma(c[h+2]),l[h+3]=ma(r.StoreLODInAlphaChannel?a:c[h+3]),h+=4;return l}static _GetFloatAsUIntRGBAArrayBuffer(t,i,s,n,o,a){const l=new Uint8Array(n),c=new Float32Array(o,s);let h=0;for(let u=0;u<i;u++)for(let d=0;d<t;d++){const f=4*(d+u*t);l[h]=255*oe.Clamp(c[f]),l[h+1]=255*oe.Clamp(c[f+1]),l[h+2]=255*oe.Clamp(c[f+2]),l[h+3]=r.StoreLODInAlphaChannel?a:255*oe.Clamp(c[f+3]),h+=4}return l}static _GetHalfFloatAsUIntRGBAArrayBuffer(t,i,s,n,o,a){const l=new Uint8Array(n),c=new Uint16Array(o,s);let h=0;for(let u=0;u<i;u++)for(let d=0;d<t;d++){const f=4*(d+u*t);l[h]=255*oe.Clamp(ga(c[f])),l[h+1]=255*oe.Clamp(ga(c[f+1])),l[h+2]=255*oe.Clamp(ga(c[f+2])),l[h+3]=r.StoreLODInAlphaChannel?a:255*oe.Clamp(ga(c[f+3])),h+=4}return l}static _GetRGBAArrayBuffer(t,i,s,n,o,a,l,c,h){const u=new Uint8Array(n),d=new Uint8Array(o,s);let f=0;for(let p=0;p<i;p++)for(let _=0;_<t;_++){const m=4*(_+p*t);u[f]=d[m+a],u[f+1]=d[m+l],u[f+2]=d[m+c],u[f+3]=d[m+h],f+=4}return u}static _ExtractLongWordOrder(t){return 0===t||255===t||-16777216===t?0:1+r._ExtractLongWordOrder(t>>8)}static _GetRGBArrayBuffer(t,i,s,n,o,a,l,c){const h=new Uint8Array(n),u=new Uint8Array(o,s);let d=0;for(let f=0;f<i;f++)for(let p=0;p<t;p++){const _=3*(p+f*t);h[d]=u[_+a],h[d+1]=u[_+l],h[d+2]=u[_+c],d+=3}return h}static _GetLuminanceArrayBuffer(t,i,s,n,o){const a=new Uint8Array(n),l=new Uint8Array(o,s);let c=0;for(let h=0;h<i;h++)for(let u=0;u<t;u++)a[c]=l[u+h*t],c++;return a}static UploadDDSLevels(t,i,s,n,o,a,l=-1,c,h=!0){let u=null;n.sphericalPolynomial&&(u=new Array);const d=!!t.getCaps().s3tc;i.generateMipMaps=o;const f=new Int32Array(s.buffer,s.byteOffset,31);let p,_,m,b,y,T,x,g=0,S=0,C=1;if(542327876!==f[0])return void V.Error("Invalid magic number in DDS header");if(!n.isFourCC&&!n.isRGB&&!n.isLuminance)return void V.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");if(n.isCompressed&&!d)return void V.Error("Compressed textures are not supported on this platform.");let D=f[22];b=f[1]+4;let P=!1;if(n.isFourCC)switch(p=f[21],p){case S3:C=8,S=33777;break;case E3:C=16,S=33778;break;case C3:C=16,S=33779;break;case 113:P=!0,D=64;break;case 116:P=!0,D=128;break;case SC:{b+=20;let Q=!1;switch(n.dxgiFormat){case 10:P=!0,D=64,Q=!0;break;case 2:P=!0,D=128,Q=!0;break;case 88:n.isRGB=!0,n.isFourCC=!1,D=32,Q=!0}if(Q)break}default:return void console.error("Unsupported FourCC code:",function Tne(r){return String.fromCharCode(255&r,r>>8&255,r>>16&255,r>>24&255)}(p))}const M=r._ExtractLongWordOrder(f[23]),w=r._ExtractLongWordOrder(f[24]),k=r._ExtractLongWordOrder(f[25]),X=r._ExtractLongWordOrder(f[26]);P&&(S=t._getRGBABufferInternalSizedFormat(n.textureType)),T=1,131072&f[2]&&!1!==o&&(T=Math.max(1,f[7]));const te=c||0,J=t.getCaps();for(let Q=te;Q<a;Q++){for(_=f[4],m=f[3],x=0;x<T;++x){if(-1===l||l===x){const me=-1===l?x:0;if(!n.isCompressed&&n.isFourCC){i.format=5,g=_*m*4;let ae=null;if(t._badOS||t._badDesktopOS||!J.textureHalfFloat&&!J.textureFloat)128===D?(ae=r._GetFloatAsUIntRGBAArrayBuffer(_,m,s.byteOffset+b,g,s.buffer,me),u&&0==me&&u.push(r._GetFloatRGBAArrayBuffer(_,m,s.byteOffset+b,g,s.buffer,me))):64===D&&(ae=r._GetHalfFloatAsUIntRGBAArrayBuffer(_,m,s.byteOffset+b,g,s.buffer,me),u&&0==me&&u.push(r._GetHalfFloatAsFloatRGBAArrayBuffer(_,m,s.byteOffset+b,g,s.buffer,me))),i.type=0;else{const W=J.textureFloat&&(h&&J.textureFloatLinearFiltering||!h),K=J.textureHalfFloat&&(h&&J.textureHalfFloatLinearFiltering||!h),O=(128===D||64===D&&!K)&&W?1:(64===D||128===D&&!W)&&K?2:0;let H,Y=null;if(128===D)switch(O){case 1:H=r._GetFloatRGBAArrayBuffer,Y=null;break;case 2:H=r._GetFloatAsHalfFloatRGBAArrayBuffer,Y=r._GetFloatRGBAArrayBuffer;break;case 0:H=r._GetFloatAsUIntRGBAArrayBuffer,Y=r._GetFloatRGBAArrayBuffer}else switch(O){case 1:H=r._GetHalfFloatAsFloatRGBAArrayBuffer,Y=null;break;case 2:H=r._GetHalfFloatRGBAArrayBuffer,Y=r._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:H=r._GetHalfFloatAsUIntRGBAArrayBuffer,Y=r._GetHalfFloatAsFloatRGBAArrayBuffer}i.type=O,ae=H(_,m,s.byteOffset+b,g,s.buffer,me),u&&0==me&&u.push(Y?Y(_,m,s.byteOffset+b,g,s.buffer,me):ae)}ae&&t._uploadDataToTextureDirectly(i,ae,Q,me)}else if(n.isRGB)i.type=0,24===D?(i.format=4,g=_*m*3,y=r._GetRGBArrayBuffer(_,m,s.byteOffset+b,g,s.buffer,M,w,k),t._uploadDataToTextureDirectly(i,y,Q,me)):(i.format=5,g=_*m*4,y=r._GetRGBAArrayBuffer(_,m,s.byteOffset+b,g,s.buffer,M,w,k,X),t._uploadDataToTextureDirectly(i,y,Q,me));else if(n.isLuminance){const ae=t._getUnpackAlignement(),W=_;g=Math.floor((_+ae-1)/ae)*ae*(m-1)+W,y=r._GetLuminanceArrayBuffer(_,m,s.byteOffset+b,g,s.buffer),i.format=1,i.type=0,t._uploadDataToTextureDirectly(i,y,Q,me)}else g=Math.max(4,_)/4*Math.max(4,m)/4*C,y=new Uint8Array(s.buffer,s.byteOffset+b,g),i.type=0,t._uploadCompressedDataToTextureDirectly(i,S,_,m,y,Q,me)}b+=D?_*m*(D/8):g,_*=.5,m*=.5,_=Math.max(1,_),m=Math.max(1,m)}if(void 0!==c)break}n.sphericalPolynomial=u&&u.length>0?Fv.ConvertCubeMapToSphericalPolynomial({size:f[4],right:u[0],left:u[1],up:u[2],down:u[3],front:u[4],back:u[5],format:5,type:1,gammaSpace:!1}):void 0}}return r.StoreLODInAlphaChannel=!1,r})();we.prototype.createPrefilteredCubeTexture=function(r,e,t,i,s=null,n=null,o,a=null,l=!0){return this.createCubeTexture(r,e,null,!1,h=>{if(!h)return void(s&&s(null));const u=h.texture;if(l?h.info.sphericalPolynomial&&(u._sphericalPolynomial=h.info.sphericalPolynomial):u._sphericalPolynomial=new ll,u._source=Ye.CubePrefiltered,this.getCaps().textureLOD)return void(s&&s(u));const f=this._gl,p=h.width;if(!p)return;const _=[];for(let m=0;m<3;m++){const b=1-m/2,y=i,T=oe.Log2(p)*t+i,S=Math.round(Math.min(Math.max(y+(T-y)*b,0),T)),C=new zt(this,Ye.Temp);if(C.type=u.type,C.format=u.format,C.width=Math.pow(2,Math.max(oe.Log2(p)-S,0)),C.height=C.width,C.isCube=!0,C._cachedWrapU=0,C._cachedWrapV=0,this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,C,!0),C.samplingMode=2,f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MIN_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),h.isDDS){const P=h.info,M=h.data;this._unpackFlipY(P.isCompressed),Sh.UploadDDSLevels(this,C,M,P,!0,6,S)}else V.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,null);const D=new kt(e);D._isCube=!0,D._texture=C,C.isReady=!0,_.push(D)}u._lodTextureHigh=_[2],u._lodTextureMid=_[1],u._lodTextureLow=_[0],s&&s(u)},n,o,a,l,t,i)},ee._TextureLoaders.push(new class One{constructor(){this.supportCascades=!0}canLoad(e){return e.endsWith(".dds")}loadCubeData(e,t,i,s){const n=t.getEngine();let o,a=!1,l=1e3;if(Array.isArray(e))for(let c=0;c<e.length;c++){const h=e[c];o=Sh.GetDDSInfo(h),t.width=o.width,t.height=o.height,a=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&t.generateMipMaps,n._unpackFlipY(o.isCompressed),Sh.UploadDDSLevels(n,t,h,o,a,6,-1,c),o.isFourCC||1!==o.mipmapCount?l=o.mipmapCount-1:n.generateMipMapsForCubemap(t)}else{const c=e;o=Sh.GetDDSInfo(c),t.width=o.width,t.height=o.height,i&&(o.sphericalPolynomial=new ll),a=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&t.generateMipMaps,n._unpackFlipY(o.isCompressed),Sh.UploadDDSLevels(n,t,c,o,a,6),o.isFourCC||1!==o.mipmapCount?l=o.mipmapCount-1:n.generateMipMapsForCubemap(t,!1)}n._setCubeMapTextureParams(t,a,l),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s({isDDS:!0,width:t.width,info:o,data:e,texture:t})}loadData(e,t,i){const s=Sh.GetDDSInfo(e),n=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&t.generateMipMaps&&s.width>>s.mipmapCount-1==1;i(s.width,s.height,n,s.isFourCC,()=>{Sh.UploadDDSLevels(t.getEngine(),t,e,s,n,1)})}}),ee._TextureLoaders.push(new class Nne{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".env")}loadCubeData(e,t,i,s,n){if(Array.isArray(e))return;const o=aC(e);if(o){t.width=o.width,t.height=o.width;try{hC(t,o),function hV(r,e,t){const i=(t=Lv(t)).specular;return i?(r._lodGenerationScale=i.lodGenerationScale,Bv(r,cC(e,t),t.imageType)):Promise.resolve()}(t,e,o).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()},a=>{n?.("Can not upload environment levels",a)})}catch(a){n?.("Can not upload environment file",a)}}else n&&n("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}});let RC=(()=>{class r{constructor(t,i){if(this.data=t,this.isInvalid=!1,!r.IsValid(t))return this.isInvalid=!0,void V.Error("texture missing KTX identifier");const s=Uint32Array.BYTES_PER_ELEMENT,n=new DataView(this.data.buffer,this.data.byteOffset+12,13*s),a=67305985===n.getUint32(0,!0);return this.glType=n.getUint32(1*s,a),this.glTypeSize=n.getUint32(2*s,a),this.glFormat=n.getUint32(3*s,a),this.glInternalFormat=n.getUint32(4*s,a),this.glBaseInternalFormat=n.getUint32(5*s,a),this.pixelWidth=n.getUint32(6*s,a),this.pixelHeight=n.getUint32(7*s,a),this.pixelDepth=n.getUint32(8*s,a),this.numberOfArrayElements=n.getUint32(9*s,a),this.numberOfFaces=n.getUint32(10*s,a),this.numberOfMipmapLevels=n.getUint32(11*s,a),this.bytesOfKeyValueData=n.getUint32(12*s,a),0!==this.glType?(V.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(V.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(V.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==i?(V.Error("number of faces expected"+i+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=r.COMPRESSED_2D))}uploadLevels(t,i){this.loadType===r.COMPRESSED_2D&&this._upload2DCompressedLevels(t,i)}_upload2DCompressedLevels(t,i){let s=r.HEADER_LEN+this.bytesOfKeyValueData,n=this.pixelWidth,o=this.pixelHeight;const a=i?this.numberOfMipmapLevels:1;for(let l=0;l<a;l++){const c=new Int32Array(this.data.buffer,this.data.byteOffset+s,1)[0];s+=4;for(let h=0;h<this.numberOfFaces;h++){const u=new Uint8Array(this.data.buffer,this.data.byteOffset+s,c);t.getEngine()._uploadCompressedDataToTextureDirectly(t,t.format,n,o,u,h,l),s+=c,s+=3-(c+3)%4}n=Math.max(1,.5*n),o=Math.max(1,.5*o)}}static IsValid(t){if(t.byteLength>=12){const i=new Uint8Array(t.buffer,t.byteOffset,12);if(171===i[0]&&75===i[1]&&84===i[2]&&88===i[3]&&32===i[4]&&49===i[5]&&49===i[6]&&187===i[7]&&13===i[8]&&10===i[9]&&26===i[10]&&10===i[11])return!0}return!1}}return r.HEADER_LEN=64,r.COMPRESSED_2D=0,r.COMPRESSED_3D=1,r.TEX_2D=2,r.TEX_3D=3,r})(),N3=(()=>{class r extends class Fne{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map(t=>({workerPromise:Promise.resolve(t),idle:!0}))}dispose(){for(const e of this._workerInfos)e.workerPromise.then(t=>{t.terminate()});this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(const t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then(i=>{t(i,()=>{const s=this._pendingActions.shift();s?this._execute(e,s):e.idle=!0})})}}{constructor(t,i,s=r.DefaultOptions){super([]),this._maxWorkers=t,this._createWorkerAsync=i,this._options=s}push(t){if(!this._executeOnIdleWorker(t))if(this._workerInfos.length<this._maxWorkers){const i={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(i),this._execute(i,t)}else this._pendingActions.push(t)}_execute(t,i){t.timeoutId&&(clearTimeout(t.timeoutId),delete t.timeoutId),super._execute(t,(s,n)=>{i(s,()=>{n(),t.idle&&(t.timeoutId=setTimeout(()=>{t.workerPromise.then(a=>{a.terminate()});const o=this._workerInfos.indexOf(t);-1!==o&&this._workerInfos.splice(o,1)},this._options.idleTimeElapsedBeforeRelease))})})}}return r.DefaultOptions={idleTimeElapsedBeforeRelease:1e3},r})();var id=(()=>{return(r=id||(id={}))[r.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",r[r.BC7_RGBA=1]="BC7_RGBA",r[r.BC3_RGBA=2]="BC3_RGBA",r[r.BC1_RGB=3]="BC1_RGB",r[r.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",r[r.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",r[r.ETC2_RGBA=6]="ETC2_RGBA",r[r.ETC1_RGB=7]="ETC1_RGB",r[r.RGBA32=8]="RGBA32",r[r.R8=9]="R8",r[r.RG8=10]="RG8",id;var r})(),Qv=(()=>{return(r=Qv||(Qv={}))[r.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",r[r.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",r[r.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",r[r.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",r[r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",r[r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",r[r.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",r[r.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",r[r.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",r[r.RGBA8Format=32856]="RGBA8Format",r[r.R8Format=33321]="R8Format",r[r.RG8Format=33323]="RG8Format",Qv;var r})();function gl(r){return r?q.GetAbsoluteUrl(r):null}function IC(r){null!==r.wasmUASTCToASTC&&(KTX2DECODER.LiteTranscoder_UASTC_ASTC.WasmModuleURL=r.wasmUASTCToASTC),null!==r.wasmUASTCToBC7&&(KTX2DECODER.LiteTranscoder_UASTC_BC7.WasmModuleURL=r.wasmUASTCToBC7),null!==r.wasmUASTCToRGBA_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=r.wasmUASTCToRGBA_UNORM),null!==r.wasmUASTCToRGBA_SRGB&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=r.wasmUASTCToRGBA_SRGB),null!==r.wasmUASTCToR8_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=r.wasmUASTCToR8_UNORM),null!==r.wasmUASTCToRG8_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=r.wasmUASTCToRG8_UNORM),null!==r.jsMSCTranscoder&&(KTX2DECODER.MSCTranscoder.JSModuleURL=r.jsMSCTranscoder),null!==r.wasmMSCTranscoder&&(KTX2DECODER.MSCTranscoder.WasmModuleURL=r.wasmMSCTranscoder),null!==r.wasmZSTDDecoder&&(KTX2DECODER.ZSTDDecoder.WasmModuleURL=r.wasmZSTDDecoder)}class Fs{static GetDefaultNumWorkers(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(e){if(Fs._WorkerPoolPromise||Fs._DecoderModulePromise)return;const t={jsDecoderModule:q.GetAbsoluteUrl(this.URLConfig.jsDecoderModule),wasmUASTCToASTC:gl(this.URLConfig.wasmUASTCToASTC),wasmUASTCToBC7:gl(this.URLConfig.wasmUASTCToBC7),wasmUASTCToRGBA_UNORM:gl(this.URLConfig.wasmUASTCToRGBA_UNORM),wasmUASTCToRGBA_SRGB:gl(this.URLConfig.wasmUASTCToRGBA_SRGB),wasmUASTCToR8_UNORM:gl(this.URLConfig.wasmUASTCToR8_UNORM),wasmUASTCToRG8_UNORM:gl(this.URLConfig.wasmUASTCToRG8_UNORM),jsMSCTranscoder:gl(this.URLConfig.jsMSCTranscoder),wasmMSCTranscoder:gl(this.URLConfig.wasmMSCTranscoder),wasmZSTDDecoder:gl(this.URLConfig.wasmZSTDDecoder)};e&&"function"==typeof Worker&&typeof URL<"u"?Fs._WorkerPoolPromise=new Promise(i=>{const n=URL.createObjectURL(new Blob([`${IC}(${Bne})()`],{type:"application/javascript"}));i(new N3(e,()=>new Promise((o,a)=>{const l=new Worker(n),c=u=>{l.removeEventListener("error",c),l.removeEventListener("message",h),a(u)},h=u=>{"init"===u.data.action&&(l.removeEventListener("error",c),l.removeEventListener("message",h),o(l))};l.addEventListener("error",c),l.addEventListener("message",h),l.postMessage({action:"init",urls:t})})))}):typeof KTX2DECODER>"u"?Fs._DecoderModulePromise=q.LoadScriptAsync(t.jsDecoderModule).then(()=>(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,IC(t),new KTX2DECODER.KTX2Decoder)):(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,Fs._DecoderModulePromise=Promise.resolve(new KTX2DECODER.KTX2Decoder))}constructor(e,t=Fs.DefaultNumWorkers){this._engine=e,Fs._Initialize(t)}uploadAsync(e,t,i){const s=this._engine.getCaps(),n={astc:!!s.astc,bptc:!!s.bptc,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,etc1:!!s.etc1};if(Fs._WorkerPoolPromise)return Fs._WorkerPoolPromise.then(o=>new Promise((a,l)=>{o.push((c,h)=>{const u=p=>{c.removeEventListener("error",u),c.removeEventListener("message",d),l(p),h()},d=p=>{if("decoded"===p.data.action){if(c.removeEventListener("error",u),c.removeEventListener("message",d),p.data.success)try{this._createTexture(p.data.decodedData,t,i),a()}catch(_){l({message:_})}else l({message:p.data.msg});h()}};c.addEventListener("error",u),c.addEventListener("message",d),c.postMessage({action:"setDefaultDecoderOptions",options:Fs.DefaultDecoderOptions._getKTX2DecoderOptions()});const f=new Uint8Array(e.byteLength);f.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),c.postMessage({action:"decode",data:f,caps:n,options:i},[f.buffer])})}));if(Fs._DecoderModulePromise)return Fs._DecoderModulePromise.then(o=>(Fs.DefaultDecoderOptions.isDirty&&(KTX2DECODER.KTX2Decoder.DefaultDecoderOptions=Fs.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise((a,l)=>{o.decode(e,s).then(c=>{this._createTexture(c,t),a()}).catch(c=>{l({message:c})})})));throw new Error("KTX2 decoder module is not available")}_createTexture(e,t,i){this._engine._bindTextureDirectly(3553,t),i&&(i.transcodedFormat=e.transcodedFormat,i.isInGammaSpace=e.isInGammaSpace,i.hasAlpha=e.hasAlpha,i.transcoderName=e.transcoderName);let n=!0;switch(e.transcodedFormat){case 32856:t.type=0,t.format=5;break;case 33321:t.type=0,t.format=6;break;case 33323:t.type=0,t.format=7;break;default:t.format=e.transcodedFormat,n=!1}if(t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let o=0;o<e.mipmaps.length;++o){const a=e.mipmaps[o];if(!a||!a.data)throw new Error("KTX2 container - could not transcode one of the image");n?(t.width=a.width,t.height=a.height,this._engine._uploadDataToTextureDirectly(t,a.data,0,o,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,a.width,a.height,a.data,0,o)}t._extension=".ktx2",t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,t.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}}function Bne(){let r;onmessage=e=>{if(e.data)switch(e.data.action){case"init":{const t=e.data.urls;importScripts(t.jsDecoderModule),IC(t),r=new KTX2DECODER.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":KTX2DECODER.KTX2Decoder.DefaultDecoderOptions=e.data.options;break;case"decode":r.decode(e.data.data,e.data.caps,e.data.options).then(t=>{const i=[];for(let s=0;s<t.mipmaps.length;++s){const n=t.mipmaps[s];n&&n.data&&i.push(n.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:t},i)}).catch(t=>{postMessage({action:"decoded",success:!1,msg:t})})}}}Fs.URLConfig={jsDecoderModule:"https://preview.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},Fs.DefaultNumWorkers=Fs.GetDefaultNumWorkers(),Fs.DefaultDecoderOptions=new class Lne{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const e={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[id.BC1_RGB,id.BC3_RGBA],yes:{transcodeFormat:id.RGBA32,engineFormat:Qv.RGBA8Format,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=e,e}},ee._TextureLoaders.unshift(new class Une{constructor(){this.supportCascades=!1}canLoad(e,t){return e.endsWith(".ktx")||e.endsWith(".ktx2")||"image/ktx"===t||"image/ktx2"===t}loadCubeData(e,t,i,s){if(Array.isArray(e))return;t._invertVScale=!t.invertY;const n=t.getEngine(),o=new RC(e,6),a=o.numberOfMipmapLevels>1&&t.generateMipMaps;n._unpackFlipY(!0),o.uploadLevels(t,t.generateMipMaps),t.width=o.pixelWidth,t.height=o.pixelHeight,n._setCubeMapTextureParams(t,a,o.numberOfMipmapLevels-1),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()}loadData(e,t,i,s){if(RC.IsValid(e)){t._invertVScale=!t.invertY;const n=new RC(e,1),o=function Vne(r){switch(r){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(n.glInternalFormat);o?(t.format=o,t._useSRGBBuffer=t.getEngine()._getUseSRGBBuffer(!0,t.generateMipMaps),t._gammaSpace=!0):t.format=n.glInternalFormat,i(n.pixelWidth,n.pixelHeight,t.generateMipMaps,!0,()=>{n.uploadLevels(t,t.generateMipMaps)},n.isInvalid)}else Fs.IsValid(e)?new Fs(t.getEngine()).uploadAsync(e,t,s).then(()=>{i(t.width,t.height,t.generateMipMaps,!0,()=>{},!1)},o=>{V.Warn(`Failed to load KTX2 texture data: ${o.message}`),i(0,0,!1,!1,()=>{},!0)}):(V.Error("texture missing KTX identifier"),i(0,0,!1,!1,()=>{},!0))}});class kp extends lr{constructor(e,t,i){super(e,v.Zero(),t),this._xrSessionManager=i,this._firstFrame=!1,this._referenceQuaternion=Z.Identity(),this._referencedPosition=new v,this._trackingState=mh.NOT_TRACKING,this.onBeforeCameraTeleport=new z,this.onAfterCameraTeleport=new z,this.onTrackingStateChanged=new z,this.compensateOnFirstFrame=!0,this._rotate180=new Z(0,1,0,0),this.minZ=.1,this.rotationQuaternion=new Z,this.cameraRigMode=ve.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this._updateNumberOfRigCameras(1),this.freezeProjectionMatrix(),this._xrSessionManager.onXRSessionInit.add(()=>{this._referencedPosition.copyFromFloats(0,0,0),this._referenceQuaternion.copyFromFloats(0,0,0,1),this._firstFrame=this.compensateOnFirstFrame}),this._xrSessionManager.onXRFrameObservable.add(()=>{this._firstFrame&&this._updateFromXRSession(),this._updateReferenceSpace(),this._updateFromXRSession()},void 0,!0)}get trackingState(){return this._trackingState}_setTrackingState(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))}get realWorldHeight(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y:0}_updateForDualEyeDebugging(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new qr(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new qr(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(e=this.getScene().activeCamera,t=!0){e&&e!==this&&(e.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,Z.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,t&&this._xrSessionManager.resetReferenceSpace())}getClassName(){return"WebXRCamera"}setTarget(e){const t=L.Vector3[1];e.subtractToRef(this.position,t),t.y=0,t.normalize();const i=Math.atan2(t.x,t.z);this.rotationQuaternion.toEulerAnglesToRef(t),Z.FromEulerAnglesToRef(t.x,i,t.z,this.rotationQuaternion)}dispose(){super.dispose(),this._lastXRViewerPose=void 0}_updateFromXRSession(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=e||void 0,e){if(this._setTrackingState(e.emulatedPosition?mh.TRACKING_LOST:mh.TRACKING),(this.minZ!==this._cache.minZ||this.maxZ!==this._cache.maxZ)&&(this._xrSessionManager.updateRenderState({depthFar:this.maxZ||1e4,depthNear:this.minZ}),this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ),e.transform){const i=e.transform.orientation;if(void 0===e.transform.orientation.x)return;const s=e.transform.position;this._referencedPosition.set(s.x,s.y,s.z),this._referenceQuaternion.set(i.x,i.y,i.z,i.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length),e.views.forEach((i,s)=>{var n;const o=this.rigCameras[s];!o.isLeftCamera&&!o.isRightCamera&&("right"===i.eye?o._isRightCamera=!0:"left"===i.eye&&(o._isLeftCamera=!0));const a=i.transform.position,l=i.transform.orientation;o.parent=this.parent,o.position.set(a.x,a.y,a.z),o.rotationQuaternion.set(l.x,l.y,l.z,l.w),this._scene.useRightHandedSystem?o.rotationQuaternion.multiplyInPlace(this._rotate180):(o.position.z*=-1,o.rotationQuaternion.z*=-1,o.rotationQuaternion.w*=-1),F.FromFloat32ArrayToRefScaled(i.projectionMatrix,0,1,o._projectionMatrix),this._scene.useRightHandedSystem||o._projectionMatrix.toggleProjectionMatrixHandInPlace(),0===s&&this._projectionMatrix.copyFrom(o._projectionMatrix);const c=this._xrSessionManager.getRenderTargetTextureForView(i);this._renderingMultiview=(null===(n=c?._texture)||void 0===n?void 0:n.isMultiview)||!1,this._renderingMultiview?0==s&&(this._xrSessionManager.trySetViewportForView(this.viewport,i),this.outputRenderTarget=c):(this._xrSessionManager.trySetViewportForView(o.viewport,i),o.outputRenderTarget=c||this._xrSessionManager.getRenderTargetTextureForView(i)),o.layerMask=this.layerMask})}else this._setTrackingState(mh.NOT_TRACKING)}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){const t=new Gi("XR-RigCamera: "+this.rigCameras.length,v.Zero(),this.getScene());t.minZ=.1,t.rotationQuaternion=new Z,t.updateUpVectorFromRotation=!0,t.isRigCamera=!0,t.rigParent=this,t.freezeProjectionMatrix(),this.rigCameras.push(t)}for(;this.rigCameras.length>e;){const t=this.rigCameras.pop();t&&t.dispose()}}_updateReferenceSpace(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){const e=L.Matrix[0],t=L.Matrix[1],i=L.Matrix[2];F.ComposeToRef(kp._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),F.ComposeToRef(kp._ScaleReadOnly,this.rotationQuaternion,this.position,t),e.invert().multiplyToRef(t,i),i.invert(),this._scene.useRightHandedSystem||i.toggleModelMatrixHandInPlace(),i.decompose(void 0,this._referenceQuaternion,this._referencedPosition);const s=new XRRigidTransform({x:this._referencedPosition.x,y:this._referencedPosition.y,z:this._referencedPosition.z},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(s)}}}kp._ScaleReadOnly=v.One();class MC{constructor(e){this._scene=e,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this._lastTimestamp=0,this.onInitialXRPoseSetObservable=new z,this.onStateChangedObservable=new z,this.state=rs.NOT_IN_XR,this.sessionManager=new Iv(e),this.camera=new kp("webxr",e,this.sessionManager),this.featuresManager=new Ai(this.sessionManager),e.onDisposeObservable.addOnce(()=>{this.dispose()})}static CreateAsync(e){const t=new MC(e);return t.sessionManager.initializeAsync().then(()=>(t._supported=!0,t)).catch(i=>{throw t._setState(rs.NOT_IN_XR),t.dispose(),i})}dispose(){var e;this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),null===(e=this._spectatorCamera)||void 0===e||e.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)}enterXRAsync(e,t,i=this.sessionManager.getWebXRRenderTarget(),s={}){var n=this;return Qt(function*(){var o,a,l;if(!n._supported)throw"WebXR not supported in this browser or environment";n._setState(rs.ENTERING_XR),"viewer"!==t&&"local"!==t&&(s.optionalFeatures=s.optionalFeatures||[],s.optionalFeatures.push(t)),s=yield n.featuresManager._extendXRSessionInitObject(s),"immersive-ar"===e&&"unbounded"!==t&&V.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{yield n.sessionManager.initializeSessionAsync(e,s),yield n.sessionManager.setReferenceSpaceTypeAsync(t);const c=yield i.initializeXRLayerAsync(n.sessionManager.session),h={depthFar:n.camera.maxZ||1e4,depthNear:n.camera.minZ};return n.featuresManager.getEnabledFeature(Ki.LAYERS)||(h.baseLayer=c),n.sessionManager.updateRenderState(h),n.sessionManager.runXRRenderLoop(),n._originalSceneAutoClear=n._scene.autoClear,n._nonVRCamera=n._scene.activeCamera,n._attachedToElement=!(null===(a=null===(o=n._nonVRCamera)||void 0===o?void 0:o.inputs)||void 0===a||!a.attachedToElement),null===(l=n._nonVRCamera)||void 0===l||l.detachControl(),n._scene.activeCamera=n.camera,"immersive-ar"!==e?n._nonXRToXRCamera():(n._scene.autoClear=!1,n.camera.compensateOnFirstFrame=!1,n.camera.position.set(0,0,0),n.camera.rotationQuaternion.set(0,0,0,1)),n.sessionManager.onXRSessionEnded.addOnce(()=>{n.state!==rs.EXITING_XR&&n._setState(rs.EXITING_XR),n.camera.rigCameras.forEach(u=>{u.outputRenderTarget=null}),n._scene.autoClear=n._originalSceneAutoClear,n._scene.activeCamera=n._nonVRCamera,n._attachedToElement&&n._nonVRCamera&&n._nonVRCamera.attachControl(!!n._nonVRCamera.inputs.noPreventDefault),"immersive-ar"!==e&&n.camera.compensateOnFirstFrame&&(n._nonVRCamera.setPosition?n._nonVRCamera.setPosition(n.camera.position):n._nonVRCamera.position.copyFrom(n.camera.position)),n._setState(rs.NOT_IN_XR)}),n.sessionManager.onXRFrameObservable.addOnce(()=>{n._setState(rs.IN_XR)}),n.sessionManager}catch(c){throw console.log(c),console.log(c.message),n._setState(rs.NOT_IN_XR),c}})()}exitXRAsync(){return this.state!==rs.IN_XR?Promise.resolve():(this._setState(rs.EXITING_XR),this.sessionManager.exitXRAsync())}enableSpectatorMode(e){this._spectatorMode||(this._spectatorMode=!0,this._switchSpectatorMode(e))}disableSpecatatorMode(){this._spectatorMode&&(this._spectatorMode=!1,this._switchSpectatorMode())}_switchSpectatorMode(e){const i=1/(e?.fps?e.fps:1e3)*1e3,s=e?.preferredCameraIndex?e?.preferredCameraIndex:0,n=()=>{this._spectatorCamera&&this.sessionManager.currentTimestamp-this._lastTimestamp>=i&&(this._lastTimestamp=this.sessionManager.currentTimestamp,this._spectatorCamera.position.copyFrom(this.camera.rigCameras[s].globalPosition),this._spectatorCamera.rotationQuaternion.copyFrom(this.camera.rigCameras[s].absoluteRotation))};if(this._spectatorMode){if(s>=this.camera.rigCameras.length)throw new Error("the preferred camera index is beyond the length of rig camera array.");const o=()=>{this.state===rs.IN_XR?(this._spectatorCamera=new qu("webxr-spectator",v.Zero(),this._scene),this._spectatorCamera.rotationQuaternion=new Z,this._scene.activeCameras=[this.camera,this._spectatorCamera],this.sessionManager.onXRFrameObservable.add(n),this._scene.onAfterRenderCameraObservable.add(a=>{a===this.camera&&(this._scene.getEngine().framebufferDimensionsObject=null)})):this.state===rs.EXITING_XR&&(this.sessionManager.onXRFrameObservable.removeCallback(n),this._scene.activeCameras=null)};this.onStateChangedObservable.add(o),o()}else this.sessionManager.onXRFrameObservable.removeCallback(n),this._scene.activeCameras=[this.camera]}_nonXRToXRCamera(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}_setState(e){this.state!==e&&(this.state=e,this.onStateChangedObservable.notifyObservers(this.state))}}let vl=(()=>{class r{constructor(t,i,s=-1,n=[]){this.id=t,this.type=i,this._buttonIndex=s,this._axesIndices=n,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new z,this.onButtonStateChangedObservable=new z}get axes(){return this._axes}get changes(){return this._changes}get hasChanges(){return this._hasChanges}get pressed(){return this._pressed}get touched(){return this._touched}get value(){return this._currentValue}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return 0!==this._axesIndices.length}isButton(){return-1!==this._buttonIndex}update(t){let i=!1,s=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){const n=t.buttons[this._buttonIndex];if(!n)return;this._currentValue!==n.value&&(this.changes.value={current:n.value,previous:this._currentValue},i=!0,this._currentValue=n.value),this._touched!==n.touched&&(this.changes.touched={current:n.touched,previous:this._touched},i=!0,this._touched=n.touched),this._pressed!==n.pressed&&(this.changes.pressed={current:n.pressed,previous:this._pressed},i=!0,this._pressed=n.pressed)}this.isAxes()&&(this._axes.x!==t.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:t.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=t.axes[this._axesIndices[0]],s=!0),this._axes.y!==t.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=t.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:t.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=t.axes[this._axesIndices[1]],s=!0)),i&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),s&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))}}return r.BUTTON_TYPE="button",r.SQUEEZE_TYPE="squeeze",r.THUMBSTICK_TYPE="thumbstick",r.TOUCHPAD_TYPE="touchpad",r.TRIGGER_TYPE="trigger",r})();class sd{constructor(e,t,i,s,n=!1,o){this.scene=e,this.layout=t,this.gamepadObject=i,this.handedness=s,this._doNotLoadControllerMesh=n,this._controllerCache=o,this._initComponent=a=>{if(!a)return;const l=this.layout.components[a],c=l.type,h=l.gamepadIndices.button,u=[];void 0!==l.gamepadIndices.xAxis&&void 0!==l.gamepadIndices.yAxis&&u.push(l.gamepadIndices.xAxis,l.gamepadIndices.yAxis),this.components[a]=new vl(a,c,h,u)},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new z,t.components&&Object.keys(t.components).forEach(this._initComponent)}dispose(){this.getComponentIds().forEach(e=>this.getComponent(e).dispose()),this.rootMesh&&(this.rootMesh.getChildren(void 0,!0).forEach(e=>{e.setEnabled(!1)}),this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache))}getAllComponentsOfType(e){return this.getComponentIds().map(t=>this.components[t]).filter(t=>t.type===e)}getComponent(e){return this.components[e]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(e){return this.getAllComponentsOfType(e)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}loadModel(){var e=this;return Qt(function*(){const t=!e._getModelLoadingConstraints();let i=e._getGenericFilenameAndPath();return t?V.Warn("Falling back to generic models"):i=e._getFilenameAndPath(),new Promise((s,n)=>{const o=a=>{t?e._getGenericParentMesh(a):e._setRootMesh(a),e._processLoadedModel(a),e._modelReady=!0,e.onModelLoadedObservable.notifyObservers(e),s(!0)};if(e._controllerCache){const a=e._controllerCache.filter(l=>l.filename===i.filename&&l.path===i.path);if(a[0])return a[0].meshes.forEach(l=>l.setEnabled(!0)),void o(a[0].meshes)}ke.ImportMesh("",i.path,i.filename,e.scene,a=>{e._controllerCache&&e._controllerCache.push({...i,meshes:a}),o(a)},null,(a,l)=>{V.Log(l),V.Warn(`Failed to retrieve controller model of type ${e.profileId} from the remote server: ${i.path}${i.filename}`),n(l)})})})()}updateFromXRFrame(e){this.getComponentIds().forEach(t=>this.getComponent(t).update(this.gamepadObject)),this.updateModel(e)}get handness(){return this.handedness}pulse(e,t,i=0){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[i]?this.gamepadObject.hapticActuators[i].pulse(e,t):Promise.resolve(!1)}_getChildByName(e,t){return e.getChildren(i=>i.name===t,!1)[0]}_getImmediateChildByName(e,t){return e.getChildren(i=>i.name==t,!0)[0]}_lerpTransform(e,t,i){if(!(e.minMesh&&e.maxMesh&&e.valueMesh&&e.minMesh.rotationQuaternion&&e.maxMesh.rotationQuaternion&&e.valueMesh.rotationQuaternion))return;const s=i?.5*t+.5:t;Z.SlerpToRef(e.minMesh.rotationQuaternion,e.maxMesh.rotationQuaternion,s,e.valueMesh.rotationQuaternion),v.LerpToRef(e.minMesh.position,e.maxMesh.position,s,e.valueMesh.position)}updateModel(e){!this._modelReady||this._updateModel(e)}_getGenericFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getGenericParentMesh(e){this.rootMesh=new G(this.profileId+" "+this.handedness,this.scene),e.forEach(t=>{t.parent||(t.isPickable=!1,t.setParent(this.rootMesh))}),this.rootMesh.rotationQuaternion=Z.FromEulerAngles(0,Math.PI,0)}}let F3=(()=>{class r extends sd{constructor(t,i,s){super(t,kne[s],i,s),this.profileId=r.ProfileId}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(t){}_setRootMesh(t){this.rootMesh=new G(this.profileId+" "+this.handedness,this.scene),t.forEach(i=>{i.isPickable=!1,i.parent||i.setParent(this.rootMesh)}),this.rootMesh.rotationQuaternion=Z.FromEulerAngles(0,Math.PI,0)}_updateModel(){}}return r.ProfileId="generic-trigger",r})();const kne={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};class Gne extends sd{constructor(e,t,i,s,n){super(e,i.layouts[t.handedness||"none"],t.gamepad,t.handedness,void 0,n),this._repositoryUrl=s,this.controllerCache=n,this._buttonMeshMapping={},this._touchDots={},this.profileId=i.profileId}dispose(){super.dispose(),this.controllerCache||Object.keys(this._touchDots).forEach(e=>{this._touchDots[e].dispose()})}_getFilenameAndPath(){return{filename:this.layout.assetPath,path:`${this._repositoryUrl}/profiles/${this.profileId}/`}}_getModelLoadingConstraints(){const e=ke.IsPluginForExtensionAvailable(".glb");return e||V.Warn("glTF / glb loader was not registered, using generic controller instead"),e}_processLoadedModel(e){this.getComponentIds().forEach(t=>{const i=this.layout.components[t];this._buttonMeshMapping[t]={mainMesh:this._getChildByName(this.rootMesh,i.rootNodeName),states:{}},Object.keys(i.visualResponses).forEach(s=>{const n=i.visualResponses[s];if("transform"===n.valueNodeProperty)this._buttonMeshMapping[t].states[s]={valueMesh:this._getChildByName(this.rootMesh,n.valueNodeName),minMesh:this._getChildByName(this.rootMesh,n.minNodeName),maxMesh:this._getChildByName(this.rootMesh,n.maxNodeName)};else if(this._buttonMeshMapping[t].states[s]={valueMesh:this._getChildByName(this.rootMesh,i.type===vl.TOUCHPAD_TYPE&&i.touchPointNodeName?i.touchPointNodeName:n.valueNodeName)},i.type===vl.TOUCHPAD_TYPE&&!this._touchDots[s]){const a=po(s+"dot",{diameter:.0015,segments:8},this.scene);a.material=new fe(s+"mat",this.scene),a.material.diffuseColor=re.Red(),a.parent=this._buttonMeshMapping[t].states[s].valueMesh||null,a.isVisible=!1,this._touchDots[s]=a}})})}_setRootMesh(e){let t;this.rootMesh=new G(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(let i=0;i<e.length;i++){const s=e[i];s.isPickable=!1,s.parent||(t=s)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(fs.Y,Math.PI,$e.WORLD)}_updateModel(e){this.disableAnimation||this.getComponentIds().forEach(t=>{const i=this.getComponent(t);if(!i.hasChanges)return;const s=this._buttonMeshMapping[t],n=this.layout.components[t];Object.keys(n.visualResponses).forEach(o=>{const a=n.visualResponses[o];let l=i.value;if("xAxis"===a.componentProperty?l=i.axes.x:"yAxis"===a.componentProperty&&(l=i.axes.y),"transform"===a.valueNodeProperty)this._lerpTransform(s.states[o],l,"button"!==a.componentProperty);else{const c=s.states[o].valueMesh;c&&(c.isVisible=i.touched||i.pressed),this._touchDots[o]&&(this._touchDots[o].isVisible=i.touched||i.pressed)}})})}}const PC=[];let nn=(()=>{class r{static ClearProfilesCache(){this._ProfilesList=null,this._ProfileLoadingPromises={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"])}static FindFallbackWithProfileId(t){const i=this._Fallbacks[t]||[];return i.unshift(t),i}static GetMotionControllerWithXRInput(t,i,s){const n=[];s&&n.push(s),n.push(...t.profiles||[]),n.length&&!n[0]&&n.pop(),t.gamepad&&t.gamepad.id&&t.gamepad.id===(t.gamepad.id.match(/oculus touch/gi)?t.gamepad.id:void 0)&&n.push("oculus-touch-v2");const o=n.indexOf("windows-mixed-reality");if(-1!==o&&n.splice(o,0,"microsoft-mixed-reality"),n.length||n.push("generic-trigger"),this.UseOnlineRepository){const l=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllers:this._LoadProfileFromRepository;return(this.PrioritizeOnlineRepository?this._LoadProfileFromRepository:this._LoadProfilesFromAvailableControllers).call(this,n,t,i).catch(()=>l.call(this,n,t,i))}return this._LoadProfilesFromAvailableControllers(n,t,i)}static RegisterController(t,i){this._AvailableControllers[t]=i}static RegisterFallbacksForProfileId(t,i){this._Fallbacks[t]?this._Fallbacks[t].push(...i):this._Fallbacks[t]=i}static UpdateProfilesList(){return this._ProfilesList=q.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then(t=>JSON.parse(t.toString())),this._ProfilesList}static ClearControllerCache(){PC.forEach(t=>{t.meshes.forEach(i=>{i.dispose(!1,!0)})}),PC.length=0}static _LoadProfileFromRepository(t,i,s){return Promise.resolve().then(()=>this._ProfilesList?this._ProfilesList:this.UpdateProfilesList()).then(n=>{for(let o=0;o<t.length;++o)if(t[o]&&n[t[o]])return t[o];throw new Error(`neither controller ${t[0]} nor all fallbacks were found in the repository,`)}).then(n=>(this._ProfileLoadingPromises[n]||(this._ProfileLoadingPromises[n]=q.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${n}/profile.json`,!1).then(o=>JSON.parse(o))),this._ProfileLoadingPromises[n])).then(n=>new Gne(s,i,n,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:PC))}static _LoadProfilesFromAvailableControllers(t,i,s){for(let n=0;n<t.length;++n){if(!t[n])continue;const o=this.FindFallbackWithProfileId(t[n]);for(let a=0;a<o.length;++a){const l=this._AvailableControllers[o[a]];if(l)return Promise.resolve(l(i,s))}}throw new Error("no controller requested was found in the available controllers list")}}return r._AvailableControllers={},r._Fallbacks={},r._ProfileLoadingPromises={},r.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist",r.PrioritizeOnlineRepository=!0,r.UseOnlineRepository=!0,r.DisableControllerCache=!0,r})();nn.RegisterController(F3.ProfileId,(r,e)=>new F3(e,r.gamepad,r.handedness)),nn.DefaultFallbacks();let zne=0;class Hne{constructor(e,t,i={}){this._scene=e,this.inputSource=t,this._options=i,this._tmpVector=new v,this._disposed=!1,this.onDisposeObservable=new z,this.onMeshLoadedObservable=new z,this.onMotionControllerInitObservable=new z,this._uniqueId=`controller-${zne++}-${t.targetRayMode}-${t.handedness}`,this.pointer=new Zt(`${this._uniqueId}-pointer`,e),this.pointer.rotationQuaternion=new Z,this.inputSource.gripSpace&&(this.grip=new Zt(`${this._uniqueId}-grip`,this._scene),this.grip.rotationQuaternion=new Z),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&"tracked-pointer"===this.inputSource.targetRayMode&&nn.GetMotionControllerWithXRInput(t,e,this._options.forceControllerProfile).then(s=>{this.motionController=s,this.onMotionControllerInitObservable.notifyObservers(s),!this._options.doNotLoadControllerMesh&&!this.motionController._doNotLoadControllerMesh&&this.motionController.loadModel().then(n=>{var o;n&&this.motionController&&this.motionController.rootMesh&&(this._options.renderingGroupId&&(this.motionController.rootMesh.renderingGroupId=this._options.renderingGroupId,this.motionController.rootMesh.getChildMeshes(!1).forEach(a=>a.renderingGroupId=this._options.renderingGroupId)),this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this._options.disableMotionControllerAnimation),this._disposed&&(null===(o=this.motionController)||void 0===o||o.dispose())})},()=>{q.Warn("Could not find a matching motion controller for the registered input source")})}get uniqueId(){return this._uniqueId}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0}getWorldPointerRayToRef(e,t=!1){const i=t&&this.grip?this.grip:this.pointer;v.TransformNormalToRef(this._tmpVector,i.getWorldMatrix(),e.direction),e.direction.normalize(),e.origin.copyFrom(i.absolutePosition),e.length=1e3}updateFromXRFrame(e,t,i){const s=e.getPose(this.inputSource.targetRaySpace,t);if(this._lastXRPose=s,s){const n=s.transform.position;this.pointer.position.set(n.x,n.y,n.z);const o=s.transform.orientation;this.pointer.rotationQuaternion.set(o.x,o.y,o.z,o.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=i.parent}if(this.inputSource.gripSpace&&this.grip){const n=e.getPose(this.inputSource.gripSpace,t);if(n){const o=n.transform.position,a=n.transform.orientation;this.grip.position.set(o.x,o.y,o.z),this.grip.rotationQuaternion.set(a.x,a.y,a.z,a.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=i.parent}this.motionController&&this.motionController.updateFromXRFrame(e)}}class Wne{constructor(e,t,i={}){if(this.xrSessionManager=e,this.xrCamera=t,this._options=i,this.controllers=[],this.onControllerAddedObservable=new z,this.onControllerRemovedObservable=new z,this._onInputSourcesChange=s=>{this._addAndRemoveControllers(s.added,s.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add(()=>{this._addAndRemoveControllers([],this.controllers.map(s=>s.inputSource))}),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add(s=>{s.addEventListener("inputsourceschange",this._onInputSourcesChange)}),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add(s=>{this.controllers.forEach(n=>{n.updateFromXRFrame(s,this.xrSessionManager.referenceSpace,this.xrCamera)})}),this._options.customControllersRepositoryURL&&(nn.BaseRepositoryUrl=this._options.customControllersRepositoryURL),nn.UseOnlineRepository=!this._options.disableOnlineControllerRepository,nn.UseOnlineRepository)try{nn.UpdateProfilesList().catch(()=>{nn.UseOnlineRepository=!1})}catch{nn.UseOnlineRepository=!1}}_addAndRemoveControllers(e,t){const i=this.controllers.map(o=>o.inputSource);for(const o of e)if(-1===i.indexOf(o)){const a=new Hne(this.xrSessionManager.scene,o,{...this._options.controllerOptions||{},forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation});this.controllers.push(a),this.onControllerAddedObservable.notifyObservers(a)}const s=[],n=[];this.controllers.forEach(o=>{-1===t.indexOf(o.inputSource)?s.push(o):n.push(o)}),this.controllers=s,n.forEach(o=>{this.onControllerRemovedObservable.notifyObservers(o),o.dispose()})}dispose(){this.controllers.forEach(e=>{e.dispose()}),this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),nn.ClearControllerCache()}}class ba extends Xs{constructor(e,t){super(e),this._options=t,this._attachController=i=>{if(this._controllers[i.uniqueId])return;const{laserPointer:s,selectionMesh:n}=this._generateNewMeshPair(i.pointer);switch(this._controllers[i.uniqueId]={xrController:i,laserPointer:s,selectionMesh:n,meshUnderPointer:null,pick:null,tmpRay:new Qe(new v,new v),disabledByNearInteraction:!1,id:ba._IdCounter++},this._attachedController?!this._options.enablePointerSelectionOnAllControllers&&this._options.preferredHandedness&&i.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=i.uniqueId):this._options.enablePointerSelectionOnAllControllers||(this._attachedController=i.uniqueId),i.inputSource.targetRayMode){case"tracked-pointer":return this._attachTrackedPointerRayMode(i);case"gaze":return this._attachGazeMode(i);case"screen":return this._attachScreenRayMode(i)}},this._controllers={},this._tmpVectorForPickCompare=new v,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new re(.9,.9,.9),this.laserPointerDefaultColor=new re(.7,.7,.7),this.selectionMeshDefaultColor=new re(.8,.8,.8),this.selectionMeshPickedColor=new re(.3,.3,1),this._identityMatrix=F.Identity(),this._screenCoordinatesRef=v.Zero(),this._viewportRef=new qr(0,0,0,0),this._scene=this._xrSessionManager.scene}attach(){if(!super.attach())return!1;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){const e=this._options.gazeCamera,{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(e);this._controllers.camera={webXRCamera:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new Qe(new v,new v),disabledByNearInteraction:!1,id:ba._IdCounter++},this._attachGazeMode()}return!0}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),!0)}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}_getPointerSelectionDisabledByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].disabledByNearInteraction;return!0}_setPointerSelectionDisabledByPointerId(e,t){const i=Object.keys(this._controllers);for(let s=0;s<i.length;++s)if(this._controllers[i[s]].id===e)return void(this._controllers[i[s]].disabledByNearInteraction=t)}_onXRFrame(e){Object.keys(this._controllers).forEach(t=>{const i=this._controllers[t];if(!this._options.enablePointerSelectionOnAllControllers&&t!==this._attachedController||i.disabledByNearInteraction)return i.selectionMesh.isVisible=!1,i.laserPointer.isVisible=!1,void(i.pick=null);let s;if(i.laserPointer.isVisible=this.displayLaserPointer,i.xrController)s=i.xrController.pointer.position,i.xrController.getWorldPointerRayToRef(i.tmpRay);else{if(!i.webXRCamera)return;s=i.webXRCamera.position,i.webXRCamera.getForwardRayToRef(i.tmpRay)}if(this._options.maxPointerDistance&&(i.tmpRay.length=this._options.maxPointerDistance),!this._options.disableScenePointerVectorUpdate&&s){const l=this._xrSessionManager.scene,c=this._options.xrInput.xrCamera;c&&(c.viewport.toGlobalToRef(l.getEngine().getRenderWidth(),l.getEngine().getRenderHeight(),this._viewportRef),v.ProjectToRef(s,this._identityMatrix,l.getTransformMatrix(),this._viewportRef,this._screenCoordinatesRef),"number"==typeof this._screenCoordinatesRef.x&&"number"==typeof this._screenCoordinatesRef.y&&!isNaN(this._screenCoordinatesRef.x)&&!isNaN(this._screenCoordinatesRef.y)&&(l.pointerX=this._screenCoordinatesRef.x,l.pointerY=this._screenCoordinatesRef.y,i.screenCoordinates={x:this._screenCoordinatesRef.x,y:this._screenCoordinatesRef.y}))}let n=null;this._utilityLayerScene&&(n=this._utilityLayerScene.pickWithRay(i.tmpRay,this._utilityLayerScene.pointerMovePredicate||this.raySelectionPredicate));const o=this._scene.pickWithRay(i.tmpRay,this._scene.pointerMovePredicate||this.raySelectionPredicate);i.pick=n&&n.hit&&(!o||!o.hit||n.distance<o.distance)?n:o,i.pick&&i.xrController&&(i.pick.aimTransform=i.xrController.pointer,i.pick.gripTransform=i.xrController.grip||null);const a=i.pick;if(a&&a.pickedPoint&&a.hit){this._updatePointerDistance(i.laserPointer,a.distance),i.selectionMesh.position.copyFrom(a.pickedPoint),i.selectionMesh.scaling.x=Math.sqrt(a.distance),i.selectionMesh.scaling.y=Math.sqrt(a.distance),i.selectionMesh.scaling.z=Math.sqrt(a.distance);const l=this._convertNormalToDirectionOfRay(a.getNormal(!0),i.tmpRay),c=.001;if(i.selectionMesh.position.copyFrom(a.pickedPoint),l){const h=v.Cross(fs.Y,l),u=v.Cross(l,h);v.RotationFromAxisToRef(u,l,h,i.selectionMesh.rotation),i.selectionMesh.position.addInPlace(l.scale(c))}i.selectionMesh.isVisible=this.displaySelectionMesh,i.meshUnderPointer=a.pickedMesh}else i.selectionMesh.isVisible=!1,this._updatePointerDistance(i.laserPointer,1),i.meshUnderPointer=null})}get _utilityLayerScene(){return this._options.customUtilityLayerScene||nl.DefaultUtilityLayer.utilityLayerScene}_attachGazeMode(e){const t=this._controllers[e&&e.uniqueId||"camera"],i=this._options.timeToSelect||3e3,s=this._options.useUtilityLayer?this._utilityLayerScene:this._scene;let n=new Os;const o=pa("selection",{diameter:.0525,thickness:.015,tessellation:20},s);o.isVisible=!1,o.isPickable=!1,o.parent=t.selectionMesh;let a=0,l=!1;const c={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{if(t.pick){if(this._augmentPointerInit(c,t.id,t.screenCoordinates),t.laserPointer.material.alpha=0,o.isVisible=!1,t.pick.hit)if(this._pickingMoved(n,t.pick))l&&(this._options.disablePointerUpOnTouchOut||this._scene.simulatePointerUp(t.pick,c)),l=!1,a=0;else if(a>i/10&&(o.isVisible=!0),a+=this._scene.getEngine().getDeltaTime(),a>=i)this._scene.simulatePointerDown(t.pick,c),l=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,c),o.isVisible=!1;else{const h=1-a/i;o.scaling.set(h,h,h)}else l=!1,a=0;this._scene.simulatePointerMove(t.pick,c),n=t.pick}}),void 0!==this._options.renderingGroupId&&(o.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce(()=>{t.pick&&!this._options.disablePointerUpOnTouchOut&&l&&(this._scene.simulatePointerUp(t.pick,c),t.finalPointerUpTriggered=!0),o.dispose()})}_attachScreenRayMode(e){const t=this._controllers[e.uniqueId];let i=!1;const s={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{this._augmentPointerInit(s,t.id,t.screenCoordinates),!(!t.pick||this._options.disablePointerUpOnTouchOut&&i)&&(i?this._scene.simulatePointerMove(t.pick,s):(this._scene.simulatePointerDown(t.pick,s),t.pointerDownTriggered=!0,i=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,s)))}),e.onDisposeObservable.addOnce(()=>{this._augmentPointerInit(s,t.id,t.screenCoordinates),this._xrSessionManager.runInXRFrame(()=>{t.pick&&!t.finalPointerUpTriggered&&i&&!this._options.disablePointerUpOnTouchOut&&(this._scene.simulatePointerUp(t.pick,s),t.finalPointerUpTriggered=!0)})})}_attachTrackedPointerRayMode(e){const t=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);const i={pointerId:t.id,pointerType:"xr"};if(t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{t.laserPointer.material.disableLighting=this.disablePointerLighting,t.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,t.pick&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerMove(t.pick,i))}),e.inputSource.gamepad){const s=n=>{this._options.overrideButtonId&&(t.selectionComponent=n.getComponent(this._options.overrideButtonId)),t.selectionComponent||(t.selectionComponent=n.getMainComponent()),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(o=>{if(o.changes.pressed){const a=o.changes.pressed.current;t.pick?(this._options.enablePointerSelectionOnAllControllers||e.uniqueId===this._attachedController)&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),a?(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)):a&&!this._options.enablePointerSelectionOnAllControllers&&!this._options.disableSwitchOnClick&&(this._attachedController=e.uniqueId)}})};e.motionController?s(e.motionController):e.onMotionControllerInitObservable.add(s)}else{const s=o=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&o.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor)},n=o=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&o.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)};t.eventListeners={selectend:n,selectstart:s},this._xrSessionManager.session.addEventListener("selectstart",s),this._xrSessionManager.session.addEventListener("selectend",n)}}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(v.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_detachController(e){const t=this._controllers[e];if(t){if(t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach(i=>{const s=t.eventListeners&&t.eventListeners[i];s&&this._xrSessionManager.session.removeEventListener(i,s)}),!t.finalPointerUpTriggered&&t.pointerDownTriggered){const i={pointerId:t.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerUp(t.pick||new Os,i),t.finalPointerUpTriggered=!0})}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce(()=>{try{if(t.selectionMesh.dispose(),t.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e){const i=Object.keys(this._controllers);this._attachedController=i.length?i[0]:""}}catch{q.Warn("controller already detached.")}})}}_generateNewMeshPair(e){const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||nl.DefaultUtilityLayer.utilityLayerScene:this._scene,i=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():sc("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},t);i.parent=e;const s=new fe("laserPointerMat",t);s.emissiveColor=this.laserPointerDefaultColor,s.alpha=.7,i.material=s,i.rotation.x=Math.PI/2,this._updatePointerDistance(i,1),i.isPickable=!1,i.isVisible=!1;const n=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():pa("gazeTracker",{diameter:.0105,thickness:.0075,tessellation:20},t);n.bakeCurrentTransformIntoVertices(),n.isPickable=!1,n.isVisible=!1;const o=new fe("targetMat",t);return o.specularColor=re.Black(),o.emissiveColor=this.selectionMeshDefaultColor,o.backFaceCulling=!1,n.material=o,void 0!==this._options.renderingGroupId&&(i.renderingGroupId=this._options.renderingGroupId,n.renderingGroupId=this._options.renderingGroupId),{laserPointer:i,selectionMesh:n}}_pickingMoved(e,t){var i;if(!(e.hit&&t.hit&&e.pickedMesh&&e.pickedPoint&&t.pickedMesh&&t.pickedPoint&&e.pickedMesh===t.pickedMesh))return!0;null===(i=e.pickedPoint)||void 0===i||i.subtractToRef(t.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));const s=.01*(this._options.gazeModePointerMovedFactor||1)*t.distance;return this._tmpVectorForPickCompare.length()>s}_updatePointerDistance(e,t=100){e.scaling.y=t,this._scene.useRightHandedSystem&&(t*=-1),e.position.z=t/2+.05}_augmentPointerInit(e,t,i){e.pointerId=t,e.pointerType="xr",i&&(e.screenX=i.x,e.screenY=i.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}}ba._IdCounter=200,ba.Name=Ki.POINTER_SELECTION,ba.Version=1,Ai.AddWebXRFeature(ba.Name,(r,e)=>()=>new ba(r,e),ba.Version,!0),fr.prototype._projectOnTrianglesToRef=function(r,e,t,i,s,n){const o=L.Vector3[0],a=L.Vector3[1];let l=1/0;for(let c=this.indexStart;c<this.indexStart+this.indexCount-(3-i);c+=i){const h=t[c],u=t[c+1],d=t[c+2];if(s&&4294967295===d){c+=2;continue}const f=e[h],p=e[u],_=e[d];if(!f||!p||!_)continue;const m=v.ProjectOnTriangleToRef(r,f,p,_,a);m<l&&(o.copyFrom(a),l=m)}return n.copyFrom(o),l},fr.prototype._projectOnUnIndexedTrianglesToRef=function(r,e,t,i){const s=L.Vector3[0],n=L.Vector3[1];let o=1/0;for(let a=this.verticesStart;a<this.verticesStart+this.verticesCount;a+=3){const u=v.ProjectOnTriangleToRef(r,e[a],e[a+1],e[a+2],n);u<o&&(s.copyFrom(n),o=u)}return i.copyFrom(s),o},fr.prototype.projectToRef=function(r,e,t,i){const s=this.getMaterial();if(!s)return-1;let n=3,o=!1;switch(s.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:n=1,o=!0}return 4===s.fillMode?-1:!t.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(r,e,t,i):this._projectOnTrianglesToRef(r,e,t,n,o,i)};var on=(()=>{return(r=on||(on={}))[r.DEHYDRATED=0]="DEHYDRATED",r[r.HOVER=1]="HOVER",r[r.TOUCH=2]="TOUCH",on;var r})(),hc=(()=>{return(r=hc||(hc={}))[r.DISABLED=0]="DISABLED",r[r.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",r[r.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT",hc;var r})();class ya extends Xs{constructor(e,t){super(e),this._options=t,this._tmpRay=new Qe(new v,new v),this._attachController=i=>{if(this._controllers[i.uniqueId])return;const{touchCollisionMesh:s,touchCollisionMeshFunction:n,hydrateCollisionMeshFunction:o}=this._generateNewTouchPointMesh(),a=this._generateVisualCue();switch(this._controllers[i.uniqueId]={xrController:i,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:s,touchCollisionMeshFunction:n,hydrateCollisionMeshFunction:o,currentAnimationState:on.DEHYDRATED,grabRay:new Qe(new v,new v),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,id:ya._IdCounter++,pickedPointVisualCue:a},this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&i.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=i.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=i.uniqueId),i.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(i);case"gaze":case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new re(.8,.8,.8),this.selectionMeshPickedColor=new re(.3,.3,1),this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,void 0===this._options.nearInteractionControllerMode&&(this._options.nearInteractionControllerMode=hc.CENTERED_IN_FRONT),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){return!!super.attach()&&(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),!0)}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,t){let i=e;for(;i;){if(i.reservedDataStore&&i.reservedDataStore.nearInteraction&&i.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;i=i.parent}return!0}_handleTransitionAnimation(e,t){var i;if(!(e.currentAnimationState===t||this._options.nearInteractionControllerMode!==hc.CENTERED_IN_FRONT||null!==(i=e.xrController)&&void 0!==i&&i.inputSource.hand)){if(t>e.currentAnimationState)switch(e.currentAnimationState){case on.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===on.HOVER)break;case on.HOVER:if(e.touchCollisionMeshFunction(!0),t===on.TOUCH)break}else switch(e.currentAnimationState){case on.TOUCH:if(e.touchCollisionMeshFunction(!1),t===on.HOVER)break;case on.HOVER:if(e.hydrateCollisionMeshFunction(!1),t===on.DEHYDRATED)break}e.currentAnimationState=t}}_processTouchPoint(e,t,i){var s;const n=this._controllers[e];n.grabRay.origin.copyFrom(t),i.toEulerAnglesToRef(L.Vector3[0]),n.grabRay.direction.copyFrom(L.Vector3[0]),this._options.nearInteractionControllerMode===hc.CENTERED_IN_FRONT&&!(null!==(s=n.xrController)&&void 0!==s&&s.inputSource.hand)&&(n.xrController.getWorldPointerRayToRef(this._tmpRay),n.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),n.grabRay.length=this._nearGrabLengthScale*this._hoverRadius,n.touchCollisionMesh.position.copyFrom(n.grabRay.origin)}_onXRFrame(e){Object.keys(this._controllers).forEach(t=>{var i;const s=this._controllers[t],n=null===(i=s.xrController)||void 0===i?void 0:i.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&t!==this._attachedController||!s.xrController||!n&&(!this._options.nearInteractionControllerMode||!s.xrController.inputSource.gamepad))return void(s.pick=null);if(s.hoverInteraction=!1,s.nearInteraction=!1,!s.xrController)return;if(n){const c=n.get("index-finger-tip");if(c){const h=e.getJointPose(c,this._xrSessionManager.referenceSpace);if(h&&h.transform){const u=this._scene.useRightHandedSystem?1:-1;L.Vector3[0].set(h.transform.position.x,h.transform.position.y,h.transform.position.z*u),L.Quaternion[0].set(h.transform.orientation.x,h.transform.orientation.y,h.transform.orientation.z*u,h.transform.orientation.w*u),this._processTouchPoint(t,L.Vector3[0],L.Quaternion[0])}}}else if(s.xrController.inputSource.gamepad&&this._options.nearInteractionControllerMode!==hc.DISABLED){let c=s.xrController.pointer;s.xrController.grip&&this._options.nearInteractionControllerMode===hc.CENTERED_ON_CONTROLLER&&(c=s.xrController.grip),this._processTouchPoint(t,c.position,c.rotationQuaternion)}const o=(c,h)=>{let u=null;return u=h&&h.hit&&(!c||!c.hit||h.distance<c.distance)?h:c,u},a=c=>{let h=new Os,u=!1;return c?.pickedPoint&&(u=0===c.pickedPoint.x&&0===c.pickedPoint.y&&0===c.pickedPoint.z),c&&c.pickedPoint&&c.hit&&!u&&(h=c),h};if(!s.grabInteraction){let c=null,h=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(h=this._pickWithSphere(s,this._hoverRadius,this._utilityLayerScene,f=>this._nearInteractionPredicate(f)));const d=o(this._pickWithSphere(s,this._hoverRadius,this._scene,f=>this._nearInteractionPredicate(f)),h);if(d&&d.hit&&(c=a(d),c.hit&&(s.hoverInteraction=!0)),s.hoverInteraction){let f=null;const p=n?this._pickRadius:this._controllerPickRadius;this._options.useUtilityLayer&&this._utilityLayerScene&&(f=this._pickWithSphere(s,p,this._utilityLayerScene,b=>this._nearPickPredicate(b)));const g=a(o(this._pickWithSphere(s,p,this._scene,b=>this._nearPickPredicate(b)),f));g.hit&&(c=g,s.nearInteraction=!0)}s.stalePick=s.pick,s.pick=c,s.pick&&s.pick.pickedPoint&&s.pick.hit?(s.meshUnderPointer=s.pick.pickedMesh,s.pickedPointVisualCue.position.copyFrom(s.pick.pickedPoint),s.pickedPointVisualCue.isVisible=!0,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(s.id,!0)):(s.meshUnderPointer=null,s.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(s.id,!1))}let l=on.DEHYDRATED;s.grabInteraction||s.nearInteraction?l=on.TOUCH:s.hoverInteraction&&(l=on.HOVER),this._handleTransitionAnimation(s,l)})}get _utilityLayerScene(){return this._options.customUtilityLayerScene||nl.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||nl.DefaultUtilityLayer.utilityLayerScene:this._scene,t=po("nearInteraction",{diameter:.0105},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=Z.Identity();const i=new fe("targetMat",e);return i.specularColor=re.Black(),i.emissiveColor=this.selectionMeshDefaultColor,i.backFaceCulling=!1,t.material=i,t}_isControllerReadyForNearInteraction(e){return!this._farInteractionFeature||this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e)}_attachNearInteractionMode(e){const t=this._controllers[e.uniqueId],i={pointerId:t.id,pointerType:"xr-near"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{!this._options.enableNearInteractionOnAllControllers&&e.uniqueId!==this._attachedController||!t.xrController||!t.xrController.inputSource.hand&&(!this._options.nearInteractionControllerMode||!t.xrController.inputSource.gamepad)||(t.pick&&(t.pick.ray=t.grabRay),t.pick&&this._isControllerReadyForNearInteraction(t.id)&&this._scene.simulatePointerMove(t.pick,i),t.nearInteraction&&t.pick&&t.pick.hit?t.nearInteractionTargetMesh||(this._scene.simulatePointerDown(t.pick,i),t.nearInteractionTargetMesh=t.meshUnderPointer):t.nearInteractionTargetMesh&&t.stalePick&&(this._scene.simulatePointerUp(t.stalePick,i),t.nearInteractionTargetMesh=null))});const s=n=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(t.id)?(t.pick&&(t.pick.ray=t.grabRay),n&&t.pick&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)?(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i)):!n&&t.pick&&t.grabInteraction&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)):n&&!this._options.enableNearInteractionOnAllControllers&&!this._options.disableSwitchOnClick&&(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){const n=o=>{t.squeezeComponent=o.getComponent("grasp"),t.squeezeComponent?t.onSqueezeButtonChangedObserver=t.squeezeComponent.onButtonStateChangedObservable.add(a=>{a.changes.pressed&&s(a.changes.pressed.current)}):(t.selectionComponent=o.getMainComponent(),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(a=>{a.changes.pressed&&s(a.changes.pressed.current)}))};e.motionController?n(e.motionController):e.onMotionControllerInitObservable.add(n)}else{const n=a=>{t.xrController&&a.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)&&(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i))},o=a=>{t.xrController&&a.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)};t.eventListeners={selectend:o,selectstart:n},this._xrSessionManager.session.addEventListener("selectstart",n),this._xrSessionManager.session.addEventListener("selectend",o)}}_detachController(e){const t=this._controllers[e];if(t&&(t.squeezeComponent&&t.onSqueezeButtonChangedObserver&&t.squeezeComponent.onButtonStateChangedObservable.remove(t.onSqueezeButtonChangedObserver),t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach(i=>{const s=t.eventListeners&&t.eventListeners[i];s&&this._xrSessionManager.session.removeEventListener(i,s)}),t.touchCollisionMesh.dispose(),t.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame(()=>{const i={pointerId:t.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new Os,i)}),delete this._controllers[e],this._attachedController===e)){const i=Object.keys(this._controllers);this._attachedController=i.length?i[0]:""}}_generateNewTouchPointMesh(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||nl.DefaultUtilityLayer.utilityLayerScene:this._scene,t=po("PickSphere",{diameter:1},e);t.isVisible=!1,this._options.motionControllerOrbMaterial?t.material=this._options.motionControllerOrbMaterial:Ri.ParseFromSnippetAsync("8RUNKL#3",e).then(C=>{t.material=C});const i=new Qie;i.setEasingMode(Bo.EASINGMODE_EASEINOUT);const s=new v(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius),n=this._controllerPickRadius*(4/3),o=new v(n,n,n),a=this._controllerPickRadius*(7/6),l=new v(a,a,a),c=.8*this._controllerPickRadius,h=new v(c,c,c),u=1.5*this._controllerPickRadius,f=[{frame:0,value:s},{frame:10,value:new v(u,u,u)},{frame:18,value:o}],p=[{frame:0,value:o},{frame:10,value:h},{frame:18,value:s}],_=[{frame:0,value:v.ZeroReadOnly},{frame:12,value:l},{frame:15,value:s}],m=[{frame:0,value:s},{frame:10,value:v.ZeroReadOnly},{frame:15,value:v.ZeroReadOnly}],g=new $("touch","scaling",60,$.ANIMATIONTYPE_VECTOR3,$.ANIMATIONLOOPMODE_CONSTANT),b=new $("release","scaling",60,$.ANIMATIONTYPE_VECTOR3,$.ANIMATIONLOOPMODE_CONSTANT),y=new $("hydrate","scaling",60,$.ANIMATIONTYPE_VECTOR3,$.ANIMATIONLOOPMODE_CONSTANT),T=new $("dehydrate","scaling",60,$.ANIMATIONTYPE_VECTOR3,$.ANIMATIONLOOPMODE_CONSTANT);return g.setEasingFunction(i),b.setEasingFunction(i),y.setEasingFunction(i),T.setEasingFunction(i),g.setKeys(f),b.setKeys(p),y.setKeys(_),T.setKeys(m),{touchCollisionMesh:t,touchCollisionMeshFunction:C=>{e.beginDirectAnimation(t,[C?g:b],0,18,!1,1)},hydrateCollisionMeshFunction:C=>{const D=C?y:T;C&&(t.isVisible=!0),e.beginDirectAnimation(t,[D],0,15,!1,1,()=>{C||(t.isVisible=!1)})}}}_pickWithSphere(e,t,i,s){const n=new Os;if(n.distance=1/0,e.touchCollisionMesh&&e.xrController){const a=Qa.CreateFromCenterAndRadius(e.touchCollisionMesh.position,t);for(let l=0;l<i.meshes.length;l++){const c=i.meshes[l];if(!s(c)||!this._controllerAvailablePredicate(c,e.xrController.uniqueId))continue;const h=ya.PickMeshWithSphere(c,a);h&&h.hit&&h.distance<n.distance&&(n.hit=h.hit,n.pickedMesh=c,n.pickedPoint=h.pickedPoint,n.aimTransform=e.xrController.pointer,n.gripTransform=e.xrController.grip||null,n.originMesh=e.touchCollisionMesh,n.distance=h.distance)}}return n}static PickMeshWithSphere(e,t,i=!1){const s=e.subMeshes,n=new Os,o=e.getBoundingInfo();if(!e._generatePointsArray()||!e.subMeshes||!o||!i&&!Qa.Intersects(o.boundingSphere,t))return n;const a=L.Vector3[0],l=L.Vector3[1];let h,u,d,c=1/0;const f=L.Vector3[2],p=L.Matrix[0];p.copyFrom(e.getWorldMatrix()),p.invert(),v.TransformCoordinatesToRef(t.center,p,f);for(let _=0;_<s.length;_++)s[_].projectToRef(f,e._positions,e.getIndices(),l),v.TransformCoordinatesToRef(l,e.getWorldMatrix(),l),h=v.Distance(l,t.center),d=v.Distance(l,e.getAbsolutePosition()),u=v.Distance(t.center,e.getAbsolutePosition()),-1!==u&&-1!==d&&d>u&&(h=0,l.copyFrom(t.center)),-1!==h&&h<c&&(c=h,a.copyFrom(l));return c<t.radius&&(n.hit=!0,n.distance=c,n.pickedMesh=e,n.pickedPoint=a.clone()),n}}ya._IdCounter=200,ya.Name=Ki.NEAR_INTERACTION,ya.Version=1,Ai.AddWebXRFeature(ya.Name,(r,e)=>()=>new ya(r,e),ya.Version,!0);class Xne{constructor(e,t,i){this.element=e,this.sessionMode=t,this.referenceSpaceType=i}update(e){}}class DC{constructor(e,t){if(this._scene=e,this.options=t,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new z,this._onSessionGranted=s=>{this._helper&&this._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!t.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),typeof window<"u"&&window.location&&"http:"===window.location.protocol&&"localhost"!==window.location.hostname)throw q.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(t.customButtons)this._buttons=t.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";const s=t.sessionMode||"immersive-vr",n=t.referenceSpaceType||"local-floor";let a=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(typeof SVGSVGElement>"u"?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";a+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';const l=document.createElement("style");l.appendChild(document.createTextNode(a)),document.getElementsByTagName("head")[0].appendChild(l);const c=document.createElement("button");c.className="babylonVRicon",c.title=`${s} - ${n}`,this._buttons.push(new Xne(c,s,n)),this._buttons[this._buttons.length-1].update=function(h){this.element.style.display=null===h||h===this?"":"none",c.className="babylonVRicon"+(h===this?" vrdisplaypresenting":"")},this._updateButtons(null)}const i=e.getEngine().getInputElement();i&&i.parentNode&&(i.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce(()=>{this.dispose()}))}setHelperAsync(e,t){var i=this;return Qt(function*(){i._helper=e,i._renderTarget=t;const s=i._buttons.map(o=>e.sessionManager.isSessionSupportedAsync(o.sessionMode));e.onStateChangedObservable.add(o=>{o==rs.NOT_IN_XR&&i._updateButtons(null)}),(yield Promise.all(s)).forEach((o,a)=>{o?(i.overlay.appendChild(i._buttons[a].element),i._buttons[a].element.onclick=i._enterXRWithButtonIndex.bind(i,a)):q.Warn(`Session mode "${i._buttons[a].sessionMode}" not supported in browser`)})})()}static CreateAsync(e,t,i){return Qt(function*(){const s=new DC(e,i);return yield s.setHelperAsync(t,i.renderTarget||void 0),s})()}_enterXRWithButtonIndex(e=0){var t=this;return Qt(function*(){if(t._helper.state==rs.IN_XR)yield t._helper.exitXRAsync(),t._updateButtons(null);else if(t._helper.state==rs.NOT_IN_XR)try{yield t._helper.enterXRAsync(t._buttons[e].sessionMode,t._buttons[e].referenceSpaceType,t._renderTarget,{optionalFeatures:t.options.optionalFeatures,requiredFeatures:t.options.requiredFeatures}),t._updateButtons(t._buttons[e])}catch(i){t._updateButtons(null);const s=t._buttons[e].element;s.title="Error entering XR session : "+s.title,s.classList.add("xr-error"),t.options.onError&&t.options.onError(i)}})()}dispose(){const e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e,this._buttons.forEach(t=>{t.update(this._activeButton)}),this.activeButtonChangedObservable.notifyObservers(this._activeButton)}}function L3(r){var e;let t=0;const i=Date.now();r.observableParameters=null!==(e=r.observableParameters)&&void 0!==e?e:{};const s=r.contextObservable.add(n=>{const o=Date.now();t=o-i;const a={startTime:i,currentTime:o,deltaTime:t,completeRate:t/r.timeout,payload:n};r.onTick&&r.onTick(a),r.breakCondition&&r.breakCondition()&&(r.contextObservable.remove(s),r.onAborted&&r.onAborted(a)),t>=r.timeout&&(r.contextObservable.remove(s),r.onEnded&&r.onEnded(a))},r.observableParameters.mask,r.observableParameters.insertFirst,r.observableParameters.scope);return s}class rd extends Xs{get rotationEnabled(){return this._rotationEnabled}set rotationEnabled(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){const t=this._options.teleportationTargetMesh.getChildMeshes(!1,i=>"rotationCone"===i.name);t[0]&&t[0].setEnabled(e)}}get teleportationTargetMesh(){return this._options.teleportationTargetMesh||null}constructor(e,t){super(e),this._options=t,this._controllers={},this._snappedToPoint=!1,this._tmpRay=new Qe(new v,new v),this._tmpVector=new v,this._tmpQuaternion=new Z,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new z,this.teleportationEnabled=!0,this._rotationEnabled=!0,this._attachController=i=>{if(this._controllers[i.uniqueId]||this._options.forceHandedness&&i.inputSource.handedness!==this._options.forceHandedness)return;this._controllers[i.uniqueId]={xrController:i,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0}};const s=this._controllers[i.uniqueId];if("tracked-pointer"===s.xrController.inputSource.targetRayMode&&s.xrController.inputSource.gamepad){const n=()=>{if(i.motionController){const o=i.motionController.getComponentOfType(vl.THUMBSTICK_TYPE)||i.motionController.getComponentOfType(vl.TOUCHPAD_TYPE);if(!o||this._options.useMainComponentOnly){const a=i.motionController.getMainComponent();if(!a)return;s.teleportationComponent=a,s.onButtonChangedObserver=a.onButtonStateChangedObservable.add(()=>{this.teleportationEnabled&&a.changes.pressed&&(a.changes.pressed.current?(s.teleportationState.forward=!0,this._currentTeleportationControllerId=s.xrController.uniqueId,s.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,s.teleportationState.currentRotation=0,L3({timeout:this._options.timeToTeleport||3e3,contextObservable:this._xrSessionManager.onXRFrameObservable,breakCondition:()=>!a.pressed,onEnded:()=>{this._currentTeleportationControllerId===s.xrController.uniqueId&&s.teleportationState.forward&&this._teleportForward(i.uniqueId)}})):(s.teleportationState.forward=!1,this._currentTeleportationControllerId=""))})}else s.teleportationComponent=o,s.onAxisChangedObserver=o.onAxisValueChangedObservable.add(a=>{if(a.y<=.7&&s.teleportationState.backwards&&(s.teleportationState.backwards=!1),a.y>.7&&!s.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!s.teleportationState.backwards){s.teleportationState.backwards=!0,this._tmpQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion),this._tmpQuaternion.toEulerAnglesToRef(this._tmpVector),this._tmpVector.x=0,this._tmpVector.z=0,Z.FromEulerVectorToRef(this._tmpVector,this._tmpQuaternion),this._tmpVector.set(0,0,this.backwardsTeleportationDistance*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),this._tmpVector.rotateByQuaternionToRef(this._tmpQuaternion,this._tmpVector),this._tmpVector.addInPlace(this._options.xrInput.xrCamera.position),this._tmpRay.origin.copyFrom(this._tmpVector),this._tmpRay.length=this._options.xrInput.xrCamera.realWorldHeight+.1,this._tmpRay.direction.set(0,-1,0);const l=this._xrSessionManager.scene.pickWithRay(this._tmpRay,c=>-1!==this._floorMeshes.indexOf(c));l&&l.pickedPoint&&(this._options.xrInput.xrCamera.position.x=l.pickedPoint.x,this._options.xrInput.xrCamera.position.z=l.pickedPoint.z)}a.y<-.7&&!this._currentTeleportationControllerId&&!s.teleportationState.rotating&&this.teleportationEnabled&&(s.teleportationState.forward=!0,this._currentTeleportationControllerId=s.xrController.uniqueId,s.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),a.x?s.teleportationState.forward?this._currentTeleportationControllerId===s.xrController.uniqueId&&(this.rotationEnabled?setTimeout(()=>{s.teleportationState.currentRotation=Math.atan2(a.x,a.y*(this._xrSessionManager.scene.useRightHandedSystem?1:-1))}):s.teleportationState.currentRotation=0):!s.teleportationState.rotating&&Math.abs(a.x)>.7&&(s.teleportationState.rotating=!0,Z.FromEulerAngles(0,this.rotationAngle*(a.x>0?1:-1)*(this._xrSessionManager.scene.useRightHandedSystem?-1:1),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion)):s.teleportationState.rotating=!1,0===a.x&&0===a.y&&s.teleportationState.forward&&this._teleportForward(i.uniqueId)})}};i.motionController?n():i.onMotionControllerInitObservable.addOnce(()=>{n()})}else this._xrSessionManager.scene.onPointerObservable.add(n=>{n.type===Re.POINTERDOWN?(s.teleportationState.forward=!0,this._currentTeleportationControllerId=s.xrController.uniqueId,s.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,s.teleportationState.currentRotation=0,L3({timeout:this._options.timeToTeleport||3e3,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===s.xrController.uniqueId&&s.teleportationState.forward&&this._teleportForward(i.uniqueId)}})):n.type===Re.POINTERUP&&(s.teleportationState.forward=!1,this._currentTeleportationControllerId="")})},this._options.teleportationTargetMesh||this._createDefaultTargetMesh(),this._floorMeshes=this._options.floorMeshes||[],this._snapToPositions=this._options.snapPositions||[],this._setTargetMeshVisibility(!1)}get snapPointsOnly(){return!!this._options.snapPointsOnly}set snapPointsOnly(e){this._options.snapPointsOnly=e}addFloorMesh(e){this._floorMeshes.push(e)}addBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)}addSnapPoint(e){this._snapToPositions.push(e)}attach(){return!!super.attach()&&(this._currentTeleportationControllerId="",this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0)}dispose(){super.dispose(),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0)}removeFloorMesh(e){const t=this._floorMeshes.indexOf(e);-1!==t&&this._floorMeshes.splice(t,1)}removeBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];const t=this._options.pickBlockerMeshes.indexOf(e);-1!==t&&this._options.pickBlockerMeshes.splice(t,1)}removeFloorMeshByName(e){const t=this._xrSessionManager.scene.getMeshByName(e);t&&this.removeFloorMesh(t)}removeSnapPoint(e){let t=this._snapToPositions.indexOf(e);if(-1===t)for(let i=0;i<this._snapToPositions.length;++i)if(this._snapToPositions[i].equals(e)){t=i;break}return-1!==t&&(this._snapToPositions.splice(t,1),!0)}setSelectionFeature(e){this._selectionFeature=e}_onXRFrame(e){const i=this._xrSessionManager.scene;if(!this.attach||!this._xrSessionManager.currentFrame)return;const s=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!s)return;s.rotationQuaternion=s.rotationQuaternion||new Z;const n=this._controllers[this._currentTeleportationControllerId];if(n&&n.teleportationState.forward){Z.RotationYawPitchRollToRef(n.teleportationState.currentRotation+n.teleportationState.baseRotation,0,0,s.rotationQuaternion);let o=!1;if(n.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){const a=i.pickWithRay(this._tmpRay,l=>{if(this._options.pickBlockerMeshes&&-1!==this._options.pickBlockerMeshes.indexOf(l))return!0;const c=this._floorMeshes.indexOf(l);return-1!==c&&this._floorMeshes[c].absolutePosition.y<this._options.xrInput.xrCamera.globalPosition.y});if(a&&a.pickedMesh&&this._options.pickBlockerMeshes&&-1!==this._options.pickBlockerMeshes.indexOf(a.pickedMesh))return;a&&a.pickedPoint&&(o=!0,this._setTargetMeshPosition(a),this._setTargetMeshVisibility(!0),this._showParabolicPath(a))}if(this.parabolicRayEnabled&&!o){const a=n.xrController.pointer.rotationQuaternion.toEulerAngles().x,l=Math.PI/2-Math.abs(a)+1,c=this.parabolicCheckRadius*l;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(2*c),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(c)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();const h=i.pickWithRay(this._tmpRay,u=>!(!this._options.pickBlockerMeshes||-1===this._options.pickBlockerMeshes.indexOf(u))||-1!==this._floorMeshes.indexOf(u));if(h&&h.pickedMesh&&this._options.pickBlockerMeshes&&-1!==this._options.pickBlockerMeshes.indexOf(h.pickedMesh))return;h&&h.pickedPoint&&(o=!0,this._setTargetMeshPosition(h),this._setTargetMeshVisibility(!0),this._showParabolicPath(h))}this._setTargetMeshVisibility(o)}else this._setTargetMeshVisibility(!1)}else this._setTargetMeshVisibility(!1)}_createDefaultTargetMesh(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||nl.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,t=Ep("teleportationTarget",{width:2,height:2,subdivisions:2},e);if(t.isPickable=!1,this._options.defaultTargetMeshOptions.teleportationCircleMaterial)t.material=this._options.defaultTargetMeshOptions.teleportationCircleMaterial;else{const o=new ic("teleportationPlaneDynamicTexture",512,e,!0);o.hasAlpha=!0;const a=o.getContext(),l=256,c=256,h=200;a.beginPath(),a.arc(l,c,h,0,2*Math.PI,!1),a.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",a.fill(),a.lineWidth=10,a.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",a.stroke(),a.closePath(),o.update();const u=new fe("teleportationPlaneMaterial",e);u.diffuseTexture=o,t.material=u}const i=pa("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(i.isPickable=!1,i.parent=t,!this._options.defaultTargetMeshOptions.disableAnimation){const n=new $("animationInnerCircle","position.y",30,$.ANIMATIONTYPE_FLOAT,$.ANIMATIONLOOPMODE_CYCLE),o=[];o.push({frame:0,value:0}),o.push({frame:30,value:.4}),o.push({frame:60,value:0}),n.setKeys(o);const a=new v1;a.setEasingMode(Bo.EASINGMODE_EASEINOUT),n.setEasingFunction(a),i.animations=[],i.animations.push(n),e.beginAnimation(i,0,60,!0)}const s=sc("rotationCone",{diameterTop:0,tessellation:4},e);if(s.isPickable=!1,s.scaling.set(.5,.12,.2),s.rotate(fs.X,Math.PI/2),s.position.z=.6,s.parent=i,this._options.defaultTargetMeshOptions.torusArrowMaterial)i.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,s.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{const n=new fe("torusConsMat",e);n.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,n.disableLighting?n.emissiveColor=new re(.3,.3,1):n.diffuseColor=new re(.3,.3,1),n.alpha=.9,i.material=n,s.material=n,this._teleportationRingMaterial=n}void 0!==this._options.renderingGroupId&&(t.renderingGroupId=this._options.renderingGroupId,i.renderingGroupId=this._options.renderingGroupId,s.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=t,this._setTargetMeshVisibility(!1)}_detachController(e){const t=this._controllers[e];!t||(t.teleportationComponent&&(t.onAxisChangedObserver&&t.teleportationComponent.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.teleportationComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver)),delete this._controllers[e])}_findClosestSnapPointWithRadius(e,t=this._options.snapToPositionRadius||.8){let i=null,s=Number.MAX_VALUE;if(this._snapToPositions.length){const n=t*t;this._snapToPositions.forEach(o=>{const a=v.DistanceSquared(o,e);a<=n&&a<s&&(s=a,i=o)})}return i}_setTargetMeshPosition(e){const t=e.pickedPoint;if(!this._options.teleportationTargetMesh||!t)return;const i=this._findClosestSnapPointWithRadius(t);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||t),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}_setTargetMeshVisibility(e){!this._options.teleportationTargetMesh||this._options.teleportationTargetMesh.isVisible!==e&&(this._options.teleportationTargetMesh.isVisible=e,this._options.teleportationTargetMesh.getChildren(void 0,!1).forEach(t=>{t.isVisible=e}),e?this._selectionFeature&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&this._selectionFeature.attach()))}_showParabolicPath(e){if(!e.pickedPoint||!this._currentTeleportationControllerId)return;const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||nl.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,s=Ka.CreateQuadraticBezier(this._controllers[this._currentTeleportationControllerId].xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25);this._quadraticBezierCurve=this._options.generateRayPathMesh?this._options.generateRayPathMesh(s.getPoints(),e):Ip("teleportation path line",{points:s.getPoints(),instance:this._quadraticBezierCurve,updatable:!0},t),this._quadraticBezierCurve.isPickable=!1,void 0!==this._options.renderingGroupId&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}_teleportForward(e){const t=this._controllers[e];if(t&&t.teleportationState.forward&&this.teleportationEnabled&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="",!this.snapPointsOnly||this._snappedToPoint)){if(this.skipNextTeleportation)return void(this.skipNextTeleportation=!1);if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){const i=this._options.xrInput.xrCamera.realWorldHeight;this._options.xrInput.xrCamera.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=i,Z.FromEulerAngles(0,t.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this._options.xrInput.xrCamera.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}}}rd.Name=Ki.TELEPORTATION,rd.Version=1,Ai.AddWebXRFeature(rd.Name,(r,e)=>()=>new rd(r,e),rd.Version,!0);class wC{constructor(){}static CreateAsync(e,t={}){const i=new wC;if(e.onDisposeObservable.addOnce(()=>{i.dispose()}),!t.disableDefaultUI){const s={renderTarget:i.renderTarget,...t.uiOptions||{}};t.optionalFeatures&&(s.optionalFeatures="boolean"==typeof t.optionalFeatures?["hit-test","anchors","plane-detection","hand-tracking"]:t.optionalFeatures),i.enterExitUI=new DC(e,s)}return MC.CreateAsync(e).then(s=>{if(i.baseExperience=s,t.ignoreNativeCameraTransformation&&(i.baseExperience.camera.compensateOnFirstFrame=!1),i.input=new Wne(s.sessionManager,s.camera,{controllerOptions:{renderingGroupId:t.renderingGroupId},...t.inputOptions||{}}),!t.disablePointerSelection){const n={...t.pointerSelectionOptions,xrInput:i.input,renderingGroupId:t.renderingGroupId};i.pointerSelection=i.baseExperience.featuresManager.enableFeature(ba.Name,t.useStablePlugins?"stable":"latest",n),t.disableTeleportation||(i.teleportation=i.baseExperience.featuresManager.enableFeature(rd.Name,t.useStablePlugins?"stable":"latest",{floorMeshes:t.floorMeshes,xrInput:i.input,renderingGroupId:t.renderingGroupId,...t.teleportationOptions}),i.teleportation.setSelectionFeature(i.pointerSelection))}if(t.disableNearInteraction||(i.nearInteraction=i.baseExperience.featuresManager.enableFeature(ya.Name,t.useStablePlugins?"stable":"latest",{xrInput:i.input,farInteractionFeature:i.pointerSelection,renderingGroupId:t.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0,...t.nearInteractionOptions})),i.renderTarget=i.baseExperience.sessionManager.getWebXRRenderTarget(t.outputCanvasOptions),!t.disableDefaultUI)return i.enterExitUI.setHelperAsync(i.baseExperience,i.renderTarget)}).then(()=>i).catch(s=>(V.Error("Error initializing XR"),V.Error(s),i))}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}}function B3(r){for(;r.firstChild;)r.removeChild(r.firstChild);r.srcObject=null,r.src="",r.removeAttribute("src")}ge.prototype.createDefaultLight=function(r=!1){if(r&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();0===this.lights.length&&new jn("default light",v.Up(),this)},ge.prototype.createDefaultCamera=function(r=!1,e=!1,t=!1){if(e&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){const i=this.getWorldExtends(l=>l.isVisible&&l.isEnabled()),s=i.max.subtract(i.min),n=i.min.add(s.scale(.5));let o,a=1.5*s.length();if(isFinite(a)||(a=1,n.copyFromFloats(0,0,0)),r){const l=new si("default camera",-Math.PI/2,Math.PI/2,a,n,this);l.lowerRadiusLimit=.01*a,l.wheelPrecision=100/a,o=l}else{const l=new lr("default camera",new v(n.x,n.y,-a),this);l.setTarget(n),o=l}o.minZ=.01*a,o.maxZ=1e3*a,o.speed=.2*a,this.activeCamera=o,t&&o.attachControl()}},ge.prototype.createDefaultCameraOrLight=function(r=!1,e=!1,t=!1){this.createDefaultLight(e),this.createDefaultCamera(r,e,t)},ge.prototype.createDefaultSkybox=function(r,e=!1,t=1e3,i=0,s=!0){if(!r)return V.Warn("Can not create default skybox without environment texture."),null;s&&r&&(this.environmentTexture=r);const n=Rp("hdrSkyBox",{size:t},this);if(e){const o=new Ee("skyBox",this);o.backFaceCulling=!1,o.reflectionTexture=r.clone(),o.reflectionTexture&&(o.reflectionTexture.coordinatesMode=U.SKYBOX_MODE),o.microSurface=1-i,o.disableLighting=!0,o.twoSidedLighting=!0,n.material=o}else{const o=new fe("skyBox",this);o.backFaceCulling=!1,o.reflectionTexture=r.clone(),o.reflectionTexture&&(o.reflectionTexture.coordinatesMode=U.SKYBOX_MODE),o.disableLighting=!0,n.material=o}return n.isPickable=!1,n.infiniteDistance=!0,n.ignoreCameraMaxZ=!0,n},ge.prototype.createDefaultEnvironment=function(r){return WU?new WU(r,this):null},ge.prototype.createDefaultVRExperience=function(r={}){return new rre(this,r)},ge.prototype.createDefaultXRExperienceAsync=function(r={}){return wC.CreateAsync(this,r).then(e=>e)};class Zv extends U{get onUserActionRequestedObservable(){return this._onUserActionRequestedObservable||(this._onUserActionRequestedObservable=new z),this._onUserActionRequestedObservable}_processError(e){this._errorFound=!0,this._onError?this._onError(e?.message):V.Error(e?.message)}_handlePlay(){this._errorFound=!1,this.video.play().catch(e=>{if("NotAllowedError"===e?.name){if(this._onUserActionRequestedObservable&&this._onUserActionRequestedObservable.hasObservers())return void this._onUserActionRequestedObservable.notifyObservers(this);if(!this.video.muted)return V.Warn("Unable to autoplay a video with sound. Trying again with muted turned true"),this.video.muted=!0,this._errorFound=!1,void this.video.play().catch(t=>{this._processError(t)})}this._processError(e)})}constructor(e,t,i,s=!1,n=!1,o=U.TRILINEAR_SAMPLINGMODE,a={},l,c=5){var h,u;super(null,i,!s,n),this._onUserActionRequestedObservable=null,this._stillImageCaptured=!1,this._displayingPosterTexture=!1,this._frameId=-1,this._currentSrc=null,this._errorFound=!1,this._resizeInternalTexture=()=>{var f;null!=this._texture&&this._texture.dispose(),!this._getEngine().needPOTTextures||q.IsExponentOfTwo(this.video.videoWidth)&&q.IsExponentOfTwo(this.video.videoHeight)?(this.wrapU=U.WRAP_ADDRESSMODE,this.wrapV=U.WRAP_ADDRESSMODE):(this.wrapU=U.CLAMP_ADDRESSMODE,this.wrapV=U.CLAMP_ADDRESSMODE,this._generateMipMaps=!1),this._texture=this._getEngine().createDynamicTexture(this.video.videoWidth,this.video.videoHeight,this._generateMipMaps,this.samplingMode),this._texture.format=null!==(f=this._format)&&void 0!==f?f:5,this._frameId=-1,this._updateInternalTexture()},this._createInternalTexture=()=>{if(null!=this._texture){if(!this._displayingPosterTexture)return;this._displayingPosterTexture=!1}if(this.video.addEventListener("resize",this._resizeInternalTexture),this._resizeInternalTexture(),this.video.autoplay||this._settings.poster||this._settings.independentVideoSource)this._updateInternalTexture(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this);else{const f=this.video.onplaying,p=this.video.muted;this.video.muted=!0,this.video.onplaying=()=>{this.video.muted=p,this.video.onplaying=f,this._updateInternalTexture(),this._errorFound||this.video.pause(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._handlePlay()}},this._reset=()=>{null!=this._texture&&(this._displayingPosterTexture||(this._texture.dispose(),this._texture=null))},this._updateInternalTexture=()=>{if(null==this._texture||this.video.readyState<this.video.HAVE_CURRENT_DATA||this._displayingPosterTexture)return;const f=this.getScene().getFrameId();this._frameId!==f&&(this._frameId=f,this._getEngine().updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:this.video,this._invertY))},this._settings={autoPlay:!0,loop:!0,autoUpdateTexture:!0,...a},this._onError=l,this._generateMipMaps=s,this._initialSamplingMode=o,this.autoUpdateTexture=this._settings.autoUpdateTexture,this._currentSrc=t,this.name=e||this._getName(t),this.video=this._getVideo(t),this._externalTexture=null!==(u=null===(h=this._engine)||void 0===h?void 0:h.createExternalTexture(this.video))&&void 0!==u?u:null,this._settings.independentVideoSource||(this._settings.poster&&(this.video.poster=this._settings.poster),void 0!==this._settings.autoPlay&&(this.video.autoplay=this._settings.autoPlay),void 0!==this._settings.loop&&(this.video.loop=this._settings.loop),void 0!==this._settings.muted&&(this.video.muted=this._settings.muted),this.video.setAttribute("playsinline",""),this.video.addEventListener("paused",this._updateInternalTexture),this.video.addEventListener("seeked",this._updateInternalTexture),this.video.addEventListener("emptied",this._reset),this._settings.autoPlay&&this._handlePlay()),this._createInternalTextureOnEvent=this._settings.poster&&!this._settings.autoPlay?"play":"canplay",this.video.addEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._format=c;const d=this.video.readyState>=this.video.HAVE_CURRENT_DATA;!this._settings.poster||this._settings.autoPlay&&d?d&&this._createInternalTexture():(this._texture=this._getEngine().createTexture(this._settings.poster,!1,!this.invertY,i),this._displayingPosterTexture=!0)}getClassName(){return"VideoTexture"}_getName(e){return e instanceof HTMLVideoElement?e.currentSrc:"object"==typeof e?e.toString():e}_getVideo(e){if(e.isNative)return e;if(e instanceof HTMLVideoElement)return q.SetCorsBehavior(e.currentSrc,e),e;const t=document.createElement("video");return"string"==typeof e?(q.SetCorsBehavior(e,t),t.src=e):(q.SetCorsBehavior(e[0],t),e.forEach(i=>{const s=document.createElement("source");s.src=i,t.appendChild(s)})),this.onDisposeObservable.addOnce(()=>{B3(t)}),t}_rebuild(){this.update()}update(){!this.autoUpdateTexture||this.updateTexture(!0)}updateTexture(e){!e||this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture())}updateURL(e){this.video.src=e,this._currentSrc=e}clone(){return new Zv(this.name,this._currentSrc,this.getScene(),this._generateMipMaps,this.invertY,this.samplingMode,this._settings)}dispose(){var e;super.dispose(),this._currentSrc=null,this._onUserActionRequestedObservable&&(this._onUserActionRequestedObservable.clear(),this._onUserActionRequestedObservable=null),this.video.removeEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._settings.independentVideoSource||(this.video.removeEventListener("paused",this._updateInternalTexture),this.video.removeEventListener("seeked",this._updateInternalTexture),this.video.removeEventListener("emptied",this._reset),this.video.removeEventListener("resize",this._resizeInternalTexture),this.video.pause()),null===(e=this._externalTexture)||void 0===e||e.dispose()}static CreateFromStreamAsync(e,t,i,s=!0){const n=e.getEngine().createVideoElement(i);return e.getEngine()._badOS&&(document.body.appendChild(n),n.style.transform="scale(0.0001, 0.0001)",n.style.opacity="0",n.style.position="fixed",n.style.bottom="0px",n.style.right="0px"),n.setAttribute("autoplay",""),n.setAttribute("muted","true"),n.setAttribute("playsinline",""),n.muted=!0,n.isNative||(void 0!==n.mozSrcObject?n.mozSrcObject=t:"object"==typeof n.srcObject?n.srcObject=t:n.src=window.URL&&window.URL.createObjectURL(t)),new Promise(o=>{const a=()=>{const l=new Zv("video",n,e,!0,s,void 0,void 0,void 0,4);e.getEngine()._badOS&&l.onDisposeObservable.addOnce(()=>{n.remove()}),l.onDisposeObservable.addOnce(()=>{B3(n)}),o(l),n.removeEventListener("playing",a)};n.addEventListener("playing",a),n.play()})}static CreateFromWebCamAsync(e,t,i=!1,s=!0){var n=this;return Qt(function*(){if(navigator.mediaDevices){const o=yield navigator.mediaDevices.getUserMedia({video:t,audio:i}),a=yield n.CreateFromStreamAsync(e,o,t,s);return a.onDisposeObservable.addOnce(()=>{o.getTracks().forEach(l=>{l.stop()})}),a}return Promise.reject("No support for userMedia on this device")})()}static CreateFromWebCam(e,t,i,s=!1,n=!0){this.CreateFromWebCamAsync(e,i,s,n).then(function(o){t&&t(o)}).catch(function(o){V.Error(o.name)})}}class OC extends cc{get videoTexture(){return this._texture}get videoMode(){return this.textureMode}set videoMode(e){this.textureMode=e}_initTexture(e,t,i){const n=new Zv((this.name||"videoDome")+"_texture",e,t,i.generateMipMaps,this._useDirectMapping,U.TRILINEAR_SAMPLINGMODE,{loop:i.loop,autoPlay:i.autoPlay,autoUpdateTexture:!0,poster:i.poster});return i.clickToPlay&&(this._pointerObserver=t.onPointerObservable.add(o=>{var a;(null===(a=o.pickInfo)||void 0===a?void 0:a.pickedMesh)===this.mesh&&this._texture.video.play()},Re.POINTERDOWN)),this._textureObserver=n.onLoadObservable.add(()=>{this.onLoadObservable.notifyObservers()}),n}dispose(e,t=!1){this._texture.onLoadObservable.remove(this._textureObserver),this._scene.onPointerObservable.remove(this._pointerObserver),super.dispose(e,t)}}OC.MODE_MONOSCOPIC=cc.MODE_MONOSCOPIC,OC.MODE_TOPBOTTOM=cc.MODE_TOPBOTTOM,OC.MODE_SIDEBYSIDE=cc.MODE_SIDEBYSIDE;j.ShadersStore.glowMapGenerationPixelShader="#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)\n#include<helperFunctions>\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;\nuniform sampler2D opacitySampler;\nuniform float opacityIntensity;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform sampler2D emissiveSampler;\n#endif\n#ifdef VERTEXALPHA\nvarying vec4 vColor;\n#endif\nuniform vec4 glowColor;\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\nvec4 finalColor=glowColor;\n#ifdef DIFFUSE\nvec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);\n#ifdef DIFFUSE_ISLINEAR\nalbedoTexture=toGammaSpace(albedoTexture);\n#endif\n#ifdef GLOW\nfinalColor.a*=albedoTexture.a;\n#endif\n#ifdef HIGHLIGHT\nfinalColor.a=albedoTexture.a;\n#endif\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vUVOpacity);\n#ifdef OPACITYRGB\nfinalColor.a*=getLuminance(opacityMap.rgb);\n#else\nfinalColor.a*=opacityMap.a;\n#endif\nfinalColor.a*=opacityIntensity;\n#endif\n#ifdef VERTEXALPHA\nfinalColor.a*=vColor.a;\n#endif\n#ifdef ALPHATEST\nif (finalColor.a<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifdef EMISSIVE\nvec4 emissive=texture2D(emissiveSampler,vUVEmissive);\n#ifdef EMISSIVE_ISLINEAR\nemissive=toGammaSpace(emissive);\n#endif\ngl_FragColor=emissive*finalColor;\n#else\ngl_FragColor=finalColor;\n#endif\n#ifdef HIGHLIGHT\ngl_FragColor.a=glowColor.a;\n#endif\n}";j.ShadersStore.glowMapGenerationVertexShader="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nvarying vec4 vPosition;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;\nuniform mat4 opacityMatrix;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef VERTEXALPHA\nattribute vec4 color;\nvarying vec4 vColor;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef CUBEMAP\nvPosition=worldPos;\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#else\nvPosition=viewProjection*worldPos;\ngl_Position=vPosition;\n#endif\n#ifdef DIFFUSE\n#ifdef DIFFUSEUV1\nvUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef DIFFUSEUV2\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef OPACITY\n#ifdef OPACITYUV1\nvUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef OPACITYUV2\nvUVOpacity=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef EMISSIVEUV2\nvUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef VERTEXALPHA\nvColor=color;\n#endif\n#include<clipPlaneVertex>\n}";class $n{get camera(){return this._effectLayerOptions.camera}get renderingGroupId(){return this._effectLayerOptions.renderingGroupId}set renderingGroupId(e){this._effectLayerOptions.renderingGroupId=e}get mainTexture(){return this._mainTexture}setMaterialForRendering(e,t){if(this._mainTexture.setMaterialForRendering(e,t),Array.isArray(e))for(let i=0;i<e.length;++i){const s=e[i];t?this._materialForRendering[s.uniqueId]=[s,t]:delete this._materialForRendering[s.uniqueId]}else t?this._materialForRendering[e.uniqueId]=[e,t]:delete this._materialForRendering[e.uniqueId]}constructor(e,t){this._vertexBuffers={},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._shouldRender=!0,this._postProcesses=[],this._textures=[],this._emissiveTextureAndColor={texture:null,color:new Te},this.neutralColor=new Te,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new z,this.onBeforeRenderMainTextureObservable=new z,this.onBeforeComposeObservable=new z,this.onBeforeRenderMeshToEffect=new z,this.onAfterRenderMeshToEffect=new z,this.onAfterComposeObservable=new z,this.onSizeChangedObservable=new z,this._materialForRendering={},this.name=e,this._scene=t||be.LastCreatedScene,$n._SceneComponentInitialization(this._scene),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.effectLayers.push(this),this._mergeDrawWrapper=[],this._generateIndexBuffer(),this._generateVertexBuffer()}_numInternalDraws(){return 1}_init(e){this._effectLayerOptions={mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,...e},this._setMainTextureSize(),this._createMainTexture(),this._createTextureAndPostProcesses()}_generateIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._engine.createIndexBuffer(e)}_generateVertexBuffer(){const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1);const t=new A(this._engine,e,A.PositionKind,!1,!1,2);this._vertexBuffers[A.PositionKind]=t}_setMainTextureSize(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?ee.GetExponentOfTwo(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?ee.GetExponentOfTwo(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)}_createMainTexture(){this._mainTexture=new Ss("EffectLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,this._effectLayerOptions.mainTextureType),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=U.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=U.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(U.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0;for(const e in this._materialForRendering){const[t,i]=this._materialForRendering[e];this._mainTexture.setMaterialForRendering(t,i)}if(this._mainTexture.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let s=0;s<e.subMeshes.length;++s){const n=e.subMeshes[s],o=n.getMaterial(),a=n.getRenderingMesh();if(!o)continue;const c=a._getInstancesRenderList(n._id,!!n.getReplacementMesh()).hardwareInstancedRendering[n._id]||a.hasThinInstances;if(this._setEmissiveTextureAndColor(a,n,o),!this._isReady(n,c,this._emissiveTextureAndColor.texture))return!1}return!0},this._mainTexture.customRenderFunction=(e,t,i,s)=>{let n;this.onBeforeRenderMainTextureObservable.notifyObservers(this);const o=this._scene.getEngine();if(s.length){for(o.setColorWrite(!1),n=0;n<s.length;n++)this._renderSubMesh(s.data[n]);o.setColorWrite(!0)}for(n=0;n<e.length;n++)this._renderSubMesh(e.data[n]);for(n=0;n<t.length;n++)this._renderSubMesh(t.data[n]);const a=o.getAlphaMode();for(n=0;n<i.length;n++)this._renderSubMesh(i.data[n],!0);o.setAlphaMode(a)},this._mainTexture.onClearObservable.add(e=>{e.clear(this.neutralColor,!0,!0,!0)}),this._scene.getBoundingBoxRenderer){const e=this._scene.getBoundingBoxRenderer().enabled;this._mainTexture.onBeforeBindObservable.add(()=>{this._scene.getBoundingBoxRenderer().enabled=!this.disableBoundingBoxesFromEffectLayer&&e}),this._mainTexture.onAfterUnbindObservable.add(()=>{this._scene.getBoundingBoxRenderer().enabled=e})}}_addCustomEffectDefines(e){}_isReady(e,t,i){var s;const n=this._scene.getEngine(),o=e.getMesh(),a=null===(s=o._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===s?void 0:s[n.currentRenderPassId];if(a)return a.isReadyForSubMesh(o,e,t);const l=e.getMaterial();if(!l)return!1;if(this._useMeshMaterial(e.getRenderingMesh()))return l.isReadyForSubMesh(e.getMesh(),e,t);const c=[],h=[A.PositionKind];let u=!1,d=!1;if(l){const y=l.needAlphaTesting(),T=l.getAlphaTestTexture(),x=T&&T.hasAlpha&&(l.useAlphaFromDiffuseTexture||l._useAlphaFromAlbedoTexture);T&&(y||x)&&(c.push("#define DIFFUSE"),o.isVerticesDataPresent(A.UV2Kind)&&1===T.coordinatesIndex?(c.push("#define DIFFUSEUV2"),d=!0):o.isVerticesDataPresent(A.UVKind)&&(c.push("#define DIFFUSEUV1"),u=!0),y&&(c.push("#define ALPHATEST"),c.push("#define ALPHATESTVALUE 0.4")),T.gammaSpace||c.push("#define DIFFUSE_ISLINEAR"));const S=l.opacityTexture;S&&(c.push("#define OPACITY"),o.isVerticesDataPresent(A.UV2Kind)&&1===S.coordinatesIndex?(c.push("#define OPACITYUV2"),d=!0):o.isVerticesDataPresent(A.UVKind)&&(c.push("#define OPACITYUV1"),u=!0))}i&&(c.push("#define EMISSIVE"),o.isVerticesDataPresent(A.UV2Kind)&&1===i.coordinatesIndex?(c.push("#define EMISSIVEUV2"),d=!0):o.isVerticesDataPresent(A.UVKind)&&(c.push("#define EMISSIVEUV1"),u=!0),i.gammaSpace||c.push("#define EMISSIVE_ISLINEAR")),o.useVertexColors&&o.isVerticesDataPresent(A.ColorKind)&&o.hasVertexAlpha&&l.transparencyMode!==ie.MATERIAL_OPAQUE&&(h.push(A.ColorKind),c.push("#define VERTEXALPHA")),u&&(h.push(A.UVKind),c.push("#define UV1")),d&&(h.push(A.UV2Kind),c.push("#define UV2"));const f=new oh;if(o.useBones&&o.computeBonesUsingShaders){h.push(A.MatricesIndicesKind),h.push(A.MatricesWeightsKind),o.numBoneInfluencers>4&&(h.push(A.MatricesIndicesExtraKind),h.push(A.MatricesWeightsExtraKind)),c.push("#define NUM_BONE_INFLUENCERS "+o.numBoneInfluencers);const y=o.skeleton;c.push(y&&y.isUsingTextureForMatrices?"#define BONETEXTURE":"#define BonesPerMesh "+(y?y.bones.length+1:0)),o.numBoneInfluencers>0&&f.addCPUSkinningFallback(0,o)}else c.push("#define NUM_BONE_INFLUENCERS 0");const p=o.morphTargetManager;let _=0;p&&p.numInfluencers>0&&(c.push("#define MORPHTARGETS"),_=p.numInfluencers,c.push("#define NUM_MORPH_INFLUENCERS "+_),p.isUsingTextureForTargets&&c.push("#define MORPHTARGETS_TEXTURE"),ce.PrepareAttributesForMorphTargetsInfluencers(h,o,_)),t&&(c.push("#define INSTANCES"),ce.PushAttributesForInstances(h),e.getRenderingMesh().hasThinInstances&&c.push("#define THIN_INSTANCES")),Za(l,this._scene,c),this._addCustomEffectDefines(c);const m=e._getDrawWrapper(void 0,!0),g=m.defines,b=c.join("\n");if(g!==b){const y=["world","mBones","viewProjection","glowColor","morphTargetInfluences","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices"];Uo(y),m.setEffect(this._engine.createEffect("glowMapGeneration",h,y,["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],b,f,void 0,void 0,{maxSimultaneousMorphTargets:_}),b)}return m.effect.isReady()}render(){for(let o=0;o<this._postProcesses.length;o++)if(!this._postProcesses[o].isReady())return;const e=this._scene.getEngine(),t=this._numInternalDraws();let i=!0;for(let o=0;o<t;++o){let a=this._mergeDrawWrapper[o];a||(a=this._mergeDrawWrapper[o]=new $i(this._engine),a.setEffect(this._createMergeEffect())),i=i&&a.effect.isReady()}if(!i)return;this.onBeforeComposeObservable.notifyObservers(this);const s=e.getAlphaMode();for(let o=0;o<t;++o){const a=this._mergeDrawWrapper[o];e.enableEffect(a),e.setState(!1),e.bindBuffers(this._vertexBuffers,this._indexBuffer,a.effect),e.setAlphaMode(this._effectLayerOptions.alphaBlendingMode),this._internalRender(a.effect,o)}e.setAlphaMode(s),this.onAfterComposeObservable.notifyObservers(this);const n=this._mainTexture.getSize();this._setMainTextureSize(),(n.width!==this._mainTextureDesiredSize.width||n.height!==this._mainTextureDesiredSize.height)&&0!==this._mainTextureDesiredSize.width&&0!==this._mainTextureDesiredSize.height&&(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses())}hasMesh(e){return-1===this.renderingGroupId||e.renderingGroupId===this.renderingGroupId}shouldRender(){return this.isEnabled&&this._shouldRender}_shouldRenderMesh(e){return!0}_canRenderMesh(e,t){return!t.needAlphaBlendingForMesh(e)}_shouldRenderEmissiveTextureForMesh(){return!0}_renderSubMesh(e,t=!1){var i,s;if(!this.shouldRender())return;const n=e.getMaterial(),o=e.getMesh(),a=e.getReplacementMesh(),l=e.getRenderingMesh(),c=e.getEffectiveMesh(),h=this._scene,u=h.getEngine();if(c._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!n||!this._canRenderMesh(l,n))return;let d=null!==(i=l.overrideMaterialSideOrientation)&&void 0!==i?i:n.sideOrientation;c._getWorldMatrixDeterminant()<0&&(d=d===ie.ClockWiseSideOrientation?ie.CounterClockWiseSideOrientation:ie.ClockWiseSideOrientation),u.setState(n.backFaceCulling,n.zOffset,void 0,d===ie.ClockWiseSideOrientation,n.cullBackFaces,void 0,n.zOffsetUnits);const _=l._getInstancesRenderList(e._id,!!a);if(_.mustReturn||!this._shouldRenderMesh(l))return;const m=_.hardwareInstancedRendering[e._id]||l.hasThinInstances;if(this._setEmissiveTextureAndColor(l,e,n),this.onBeforeRenderMeshToEffect.notifyObservers(o),this._useMeshMaterial(l))l.render(e,t,a||void 0);else if(this._isReady(e,m,this._emissiveTextureAndColor.texture)){const g=null===(s=c._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===s?void 0:s[u.currentRenderPassId];let b=e._getDrawWrapper();if(!b&&g&&(b=g._getDrawWrapper()),!b)return;const y=b.effect;if(u.enableEffect(b),m||l._bind(e,y,h.forcePointsCloud?ie.PointFillMode:h.forceWireframe?ie.WireFrameFillMode:n.fillMode),g?g.bindForSubMesh(c.getWorldMatrix(),c,e):(y.setMatrix("viewProjection",h.getTransformMatrix()),y.setMatrix("world",c.getWorldMatrix()),y.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a)),!g){const T=n.needAlphaTesting(),x=n.getAlphaTestTexture(),S=x&&x.hasAlpha&&(n.useAlphaFromDiffuseTexture||n._useAlphaFromAlbedoTexture);if(x&&(T||S)){y.setTexture("diffuseSampler",x);const D=x.getTextureMatrix();D&&y.setMatrix("diffuseMatrix",D)}const C=n.opacityTexture;if(C){y.setTexture("opacitySampler",C),y.setFloat("opacityIntensity",C.level);const D=C.getTextureMatrix();D&&y.setMatrix("opacityMatrix",D)}if(this._emissiveTextureAndColor.texture&&(y.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),y.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),l.useBones&&l.computeBonesUsingShaders&&l.skeleton){const D=l.skeleton;if(D.isUsingTextureForMatrices){const P=D.getTransformMatrixTexture(l);if(!P)return;y.setTexture("boneSampler",P),y.setFloat("boneTextureWidth",4*(D.bones.length+1))}else y.setMatrices("mBones",D.getTransformMatrices(l))}ce.BindMorphTargetParameters(l,y),l.morphTargetManager&&l.morphTargetManager.isUsingTextureForTargets&&l.morphTargetManager._bind(y),t&&u.setAlphaMode(n.alphaMode),fo(y,n,h)}l._processRendering(c,e,y,n.fillMode,_,m,(T,x)=>y.setMatrix("world",x))}else this._mainTexture.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(o)}_useMeshMaterial(e){return!1}_rebuild(){const e=this._vertexBuffers[A.PositionKind];e&&e._rebuild(),this._generateIndexBuffer()}_disposeTextureAndPostProcesses(){this._mainTexture.dispose();for(let e=0;e<this._postProcesses.length;e++)this._postProcesses[e]&&this._postProcesses[e].dispose();this._postProcesses=[];for(let e=0;e<this._textures.length;e++)this._textures[e]&&this._textures[e].dispose();this._textures=[]}dispose(){const e=this._vertexBuffers[A.PositionKind];e&&(e.dispose(),this._vertexBuffers[A.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(const i of this._mergeDrawWrapper)i.dispose();this._mergeDrawWrapper=[],this._disposeTextureAndPostProcesses();const t=this._scene.effectLayers.indexOf(this,0);t>-1&&this._scene.effectLayers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()}getClassName(){return"EffectLayer"}static Parse(e,t,i){return q.Instantiate(e.customType).Parse(e,t,i)}}$n._SceneComponentInitialization=r=>{throw Ge("EffectLayerSceneComponent")},E([I()],$n.prototype,"name",void 0),E([sE()],$n.prototype,"neutralColor",void 0),E([I()],$n.prototype,"isEnabled",void 0),E([function hie(r){return Bn(11,r)}()],$n.prototype,"camera",null),E([I()],$n.prototype,"renderingGroupId",null),E([I()],$n.prototype,"disableBoundingBoxesFromEffectLayer",void 0),es.AddParser(Me.NAME_EFFECTLAYER,(r,e,t,i)=>{if(r.effectLayers){t.effectLayers||(t.effectLayers=new Array);for(let s=0;s<r.effectLayers.length;s++){const n=$n.Parse(r.effectLayers[s],e,i);t.effectLayers.push(n)}}}),es.prototype.removeEffectLayer=function(r){const e=this.effectLayers.indexOf(r);return-1!==e&&this.effectLayers.splice(e,1),e},es.prototype.addEffectLayer=function(r){this.effectLayers.push(r)};class jne{constructor(e){this.name=Me.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||be.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine(),this.scene.effectLayers=new Array)}register(){this.scene._isReadyForMeshStage.registerStep(Me.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(Me.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(Me.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(Me.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(Me.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(Me.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)}rebuild(){const e=this.scene.effectLayers;for(const t of e)t._rebuild()}serialize(e){e.effectLayers=[];const t=this.scene.effectLayers;for(const i of t)i.serialize&&e.effectLayers.push(i.serialize())}addFromContainer(e){!e.effectLayers||e.effectLayers.forEach(t=>{this.scene.addEffectLayer(t)})}removeFromContainer(e,t){!e.effectLayers||e.effectLayers.forEach(i=>{this.scene.removeEffectLayer(i),t&&i.dispose()})}dispose(){const e=this.scene.effectLayers;for(;e.length;)e[0].dispose()}_isReadyForMesh(e,t){const i=this._engine.currentRenderPassId,s=this.scene.effectLayers;for(const n of s)if(n.hasMesh(e)){this._engine.currentRenderPassId=n._mainTexture.renderPassId;for(const a of e.subMeshes)if(!n.isReady(a,t))return this._engine.currentRenderPassId=i,!1}return this._engine.currentRenderPassId=i,!0}_renderMainTexture(e){this._renderEffects=!1,this._needStencil=!1;let t=!1;const i=this.scene.effectLayers;if(i&&i.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(const s of i)if(s.shouldRender()&&(!s.camera||s.camera.cameraRigMode===ve.RIG_MODE_NONE&&e===s.camera||s.camera.cameraRigMode!==ve.RIG_MODE_NONE&&s.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||s.needStencil();const n=s._mainTexture;n._shouldRender()&&(this.scene.incrementRenderId(),n.render(!1,!1),t=!0)}this.scene.incrementRenderId()}return t}_setStencil(){this._needStencil&&this._engine.setStencilBuffer(!0)}_setStencilBack(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)}_draw(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);const t=this.scene.effectLayers;for(let i=0;i<t.length;i++){const s=t[i];s.renderingGroupId===e&&s.shouldRender()&&s.render()}this._engine.setDepthBuffer(!0)}}_drawCamera(){this._renderEffects&&this._draw(-1)}_drawRenderingGroup(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)}}$n._SceneComponentInitialization=r=>{let e=r._getComponent(Me.NAME_EFFECTLAYER);e||(e=new jne(r),r._addComponent(e))};j.ShadersStore.glowMapMergePixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#ifdef EMISSIVE\nuniform sampler2D textureSampler2;\n#endif\nuniform float offset;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef EMISSIVE\nbaseColor+=texture2D(textureSampler2,vUV);\nbaseColor*=offset;\n#else\nbaseColor.a=abs(offset-baseColor.a);\n#ifdef STROKE\nfloat alpha=smoothstep(.0,.1,baseColor.a);\nbaseColor.a=alpha;\nbaseColor.rgb=baseColor.rgb*alpha;\n#endif\n#endif\n#if LDR\nbaseColor=clamp(baseColor,0.,1.0);\n#endif\ngl_FragColor=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";j.ShadersStore.glowMapMergeVertexShader="attribute vec2 position;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}",es.prototype.getGlowLayerByName=function(r){var e;for(let t=0;t<(null===(e=this.effectLayers)||void 0===e?void 0:e.length);t++)if(this.effectLayers[t].name===r&&this.effectLayers[t].getEffectName()===Kn.EffectName)return this.effectLayers[t];return null};class Kn extends $n{set blurKernelSize(e){if(e===this._options.blurKernelSize)return;this._options.blurKernelSize=e;const t=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1.kernel=t,this._verticalBlurPostprocess1.kernel=t,this._horizontalBlurPostprocess2.kernel=t,this._verticalBlurPostprocess2.kernel=t}get blurKernelSize(){return this._options.blurKernelSize}set intensity(e){this._intensity=e}get intensity(){return this._intensity}constructor(e,t,i){super(e,t),this._intensity=1,this._includedOnlyMeshes=[],this._excludedMeshes=[],this._meshesUsingTheirOwnMaterials=[],this.neutralColor=new Te(0,0,0,1),this._options={mainTextureRatio:Kn.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,mainTextureType:0,...i},this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType})}getEffectName(){return Kn.EffectName}_createMergeEffect(){let e="#define EMISSIVE \n";return this._options.ldrMerge&&(e+="#define LDR \n"),this._engine.createEffect("glowMapMerge",[A.PositionKind],["offset"],["textureSampler","textureSampler2"],e)}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width,t=this._mainTextureDesiredSize.height;e=this._engine.needPOTTextures?ee.GetExponentOfTwo(e,this._maxSize):e,t=this._engine.needPOTTextures?ee.GetExponentOfTwo(t,this._maxSize):t;let i=0;i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture1=new Ss("GlowLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture1.wrapU=U.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=U.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode(U.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;const s=Math.floor(e/2),n=Math.floor(t/2);this._blurTexture2=new Ss("GlowLayerBlurRTT2",{width:s,height:n},this._scene,!1,!0,i),this._blurTexture2.wrapU=U.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=U.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode(U.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2];const o=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1=new _s("GlowLayerHBP1",new de(1,0),o,{width:e,height:t},null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess1.width=e,this._horizontalBlurPostprocess1.height=t,this._horizontalBlurPostprocess1.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess1.onApplyObservable.add(a=>{a.setTexture("textureSampler",this._mainTexture)}),this._verticalBlurPostprocess1=new _s("GlowLayerVBP1",new de(0,1),o,{width:e,height:t},null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2=new _s("GlowLayerHBP2",new de(1,0),o,{width:s,height:n},null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2.width=s,this._horizontalBlurPostprocess2.height=n,this._horizontalBlurPostprocess2.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess2.onApplyObservable.add(a=>{a.setTexture("textureSampler",this._blurTexture1)}),this._verticalBlurPostprocess2=new _s("GlowLayerVBP2",new de(0,1),o,{width:s,height:n},null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add(()=>{const a=this._blurTexture1.renderTarget;if(a){this._scene.postProcessManager.directRender(this._postProcesses1,a,!0);const l=this._blurTexture2.renderTarget;l&&this._scene.postProcessManager.directRender(this._postProcesses2,l,!0),this._engine.unBindFramebuffer(l??a,!0)}}),this._postProcesses.map(a=>{a.autoClear=!1})}_getEffectiveBlurKernelSize(){return this._options.blurKernelSize/2}isReady(e,t){const i=e.getMaterial(),s=e.getRenderingMesh();return!(!i||!s)&&super._isReady(e,t,i.emissiveTexture)}needStencil(){return!1}_canRenderMesh(e,t){return!0}_internalRender(e){e.setTexture("textureSampler",this._blurTexture1),e.setTexture("textureSampler2",this._blurTexture2),e.setFloat("offset",this._intensity);const t=this._engine,i=t.getStencilBuffer();t.setStencilBuffer(!1),t.drawElementsType(ie.TriangleFillMode,0,6),t.setStencilBuffer(i)}_setEmissiveTextureAndColor(e,t,i){var s;let n=1;this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(e,t,i):i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.texture&&(n=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector?this.customEmissiveColorSelector(e,t,i,this._emissiveTextureAndColor.color):i.emissiveColor?(n*=null!==(s=i.emissiveIntensity)&&void 0!==s?s:1,this._emissiveTextureAndColor.color.set(i.emissiveColor.r*n,i.emissiveColor.g*n,i.emissiveColor.b*n,i.alpha)):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}_shouldRenderMesh(e){return this.hasMesh(e)}_addCustomEffectDefines(e){e.push("#define GLOW")}addExcludedMesh(e){-1===this._excludedMeshes.indexOf(e.uniqueId)&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);-1!==t&&this._excludedMeshes.splice(t,1)}addIncludedOnlyMesh(e){-1===this._includedOnlyMeshes.indexOf(e.uniqueId)&&this._includedOnlyMeshes.push(e.uniqueId)}removeIncludedOnlyMesh(e){const t=this._includedOnlyMeshes.indexOf(e.uniqueId);-1!==t&&this._includedOnlyMeshes.splice(t,1)}hasMesh(e){return!!super.hasMesh(e)&&(this._includedOnlyMeshes.length?-1!==this._includedOnlyMeshes.indexOf(e.uniqueId):!this._excludedMeshes.length||-1===this._excludedMeshes.indexOf(e.uniqueId))}_useMeshMaterial(e){return 0!=this._meshesUsingTheirOwnMaterials.length&&this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId)>-1}referenceMeshToUseItsOwnMaterial(e){e.resetDrawCache(this._mainTexture.renderPassId),this._meshesUsingTheirOwnMaterials.push(e.uniqueId),e.onDisposeObservable.add(()=>{this._disposeMesh(e)})}unReferenceMeshFromUsingItsOwnMaterial(e){let t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);for(;t>=0;)this._meshesUsingTheirOwnMaterials.splice(t,1),t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);e.resetDrawCache(this._mainTexture.renderPassId)}_disposeMesh(e){this.removeIncludedOnlyMesh(e),this.removeExcludedMesh(e)}getClassName(){return"GlowLayer"}serialize(){const e=Ce.Serialize(this);let t;if(e.customType="BABYLON.GlowLayer",e.includedMeshes=[],this._includedOnlyMeshes.length)for(t=0;t<this._includedOnlyMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._includedOnlyMeshes[t]);i&&e.includedMeshes.push(i.id)}if(e.excludedMeshes=[],this._excludedMeshes.length)for(t=0;t<this._excludedMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._excludedMeshes[t]);i&&e.excludedMeshes.push(i.id)}return e}static Parse(e,t,i){const s=Ce.Parse(()=>new Kn(e.name,t,e.options),e,t,i);let n;for(n=0;n<e.excludedMeshes.length;n++){const o=t.getMeshById(e.excludedMeshes[n]);o&&s.addExcludedMesh(o)}for(n=0;n<e.includedMeshes.length;n++){const o=t.getMeshById(e.includedMeshes[n]);o&&s.addIncludedOnlyMesh(o)}return s}}Kn.EffectName="GlowLayer",Kn.DefaultBlurKernelSize=32,Kn.DefaultTextureRatio=.5,E([I()],Kn.prototype,"blurKernelSize",null),E([I()],Kn.prototype,"intensity",null),E([I("options")],Kn.prototype,"_options",void 0),le("BABYLON.GlowLayer",Kn);j.ShadersStore.glowBlurPostProcessPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\nuniform vec2 direction;\nuniform float blurWidth;\nfloat getLuminance(vec3 color)\n{\nreturn dot(color,vec3(0.2126,0.7152,0.0722));\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nfloat weights[7];\nweights[0]=0.05;\nweights[1]=0.1;\nweights[2]=0.2;\nweights[3]=0.3;\nweights[4]=0.2;\nweights[5]=0.1;\nweights[6]=0.05;\nvec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);\nvec2 texelStep=texelSize*direction*blurWidth;\nvec2 start=vUV-3.0*texelStep;\nvec4 baseColor=vec4(0.,0.,0.,0.);\nvec2 texelOffset=vec2(0.,0.);\nfor (int i=0; i<7; i++)\n{\nvec4 texel=texture2D(textureSampler,start+texelOffset);\nbaseColor.a+=texel.a*weights[i];\nfloat luminance=getLuminance(baseColor.rgb);\nfloat luminanceTexel=getLuminance(texel.rgb);\nfloat choice=step(luminanceTexel,luminance);\nbaseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;\ntexelOffset+=texelStep;\n}\ngl_FragColor=baseColor;\n}",es.prototype.getHighlightLayerByName=function(r){var e;for(let t=0;t<(null===(e=this.effectLayers)||void 0===e?void 0:e.length);t++)if(this.effectLayers[t].name===r&&this.effectLayers[t].getEffectName()===Tr.EffectName)return this.effectLayers[t];return null};class q3 extends Pe{constructor(e,t,i,s,n,o=U.BILINEAR_SAMPLINGMODE,a,l){super(e,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,s,n,o,a,l),this.direction=t,this.kernel=i,this.onApplyObservable.add(c=>{c.setFloat2("screenSize",this.width,this.height),c.setVector2("direction",this.direction),c.setFloat("blurWidth",this.kernel)})}}class Tr extends $n{set blurHorizontalSize(e){this._horizontalBlurPostprocess.kernel=e,this._options.blurHorizontalSize=e}set blurVerticalSize(e){this._verticalBlurPostprocess.kernel=e,this._options.blurVerticalSize=e}get blurHorizontalSize(){return this._horizontalBlurPostprocess.kernel}get blurVerticalSize(){return this._verticalBlurPostprocess.kernel}constructor(e,t,i){super(e,t),this.name=e,this.innerGlow=!0,this.outerGlow=!0,this.onBeforeBlurObservable=new z,this.onAfterBlurObservable=new z,this._instanceGlowingMeshStencilReference=Tr.GlowingMeshStencilReference++,this._meshes={},this._excludedMeshes={},this.neutralColor=Tr.NeutralColor,this._engine.isStencilEnable||V.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),this._options={mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,...i},this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType}),this._shouldRender=!1}getEffectName(){return Tr.EffectName}_numInternalDraws(){return 2}_createMergeEffect(){return this._engine.createEffect("glowMapMerge",[A.PositionKind],["offset"],["textureSampler"],this._options.isStroke?"#define STROKE \n":void 0)}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,t=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;e=this._engine.needPOTTextures?ee.GetExponentOfTwo(e,this._maxSize):e,t=this._engine.needPOTTextures?ee.GetExponentOfTwo(t,this._maxSize):t;let i=0;i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture=new Ss("HighlightLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture.wrapU=U.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=U.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(U.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],2===this._options.alphaBlendingMode?(this._downSamplePostprocess=new fa("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.externalTextureSamplerBinding=!0,this._downSamplePostprocess.onApplyObservable.add(s=>{s.setTexture("textureSampler",this._mainTexture)}),this._horizontalBlurPostprocess=new q3("HighlightLayerHBP",new de(1,0),this._options.blurHorizontalSize,1,null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add(s=>{s.setFloat2("screenSize",e,t)}),this._verticalBlurPostprocess=new q3("HighlightLayerVBP",new de(0,1),this._options.blurVerticalSize,1,null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add(s=>{s.setFloat2("screenSize",e,t)}),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new _s("HighlightLayerHBP",new de(1,0),this._options.blurHorizontalSize/2,{width:e,height:t},null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess.width=e,this._horizontalBlurPostprocess.height=t,this._horizontalBlurPostprocess.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess.onApplyObservable.add(s=>{s.setTexture("textureSampler",this._mainTexture)}),this._verticalBlurPostprocess=new _s("HighlightLayerVBP",new de(0,1),this._options.blurVerticalSize/2,{width:e,height:t},null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]),this._mainTexture.onAfterUnbindObservable.add(()=>{this.onBeforeBlurObservable.notifyObservers(this);const s=this._blurTexture.renderTarget;s&&(this._scene.postProcessManager.directRender(this._postProcesses,s,!0),this._engine.unBindFramebuffer(s,!0)),this.onAfterBlurObservable.notifyObservers(this)}),this._postProcesses.map(s=>{s.autoClear=!1})}needStencil(){return!0}isReady(e,t){const i=e.getMaterial(),s=e.getRenderingMesh();if(!i||!s||!this._meshes)return!1;let n=null;const o=this._meshes[s.uniqueId];return o&&o.glowEmissiveOnly&&i&&(n=i.emissiveTexture),super._isReady(e,t,n)}_internalRender(e,t){e.setTexture("textureSampler",this._blurTexture);const i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&0===t&&(e.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(ie.TriangleFillMode,0,6)),this.innerGlow&&1===t&&(e.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(ie.TriangleFillMode,0,6)),i.restoreStencilState()}shouldRender(){return!!super.shouldRender()&&!!this._meshes}_shouldRenderMesh(e){return!(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]||!super.hasMesh(e))}_canRenderMesh(e,t){return!0}_addCustomEffectDefines(e){e.push("#define HIGHLIGHT")}_setEmissiveTextureAndColor(e,t,i){const s=this._meshes[e.uniqueId];s?this._emissiveTextureAndColor.color.set(s.color.r,s.color.g,s.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),s&&s.glowEmissiveOnly&&i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null}addExcludedMesh(e){this._excludedMeshes&&(this._excludedMeshes[e.uniqueId]||(this._excludedMeshes[e.uniqueId]={mesh:e,beforeBind:e.onBeforeBindObservable.add(i=>{i.getEngine().setStencilBuffer(!1)}),afterRender:e.onAfterRenderObservable.add(i=>{i.getEngine().setStencilBuffer(!0)})}))}removeExcludedMesh(e){if(!this._excludedMeshes)return;const t=this._excludedMeshes[e.uniqueId];t&&(t.beforeBind&&e.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&e.onAfterRenderObservable.remove(t.afterRender)),this._excludedMeshes[e.uniqueId]=null}hasMesh(e){return!(!this._meshes||!super.hasMesh(e))&&null!=this._meshes[e.uniqueId]}addMesh(e,t,i=!1){if(!this._meshes)return;const s=this._meshes[e.uniqueId];s?s.color=t:(this._meshes[e.uniqueId]={mesh:e,color:t,observerHighlight:e.onBeforeBindObservable.add(n=>{this.isEnabled&&(this._excludedMeshes&&this._excludedMeshes[n.uniqueId]?this._defaultStencilReference(n):n.getScene().getEngine().setStencilFunctionReference(this._instanceGlowingMeshStencilReference))}),observerDefault:e.onAfterRenderObservable.add(n=>{this.isEnabled&&this._defaultStencilReference(n)}),glowEmissiveOnly:i},e.onDisposeObservable.add(()=>{this._disposeMesh(e)})),this._shouldRender=!0}removeMesh(e){if(!this._meshes)return;const t=this._meshes[e.uniqueId];t&&(t.observerHighlight&&e.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&e.onAfterRenderObservable.remove(t.observerDefault),delete this._meshes[e.uniqueId]),this._shouldRender=!1;for(const i in this._meshes)if(this._meshes[i]){this._shouldRender=!0;break}}removeAllMeshes(){if(this._meshes)for(const e in this._meshes)if(Object.prototype.hasOwnProperty.call(this._meshes,e)){const t=this._meshes[e];t&&this.removeMesh(t.mesh)}}_defaultStencilReference(e){e.getScene().getEngine().setStencilFunctionReference(Tr.NormalMeshStencilReference)}_disposeMesh(e){this.removeMesh(e),this.removeExcludedMesh(e)}dispose(){if(this._meshes){for(const e in this._meshes){const t=this._meshes[e];t&&t.mesh&&(t.observerHighlight&&t.mesh.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&t.mesh.onAfterRenderObservable.remove(t.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(const e in this._excludedMeshes){const t=this._excludedMeshes[e];t&&(t.beforeBind&&t.mesh.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&t.mesh.onAfterRenderObservable.remove(t.afterRender))}this._excludedMeshes=null}super.dispose()}getClassName(){return"HighlightLayer"}serialize(){const e=Ce.Serialize(this);if(e.customType="BABYLON.HighlightLayer",e.meshes=[],this._meshes)for(const t in this._meshes){const i=this._meshes[t];i&&e.meshes.push({glowEmissiveOnly:i.glowEmissiveOnly,color:i.color.asArray(),meshId:i.mesh.id})}if(e.excludedMeshes=[],this._excludedMeshes)for(const t in this._excludedMeshes){const i=this._excludedMeshes[t];i&&e.excludedMeshes.push(i.mesh.id)}return e}static Parse(e,t,i){const s=Ce.Parse(()=>new Tr(e.name,t,e.options),e,t,i);let n;for(n=0;n<e.excludedMeshes.length;n++){const o=t.getMeshById(e.excludedMeshes[n]);o&&s.addExcludedMesh(o)}for(n=0;n<e.meshes.length;n++){const o=e.meshes[n],a=t.getMeshById(o.meshId);a&&s.addMesh(a,re.FromArray(o.color),o.glowEmissiveOnly)}return s}}Tr.EffectName="HighlightLayer",Tr.NeutralColor=new Te(0,0,0,0),Tr.GlowingMeshStencilReference=2,Tr.NormalMeshStencilReference=1,E([I()],Tr.prototype,"innerGlow",void 0),E([I()],Tr.prototype,"outerGlow",void 0),E([I()],Tr.prototype,"blurHorizontalSize",null),E([I()],Tr.prototype,"blurVerticalSize",null),E([I("options")],Tr.prototype,"_options",void 0),le("BABYLON.HighlightLayer",Tr);j.ShadersStore.layerPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec4 color;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef LINEAR\nbaseColor.rgb=toGammaSpace(baseColor.rgb);\n#endif\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=baseColor*color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";j.ShadersStore.layerVertexShader="attribute vec2 position;\nuniform vec2 scale;\nuniform vec2 offset;\nuniform mat4 textureMatrix;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec2 shiftedPosition=position*scale+offset;\nvUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));\ngl_Position=vec4(shiftedPosition,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class NC{static AddFlare(e,t,i,s,n){return new NC(e,t,i,s,n)}constructor(e,t,i,s,n){this.size=e,this.position=t,this.alphaMode=6,this.color=i||new re(1,1,1),this.texture=s?new U(s,n.getScene(),!0):null,this._system=n;const o=n.scene.getEngine();this._drawWrapper=new $i(o),this._drawWrapper.effect=o.createEffect("lensFlare",[A.PositionKind],["color","viewportMatrix"],["textureSampler"],""),n.lensFlares.push(this)}dispose(){this.texture&&this.texture.dispose();const e=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(e,1)}}j.ShadersStore.lensFlarePixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec4 color;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\ngl_FragColor=baseColor*color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";j.ShadersStore.lensFlareVertexShader="attribute vec2 position;\nuniform mat4 viewportMatrix;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=position*madd+madd;\ngl_Position=viewportMatrix*vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";let sG=(()=>{class r{get scene(){return this._scene}constructor(t,i,s){this.name=t,this.lensFlares=new Array,this.borderLimit=300,this.viewportBorder=0,this.layerMask=268435455,this._vertexBuffers={},this._isEnabled=!0,this._scene=s||be.LastCreatedScene,r._SceneComponentInitialization(this._scene),this._emitter=i,this.id=t,s.lensFlareSystems.push(this),this.meshesSelectionPredicate=a=>s.activeCamera&&a.material&&a.isVisible&&a.isEnabled()&&a.isBlocker&&0!=(a.layerMask&s.activeCamera.layerMask);const n=s.getEngine(),o=[];o.push(1,1),o.push(-1,1),o.push(-1,-1),o.push(1,-1),this._vertexBuffers[A.PositionKind]=new A(n,o,A.PositionKind,!1,!1,2),this._createIndexBuffer()}_createIndexBuffer(){const t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(t)}get isEnabled(){return this._isEnabled}set isEnabled(t){this._isEnabled=t}getScene(){return this._scene}getEmitter(){return this._emitter}setEmitter(t){this._emitter=t}getEmitterPosition(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position}computeEffectivePosition(t){let i=this.getEmitterPosition();i=v.Project(i,F.Identity(),this._scene.getTransformMatrix(),t),this._positionX=i.x,this._positionY=i.y,i=v.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),this.viewportBorder>0&&(t.x-=this.viewportBorder,t.y-=this.viewportBorder,t.width+=2*this.viewportBorder,t.height+=2*this.viewportBorder,i.x+=this.viewportBorder,i.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder);const s=this._scene.useRightHandedSystem;return!!(i.z>0&&!s||i.z<0&&s)}_isVisible(){if(!this._isEnabled||!this._scene.activeCamera)return!1;const i=this.getEmitterPosition().subtract(this._scene.activeCamera.globalPosition),s=i.length();i.normalize();const n=new Qe(this._scene.activeCamera.globalPosition,i),o=this._scene.pickWithRay(n,this.meshesSelectionPredicate,!0);return!o||!o.hit||o.distance>s}render(){if(!this._scene.activeCamera)return!1;const t=this._scene.getEngine(),s=this._scene.activeCamera.viewport.toGlobal(t.getRenderWidth(!0),t.getRenderHeight(!0));if(!this.computeEffectivePosition(s)||!this._isVisible())return!1;let n,o;n=this._positionX<this.borderLimit+s.x?this.borderLimit+s.x-this._positionX:this._positionX>s.x+s.width-this.borderLimit?this._positionX-s.x-s.width+this.borderLimit:0,o=this._positionY<this.borderLimit+s.y?this.borderLimit+s.y-this._positionY:this._positionY>s.y+s.height-this.borderLimit?this._positionY-s.y-s.height+this.borderLimit:0;let a=n>o?n:o;a-=this.viewportBorder,a>this.borderLimit&&(a=this.borderLimit);let l=1-oe.Clamp(a/this.borderLimit,0,1);if(l<0)return!1;l>1&&(l=1),this.viewportBorder>0&&(s.x+=this.viewportBorder,s.y+=this.viewportBorder,s.width-=2*this.viewportBorder,s.height-=2*this.viewportBorder,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);const c=s.x+s.width/2,h=s.y+s.height/2,u=c-this._positionX,d=h-this._positionY;t.setState(!1),t.setDepthBuffer(!1);for(let f=0;f<this.lensFlares.length;f++){const p=this.lensFlares[f];if(!p._drawWrapper.effect.isReady()||p.texture&&!p.texture.isReady())continue;t.enableEffect(p._drawWrapper),t.bindBuffers(this._vertexBuffers,this._indexBuffer,p._drawWrapper.effect),t.setAlphaMode(p.alphaMode);const _=c-u*p.position,m=h-d*p.position,g=p.size,b=p.size*t.getAspectRatio(this._scene.activeCamera,!0),x=F.FromValues(g/2,0,0,0,0,b/2,0,0,0,0,1,0,_/(s.width+2*s.x)*2-1,1-m/(s.height+2*s.y)*2,0,1);p._drawWrapper.effect.setMatrix("viewportMatrix",x),p._drawWrapper.effect.setTexture("textureSampler",p.texture),p._drawWrapper.effect.setFloat4("color",p.color.r*l,p.color.g*l,p.color.b*l,1),t.drawElementsType(ie.TriangleFillMode,0,6)}return t.setDepthBuffer(!0),t.setAlphaMode(0),!0}rebuild(){var t;this._createIndexBuffer();for(const i in this._vertexBuffers)null===(t=this._vertexBuffers[i])||void 0===t||t._rebuild()}dispose(){const t=this._vertexBuffers[A.PositionKind];for(t&&(t.dispose(),this._vertexBuffers[A.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();const i=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(i,1)}static Parse(t,i,s){const n=i.getLastEntryById(t.emitterId),o=t.name||"lensFlareSystem#"+t.emitterId,a=new r(o,n,i);a.id=t.id||o,a.borderLimit=t.borderLimit;for(let l=0;l<t.flares.length;l++){const c=t.flares[l];NC.AddFlare(c.size,c.position,re.FromArray(c.color),c.textureName?s+c.textureName:"",a)}return a}serialize(){const t={};t.id=this.id,t.name=this.name,t.emitterId=this.getEmitter().id,t.borderLimit=this.borderLimit,t.flares=[];for(let i=0;i<this.lensFlares.length;i++){const s=this.lensFlares[i];t.flares.push({size:s.size,position:s.position,color:s.color.asArray(),textureName:q.GetFilename(s.texture?s.texture.name:"")})}return t}}return r._SceneComponentInitialization=e=>{throw Ge("LensFlareSystemSceneComponent")},r})();es.AddParser(Me.NAME_LENSFLARESYSTEM,(r,e,t,i)=>{if(null!=r.lensFlareSystems){t.lensFlareSystems||(t.lensFlareSystems=new Array);for(let s=0,n=r.lensFlareSystems.length;s<n;s++){const a=sG.Parse(r.lensFlareSystems[s],e,i);t.lensFlareSystems.push(a)}}}),es.prototype.getLensFlareSystemByName=function(r){for(let e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].name===r)return this.lensFlareSystems[e];return null},es.prototype.getLensFlareSystemById=function(r){for(let e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].id===r)return this.lensFlareSystems[e];return null},es.prototype.getLensFlareSystemByID=function(r){return this.getLensFlareSystemById(r)},es.prototype.removeLensFlareSystem=function(r){const e=this.lensFlareSystems.indexOf(r);return-1!==e&&this.lensFlareSystems.splice(e,1),e},es.prototype.addLensFlareSystem=function(r){this.lensFlareSystems.push(r)};class Yne{constructor(e){this.name=Me.NAME_LENSFLARESYSTEM,this.scene=e,e.lensFlareSystems=new Array}register(){this.scene._afterCameraDrawStage.registerStep(Me.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM,this,this._draw)}rebuild(){for(let e=0;e<this.scene.lensFlareSystems.length;e++)this.scene.lensFlareSystems[e].rebuild()}addFromContainer(e){!e.lensFlareSystems||e.lensFlareSystems.forEach(t=>{this.scene.addLensFlareSystem(t)})}removeFromContainer(e,t){!e.lensFlareSystems||e.lensFlareSystems.forEach(i=>{this.scene.removeLensFlareSystem(i),t&&i.dispose()})}serialize(e){e.lensFlareSystems=[];const t=this.scene.lensFlareSystems;for(const i of t)e.lensFlareSystems.push(i.serialize())}dispose(){const e=this.scene.lensFlareSystems;for(;e.length;)e[0].dispose()}_draw(e){if(this.scene.lensFlaresEnabled){const t=this.scene.lensFlareSystems;q.StartPerformanceCounter("Lens flares",t.length>0);for(const i of t)0!=(e.layerMask&i.layerMask)&&i.render();q.EndPerformanceCounter("Lens flares",t.length>0)}}}sG._SceneComponentInitialization=r=>{let e=r._getComponent(Me.NAME_LENSFLARESYSTEM);e||(e=new Yne(r),r._addComponent(e))};j.IncludesShadersStore.bayerDitherFunctions="float bayerDither2(vec2 _P) {\nreturn mod(2.0*_P.y+_P.x+1.0,4.0);\n}\nfloat bayerDither4(vec2 _P) {\nvec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5*mod(_P,4.0)); \nreturn 4.0*bayerDither2(P1)+bayerDither2(P2);\n}\nfloat bayerDither8(vec2 _P) {\nvec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5 *mod(_P,4.0)); \nvec2 P4=floor(0.25*mod(_P,8.0)); \nreturn 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);\n}\n";j.IncludesShadersStore.shadowMapFragmentExtraDeclaration="#if SM_FLOAT==0\n#include<packingFunctions>\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#include<bayerDitherFunctions>\nuniform float softTransparentShadowSM;\n#endif\nvarying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nuniform vec3 lightDataSM;\nvarying vec3 vPositionWSM;\n#endif\nuniform vec3 biasAndScaleSM;\nuniform vec2 depthValuesSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n";j.IncludesShadersStore.shadowMapFragment="float depthSM=vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\ndepthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_FragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\ngl_FragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\ngl_FragColor=vec4(depthSM,1.0,1.0,1.0);\n#else\ngl_FragColor=pack(depthSM);\n#endif\nreturn;";j.ShadersStore.shadowMapPixelShader="#include<shadowMapFragmentExtraDeclaration>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEXTURE\nfloat alphaFromAlphaTexture=texture2D(diffuseSampler,vUV).a;\n#ifdef ALPHATESTVALUE\nif (alphaFromAlphaTexture<ALPHATESTVALUE)\ndiscard;\n#endif\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#ifdef ALPHATEXTURE\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alphaFromAlphaTexture) discard;\n#else\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM) discard;\n#endif\n#endif\n#include<shadowMapFragment>\n}";j.IncludesShadersStore.sceneVertexDeclaration="uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec4 vEyePosition;\n";j.IncludesShadersStore.meshVertexDeclaration="uniform mat4 world;\nuniform float visibility;\n";j.IncludesShadersStore.shadowMapVertexDeclaration="#include<sceneVertexDeclaration>\n#include<meshVertexDeclaration>\n";j.IncludesShadersStore.shadowMapUboDeclaration="layout(std140,column_major) uniform;\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";j.IncludesShadersStore.shadowMapVertexExtraDeclaration="#if SM_NORMALBIAS==1\nuniform vec3 lightDataSM;\n#endif\nuniform vec3 biasAndScaleSM;\nuniform vec2 depthValuesSM;\nvarying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nvarying vec3 vPositionWSM;\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n";j.IncludesShadersStore.shadowMapVertexNormalBias="#if SM_NORMALBIAS==1\n#if SM_DIRECTIONINLIGHTDATA==1\nvec3 worldLightDirSM=normalize(-lightDataSM.xyz);\n#else\nvec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;\nvec3 worldLightDirSM=normalize(directionToLightSM);\n#endif\nfloat ndlSM=dot(vNormalW,worldLightDirSM);\nfloat sinNLSM=sqrt(1.0-ndlSM*ndlSM);\nfloat normalBiasSM=biasAndScaleSM.y*sinNLSM;\nworldPos.xyz-=vNormalW*normalBiasSM;\n#endif\n";j.IncludesShadersStore.shadowMapVertexMetric="#if SM_USEDISTANCE==1\nvPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#else\ngl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nzSM=gl_Position.z;\ngl_Position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\nvDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n";j.ShadersStore.shadowMapVertexShader="attribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef INSTANCES\nattribute vec4 world0;\nattribute vec4 world1;\nattribute vec4 world2;\nattribute vec4 world3;\n#endif\n#include<helperFunctions>\n#include<__decl__shadowMapVertex>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<shadowMapVertexExtraDeclaration>\n#include<clipPlaneVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normWorldSM=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));\nvNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvec3 vNormalW=normalize(normWorldSM*normalUpdated);\n#endif\n#endif\n#include<shadowMapVertexNormalBias>\ngl_Position=viewProjection*worldPos;\n#include<shadowMapVertexMetric>\n#ifdef ALPHATEXTURE\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n}";j.ShadersStore.depthBoxBlurPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec4 colorDepth=vec4(0.0);\nfor (int x=-OFFSET; x<=OFFSET; x++)\nfor (int y=-OFFSET; y<=OFFSET; y++)\ncolorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);\ngl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));\n}";j.IncludesShadersStore.shadowMapFragmentSoftTransparentShadow="#if SM_SOFTTRANSPARENTSHADOW==1\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alpha) discard;\n#endif\n";let Qn=(()=>{class r{get bias(){return this._bias}set bias(t){this._bias=t}get normalBias(){return this._normalBias}set normalBias(t){this._normalBias=t}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(t){this._blurBoxOffset!==t&&(this._blurBoxOffset=t,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(t){this._blurScale!==t&&(this._blurScale=t,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(t){this._blurKernel!==t&&(this._blurKernel=t,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(t){this._useKernelBlur!==t&&(this._useKernelBlur=t,this._disposeBlurPostProcesses())}get depthScale(){return void 0!==this._depthScale?this._depthScale:this._light.getDepthScale()}set depthScale(t){this._depthScale=t}_validateFilter(t){return t}get filter(){return this._filter}set filter(t){if(t=this._validateFilter(t),this._light.needCube()){if(t===r.FILTER_BLUREXPONENTIALSHADOWMAP)return void(this.useExponentialShadowMap=!0);if(t===r.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)return void(this.useCloseExponentialShadowMap=!0);if(t===r.FILTER_PCF||t===r.FILTER_PCSS)return void(this.usePoissonSampling=!0)}t!==r.FILTER_PCF&&t!==r.FILTER_PCSS||this._scene.getEngine()._features.supportShadowSamplers?this._filter!==t&&(this._filter=t,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty()):this.usePoissonSampling=!0}get usePoissonSampling(){return this.filter===r.FILTER_POISSONSAMPLING}set usePoissonSampling(t){const i=this._validateFilter(r.FILTER_POISSONSAMPLING);!t&&this.filter!==r.FILTER_POISSONSAMPLING||(this.filter=t?i:r.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===r.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(t){const i=this._validateFilter(r.FILTER_EXPONENTIALSHADOWMAP);!t&&this.filter!==r.FILTER_EXPONENTIALSHADOWMAP||(this.filter=t?i:r.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===r.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(t){const i=this._validateFilter(r.FILTER_BLUREXPONENTIALSHADOWMAP);!t&&this.filter!==r.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=t?i:r.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===r.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(t){const i=this._validateFilter(r.FILTER_CLOSEEXPONENTIALSHADOWMAP);!t&&this.filter!==r.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=t?i:r.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===r.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(t){const i=this._validateFilter(r.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!t&&this.filter!==r.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=t?i:r.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===r.FILTER_PCF}set usePercentageCloserFiltering(t){const i=this._validateFilter(r.FILTER_PCF);!t&&this.filter!==r.FILTER_PCF||(this.filter=t?i:r.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(t){this._filteringQuality!==t&&(this._filteringQuality=t,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===r.FILTER_PCSS}set useContactHardeningShadow(t){const i=this._validateFilter(r.FILTER_PCSS);!t&&this.filter!==r.FILTER_PCSS||(this.filter=t?i:r.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(t){this._contactHardeningLightSizeUVRatio=t}get darkness(){return this._darkness}set darkness(t){this.setDarkness(t)}getDarkness(){return this._darkness}setDarkness(t){return this._darkness=t>=1?1:t<=0?0:t,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(t){this.setTransparencyShadow(t)}setTransparencyShadow(t){return this._transparencyShadow=t,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return r.CLASSNAME}addShadowCaster(t,i=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),-1===this._shadowMap.renderList.indexOf(t)&&this._shadowMap.renderList.push(t),i)for(const s of t.getChildMeshes())-1===this._shadowMap.renderList.indexOf(s)&&this._shadowMap.renderList.push(s);return this}removeShadowCaster(t,i=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const s=this._shadowMap.renderList.indexOf(t);if(-1!==s&&this._shadowMap.renderList.splice(s,1),i)for(const n of t.getChildren())this.removeShadowCaster(n);return this}getLight(){return this._light}_getCamera(){var t;return null!==(t=this._camera)&&void 0!==t?t:this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(t){this._mapSize=t,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(t,i,s,n){this.onBeforeShadowMapRenderObservable=new z,this.onAfterShadowMapRenderObservable=new z,this.onBeforeShadowMapRenderMeshObservable=new z,this.onAfterShadowMapRenderMeshObservable=new z,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=r.FILTER_NONE,this._filteringQuality=r.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=v.Zero(),this._viewMatrix=F.Zero(),this._projectionMatrix=F.Zero(),this._transformMatrix=F.Zero(),this._cachedPosition=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=F.Identity(),this._mapSize=t,this._light=i,this._scene=i.getScene(),this._camera=n??null;let o=i._shadowGenerators;o||(o=i._shadowGenerators=new Map),o.set(this._camera,this),this.id=i.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),r._SceneComponentInitialization(this._scene);const a=this._scene.getEngine().getCaps();this._textureType=s?a.textureFloatRender&&a.textureFloatLinearFiltering?1:a.textureHalfFloatRender&&a.textureHalfFloatLinearFiltering?2:0:a.textureHalfFloatRender&&a.textureHalfFloatLinearFiltering?2:a.textureFloatRender&&a.textureFloatLinearFiltering?1:0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){const t=this._scene.getEngine();t._features.supportDepthStencilTexture?(this._shadowMap=new Ss(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1),this._shadowMap.createDepthStencilTexture(t.useReverseDepthBuffer?516:513,!0)):this._shadowMap=new Ss(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube())}_initializeShadowMap(){if(this._createTargetRenderTexture(),null===this._shadowMap)return;this._shadowMap.wrapU=U.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=U.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(U.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=this._renderForShadowMap.bind(this),this._shadowMap.customIsReadyFunction=()=>!0;const t=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(()=>{var n;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),null===(n=t._debugPushGroup)||void 0===n||n.call(t,`shadow map generation for pass id ${t.currentRenderPassId}`,1)}),this._shadowMap.onBeforeRenderObservable.add(n=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=n,this._filter===r.FILTER_PCF&&t.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(()=>{var n,o;if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===r.FILTER_PCF&&t.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap)return void(null===(n=t._debugPopGroup)||void 0===n||n.call(t,1));const a=this.getShadowMapForRendering();a&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,a.renderTarget,!0),t.unBindFramebuffer(a.renderTarget,!0),null===(o=t._debugPopGroup)||void 0===o||o.call(t,1))});const i=new Te(0,0,0,0),s=new Te(1,1,1,1);this._shadowMap.onClearObservable.add(n=>{this._filter===r.FILTER_PCF?n.clear(s,!1,!0,!1):n.clear(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?i:s,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(n=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=n.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()});for(let n=Jg.MIN_RENDERINGGROUPS;n<Jg.MAX_RENDERINGGROUPS;n++)this._shadowMap.setRenderingAutoClearDepthStencil(n,!1)}_initializeBlurRTTAndPostProcesses(){const t=this._scene.getEngine(),i=this._mapSize/this.blurScale;(!this.useKernelBlur||1!==this.blurScale)&&(this._shadowMap2=new Ss(this._light.name+"_shadowMap2",i,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=U.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=U.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(U.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new _s(this._light.name+"KernelBlurX",new de(1,0),this.blurKernel,1,null,U.BILINEAR_SAMPLINGMODE,t,!1,this._textureType),this._kernelBlurXPostprocess.width=i,this._kernelBlurXPostprocess.height=i,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(s=>{s.setTexture("textureSampler",this._shadowMap)}),this._kernelBlurYPostprocess=new _s(this._light.name+"KernelBlurY",new de(0,1),this.blurKernel,1,null,U.BILINEAR_SAMPLINGMODE,t,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,0===this._textureType&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new Pe(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,U.BILINEAR_SAMPLINGMODE,t,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(s=>{s.setFloat2("screenSize",i,i),s.setTexture("textureSampler",this._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(t,i,s,n){let o;if(n.length)for(o=0;o<n.length;o++)this._renderSubMeshForShadowMap(n.data[o]);for(o=0;o<t.length;o++)this._renderSubMeshForShadowMap(t.data[o]);for(o=0;o<i.length;o++)this._renderSubMeshForShadowMap(i.data[o]);if(this._transparencyShadow)for(o=0;o<s.length;o++)this._renderSubMeshForShadowMap(s.data[o],!0);else for(o=0;o<s.length;o++)s.data[o].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(t,i,s){i.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(t,i=!1){var s,n;const o=t.getRenderingMesh(),a=t.getEffectiveMesh(),l=this._scene,c=l.getEngine(),h=t.getMaterial();if(a._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!h||0===t.verticesCount||t._renderId===l.getRenderId())return;const u=a._getWorldMatrixDeterminant()<0;let d=null!==(s=o.overrideMaterialSideOrientation)&&void 0!==s?s:h.sideOrientation;u&&(d=0===d?1:0),c.setState(h.backFaceCulling,void 0,void 0,0===d,h.cullBackFaces);const p=o._getInstancesRenderList(t._id,!!t.getReplacementMesh());if(p.mustReturn)return;const _=c.getCaps().instancedArrays&&(null!=p.visibleInstances[t._id]||o.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(t))if(this.isReady(t,_,i)){t._renderId=l.getRenderId();const m=h.shadowDepthWrapper,g=null!==(n=m?.getEffect(t,this,c.currentRenderPassId))&&void 0!==n?n:t._getDrawWrapper(),b=$i.GetEffect(g);c.enableEffect(g),_||o._bind(t,b,h.fillMode),this.getTransformMatrix(),b.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===Je.LIGHTTYPEID_DIRECTIONALLIGHT?b.setVector3("lightDataSM",this._cachedDirection):b.setVector3("lightDataSM",this._cachedPosition);const y=this._getCamera();if(y&&b.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(y),this.getLight().getDepthMinZ(y)+this.getLight().getDepthMaxZ(y)),i&&this.enableSoftTransparentShadow&&b.setFloat("softTransparentShadowSM",a.visibility*h.alpha),m)t._setMainDrawWrapperOverride(g),m.standalone?m.baseMaterial.bindForSubMesh(a.getWorldMatrix(),o,t):h.bindForSubMesh(a.getWorldMatrix(),o,t),t._setMainDrawWrapperOverride(null);else{if(this.useOpacityTextureForTransparentShadow){const x=h.opacityTexture;x&&(b.setTexture("diffuseSampler",x),b.setMatrix("diffuseMatrix",x.getTextureMatrix()||this._defaultTextureMatrix))}else if(h.needAlphaTesting()||h.needAlphaBlending()){const x=h.getAlphaTestTexture();x&&(b.setTexture("diffuseSampler",x),b.setMatrix("diffuseMatrix",x.getTextureMatrix()||this._defaultTextureMatrix))}if(o.useBones&&o.computeBonesUsingShaders&&o.skeleton){const x=o.skeleton;if(x.isUsingTextureForMatrices){const S=x.getTransformMatrixTexture(o);if(!S)return;b.setTexture("boneSampler",S),b.setFloat("boneTextureWidth",4*(x.bones.length+1))}else b.setMatrices("mBones",x.getTransformMatrices(o))}ce.BindMorphTargetParameters(o,b),o.morphTargetManager&&o.morphTargetManager.isUsingTextureForTargets&&o.morphTargetManager._bind(b),fo(b,h,l)}!this._useUBO&&!m&&this._bindCustomEffectForRenderSubMeshForShadowMap(t,b,a),ce.BindSceneUniformBuffer(b,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const T=a.getWorldMatrix();_&&(a.getMeshUniformBuffer().bindToEffect(b,"Mesh"),a.transferToEffect(T)),this.forceBackFacesOnly&&c.setState(!0,0,!1,!0,h.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(o),this.onBeforeShadowMapRenderObservable.notifyObservers(b),o._processRendering(a,t,b,h.fillMode,p,_,(x,S)=>{a===o||x?(a.getMeshUniformBuffer().bindToEffect(b,"Mesh"),a.transferToEffect(x?S:T)):(o.getMeshUniformBuffer().bindToEffect(b,"Mesh"),o.transferToEffect(S))}),this.forceBackFacesOnly&&c.setState(!0,0,!1,!1,h.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(b),this.onAfterShadowMapRenderMeshObservable.notifyObservers(o)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){!this._shadowMap||this._shadowMap.updateSamplingMode(this.filter===r.FILTER_NONE||this.filter===r.FILTER_PCSS?U.NEAREST_SAMPLINGMODE:U.BILINEAR_SAMPLINGMODE)}forceCompilation(t,i){const s={useInstances:!1,...i},n=this.getShadowMap();if(!n)return void(t&&t(this));const o=n.renderList;if(!o)return void(t&&t(this));const a=new Array;for(const h of o)a.push(...h.subMeshes);if(0===a.length)return void(t&&t(this));let l=0;const c=()=>{var h,u;if(this._scene&&this._scene.getEngine()){for(;this.isReady(a[l],s.useInstances,null!==(u=null===(h=a[l].getMaterial())||void 0===h?void 0:h.needAlphaBlendingForMesh(a[l].getMesh()))&&void 0!==u&&u);)if(l++,l>=a.length)return void(t&&t(this));setTimeout(c,16)}};c()}forceCompilationAsync(t){return new Promise(i=>{this.forceCompilation(()=>{i()},t)})}_isReadyCustomDefines(t,i,s){}_prepareShadowDefines(t,i,s,n){s.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),s.push("#define SM_FLOAT "+(0!==this._textureType?"1":"0")),s.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),s.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const o=t.getMesh();return s.push("#define SM_NORMALBIAS "+(this.normalBias&&o.isVerticesDataPresent(A.NormalKind)?"1":"0")),s.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===Je.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),s.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),s.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&n?"1":"0")),this._isReadyCustomDefines(s,t,i),s}isReady(t,i,s){var n;const o=t.getMaterial(),a=o?.shadowDepthWrapper;if(!o)return!1;const l=[];if(this._prepareShadowDefines(t,i,l,s),a){if(!a.isReadyForSubMesh(t,l,this,i,this._scene.getEngine().currentRenderPassId))return!1}else{const c=t._getDrawWrapper(void 0,!0);let h=c.effect,u=c.defines;const d=[A.PositionKind],f=t.getMesh();this.normalBias&&f.isVerticesDataPresent(A.NormalKind)&&(d.push(A.NormalKind),l.push("#define NORMAL"),f.nonUniformScaling&&l.push("#define NONUNIFORMSCALING"));const p=o?.needAlphaTesting(),_=o?.needAlphaBlending();if(o&&(p||_)){let T=null;if(T=this.useOpacityTextureForTransparentShadow?o.opacityTexture:o.getAlphaTestTexture(),T){if(!T.isReady())return!1;const x=null!==(n=o.alphaCutOff)&&void 0!==n?n:r.DEFAULT_ALPHA_CUTOFF;l.push("#define ALPHATEXTURE"),p&&l.push(`#define ALPHATESTVALUE ${x}${x%1==0?".":""}`),f.isVerticesDataPresent(A.UVKind)&&(d.push(A.UVKind),l.push("#define UV1")),f.isVerticesDataPresent(A.UV2Kind)&&1===T.coordinatesIndex&&(d.push(A.UV2Kind),l.push("#define UV2"))}}const m=new oh;if(f.useBones&&f.computeBonesUsingShaders&&f.skeleton){d.push(A.MatricesIndicesKind),d.push(A.MatricesWeightsKind),f.numBoneInfluencers>4&&(d.push(A.MatricesIndicesExtraKind),d.push(A.MatricesWeightsExtraKind));const T=f.skeleton;l.push("#define NUM_BONE_INFLUENCERS "+f.numBoneInfluencers),f.numBoneInfluencers>0&&m.addCPUSkinningFallback(0,f),l.push(T.isUsingTextureForMatrices?"#define BONETEXTURE":"#define BonesPerMesh "+(T.bones.length+1))}else l.push("#define NUM_BONE_INFLUENCERS 0");const g=f.morphTargetManager;let b=0;if(g&&g.numInfluencers>0&&(l.push("#define MORPHTARGETS"),b=g.numInfluencers,l.push("#define NUM_MORPH_INFLUENCERS "+b),g.isUsingTextureForTargets&&l.push("#define MORPHTARGETS_TEXTURE"),ce.PrepareAttributesForMorphTargetsInfluencers(d,f,b)),Za(o,this._scene,l),i&&(l.push("#define INSTANCES"),ce.PushAttributesForInstances(d),t.getRenderingMesh().hasThinInstances&&l.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const T of this.customShaderOptions.defines)-1===l.indexOf(T)&&l.push(T);const y=l.join("\n");if(u!==y){u=y;let T="shadowMap";const x=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices"],S=["diffuseSampler","boneSampler","morphTargets"],C=["Scene","Mesh"];if(Uo(x),this.customShaderOptions){if(T=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const P of this.customShaderOptions.attributes)-1===d.indexOf(P)&&d.push(P);if(this.customShaderOptions.uniforms)for(const P of this.customShaderOptions.uniforms)-1===x.indexOf(P)&&x.push(P);if(this.customShaderOptions.samplers)for(const P of this.customShaderOptions.samplers)-1===S.indexOf(P)&&S.push(P)}const D=this._scene.getEngine();h=D.createEffect(T,{attributes:d,uniformsNames:x,uniformBuffersNames:C,samplers:S,defines:y,fallbacks:m,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:b}},D),c.setEffect(h,u)}if(!h.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(t,i){const n=this._light;!this._scene.shadowsEnabled||!n.shadowEnabled||(t["SHADOW"+i]=!0,this.useContactHardeningShadow?(t["SHADOWPCSS"+i]=!0,this._filteringQuality===r.QUALITY_LOW?t["SHADOWLOWQUALITY"+i]=!0:this._filteringQuality===r.QUALITY_MEDIUM&&(t["SHADOWMEDIUMQUALITY"+i]=!0)):this.usePercentageCloserFiltering?(t["SHADOWPCF"+i]=!0,this._filteringQuality===r.QUALITY_LOW?t["SHADOWLOWQUALITY"+i]=!0:this._filteringQuality===r.QUALITY_MEDIUM&&(t["SHADOWMEDIUMQUALITY"+i]=!0)):this.usePoissonSampling?t["SHADOWPOISSON"+i]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?t["SHADOWESM"+i]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(t["SHADOWCLOSEESM"+i]=!0),n.needCube()&&(t["SHADOWCUBE"+i]=!0))}bindShadowLight(t,i){const s=this._light;if(!this._scene.shadowsEnabled||!s.shadowEnabled)return;const o=this._getCamera();if(!o)return;const a=this.getShadowMap();!a||(s.needCube()||i.setMatrix("lightMatrix"+t,this.getTransformMatrix()),this._filter===r.FILTER_PCF?(i.setDepthStencilTexture("shadowSampler"+t,this.getShadowMapForRendering()),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a.getSize().width,1/a.getSize().width,this.frustumEdgeFalloff,t)):this._filter===r.FILTER_PCSS?(i.setDepthStencilTexture("shadowSampler"+t,this.getShadowMapForRendering()),i.setTexture("depthSampler"+t,this.getShadowMapForRendering()),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/a.getSize().width,this._contactHardeningLightSizeUVRatio*a.getSize().width,this.frustumEdgeFalloff,t)):(i.setTexture("shadowSampler"+t,this.getShadowMapForRendering()),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/a.getSize().width,this.depthScale,this.frustumEdgeFalloff,t)),s._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(o),this.getLight().getDepthMinZ(o)+this.getLight().getDepthMaxZ(o),t))}getTransformMatrix(){const t=this._scene;if(this._currentRenderId===t.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=t.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let i=this._light.position;if(this._light.computeTransformedInformation()&&(i=this._light.transformedPosition),v.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(v.Dot(this._lightDirection,v.Up()))&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!i.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(i),this._cachedDirection.copyFrom(this._lightDirection),F.LookAtLHToRef(i,i.add(this._lightDirection),v.Up(),this._viewMatrix);const s=this.getShadowMap();if(s){const n=s.renderList;n&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,n)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const t=this._shadowMap;if(!t)return;const i=t.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),i){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const s of i)this._shadowMap.renderList.push(s)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const t of this._sceneUBOs)t.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const t=this._light._shadowGenerators.entries();for(let i=t.next();!0!==i.done;i=t.next()){const[s,n]=i.value;n===this&&this._light._shadowGenerators.delete(s)}0===this._light._shadowGenerators.size&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){var t;const i={},s=this.getShadowMap();if(!s)return i;if(i.className=this.getClassName(),i.lightId=this._light.id,i.cameraId=null===(t=this._camera)||void 0===t?void 0:t.id,i.id=this.id,i.mapSize=s.getRenderSize(),i.forceBackFacesOnly=this.forceBackFacesOnly,i.darkness=this.getDarkness(),i.transparencyShadow=this._transparencyShadow,i.frustumEdgeFalloff=this.frustumEdgeFalloff,i.bias=this.bias,i.normalBias=this.normalBias,i.usePercentageCloserFiltering=this.usePercentageCloserFiltering,i.useContactHardeningShadow=this.useContactHardeningShadow,i.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,i.filteringQuality=this.filteringQuality,i.useExponentialShadowMap=this.useExponentialShadowMap,i.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,i.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,i.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,i.usePoissonSampling=this.usePoissonSampling,i.depthScale=this.depthScale,i.blurBoxOffset=this.blurBoxOffset,i.blurKernel=this.blurKernel,i.blurScale=this.blurScale,i.useKernelBlur=this.useKernelBlur,i.renderList=[],s.renderList)for(let n=0;n<s.renderList.length;n++)i.renderList.push(s.renderList[n].id);return i}static Parse(t,i,s){const n=i.getLightById(t.lightId),o=void 0!==t.cameraId?i.getCameraById(t.cameraId):null,a=s?s(t.mapSize,n,o):new r(t.mapSize,n,void 0,o),l=a.getShadowMap();for(let c=0;c<t.renderList.length;c++)i.getMeshesById(t.renderList[c]).forEach(function(u){!l||(l.renderList||(l.renderList=[]),l.renderList.push(u))});return void 0!==t.id&&(a.id=t.id),a.forceBackFacesOnly=!!t.forceBackFacesOnly,void 0!==t.darkness&&a.setDarkness(t.darkness),t.transparencyShadow&&a.setTransparencyShadow(!0),void 0!==t.frustumEdgeFalloff&&(a.frustumEdgeFalloff=t.frustumEdgeFalloff),void 0!==t.bias&&(a.bias=t.bias),void 0!==t.normalBias&&(a.normalBias=t.normalBias),t.usePercentageCloserFiltering?a.usePercentageCloserFiltering=!0:t.useContactHardeningShadow?a.useContactHardeningShadow=!0:t.usePoissonSampling?a.usePoissonSampling=!0:t.useExponentialShadowMap?a.useExponentialShadowMap=!0:t.useBlurExponentialShadowMap?a.useBlurExponentialShadowMap=!0:t.useCloseExponentialShadowMap?a.useCloseExponentialShadowMap=!0:t.useBlurCloseExponentialShadowMap?a.useBlurCloseExponentialShadowMap=!0:t.useVarianceShadowMap?a.useExponentialShadowMap=!0:t.useBlurVarianceShadowMap&&(a.useBlurExponentialShadowMap=!0),void 0!==t.contactHardeningLightSizeUVRatio&&(a.contactHardeningLightSizeUVRatio=t.contactHardeningLightSizeUVRatio),void 0!==t.filteringQuality&&(a.filteringQuality=t.filteringQuality),t.depthScale&&(a.depthScale=t.depthScale),t.blurScale&&(a.blurScale=t.blurScale),t.blurBoxOffset&&(a.blurBoxOffset=t.blurBoxOffset),t.useKernelBlur&&(a.useKernelBlur=t.useKernelBlur),t.blurKernel&&(a.blurKernel=t.blurKernel),a}}return r.CLASSNAME="ShadowGenerator",r.FILTER_NONE=0,r.FILTER_EXPONENTIALSHADOWMAP=1,r.FILTER_POISSONSAMPLING=2,r.FILTER_BLUREXPONENTIALSHADOWMAP=3,r.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,r.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,r.FILTER_PCF=6,r.FILTER_PCSS=7,r.QUALITY_HIGH=0,r.QUALITY_MEDIUM=1,r.QUALITY_LOW=2,r.DEFAULT_ALPHA_CUTOFF=.5,r._SceneComponentInitialization=e=>{throw Ge("ShadowGeneratorSceneComponent")},r})();j.ShadersStore.depthPixelShader="#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\nvarying float vDepthMetric;\n#ifdef PACKED\n#include<packingFunctions>\n#endif\n#ifdef STORE_CAMERASPACE_Z\nvarying vec4 vViewPos;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#ifdef STORE_CAMERASPACE_Z\n#ifdef PACKED\ngl_FragColor=pack(vViewPos.z);\n#else\ngl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);\n#endif\n#else\n#ifdef NONLINEARDEPTH\n#ifdef PACKED\ngl_FragColor=pack(gl_FragCoord.z);\n#else\ngl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);\n#endif\n#else\n#ifdef PACKED\ngl_FragColor=pack(vDepthMetric);\n#else\ngl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);\n#endif\n#endif\n#endif\n}";j.ShadersStore.depthVertexShader="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nuniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef STORE_CAMERASPACE_Z\nuniform mat4 view;\nvarying vec4 vViewPos;\n#endif\nvarying float vDepthMetric;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\ngl_Position=viewProjection*worldPos;\n#ifdef STORE_CAMERASPACE_Z\nvViewPos=view*worldPos;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));\n#else\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));\n#endif\n#endif\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}\n";let Jv=(()=>{class r{setMaterialForRendering(t,i){this._depthMap.setMaterialForRendering(t,i)}constructor(t,i=1,s=null,n=!1,o=U.TRILINEAR_SAMPLINGMODE,a=!1,l){this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.reverseCulling=!1,this._scene=t,this._storeNonLinearDepth=n,this._storeCameraSpaceZ=a,this.isPacked=0===i,this.clearColor=this.isPacked?new Te(1,1,1,1):new Te(a?1e8:1,0,0,1),r._SceneComponentInitialization(this._scene);const c=t.getEngine();this._camera=s,o!==U.NEAREST_SAMPLINGMODE&&(1===i&&!c._caps.textureFloatLinearFiltering&&(o=U.NEAREST_SAMPLINGMODE),2===i&&!c._caps.textureHalfFloatLinearFiltering&&(o=U.NEAREST_SAMPLINGMODE));const h=this.isPacked||!c._features.supportExtendedTextureFormats?5:6;this._depthMap=new Ss(l??"DepthRenderer",{width:c.getRenderWidth(),height:c.getRenderHeight()},this._scene,!1,!0,i,!1,o,void 0,void 0,void 0,h),this._depthMap.wrapU=U.CLAMP_ADDRESSMODE,this._depthMap.wrapV=U.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(d=>{d.clear(this.clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(()=>{var d;null===(d=c._debugPushGroup)||void 0===d||d.call(c,"depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(()=>{var d;null===(d=c._debugPopGroup)||void 0===d||d.call(c,1)}),this._depthMap.customIsReadyFunction=(d,f,p)=>{if((p||0===f)&&d.subMeshes)for(let _=0;_<d.subMeshes.length;++_){const m=d.subMeshes[_],g=m.getRenderingMesh(),b=g._getInstancesRenderList(m._id,!!m.getReplacementMesh()),y=c.getCaps().instancedArrays&&(null!=b.visibleInstances[m._id]||g.hasThinInstances);if(!this.isReady(m,y))return!1}return!0};const u=d=>{var f,p;const _=d.getRenderingMesh(),m=d.getEffectiveMesh(),g=this._scene,b=g.getEngine(),y=d.getMaterial();if(m._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!y||m.infiniteDistance||y.disableDepthWrite||0===d.verticesCount||d._renderId===g.getRenderId())return;const T=m._getWorldMatrixDeterminant()<0;let x=null!==(f=_.overrideMaterialSideOrientation)&&void 0!==f?f:y.sideOrientation;T&&(x=0===x?1:0),b.setState(y.backFaceCulling,0,!1,0===x,this.reverseCulling?!y.cullBackFaces:y.cullBackFaces);const C=_._getInstancesRenderList(d._id,!!d.getReplacementMesh());if(C.mustReturn)return;const D=b.getCaps().instancedArrays&&(null!=C.visibleInstances[d._id]||_.hasThinInstances),P=this._camera||g.activeCamera;if(this.isReady(d,D)&&P){d._renderId=g.getRenderId();const M=null===(p=m._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===p?void 0:p[b.currentRenderPassId];let w=d._getDrawWrapper();!w&&M&&(w=M._getDrawWrapper());const k=P.mode===ve.ORTHOGRAPHIC_CAMERA;if(!w)return;const X=w.effect;let te,J;if(b.enableEffect(w),D||_._bind(d,X,y.fillMode),M?M.bindForSubMesh(m.getWorldMatrix(),m,d):(X.setMatrix("viewProjection",g.getTransformMatrix()),X.setMatrix("world",m.getWorldMatrix()),this._storeCameraSpaceZ&&X.setMatrix("view",g.getViewMatrix())),k?(te=!b.useReverseDepthBuffer&&b.isNDCHalfZRange?0:1,J=b.useReverseDepthBuffer&&b.isNDCHalfZRange?0:1):(te=b.useReverseDepthBuffer&&b.isNDCHalfZRange?P.minZ:b.isNDCHalfZRange?0:P.minZ,J=b.useReverseDepthBuffer&&b.isNDCHalfZRange?0:P.maxZ),X.setFloat2("depthValues",te,te+J),!M){if(y.needAlphaTesting()){const Q=y.getAlphaTestTexture();Q&&(X.setTexture("diffuseSampler",Q),X.setMatrix("diffuseMatrix",Q.getTextureMatrix()))}if(_.useBones&&_.computeBonesUsingShaders&&_.skeleton){const Q=_.skeleton;if(Q.isUsingTextureForMatrices){const me=Q.getTransformMatrixTexture(_);if(!me)return;X.setTexture("boneSampler",me),X.setFloat("boneTextureWidth",4*(Q.bones.length+1))}else X.setMatrices("mBones",Q.getTransformMatrices(_))}fo(X,y,g),ce.BindMorphTargetParameters(_,X),_.morphTargetManager&&_.morphTargetManager.isUsingTextureForTargets&&_.morphTargetManager._bind(X)}_._processRendering(m,d,X,y.fillMode,C,D,(Q,me)=>X.setMatrix("world",me))}};this._depthMap.customRenderFunction=(d,f,p,_)=>{let m;if(_.length)for(m=0;m<_.length;m++)u(_.data[m]);for(m=0;m<d.length;m++)u(d.data[m]);for(m=0;m<f.length;m++)u(f.data[m]);if(this.forceDepthWriteTransparentMeshes)for(m=0;m<p.length;m++)u(p.data[m]);else for(m=0;m<p.length;m++)p.data[m].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}isReady(t,i){var s;const n=this._scene.getEngine(),o=t.getMesh(),a=o.getScene(),l=null===(s=o._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===s?void 0:s[n.currentRenderPassId];if(l)return l.isReadyForSubMesh(o,t,i);const c=t.getMaterial();if(!c||c.disableDepthWrite)return!1;const h=[],u=[A.PositionKind];c&&c.needAlphaTesting()&&c.getAlphaTestTexture()&&(h.push("#define ALPHATEST"),o.isVerticesDataPresent(A.UVKind)&&(u.push(A.UVKind),h.push("#define UV1")),o.isVerticesDataPresent(A.UV2Kind)&&(u.push(A.UV2Kind),h.push("#define UV2"))),o.useBones&&o.computeBonesUsingShaders?(u.push(A.MatricesIndicesKind),u.push(A.MatricesWeightsKind),o.numBoneInfluencers>4&&(u.push(A.MatricesIndicesExtraKind),u.push(A.MatricesWeightsExtraKind)),h.push("#define NUM_BONE_INFLUENCERS "+o.numBoneInfluencers),h.push("#define BonesPerMesh "+(o.skeleton?o.skeleton.bones.length+1:0)),t.getRenderingMesh().skeleton?.isUsingTextureForMatrices&&h.push("#define BONETEXTURE")):h.push("#define NUM_BONE_INFLUENCERS 0");const d=o.morphTargetManager;let f=0;d&&d.numInfluencers>0&&(f=d.numInfluencers,h.push("#define MORPHTARGETS"),h.push("#define NUM_MORPH_INFLUENCERS "+f),d.isUsingTextureForTargets&&h.push("#define MORPHTARGETS_TEXTURE"),ce.PrepareAttributesForMorphTargetsInfluencers(u,o,f)),i&&(h.push("#define INSTANCES"),ce.PushAttributesForInstances(u),t.getRenderingMesh().hasThinInstances&&h.push("#define THIN_INSTANCES")),this._storeNonLinearDepth&&h.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&h.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&h.push("#define PACKED"),Za(c,a,h);const p=t._getDrawWrapper(void 0,!0),_=p.defines,m=h.join("\n");if(_!==m){const g=["world","mBones","boneTextureWidth","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];Uo(g),p.setEffect(n.createEffect("depth",u,g,["diffuseSampler","morphTargets","boneSampler"],m,void 0,void 0,void 0,{maxSimultaneousMorphTargets:f}),m)}return p.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){const t=[];for(const i in this._scene._depthRenderer)this._scene._depthRenderer[i]===this&&t.push(i);if(t.length>0){this._depthMap.dispose();for(const i of t)delete this._scene._depthRenderer[i]}}}return r._SceneComponentInitialization=e=>{throw Ge("DepthRendererSceneComponent")},r})();j.ShadersStore.minmaxReduxPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#if defined(INITIAL)\nuniform sampler2D sourceTexture;\nuniform vec2 texSize;\nvoid main(void)\n{\nivec2 coord=ivec2(vUV*(texSize-1.0));\nfloat f1=texelFetch(sourceTexture,coord,0).r;\nfloat f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;\nfloat f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;\nfloat f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;\nfloat minz=min(min(min(f1,f2),f3),f4);\n#ifdef DEPTH_REDUX\nfloat maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);\n#else\nfloat maxz=max(max(max(f1,f2),f3),f4);\n#endif\nglFragColor=vec4(minz,maxz,0.,0.);\n}\n#elif defined(MAIN)\nuniform vec2 texSize;\nvoid main(void)\n{\nivec2 coord=ivec2(vUV*(texSize-1.0));\nvec2 f1=texelFetch(textureSampler,coord,0).rg;\nvec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;\nvec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;\nvec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;\nfloat minz=min(min(min(f1.x,f2.x),f3.x),f4.x);\nfloat maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);\nglFragColor=vec4(minz,maxz,0.,0.);\n}\n#elif defined(ONEBEFORELAST)\nuniform ivec2 texSize;\nvoid main(void)\n{\nivec2 coord=ivec2(vUV*vec2(texSize-1));\nvec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;\nvec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;\nvec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;\nvec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;\nfloat minz=min(f1.x,f2.x);\nfloat maxz=max(f1.y,f2.y);\nglFragColor=vec4(minz,maxz,0.,0.);\n}\n#elif defined(LAST)\nvoid main(void)\n{\nglFragColor=vec4(0.);\nif (true) { \ndiscard;\n}\n}\n#endif\n";class $ne extends class qne{constructor(e){this.onAfterReductionPerformed=new z,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new Zg(e.getScene()),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{this._postProcessManager._rebuild()})}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=2,s=!0){if(e===this._sourceTexture)return;this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=s;const n=this._camera.getScene(),o=new Pe("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,n.getEngine(),!1,"#define INITIAL"+(t?"\n#define DEPTH_REDUX":""),i,void 0,void 0,void 0,7);o.autoClear=!1,o.forceFullscreenViewport=s;let a=this._sourceTexture.getRenderWidth(),l=this._sourceTexture.getRenderHeight();o.onApply=((h,u)=>d=>{d.setTexture("sourceTexture",this._sourceTexture),d.setFloat2("texSize",h,u)})(a,l),this._reductionSteps.push(o);let c=1;for(;a>1||l>1;){a=Math.max(Math.round(a/2),1),l=Math.max(Math.round(l/2),1);const h=new Pe("Reduction phase "+c,"minmaxRedux",["texSize"],null,{width:a,height:l},null,1,n.getEngine(),!1,"#define "+(1==a&&1==l?"LAST":1==a||1==l?"ONEBEFORELAST":"MAIN"),i,void 0,void 0,void 0,7);h.autoClear=!1,h.forceFullscreenViewport=s,h.onApply=((u,d)=>f=>{1==u||1==d?f.setInt2("texSize",u,d):f.setFloat2("texSize",u,d)})(a,l),this._reductionSteps.push(h),c++,1==a&&1==l&&h.onAfterRenderObservable.add(((d,f,p)=>{const _=new Float32Array(4*d*f),m={min:0,max:0};return()=>{n.getEngine()._readTexturePixels(p.inputTexture.texture,d,f,-1,0,_,!1),m.min=_[0],m.max=_[1],this.onAfterReductionPerformed.notifyObservers(m)}})(a,l,h))}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){this._onAfterUnbindObserver||!this._sourceTexture||(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(()=>{var e,t;const i=this._camera.getScene().getEngine();null===(e=i._debugPushGroup)||void 0===e||e.call(i,"min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport),i.unBindFramebuffer(this._reductionSteps[0].inputTexture,!1),null===(t=i._debugPopGroup)||void 0===t||t.call(i,1)}),this._activated=!0)}deactivate(){!this._onAfterUnbindObserver||!this._sourceTexture||(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){if(e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(let t=0;t<this._reductionSteps.length;++t)this._reductionSteps[t].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null}}{get depthRenderer(){return this._depthRenderer}constructor(e){super(e)}setDepthRenderer(e=null,t=2,i=!0){const s=this._camera.getScene();this._depthRenderer&&(delete s._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),null===e&&(s._depthRenderer||(s._depthRenderer={}),(e=this._depthRenderer=new Jv(s,t,this._camera,!1,1)).enabled=!1,this._depthRendererId="minmax"+this._camera.id,s._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,i)}setSourceTexture(e,t,i=2,s=!0){super.setSourceTexture(e,t,i,s)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){if(super.dispose(e),this._depthRenderer&&e){const t=this._depthRenderer.getDepthMap().getScene();t&&delete t._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}}const VG=v.Up(),Kne=v.Zero(),ms=new v,nd=new v,eb=new F;class Ls extends Qn{_validateFilter(e){return e===Qn.FILTER_NONE||e===Qn.FILTER_PCF||e===Qn.FILTER_PCSS?e:(console.error('Unsupported filter "'+e+'"!'),Qn.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){(e=Math.min(Math.max(e,Ls.MIN_CASCADES_COUNT),Ls.MAX_CASCADES_COUNT))!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),!this._freezeShadowCastersBoundingInfoObservable&&!e&&(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(this._computeShadowCastersBoundingInfo.bind(this))),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._shadowMap&&this._shadowMap.renderList){const e=this._shadowMap.renderList;for(let i=0;i<e.length;i++){const s=e[i];if(!s)continue;const o=s.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(o.minimumWorld),this._scbiMax.maximizeInPlace(o.maximumWorld)}const t=this._scene.meshes;for(let i=0;i<t.length;i++){const s=t[i];if(!(s&&s.isVisible&&s.isEnabled&&s.receiveShadows))continue;const o=s.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(o.minimumWorld),this._scbiMax.maximizeInPlace(o.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return Ls.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){const t=this._getCamera();t?this._shadowMaxZ===e||e<t.minZ||e>t.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0):this._shadowMaxZ=e}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){const t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){const t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e)return this._depthReducer&&this._depthReducer.deactivate(),void this.setMinMaxDistance(0,1);this._depthReducer||(this._depthReducer=new $ne(t),this._depthReducer.onAfterReductionPerformed.add(i=>{let s=i.min,n=i.max;s>=n&&(s=0,n=1),(s!=this._minDistance||n!=this._maxDistance)&&this.setMinMaxDistance(s,n)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){var e,t,i;return null!==(i=null===(t=null===(e=this._depthReducer)||void 0===e?void 0:e.depthRenderer)||void 0===t?void 0:t.getDepthMap().refreshRate)&&void 0!==i?i:-1}set autoCalcDepthBoundsRefreshRate(e){var t;null!==(t=this._depthReducer)&&void 0!==t&&t.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){const e=this._getCamera();if(!e)return;const t=e.minZ,i=e.maxZ,s=i-t,n=this._minDistance,a=t+n*s,l=t+(this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance)*s,c=l-a,h=l/a;for(let u=0;u<this._cascades.length;++u){const d=(u+1)/this._numCascades,p=a+c*d,_=this._lambda*(a*h**d-p)+p;this._cascades[u].prevBreakDistance=0===u?n:this._cascades[u-1].breakDistance,this._cascades[u].breakDistance=(_-t)/s,this._viewSpaceFrustumsZ[u]=_,this._frustumLengths[u]=(this._cascades[u].breakDistance-this._cascades[u].prevBreakDistance)*s}this._breaksAreDirty=!1}_computeMatrices(){const e=this._scene;if(!this._getCamera())return;v.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),1===Math.abs(v.Dot(this._lightDirection,v.Up()))&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);const i=e.getEngine().useReverseDepthBuffer;for(let s=0;s<this._numCascades;++s){this._computeFrustumInWorldSpace(s),this._computeCascadeFrustum(s),this._cascadeMaxExtents[s].subtractToRef(this._cascadeMinExtents[s],ms),this._frustumCenter[s].addToRef(this._lightDirection.scale(this._cascadeMinExtents[s].z),this._shadowCameraPos[s]),F.LookAtLHToRef(this._shadowCameraPos[s],this._frustumCenter[s],VG,this._viewMatrices[s]);let n=0,o=ms.z;const a=this._shadowCastersBoundingInfo;a.update(this._viewMatrices[s]),o=Math.min(o,a.boundingBox.maximumWorld.z),n=this._depthClamp&&this.filter!==Qn.FILTER_PCSS?Math.max(n,a.boundingBox.minimumWorld.z):Math.min(n,a.boundingBox.minimumWorld.z),F.OrthoOffCenterLHToRef(this._cascadeMinExtents[s].x,this._cascadeMaxExtents[s].x,this._cascadeMinExtents[s].y,this._cascadeMaxExtents[s].y,i?o:n,i?n:o,this._projectionMatrices[s],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[s].z=n,this._cascadeMaxExtents[s].z=o,this._viewMatrices[s].multiplyToRef(this._projectionMatrices[s],this._transformMatrices[s]),v.TransformCoordinatesToRef(Kne,this._transformMatrices[s],ms),ms.scaleInPlace(this._mapSize/2),nd.copyFromFloats(Math.round(ms.x),Math.round(ms.y),Math.round(ms.z)),nd.subtractInPlace(ms).scaleInPlace(2/this._mapSize),F.TranslationToRef(nd.x,nd.y,0,eb),this._projectionMatrices[s].multiplyToRef(eb,this._projectionMatrices[s]),this._viewMatrices[s].multiplyToRef(this._projectionMatrices[s],this._transformMatrices[s]),this._transformMatrices[s].copyToArray(this._transformMatricesAsArray,16*s)}}_computeFrustumInWorldSpace(e){const t=this._getCamera();if(!t)return;const i=this._cascades[e].prevBreakDistance,s=this._cascades[e].breakDistance,n=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();const o=F.Invert(t.getTransformationMatrix()),a=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let l=0;l<Ls._FrustumCornersNDCSpace.length;++l)ms.copyFrom(Ls._FrustumCornersNDCSpace[(l+a)%Ls._FrustumCornersNDCSpace.length]),n&&-1===ms.z&&(ms.z=0),v.TransformCoordinatesToRef(ms,o,this._frustumCornersWorldSpace[e][l]);for(let l=0;l<Ls._FrustumCornersNDCSpace.length/2;++l)ms.copyFrom(this._frustumCornersWorldSpace[e][l+4]).subtractInPlace(this._frustumCornersWorldSpace[e][l]),nd.copyFrom(ms).scaleInPlace(i),ms.scaleInPlace(s),ms.addInPlace(this._frustumCornersWorldSpace[e][l]),this._frustumCornersWorldSpace[e][l+4].copyFrom(ms),this._frustumCornersWorldSpace[e][l].addInPlace(nd)}_computeCascadeFrustum(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),this._getCamera()){for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][i]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let i=0;for(let s=0;s<this._frustumCornersWorldSpace[e].length;++s){const n=this._frustumCornersWorldSpace[e][s].subtractToRef(this._frustumCenter[e],ms).length();i=Math.max(i,n)}i=Math.ceil(16*i)/16,this._cascadeMaxExtents[e].copyFromFloats(i,i,i),this._cascadeMinExtents[e].copyFromFloats(-i,-i,-i)}else{const i=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,ms),F.LookAtLHToRef(i,ms,VG,eb);for(let s=0;s<this._frustumCornersWorldSpace[e].length;++s)v.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][s],eb,ms),this._cascadeMinExtents[e].minimizeInPlace(ms),this._cascadeMaxExtents[e].maximizeInPlace(ms)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){const e=be.LastCreatedEngine;return!!e&&e._features.supportCSM}constructor(e,t,i,s){Ls.IsSupported?(super(e,t,i,s),this.usePercentageCloserFiltering=!0):V.Error("CascadedShadowMap is not supported by the current engine.")}_initializeGenerator(){var e,t,i,s,n,o,a,l,c,h,u,d,f,p,_,m,g,b,y,T;this.penumbraDarkness=null!==(e=this.penumbraDarkness)&&void 0!==e?e:1,this._numCascades=null!==(t=this._numCascades)&&void 0!==t?t:Ls.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=null!==(i=this.stabilizeCascades)&&void 0!==i&&i,this._freezeShadowCastersBoundingInfoObservable=null!==(s=this._freezeShadowCastersBoundingInfoObservable)&&void 0!==s?s:null,this.freezeShadowCastersBoundingInfo=null!==(n=this.freezeShadowCastersBoundingInfo)&&void 0!==n&&n,this._scbiMin=null!==(o=this._scbiMin)&&void 0!==o?o:new v(0,0,0),this._scbiMax=null!==(a=this._scbiMax)&&void 0!==a?a:new v(0,0,0),this._shadowCastersBoundingInfo=null!==(l=this._shadowCastersBoundingInfo)&&void 0!==l?l:new pn(new v(0,0,0),new v(0,0,0)),this._breaksAreDirty=null===(c=this._breaksAreDirty)||void 0===c||c,this._minDistance=null!==(h=this._minDistance)&&void 0!==h?h:0,this._maxDistance=null!==(u=this._maxDistance)&&void 0!==u?u:1,this._currentLayer=null!==(d=this._currentLayer)&&void 0!==d?d:0,this._shadowMaxZ=null!==(_=null!==(f=this._shadowMaxZ)&&void 0!==f?f:null===(p=this._getCamera())||void 0===p?void 0:p.maxZ)&&void 0!==_?_:1e4,this._debug=null!==(m=this._debug)&&void 0!==m&&m,this._depthClamp=null===(g=this._depthClamp)||void 0===g||g,this._cascadeBlendPercentage=null!==(b=this._cascadeBlendPercentage)&&void 0!==b?b:.1,this._lambda=null!==(y=this._lambda)&&void 0!==y?y:.5,this._autoCalcDepthBounds=null!==(T=this._autoCalcDepthBounds)&&void 0!==T&&T,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){const e=this._scene.getEngine();this._shadowMap=new Ss(this._light.name+"_CSMShadowMap",{width:this._mapSize,height:this._mapSize,layers:this.numCascades},this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)}_initializeShadowMap(){if(super._initializeShadowMap(),null===this._shadowMap)return;this._transformMatricesAsArray=new Float32Array(16*this._numCascades),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(2*this._numCascades),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let t=0;t<this._numCascades;++t){this._cascades[t]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[t]=F.Zero(),this._projectionMatrices[t]=F.Zero(),this._transformMatrices[t]=F.Zero(),this._cascadeMinExtents[t]=new v,this._cascadeMaxExtents[t]=new v,this._frustumCenter[t]=new v,this._shadowCameraPos[t]=new v,this._frustumCornersWorldSpace[t]=new Array(Ls._FrustumCornersNDCSpace.length);for(let i=0;i<Ls._FrustumCornersNDCSpace.length;++i)this._frustumCornersWorldSpace[t][i]=new v}const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===Qn.FILTER_PCF&&e.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onBeforeBindObservable.add(()=>{var t;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),null===(t=e._debugPushGroup)||void 0===t||t.call(e,`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()}),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==Qn.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);const i=this._scene;if(!i.shadowsEnabled||!this._light.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;const n=this._getCamera();n&&this._shadowMaxZ<n.maxZ&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),0===this.cascadeBlendPercentage&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const n=this._getCamera();if(!n)return;const o=this.getShadowMap();if(!o)return;const a=o.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,0===this.cascadeBlendPercentage?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===Qn.FILTER_PCF)t.setDepthStencilTexture("shadowSampler"+e,o),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a,1/a,this.frustumEdgeFalloff,e);else if(this._filter===Qn.FILTER_PCSS){for(let l=0;l<this._numCascades;++l)this._lightSizeUVCorrection[2*l+0]=0===l?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[l].x-this._cascadeMinExtents[l].x),this._lightSizeUVCorrection[2*l+1]=0===l?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[l].y-this._cascadeMinExtents[l].y),this._depthCorrection[l]=0===l?1:(this._cascadeMaxExtents[l].z-this._cascadeMinExtents[l].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowSampler"+e,o),t.setTexture("depthSampler"+e,o),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/a,this._contactHardeningLightSizeUVRatio*a,this.frustumEdgeFalloff,e)}else t.setTexture("shadowSampler"+e,o),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a,1/a,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(n),this.getLight().getDepthMinZ(n)+this.getLight().getDepthMaxZ(n),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){const e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++)e.renderList.push(t.renderList[i].id);return e}static Parse(e,t){const i=Qn.Parse(e,t,(s,n,o)=>new Ls(s,n,void 0,o));return void 0!==e.numCascades&&(i.numCascades=e.numCascades),void 0!==e.debug&&(i.debug=e.debug),void 0!==e.stabilizeCascades&&(i.stabilizeCascades=e.stabilizeCascades),void 0!==e.lambda&&(i.lambda=e.lambda),void 0!==e.cascadeBlendPercentage&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),void 0!==e.depthClamp&&(i.depthClamp=e.depthClamp),void 0!==e.autoCalcDepthBounds&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),void 0!==e.shadowMaxZ&&(i.shadowMaxZ=e.shadowMaxZ),void 0!==e.penumbraDarkness&&(i.penumbraDarkness=e.penumbraDarkness),void 0!==e.freezeShadowCastersBoundingInfo&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),void 0!==e.minDistance&&void 0!==e.maxDistance&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}}Ls._FrustumCornersNDCSpace=[new v(-1,1,-1),new v(1,1,-1),new v(1,-1,-1),new v(-1,-1,-1),new v(-1,1,1),new v(1,1,1),new v(1,-1,1),new v(-1,-1,1)],Ls.CLASSNAME="CascadedShadowGenerator",Ls.DEFAULT_CASCADES_COUNT=4,Ls.MIN_CASCADES_COUNT=2,Ls.MAX_CASCADES_COUNT=4,Ls._SceneComponentInitialization=r=>{throw Ge("ShadowGeneratorSceneComponent")},es.AddParser(Me.NAME_SHADOWGENERATOR,(r,e)=>{if(null!=r.shadowGenerators)for(let t=0,i=r.shadowGenerators.length;t<i;t++){const s=r.shadowGenerators[t];s.className===Ls.CLASSNAME?Ls.Parse(s,e):Qn.Parse(s,e)}});class Qne{constructor(e){this.name=Me.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Me.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];const t=this.scene.lights;for(const i of t){const s=i.getShadowGenerators();if(s){const n=s.values();for(let o=n.next();!0!==o.done;o=n.next())e.shadowGenerators.push(o.value.serialize())}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){const t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){const s=t.lights[i],n=s.getShadowGenerators();if(s.isEnabled()&&s.shadowEnabled&&n){const o=n.values();for(let a=o.next();!0!==a.done;a=o.next()){const c=a.value.getShadowMap();-1!==t.textures.indexOf(c)&&e.push(c)}}}}}Qn._SceneComponentInitialization=r=>{let e=r._getComponent(Me.NAME_SHADOWGENERATOR);e||(e=new Qne(r),r._addComponent(e))},Rt.AddNodeConstructor("Light_Type_0",(r,e)=>()=>new od(r,v.Zero(),e));class od extends Th{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){const i=this._shadowGenerators.values();for(let s=i.next();!0!==s.done;s=i.next())s.value.recreateShadowMap()}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return Je.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new v(1,0,0);case 1:return new v(-1,0,0);case 2:return new v(0,-1,0);case 3:return new v(0,1,0);case 4:return new v(0,0,1);case 5:return new v(0,0,-1)}return v.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;const n=void 0!==this.shadowMinZ?this.shadowMinZ:s.minZ,o=void 0!==this.shadowMaxZ?this.shadowMaxZ:s.maxZ,a=this.getScene().getEngine().useReverseDepthBuffer;F.PerspectiveFovLHToRef(this.shadowAngle,1,a?o:n,a?n:o,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,a)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}}E([I()],od.prototype,"shadowAngle",null);let Zne=(()=>{class r{constructor(t,i="",s="black"){this._renderingCanvas=t,this._loadingText=i,this._loadingDivBackgroundColor=s,this._resizeLoadingUI=()=>{const n=this._renderingCanvas.getBoundingClientRect(),o=window.getComputedStyle(this._renderingCanvas).position;!this._loadingDiv||(this._loadingDiv.style.position="fixed"===o?"fixed":"absolute",this._loadingDiv.style.left=n.left+"px",this._loadingDiv.style.top=n.top+"px",this._loadingDiv.style.width=n.width+"px",this._loadingDiv.style.height=n.height+"px")}}displayLoadingUI(){if(this._loadingDiv)return;this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingDiv.style.pointerEvents="none",this._loadingDiv.style.display="grid",this._loadingDiv.style.gridTemplateRows="100%",this._loadingDiv.style.gridTemplateColumns="100%",this._loadingDiv.style.justifyItems="center",this._loadingDiv.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText,this._style=document.createElement("style"),this._style.type="text/css",this._style.innerHTML="@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}\n                    100% { -webkit-transform: rotate(360deg);}\n                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}\n                    100% { transform: rotate(360deg);}\n                }",document.getElementsByTagName("head")[0].appendChild(this._style);const i=!!window.SVGSVGElement,s=new Image;s.src=r.DefaultLogoUrl?r.DefaultLogoUrl:i?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",s.style.width="150px",s.style.gridColumn="1",s.style.gridRow="1",s.style.top="50%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.position="absolute";const n=document.createElement("div");n.style.width="300px",n.style.gridColumn="1",n.style.gridRow="1",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.position="absolute";const o=new Image;if(o.src=r.DefaultSpinnerUrl?r.DefaultSpinnerUrl:i?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",o.style.animation="spin1 0.75s infinite linear",o.style.webkitAnimation="spin1 0.75s infinite linear",o.style.transformOrigin="50% 50%",o.style.webkitTransformOrigin="50% 50%",!i){const a={w:16,h:18.5},l={w:30,h:30};s.style.width=`${a.w}vh`,s.style.height=`${a.h}vh`,s.style.left=`calc(50% - ${a.w/2}vh)`,s.style.top=`calc(50% - ${a.h/2}vh)`,o.style.width=`${l.w}vh`,o.style.height=`${l.h}vh`,o.style.left=`calc(50% - ${l.w/2}vh)`,o.style.top=`calc(50% - ${l.h/2}vh)`}n.appendChild(o),this._loadingDiv.appendChild(s),this._loadingDiv.appendChild(n),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),this._loadingDiv.style.opacity="1"}hideLoadingUI(){this._loadingDiv&&(this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",()=>{this._loadingTextDiv&&(this._loadingTextDiv.remove(),this._loadingTextDiv=null),this._loadingDiv&&(this._loadingDiv.remove(),this._loadingDiv=null),this._style&&(this._style.remove(),this._style=null),window.removeEventListener("resize",this._resizeLoadingUI)}))}set loadingUIText(t){this._loadingText=t,this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)}get loadingUIText(){return this._loadingText}get loadingUIBackgroundColor(){return this._loadingDivBackgroundColor}set loadingUIBackgroundColor(t){this._loadingDivBackgroundColor=t,this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)}}return r.DefaultLogoUrl="",r.DefaultSpinnerUrl="",r})();ee.DefaultLoadingScreenFactory=r=>new Zne(r);class Eh{static ConvertPanoramaToCubemap(e,t,i,s){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*i*3)throw"ConvertPanoramaToCubemap: input size is wrong";return{front:this.CreateCubemapTexture(s,this.FACE_FRONT,e,t,i),back:this.CreateCubemapTexture(s,this.FACE_BACK,e,t,i),left:this.CreateCubemapTexture(s,this.FACE_LEFT,e,t,i),right:this.CreateCubemapTexture(s,this.FACE_RIGHT,e,t,i),up:this.CreateCubemapTexture(s,this.FACE_UP,e,t,i),down:this.CreateCubemapTexture(s,this.FACE_DOWN,e,t,i),size:s,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,t,i,s,n){const o=new ArrayBuffer(e*e*4*3),a=new Float32Array(o),l=t[1].subtract(t[0]).scale(1/e),c=t[3].subtract(t[2]).scale(1/e),h=1/e;let u=0;for(let d=0;d<e;d++){let f=t[0],p=t[2];for(let _=0;_<e;_++){const m=p.subtract(f).scale(u).add(f);m.normalize();const g=this.CalcProjectionSpherical(m,i,s,n);a[d*e*3+3*_+0]=g.r,a[d*e*3+3*_+1]=g.g,a[d*e*3+3*_+2]=g.b,f=f.add(l),p=p.add(c)}u+=h}return a}static CalcProjectionSpherical(e,t,i,s){let n=Math.atan2(e.z,e.x);const o=Math.acos(e.y);for(;n<-Math.PI;)n+=2*Math.PI;for(;n>Math.PI;)n-=2*Math.PI;let a=n/Math.PI;const l=o/Math.PI;a=.5*a+.5;let c=Math.round(a*i);c<0?c=0:c>=i&&(c=i-1);let h=Math.round(l*s);h<0?h=0:h>=s&&(h=s-1);const u=s-h-1;return{r:t[u*i*3+3*c+0],g:t[u*i*3+3*c+1],b:t[u*i*3+3*c+2]}}}Eh.FACE_LEFT=[new v(-1,-1,-1),new v(1,-1,-1),new v(-1,1,-1),new v(1,1,-1)],Eh.FACE_RIGHT=[new v(1,-1,1),new v(-1,-1,1),new v(1,1,1),new v(-1,1,1)],Eh.FACE_FRONT=[new v(1,-1,-1),new v(1,-1,1),new v(1,1,-1),new v(1,1,1)],Eh.FACE_BACK=[new v(-1,-1,1),new v(-1,-1,-1),new v(-1,1,1),new v(-1,1,-1)],Eh.FACE_DOWN=[new v(1,1,-1),new v(1,1,1),new v(-1,1,-1),new v(-1,1,1)],Eh.FACE_UP=[new v(-1,-1,-1),new v(-1,-1,1),new v(1,-1,-1),new v(1,-1,1)];class FC{static _Ldexp(e,t){return t>1023?e*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?e*Math.pow(2,-1074)*Math.pow(2,t+1074):e*Math.pow(2,t)}static _Rgbe2float(e,t,i,s,n,o){n>0?(n=this._Ldexp(1,n-136),e[o+0]=t*n,e[o+1]=i*n,e[o+2]=s*n):(e[o+0]=0,e[o+1]=0,e[o+2]=0)}static _ReadStringLine(e,t){let i="",s="";for(let n=t;n<e.length-t&&(s=String.fromCharCode(e[n]),"\n"!=s);n++)i+=s;return i}static RGBE_ReadHeader(e){let t=0,i=0,s=this._ReadStringLine(e,0);if("#"!=s[0]||"?"!=s[1])throw"Bad HDR Format.";let n=!1,o=!1,a=0;do{a+=s.length+1,s=this._ReadStringLine(e,a),"FORMAT=32-bit_rle_rgbe"==s?o=!0:0==s.length&&(n=!0)}while(!n);if(!o)throw"HDR Bad header format, unsupported FORMAT";a+=s.length+1,s=this._ReadStringLine(e,a);const c=/^-Y (.*) \+X (.*)$/g.exec(s);if(!c||c.length<3)throw"HDR Bad header format, no size";if(i=parseInt(c[2]),t=parseInt(c[1]),i<8||i>32767)throw"HDR Bad header format, unsupported size";return a+=s.length+1,{height:t,width:i,dataPosition:a}}static GetCubeMapTextureData(e,t){const i=new Uint8Array(e),s=this.RGBE_ReadHeader(i),n=this.RGBE_ReadPixels(i,s);return Eh.ConvertPanoramaToCubemap(n,s.width,s.height,t)}static RGBE_ReadPixels(e,t){return this._RGBEReadPixelsRLE(e,t)}static _RGBEReadPixelsRLE(e,t){let i=t.height;const s=t.width;let n,o,a,l,c,h=t.dataPosition,u=0,d=0,f=0;const p=new ArrayBuffer(4*s),_=new Uint8Array(p),m=new ArrayBuffer(t.width*t.height*4*3),g=new Float32Array(m);for(;i>0;){if(n=e[h++],o=e[h++],a=e[h++],l=e[h++],2!=n||2!=o||128&a||t.width<8||t.width>32767)return this._RGBEReadPixelsNOTRLE(e,t);if((a<<8|l)!=s)throw"HDR Bad header format, wrong scan line width";for(u=0,f=0;f<4;f++)for(d=(f+1)*s;u<d;)if(n=e[h++],o=e[h++],n>128){if(c=n-128,0==c||c>d-u)throw"HDR Bad Format, bad scanline data (run)";for(;c-- >0;)_[u++]=o}else{if(c=n,0==c||c>d-u)throw"HDR Bad Format, bad scanline data (non-run)";if(_[u++]=o,--c>0)for(let b=0;b<c;b++)_[u++]=e[h++]}for(f=0;f<s;f++)n=_[f],o=_[f+s],a=_[f+2*s],l=_[f+3*s],this._Rgbe2float(g,n,o,a,l,(t.height-i)*s*3+3*f);i--}return g}static _RGBEReadPixelsNOTRLE(e,t){let i=t.height;const s=t.width;let n,o,a,l,c,h=t.dataPosition;const u=new ArrayBuffer(t.width*t.height*4*3),d=new Float32Array(u);for(;i>0;){for(c=0;c<t.width;c++)n=e[h++],o=e[h++],a=e[h++],l=e[h++],this._Rgbe2float(d,n,o,a,l,(t.height-i)*s*3+3*c);i--}return d}}j.ShadersStore.hdrFilteringVertexShader="attribute vec2 position;\nvarying vec3 direction;\nuniform vec3 up;\nuniform vec3 right;\nuniform vec3 front;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nmat3 view=mat3(up,right,front);\ndirection=view*vec3(position,1.0);\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";j.ShadersStore.hdrFilteringPixelShader="#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nuniform float alphaG;\nuniform samplerCube inputTexture;\nuniform vec2 vFilteringInfo;\nuniform float hdrScale;\nvarying vec3 direction;\nvoid main() {\nvec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);\ngl_FragColor=vec4(color*hdrScale,1.0);\n}";class Jne{constructor(e,t={}){this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);const i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),this._engine.updateTextureSamplingMode(3,i.texture,!0),i}_prefilterInternal(e){const t=e.getSize().width,i=oe.ILog2(t)+1,s=this._effectWrapper.effect,n=this._createRenderTarget(t);this._effectRenderer.setViewport();const o=e.getInternalTexture();o&&this._engine.updateTextureSamplingMode(3,o,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);const a=[[new v(0,0,-1),new v(0,-1,0),new v(1,0,0)],[new v(0,0,1),new v(0,-1,0),new v(-1,0,0)],[new v(1,0,0),new v(0,0,1),new v(0,1,0)],[new v(1,0,0),new v(0,0,-1),new v(0,-1,0)],[new v(1,0,0),new v(0,-1,0),new v(0,0,1)],[new v(-1,0,0),new v(0,-1,0),new v(0,0,-1)]];s.setFloat("hdrScale",this.hdrScale),s.setFloat2("vFilteringInfo",e.getSize().width,i),s.setTexture("inputTexture",e);for(let l=0;l<6;l++){s.setVector3("up",a[l][0]),s.setVector3("right",a[l][1]),s.setVector3("front",a[l][2]);for(let c=0;c<i;c++){this._engine.bindFramebuffer(n,l,void 0,void 0,!0,c),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let h=Math.pow(2,(c-this._lodGenerationOffset)/this._lodGenerationScale)/t;0===c&&(h=0),s.setFloat("alphaG",h),this._effectRenderer.draw()}}return this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(e._texture),n._swapAndDie(e._texture),e._prefiltered=!0,e}_createEffect(e,t){const i=[];return e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u"),new sl({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:i,onCompiled:t})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}prefilter(e,t=null){return this._engine._features.allowTexturePrefiltering?new Promise(i=>{this._effectRenderer=new uv(this._engine),this._effectWrapper=this._createEffect(e),this._effectWrapper.effect.executeWhenCompiled(()=>{this._prefilterInternal(e),this._effectRenderer.dispose(),this._effectWrapper.dispose(),i(),t&&t()})}):(V.Warn("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."),Promise.reject("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."))}}let HG=(()=>{class r extends kt{set isBlocking(t){this._isBlocking=t}get isBlocking(){return this._isBlocking}set rotationY(t){this._rotationY=t,this.setReflectionTextureMatrix(F.RotationY(this._rotationY))}get rotationY(){return this._rotationY}set boundingBoxSize(t){if(this._boundingBoxSize&&this._boundingBoxSize.equals(t))return;this._boundingBoxSize=t;const i=this.getScene();i&&i.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}constructor(t,i,s,n=!1,o=!0,a=!1,l=!1,c=null,h=null){var u;super(i),this._generateHarmonics=!0,this._onError=null,this._isBlocking=!0,this._rotationY=0,this.boundingBoxPosition=v.Zero(),this.onLoadObservable=new z,t&&(this._coordinatesMode=U.CUBIC_MODE,this.name=t,this.url=t,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=F.Identity(),this._prefilterOnLoad=l,this._onLoad=()=>{this.onLoadObservable.notifyObservers(this),c&&c()},this._onError=h,this.gammaSpace=a,this._noMipmap=n,this._size=s,this._generateHarmonics=o,this._texture=this._getFromCache(t,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?this._texture.isReady?q.SetImmediate(()=>this._onLoad()):this._texture.onLoadedObservable.add(this._onLoad):null!==(u=this.getScene())&&void 0!==u&&u.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture())}getClassName(){return"HDRCubeTexture"}_loadTexture(){const t=this._getEngine(),i=t.getCaps();let s=0;if(i.textureFloat&&i.textureFloatLinearFiltering?s=1:i.textureHalfFloat&&i.textureHalfFloatLinearFiltering&&(s=2),t._features.allowTexturePrefiltering&&this._prefilterOnLoad){const o=this._onLoad,a=new Jne(t);this._onLoad=()=>{a.prefilter(this,o)}}this._texture=t.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,s,this._noMipmap,o=>{this.lodGenerationOffset=0,this.lodGenerationScale=.8;const a=FC.GetCubeMapTextureData(o,this._size);if(this._generateHarmonics){const u=Fv.ConvertCubeMapToSphericalPolynomial(a);this.sphericalPolynomial=u}const l=[];let c=null,h=null;for(let u=0;u<6;u++){2===s?h=new Uint16Array(this._size*this._size*3):0===s&&(c=new Uint8Array(this._size*this._size*3));const d=a[r._FacesMapping[u]];if(this.gammaSpace||h||c)for(let f=0;f<this._size*this._size;f++)if(this.gammaSpace&&(d[3*f+0]=Math.pow(d[3*f+0],Jf),d[3*f+1]=Math.pow(d[3*f+1],Jf),d[3*f+2]=Math.pow(d[3*f+2],Jf)),h&&(h[3*f+0]=ma(d[3*f+0]),h[3*f+1]=ma(d[3*f+1]),h[3*f+2]=ma(d[3*f+2])),c){let p=Math.max(255*d[3*f+0],0),_=Math.max(255*d[3*f+1],0),m=Math.max(255*d[3*f+2],0);const g=Math.max(Math.max(p,_),m);if(g>255){const b=255/g;p*=b,_*=b,m*=b}c[3*f+0]=p,c[3*f+1]=_,c[3*f+2]=m}l.push(h||c||d)}return l},null,this._onLoad,this._onError)}clone(){const t=new r(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t}delayLoad(){4===this.delayLoadState&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture())}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(t){var i;this._textureMatrix=t,t.updateFlag!==this._textureMatrix.updateFlag&&t.isIdentity()!==this._textureMatrix.isIdentity()&&(null===(i=this.getScene())||void 0===i||i.markAllMaterialsAsDirty(1,s=>-1!==s.getActiveTextures().indexOf(this)))}dispose(){this.onLoadObservable.clear(),super.dispose()}static Parse(t,i,s){let n=null;return t.name&&!t.isRenderTarget&&(n=new r(s+t.name,i,t.size,t.noMipmap,t.generateHarmonics,t.useInGammaSpace),n.name=t.name,n.hasAlpha=t.hasAlpha,n.level=t.level,n.coordinatesMode=t.coordinatesMode,n.isBlocking=t.isBlocking),n&&(t.boundingBoxPosition&&(n.boundingBoxPosition=v.FromArray(t.boundingBoxPosition)),t.boundingBoxSize&&(n.boundingBoxSize=v.FromArray(t.boundingBoxSize)),t.rotationY&&(n.rotationY=t.rotationY)),n}serialize(){if(!this.name)return null;const t={};return t.name=this.name,t.hasAlpha=this.hasAlpha,t.isCube=!0,t.level=this.level,t.size=this._size,t.coordinatesMode=this.coordinatesMode,t.useInGammaSpace=this.gammaSpace,t.generateHarmonics=this._generateHarmonics,t.customType="BABYLON.HDRCubeTexture",t.noMipmap=this._noMipmap,t.isBlocking=this._isBlocking,t.rotationY=this._rotationY,t}}return r._FacesMapping=["right","left","up","down","front","back"],r})();le("BABYLON.HDRCubeTexture",HG);class Ch{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(0===t||0===e)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,i=null){this.name=e,this.animations=new Array,this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new z,this._onDataLayoutChanged=new z,this._animationPropertiesOverride=null,this._scene=i||be.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}clone(){const e=Ce.Clone(()=>new Ch(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),null!=this.id&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),Ce.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const i=new Ch(e.name,e.influence);if(i.setPositions(e.positions),null!=e.id&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.animations){for(let s=0;s<e.animations.length;s++){const n=e.animations[s],o=hs("BABYLON.Animation");o&&i.animations.push(o.Parse(n))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);const s=new Ch(t,i,e.getScene());return s.setPositions(e.getVerticesData(A.PositionKind)),e.isVerticesDataPresent(A.NormalKind)&&s.setNormals(e.getVerticesData(A.NormalKind)),e.isVerticesDataPresent(A.TangentKind)&&s.setTangents(e.getVerticesData(A.TangentKind)),e.isVerticesDataPresent(A.UVKind)&&s.setUVs(e.getVerticesData(A.UVKind)),s}}E([I()],Ch.prototype,"id",void 0);class LC extends U{get depth(){return this._depth}constructor(e,t,i,s,n,o,a=!0,l=!1,c=U.TRILINEAR_SAMPLINGMODE,h=0){super(null,o,!a,l),this.format=n,this._texture=o.getEngine().createRawTexture2DArray(e,t,i,s,n,a,l,c,null,h),this._depth=s,this.is2DArray=!0}update(e){!this._texture||this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,s,n,o=!0,a=!1,l=3,c=0){return new LC(e,t,i,s,5,n,o,a,l,c)}}let BC=(()=>{class r{set areUpdatesFrozen(t){t?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(t=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new ws(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._useTextureToStoreTargets=!0,t||(t=be.LastCreatedScene),this._scene=t,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const i=this._scene.getEngine().getCaps();this._canUseTextureForTargets=i.canUseGLVertexID&&i.textureFloat&&i.maxVertexTextureImageUnits>0&&i.texture2DArrayMaxLayerCount>1}}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(t){this._useTextureToStoreTargets=t}get isUsingTextureForTargets(){return r.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets}getActiveTarget(t){return this._activeTargets.data[t]}getTarget(t){return this._targets[t]}addTarget(t){this._targets.push(t),this._targetInfluenceChangedObservers.push(t.onInfluenceChanged.add(i=>{this._syncActiveTargets(i)})),this._targetDataLayoutChangedObservers.push(t._onDataLayoutChanged.add(()=>{this._syncActiveTargets(!0)})),this._syncActiveTargets(!0)}removeTarget(t){const i=this._targets.indexOf(t);i>=0&&(this._targets.splice(i,1),t.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(i,1)[0]),t._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(i,1)[0]),this._syncActiveTargets(!0)),this._scene&&this._scene.stopAnimation(t)}_bind(t){t.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),t.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),t.setTexture("morphTargets",this._targetStoreTexture)}clone(){const t=new r(this._scene);for(const i of this._targets)t.addTarget(i.clone());return t.enableNormalMorphing=this.enableNormalMorphing,t.enableTangentMorphing=this.enableTangentMorphing,t.enableUVMorphing=this.enableUVMorphing,t}serialize(){const t={};t.id=this.uniqueId,t.targets=[];for(const i of this._targets)t.targets.push(i.serialize());return t}_syncActiveTargets(t){if(this.areUpdatesFrozen)return;let i=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,this._scene&&this._targets.length>this._scene.getEngine().getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1),(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let s=-1;for(const n of this._targets){if(s++,0===n.influence&&this.optimizeInfluencers)continue;if(this._activeTargets.length>=r.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(n),this._morphTargetTextureIndices[i]=s,this._tempInfluences[i++]=n.influence,this._supportsNormals=this._supportsNormals&&n.hasNormals,this._supportsTangents=this._supportsTangents&&n.hasTangents,this._supportsUVs=this._supportsUVs&&n.hasUVs;const o=n.getPositions();if(o){const a=o.length/3;if(0===this._vertexCount)this._vertexCount=a;else if(this._vertexCount!==a)return void V.Error("Incompatible target. Targets must all have the same vertices count.")}}(!this._influences||this._influences.length!==i)&&(this._influences=new Float32Array(i));for(let n=0;n<i;n++)this._influences[n]=this._tempInfluences[n];t&&this.synchronize()}synchronize(){if(this._scene&&!this.areUpdatesFrozen){if(this.isUsingTextureForTargets&&this._vertexCount){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride,this._textureHeight=1;const t=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>t&&(this._textureHeight=Math.ceil(this._textureWidth/t),this._textureWidth=t);let i=!0;if(this._targetStoreTexture){const s=this._targetStoreTexture.getSize();s.width===this._textureWidth&&s.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(i=!1)}if(i){this._targetStoreTexture&&this._targetStoreTexture.dispose();const s=this._targets.length,n=new Float32Array(s*this._textureWidth*this._textureHeight*4);let o=0;for(let a=0;a<s;a++){const l=this._targets[a],c=l.getPositions(),h=l.getNormals(),u=l.getUVs(),d=l.getTangents();if(!c)return void(0===a&&V.Error("Invalid morph target. Target must have positions."));o=a*this._textureWidth*this._textureHeight*4;for(let f=0;f<this._vertexCount;f++)n[o]=c[3*f],n[o+1]=c[3*f+1],n[o+2]=c[3*f+2],o+=4,h&&(n[o]=h[3*f],n[o+1]=h[3*f+1],n[o+2]=h[3*f+2],o+=4),u&&(n[o]=u[2*f],n[o+1]=u[2*f+1],o+=4),d&&(n[o]=d[3*f],n[o+1]=d[3*f+1],n[o+2]=d[3*f+2],o+=4)}this._targetStoreTexture=LC.CreateRGBATexture(n,this._textureWidth,this._textureHeight,s,this._scene,!1,!1,1,1)}}for(const t of this._scene.meshes)t.morphTargetManager===this&&t._syncGeometryWithMorphTargetManager()}}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const t=this._parentContainer.morphTargetManagers.indexOf(this);t>-1&&this._parentContainer.morphTargetManagers.splice(t,1),this._parentContainer=null}for(const t of this._targets)this._scene.stopAnimation(t)}}static Parse(t,i){const s=new r(i);s._uniqueId=t.id;for(const n of t.targets)s.addTarget(Ch.Parse(n,i));return s}}return r.EnableTextureStorage=!0,r.MaxActiveMorphTargetsInVertexAttributeMode=8,r})();class tb{constructor(){this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=v.Zero(),this._hitPointWorld=v.Zero(),this._rayFromWorld=v.Zero(),this._rayToWorld=v.Zero()}get hasHit(){return this._hasHit}get hitDistance(){return this._hitDistance}get hitNormalWorld(){return this._hitNormalWorld}get hitPointWorld(){return this._hitPointWorld}get rayFromWorld(){return this._rayFromWorld}get rayToWorld(){return this._rayToWorld}setHitData(e,t){this._hasHit=!0,this._hitNormalWorld=new v(e.x,e.y,e.z),this._hitPointWorld=new v(t.x,t.y,t.z)}setHitDistance(e){this._hitDistance=e}calculateHitDistance(){this._hitDistance=v.Distance(this._rayFromWorld,this._hitPointWorld)}reset(e=v.Zero(),t=v.Zero()){this._rayFromWorld=e,this._rayToWorld=t,this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=v.Zero(),this._hitPointWorld=v.Zero()}}class ib{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw Ge("CannonJSPlugin")}constructor(e,t=ib.DefaultPluginFactory()){if(this._physicsPlugin=t,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new v(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._impostors.forEach(function(e){e.dispose()}),this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}addImpostor(e){this._impostors.push(e),e.uniqueId=this._uniqueIdCounter++,e.parent||this._physicsPlugin.generatePhysicsBody(e)}removeImpostor(e){const t=this._impostors.indexOf(e);t>-1&&this._impostors.splice(t,1).length&&this.getPhysicsPlugin().removePhysicsBody(e)}addJoint(e,t,i){const s={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(s),this._physicsPlugin.generateJoint(s)}removeJoint(e,t,i){const s=this._joints.filter(function(n){return n.connectedImpostor===t&&n.joint===i&&n.mainImpostor===e});s.length&&this._physicsPlugin.removeJoint(s[0])}_step(e){this._impostors.forEach(t=>{t.isBodyInitRequired()&&this._physicsPlugin.generatePhysicsBody(t)}),e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)}getPhysicsPlugin(){return this._physicsPlugin}getImpostors(){return this._impostors}getImpostorForPhysicsObject(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null}getImpostorWithPhysicsBody(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null}raycast(e,t){return this._physicsPlugin.raycast(e,t)}raycastToRef(e,t,i){return this._physicsPlugin.raycastToRef(e,t,i)}}class VC{constructor(e=!0,t=10,i=CANNON){this._useDeltaForWorldStep=e,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=new Array,this._firstFrame=!0,this._tmpQuaternion=new Z,this._minus90X=new Z(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new Z(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=v.Zero(),this._tmpDeltaPosition=v.Zero(),this._tmpUnityRotation=new Z,this.BJSCANNON=i,this.isSupported()?(this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=t,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new tb):V.Error("CannonJS is not available. Please make sure you included the js file.")}getPluginVersion(){return 1}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){if(this._firstFrame){this._firstFrame=!1;for(const i of t)i.type==Be.HeightmapImpostor||i.type===Be.PlaneImpostor||i.beforeStep()}this.world.step(this._useDeltaForWorldStep?e:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()}_removeMarkedPhysicsBodiesFromWorld(){this._physicsBodiesToRemoveAfterStep.length>0&&(this._physicsBodiesToRemoveAfterStep.forEach(e=>{"function"==typeof this.world.removeBody?this.world.removeBody(e):this.world.remove(e)}),this._physicsBodiesToRemoveAfterStep.length=0)}applyImpulse(e,t,i){const s=new this.BJSCANNON.Vec3(i.x,i.y,i.z),n=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyImpulse(n,s)}applyForce(e,t,i){const s=new this.BJSCANNON.Vec3(i.x,i.y,i.z),n=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyForce(n,s)}generatePhysicsBody(e){if(this._removeMarkedPhysicsBodiesFromWorld(),e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else{if(e.isBodyInitRequired()){const t=this._createShape(e);if(!t)return void V.Warn("It was not possible to create a physics body for this object.");const i=e.physicsBody;i&&this.removePhysicsBody(e);const s=this._addMaterial("mat-"+e.uniqueId,e.getParam("friction"),e.getParam("restitution")),n={mass:e.getParam("mass"),material:s},o=e.getParam("nativeOptions");for(const a in o)Object.prototype.hasOwnProperty.call(o,a)&&(n[a]=o[a]);e.physicsBody=new this.BJSCANNON.Body(n),e.physicsBody.addEventListener("collide",e.onCollide),this.world.addEventListener("preStep",e.beforeStep),this.world.addEventListener("postStep",e.afterStep),e.physicsBody.addShape(t),"function"==typeof this.world.addBody?this.world.addBody(e.physicsBody):this.world.add(e.physicsBody),i&&["force","torque","velocity","angularVelocity"].forEach(function(a){const l=i[a];e.physicsBody[a].set(l.x,l.y,l.z)}),this._processChildMeshes(e)}this._updatePhysicsBodyTransformation(e)}}_processChildMeshes(e){const t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[],i=e.object.rotationQuaternion;if(i?i.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),t.length){const s=n=>{if(!n.rotationQuaternion)return;const o=n.getPhysicsImpostor();if(o&&o.parent!==e&&n.parent){const l=n.getAbsolutePosition().subtract(n.parent.getAbsolutePosition()),c=n.rotationQuaternion.multiply(this._tmpQuaternion);o.physicsBody&&(this.removePhysicsBody(o),o.physicsBody=null),o.parent=e,o.resetUpdateFlags(),e.physicsBody.addShape(this._createShape(o),new this.BJSCANNON.Vec3(l.x,l.y,l.z),new this.BJSCANNON.Quaternion(c.x,c.y,c.z,c.w)),e.physicsBody.mass+=o.getParam("mass")}n.getChildMeshes(!0).filter(a=>!!a.physicsImpostor).forEach(s)};t.filter(n=>!!n.physicsImpostor).forEach(s)}}removePhysicsBody(e){e.physicsBody.removeEventListener("collide",e.onCollide),this.world.removeEventListener("preStep",e.beforeStep),this.world.removeEventListener("postStep",e.afterStep),-1===this._physicsBodiesToRemoveAfterStep.indexOf(e.physicsBody)&&this._physicsBodiesToRemoveAfterStep.push(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;let s;const n=e.joint.jointData,o={pivotA:n.mainPivot?(new this.BJSCANNON.Vec3).set(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z):null,pivotB:n.connectedPivot?(new this.BJSCANNON.Vec3).set(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z):null,axisA:n.mainAxis?(new this.BJSCANNON.Vec3).set(n.mainAxis.x,n.mainAxis.y,n.mainAxis.z):null,axisB:n.connectedAxis?(new this.BJSCANNON.Vec3).set(n.connectedAxis.x,n.connectedAxis.y,n.connectedAxis.z):null,maxForce:n.nativeParams.maxForce,collideConnected:!!n.collision};switch(e.joint.type){case $t.HingeJoint:case $t.Hinge2Joint:s=new this.BJSCANNON.HingeConstraint(t,i,o);break;case $t.DistanceJoint:s=new this.BJSCANNON.DistanceConstraint(t,i,n.maxDistance||2);break;case $t.SpringJoint:s=new this.BJSCANNON.Spring(t,i,{restLength:n.length,stiffness:n.stiffness,damping:n.damping,localAnchorA:o.pivotA,localAnchorB:o.pivotB});break;case $t.LockJoint:s=new this.BJSCANNON.LockConstraint(t,i,o);break;default:s=new this.BJSCANNON.PointToPointConstraint(t,o.pivotA,i,o.pivotB,o.maxForce)}s.collideConnected=!!n.collision,e.joint.physicsJoint=s,e.joint.type!==$t.SpringJoint?this.world.addConstraint(s):(e.joint.jointData.forceApplicationCallback=e.joint.jointData.forceApplicationCallback||function(){s.applyForce()},e.mainImpostor.registerAfterPhysicsStep(e.joint.jointData.forceApplicationCallback))}removeJoint(e){e.joint.type!==$t.SpringJoint?this.world.removeConstraint(e.joint.physicsJoint):e.mainImpostor.unregisterAfterPhysicsStep(e.joint.jointData.forceApplicationCallback)}_addMaterial(e,t,i){let s,n;for(s=0;s<this._physicsMaterials.length;s++)if(n=this._physicsMaterials[s],n.friction===t&&n.restitution===i)return n;const o=new this.BJSCANNON.Material(e);return o.friction=t,o.restitution=i,this._physicsMaterials.push(o),o}_checkWithEpsilon(e){return e<ot?ot:e}_createShape(e){const t=e.object;let i;const s=e.getObjectExtents();switch(e.type){case Be.SphereImpostor:{const o=s.y,a=s.z;i=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(s.x),this._checkWithEpsilon(o),this._checkWithEpsilon(a))/2);break}case Be.CylinderImpostor:{let n=e.getParam("nativeOptions");n||(n={});const o=void 0!==n.radiusTop?n.radiusTop:this._checkWithEpsilon(s.x)/2,a=void 0!==n.radiusBottom?n.radiusBottom:this._checkWithEpsilon(s.x)/2,l=void 0!==n.height?n.height:this._checkWithEpsilon(s.y);i=new this.BJSCANNON.Cylinder(o,a,l,void 0!==n.numSegments?n.numSegments:16);const h=new this.BJSCANNON.Quaternion;h.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);const u=new this.BJSCANNON.Vec3(0,0,0);i.transformAllPoints(u,h);break}case Be.BoxImpostor:{const n=s.scale(.5);i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(n.x),this._checkWithEpsilon(n.y),this._checkWithEpsilon(n.z)));break}case Be.PlaneImpostor:V.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),i=new this.BJSCANNON.Plane;break;case Be.MeshImpostor:{const n=t.getVerticesData?t.getVerticesData(A.PositionKind):[],o=t.getIndices?t.getIndices():[];if(!n)return void V.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");const a=t.position.clone(),l=t.rotation&&t.rotation.clone(),c=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace();const h=t.computeWorldMatrix(!0),u=new Array;let d;for(d=0;d<n.length;d+=3)v.TransformCoordinates(v.FromArray(n,d),h).toArray(u,d);V.Warn("MeshImpostor only collides against spheres."),i=new this.BJSCANNON.Trimesh(u,o),t.position.copyFrom(a),l&&t.rotation&&t.rotation.copyFrom(l),c&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(c);break}case Be.HeightmapImpostor:{const n=t.position.clone(),o=t.rotation&&t.rotation.clone(),a=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace(),t.rotationQuaternion&&t.rotationQuaternion.multiplyInPlace(this._minus90X),i=this._createHeightmap(t),t.position.copyFrom(n),o&&t.rotation&&t.rotation.copyFrom(o),a&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(a),t.computeWorldMatrix(!0);break}case Be.ParticleImpostor:i=new this.BJSCANNON.Particle;break;case Be.NoImpostor:i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0))}return i}_createHeightmap(e,t){let i=e.getVerticesData(A.PositionKind);const s=e.computeWorldMatrix(!0),n=new Array;let o;for(o=0;o<i.length;o+=3)v.TransformCoordinates(v.FromArray(i,o),s).toArray(n,o);i=n;const a=new Array,l=t||~~(Math.sqrt(i.length/3)-1),c=e.getBoundingInfo(),h=Math.min(c.boundingBox.extendSizeWorld.x,c.boundingBox.extendSizeWorld.y),u=c.boundingBox.extendSizeWorld.z,d=2*h/l;for(let p=0;p<i.length;p+=3){const _=Math.round(i[p+0]/d+l/2),m=Math.round(-1*(i[p+1]/d-l/2)),g=-i[p+2]+u;a[_]||(a[_]=[]),a[_][m]||(a[_][m]=g),a[_][m]=Math.max(g,a[_][m])}for(let p=0;p<=l;++p){if(!a[p]){let _=1;for(;!a[(p+_)%l];)_++;a[p]=a[(p+_)%l].slice()}for(let _=0;_<=l;++_)if(!a[p][_]){let g,m=1;for(;void 0===g;)g=a[p][(_+m++)%l];a[p][_]=g}}const f=new this.BJSCANNON.Heightfield(a,{elementSize:d});return f.minY=u,f}_updatePhysicsBodyTransformation(e){const t=e.object;if(t.computeWorldMatrix&&t.computeWorldMatrix(!0),!t.getBoundingInfo())return;const i=e.getObjectCenter();this._tmpDeltaPosition.copyFrom(t.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(e.object.scaling),this._tmpPosition.copyFrom(i);let s=t.rotationQuaternion;if(s){if((e.type===Be.PlaneImpostor||e.type===Be.HeightmapImpostor)&&(s=s.multiply(this._minus90X),e.setDeltaRotation(this._plus90X)),e.type===Be.HeightmapImpostor){const n=t;let o=n.getBoundingInfo();const a=n.rotationQuaternion;n.rotationQuaternion=this._tmpUnityRotation,n.computeWorldMatrix(!0);const l=i.clone();let c=n.getPivotMatrix();c=c?c.clone():F.Identity();const h=F.Translation(o.boundingBox.extendSizeWorld.x,0,-o.boundingBox.extendSizeWorld.z);n.setPreTransformMatrix(h),n.computeWorldMatrix(!0),o=n.getBoundingInfo();const u=o.boundingBox.centerWorld.subtract(i).subtract(n.position).negate();this._tmpPosition.copyFromFloats(u.x,u.y-o.boundingBox.extendSizeWorld.y,u.z),this._tmpDeltaPosition.copyFrom(o.boundingBox.centerWorld.subtract(l)),this._tmpDeltaPosition.y+=o.boundingBox.extendSizeWorld.y,n.rotationQuaternion=a,n.setPreTransformMatrix(c),n.computeWorldMatrix(!0)}else e.type===Be.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpDeltaPosition),e.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),e.physicsBody.quaternion.set(s.x,s.y,s.z,s.w)}}setTransformationFromPhysicsBody(e){if(e.object.position.set(e.physicsBody.position.x,e.physicsBody.position.y,e.physicsBody.position.z),e.object.rotationQuaternion){const t=e.physicsBody.quaternion;e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}setPhysicsBodyTransformation(e,t,i){e.physicsBody.position.set(t.x,t.y,t.z),e.physicsBody.quaternion.set(i.x,i.y,i.z,i.w)}isSupported(){return void 0!==this.BJSCANNON}setLinearVelocity(e,t){e.physicsBody.velocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.velocity;return t?new v(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new v(t.x,t.y,t.z):null}setBodyMass(e,t){e.physicsBody.mass=t,e.physicsBody.updateMassProperties()}getBodyMass(e){return e.physicsBody.mass}getBodyFriction(e){return e.physicsBody.material.friction}setBodyFriction(e,t){e.physicsBody.material.friction=t}getBodyRestitution(e){return e.physicsBody.material.restitution}setBodyRestitution(e,t){e.physicsBody.material.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.wakeUp()}updateDistanceJoint(e,t){e.physicsJoint.distance=t}setMotor(e,t,i,s){s||(e.physicsJoint.enableMotor(),e.physicsJoint.setMotorSpeed(t),i&&this.setLimit(e,i))}setLimit(e,t,i){e.physicsJoint.motorEquation.maxForce=i,e.physicsJoint.motorEquation.minForce=void 0===t?-t:t}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.quaternion.x,e.rotationQuaternion.y=i.quaternion.y,e.rotationQuaternion.z=i.quaternion.z,e.rotationQuaternion.w=i.quaternion.w)}getRadius(e){return e.physicsBody.shapes[0].boundingSphereRadius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes[0];t.x=2*i.halfExtents.x,t.y=2*i.halfExtents.y,t.z=2*i.halfExtents.z}dispose(){}_extendNamespace(){const e=new this.BJSCANNON.Vec3,t=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,s,n){if(n=n||10,0===(s=s||0))this.internalStep(i),this.time+=i;else{let o=Math.floor((this.time+s)/i)-Math.floor(this.time/i);o=Math.min(o,n)||1;const a=performance.now();for(let d=0;d!==o&&(this.internalStep(i),!(performance.now()-a>1e3*i));d++);this.time+=s;const c=this.time%i/i,h=e,u=this.bodies;for(let d=0;d!==u.length;d++){const f=u[d];f.type!==t.Body.STATIC&&f.sleepState!==t.Body.SLEEPING?(f.position.vsub(f.previousPosition,h),h.scale(c,h),f.position.vadd(h,f.interpolatedPosition)):(f.interpolatedPosition.set(f.position.x,f.position.y,f.position.z),f.interpolatedQuaternion.set(f.quaternion.x,f.quaternion.y,f.quaternion.z,f.quaternion.w))}}}}raycast(e,t){return this._raycastResult.reset(e,t),this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._cannonRaycastResult.reset(),this.world.raycastClosest(e,t,{},this._cannonRaycastResult),i.reset(e,t),this._cannonRaycastResult.hasHit&&(i.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),i.setHitDistance(this._cannonRaycastResult.distance))}}ib.DefaultPluginFactory=()=>new VC;class WG{constructor(e=!0,t,i=OIMO){this._useDeltaForWorldStep=e,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=v.Zero(),this.BJSOIMO=i,this.world=new this.BJSOIMO.World({iterations:t}),this.world.clear(),this._raycastResult=new tb}getPluginVersion(){return 1}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this.world.timeStep=e}getTimeStep(){return this.world.timeStep}executeStep(e,t){t.forEach(function(s){s.beforeStep()}),this.world.timeStep=this._useDeltaForWorldStep?e:this._fixedTimeStep,this.world.step(),t.forEach(s=>{s.afterStep(),this._tmpImpostorsArray[s.uniqueId]=s});let i=this.world.contacts;for(;null!==i;){if(i.touching&&!i.body1.sleeping&&!i.body2.sleeping){i=i.next;continue}const s=this._tmpImpostorsArray[+i.body1.name],n=this._tmpImpostorsArray[+i.body2.name];s&&n?(s.onCollide({body:n.physicsBody,point:null,distance:0,impulse:0,normal:null}),n.onCollide({body:s.physicsBody,point:null,distance:0,impulse:0,normal:null}),i=i.next):i=i.next}}applyImpulse(e,t,i){const s=e.physicsBody.mass;e.physicsBody.applyImpulse(i.scale(this.world.invScale),t.scale(this.world.invScale*s))}applyForce(e,t,i){V.Warn("Oimo doesn't support applying force. Using impulse instead."),this.applyImpulse(e,t,i)}generatePhysicsBody(e){if(e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else{if(e.isBodyInitRequired()){const t={name:e.uniqueId,config:[e.getParam("mass")||.001,e.getParam("friction"),e.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:0!==e.getParam("mass"),density:e.getParam("mass"),friction:e.getParam("friction"),restitution:e.getParam("restitution"),world:this.world},i=[e];!(a=e.object).getChildMeshes||a.getChildMeshes().forEach(function(l){l.physicsImpostor&&i.push(l.physicsImpostor)});const n=a=>Math.max(a,ot),o=new Z;i.forEach(a=>{if(!a.object.rotationQuaternion)return;const l=a.object.rotationQuaternion;o.copyFrom(l),a.object.rotationQuaternion.set(0,0,0,1),a.object.computeWorldMatrix(!0);const c=o.toEulerAngles(),h=a.getObjectExtents(),u=57.29577951308232;if(a===e){const d=e.getObjectCenter();e.object.getAbsolutePivotPoint().subtractToRef(d,this._tmpPositionVector),this._tmpPositionVector.divideInPlace(e.object.scaling),t.pos.push(d.x),t.pos.push(d.y),t.pos.push(d.z),t.posShape.push(0,0,0),t.rotShape.push(0,0,0)}else{const d=a.object.position.clone();t.posShape.push(d.x),t.posShape.push(d.y),t.posShape.push(d.z),t.rotShape.push(c.x*u,c.y*u,c.z*u)}switch(a.object.rotationQuaternion.copyFrom(o),a.type){case Be.ParticleImpostor:V.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case Be.SphereImpostor:{const f=h.y,p=h.z,_=Math.max(n(h.x),n(f),n(p))/2;t.type.push("sphere"),t.size.push(_),t.size.push(_),t.size.push(_);break}case Be.CylinderImpostor:{const d=n(h.x)/2,f=n(h.y);t.type.push("cylinder"),t.size.push(d),t.size.push(f),t.size.push(f);break}default:{const d=n(h.x),f=n(h.y),p=n(h.z);t.type.push("box"),t.size.push(d),t.size.push(f),t.size.push(p);break}}a.object.rotationQuaternion=l}),e.physicsBody=this.world.add(t),e.physicsBody.resetQuaternion(o),e.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpPositionVector)}var a}removePhysicsBody(e){this.world.removeRigidBody(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;const s=e.joint.jointData,n=s.nativeParams||{};let o;const a={body1:t,body2:i,axe1:n.axe1||(s.mainAxis?s.mainAxis.asArray():null),axe2:n.axe2||(s.connectedAxis?s.connectedAxis.asArray():null),pos1:n.pos1||(s.mainPivot?s.mainPivot.asArray():null),pos2:n.pos2||(s.connectedPivot?s.connectedPivot.asArray():null),min:n.min,max:n.max,collision:n.collision||s.collision,spring:n.spring,world:this.world};switch(e.joint.type){case $t.BallAndSocketJoint:o="jointBall";break;case $t.SpringJoint:V.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead"),a.min=s.length||a.min,a.max=Math.max(a.min,a.max);case $t.DistanceJoint:o="jointDistance",a.max=s.maxDistance;break;case $t.PrismaticJoint:o="jointPrisme";break;case $t.SliderJoint:o="jointSlide";break;case $t.WheelJoint:o="jointWheel";break;default:o="jointHinge"}a.type=o,e.joint.physicsJoint=this.world.add(a)}removeJoint(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(t){V.Warn(t)}}isSupported(){return void 0!==this.BJSOIMO}setTransformationFromPhysicsBody(e){if(!e.physicsBody.sleeping){if(e.physicsBody.shapes.next){let t=e.physicsBody.shapes;for(;t.next;)t=t.next;e.object.position.set(t.position.x,t.position.y,t.position.z)}else{const t=e.physicsBody.getPosition();e.object.position.set(t.x,t.y,t.z)}if(e.object.rotationQuaternion){const t=e.physicsBody.getQuaternion();e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}}setPhysicsBodyTransformation(e,t,i){const s=e.physicsBody;e.physicsBody.shapes.next||(s.position.set(t.x,t.y,t.z),s.orientation.set(i.x,i.y,i.z,i.w),s.syncShapes(),s.awake())}setLinearVelocity(e,t){e.physicsBody.linearVelocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.linearVelocity;return t?new v(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new v(t.x,t.y,t.z):null}setBodyMass(e,t){const i=0===t;e.physicsBody.shapes.density=i?1:t,e.physicsBody.setupMass(i?2:1)}getBodyMass(e){return e.physicsBody.shapes.density}getBodyFriction(e){return e.physicsBody.shapes.friction}setBodyFriction(e,t){e.physicsBody.shapes.friction=t}getBodyRestitution(e){return e.physicsBody.shapes.restitution}setBodyRestitution(e,t){e.physicsBody.shapes.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.awake()}updateDistanceJoint(e,t,i){e.physicsJoint.limitMotor.upperLimit=t,void 0!==i&&(e.physicsJoint.limitMotor.lowerLimit=i)}setMotor(e,t,i,s){void 0!==i?V.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):i=1e6;const n=s?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;n&&n.setMotor(t*=-1,i)}setLimit(e,t,i,s){const n=s?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;n&&n.setLimit(t,void 0===i?-t:i)}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.orientation.x,e.rotationQuaternion.y=i.orientation.y,e.rotationQuaternion.z=i.orientation.z,e.rotationQuaternion.w=i.orientation.w)}getRadius(e){return e.physicsBody.shapes.radius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes;t.x=2*i.halfWidth,t.y=2*i.halfHeight,t.z=2*i.halfDepth}dispose(){this.world.clear()}raycast(e,t){return V.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(e,t),this._raycastResult}raycastToRef(e,t,i){V.Warn("raycast is not currently supported by the Oimo physics plugin"),i.reset(e,t)}}let XG=(()=>{class r{constructor(t=!0,i=Ammo,s=null){this._useDeltaForWorldStep=t,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new Z,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new v,this._tmpContactNormal=new v,this._tmpVec3=new v,this._tmpMatrix=new F,"function"!=typeof i?(this.bjsAMMO=i,this.isSupported()?(this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=s||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=n=>{const o=(n=this.bjsAMMO.wrapPointer(n,this.bjsAMMO.btManifoldPoint)).getPositionWorldOnA(),a=n.m_normalWorldOnB;this._tmpContactPoint.x=o.x(),this._tmpContactPoint.y=o.y(),this._tmpContactPoint.z=o.z(),this._tmpContactNormal.x=a.x(),this._tmpContactNormal.y=a.y(),this._tmpContactNormal.z=a.z(),this._tmpContactImpulse=n.getAppliedImpulse(),this._tmpContactDistance=n.getDistance(),this._tmpContactCallbackResult=!0},this._raycastResult=new tb,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)):V.Error("AmmoJS is not available. Please make sure you included the js file.")):V.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.")}getPluginVersion(){return 1}setGravity(t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)}setTimeStep(t){this._timeStep=t}setFixedTimeStep(t){this._fixedTimeStep=t}setMaxSteps(t){this._maxSteps=t}getTimeStep(){return this._timeStep}_isImpostorInContact(t){return this._tmpContactCallbackResult=!1,this.world.contactTest(t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_isImpostorPairInContact(t,i){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(t.physicsBody,i.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_stepSimulation(t=1/60,i=10,s=1/60){if(0==i)this.world.stepSimulation(t,0);else for(;i>0&&t>0;)t-s<s?(this.world.stepSimulation(t,0),t=0):(t-=s,this.world.stepSimulation(s,0)),i--}executeStep(t,i){for(const s of i)s.soft||s.beforeStep();this._stepSimulation(this._useDeltaForWorldStep?t:this._timeStep,this._maxSteps,this._fixedTimeStep);for(const s of i)if(s.soft?this._afterSoftStep(s):s.afterStep(),s._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(s))for(const n of s._onPhysicsCollideCallbacks)for(const o of n.otherImpostors)(s.physicsBody.isActive()||o.physicsBody.isActive())&&this._isImpostorPairInContact(s,o)&&(s.onCollide({body:o.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}),o.onCollide({body:s.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}))}_afterSoftStep(t){t.type===Be.RopeImpostor?this._ropeStep(t):this._softbodyOrClothStep(t)}_ropeStep(t){const i=t.physicsBody.get_m_nodes(),s=i.size();let n,o,a,l,c;const h=new Array;for(let f=0;f<s;f++)n=i.at(f),o=n.get_m_x(),a=o.x(),l=o.y(),c=o.z(),h.push(new v(a,l,c));const u=t.object,d=t.getParam("shape");t.object=t._isFromLine?Ip("lines",{points:h,instance:u}):Ov("ext",{shape:d,path:h,instance:u})}_softbodyOrClothStep(t){const i=t.type===Be.ClothImpostor?1:-1,s=t.object;let n=s.getVerticesData(A.PositionKind);n||(n=[]);let o=s.getVerticesData(A.NormalKind);o||(o=[]);const a=n.length/3,l=t.physicsBody.get_m_nodes();let c,h,u,d,f,p,_,m;for(let b=0;b<a;b++){c=l.at(b),h=c.get_m_x(),u=h.x(),d=h.y(),f=h.z()*i;const y=c.get_m_n();p=y.x(),_=y.y(),m=y.z()*i,n[3*b]=u,n[3*b+1]=d,n[3*b+2]=f,o[3*b]=p,o[3*b+1]=_,o[3*b+2]=m}const g=new ue;g.positions=n,g.normals=o,g.uvs=s.getVerticesData(A.UVKind),g.colors=s.getVerticesData(A.ColorKind),s&&s.getIndices&&(g.indices=s.getIndices()),g.applyToMesh(s)}applyImpulse(t,i,s){if(t.soft)V.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();const n=this._tmpAmmoVectorA,o=this._tmpAmmoVectorB;t.object&&t.object.getWorldMatrix&&s.subtractInPlace(t.object.getWorldMatrix().getTranslation()),n.setValue(s.x,s.y,s.z),o.setValue(i.x,i.y,i.z),t.physicsBody.applyImpulse(o,n)}}applyForce(t,i,s){if(t.soft)V.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();const n=this._tmpAmmoVectorA,o=this._tmpAmmoVectorB;if(t.object&&t.object.getWorldMatrix){const a=t.object.getWorldMatrix().getTranslation();n.setValue(s.x-a.x,s.y-a.y,s.z-a.z)}else n.setValue(s.x,s.y,s.z);o.setValue(i.x,i.y,i.z),t.physicsBody.applyForce(o,n)}}generatePhysicsBody(t){if(t._pluginData.toDispose=[],t.parent)t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate());else if(t.isBodyInitRequired()){const i=this._createShape(t),s=t.getParam("mass");if(t._pluginData.mass=s,t.soft)i.get_m_cfg().set_collisions(17),i.get_m_cfg().set_kDP(t.getParam("damping")),this.bjsAMMO.castObject(i,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(t.getParam("margin")),i.setActivationState(r._DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(i,1,-1),t.physicsBody=i,t._pluginData.toDispose.push(i),this.setBodyPressure(t,0),t.type===Be.SoftbodyImpostor&&this.setBodyPressure(t,t.getParam("pressure")),this.setBodyStiffness(t,t.getParam("stiffness")),this.setBodyVelocityIterations(t,t.getParam("velocityIterations")),this.setBodyPositionIterations(t,t.getParam("positionIterations"));else{const n=new this.bjsAMMO.btVector3(0,0,0),o=new this.bjsAMMO.btTransform;t.object.computeWorldMatrix(!0),o.setIdentity(),0!==s&&i.calculateLocalInertia(s,n),this._tmpAmmoVectorA.setValue(t.object.position.x,t.object.position.y,t.object.position.z),this._tmpAmmoQuaternion.setValue(t.object.rotationQuaternion.x,t.object.rotationQuaternion.y,t.object.rotationQuaternion.z,t.object.rotationQuaternion.w),o.setOrigin(this._tmpAmmoVectorA),o.setRotation(this._tmpAmmoQuaternion);const a=new this.bjsAMMO.btDefaultMotionState(o),l=new this.bjsAMMO.btRigidBodyConstructionInfo(s,a,i,n),c=new this.bjsAMMO.btRigidBody(l);if(0===s&&(c.setCollisionFlags(c.getCollisionFlags()|r._KINEMATIC_FLAG),c.setActivationState(r._DISABLE_DEACTIVATION_FLAG)),t.type==Be.NoImpostor&&!i.getChildShape&&c.setCollisionFlags(c.getCollisionFlags()|r._DISABLE_COLLISION_FLAG),t.type!==Be.MeshImpostor&&t.type!==Be.NoImpostor){const d=t.object.getBoundingInfo();this._tmpVec3.copyFrom(t.object.getAbsolutePosition()),this._tmpVec3.subtractInPlace(d.boundingBox.centerWorld),this._tmpVec3.x/=t.object.scaling.x,this._tmpVec3.y/=t.object.scaling.y,this._tmpVec3.z/=t.object.scaling.z,t.setDeltaPosition(this._tmpVec3)}const h=t.getParam("group"),u=t.getParam("mask");h&&u?this.world.addRigidBody(c,h,u):this.world.addRigidBody(c),t.physicsBody=c,t._pluginData.toDispose=t._pluginData.toDispose.concat([c,l,a,o,n,i])}this.setBodyRestitution(t,t.getParam("restitution")),this.setBodyFriction(t,t.getParam("friction"))}}removePhysicsBody(t){this.world&&(t.soft?this.world.removeSoftBody(t.physicsBody):this.world.removeRigidBody(t.physicsBody),t._pluginData&&(t._pluginData.toDispose.forEach(i=>{this.bjsAMMO.destroy(i)}),t._pluginData.toDispose=[]))}generateJoint(t){const i=t.mainImpostor.physicsBody,s=t.connectedImpostor.physicsBody;if(!i||!s)return;const n=t.joint.jointData;let o;switch(n.mainPivot||(n.mainPivot=new v(0,0,0)),n.connectedPivot||(n.connectedPivot=new v(0,0,0)),t.joint.type){case $t.DistanceJoint:{const a=n.maxDistance;a&&(n.mainPivot=new v(0,-a/2,0),n.connectedPivot=new v(0,a/2,0)),o=new this.bjsAMMO.btPoint2PointConstraint(i,s,new this.bjsAMMO.btVector3(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z),new this.bjsAMMO.btVector3(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z));break}case $t.HingeJoint:{n.mainAxis||(n.mainAxis=new v(0,0,0)),n.connectedAxis||(n.connectedAxis=new v(0,0,0));const a=new this.bjsAMMO.btVector3(n.mainAxis.x,n.mainAxis.y,n.mainAxis.z),l=new this.bjsAMMO.btVector3(n.connectedAxis.x,n.connectedAxis.y,n.connectedAxis.z);o=new this.bjsAMMO.btHingeConstraint(i,s,new this.bjsAMMO.btVector3(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z),new this.bjsAMMO.btVector3(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z),a,l);break}case $t.BallAndSocketJoint:o=new this.bjsAMMO.btPoint2PointConstraint(i,s,new this.bjsAMMO.btVector3(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z),new this.bjsAMMO.btVector3(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z));break;default:V.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint"),o=new this.bjsAMMO.btPoint2PointConstraint(i,s,new this.bjsAMMO.btVector3(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z),new this.bjsAMMO.btVector3(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z))}this.world.addConstraint(o,!t.joint.jointData.collision),t.joint.physicsJoint=o}removeJoint(t){this.world&&this.world.removeConstraint(t.joint.physicsJoint)}_addMeshVerts(t,i,s){let n=0;if(s&&s.getIndices&&s.getWorldMatrix&&s.getChildMeshes){let o=s.getIndices();o||(o=[]);let l,a=s.getVerticesData(A.PositionKind);if(a||(a=[]),i&&i!==s){let h;h=i.rotationQuaternion?i.rotationQuaternion:i.rotation?Z.FromEulerAngles(i.rotation.x,i.rotation.y,i.rotation.z):Z.Identity(),F.Compose(v.One(),h,i.position).invertToRef(this._tmpMatrix),l=s.computeWorldMatrix(!1).multiply(this._tmpMatrix)}else F.ScalingToRef(s.scaling.x,s.scaling.y,s.scaling.z,this._tmpMatrix),l=this._tmpMatrix;const c=o.length/3;for(let h=0;h<c;h++){const u=[];for(let d=0;d<3;d++){let p,f=new v(a[3*o[3*h+d]+0],a[3*o[3*h+d]+1],a[3*o[3*h+d]+2]);f=v.TransformCoordinates(f,l),p=0==d?this._tmpAmmoVectorA:1==d?this._tmpAmmoVectorB:this._tmpAmmoVectorC,p.setValue(f.x,f.y,f.z),u.push(p)}t.addTriangle(u[0],u[1],u[2]),n++}s.getChildMeshes().forEach(h=>{n+=this._addMeshVerts(t,i,h)})}return n}_softVertexData(t){const i=t.object;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let s=i.getIndices();s||(s=[]);let n=i.getVerticesData(A.PositionKind);n||(n=[]);let o=i.getVerticesData(A.NormalKind);o||(o=[]),i.computeWorldMatrix(!1);const a=[],l=[];for(let h=0;h<n.length;h+=3){let u=new v(n[h],n[h+1],n[h+2]),d=new v(o[h],o[h+1],o[h+2]);u=v.TransformCoordinates(u,i.getWorldMatrix()),d=v.TransformNormal(d,i.getWorldMatrix()),a.push(u.x,u.y,u.z),l.push(d.x,d.y,d.z)}const c=new ue;return c.positions=a,c.normals=l,c.uvs=i.getVerticesData(A.UVKind),c.colors=i.getVerticesData(A.ColorKind),i&&i.getIndices&&(c.indices=i.getIndices()),c.applyToMesh(i),i.position=v.Zero(),i.rotationQuaternion=null,i.rotation=v.Zero(),i.computeWorldMatrix(!0),c}return ue.ExtractFromMesh(i)}_createSoftbody(t){const i=t.object;if(i&&i.getIndices){let s=i.getIndices();s||(s=[]);const n=this._softVertexData(t),o=n.positions,a=n.normals;if(null===o||null===a)return new this.bjsAMMO.btCompoundShape;{const l=[],c=[];for(let _=0;_<o.length;_+=3){const m=new v(o[_],o[_+1],o[_+2]),g=new v(a[_],a[_+1],a[_+2]);l.push(m.x,m.y,-m.z),c.push(g.x,g.y,-g.z)}const h=(new this.bjsAMMO.btSoftBodyHelpers).CreateFromTriMesh(this.world.getWorldInfo(),l,i.getIndices(),s.length/3,!0),u=o.length/3,d=h.get_m_nodes();let f,p;for(let _=0;_<u;_++)f=d.at(_),p=f.get_m_n(),p.setX(c[3*_]),p.setY(c[3*_+1]),p.setZ(c[3*_+2]);return h}}}_createCloth(t){const i=t.object;if(i&&i.getIndices){let s=i.getIndices();s||(s=[]);const n=this._softVertexData(t),o=n.positions,a=n.normals;if(null===o||null===a)return new this.bjsAMMO.btCompoundShape;{const l=o.length,c=Math.sqrt(l/3);t.segments=c;const h=c-1;return this._tmpAmmoVectorA.setValue(o[0],o[1],o[2]),this._tmpAmmoVectorB.setValue(o[3*h],o[3*h+1],o[3*h+2]),this._tmpAmmoVectorD.setValue(o[l-3],o[l-2],o[l-1]),this._tmpAmmoVectorC.setValue(o[l-3-3*h],o[l-2-3*h],o[l-1-3*h]),(new this.bjsAMMO.btSoftBodyHelpers).CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,c,c,t.getParam("fixedPoints"),!0)}}}_createRope(t){let i,s;const n=this._softVertexData(t),o=n.positions,a=n.normals;if(null===o||null===a)return new this.bjsAMMO.btCompoundShape;if(n.applyToMesh(t.object,!0),t._isFromLine=!0,0===a.map(f=>f*f).reduce((f,p)=>f+p))i=o.length,s=i/3-1,this._tmpAmmoVectorA.setValue(o[0],o[1],o[2]),this._tmpAmmoVectorB.setValue(o[i-3],o[i-2],o[i-1]);else{t._isFromLine=!1;const f=t.getParam("path");if(null===t.getParam("shape"))return V.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;i=f.length,s=i-1,this._tmpAmmoVectorA.setValue(f[0].x,f[0].y,f[0].z),this._tmpAmmoVectorB.setValue(f[i-1].x,f[i-1].y,f[i-1].z)}t.segments=s;let u=t.getParam("fixedPoints");u=u>3?3:u;const d=(new this.bjsAMMO.btSoftBodyHelpers).CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,s-1,u);return d.get_m_cfg().set_collisions(17),d}_createCustom(t){let i=null;return this.onCreateCustomShape&&(i=this.onCreateCustomShape(t)),null==i&&(i=new this.bjsAMMO.btCompoundShape),i}_addHullVerts(t,i,s){let n=0;if(s&&s.getIndices&&s.getWorldMatrix&&s.getChildMeshes){let o=s.getIndices();o||(o=[]);let a=s.getVerticesData(A.PositionKind);a||(a=[]),s.computeWorldMatrix(!1);const l=o.length/3;for(let c=0;c<l;c++){const h=[];for(let u=0;u<3;u++){let f,d=new v(a[3*o[3*c+u]+0],a[3*o[3*c+u]+1],a[3*o[3*c+u]+2]);F.ScalingToRef(s.scaling.x,s.scaling.y,s.scaling.z,this._tmpMatrix),d=v.TransformCoordinates(d,this._tmpMatrix),f=0==u?this._tmpAmmoVectorA:1==u?this._tmpAmmoVectorB:this._tmpAmmoVectorC,f.setValue(d.x,d.y,d.z),h.push(f)}t.addPoint(h[0],!0),t.addPoint(h[1],!0),t.addPoint(h[2],!0),n++}s.getChildMeshes().forEach(c=>{n+=this._addHullVerts(t,i,c)})}return n}_createShape(t,i=!1){const s=t.object;let n;const o=t.getObjectExtents();if(!i){const a=t.object.getChildMeshes?t.object.getChildMeshes(!0):[];n=new this.bjsAMMO.btCompoundShape;let l=0;if(a.forEach(c=>{const h=c.getPhysicsImpostor();if(h){if(h.type==Be.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";const u=this._createShape(h),d=c.parent.getWorldMatrix().clone(),f=new v;d.decompose(f),this._tmpAmmoTransform.getOrigin().setValue(c.position.x*f.x,c.position.y*f.y,c.position.z*f.z),this._tmpAmmoQuaternion.setValue(c.rotationQuaternion.x,c.rotationQuaternion.y,c.rotationQuaternion.z,c.rotationQuaternion.w),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),n.addChildShape(this._tmpAmmoTransform,u),h.dispose(),l++}}),l>0){if(t.type!=Be.NoImpostor){const c=this._createShape(t,!0);c&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),n.addChildShape(this._tmpAmmoTransform,c))}return n}this.bjsAMMO.destroy(n),n=null}switch(t.type){case Be.SphereImpostor:if(oe.WithinEpsilon(o.x,o.y,1e-4)&&oe.WithinEpsilon(o.x,o.z,1e-4))n=new this.bjsAMMO.btSphereShape(o.x/2);else{const a=[new this.bjsAMMO.btVector3(0,0,0)];n=new this.bjsAMMO.btMultiSphereShape(a,[1],1),n.setLocalScaling(new this.bjsAMMO.btVector3(o.x/2,o.y/2,o.z/2))}break;case Be.CapsuleImpostor:{const a=o.x/2;n=new this.bjsAMMO.btCapsuleShape(a,o.y-2*a)}break;case Be.CylinderImpostor:this._tmpAmmoVectorA.setValue(o.x/2,o.y/2,o.z/2),n=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case Be.PlaneImpostor:case Be.BoxImpostor:this._tmpAmmoVectorA.setValue(o.x/2,o.y/2,o.z/2),n=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case Be.MeshImpostor:if(0==t.getParam("mass")){if(this.onCreateCustomMeshImpostor)n=this.onCreateCustomMeshImpostor(t);else{const a=new this.bjsAMMO.btTriangleMesh;t._pluginData.toDispose.push(a),n=0==this._addMeshVerts(a,s,s)?new this.bjsAMMO.btCompoundShape:new this.bjsAMMO.btBvhTriangleMeshShape(a)}break}case Be.ConvexHullImpostor:if(this.onCreateCustomConvexHullImpostor)n=this.onCreateCustomConvexHullImpostor(t);else{const a=new this.bjsAMMO.btConvexHullShape;0==this._addHullVerts(a,s,s)?(t._pluginData.toDispose.push(a),n=new this.bjsAMMO.btCompoundShape):n=a}break;case Be.NoImpostor:n=new this.bjsAMMO.btSphereShape(o.x/2);break;case Be.CustomImpostor:n=this._createCustom(t);break;case Be.SoftbodyImpostor:n=this._createSoftbody(t);break;case Be.ClothImpostor:n=this._createCloth(t);break;case Be.RopeImpostor:n=this._createRope(t);break;default:V.Warn("The impostor type is not currently supported by the ammo plugin.")}return n}setTransformationFromPhysicsBody(t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),t.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),t.object.rotationQuaternion?t.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):t.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(t.object.rotation))}setPhysicsBodyTransformation(t,i,s){const n=t.physicsBody.getWorldTransform();if(Math.abs(n.getOrigin().x()-i.x)>ot||Math.abs(n.getOrigin().y()-i.y)>ot||Math.abs(n.getOrigin().z()-i.z)>ot||Math.abs(n.getRotation().x()-s.x)>ot||Math.abs(n.getRotation().y()-s.y)>ot||Math.abs(n.getRotation().z()-s.z)>ot||Math.abs(n.getRotation().w()-s.w)>ot)if(this._tmpAmmoVectorA.setValue(i.x,i.y,i.z),n.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(s.x,s.y,s.z,s.w),n.setRotation(this._tmpAmmoQuaternion),t.physicsBody.setWorldTransform(n),0==t.mass){const o=t.physicsBody.getMotionState();o&&o.setWorldTransform(n)}else t.physicsBody.activate()}isSupported(){return void 0!==this.bjsAMMO}setLinearVelocity(t,i){this._tmpAmmoVectorA.setValue(i.x,i.y,i.z),t.soft?t.physicsBody.linearVelocity(this._tmpAmmoVectorA):t.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)}setAngularVelocity(t,i){this._tmpAmmoVectorA.setValue(i.x,i.y,i.z),t.soft?t.physicsBody.angularVelocity(this._tmpAmmoVectorA):t.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)}getLinearVelocity(t){let i;if(i=t.soft?t.physicsBody.linearVelocity():t.physicsBody.getLinearVelocity(),!i)return null;const s=new v(i.x(),i.y(),i.z());return this.bjsAMMO.destroy(i),s}getAngularVelocity(t){let i;if(i=t.soft?t.physicsBody.angularVelocity():t.physicsBody.getAngularVelocity(),!i)return null;const s=new v(i.x(),i.y(),i.z());return this.bjsAMMO.destroy(i),s}setBodyMass(t,i){t.soft?t.physicsBody.setTotalMass(i,!1):t.physicsBody.setMassProps(i),t._pluginData.mass=i}getBodyMass(t){return t._pluginData.mass||0}getBodyFriction(t){return t._pluginData.friction||0}setBodyFriction(t,i){t.soft?t.physicsBody.get_m_cfg().set_kDF(i):t.physicsBody.setFriction(i),t._pluginData.friction=i}getBodyRestitution(t){return t._pluginData.restitution||0}setBodyRestitution(t,i){t.physicsBody.setRestitution(i),t._pluginData.restitution=i}getBodyPressure(t){return t.soft?t._pluginData.pressure||0:(V.Warn("Pressure is not a property of a rigid body"),0)}setBodyPressure(t,i){t.soft?t.type===Be.SoftbodyImpostor?(t.physicsBody.get_m_cfg().set_kPR(i),t._pluginData.pressure=i):(t.physicsBody.get_m_cfg().set_kPR(0),t._pluginData.pressure=0):V.Warn("Pressure can only be applied to a softbody")}getBodyStiffness(t){return t.soft?t._pluginData.stiffness||0:(V.Warn("Stiffness is not a property of a rigid body"),0)}setBodyStiffness(t,i){t.soft?(i=(i=i<0?0:i)>1?1:i,t.physicsBody.get_m_materials().at(0).set_m_kLST(i),t._pluginData.stiffness=i):V.Warn("Stiffness cannot be applied to a rigid body")}getBodyVelocityIterations(t){return t.soft?t._pluginData.velocityIterations||0:(V.Warn("Velocity iterations is not a property of a rigid body"),0)}setBodyVelocityIterations(t,i){t.soft?(i=i<0?0:i,t.physicsBody.get_m_cfg().set_viterations(i),t._pluginData.velocityIterations=i):V.Warn("Velocity iterations cannot be applied to a rigid body")}getBodyPositionIterations(t){return t.soft?t._pluginData.positionIterations||0:(V.Warn("Position iterations is not a property of a rigid body"),0)}setBodyPositionIterations(t,i){t.soft?(i=i<0?0:i,t.physicsBody.get_m_cfg().set_piterations(i),t._pluginData.positionIterations=i):V.Warn("Position iterations cannot be applied to a rigid body")}appendAnchor(t,i,s,n,o=1,a=!1){const l=t.segments,c=Math.round((l-1)*s),h=Math.round((l-1)*n);t.physicsBody.appendAnchor(c+l*(l-1-h),i.physicsBody,a,o)}appendHook(t,i,s,n=1,o=!1){const a=Math.round(t.segments*s);t.physicsBody.appendAnchor(a,i.physicsBody,o,n)}sleepBody(t){t.physicsBody.forceActivationState(0)}wakeUpBody(t){t.physicsBody.activate()}updateDistanceJoint(){V.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")}setMotor(t,i,s){t.physicsJoint.enableAngularMotor(!0,i,s)}setLimit(){V.Warn("setLimit is not currently supported by the Ammo physics plugin")}syncMeshWithImpostor(t,i){i.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),t.position.x=this._tmpAmmoTransform.getOrigin().x(),t.position.y=this._tmpAmmoTransform.getOrigin().y(),t.position.z=this._tmpAmmoTransform.getOrigin().z(),t.rotationQuaternion&&(t.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),t.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),t.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),t.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())}getRadius(t){return t.getObjectExtents().x/2}getBoxSizeToRef(t,i){const s=t.getObjectExtents();i.x=s.x,i.y=s.y,i.z=s.z}dispose(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null}raycast(t,i){return this.raycastToRef(t,i,this._raycastResult),this._raycastResult}raycastToRef(t,i,s){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(t.x,t.y,t.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(i.x,i.y,i.z);const n=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,n),s.reset(t,i),n.hasHit()&&(s.setHitData({x:n.get_m_hitNormalWorld().x(),y:n.get_m_hitNormalWorld().y(),z:n.get_m_hitNormalWorld().z()},{x:n.get_m_hitPointWorld().x(),y:n.get_m_hitPointWorld().y(),z:n.get_m_hitPointWorld().z()}),s.calculateHitDistance()),this.bjsAMMO.destroy(n),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB)}}return r._DISABLE_COLLISION_FLAG=4,r._KINEMATIC_FLAG=2,r._DISABLE_DEACTIVATION_FLAG=4,r})();es.prototype.removeReflectionProbe=function(r){if(!this.reflectionProbes)return-1;const e=this.reflectionProbes.indexOf(r);return-1!==e&&this.reflectionProbes.splice(e,1),e},es.prototype.addReflectionProbe=function(r){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(r)};class zp{constructor(e,t,i,s=!0,n=!1,o=!1){if(this.name=e,this._viewMatrix=F.Identity(),this._target=v.Zero(),this._add=v.Zero(),this._invertYAxis=!1,this.position=v.Zero(),this.metadata=null,this._parentContainer=null,this._scene=i,i.getEngine().supportsUniformBuffers){this._sceneUBOs=[];for(let h=0;h<6;++h)this._sceneUBOs.push(i.createSceneUniformBuffer(`Scene for Reflection Probe (name "${e}") face #${h}`))}this._scene.reflectionProbes||(this._scene.reflectionProbes=new Array),this._scene.reflectionProbes.push(this);let a=0;if(n){const h=this._scene.getEngine().getCaps();h.textureHalfFloatRender?a=2:h.textureFloatRender&&(a=1)}this._renderTargetTexture=new Ss(e,t,i,s,!0,a,!0),this._renderTargetTexture.gammaSpace=!o;const l=i.getEngine().useReverseDepthBuffer;let c;this._renderTargetTexture.onBeforeRenderObservable.add(h=>{switch(this._sceneUBOs&&(i.setSceneUniformBuffer(this._sceneUBOs[h]),i.getSceneUniformBuffer().unbindEffect()),h){case 0:this._add.copyFromFloats(1,0,0);break;case 1:this._add.copyFromFloats(-1,0,0);break;case 2:this._add.copyFromFloats(0,this._invertYAxis?1:-1,0);break;case 3:this._add.copyFromFloats(0,this._invertYAxis?-1:1,0);break;case 4:this._add.copyFromFloats(0,0,i.useRightHandedSystem?-1:1);break;case 5:this._add.copyFromFloats(0,0,i.useRightHandedSystem?1:-1)}this._attachedMesh&&this.position.copyFrom(this._attachedMesh.getAbsolutePosition()),this.position.addToRef(this._add,this._target);const d=i.useRightHandedSystem?F.PerspectiveFovRH:F.PerspectiveFovLH;(i.useRightHandedSystem?F.LookAtRHToRef:F.LookAtLHToRef)(this.position,this._target,v.Up(),this._viewMatrix),i.activeCamera&&(this._projectionMatrix=d(Math.PI/2,1,l?i.activeCamera.maxZ:i.activeCamera.minZ,l?i.activeCamera.minZ:i.activeCamera.maxZ,this._scene.getEngine().isNDCHalfZRange),i.setTransformMatrix(this._viewMatrix,this._projectionMatrix),i.activeCamera.isRigCamera&&!this._renderTargetTexture.activeCamera&&(this._renderTargetTexture.activeCamera=i.activeCamera.rigParent||null)),i._forcedViewPosition=this.position}),this._renderTargetTexture.onBeforeBindObservable.add(()=>{var h,u;this._currentSceneUBO=i.getSceneUniformBuffer(),null===(u=(h=i.getEngine())._debugPushGroup)||void 0===u||u.call(h,`reflection probe generation for ${e}`,1),c=this._scene.imageProcessingConfiguration.applyByPostProcess,o&&(i.imageProcessingConfiguration.applyByPostProcess=!0)}),this._renderTargetTexture.onAfterUnbindObservable.add(()=>{var h,u;i.imageProcessingConfiguration.applyByPostProcess=c,i._forcedViewPosition=null,this._sceneUBOs&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(!0),null===(u=(h=i.getEngine())._debugPopGroup)||void 0===u||u.call(h,1)})}get samples(){return this._renderTargetTexture.samples}set samples(e){this._renderTargetTexture.samples=e}get refreshRate(){return this._renderTargetTexture.refreshRate}set refreshRate(e){this._renderTargetTexture.refreshRate=e}getScene(){return this._scene}get cubeTexture(){return this._renderTargetTexture}get renderList(){return this._renderTargetTexture.renderList}attachToMesh(e){this._attachedMesh=e}setRenderingAutoClearDepthStencil(e,t){this._renderTargetTexture.setRenderingAutoClearDepthStencil(e,t)}dispose(){const e=this._scene.reflectionProbes.indexOf(this);if(-1!==e&&this._scene.reflectionProbes.splice(e,1),this._parentContainer){const t=this._parentContainer.reflectionProbes.indexOf(this);t>-1&&this._parentContainer.reflectionProbes.splice(t,1),this._parentContainer=null}if(this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null),this._sceneUBOs){for(const t of this._sceneUBOs)t.dispose();this._sceneUBOs=[]}}toString(e){let t="Name: "+this.name;return e&&(t+=", position: "+this.position.toString(),this._attachedMesh&&(t+=", attached mesh: "+this._attachedMesh.name)),t}getClassName(){return"ReflectionProbe"}serialize(){const e=Ce.Serialize(this,this._renderTargetTexture.serialize());return e.isReflectionProbe=!0,e.metadata=this.metadata,e}static Parse(e,t,i){let s=null;if(t.reflectionProbes)for(let n=0;n<t.reflectionProbes.length;n++){const o=t.reflectionProbes[n];if(o.name===e.name){s=o;break}}return s=Ce.Parse(()=>s||new zp(e.name,e.renderTargetSize,t,e._generateMipMaps),e,t,i),s.cubeTexture._waitingRenderList=e.renderList,e._attachedMesh&&s.attachToMesh(t.getMeshById(e._attachedMesh)),e.metadata&&(s.metadata=e.metadata),s}}E([ip()],zp.prototype,"_attachedMesh",void 0),E([Ws()],zp.prototype,"position",void 0);class sb{}sb.LoaderInjectedPhysicsEngine=void 0;let ad={},uc={};const jG=(r,e,t,i)=>{if(!e.materials)return null;for(let s=0,n=e.materials.length;s<n;s++){const o=e.materials[s];if(r(o))return{parsedMaterial:o,material:ie.Parse(o,t,i)}}return null},eoe=(r,e,t)=>{for(const i in e)if(r.name===e[i])return t.push(r.id),!0;return void 0!==r.parentId&&-1!==t.indexOf(r.parentId)&&(t.push(r.id),!0)},ld=(r,e)=>r+" of "+(e?e.file+" from "+e.name+" version: "+e.version+", exporter version: "+e.exporter_version:"unknown"),YG=(r,e)=>{const t=e;if(e._waitingData.lods){if(e._waitingData.lods.ids&&e._waitingData.lods.ids.length>0){const i=e._waitingData.lods.ids,s=t.isEnabled(!1);if(e._waitingData.lods.distances){const n=e._waitingData.lods.distances;if(n.length>=i.length){const o=n.length>i.length?n[n.length-1]:0;t.setEnabled(!1);for(let a=0;a<i.length;a++){const c=r.getMeshById(i[a]);null!=c&&t.addLODLevel(n[a],c)}o>0&&t.addLODLevel(o,null),!0===s&&t.setEnabled(!0)}else q.Warn("Invalid level of detail distances for "+e.name)}}e._waitingData.lods=null}},rb=(r,e,t)=>{if("number"!=typeof r){const s=t.getLastEntryById(r);return s&&null!=e?s.instances[parseInt(e)]:s}const i=ad[r];return i&&null!=e?i.instances[parseInt(e)]:i},nb=(r,e)=>"number"!=typeof r?e.getLastMaterialById(r,!0):uc[r],qG=(r,e,t,i,s=!1)=>{const n=new E1(r);let o="importScene has failed JSON parse";try{var a=JSON.parse(e);o="";const l=ke.loggingLevel===ke.DETAILED_LOGGING;let c,h;if(null!=a.environmentTexture){const d=void 0===a.isPBR||a.isPBR;if(a.environmentTextureType&&"BABYLON.HDRCubeTexture"===a.environmentTextureType){const f=a.environmentTextureSize?a.environmentTextureSize:128,p=new HG((a.environmentTexture.match(/https?:\/\//g)?"":t)+a.environmentTexture,r,f,!0,!d,void 0,a.environmentTexturePrefilterOnLoad);a.environmentTextureRotationY&&(p.rotationY=a.environmentTextureRotationY),r.environmentTexture=p}else if("object"==typeof a.environmentTexture){const f=os.Parse(a.environmentTexture,r,t);r.environmentTexture=f}else if(a.environmentTexture.endsWith(".env")){const f=new os((a.environmentTexture.match(/https?:\/\//g)?"":t)+a.environmentTexture,r,a.environmentTextureForcedExtension);a.environmentTextureRotationY&&(f.rotationY=a.environmentTextureRotationY),r.environmentTexture=f}else{const f=os.CreateFromPrefilteredData((a.environmentTexture.match(/https?:\/\//g)?"":t)+a.environmentTexture,r,a.environmentTextureForcedExtension);a.environmentTextureRotationY&&(f.rotationY=a.environmentTextureRotationY),r.environmentTexture=f}!0===a.createDefaultSkybox&&r.createDefaultSkybox(r.environmentTexture,d,null!=r.activeCamera?(r.activeCamera.maxZ-r.activeCamera.minZ)/2:1e3,a.skyboxBlurLevel||0),n.environmentTexture=r.environmentTexture}if(null!=a.environmentIntensity&&(r.environmentIntensity=a.environmentIntensity),null!=a.lights)for(c=0,h=a.lights.length;c<h;c++){const d=a.lights[c],f=Je.Parse(d,r);f&&(ad[d.uniqueId]=f,n.lights.push(f),f._parentContainer=n,o+=0===c?"\n\tLights:":"",o+="\n\t\t"+f.toString(l))}if(null!=a.reflectionProbes)for(c=0,h=a.reflectionProbes.length;c<h;c++){const f=zp.Parse(a.reflectionProbes[c],r,t);f&&(n.reflectionProbes.push(f),f._parentContainer=n,o+=0===c?"\n\tReflection Probes:":"",o+="\n\t\t"+f.toString(l))}if(null!=a.animations)for(c=0,h=a.animations.length;c<h;c++){const d=a.animations[c],f=hs("BABYLON.Animation");if(f){const p=f.Parse(d);r.animations.push(p),n.animations.push(p),o+=0===c?"\n\tAnimations:":"",o+="\n\t\t"+p.toString(l)}}if(null!=a.materials)for(c=0,h=a.materials.length;c<h;c++){const d=a.materials[c],f=ie.Parse(d,r,t);f&&(uc[d.uniqueId||d.id]=f,n.materials.push(f),f._parentContainer=n,o+=0===c?"\n\tMaterials:":"",o+="\n\t\t"+f.toString(l),f.getActiveTextures().forEach(_=>{-1==n.textures.indexOf(_)&&(n.textures.push(_),_._parentContainer=n)}))}if(null!=a.multiMaterials)for(c=0,h=a.multiMaterials.length;c<h;c++){const d=a.multiMaterials[c],f=el.ParseMultiMaterial(d,r);uc[d.uniqueId||d.id]=f,n.multiMaterials.push(f),f._parentContainer=n,o+=0===c?"\n\tMultiMaterials:":"",o+="\n\t\t"+f.toString(l),f.getActiveTextures().forEach(_=>{-1==n.textures.indexOf(_)&&(n.textures.push(_),_._parentContainer=n)})}if(null!=a.morphTargetManagers)for(const d of a.morphTargetManagers){const f=BC.Parse(d,r);n.morphTargetManagers.push(f),f._parentContainer=n}if(null!=a.skeletons)for(c=0,h=a.skeletons.length;c<h;c++){const f=Jl.Parse(a.skeletons[c],r);n.skeletons.push(f),f._parentContainer=n,o+=0===c?"\n\tSkeletons:":"",o+="\n\t\t"+f.toString(l)}const u=a.geometries;if(null!=u){const d=new Array,f=u.vertexData;if(null!=f)for(c=0,h=f.length;c<h;c++)d.push(rr.Parse(f[c],r,t));d.forEach(p=>{p&&(n.geometries.push(p),p._parentContainer=n)})}if(null!=a.transformNodes)for(c=0,h=a.transformNodes.length;c<h;c++){const d=a.transformNodes[c],f=We.Parse(d,r,t);ad[d.uniqueId]=f,n.transformNodes.push(f),f._parentContainer=n}if(null!=a.meshes)for(c=0,h=a.meshes.length;c<h;c++){const d=a.meshes[c],f=G.Parse(d,r,t);if(ad[d.uniqueId]=f,n.meshes.push(f),f._parentContainer=n,f.hasInstances)for(const p of f.instances)n.meshes.push(p),p._parentContainer=n;o+=0===c?"\n\tMeshes:":"",o+="\n\t\t"+f.toString(l)}if(null!=a.cameras)for(c=0,h=a.cameras.length;c<h;c++){const d=a.cameras[c],f=ve.Parse(d,r);ad[d.uniqueId]=f,n.cameras.push(f),f._parentContainer=n,o+=0===c?"\n\tCameras:":"",o+="\n\t\t"+f.toString(l)}if(null!=a.postProcesses)for(c=0,h=a.postProcesses.length;c<h;c++){const f=Pe.Parse(a.postProcesses[c],r,t);f&&(n.postProcesses.push(f),f._parentContainer=n,o+=0===c?"\nPostprocesses:":"",o+="\n\t\t"+f.toString())}if(null!=a.animationGroups)for(c=0,h=a.animationGroups.length;c<h;c++){const f=_p.Parse(a.animationGroups[c],r);n.animationGroups.push(f),f._parentContainer=n,o+=0===c?"\n\tAnimationGroups:":"",o+="\n\t\t"+f.toString(l)}for(c=0,h=r.cameras.length;c<h;c++){const d=r.cameras[c];null!==d._waitingParentId&&(d.parent=rb(d._waitingParentId,d._waitingParentInstanceIndex,r),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,h=r.lights.length;c<h;c++){const d=r.lights[c];d&&null!==d._waitingParentId&&(d.parent=rb(d._waitingParentId,d._waitingParentInstanceIndex,r),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,h=r.transformNodes.length;c<h;c++){const d=r.transformNodes[c];null!==d._waitingParentId&&(d.parent=rb(d._waitingParentId,d._waitingParentInstanceIndex,r),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,h=r.meshes.length;c<h;c++){const d=r.meshes[c];null!==d._waitingParentId&&(d.parent=rb(d._waitingParentId,d._waitingParentInstanceIndex,r),d._waitingParentId=null,d._waitingParentInstanceIndex=null),d._waitingData.lods&&YG(r,d)}for(r.multiMaterials.forEach(d=>{d._waitingSubMaterialsUniqueIds.forEach(f=>{d.subMaterials.push(nb(f,r))}),d._waitingSubMaterialsUniqueIds=[]}),r.meshes.forEach(d=>{null!==d._waitingMaterialId&&(d.material=nb(d._waitingMaterialId,r),d._waitingMaterialId=null)}),c=0,h=r.skeletons.length;c<h;c++){const d=r.skeletons[c];d._hasWaitingData&&(null!=d.bones&&d.bones.forEach(f=>{if(f._waitingTransformNodeId){const p=r.getLastEntryById(f._waitingTransformNodeId);p&&f.linkTransformNode(p),f._waitingTransformNodeId=null}}),d._hasWaitingData=null)}for(c=0,h=r.meshes.length;c<h;c++){const d=r.meshes[c];d._waitingData.freezeWorldMatrix?(d.freezeWorldMatrix(),d._waitingData.freezeWorldMatrix=null):d.computeWorldMatrix(!0)}for(c=0,h=r.lights.length;c<h;c++){const d=r.lights[c];if(d._excludedMeshesIds.length>0){for(let f=0;f<d._excludedMeshesIds.length;f++){const p=r.getMeshById(d._excludedMeshesIds[f]);p&&d.excludedMeshes.push(p)}d._excludedMeshesIds=[]}if(d._includedOnlyMeshesIds.length>0){for(let f=0;f<d._includedOnlyMeshesIds.length;f++){const p=r.getMeshById(d._includedOnlyMeshesIds[f]);p&&d.includedOnlyMeshes.push(p)}d._includedOnlyMeshesIds=[]}}for(r.geometries.forEach(d=>{d._loadedUniqueId=""}),es.Parse(a,r,n,t),c=0,h=r.meshes.length;c<h;c++){const d=r.meshes[c];d._waitingData.actions&&(Qc.Parse(d._waitingData.actions,d,r),d._waitingData.actions=null)}null!=a.actions&&Qc.Parse(a.actions,null,r)}catch(l){const c=ld("loadAssets",a?a.producer:"Unknown")+o;if(!i)throw V.Log(c),l;i(c,l)}finally{ad={},uc={},s||n.removeAllFromScene(),null!==o&&ke.loggingLevel!==ke.NO_LOGGING&&V.Log(ld("loadAssets",a?a.producer:"Unknown")+(ke.loggingLevel!==ke.MINIMAL_LOGGING?o:""))}return n};ke.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:r=>-1!==r.indexOf("babylon"),importMesh:(r,e,t,i,s,n,o,a)=>{var l;let c="importMesh has failed JSON parse";try{var h=JSON.parse(t);c="";const u=ke.loggingLevel===ke.DETAILED_LOGGING;r?Array.isArray(r)||(r=[r]):r=null;const d=new Array,f=new Map,p=[];if(null!=h.transformNodes)for(let _=0,m=h.transformNodes.length;_<m;_++){const b=We.Parse(h.transformNodes[_],e,i);p.push(b),f.set(b._waitingParsedUniqueId,b),b._waitingParsedUniqueId=null}if(null!=h.meshes){const _=[],m=[],g=[],b=[];for(let T=0,x=h.meshes.length;T<x;T++){const S=h.meshes[T];if(null===r||eoe(S,r,d)){if(null!==r&&delete r[r.indexOf(S.name)],null!=S.geometryId&&null!=h.geometries){let D=!1;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach(P=>{!0===D||!h.geometries[P]||!Array.isArray(h.geometries[P])||h.geometries[P].forEach(M=>{M.id===S.geometryId&&("vertexData"===P&&rr.Parse(M,e,i),D=!0)})}),!1===D&&V.Warn("Geometry not found for mesh "+S.id)}if(S.materialUniqueId||S.materialId){const D=S.materialUniqueId?g:m;let P=-1!==D.indexOf(S.materialUniqueId||S.materialId);if(!1===P&&null!=h.multiMaterials){const M=(w,k)=>{D.push(w);const X=jG(k,h,e,i);X&&X.material&&(uc[X.parsedMaterial.uniqueId||X.parsedMaterial.id]=X.material,c+="\n\tMaterial "+X.material.toString(u))};for(let w=0,k=h.multiMaterials.length;w<k;w++){const X=h.multiMaterials[w];if(S.materialUniqueId&&X.uniqueId===S.materialUniqueId||X.id===S.materialId){X.materialsUniqueIds?X.materialsUniqueIds.forEach(J=>M(J,Q=>Q.uniqueId===J)):X.materials.forEach(J=>M(J,Q=>Q.id===J)),D.push(X.uniqueId||X.id);const te=el.ParseMultiMaterial(X,e);uc[X.uniqueId||X.id]=te,te&&(P=!0,c+="\n\tMulti-Material "+te.toString(u));break}}}if(!1===P){D.push(S.materialUniqueId||S.materialId);const M=jG(w=>S.materialUniqueId&&w.uniqueId===S.materialUniqueId||w.id===S.materialId,h,e,i);M&&M.material?(uc[M.parsedMaterial.uniqueId||M.parsedMaterial.id]=M.material,c+="\n\tMaterial "+M.material.toString(u)):V.Warn("Material not found for mesh "+S.id)}}if(S.skeletonId>-1&&null!=h.skeletons&&!(_.indexOf(S.skeletonId)>-1))for(let P=0,M=h.skeletons.length;P<M;P++){const w=h.skeletons[P];if(w.id===S.skeletonId){const k=Jl.Parse(w,e);o.push(k),_.push(w.id),c+="\n\tSkeleton "+k.toString(u)}}if(S.morphTargetManagerId>-1&&null!=h.morphTargetManagers&&!(b.indexOf(S.morphTargetManagerId)>-1))for(let P=0,M=h.morphTargetManagers.length;P<M;P++){const w=h.morphTargetManagers[P];if(w.id===S.morphTargetManagerId){const k=BC.Parse(w,e);b.push(k.uniqueId),c+="\nMorph target "+k.toString()}}const C=G.Parse(S,e,i);s.push(C),f.set(C._waitingParsedUniqueId,C),C._waitingParsedUniqueId=null,c+="\n\tMesh "+C.toString(u)}}e.multiMaterials.forEach(T=>{T._waitingSubMaterialsUniqueIds.forEach(x=>{T.subMaterials.push(nb(x,e))}),T._waitingSubMaterialsUniqueIds=[]}),e.meshes.forEach(T=>{null!==T._waitingMaterialId&&(T.material=nb(T._waitingMaterialId,e),T._waitingMaterialId=null)});for(let T=0,x=e.transformNodes.length;T<x;T++){const S=e.transformNodes[T];if(null!==S._waitingParentId){let C=f.get(parseInt(S._waitingParentId))||null;null===C&&(C=e.getLastEntryById(S._waitingParentId));let D=C;S._waitingParentInstanceIndex&&(D=C.instances[parseInt(S._waitingParentInstanceIndex)],S._waitingParentInstanceIndex=null),S.parent=D,S._waitingParentId=null}}let y;for(let T=0,x=e.meshes.length;T<x;T++){if(y=e.meshes[T],y._waitingParentId){let S=f.get(parseInt(y._waitingParentId))||null;null===S&&(S=e.getLastEntryById(y._waitingParentId));let C=S;if(y._waitingParentInstanceIndex&&(C=S.instances[parseInt(y._waitingParentInstanceIndex)],y._waitingParentInstanceIndex=null),y.parent=C,"TransformNode"===(null===(l=y.parent)||void 0===l?void 0:l.getClassName())){const D=p.indexOf(y.parent);D>-1&&p.splice(D,1)}y._waitingParentId=null}y._waitingData.lods&&YG(e,y)}for(const T of p)T.dispose();for(let T=0,x=e.skeletons.length;T<x;T++){const S=e.skeletons[T];S._hasWaitingData&&(null!=S.bones&&S.bones.forEach(C=>{if(C._waitingTransformNodeId){const D=e.getLastEntryById(C._waitingTransformNodeId);D&&C.linkTransformNode(D),C._waitingTransformNodeId=null}}),S._hasWaitingData=null)}for(let T=0,x=e.meshes.length;T<x;T++)y=e.meshes[T],y._waitingData.freezeWorldMatrix?(y.freezeWorldMatrix(),y._waitingData.freezeWorldMatrix=null):y.computeWorldMatrix(!0)}if(null!=h.particleSystems){const _=es.GetIndividualParser(Me.NAME_PARTICLESYSTEM);if(_)for(let m=0,g=h.particleSystems.length;m<g;m++){const b=h.particleSystems[m];-1!==d.indexOf(b.emitterId)&&n.push(_(b,e,i))}}return e.geometries.forEach(_=>{_._loadedUniqueId=""}),!0}catch(u){const d=ld("importMesh",h?h.producer:"Unknown")+c;if(!a)throw V.Log(d),u;a(d,u)}finally{null!==c&&ke.loggingLevel!==ke.NO_LOGGING&&V.Log(ld("importMesh",h?h.producer:"Unknown")+(ke.loggingLevel!==ke.MINIMAL_LOGGING?c:"")),uc={}}return!1},load:(r,e,t,i)=>{let s="importScene has failed JSON parse";try{var n=JSON.parse(e);if(s="",null!=n.useDelayedTextureLoading&&(r.useDelayedTextureLoading=n.useDelayedTextureLoading&&!ke.ForceFullSceneLoadingForIncremental),null!=n.autoClear&&(r.autoClear=n.autoClear),null!=n.clearColor&&(r.clearColor=Te.FromArray(n.clearColor)),null!=n.ambientColor&&(r.ambientColor=re.FromArray(n.ambientColor)),null!=n.gravity&&(r.gravity=v.FromArray(n.gravity)),void 0!==n.useRightHandedSystem&&(r.useRightHandedSystem=!!n.useRightHandedSystem),n.fogMode&&0!==n.fogMode)switch(r.fogMode=n.fogMode,r.fogColor=re.FromArray(n.fogColor),r.fogStart=n.fogStart,r.fogEnd=n.fogEnd,r.fogDensity=n.fogDensity,s+="\tFog mode for scene:  ",r.fogMode){case 1:s+="exp\n";break;case 2:s+="exp2\n";break;case 3:s+="linear\n"}if(n.physicsEnabled){let a;"cannon"===n.physicsEngine||n.physicsEngine===VC.name?a=new VC(void 0,void 0,sb.LoaderInjectedPhysicsEngine):"oimo"===n.physicsEngine||n.physicsEngine===WG.name?a=new WG(void 0,sb.LoaderInjectedPhysicsEngine):("ammo"===n.physicsEngine||n.physicsEngine===XG.name)&&(a=new XG(void 0,sb.LoaderInjectedPhysicsEngine,void 0)),s="\tPhysics engine "+(n.physicsEngine?n.physicsEngine:"oimo")+" enabled\n";const l=n.physicsGravity?v.FromArray(n.physicsGravity):null;r.enablePhysics(l,a)}return null!=n.metadata&&(r.metadata=n.metadata),null!=n.collisionsEnabled&&(r.collisionsEnabled=n.collisionsEnabled),!!qG(r,e,t,i,!0)&&(n.autoAnimate&&r.beginAnimation(r,n.autoAnimateFrom,n.autoAnimateTo,n.autoAnimateLoop,n.autoAnimateSpeed||1),null!=n.activeCameraID&&r.setActiveCameraById(n.activeCameraID),!0)}catch(o){const a=ld("importScene",n?n.producer:"Unknown")+s;if(!i)throw V.Log(a),o;i(a,o)}finally{null!==s&&ke.loggingLevel!==ke.NO_LOGGING&&V.Log(ld("importScene",n?n.producer:"Unknown")+(ke.loggingLevel!==ke.MINIMAL_LOGGING?s:""))}return!1},loadAssetContainer:(r,e,t,i)=>qG(r,e,t,i)});class ob{get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,ee.MarkAllMaterialsAsDirty(20))}constructor(e={}){this._isEnabled=!0,this.bias=void 0===e.bias?0:e.bias,this.power=void 0===e.power?1:e.power,this.leftColor=e.leftColor||re.White(),this.rightColor=e.rightColor||re.Black(),!1===e.isEnabled&&(this.isEnabled=!1)}clone(){const e=new ob;return Pr.DeepCopy(this,e),e}equals(e){return e&&this.bias===e.bias&&this.power===e.power&&this.leftColor.equals(e.leftColor)&&this.rightColor.equals(e.rightColor)&&this.isEnabled===e.isEnabled}serialize(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}}static Parse(e){return new ob({isEnabled:e.isEnabled,leftColor:re.FromArray(e.leftColor),rightColor:re.FromArray(e.rightColor),bias:e.bias,power:e.power||1})}}Ce._FresnelParametersParser=ob.Parse;class Or extends Vt{get doubleSided(){return this._twoSidedLighting}set doubleSided(e){this._twoSidedLighting!==e&&(this._twoSidedLighting=e,this.backFaceCulling=!e,this._markAllSubMeshesAsTexturesDirty())}constructor(e,t){super(e,t),this.maxSimultaneousLights=4,this.disableLighting=!1,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.emissiveColor=new re(0,0,0),this.occlusionStrength=1,this.useLightmapAsShadowmap=!1,this._useAlphaFromAlbedoTexture=!0,this._useAmbientInGrayScale=!0}getClassName(){return"PBRBaseSimpleMaterial"}}E([I(),ne("_markAllSubMeshesAsLightsDirty")],Or.prototype,"maxSimultaneousLights",void 0),E([I(),ne("_markAllSubMeshesAsLightsDirty")],Or.prototype,"disableLighting",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],Or.prototype,"environmentTexture",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Or.prototype,"invertNormalMapX",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Or.prototype,"invertNormalMapY",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],Or.prototype,"normalTexture",void 0),E([us("emissive"),ne("_markAllSubMeshesAsTexturesDirty")],Or.prototype,"emissiveColor",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty")],Or.prototype,"emissiveTexture",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],Or.prototype,"occlusionStrength",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],Or.prototype,"occlusionTexture",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],Or.prototype,"alphaCutOff",void 0),E([I()],Or.prototype,"doubleSided",null),E([ht(),ne("_markAllSubMeshesAsTexturesDirty",null)],Or.prototype,"lightmapTexture",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],Or.prototype,"useLightmapAsShadowmap",void 0);class bl extends Or{constructor(e,t){super(e,t),this._useRoughnessFromMetallicTextureAlpha=!1,this._useRoughnessFromMetallicTextureGreen=!0,this._useMetallnessFromMetallicTextureBlue=!0,this.metallic=1,this.roughness=1}getClassName(){return"PBRMetallicRoughnessMaterial"}clone(e){const t=Ce.Clone(()=>new bl(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=Ce.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const s=Ce.Parse(()=>new bl(e.name,t),e,t,i);return e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}E([us(),ne("_markAllSubMeshesAsTexturesDirty","_albedoColor")],bl.prototype,"baseColor",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],bl.prototype,"baseTexture",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],bl.prototype,"metallic",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],bl.prototype,"roughness",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],bl.prototype,"metallicRoughnessTexture",void 0),le("BABYLON.PBRMetallicRoughnessMaterial",bl);class yl extends Or{get useMicroSurfaceFromReflectivityMapAlpha(){return this._useMicroSurfaceFromReflectivityMapAlpha}constructor(e,t){super(e,t),this._useMicroSurfaceFromReflectivityMapAlpha=!0}getClassName(){return"PBRSpecularGlossinessMaterial"}clone(e){const t=Ce.Clone(()=>new yl(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=Ce.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const s=Ce.Parse(()=>new yl(e.name,t),e,t,i);return e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}function ab(r){let e=0;return{id_length:r[e++],colormap_type:r[e++],image_type:r[e++],colormap_index:r[e++]|r[e++]<<8,colormap_length:r[e++]|r[e++]<<8,colormap_size:r[e++],origin:[r[e++]|r[e++]<<8,r[e++]|r[e++]<<8],width:r[e++]|r[e++]<<8,height:r[e++]|r[e++]<<8,pixel_size:r[e++],flags:r[e++]}}function $G(r,e){if(e.length<19)return void V.Error("Unable to load TGA file - Not enough data to contain header");let t=18;const i=ab(e);if(i.id_length+t>e.length)return void V.Error("Unable to load TGA file - Not enough data");t+=i.id_length;let a,s=!1,n=!1,o=!1;switch(i.image_type){case 9:s=!0;case 1:n=!0;break;case 10:s=!0;case 2:break;case 11:s=!0;case 3:o=!0}const l=i.pixel_size>>3,c=i.width*i.height*l;let h,u,d,f,p,_,m;if(n&&(h=e.subarray(t,t+=i.colormap_length*(i.colormap_size>>3))),s){a=new Uint8Array(c);let T,x,S,C=0;const D=new Uint8Array(l);for(;t<c&&C<c;)if(T=e[t++],x=1+(127&T),128&T){for(S=0;S<l;++S)D[S]=e[t++];for(S=0;S<x;++S)a.set(D,C+S*l);C+=l*x}else{for(x*=l,S=0;S<x;++S)a[C+S]=e[t++];C+=x}}else a=e.subarray(t,t+=n?i.width*i.height:c);switch((48&i.flags)>>4){default:case 2:u=0,f=1,m=i.width,d=0,p=1,_=i.height;break;case 0:u=0,f=1,m=i.width,d=i.height-1,p=-1,_=-1;break;case 3:u=i.width-1,f=-1,m=-1,d=0,p=1,_=i.height;break;case 1:u=i.width-1,f=-1,m=-1,d=i.height-1,p=-1,_=-1}const b=boe["_getImageData"+(o?"Grey":"")+i.pixel_size+"bits"](i,h,a,d,p,_,u,f,m);r.getEngine()._uploadDataToTextureDirectly(r,b)}E([us("diffuse"),ne("_markAllSubMeshesAsTexturesDirty","_albedoColor")],yl.prototype,"diffuseColor",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],yl.prototype,"diffuseTexture",void 0),E([us("specular"),ne("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],yl.prototype,"specularColor",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty","_microSurface")],yl.prototype,"glossiness",void 0),E([ht(),ne("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],yl.prototype,"specularGlossinessTexture",void 0),le("BABYLON.PBRSpecularGlossinessMaterial",yl),le("BABYLON.ColorGradingTexture",(()=>{class r extends kt{constructor(t,i,s=null){if(super(i),t)if(this._textureMatrix=F.Identity(),this.name=t,this.url=t,this._onLoad=s,this._texture=this._getFromCache(t,!0),this._texture)this._triggerOnLoad();else{const n=this.getScene();n&&n.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture()}}_triggerOnLoad(){this._onLoad&&this._onLoad()}getTextureMatrix(){return this._textureMatrix}_load3dlTexture(){const t=this._getEngine();let i;i=t._features.support3DTextures?t.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):t.createRawTexture(null,1,1,5,!1,!1,2,null,0),this._texture=i,this._texture.isReady=!1,this.isCube=!1,this.is3D=t._features.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;const s=o=>{if("string"!=typeof o)return;let c,a=null,l=null;const h=o.split("\n");let u=0,d=0,f=0,p=0,_=0;for(let m=0;m<h.length;m++){if(c=h[m],!r._NoneEmptyLineRegex.test(c)||0===c.indexOf("#"))continue;const g=c.split(" ");if(0!==u){if(0!=u){const b=Math.max(parseInt(g[0]),0),y=Math.max(parseInt(g[1]),0),T=Math.max(parseInt(g[2]),0);_=Math.max(b,_),_=Math.max(y,_),_=Math.max(T,_);const x=4*(d+p*u+f*u*u);l&&(l[x+0]=b,l[x+1]=y,l[x+2]=T),f++,f%u==0&&(p++,f=0,p%u==0&&(d++,p=0))}}else u=g.length,a=new Uint8Array(u*u*u*4),l=new Float32Array(u*u*u*4)}if(l&&a)for(let m=0;m<l.length;m++)a[m]=m>0&&(m+1)%4==0?255:l[m]/_*255;i.is3D?(i.updateSize(u,u,u),t.updateRawTexture3D(i,a,5,!1)):(i.updateSize(u*u,u),t.updateRawTexture(i,a,5,!1)),i.isReady=!0,this._triggerOnLoad()},n=this.getScene();return n?n._loadFile(this.url,s):t._loadFile(this.url,s),this._texture}_loadTexture(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this._load3dlTexture()}clone(){const t=new r(this.url,this.getScene()||this._getEngine());return t.level=this.level,t}delayLoad(){4===this.delayLoadState&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,!0),this._texture||this._loadTexture())}static Parse(t,i){let s=null;return t.name&&!t.isRenderTarget&&(s=new r(t.name,i),s.name=t.name,s.level=t.level),s}serialize(){if(!this.name)return null;const t={};return t.name=this.name,t.level=this.level,t.customType="BABYLON.ColorGradingTexture",t}}return r._NoneEmptyLineRegex=/\S+/,r})());const boe={GetTGAHeader:ab,UploadContent:$G,_getImageData8bits:function foe(r,e,t,i,s,n,o,a,l){const c=t,h=e,u=r.width;let f,_,m,p=0;const g=new Uint8Array(u*r.height*4);for(m=i;m!==n;m+=s)for(_=o;_!==l;_+=a,p++)f=c[p],g[4*(_+u*m)+3]=255,g[4*(_+u*m)+2]=h[3*f+0],g[4*(_+u*m)+1]=h[3*f+1],g[4*(_+u*m)+0]=h[3*f+2];return g},_getImageData16bits:function poe(r,e,t,i,s,n,o,a,l){const c=t,h=r.width;let d,p,_,f=0;const m=new Uint8Array(h*r.height*4);for(_=i;_!==n;_+=s)for(p=o;p!==l;p+=a,f+=2){d=c[f+0]+(c[f+1]<<8);const b=255*((992&d)>>5)/31|0,y=255*(31&d)/31|0;m[4*(p+h*_)+0]=255*((31744&d)>>10)/31|0,m[4*(p+h*_)+1]=b,m[4*(p+h*_)+2]=y,m[4*(p+h*_)+3]=32768&d?0:255}return m},_getImageData24bits:function _oe(r,e,t,i,s,n,o,a,l){const c=t,h=r.width;let f,p,d=0;const _=new Uint8Array(h*r.height*4);for(p=i;p!==n;p+=s)for(f=o;f!==l;f+=a,d+=3)_[4*(f+h*p)+3]=255,_[4*(f+h*p)+2]=c[d+0],_[4*(f+h*p)+1]=c[d+1],_[4*(f+h*p)+0]=c[d+2];return _},_getImageData32bits:function moe(r,e,t,i,s,n,o,a,l){const c=t,h=r.width;let f,p,d=0;const _=new Uint8Array(h*r.height*4);for(p=i;p!==n;p+=s)for(f=o;f!==l;f+=a,d+=4)_[4*(f+h*p)+2]=c[d+0],_[4*(f+h*p)+1]=c[d+1],_[4*(f+h*p)+0]=c[d+2],_[4*(f+h*p)+3]=c[d+3];return _},_getImageDataGrey8bits:function goe(r,e,t,i,s,n,o,a,l){const c=t,h=r.width;let d,p,_,f=0;const m=new Uint8Array(h*r.height*4);for(_=i;_!==n;_+=s)for(p=o;p!==l;p+=a,f++)d=c[f],m[4*(p+h*_)+0]=d,m[4*(p+h*_)+1]=d,m[4*(p+h*_)+2]=d,m[4*(p+h*_)+3]=255;return m},_getImageDataGrey16bits:function voe(r,e,t,i,s,n,o,a,l){const c=t,h=r.width;let f,p,d=0;const _=new Uint8Array(h*r.height*4);for(p=i;p!==n;p+=s)for(f=o;f!==l;f+=a,d+=2)_[4*(f+h*p)+0]=c[d+0],_[4*(f+h*p)+1]=c[d+0],_[4*(f+h*p)+2]=c[d+0],_[4*(f+h*p)+3]=c[d+1];return _}};ee._TextureLoaders.push(new class yoe{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".tga")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=ab(s);i(n.width,n.height,t.generateMipMaps,!1,()=>{$G(t,s)})}}),ee._TextureLoaders.push(new class xoe{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".hdr")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=FC.RGBE_ReadHeader(s),o=FC.RGBE_ReadPixels(s,n),a=n.width*n.height,l=new Float32Array(4*a);for(let c=0;c<a;c+=1)l[4*c]=o[3*c],l[4*c+1]=o[3*c+1],l[4*c+2]=o[3*c+2],l[4*c+3]=1;i(n.width,n.height,t.generateMipMaps,!1,()=>{const c=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,c._uploadDataToTextureDirectly(t,l)})}});var xa=(()=>{return(r=xa||(xa={}))[r.cTFETC1=0]="cTFETC1",r[r.cTFETC2=1]="cTFETC2",r[r.cTFBC1=2]="cTFBC1",r[r.cTFBC3=3]="cTFBC3",r[r.cTFBC4=4]="cTFBC4",r[r.cTFBC5=5]="cTFBC5",r[r.cTFBC7=6]="cTFBC7",r[r.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",r[r.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",r[r.cTFASTC_4x4=10]="cTFASTC_4x4",r[r.cTFATC_RGB=11]="cTFATC_RGB",r[r.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",r[r.cTFRGBA32=13]="cTFRGBA32",r[r.cTFRGB565=14]="cTFRGB565",r[r.cTFBGR565=15]="cTFBGR565",r[r.cTFRGBA4444=16]="cTFRGBA4444",r[r.cTFFXT1_RGB=17]="cTFFXT1_RGB",r[r.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",r[r.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",r[r.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",r[r.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11",xa;var r})();const dc={JSModuleURL:"https://cdn.babylonjs.com/basisTranscoder/1/basis_transcoder.js",WasmModuleURL:"https://cdn.babylonjs.com/basisTranscoder/1/basis_transcoder.wasm"};let UC=null,Ta=null,Soe=0;const kC=(r,e)=>{const t=r instanceof ArrayBuffer?new Uint8Array(r):r;return new Promise((i,s)=>{(UC||(UC=new Promise((r,e)=>{Ta?r(Ta):q.LoadFileAsync(dc.WasmModuleURL).then(t=>{if("function"!=typeof URL)return e("Basis transcoder requires an environment with a URL constructor");const i=URL.createObjectURL(new Blob([`(${Aoe})()`],{type:"application/javascript"}));Ta=new Worker(i);const s=n=>{"init"===n.data.action?(Ta.removeEventListener("message",s),r(Ta)):"error"===n.data.action&&e(n.data.error||"error initializing worker")};Ta.addEventListener("message",s),Ta.postMessage({action:"init",url:dc.JSModuleURL,wasmBinary:t})}).catch(e)})),UC).then(()=>{const n=Soe++,o=l=>{"transcode"===l.data.action&&l.data.id===n&&(Ta.removeEventListener("message",o),l.data.success?i(l.data):s("Transcode is not supported on this device"))};Ta.addEventListener("message",o);const a=new Uint8Array(t.byteLength);a.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),Ta.postMessage({action:"transcode",id:n,imageData:a,config:e,ignoreSupportedFormats:!1},[a.buffer])},n=>{s(n)})})},lb=(r,e)=>{var t,i;let s=null===(t=e._gl)||void 0===t?void 0:t.TEXTURE_2D;r.isCube&&(s=null===(i=e._gl)||void 0===i?void 0:i.TEXTURE_CUBE_MAP),e._bindTextureDirectly(s,r,!0)},GC=(r,e)=>{const t=r.getEngine();for(let i=0;i<e.fileInfo.images.length;i++){const s=e.fileInfo.images[i].levels[0];if(r._invertVScale=r.invertY,-1===e.format||e.format===xa.cTFRGB565)if(r.type=10,r.format=4,!t._features.basisNeedsPOT||oe.Log2(s.width)%1==0&&oe.Log2(s.height)%1==0)r._invertVScale=!r.invertY,r.width=s.width+3&-4,r.height=s.height+3&-4,r.samplingMode=2,lb(r,t),t._uploadDataToTextureDirectly(r,new Uint16Array(s.transcodedPixels.buffer),i,0,4,!0);else{const n=new zt(t,Ye.Temp);r._invertVScale=r.invertY,n.type=10,n.format=4,n.width=s.width+3&-4,n.height=s.height+3&-4,lb(n,t),t._uploadDataToTextureDirectly(n,new Uint16Array(s.transcodedPixels.buffer),i,0,4,!0),t._rescaleTexture(n,r,t.scenes[0],t._getInternalFormat(4),()=>{t._releaseTexture(n),lb(r,t)})}else{r.width=s.width,r.height=s.height,r.generateMipMaps=e.fileInfo.images[i].levels.length>1;const n=zC.GetInternalFormatFromBasisFormat(e.format,t);r.format=n,lb(r,t),e.fileInfo.images[i].levels.forEach((o,a)=>{t._uploadCompressedDataToTextureDirectly(r,n,o.width,o.height,o.transcodedPixels,i,a)}),t._features.basisNeedsPOT&&(oe.Log2(r.width)%1!=0||oe.Log2(r.height)%1!=0)&&(q.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),r._cachedWrapU=U.CLAMP_ADDRESSMODE,r._cachedWrapV=U.CLAMP_ADDRESSMODE)}}},zC={JSModuleURL:dc.JSModuleURL,WasmModuleURL:dc.WasmModuleURL,GetInternalFormatFromBasisFormat:(r,e)=>{let t;switch(r){case xa.cTFETC1:t=36196;break;case xa.cTFBC1:t=33776;break;case xa.cTFBC4:t=33779;break;case xa.cTFASTC_4x4:t=37808;break;case xa.cTFETC2:t=37496;break;case xa.cTFBC7:t=36492}if(void 0===t)throw"The chosen Basis transcoder format is not currently supported";return t},TranscodeAsync:kC,LoadTextureFromTranscodeResult:GC};function Aoe(){let e=null;function s(o,a,l,c,h){const u=o.getImageTranscodedSizeInBytes(a,l,c);let d=new Uint8Array(u);return o.transcodeImage(d,a,l,c,1,0)?(h&&(d=function n(o,a,l,c){const h=new Uint16Array(4),u=new Uint16Array(l*c),d=l/4,f=c/4;for(let p=0;p<f;p++)for(let _=0;_<d;_++){const m=a+8*(p*d+_);h[0]=o[m]|o[m+1]<<8,h[1]=o[m+2]|o[m+3]<<8,h[2]=(2*(31&h[0])+1*(31&h[1]))/3|(2*(2016&h[0])+1*(2016&h[1]))/3&2016|(2*(63488&h[0])+1*(63488&h[1]))/3&63488,h[3]=(2*(31&h[1])+1*(31&h[0]))/3|(2*(2016&h[1])+1*(2016&h[0]))/3&2016|(2*(63488&h[1])+1*(63488&h[0]))/3&63488;for(let g=0;g<4;g++){const b=o[m+4+g];let y=(4*p+g)*l+4*_;u[y++]=h[3&b],u[y++]=h[b>>2&3],u[y++]=h[b>>4&3],u[y++]=h[b>>6&3]}}return u}(d,0,o.getImageWidth(a,l)+3&-4,o.getImageHeight(a,l)+3&-4)),d):null}onmessage=o=>{if("init"===o.data.action){if(!e){try{importScripts(o.data.url)}catch(a){postMessage({action:"error",error:a})}e=BASIS({wasmBinary:o.data.wasmBinary})}null!==e&&e.then(a=>{BASIS=a,a.initializeBasis(),postMessage({action:"init"})})}else if("transcode"===o.data.action){const a=o.data.config,c=new BASIS.BasisFile(o.data.imageData),h=function i(o){const a=o.getHasAlpha(),l=o.getNumImages(),c=[];for(let u=0;u<l;u++){const d={levels:[]},f=o.getNumLevels(u);for(let p=0;p<f;p++){const _={width:o.getImageWidth(u,p),height:o.getImageHeight(u,p)};d.levels.push(_)}c.push(d)}return{hasAlpha:a,images:c}}(c);let u=o.data.ignoreSupportedFormats?null:function t(o,a){let l=null;return o.supportedCompressionFormats&&(l=o.supportedCompressionFormats.astc?10:o.supportedCompressionFormats.bc7?6:o.supportedCompressionFormats.s3tc?a.hasAlpha?3:2:o.supportedCompressionFormats.pvrtc?a.hasAlpha?9:8:o.supportedCompressionFormats.etc2?1:o.supportedCompressionFormats.etc1?0:14),l}(o.data.config,h),d=!1;null===u&&(d=!0,u=h.hasAlpha?3:2);let f=!0;c.startTranscoding()||(f=!1);const p=[];for(let _=0;_<h.images.length&&f;_++){const m=h.images[_];if(void 0===a.loadSingleImage||a.loadSingleImage===_){let g=m.levels.length;!1===a.loadMipmapLevels&&(g=1);for(let b=0;b<g;b++){const y=m.levels[b],T=s(c,_,b,u,d);if(!T){f=!1;break}y.transcodedPixels=T,p.push(y.transcodedPixels.buffer)}}}c.close(),c.delete(),d&&(u=-1),f?postMessage({action:"transcode",success:f,id:o.data.id,fileInfo:h,format:u},p):postMessage({action:"transcode",success:f,id:o.data.id})}}}Object.defineProperty(zC,"JSModuleURL",{get:function(){return dc.JSModuleURL},set:function(r){dc.JSModuleURL=r}}),Object.defineProperty(zC,"WasmModuleURL",{get:function(){return dc.WasmModuleURL},set:function(r){dc.WasmModuleURL=r}}),ee._TextureLoaders.push(new class Roe{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".basis")}loadCubeData(e,t,i,s,n){if(Array.isArray(e))return;const o=t.getEngine().getCaps();kC(e,{supportedCompressionFormats:{etc1:!!o.etc1,s3tc:!!o.s3tc,pvrtc:!!o.pvrtc,etc2:!!o.etc2,astc:!!o.astc,bc7:!!o.bptc}}).then(l=>{const c=l.fileInfo.images[0].levels.length>1&&t.generateMipMaps;GC(t,l),t.getEngine()._setCubeMapTextureParams(t,c),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()}).catch(l=>{q.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),t.isReady=!0,n&&n(l)})}loadData(e,t,i){const s=t.getEngine().getCaps();kC(e,{supportedCompressionFormats:{etc1:!!s.etc1,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,astc:!!s.astc,bc7:!!s.bptc}}).then(o=>{const a=o.fileInfo.images[0].levels[0];i(a.width,a.height,o.fileInfo.images[0].levels.length>1&&t.generateMipMaps,-1!==o.format,()=>{GC(t,o)})}).catch(o=>{q.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),q.Warn(`Failed to transcode Basis file: ${o}`),i(0,0,!1,!1,()=>{},!0)})}});class Ah extends Ss{get isSupported(){var e,t;return null!==(t=null===(e=this._engine)||void 0===e?void 0:e.getCaps().drawBuffersExtension)&&void 0!==t&&t}get textures(){return this._textures}get count(){return this._count}get depthTexture(){return this._textures[this._textures.length-1]}set wrapU(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapU=e}set wrapV(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapV=e}constructor(e,t,i,s,n,o){const a=!(!n||!n.generateMipMaps)&&n.generateMipMaps,l=!(!n||!n.generateDepthTexture)&&n.generateDepthTexture,c=n&&n.depthTextureFormat?n.depthTextureFormat:15,u=!(!n||!n.drawOnlyOnFirstAttachmentByDefault)&&n.drawOnlyOnFirstAttachmentByDefault;if(super(e,t,s,a,!n||void 0===n.doNotChangeAspectRatio||n.doNotChangeAspectRatio,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0),!this.isSupported)return void this.dispose();const d=[],f=[],p=[];this._initTypes(i,d,f,p,n);const _=!n||void 0===n.generateDepthBuffer||n.generateDepthBuffer,m=!(!n||void 0===n.generateStencilBuffer)&&n.generateStencilBuffer;this._size=t,this._multiRenderTargetOptions={samplingModes:f,generateMipMaps:a,generateDepthBuffer:_,generateStencilBuffer:m,generateDepthTexture:l,depthTextureFormat:c,types:d,textureCount:i,useSRGBBuffers:p},this._count=i,this._drawOnlyOnFirstAttachmentByDefault=u,i>0&&(this._createInternalTextures(),this._createTextures(o))}_initTypes(e,t,i,s,n){for(let o=0;o<e;o++)t.push(n&&n.types&&void 0!==n.types[o]?n.types[o]:n&&n.defaultType?n.defaultType:0),i.push(n&&n.samplingModes&&void 0!==n.samplingModes[o]?n.samplingModes[o]:U.BILINEAR_SAMPLINGMODE),s.push(!(!n||!n.useSRGBBuffers||void 0===n.useSRGBBuffers[o])&&n.useSRGBBuffers[o])}_rebuild(e=!1,t){if(this._count<1)return;this.releaseInternalTextures(),this._createInternalTextures(),e&&(this._releaseTextures(),this._createTextures(t));const i=this._renderTarget.textures;for(let s=0;s<i.length;s++)this._textures[s]._texture=i[s];1!==this.samples&&this._renderTarget.setSamples(this.samples,!this._drawOnlyOnFirstAttachmentByDefault,!0)}_createInternalTextures(){this._renderTarget=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._renderTarget.texture}_releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;e++)this._textures[e]._texture=null,this._textures[e].dispose()}_createTextures(e){const t=this._renderTarget.textures;this._textures=[];for(let i=0;i<t.length;i++){const s=new U(null,this.getScene());e?.[i]&&(s.name=e[i]),s._texture=t[i],this._textures.push(s)}}setInternalTexture(e,t,i=!0){!this.renderTarget||(0===t&&(this._texture=e),this.renderTarget.setTexture(e,t,i),this.textures[t]||(this.textures[t]=new U(null,this.getScene())),this.textures[t]._texture=e,this._count=this.renderTarget.textures?this.renderTarget.textures.length:0,this._multiRenderTargetOptions.types&&(this._multiRenderTargetOptions.types[t]=e.type),this._multiRenderTargetOptions.samplingModes&&(this._multiRenderTargetOptions.samplingModes[t]=e.samplingMode),this._multiRenderTargetOptions.useSRGBBuffers&&(this._multiRenderTargetOptions.useSRGBBuffers[t]=e._useSRGBBuffer))}get samples(){return this._samples}set samples(e){this._samples=this._renderTarget?this._renderTarget.setSamples(e):e}resize(e){this._size=e,this._rebuild()}updateCount(e,t,i){this._multiRenderTargetOptions.textureCount=e,this._count=e;const s=[],n=[],o=[];this._initTypes(e,s,n,o,t),this._multiRenderTargetOptions.types=s,this._multiRenderTargetOptions.samplingModes=n,this._multiRenderTargetOptions.useSRGBBuffers=o,this._rebuild(!0,i)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindMultiColorAttachmentFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}dispose(e=!1){this._releaseTextures(),e?this._texture=null:this.releaseInternalTextures(),super.dispose()}releaseInternalTextures(){var e,t;const i=null===(e=this._renderTarget)||void 0===e?void 0:e.textures;if(i){for(let s=i.length-1;s>=0;s--)this._textures[s]._texture=null;null===(t=this._renderTarget)||void 0===t||t.dispose(),this._renderTarget=null}}}j.ShadersStore.noisePixelShader="uniform float brightness;\nuniform float persistence;\nuniform float timeScale;\nvarying vec2 vUV;\nvec2 hash22(vec2 p)\n{\np=p*mat2(127.1,311.7,269.5,183.3);\np=-1.0+2.0*fract(sin(p)*43758.5453123);\nreturn sin(p*6.283+timeScale);\n}\nfloat interpolationNoise(vec2 p)\n{\nvec2 pi=floor(p);\nvec2 pf=p-pi;\nvec2 w=pf*pf*(3.-2.*pf);\nfloat f00=dot(hash22(pi+vec2(.0,.0)),pf-vec2(.0,.0));\nfloat f01=dot(hash22(pi+vec2(.0,1.)),pf-vec2(.0,1.));\nfloat f10=dot(hash22(pi+vec2(1.0,0.)),pf-vec2(1.0,0.));\nfloat f11=dot(hash22(pi+vec2(1.0,1.)),pf-vec2(1.0,1.));\nfloat xm1=mix(f00,f10,w.x);\nfloat xm2=mix(f01,f11,w.x);\nfloat ym=mix(xm1,xm2,w.y); \nreturn ym;\n}\nfloat perlinNoise2D(float x,float y)\n{\nfloat sum=0.0;\nfloat frequency=0.0;\nfloat amplitude=0.0;\nfor(int i=0; i<OCTAVES; i++)\n{\nfrequency=pow(2.0,float(i));\namplitude=pow(persistence,float(i));\nsum=sum+interpolationNoise(vec2(x*frequency,y*frequency))*amplitude;\n}\nreturn sum;\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nfloat x=abs(vUV.x);\nfloat y=abs(vUV.y);\nfloat noise=brightness+(1.0-brightness)*perlinNoise2D(x,y);\ngl_FragColor=vec4(noise,noise,noise,1.0);\n}\n";class cb extends da{constructor(e,t=256,i=be.LastCreatedScene,s,n){super(e,t,"noise",i,s,n),this.time=0,this.brightness=.2,this.octaves=3,this.persistence=.8,this.animationSpeedFactor=1,this.autoClear=!1,this._updateShaderUniforms()}_updateShaderUniforms(){const e=this.getScene();!e||(this.time+=e.getAnimationRatio()*this.animationSpeedFactor*.01,this.setFloat("brightness",this.brightness),this.setFloat("persistence",this.persistence),this.setFloat("timeScale",this.time))}_getDefines(){return"#define OCTAVES "+(0|this.octaves)}render(e){this._updateShaderUniforms(),super.render(e)}serialize(){const e={customType:"BABYLON.NoiseProceduralTexture"};return e.brightness=this.brightness,e.octaves=this.octaves,e.persistence=this.persistence,e.animationSpeedFactor=this.animationSpeedFactor,e.size=this.getSize().width,e.generateMipMaps=this._generateMipMaps,e.time=this.time,e}clone(){const e=this.getSize(),t=new cb(this.name,e.width,this.getScene(),this._fallbackTexture?this._fallbackTexture:void 0,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t.brightness=this.brightness,t.octaves=this.octaves,t.persistence=this.persistence,t.animationSpeedFactor=this.animationSpeedFactor,t.time=this.time,t}static Parse(e,t){var i;const s=new cb(e.name,e.size,t,void 0,e.generateMipMaps);return s.brightness=e.brightness,s.octaves=e.octaves,s.persistence=e.persistence,s.animationSpeedFactor=e.animationSpeedFactor,s.time=null!==(i=e.time)&&void 0!==i?i:0,s}}le("BABYLON.NoiseProceduralTexture",cb);class HC extends os{constructor(e,t,i,s=5,n=0,o=!1,a=!1,l=3,c=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,i,s,n,o,a,l,c)}update(e,t,i,s,n=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,i,s,n)}updateRGBDAsync(e,t=null,i=.8,s=0){return function gre(r,e,t,i,s){const o=Bv(r.getEngine().createRawCubeTexture(null,r.width,r.format,r.type,r.generateMipMaps,r.invertY,r.samplingMode,r._compression),e).then(()=>r);return r.onRebuildCallback=a=>({proxy:o,isReady:!0,isAsync:!0}),r._source=Ye.CubeRawRGBD,r._bufferViewArrayArray=e,r._lodGenerationScale=i,r._lodGenerationOffset=s,r._sphericalPolynomial=t,Bv(r,e).then(()=>(r.isReady=!0,r))}(this._texture,e,t,i,s).then(()=>{})}clone(){return Ce.Clone(()=>{const e=this.getScene(),t=this._texture,i=new HC(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return t.source===Ye.CubeRawRGBD&&i.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),i},this)}}class Qi extends ju{constructor(e,t,i,s,n){super(e,t,i),this._blockType=s,this._blockName=n,this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof Qi&&e._blockName===this._blockName?_n.Compatible:_n.TypeIncompatible}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}}le("BABYLON.BonesBlock",class Ioe extends De{constructor(e){super(e,B.Vertex),this.registerInput("matricesIndices",R.Vector4),this.registerInput("matricesWeights",R.Vector4),this.registerInput("matricesIndicesExtra",R.Vector4,!0),this.registerInput("matricesWeightsExtra",R.Vector4,!0),this.registerInput("world",R.Matrix),this.registerOutput("output",R.Matrix)}initialize(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh")}getClassName(){return"BonesBlock"}get matricesIndices(){return this._inputs[0]}get matricesWeights(){return this._inputs[1]}get matricesIndicesExtra(){return this._inputs[2]}get matricesWeightsExtra(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.matricesIndices.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"matricesIndices"===i.name);t||(t=new et("matricesIndices"),t.setAsAttribute("matricesIndices")),t.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"matricesWeights"===i.name);t||(t=new et("matricesWeights"),t.setAsAttribute("matricesWeights")),t.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===it.World);t||(t=new et("world"),t.setAsSystemValue(it.World)),t.output.connectTo(this.world)}}provideFallbacks(e,t){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&t.addCPUSkinningFallback(0,e)}bind(e,t,i){ce.BindBonesParameters(i,e)}prepareDefines(e,t,i){!i._areAttributesDirty||ce.PrepareDefinesForBones(e,i)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");const t=`//${this.name}`;e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});const i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});const s=this._outputs[0],n=this.world;return e.compilationString+="#if NUM_BONE_INFLUENCERS>0\r\n",e.compilationString+=this._declareOutput(s,e)+` = ${n.associatedVariableName} * ${i};\r\n`,e.compilationString+="#else\r\n",e.compilationString+=this._declareOutput(s,e)+` = ${n.associatedVariableName};\r\n`,e.compilationString+="#endif\r\n",this}}),le("BABYLON.InstancesBlock",class Moe extends De{constructor(e){super(e,B.Vertex),this.registerInput("world0",R.Vector4),this.registerInput("world1",R.Vector4),this.registerInput("world2",R.Vector4),this.registerInput("world3",R.Vector4),this.registerInput("world",R.Matrix,!0),this.registerOutput("output",R.Matrix),this.registerOutput("instanceID",R.Float)}getClassName(){return"InstancesBlock"}get world0(){return this._inputs[0]}get world1(){return this._inputs[1]}get world2(){return this._inputs[2]}get world3(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}get instanceID(){return this._outputs[1]}autoConfigure(e){if(!this.world0.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"world0"===i.name);t||(t=new et("world0"),t.setAsAttribute("world0")),t.output.connectTo(this.world0)}if(!this.world1.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"world1"===i.name);t||(t=new et("world1"),t.setAsAttribute("world1")),t.output.connectTo(this.world1)}if(!this.world2.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"world2"===i.name);t||(t=new et("world2"),t.setAsAttribute("world2")),t.output.connectTo(this.world2)}if(!this.world3.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"world3"===i.name);t||(t=new et("world3"),t.setAsAttribute("world3")),t.output.connectTo(this.world3)}if(!this.world.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"world"===i.name);t||(t=new et("world"),t.setAsSystemValue(it.World)),t.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"}prepareDefines(e,t,i,s=!1,n){let o=!1;i.INSTANCES!==s&&(i.setValue("INSTANCES",s),o=!0),n&&i.THIN_INSTANCES!==!!n?.getRenderingMesh().hasThinInstances&&(i.setValue("THIN_INSTANCES",!!n?.getRenderingMesh().hasThinInstances),o=!0),o&&i.markAsUnprocessed()}_buildBlock(e){super._buildBlock(e);const t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);const i=this._outputs[0],s=this._outputs[1],n=this.world0,o=this.world1,a=this.world2,l=this.world3;return e.compilationString+="#ifdef INSTANCES\r\n",e.compilationString+=this._declareOutput(i,e)+` = mat4(${n.associatedVariableName}, ${o.associatedVariableName}, ${a.associatedVariableName}, ${l.associatedVariableName});\r\n`,e.compilationString+="#ifdef THIN_INSTANCES\r\n",e.compilationString+=`${i.associatedVariableName} = ${this.world.associatedVariableName} * ${i.associatedVariableName};\r\n`,e.compilationString+="#endif\r\n",e.compilationString+=t._caps.canUseGLInstanceID?this._declareOutput(s,e)+" = float(gl_InstanceID);\r\n":this._declareOutput(s,e)+" = 0.0;\r\n",e.compilationString+="#else\r\n",e.compilationString+=this._declareOutput(i,e)+` = ${this.world.associatedVariableName};\r\n`,e.compilationString+=this._declareOutput(s,e)+" = 0.0;\r\n",e.compilationString+="#endif\r\n",this}}),le("BABYLON.MorphTargetsBlock",class Poe extends De{constructor(e){super(e,B.Vertex),this.registerInput("position",R.Vector3),this.registerInput("normal",R.Vector3),this.registerInput("tangent",R.AutoDetect),this.tangent.addExcludedConnectionPointFromAllowedTypes(R.Color4|R.Vector4|R.Vector3),this.registerInput("uv",R.Vector2),this.registerOutput("positionOutput",R.Vector3),this.registerOutput("normalOutput",R.Vector3),this.registerOutput("tangentOutput",R.Vector4),this.registerOutput("uvOutput",R.Vector2)}getClassName(){return"MorphTargetsBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get tangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get positionOutput(){return this._outputs[0]}get normalOutput(){return this._outputs[1]}get tangentOutput(){return this._outputs[2]}get uvOutput(){return this._outputs[3]}initialize(e){e._excludeVariableName("morphTargetInfluences")}autoConfigure(e){if(!this.position.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"position"===i.name);t||(t=new et("position"),t.setAsAttribute()),t.output.connectTo(this.position)}if(!this.normal.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"normal"===i.name);t||(t=new et("normal"),t.setAsAttribute("normal")),t.output.connectTo(this.normal)}if(!this.tangent.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"tangent"===i.name);t||(t=new et("tangent"),t.setAsAttribute("tangent")),t.output.connectTo(this.tangent)}if(!this.uv.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"uv"===i.name);t||(t=new et("uv"),t.setAsAttribute("uv")),t.output.connectTo(this.uv)}}prepareDefines(e,t,i){if(e.morphTargetManager){const s=e.morphTargetManager;s?.isUsingTextureForTargets&&s.numInfluencers!==i.NUM_MORPH_INFLUENCERS&&i.markAsAttributesDirty()}!i._areAttributesDirty||ce.PrepareDefinesForMorphTargets(e,i)}bind(e,t,i){i&&i.morphTargetManager&&i.morphTargetManager.numInfluencers>0&&(ce.BindMorphTargetParameters(i,e),i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(e))}replaceRepeatableContent(e,t,i,s){const n=this.position,o=this.normal,a=this.tangent,l=this.uv,c=this.positionOutput,h=this.normalOutput,u=this.tangentOutput,d=this.uvOutput,f=e,p=s.NUM_MORPH_INFLUENCERS,_=i.morphTargetManager,m=_&&_.supportsNormals&&s.NORMAL,g=_&&_.supportsTangents&&s.TANGENT,b=_&&_.supportsUVs&&s.UV1;let y="";_?.isUsingTextureForTargets&&p>0&&(y+="float vertexID;\r\n");for(let T=0;T<p;T++)y+="#ifdef MORPHTARGETS\r\n",_?.isUsingTextureForTargets?(y+="vertexID = float(gl_VertexID) * morphTargetTextureInfo.x;\r\n",y+=`${c.associatedVariableName} += (readVector3FromRawSampler(${T}, vertexID) - ${n.associatedVariableName}) * morphTargetInfluences[${T}];\r\n`,y+="vertexID += 1.0;\r\n"):y+=`${c.associatedVariableName} += (position${T} - ${n.associatedVariableName}) * morphTargetInfluences[${T}];\r\n`,m&&(y+="#ifdef MORPHTARGETS_NORMAL\r\n",_?.isUsingTextureForTargets?(y+=`${h.associatedVariableName} += (readVector3FromRawSampler(${T}, vertexID) - ${o.associatedVariableName}) * morphTargetInfluences[${T}];\r\n`,y+="vertexID += 1.0;\r\n"):y+=`${h.associatedVariableName} += (normal${T} - ${o.associatedVariableName}) * morphTargetInfluences[${T}];\r\n`,y+="#endif\r\n"),b&&(y+="#ifdef MORPHTARGETS_UV\r\n",_?.isUsingTextureForTargets?(y+=`${d.associatedVariableName} += (readVector3FromRawSampler(${T}, vertexID).xy - ${l.associatedVariableName}) * morphTargetInfluences[${T}];\r\n`,y+="vertexID += 1.0;\r\n"):y+=`${d.associatedVariableName}.xy += (uv_${T} - ${l.associatedVariableName}.xy) * morphTargetInfluences[${T}];\r\n`,y+="#endif\r\n"),g&&(y+="#ifdef MORPHTARGETS_TANGENT\r\n",y+=_?.isUsingTextureForTargets?`${u.associatedVariableName}.xyz += (readVector3FromRawSampler(${T}, vertexID) - ${a.associatedVariableName}.xyz) * morphTargetInfluences[${T}];\r\n`:`${u.associatedVariableName}.xyz += (tangent${T} - ${a.associatedVariableName}.xyz) * morphTargetInfluences[${T}];\r\n`,y+=a.type===R.Vector4?`${u.associatedVariableName}.w = ${a.associatedVariableName}.w;\r\n`:`${u.associatedVariableName}.w = 1.;\r\n`,y+="#endif\r\n"),y+="#endif\r\n";if(f.compilationString=f.compilationString.replace(this._repeatableContentAnchor,y),p>0)for(let T=0;T<p;T++)f.attributes.push(A.PositionKind+T),m&&f.attributes.push(A.NormalKind+T),g&&f.attributes.push(A.TangentKind+T),b&&f.attributes.push(A.UVKind+"_"+T)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);const t=this.position,i=this.normal,s=this.tangent,n=this.uv,o=this.positionOutput,a=this.normalOutput,l=this.tangentOutput,c=this.uvOutput,h=`//${this.name}`;return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",h),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",h,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+=`${this._declareOutput(o,e)} = ${t.associatedVariableName};\r\n`,e.compilationString+="#ifdef NORMAL\r\n",e.compilationString+=`${this._declareOutput(a,e)} = ${i.associatedVariableName};\r\n`,e.compilationString+="#else\r\n",e.compilationString+=`${this._declareOutput(a,e)} = vec3(0., 0., 0.);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#ifdef TANGENT\r\n",e.compilationString+=`${this._declareOutput(l,e)} = ${s.associatedVariableName};\r\n`,e.compilationString+="#else\r\n",e.compilationString+=`${this._declareOutput(l,e)} = vec4(0., 0., 0., 0.);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#ifdef UV1\r\n",e.compilationString+=`${this._declareOutput(c,e)} = ${n.associatedVariableName};\r\n`,e.compilationString+="#else\r\n",e.compilationString+=`${this._declareOutput(c,e)} = vec2(0., 0.);\r\n`,e.compilationString+="#endif\r\n",this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this}}),le("BABYLON.LightInformationBlock",class Doe extends De{constructor(e){super(e,B.Vertex),this.registerInput("worldPosition",R.Vector4,!1,B.Vertex),this.registerOutput("direction",R.Vector3),this.registerOutput("color",R.Color3),this.registerOutput("intensity",R.Float),this.registerOutput("shadowBias",R.Float),this.registerOutput("shadowNormalBias",R.Float),this.registerOutput("shadowDepthScale",R.Float),this.registerOutput("shadowDepthRange",R.Vector2)}getClassName(){return"LightInformationBlock"}get worldPosition(){return this._inputs[0]}get direction(){return this._outputs[0]}get color(){return this._outputs[1]}get intensity(){return this._outputs[2]}get shadowBias(){return this._outputs[3]}get shadowNormalBias(){return this._outputs[4]}get shadowDepthScale(){return this._outputs[5]}get shadowDepthRange(){return this._outputs[6]}bind(e,t,i){if(!i)return;this.light&&this.light.isDisposed()&&(this.light=null);let s=this.light;const n=t.getScene();if(!s&&n.lights.length&&(s=this.light=n.lights[0],this._forcePrepareDefines=!0),!s||!s.isEnabled)return e.setFloat3(this._lightDataUniformName,0,0,0),void e.setFloat4(this._lightColorUniformName,0,0,0,0);s.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,s.diffuse,s.intensity);const o=s.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(o?e.setFloat3(this._lightShadowUniformName,o.bias,o.normalBias,o.depthScale):e.setFloat3(this._lightShadowUniformName,0,0,0)),this.shadowDepthRange)if(o&&n.activeCamera){const a=s;e.setFloat2(this._lightShadowExtraUniformName,a.getDepthMinZ(n.activeCamera),a.getDepthMinZ(n.activeCamera)+a.getDepthMaxZ(n.activeCamera))}else e.setFloat2(this._lightShadowExtraUniformName,0,0)}prepareDefines(e,t,i){if(!i._areLightsDirty&&!this._forcePrepareDefines)return;this._forcePrepareDefines=!1;const s=this.light;i.setValue(this._lightTypeDefineName,!!(s&&s instanceof od),!0)}_buildBlock(e){super._buildBlock(e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=this.direction,i=this.color,s=this.intensity,n=this.shadowBias,o=this.shadowNormalBias,a=this.shadowDepthScale,l=this.shadowDepthRange;return this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightShadowUniformName=e._getFreeVariableName("shadowData"),this._lightShadowExtraUniformName=e._getFreeVariableName("shadowExtraData"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE"),e._emitUniformFromString(this._lightDataUniformName,"vec3"),e._emitUniformFromString(this._lightColorUniformName,"vec4"),e.compilationString+=`#ifdef ${this._lightTypeDefineName}\r\n`,e.compilationString+=this._declareOutput(t,e)+` = normalize(${this.worldPosition.associatedVariableName}.xyz - ${this._lightDataUniformName});\r\n`,e.compilationString+="#else\r\n",e.compilationString+=this._declareOutput(t,e)+` = ${this._lightDataUniformName};\r\n`,e.compilationString+="#endif\r\n",e.compilationString+=this._declareOutput(i,e)+` = ${this._lightColorUniformName}.rgb;\r\n`,e.compilationString+=this._declareOutput(s,e)+` = ${this._lightColorUniformName}.a;\r\n`,(n.hasEndpoints||o.hasEndpoints||a.hasEndpoints)&&(e._emitUniformFromString(this._lightShadowUniformName,"vec3"),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${this._lightShadowUniformName}.x;\r\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${this._lightShadowUniformName}.y;\r\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${this._lightShadowUniformName}.z;\r\n`)),l.hasEndpoints&&(e._emitUniformFromString(this._lightShadowExtraUniformName,"vec2"),e.compilationString+=this._declareOutput(l,e)+` = ${this._lightShadowUniformName};\r\n`),this}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))}});class JG extends De{constructor(e){super(e,B.Fragment),this.convertInputToLinearSpace=!0,this.registerInput("color",R.AutoDetect),this.registerOutput("output",R.Color4),this.registerOutput("rgb",R.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(R.Color3|R.Color4|R.Vector3|R.Vector4)}getClassName(){return"ImageProcessingBlock"}get color(){return this._inputs[0]}get output(){return this._outputs[0]}get rgb(){return this._outputs[1]}initialize(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings"),e._excludeVariableName("ditherIntensity")}isReady(e,t,i){return!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}prepareDefines(e,t,i){i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i)}bind(e,t,i){!i||!t.imageProcessingConfiguration||t.imageProcessingConfiguration.bind(e)}_buildBlock(e){var t;super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity");const i=this.color,s=this._outputs[0],n=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",n),e._emitFunctionFromInclude("imageProcessingDeclaration",n),e._emitFunctionFromInclude("imageProcessingFunctions",n),!(null===(t=i.connectedPoint)||void 0===t)&&t.isConnected&&(e.compilationString+=i.connectedPoint.type===R.Color4||i.connectedPoint.type===R.Vector4?`${this._declareOutput(s,e)} = ${i.associatedVariableName};\r\n`:`${this._declareOutput(s,e)} = vec4(${i.associatedVariableName}, 1.0);\r\n`,e.compilationString+="#ifdef IMAGEPROCESSINGPOSTPROCESS\r\n",this.convertInputToLinearSpace&&(e.compilationString+=`${s.associatedVariableName}.rgb = toLinearSpace(${i.associatedVariableName}.rgb);\r\n`),e.compilationString+="#else\r\n",e.compilationString+="#ifdef IMAGEPROCESSING\r\n",this.convertInputToLinearSpace&&(e.compilationString+=`${s.associatedVariableName}.rgb = toLinearSpace(${i.associatedVariableName}.rgb);\r\n`),e.compilationString+=`${s.associatedVariableName} = applyImageProcessing(${s.associatedVariableName});\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#endif\r\n",this.rgb.hasEndpoints&&(e.compilationString+=this._declareOutput(this.rgb,e)+` = ${this.output.associatedVariableName}.xyz;\r\n`)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertInputToLinearSpace = ${this.convertInputToLinearSpace};\r\n`,e}serialize(){const e=super.serialize();return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.convertInputToLinearSpace=null===(s=e.convertInputToLinearSpace)||void 0===s||s}}E([_t("Convert input to linear space",lt.Boolean,"ADVANCED")],JG.prototype,"convertInputToLinearSpace",void 0),le("BABYLON.ImageProcessingBlock",JG);class cd extends De{constructor(e){super(e,B.Fragment,!0),this.registerInput("normal",R.AutoDetect,!1),this.normal.addExcludedConnectionPointFromAllowedTypes(R.Color4|R.Vector4|R.Vector3),this.registerInput("tangent",R.Vector4,!1),this.registerInput("world",R.Matrix,!1),this.registerOutput("TBN",R.Object,B.Fragment,new Qi("TBN",this,Ei.Output,cd,"TBNBlock")),this.registerOutput("row0",R.Vector3,B.Fragment),this.registerOutput("row1",R.Vector3,B.Fragment),this.registerOutput("row2",R.Vector3,B.Fragment)}getClassName(){return"TBNBlock"}initialize(e){e._excludeVariableName("tbnNormal"),e._excludeVariableName("tbnTangent"),e._excludeVariableName("tbnBitangent"),e._excludeVariableName("TBN")}get normal(){return this._inputs[0]}get tangent(){return this._inputs[1]}get world(){return this._inputs[2]}get TBN(){return this._outputs[0]}get row0(){return this._outputs[1]}get row1(){return this._outputs[2]}get row2(){return this._outputs[3]}get target(){return B.Fragment}set target(e){}autoConfigure(e){if(!this.world.isConnected){let t=e.getInputBlockByPredicate(i=>i.isSystemValue&&i.systemValue===it.World);t||(t=new et("world"),t.setAsSystemValue(it.World)),t.output.connectTo(this.world)}if(!this.normal.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"normal"===i.name);t||(t=new et("normal"),t.setAsAttribute("normal")),t.output.connectTo(this.normal)}if(!this.tangent.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"tangent"===i.name&&i.type===R.Vector4);t||(t=new et("tangent"),t.setAsAttribute("tangent")),t.output.connectTo(this.tangent)}}prepareDefines(e,t,i){var s,n,o,a;const l=this.normal,c=this.tangent;let h=l.isConnected;(null===(s=l.connectInputBlock)||void 0===s?void 0:s.isAttribute)&&!e.isVerticesDataPresent(null===(n=l.connectInputBlock)||void 0===n?void 0:n.name)&&(h=!1);let u=c.isConnected;(null===(o=c.connectInputBlock)||void 0===o?void 0:o.isAttribute)&&!e.isVerticesDataPresent(null===(a=c.connectInputBlock)||void 0===a?void 0:a.name)&&(u=!1),i.setValue("TBNBLOCK",h&&u,!0)}_buildBlock(e){super._buildBlock(e);const i=this.tangent,n=this.TBN,o=this.row0,a=this.row1,l=this.row2;return e.target===B.Fragment&&(e.compilationString+=`\n                // ${this.name}\n                vec3 tbnNormal = normalize(${this.normal.associatedVariableName}).xyz;\n                vec3 tbnTangent = normalize(${i.associatedVariableName}.xyz);\n                vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${i.associatedVariableName}.w;\n                mat3 ${n.associatedVariableName} = mat3(${this.world.associatedVariableName}) * mat3(tbnTangent, tbnBitangent, tbnNormal);\n            `,o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = vec3(${n.associatedVariableName}[0][0], ${n.associatedVariableName}[0][1], ${n.associatedVariableName}[0][2]);\r\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = vec3(${n.associatedVariableName}[1[0], ${n.associatedVariableName}[1][1], ${n.associatedVariableName}[1][2]);\r\n`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = vec3(${n.associatedVariableName}[2][0], ${n.associatedVariableName}[2][1], ${n.associatedVariableName}[2][2]);\r\n`),e.sharedData.blocksWithDefines.push(this)),this}}le("BABYLON.TBNBlock",cd);class Hp extends De{constructor(e){super(e,B.Fragment),this._tangentSpaceParameterName="",this._tangentCorrectionFactorName="",this._worldMatrixName="",this.invertX=!1,this.invertY=!1,this.useParallaxOcclusion=!1,this.useObjectSpaceNormalMap=!1,this._isUnique=!0,this.registerInput("worldPosition",R.Vector4,!1),this.registerInput("worldNormal",R.Vector4,!1),this.registerInput("worldTangent",R.Vector4,!0),this.registerInput("uv",R.Vector2,!1),this.registerInput("normalMapColor",R.Color3,!1),this.registerInput("strength",R.Float,!1),this.registerInput("viewDirection",R.Vector3,!0),this.registerInput("parallaxScale",R.Float,!0),this.registerInput("parallaxHeight",R.Float,!0),this.registerInput("TBN",R.Object,!0,B.VertexAndFragment,new Qi("TBN",this,Ei.Input,cd,"TBNBlock")),this.registerInput("world",R.Matrix,!0),this.registerOutput("output",R.Vector4),this.registerOutput("uvOffset",R.Vector2)}getClassName(){return"PerturbNormalBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get worldTangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get normalMapColor(){return this._inputs[4]}get strength(){return this._inputs[5]}get viewDirection(){return this._inputs[6]}get parallaxScale(){return this._inputs[7]}get parallaxHeight(){return this._inputs[8]}get TBN(){return this._inputs[9]}get world(){return this._inputs[10]}get output(){return this._outputs[0]}get uvOffset(){return this._outputs[1]}prepareDefines(e,t,i){const n=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&this.normalMapColor.connectedPoint._ownerBlock.samplerName||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);i.setValue("BUMP",!0),i.setValue("PARALLAX",n,!0),i.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0),i.setValue("OBJECTSPACE_NORMALMAP",this.useObjectSpaceNormalMap,!0)}bind(e,t,i){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1),i&&(e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1),this.useObjectSpaceNormalMap&&!this.world.isConnected&&e.setMatrix(this._worldMatrixName,i.getWorldMatrix()))}autoConfigure(e){if(!this.uv.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"uv"===i.name);t||(t=new et("uv"),t.setAsAttribute()),t.output.connectTo(this.uv)}if(!this.strength.isConnected){const t=new et("strength");t.value=1,t.output.connectTo(this.strength)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=this.uv,s=this.worldPosition,n=this.worldNormal,o=this.worldTangent;e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,"vec2"),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float"),this._worldMatrixName=e._getFreeDefineName("perturbNormalWorldMatrix"),e._emitUniformFromString(this._worldMatrixName,"mat4");let a=null;this.normalMapColor.connectedPoint&&(a=this.normalMapColor.connectedPoint._ownerBlock.samplerName);const l=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&a||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),c=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",h=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`\r\n#if !defined(NORMALXYSCALE)\r\n1.0/\r\n#endif\r\n${e._emitFloat(this.strength.connectInputBlock.value)}`:`\r\n#if !defined(NORMALXYSCALE)\r\n1.0/\r\n#endif\r\n${this.strength.associatedVariableName}`;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const u={search:/defined\(TANGENT\)/g,replace:o.isConnected?"defined(TANGENT)":"defined(IGNORE)"},p=this.TBN;p.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${p.associatedVariableName};\n            #endif\n            `:o.isConnected&&(e.compilationString+=`vec3 tbnNormal = normalize(${n.associatedVariableName}.xyz);\r\n`,e.compilationString+=`vec3 tbnTangent = normalize(${o.associatedVariableName}.xyz);\r\n`,e.compilationString+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\r\n`,e.compilationString+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r\n"),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:[u,{search:/varying mat3 vTBN/g,replace:""},{search:/uniform mat4 normalMatrix;/g,replace:""}]}),e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,replace:"#define inline\r\nvec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)"},{search:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g,replace:"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)"},{search:/texture2D\(bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});const _=l&&a?`texture2D(${a}, ${i.associatedVariableName} + uvOffset).xyz`:this.normalMapColor.associatedVariableName;return e.compilationString+=this._declareOutput(this.output,e)+" = vec4(0.);\r\n",e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:[{search:/texture2D\(bumpSampler,vBumpUV\)/g,replace:`${_}`},{search:/#define CUSTOM_FRAGMENT_BUMP_FRAGMENT/g,replace:`mat4 normalMatrix = toNormalMatrix(${this.world.isConnected?this.world.associatedVariableName:this._worldMatrixName});`},{search:/perturbNormal\(TBN,texture2D\(bumpSampler,vBumpUV\+uvOffset\).xyz,vBumpInfos.y\)/g,replace:`perturbNormal(TBN, ${_}, vBumpInfos.y)`},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:`parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${l&&this.useParallaxOcclusion?a:"bumpSampler"})`},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:`parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${l?this.parallaxHeight.associatedVariableName:"0."})`},{search:/vTangentSpaceParams/g,replace:this._tangentSpaceParameterName},{search:/vBumpInfos.y/g,replace:h},{search:/vBumpInfos.z/g,replace:c},{search:/vBumpUV/g,replace:i.associatedVariableName},{search:/vPositionW/g,replace:s.associatedVariableName+".xyz"},{search:/normalW=/g,replace:this.output.associatedVariableName+".xyz = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:"mat3(normalMatrix) * "+this.output.associatedVariableName+".xyz"},{search:/normalW/g,replace:n.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:l?this.viewDirection.associatedVariableName:"vec3(0.)"},u]}),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.invertX = ${this.invertX};\r\n`;return e+=`${this._codeVariableName}.invertY = ${this.invertY};\r\n`,e+=`${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};\r\n`,e+=`${this._codeVariableName}.useObjectSpaceNormalMap = ${this.useObjectSpaceNormalMap};\r\n`,e}serialize(){const e=super.serialize();return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e.useObjectSpaceNormalMap=this.useObjectSpaceNormalMap,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion,this.useObjectSpaceNormalMap=!!e.useObjectSpaceNormalMap}}E([_t("Invert X axis",lt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],Hp.prototype,"invertX",void 0),E([_t("Invert Y axis",lt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],Hp.prototype,"invertY",void 0),E([_t("Use parallax occlusion",lt.Boolean)],Hp.prototype,"useParallaxOcclusion",void 0),E([_t("Object Space Mode",lt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],Hp.prototype,"useObjectSpaceNormalMap",void 0),le("BABYLON.PerturbNormalBlock",Hp),le("BABYLON.DiscardBlock",class woe extends De{constructor(e){super(e,B.Fragment,!0),this.registerInput("value",R.Float,!0),this.registerInput("cutoff",R.Float,!0)}getClassName(){return"DiscardBlock"}get value(){return this._inputs[0]}get cutoff(){return this._inputs[1]}_buildBlock(e){if(super._buildBlock(e),e.sharedData.hints.needAlphaTesting=!0,this.cutoff.isConnected&&this.value.isConnected)return e.compilationString+=`if (${this.value.associatedVariableName} < ${this.cutoff.associatedVariableName}) discard;\r\n`,this}}),le("BABYLON.FrontFacingBlock",class Ooe extends De{constructor(e){super(e,B.Fragment),this.registerOutput("output",R.Float,B.Fragment)}getClassName(){return"FrontFacingBlock"}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),e.target===B.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";return e.compilationString+=this._declareOutput(this._outputs[0],e)+" = gl_FrontFacing ? 1.0 : 0.0;\r\n",this}}),le("BABYLON.DerivativeBlock",class Noe extends De{constructor(e){super(e,B.Fragment),this.registerInput("input",R.AutoDetect,!1),this.registerOutput("dx",R.BasedOnInput),this.registerOutput("dy",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[1]._typeConnectionSource=this._inputs[0]}getClassName(){return"DerivativeBlock"}get input(){return this._inputs[0]}get dx(){return this._outputs[0]}get dy(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1];return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),t.hasEndpoints&&(e.compilationString+=this._declareOutput(t,e)+` = dFdx(${this.input.associatedVariableName});\r\n`),i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+` = dFdy(${this.input.associatedVariableName});\r\n`),this}}),le("BABYLON.FragCoordBlock",class Foe extends De{constructor(e){super(e,B.Fragment),this.registerOutput("xy",R.Vector2,B.Fragment),this.registerOutput("xyz",R.Vector3,B.Fragment),this.registerOutput("xyzw",R.Vector4,B.Fragment),this.registerOutput("x",R.Float,B.Fragment),this.registerOutput("y",R.Float,B.Fragment),this.registerOutput("z",R.Float,B.Fragment),this.registerOutput("w",R.Float,B.Fragment)}getClassName(){return"FragCoordBlock"}get xy(){return this._outputs[0]}get xyz(){return this._outputs[1]}get xyzw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get output(){return this._outputs[6]}writeOutputs(e){let t="";for(const i of this._outputs)i.hasEndpoints&&(t+=`${this._declareOutput(i,e)} = gl_FragCoord.${i.name};\r\n`);return t}_buildBlock(e){if(super._buildBlock(e),e.target===B.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this}}),le("BABYLON.ScreenSizeBlock",class Loe extends De{constructor(e){super(e,B.Fragment),this.registerOutput("xy",R.Vector2,B.Fragment),this.registerOutput("x",R.Float,B.Fragment),this.registerOutput("y",R.Float,B.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){const t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let i="";for(const s of this._outputs)s.hasEndpoints&&(i+=`${this._declareOutput(s,e)} = ${t}.${s.name};\r\n`);return i}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===B.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";return e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,"vec2"),e.compilationString+=this.writeOutputs(e,this._varName),this}}),le("BABYLON.ScreenSpaceBlock",class Boe extends De{constructor(e){super(e,B.Fragment),this.registerInput("vector",R.AutoDetect),this.registerInput("worldViewProjection",R.Matrix),this.registerOutput("output",R.Vector2),this.registerOutput("x",R.Float),this.registerOutput("y",R.Float),this.inputs[0].addExcludedConnectionPointFromAllowedTypes(R.Color3|R.Vector3|R.Vector4)}getClassName(){return"ScreenSpaceBlock"}get vector(){return this._inputs[0]}get worldViewProjection(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(e){if(!this.worldViewProjection.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===it.WorldViewProjection);t||(t=new et("worldViewProjection"),t.setAsSystemValue(it.WorldViewProjection)),t.output.connectTo(this.worldViewProjection)}}_buildBlock(e){super._buildBlock(e);const t=this.vector;if(!t.connectedPoint)return;const s=this.worldViewProjection.associatedVariableName,n=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case R.Vector3:e.compilationString+=`vec4 ${n} = ${s} * vec4(${t.associatedVariableName}, 1.0);\r\n`;break;case R.Vector4:e.compilationString+=`vec4 ${n} = ${s} * ${t.associatedVariableName};\r\n`}return e.compilationString+=`${n}.xy /= ${n}.w;`,e.compilationString+=`${n}.xy = ${n}.xy * 0.5 + vec2(0.5, 0.5);`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${n}.xy;\r\n`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${n}.x;\r\n`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${n}.y;\r\n`),this}}),le("BABYLON.TwirlBlock",class Voe extends De{constructor(e){super(e,B.Fragment),this.registerInput("input",R.Vector2),this.registerInput("strength",R.Float),this.registerInput("center",R.Vector2),this.registerInput("offset",R.Vector2),this.registerOutput("output",R.Vector2),this.registerOutput("x",R.Float),this.registerOutput("y",R.Float)}getClassName(){return"TwirlBlock"}get input(){return this._inputs[0]}get strength(){return this._inputs[1]}get center(){return this._inputs[2]}get offset(){return this._inputs[3]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(){if(!this.center.isConnected){const e=new et("center");e.value=new de(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){const e=new et("strength");e.value=1,e.output.connectTo(this.strength)}if(!this.offset.isConnected){const e=new et("offset");e.value=new de(0,0),e.output.connectTo(this.offset)}}_buildBlock(e){super._buildBlock(e);const t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),s=e._getFreeVariableName("x"),n=e._getFreeVariableName("y"),o=e._getFreeVariableName("result");return e.compilationString+=`\n            vec2 ${t} = ${this.input.associatedVariableName} - ${this.center.associatedVariableName};\n            float ${i} = ${this.strength.associatedVariableName} * length(${t});\n            float ${s} = cos(${i}) * ${t}.x - sin(${i}) * ${t}.y;\n            float ${n} = sin(${i}) * ${t}.x + cos(${i}) * ${t}.y;\n            vec2 ${o} = vec2(${s} + ${this.center.associatedVariableName}.x + ${this.offset.associatedVariableName}.x, ${n} + ${this.center.associatedVariableName}.y + ${this.offset.associatedVariableName}.y);\n        `,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${o};\r\n`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${o}.x;\r\n`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${o}.y;\r\n`),this}});class hb extends De{constructor(e){super(e,B.Fragment),this.generateInWorldSpace=!1,this.automaticNormalizationNormal=!0,this.automaticNormalizationTangent=!0,this.registerInput("input",R.Float),this.registerInput("worldPosition",R.Vector3),this.registerInput("worldNormal",R.Vector3),this.registerInput("worldTangent",R.AutoDetect,!0),this.registerOutput("output",R.Vector4),this.registerOutput("xyz",R.Vector3),this._inputs[3].addExcludedConnectionPointFromAllowedTypes(R.Color3|R.Vector3|R.Vector4)}getClassName(){return"HeightToNormalBlock"}get input(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];!this.generateInWorldSpace&&!this.worldTangent.isConnected&&console.error(`You must connect the 'worldTangent' input of the ${this.name} block!`);const n=`\n            vec4 heightToNormal(in float height, in vec3 position, in vec3 tangent, in vec3 normal) {\n                ${this.generateInWorldSpace?"":"\n            vec3 biTangent = cross(normal, tangent);\n            mat3 TBN = mat3(tangent, biTangent, normal);\n            "}\n                ${this.automaticNormalizationTangent?"tangent = normalize(tangent);":""}\n                ${this.automaticNormalizationNormal?"normal = normalize(normal);":""}\n                vec3 worlddX = dFdx(position);\n                vec3 worlddY = dFdy(position);\n                vec3 crossX = cross(normal, worlddX);\n                vec3 crossY = cross(normal, worlddY);\n                float d = abs(dot(crossY, worlddX));\n                vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));\n                inToNormal.y *= -1.0;\n                vec3 result = normalize((d * normal) - inToNormal);\n                ${this.generateInWorldSpace?"":"\n            result = TBN * result;\n            result = result * vec3(0.5) + vec3(0.5);\n            "}\n                return vec4(result, 0.);\n            }`;return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitFunction("heightToNormal",n,"// heightToNormal"),e.compilationString+=this._declareOutput(t,e)+` = heightToNormal(${this.input.associatedVariableName}, ${this.worldPosition.associatedVariableName}, ${this.worldTangent.isConnected?this.worldTangent.associatedVariableName:"vec3(0.)"}.xyz, ${this.worldNormal.associatedVariableName});\r\n`,this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+` = ${this.output.associatedVariableName}.xyz;\r\n`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.generateInWorldSpace = ${this.generateInWorldSpace};\r\n`,e+=`${this._codeVariableName}.automaticNormalizationNormal = ${this.automaticNormalizationNormal};\r\n`,e+=`${this._codeVariableName}.automaticNormalizationTangent = ${this.automaticNormalizationTangent};\r\n`,e}serialize(){const e=super.serialize();return e.generateInWorldSpace=this.generateInWorldSpace,e.automaticNormalizationNormal=this.automaticNormalizationNormal,e.automaticNormalizationTangent=this.automaticNormalizationTangent,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.generateInWorldSpace=e.generateInWorldSpace,this.automaticNormalizationNormal=e.automaticNormalizationNormal,this.automaticNormalizationTangent=e.automaticNormalizationTangent}}E([_t("Generate in world space instead of tangent space",lt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],hb.prototype,"generateInWorldSpace",void 0),E([_t("Force normalization for the worldNormal input",lt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],hb.prototype,"automaticNormalizationNormal",void 0),E([_t("Force normalization for the worldTangent input",lt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],hb.prototype,"automaticNormalizationTangent",void 0),le("BABYLON.HeightToNormalBlock",hb),le("BABYLON.FragDepthBlock",class Uoe extends De{constructor(e){super(e,B.Fragment,!0),this.registerInput("depth",R.Float,!0),this.registerInput("worldPos",R.Vector4,!0),this.registerInput("viewProjection",R.Matrix,!0)}getClassName(){return"FragDepthBlock"}get depth(){return this._inputs[0]}get worldPos(){return this._inputs[1]}get viewProjection(){return this._inputs[2]}_buildBlock(e){return super._buildBlock(e),this.depth.isConnected?e.compilationString+=`gl_FragDepth = ${this.depth.associatedVariableName};\r\n`:this.worldPos.isConnected&&this.viewProjection.isConnected?e.compilationString+=`\n                vec4 p = ${this.viewProjection.associatedVariableName} * ${this.worldPos.associatedVariableName};\n                float v = p.z / p.w;\n                #ifndef IS_NDC_HALF_ZRANGE\n                    v = v * 0.5 + 0.5;\n                #endif\n                gl_FragDepth = v;\n    \n            `:console.warn("FragDepthBlock: either the depth input or both the worldPos and viewProjection inputs must be connected!"),this}}),le("BABYLON.ShadowMapBlock",class koe extends De{constructor(e){super(e,B.Fragment),this.registerInput("worldPosition",R.Vector4,!1),this.registerInput("viewProjection",R.Matrix,!1),this.registerInput("worldNormal",R.AutoDetect,!0),this.registerOutput("depth",R.Vector3),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(R.Color3|R.Vector3|R.Vector4)}getClassName(){return"ShadowMapBlock"}initialize(e){e._excludeVariableName("vPositionWSM"),e._excludeVariableName("lightDataSM"),e._excludeVariableName("biasAndScaleSM"),e._excludeVariableName("depthValuesSM"),e._excludeVariableName("clipPos"),e._excludeVariableName("worldPos"),e._excludeVariableName("zSM")}get worldPosition(){return this._inputs[0]}get viewProjection(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get depth(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitUniformFromString("biasAndScaleSM","vec3"),e._emitUniformFromString("lightDataSM","vec3"),e._emitUniformFromString("depthValuesSM","vec2"),e._emitFunctionFromInclude("packingFunctions",t),e.compilationString+=`vec4 worldPos = ${this.worldPosition.associatedVariableName};\r\n`,e.compilationString+="vec3 vPositionWSM;\r\n",e.compilationString+="float vDepthMetricSM = 0.0;\r\n",e.compilationString+="float zSM;\r\n",this.worldNormal.isConnected&&(e.compilationString+=`vec3 vNormalW = ${this.worldNormal.associatedVariableName}.xyz;\r\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexNormalBias",t)),e.compilationString+=`vec4 clipPos = ${this.viewProjection.associatedVariableName} * worldPos;\r\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexMetric",t,{replaceStrings:[{search:/gl_Position/g,replace:"clipPos"}]}),e.compilationString+=e._emitCodeFromInclude("shadowMapFragment",t,{replaceStrings:[{search:/return;/g,replace:""}]}),e.compilationString+="\n            #if SM_DEPTHTEXTURE == 1\n                #ifdef IS_NDC_HALF_ZRANGE\n                    gl_FragDepth = (clipPos.z / clipPos.w);\n                #else\n                    gl_FragDepth = (clipPos.z / clipPos.w) * 0.5 + 0.5;\n                #endif\n            #endif\n        ",e.compilationString+=`${this._declareOutput(this.depth,e)} = vec3(depthSM, 1., 1.);\r\n`,this}}),le("BABYLON.FogBlock",class Goe extends De{constructor(e){super(e,B.VertexAndFragment,!1),this.registerInput("worldPosition",R.Vector4,!1,B.Vertex),this.registerInput("view",R.Matrix,!1,B.Vertex),this.registerInput("input",R.AutoDetect,!1,B.Fragment),this.registerInput("fogColor",R.AutoDetect,!1,B.Fragment),this.registerOutput("output",R.Color3,B.Fragment),this.input.addExcludedConnectionPointFromAllowedTypes(R.Color3|R.Vector3|R.Color4),this.fogColor.addExcludedConnectionPointFromAllowedTypes(R.Color3|R.Vector3|R.Color4)}getClassName(){return"FogBlock"}get worldPosition(){return this._inputs[0]}get view(){return this._inputs[1]}get input(){return this._inputs[2]}get fogColor(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===it.View);t||(t=new et("view"),t.setAsSystemValue(it.View)),t.output.connectTo(this.view)}if(!this.fogColor.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===it.FogColor);t||(t=new et("fogColor",void 0,R.Color3),t.setAsSystemValue(it.FogColor)),t.output.connectTo(this.fogColor)}}prepareDefines(e,t,i){const s=e.getScene();i.setValue("FOG",t.fogEnabled&&ce.GetFogState(e,s))}bind(e,t,i){if(!i)return;const s=i.getScene();e.setFloat4(this._fogParameters,s.fogMode,s.fogStart,s.fogEnd,s.fogDensity)}_buildBlock(e){if(super._buildBlock(e),e.target===B.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e._emitFunctionFromInclude("fogFragmentDeclaration",`//${this.name}`,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}]});const t=e._getFreeVariableName("fog"),i=this.input,s=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");const n=this._outputs[0];e._emitUniformFromString(this._fogParameters,"vec4"),e.compilationString+="#ifdef FOG\r\n",e.compilationString+=`float ${t} = CalcFogFactor(${this._fogDistanceName}, ${this._fogParameters});\r\n`,e.compilationString+=this._declareOutput(n,e)+` = ${t} * ${i.associatedVariableName}.rgb + (1.0 - ${t}) * ${s.associatedVariableName}.rgb;\r\n`,e.compilationString+=`#else\r\n${this._declareOutput(n,e)} =  ${i.associatedVariableName}.rgb;\r\n`,e.compilationString+="#endif\r\n"}else{const t=this.worldPosition,i=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,"vec3"),e.compilationString+=`${this._fogDistanceName} = (${i.associatedVariableName} * ${t.associatedVariableName}).xyz;\r\n`}return this}});class WC extends De{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?B.Fragment:B.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?B.Fragment:B.Vertex}constructor(e){super(e,B.VertexAndFragment),this._lightId=0,this.generateOnlyFragmentCode=!1,this._isUnique=!0,this.registerInput("worldPosition",R.Vector4,!1,B.Vertex),this.registerInput("worldNormal",R.Vector4,!1,B.Fragment),this.registerInput("cameraPosition",R.Vector3,!1,B.Fragment),this.registerInput("glossiness",R.Float,!0,B.Fragment),this.registerInput("glossPower",R.Float,!0,B.Fragment),this.registerInput("diffuseColor",R.Color3,!0,B.Fragment),this.registerInput("specularColor",R.Color3,!0,B.Fragment),this.registerInput("view",R.Matrix,!0),this.registerOutput("diffuseOutput",R.Color3,B.Fragment),this.registerOutput("specularOutput",R.Color3,B.Fragment),this.registerOutput("shadow",R.Float,B.Fragment)}getClassName(){return"LightBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get cameraPosition(){return this._inputs[2]}get glossiness(){return this._inputs[3]}get glossPower(){return this._inputs[4]}get diffuseColor(){return this._inputs[5]}get specularColor(){return this._inputs[6]}get view(){return this._inputs[7]}get diffuseOutput(){return this._outputs[0]}get specularOutput(){return this._outputs[1]}get shadow(){return this._outputs[2]}autoConfigure(e){if(!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===it.CameraPosition);t||(t=new et("cameraPosition"),t.setAsSystemValue(it.CameraPosition)),t.output.connectTo(this.cameraPosition)}}prepareDefines(e,t,i){if(!i._areLightsDirty)return;const s=e.getScene();if(this.light){const n={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};ce.PrepareDefinesForLight(s,e,this.light,this._lightId,i,!0,n),n.needRebuild&&i.rebuild()}else ce.PrepareDefinesForLights(s,e,i,!0,t.maxSimultaneousLights)}updateUniformsAndSamples(e,t,i,s){for(let n=0;n<t.maxSimultaneousLights&&i["LIGHT"+n];n++){const o=e.uniforms.indexOf("vLightData"+n)>=0;ce.PrepareUniformsAndSamplersForLight(n,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+n],s,o)}}bind(e,t,i){if(!i)return;const s=i.getScene();this.light?ce.BindLight(this.light,this._lightId,s,e,!0):ce.BindLights(s,i,e,!0,t.maxSimultaneousLights)}_injectVertexCode(e){const t=this.worldPosition,i=`//${this.name}`;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const s="v_"+t.associatedVariableName;e._emitVaryingFromString(s,"vec4")&&(e.compilationString+=`${s} = ${t.associatedVariableName};\r\n`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`vec4 worldPos = ${t.associatedVariableName};\r\n`,this.view.isConnected&&(e.compilationString+=`mat4 view = ${this.view.associatedVariableName};\r\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))}_buildBlock(e){if(super._buildBlock(e),e.target!==B.Fragment)return void this._injectVertexCode(e);this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=`//${this.name}`,i=this.worldPosition;let s=i.associatedVariableName;this.generateOnlyFragmentCode?(s=e._getFreeVariableName("globalWorldPos"),e._emitFunction("light_globalworldpos",`vec3 ${s};\r\n`,t),e.compilationString+=`${s} = ${i.associatedVariableName}.xyz;\r\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${i.associatedVariableName}`:void 0})):s="v_"+s+".xyz",e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("lightsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:s}]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:s}]}),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),0===this._lightId&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${s});\r\n`),e.compilationString+="lightingInfo info;\r\n",e.compilationString+="float shadow = 1.;\r\n",e.compilationString+=`float glossiness = ${this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"} * ${this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0"};\r\n`,e.compilationString+="vec3 diffuseBase = vec3(0., 0., 0.);\r\n",e.compilationString+="vec3 specularBase = vec3(0., 0., 0.);\r\n",e.compilationString+=`vec3 normalW = ${this.worldNormal.associatedVariableName}.xyz;\r\n`),e.compilationString+=e._emitCodeFromInclude("lightFragment",t,this.light?{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}:{repeatKey:"maxSimultaneousLights"});const o=this.specularOutput;return e.compilationString+=this._declareOutput(this.diffuseOutput,e)+` = diffuseBase${this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:""};\r\n`,o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = specularBase${this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:""};\r\n`),this.shadow.hasEndpoints&&(e.compilationString+=this._declareOutput(this.shadow,e)+" = shadow;\r\n"),this}serialize(){const e=super.serialize();return e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}E([_t("Generate only fragment code",lt.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:WC._OnGenerateOnlyFragmentCodeChanged}})],WC.prototype,"generateOnlyFragmentCode",void 0),le("BABYLON.LightBlock",WC);class Rh extends De{get texture(){return this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=e?.getScene())&&void 0!==t?t:be.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,s=>s.hasTexture(this._texture)),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,s=>s.hasTexture(e))}get samplerName(){return this._samplerName}constructor(e){super(e,B.VertexAndFragment),this.registerOutput("source",R.Object,B.VertexAndFragment,new Qi("source",this,Ei.Output,Rh,"ImageSourceBlock"))}bind(e){!this.texture||e.setTexture(this._samplerName,this.texture)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}getClassName(){return"ImageSourceBlock"}get source(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.target===B.Vertex&&(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),e._emit2DSampler(this._samplerName),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\r\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\r\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\r\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\r\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\r\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\r\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\r\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\r\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\r\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\r\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r\n`),e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&"VideoTexture"!==this.texture.getClassName()&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!Ri.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=U.Parse(e.texture,t,i))}}le("BABYLON.ImageSourceBlock",Rh),le("BABYLON.TextureBlock",class zoe extends De{get texture(){var e;return this.source.isConnected?(null===(e=this.source.connectedPoint)||void 0===e?void 0:e.ownerBlock).texture:this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=e?.getScene())&&void 0!==t?t:be.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,s=>s.hasTexture(this._texture)),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,s=>s.hasTexture(e))}get samplerName(){return this._imageSource?this._imageSource.samplerName:this._samplerName}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){var t;e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)&&(null!==(t=this.texture.getScene())&&void 0!==t?t:be.LastCreatedScene)?.markAllMaterialsAsDirty(1,s=>s.hasTexture(this.texture))}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){var t;e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)&&(null!==(t=this.texture.getScene())&&void 0!==t?t:be.LastCreatedScene)?.markAllMaterialsAsDirty(1,s=>s.hasTexture(this.texture))}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,t?B.Fragment:B.VertexAndFragment),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this._fragmentOnly=t,this.registerInput("uv",R.AutoDetect,!1,B.VertexAndFragment),this.registerInput("source",R.Object,!0,B.VertexAndFragment,new Qi("source",this,Ei.Input,Rh,"ImageSourceBlock")),this.registerInput("layer",R.Float,!0),this.registerOutput("rgba",R.Color4,B.Neutral),this.registerOutput("rgb",R.Color3,B.Neutral),this.registerOutput("r",R.Float,B.Neutral),this.registerOutput("g",R.Float,B.Neutral),this.registerOutput("b",R.Float,B.Neutral),this.registerOutput("a",R.Float,B.Neutral),this.registerOutput("level",R.Float,B.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(R.Vector2|R.Vector3|R.Vector4),this._inputs[0]._prioritizeVertex=!t}getClassName(){return"TextureBlock"}get uv(){return this._inputs[0]}get source(){return this._inputs[1]}get layer(){return this._inputs[2]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}get target(){if(this._fragmentOnly)return B.Fragment;if(!this.uv.isConnected||this.uv.sourceBlock.isInput)return B.VertexAndFragment;let e=this.uv.connectedPoint;for(;e;){if(e.target===B.Fragment)return B.Fragment;if(e.target===B.Vertex)return B.VertexAndFragment;if(e.target===B.Neutral||e.target===B.VertexAndFragment){const t=e.ownerBlock;if(t.target===B.Fragment)return B.Fragment;e=null;for(const i of t.inputs)if(i.connectedPoint){e=i.connectedPoint;break}}}return B.VertexAndFragment}set target(e){}autoConfigure(e){if(!this.uv.isConnected)if(e.mode===wr.PostProcess){const t=e.getBlockByPredicate(i=>"uv"===i.name);t&&t.connectTo(this)}else{const t=e.mode===wr.Particle?"particle_uv":"uv";let i=e.getInputBlockByPredicate(s=>s.isAttribute&&s.name===t);i||(i=new et("uv"),i.setAsAttribute(t)),i.output.connectTo(this.uv)}}initializeDefines(e,t,i){!i._areTexturesDirty||void 0!==this._mainUVDefineName&&i.setValue(this._mainUVDefineName,!1,!0)}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;if(!this.texture||!this.texture.getTextureMatrix)return void(this._isMixed&&(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)));const n=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,!0),i.setValue(this._gammaDefineName,n,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)):(i.setValue(this._defineName,!0),null==i[this._mainUVDefineName]&&i.setValue(this._mainUVDefineName,!1,!0)))}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){!this.texture||(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))}get _isMixed(){return this.target!==B.Fragment}_injectVertexCode(e){const t=this.uv;if(this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.associatedVariableName.toUpperCase(),this._mainUVName="vMain"+t.associatedVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,"vec2",this._defineName),e._emitVaryingFromString(this._mainUVName,"vec2",this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,"mat4",this._defineName),e.compilationString+=`#ifdef ${this._defineName}\r\n`,e.compilationString+=`${this._transformedUVName} = vec2(${this._textureTransformName} * vec4(${t.associatedVariableName}.xy, 1.0, 0.0));\r\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\r\n`,e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\r\n`,e.compilationString+="#endif\r\n",this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&"level"!==i.name&&this._writeOutput(e,i,i.name,!0)}}_getUVW(e){var t,i,s;let n=e;return null!==(s=null===(i=null===(t=this._texture)||void 0===t?void 0:t._texture)||void 0===i?void 0:i.is2DArray)&&void 0!==s&&s&&(n=`vec3(${e}, ${this.layer.isConnected?this.layer.associatedVariableName:"0"})`),n}_generateTextureLookup(e){const t=this.samplerName;e.compilationString+=`#ifdef ${this._defineName}\r\n`,e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${t}, ${this._getUVW(this._transformedUVName)});\r\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\r\n`,e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${t}, ${this._getUVW(this._mainUVName?this._mainUVName:this.uv.associatedVariableName)});\r\n`,e.compilationString+="#endif\r\n"}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===B.Fragment)return;this._generateTextureLookup(e)}else this.uv.ownerBlock.target!==B.Fragment?this._generateTextureLookup(e):e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this.samplerName}, ${this._getUVW(i.associatedVariableName)});\r\n`}_generateConversionCode(e,t,i){"a"!==i&&((!this.texture||!this.texture.gammaSpace)&&(e.compilationString+=`#ifdef ${this._linearDefineName}\n                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n                    #endif\n                `),e.compilationString+=`#ifdef ${this._gammaDefineName}\n                ${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n                #endif\n            `)}_writeOutput(e,t,i,s=!1){if(s){if(e.target===B.Fragment)return;return e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`,void this._generateConversionCode(e,t,i)}if(this.uv.ownerBlock.target===B.Fragment)return e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`,void this._generateConversionCode(e,t,i);let n="";this.disableLevelMultiplication||(n=` * ${this._textureInfoName}`),e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i}${n};\r\n`,this._generateConversionCode(e,t,i)}_buildBlock(e){var t,i,s,n;if(super._buildBlock(e),this._imageSource=this.source.isConnected?this.source.connectedPoint.ownerBlock:null,(e.target===B.Vertex||this._fragmentOnly||e.target===B.Fragment)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),(!this._isMixed&&e.target===B.Fragment||this._isMixed&&e.target===B.Vertex)&&(this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),null!==(i=null===(t=this._texture)||void 0===t?void 0:t._texture)&&void 0!==i&&i.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)),e.target===B.Fragment){if(this._outputs.some(a=>a.isConnectedInFragmentShader)){this._isMixed&&!this._imageSource&&(null!==(n=null===(s=this._texture)||void 0===s?void 0:s._texture)&&void 0!==n&&n.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName)),e._emitFunctionFromInclude("helperFunctions",`//${this.name}`),this._isMixed&&e._emitUniformFromString(this._textureInfoName,"float"),this._writeTextureRead(e);for(const a of this._outputs)a.hasEndpoints&&"level"!==a.name&&this._writeOutput(e,a,a.name);return this}}else this._injectVertexCode(e)}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\r\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\r\n`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\r\n`,this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\r\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\r\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\r\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\r\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\r\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\r\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\r\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\r\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\r\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\r\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r\n`),e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,!this.hasImageSource&&this.texture&&!this.texture.isRenderTarget&&"VideoTexture"!==this.texture.getClassName()&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!Ri.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=U.Parse(e.texture,t,i))}});class Wp extends De{get texture(){return this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=e?.getScene())&&void 0!==t?t:be.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,s=>s.hasTexture(this._texture)),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,s=>s.hasTexture(e))}static _OnGenerateOnlyFragmentCodeChanged(e,t){return e._onGenerateOnlyFragmentCodeChanged()}_onGenerateOnlyFragmentCodeChanged(){return this._setTarget(),!0}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?B.Fragment:B.VertexAndFragment)}constructor(e){super(e,B.VertexAndFragment),this.generateOnlyFragmentCode=!1}getClassName(){return"ReflectionTextureBaseBlock"}_getTexture(){return this.texture}autoConfigure(e){if(!this.position.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"position"===i.name);t||(t=new et("position"),t.setAsAttribute()),t.output.connectTo(this.position)}if(!this.world.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===it.World);t||(t=new et("world"),t.setAsSystemValue(it.World)),t.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===it.View);t||(t=new et("view"),t.setAsSystemValue(it.View)),t.output.connectTo(this.view)}}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const s=this._getTexture();!s||!s.getTextureMatrix||(i.setValue(this._define3DName,s.isCube,!0),i.setValue(this._defineLocalCubicName,!!s.boundingBoxSize,!0),i.setValue(this._defineExplicitName,0===s.coordinatesMode,!0),i.setValue(this._defineSkyboxName,5===s.coordinatesMode,!0),i.setValue(this._defineCubicName,3===s.coordinatesMode||6===s.coordinatesMode,!0),i.setValue("INVERTCUBICMAP",6===s.coordinatesMode,!0),i.setValue(this._defineSphericalName,1===s.coordinatesMode,!0),i.setValue(this._definePlanarName,2===s.coordinatesMode,!0),i.setValue(this._defineProjectionName,4===s.coordinatesMode,!0),i.setValue(this._defineEquirectangularName,7===s.coordinatesMode,!0),i.setValue(this._defineEquirectangularFixedName,8===s.coordinatesMode,!0),i.setValue(this._defineMirroredEquirectangularFixedName,9===s.coordinatesMode,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){const s=this._getTexture();if(i&&s&&(e.setMatrix(this._reflectionMatrixName,s.getReflectionTextureMatrix()),e.setTexture(s.isCube?this._cubeSamplerName:this._2DSamplerName,s),s.boundingBoxSize)){const n=s;e.setVector3(this._reflectionPositionName,n.boundingBoxPosition),e.setVector3(this._reflectionSizeName,n.boundingBoxSize)}}handleVertexSide(e){if(this.generateOnlyFragmentCode&&e.target===B.Vertex)return"";this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,"mat4");let t="";this._worldPositionNameInFragmentOnlyMode=e._getFreeVariableName("worldPosition");const i=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName;return(this.generateOnlyFragmentCode||e._emitVaryingFromString(i,"vec4"))&&(t+=`${this.generateOnlyFragmentCode?"vec4 ":""}${i} = ${this.worldPosition.associatedVariableName};\r\n`),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._positionUVWName,"vec3",this._defineSkyboxName))&&(t+=`#ifdef ${this._defineSkyboxName}\r\n`,t+=`${this.generateOnlyFragmentCode?"vec3 ":""}${this._positionUVWName} = ${this.position.associatedVariableName}.xyz;\r\n`,t+="#endif\r\n"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._directionWName,"vec3",`defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})`))&&(t+=`#if defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})\r\n`,t+=`${this.generateOnlyFragmentCode?"vec3 ":""}${this._directionWName} = normalize(vec3(${this.world.associatedVariableName} * vec4(${this.position.associatedVariableName}.xyz, 0.0)));\r\n`,t+="#endif\r\n"),t}handleFragmentSideInits(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+=`#ifdef ${this._define3DName}\r\n`,e._samplerDeclaration+=`uniform samplerCube ${this._cubeSamplerName};\r\n`,e._samplerDeclaration+="#else\r\n",e._samplerDeclaration+=`uniform sampler2D ${this._2DSamplerName};\r\n`,e._samplerDeclaration+="#endif\r\n",e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunction("ReciprocalPI","#define RECIPROCAL_PI2 0.15915494",""),e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("reflectionFunction",t,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords"),this._reflectionPositionName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionPositionName,"vec3"),this._reflectionSizeName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionSizeName,"vec3")}handleFragmentSideCodeReflectionCoords(e,t,i=!1,s=!1){t||(t=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:`v_${this.worldPosition.associatedVariableName}`);const n=this._reflectionMatrixName,o=`normalize(${this._directionWName})`,l=`${this.cameraPosition.associatedVariableName}`,c=`${this.view.associatedVariableName}`;let h=`\n            #ifdef ${this._defineMirroredEquirectangularFixedName}\n                vec3 ${this._reflectionVectorName} = computeMirroredFixedEquirectangularCoords(${t}, ${e+=".xyz"}, ${o});\n            #endif\n\n            #ifdef ${this._defineEquirectangularFixedName}\n                vec3 ${this._reflectionVectorName} = computeFixedEquirectangularCoords(${t}, ${e}, ${o});\n            #endif\n\n            #ifdef ${this._defineEquirectangularName}\n                vec3 ${this._reflectionVectorName} = computeEquirectangularCoords(${t}, ${e}, ${l}.xyz, ${n});\n            #endif\n\n            #ifdef ${this._defineSphericalName}\n                vec3 ${this._reflectionVectorName} = computeSphericalCoords(${t}, ${e}, ${c}, ${n});\n            #endif\n\n            #ifdef ${this._definePlanarName}\n                vec3 ${this._reflectionVectorName} = computePlanarCoords(${t}, ${e}, ${l}.xyz, ${n});\n            #endif\n\n            #ifdef ${this._defineCubicName}\n                #ifdef ${this._defineLocalCubicName}\n                    vec3 ${this._reflectionVectorName} = computeCubicLocalCoords(${t}, ${e}, ${l}.xyz, ${n}, ${this._reflectionSizeName}, ${this._reflectionPositionName});\n                #else\n                vec3 ${this._reflectionVectorName} = computeCubicCoords(${t}, ${e}, ${l}.xyz, ${n});\n                #endif\n            #endif\n\n            #ifdef ${this._defineProjectionName}\n                vec3 ${this._reflectionVectorName} = computeProjectionCoords(${t}, ${c}, ${n});\n            #endif\n\n            #ifdef ${this._defineSkyboxName}\n                vec3 ${this._reflectionVectorName} = computeSkyBoxCoords(${this._positionUVWName}, ${n});\n            #endif\n\n            #ifdef ${this._defineExplicitName}\n                vec3 ${this._reflectionVectorName} = vec3(0, 0, 0);\n            #endif\r\n`;return s||(h+=`#ifdef ${this._defineOppositeZ}\n                ${this._reflectionVectorName}.z *= -1.0;\n            #endif\r\n`),i||(h+=`\n                #ifdef ${this._define3DName}\n                    vec3 ${this._reflectionCoordsName} = ${this._reflectionVectorName};\n                #else\n                    vec2 ${this._reflectionCoordsName} = ${this._reflectionVectorName}.xy;\n                    #ifdef ${this._defineProjectionName}\n                        ${this._reflectionCoordsName} /= ${this._reflectionVectorName}.z;\n                    #endif\n                    ${this._reflectionCoordsName}.y = 1.0 - ${this._reflectionCoordsName}.y;\n                #endif\r\n`),h}handleFragmentSideCodeReflectionColor(e,t=".rgb"){let s=`${"vec"+(0===t.length?"4":t.length-1)} ${this._reflectionColorName};\n            #ifdef ${this._define3DName}\r\n`;return s+=e?`${this._reflectionColorName} = textureCubeLodEXT(${this._cubeSamplerName}, ${this._reflectionVectorName}, ${e})${t};\r\n`:`${this._reflectionColorName} = textureCube(${this._cubeSamplerName}, ${this._reflectionVectorName})${t};\r\n`,s+="\n            #else\r\n",s+=e?`${this._reflectionColorName} = texture2DLodEXT(${this._2DSamplerName}, ${this._reflectionCoordsName}, ${e})${t};\r\n`:`${this._reflectionColorName} = texture2D(${this._2DSamplerName}, ${this._reflectionCoordsName})${t};\r\n`,s+="#endif\r\n",s}writeOutputs(e,t){let i="";if(e.target===B.Fragment)for(const s of this._outputs)s.hasEndpoints&&(i+=`${this._declareOutput(s,e)} = ${t}.${s.name};\r\n`);return i}_buildBlock(e){return super._buildBlock(e),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();if(!this.texture)return e;if(this.texture.isCube){const t=this.texture.forcedExtension;e+=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}", undefined, undefined, ${this.texture.noMipmap}, null, undefined, undefined, undefined, ${this.texture._prefiltered}, ${t?'"'+t+'"':"null"});\r\n`}else e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null);\r\n`;return e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r\n`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!Ri.IgnoreTexturesAtLoadTime&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=e.texture.isCube?os.Parse(e.texture,t,i):U.Parse(e.texture,t,i)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}E([_t("Generate only fragment code",lt.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Wp._OnGenerateOnlyFragmentCodeChanged}})],Wp.prototype,"generateOnlyFragmentCode",void 0),le("BABYLON.ReflectionTextureBaseBlock",Wp),le("BABYLON.ReflectionTextureBlock",class Hoe extends Wp{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The position input must not be connected to be able to switch!"),!1):this.worldPosition.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?B.Fragment:B.Vertex,this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?B.Fragment:B.Vertex}constructor(e){super(e),this.registerInput("position",R.AutoDetect,!1,B.Vertex),this.registerInput("worldPosition",R.Vector4,!1,B.Vertex),this.registerInput("worldNormal",R.Vector4,!1,B.Fragment),this.registerInput("world",R.Matrix,!1,B.Vertex),this.registerInput("cameraPosition",R.Vector3,!1,B.Fragment),this.registerInput("view",R.Matrix,!1,B.Fragment),this.registerOutput("rgb",R.Color3,B.Fragment),this.registerOutput("rgba",R.Color4,B.Fragment),this.registerOutput("r",R.Float,B.Fragment),this.registerOutput("g",R.Float,B.Fragment),this.registerOutput("b",R.Float,B.Fragment),this.registerOutput("a",R.Float,B.Fragment),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(R.Color3|R.Vector3|R.Vector4)}getClassName(){return"ReflectionTextureBlock"}get position(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get world(){return this._inputs[3]}get cameraPosition(){return this._inputs[4]}get view(){return this._inputs[5]}get rgb(){return this._outputs[0]}get rgba(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}autoConfigure(e){if(super.autoConfigure(e),!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===it.CameraPosition);t||(t=new et("cameraPosition"),t.setAsSystemValue(it.CameraPosition)),t.output.connectTo(this.cameraPosition)}}_buildBlock(e){if(super._buildBlock(e),!this.texture)return e.compilationString+=this.writeOutputs(e,"vec4(0.)"),this;if(e.target!==B.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.generateOnlyFragmentCode&&(e.compilationString+=this.handleVertexSide(e)),this.handleFragmentSideInits(e);const t=e._getFreeVariableName("normalWUnit");return e.compilationString+=`vec4 ${t} = normalize(${this.worldNormal.associatedVariableName});\r\n`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this}});class ub extends De{constructor(e){super(e,B.VertexAndFragment),this.useNonLinearDepth=!1,this.storeCameraSpaceZ=!1,this.force32itsFloat=!1,this._isUnique=!0,this.registerInput("uv",R.AutoDetect,!1,B.VertexAndFragment),this.registerOutput("depth",R.Float,B.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(R.Vector2|R.Vector3|R.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"SceneDepthBlock"}get uv(){return this._inputs[0]}get depth(){return this._outputs[0]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?B.VertexAndFragment:B.Fragment}_getTexture(e){return e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat,void 0,this.storeCameraSpaceZ).getDepthMap()}bind(e,t){const i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec"+(t.type===R.Vector3?"3":t.type===R.Vector4?"4":"2"))),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\r\n`,this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,"r",!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===B.Fragment)return;e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName}.xy);\r\n`}else e.compilationString+=this.uv.ownerBlock.target!==B.Fragment?`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this._mainUVName});\r\n`:`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName}.xy);\r\n`}_writeOutput(e,t,i,s=!1){if(s){if(e.target===B.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`}else e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`}_buildBlock(e){if(super._buildBlock(e),this._samplerName=e._getFreeVariableName(this.name+"Sampler"),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.bindableBlocks.indexOf(this)<0&&e.sharedData.bindableBlocks.push(this),e.target!==B.Fragment)return e._emit2DSampler(this._samplerName),void this._injectVertexCode(e);if(this._outputs.some(t=>t.isConnectedInFragmentShader)){e._emit2DSampler(this._samplerName),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r");return this}}serialize(){const e=super.serialize();return e.useNonLinearDepth=this.useNonLinearDepth,e.storeCameraSpaceZ=this.storeCameraSpaceZ,e.force32itsFloat=this.force32itsFloat,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.storeCameraSpaceZ=!!e.storeCameraSpaceZ,this.force32itsFloat=e.force32itsFloat}}E([_t("Use non linear depth",lt.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(r,e)=>{let i=!1;return e.useNonLinearDepth&&(e.storeCameraSpaceZ=!1,i=!0),r.disableDepthRenderer(),i}}})],ub.prototype,"useNonLinearDepth",void 0),E([_t("Store Camera space Z",lt.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(r,e)=>{let i=!1;return e.storeCameraSpaceZ&&(e.useNonLinearDepth=!1,i=!0),r.disableDepthRenderer(),i}}})],ub.prototype,"storeCameraSpaceZ",void 0),E([_t("Force 32 bits float",lt.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:r=>r.disableDepthRenderer()}})],ub.prototype,"force32itsFloat",void 0),le("BABYLON.SceneDepthBlock",ub),le("BABYLON.ClipPlanesBlock",class Woe extends De{constructor(e){super(e,B.VertexAndFragment,!0),this.registerInput("worldPosition",R.Vector4,!1)}getClassName(){return"ClipPlanesBlock"}initialize(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6")}get worldPosition(){return this._inputs[0]}get target(){return B.VertexAndFragment}set target(e){}prepareDefines(e,t,i){var s,n,o,a,l,c;const h=e.getScene(),u=!!(null!==(s=t.clipPlane)&&void 0!==s?s:h.clipPlane),d=!!(null!==(n=t.clipPlane2)&&void 0!==n?n:h.clipPlane2),f=!!(null!==(o=t.clipPlane3)&&void 0!==o?o:h.clipPlane3),p=!!(null!==(a=t.clipPlane4)&&void 0!==a?a:h.clipPlane4),_=!!(null!==(l=t.clipPlane5)&&void 0!==l?l:h.clipPlane5),m=!!(null!==(c=t.clipPlane6)&&void 0!==c?c:h.clipPlane6);i.setValue("CLIPPLANE",u,!0),i.setValue("CLIPPLANE2",d,!0),i.setValue("CLIPPLANE3",f,!0),i.setValue("CLIPPLANE4",p,!0),i.setValue("CLIPPLANE5",_,!0),i.setValue("CLIPPLANE6",m,!0)}bind(e,t,i){i&&fo(e,t,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;if(e.target!==B.Fragment){const i=this.worldPosition;return e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane","vec4"),e._emitUniformFromString("vClipPlane2","vec4"),e._emitUniformFromString("vClipPlane3","vec4"),e._emitUniformFromString("vClipPlane4","vec4"),e._emitUniformFromString("vClipPlane5","vec4"),void e._emitUniformFromString("vClipPlane6","vec4")}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this}}),le("BABYLON.AddBlock",class Xoe extends De{constructor(e){super(e,B.Neutral),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"AddBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};\r\n`,this}}),le("BABYLON.ScaleBlock",class joe extends De{constructor(e){super(e,B.Neutral),this.registerInput("input",R.AutoDetect),this.registerInput("factor",R.Float),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ScaleBlock"}get input(){return this._inputs[0]}get factor(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${this.input.associatedVariableName} * ${this.factor.associatedVariableName};\r\n`,this}});class XC extends De{constructor(e){super(e,B.Neutral),this.minimum=0,this.maximum=1,this.registerInput("value",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = clamp(${this.value.associatedVariableName}, ${this._writeFloat(this.minimum)}, ${this._writeFloat(this.maximum)});\r\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};\r\n`;return e+=`${this._codeVariableName}.maximum = ${this.maximum};\r\n`,e}serialize(){const e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.minimum=e.minimum,this.maximum=e.maximum}}E([_t("Minimum",lt.Float)],XC.prototype,"minimum",void 0),E([_t("Maximum",lt.Float)],XC.prototype,"maximum",void 0),le("BABYLON.ClampBlock",XC),le("BABYLON.CrossBlock",class Yoe extends De{constructor(e){super(e,B.Neutral),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerOutput("output",R.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(R.Float),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Vector2),this._inputs[1].excludedConnectionPointTypes.push(R.Float),this._inputs[1].excludedConnectionPointTypes.push(R.Matrix),this._inputs[1].excludedConnectionPointTypes.push(R.Vector2)}getClassName(){return"CrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = cross(${this.left.associatedVariableName}.xyz, ${this.right.associatedVariableName}.xyz);\r\n`,this}}),le("BABYLON.CustomBlock",class qoe extends De{get options(){return this._options}set options(e){this._deserializeOptions(e)}constructor(e){super(e)}getClassName(){return"CustomBlock"}_buildBlock(e){super._buildBlock(e);let t=this._code,i=this._options.functionName;this._inputs.forEach(n=>{const o=new RegExp("\\{TYPE_"+n.name+"\\}","gm"),a=e._getGLType(n.type);t=t.replace(o,a),i=i.replace(o,a)}),this._outputs.forEach(n=>{const o=new RegExp("\\{TYPE_"+n.name+"\\}","gm"),a=e._getGLType(n.type);t=t.replace(o,a),i=i.replace(o,a)}),e._emitFunction(i,t,""),this._outputs.forEach(n=>{e.compilationString+=this._declareOutput(n,e)+";\r\n"}),e.compilationString+=i+"(";let s=!1;return this._inputs.forEach((n,o)=>{o>0&&(e.compilationString+=", "),e.compilationString+=n.associatedVariableName,s=!0}),this._outputs.forEach((n,o)=>{(o>0||s)&&(e.compilationString+=", "),e.compilationString+=n.associatedVariableName}),e.compilationString+=");\r\n",this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.options = ${JSON.stringify(this._options)};\r\n`,e}serialize(){const e=super.serialize();return e.options=this._options,e}_deserialize(e,t,i){this._deserializeOptions(e.options),super._deserialize(e,t,i)}_deserializeOptions(e){var t,i,s;this._options=e,this._code=e.code.join("\r\n")+"\r\n",this.name=this.name||e.name,this.target=B[e.target],null===(t=e.inParameters)||void 0===t||t.forEach((n,o)=>{this.registerInput(n.name,R[n.type]),Object.defineProperty(this,n.name,{get:function(){return this._inputs[o]},enumerable:!0,configurable:!0})}),null===(i=e.outParameters)||void 0===i||i.forEach((n,o)=>{this.registerOutput(n.name,R[n.type]),Object.defineProperty(this,n.name,{get:function(){return this._outputs[o]},enumerable:!0,configurable:!0}),"BasedOnInput"===n.type&&(this._outputs[o]._typeConnectionSource=this._findInputByName(n.typeFromInput)[0])}),null===(s=e.inLinkedConnectionTypes)||void 0===s||s.forEach(n=>{this._linkConnectionTypes(this._findInputByName(n.input1)[1],this._findInputByName(n.input2)[1])})}_findInputByName(e){if(!e)return null;for(let t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null}}),le("BABYLON.DotBlock",class $oe extends De{constructor(e){super(e,B.Neutral),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerOutput("output",R.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(R.Float),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[1].excludedConnectionPointTypes.push(R.Float),this._inputs[1].excludedConnectionPointTypes.push(R.Matrix)}getClassName(){return"DotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = dot(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r\n`,this}}),le("BABYLON.NormalizeBlock",class Koe extends De{constructor(e){super(e,B.Neutral),this.registerInput("input",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(R.Float),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix)}getClassName(){return"NormalizeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const i=this._inputs[0];return e.compilationString+=this._declareOutput(this._outputs[0],e)+` = normalize(${i.associatedVariableName});\r\n`,this}}),le("BABYLON.ColorMergerBlock",class Qoe extends De{constructor(e){super(e,B.Neutral),this.rSwizzle="r",this.gSwizzle="g",this.bSwizzle="b",this.aSwizzle="a",this.registerInput("rgb ",R.Color3,!0),this.registerInput("r",R.Float,!0),this.registerInput("g",R.Float,!0),this.registerInput("b",R.Float,!0),this.registerInput("a",R.Float,!0),this.registerOutput("rgba",R.Color4),this.registerOutput("rgb",R.Color3)}getClassName(){return"ColorMergerBlock"}get rgbIn(){return this._inputs[0]}get r(){return this._inputs[1]}get g(){return this._inputs[2]}get b(){return this._inputs[3]}get a(){return this._inputs[4]}get rgba(){return this._outputs[0]}get rgbOut(){return this._outputs[1]}get rgb(){return this.rgbOut}_inputRename(e){return"rgb "===e?"rgbIn":e}_buildSwizzle(e){return"."+(this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle).substr(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.r,i=this.g,s=this.b,n=this.a,o=this.rgbIn,a=this._outputs[0],l=this._outputs[1];return o.isConnected?(a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = vec4(${o.associatedVariableName}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};\r\n`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = ${o.associatedVariableName}${this._buildSwizzle(3)};\r\n`)):(a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};\r\n`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = vec3(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\r\n`)),this}serialize(){const e=super.serialize();return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e}_deserialize(e,t,i){var s,n,o,a;super._deserialize(e,t,i),this.rSwizzle=null!==(s=e.rSwizzle)&&void 0!==s?s:"r",this.gSwizzle=null!==(n=e.gSwizzle)&&void 0!==n?n:"g",this.bSwizzle=null!==(o=e.bSwizzle)&&void 0!==o?o:"b",this.aSwizzle=null!==(a=e.aSwizzle)&&void 0!==a?a:"a"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.rSwizzle = "${this.rSwizzle}";\r\n`,e+=`${this._codeVariableName}.gSwizzle = "${this.gSwizzle}";\r\n`,e+=`${this._codeVariableName}.bSwizzle = "${this.bSwizzle}";\r\n`,e+=`${this._codeVariableName}.aSwizzle = "${this.aSwizzle}";\r\n`,e}}),le("BABYLON.VectorSplitterBlock",class Zoe extends De{constructor(e){super(e,B.Neutral),this.registerInput("xyzw",R.Vector4,!0),this.registerInput("xyz ",R.Vector3,!0),this.registerInput("xy ",R.Vector2,!0),this.registerOutput("xyz",R.Vector3),this.registerOutput("xy",R.Vector2),this.registerOutput("zw",R.Vector2),this.registerOutput("x",R.Float),this.registerOutput("y",R.Float),this.registerOutput("z",R.Float),this.registerOutput("w",R.Float),this.inputsAreExclusive=!0}getClassName(){return"VectorSplitterBlock"}get xyzw(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get xyzOut(){return this._outputs[0]}get xyOut(){return this._outputs[1]}get zw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get w(){return this._outputs[6]}_inputRename(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}}_outputRename(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],s=this._outputs[1],n=this._outputs[2],o=this._outputs[3],a=this._outputs[4],l=this._outputs[5],c=this._outputs[6];return i.hasEndpoints&&(e.compilationString+=t===this.xyIn?this._declareOutput(i,e)+` = vec3(${t.associatedVariableName}, 0.0);\r\n`:this._declareOutput(i,e)+` = ${t.associatedVariableName}.xyz;\r\n`),n.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=this._declareOutput(n,e)+` = ${this.xyzw.associatedVariableName}.zw;\r\n`),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+` = ${t.associatedVariableName}.xy;\r\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${t.associatedVariableName}.x;\r\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${t.associatedVariableName}.y;\r\n`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = ${t.associatedVariableName}.z;\r\n`),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+` = ${t.associatedVariableName}.w;\r\n`),this}}),le("BABYLON.LerpBlock",class Joe extends De{constructor(e){super(e,B.Neutral),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerInput("gradient",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(R.Float)}getClassName(){return"LerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});\r\n`,this}}),le("BABYLON.DivideBlock",class eae extends De{constructor(e){super(e,B.Neutral),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"DivideBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};\r\n`,this}}),le("BABYLON.SubtractBlock",class tae extends De{constructor(e){super(e,B.Neutral),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"SubtractBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};\r\n`,this}}),le("BABYLON.StepBlock",class iae extends De{constructor(e){super(e,B.Neutral),this.registerInput("value",R.Float),this.registerInput("edge",R.Float),this.registerOutput("output",R.Float)}getClassName(){return"StepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});\r\n`,this}});class ez extends De{constructor(e){super(e,B.Neutral),this.registerInput("input",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0].excludedConnectionPointTypes.push(R.Matrix)}getClassName(){return"OneMinusBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = 1. - ${this.input.associatedVariableName};\r\n`,this}}le("BABYLON.OneMinusBlock",ez),le("BABYLON.OppositeBlock",ez);class tz extends De{constructor(e){super(e,B.Neutral),this.registerInput("worldPosition",R.Vector4),this.registerInput("cameraPosition",R.Vector3),this.registerOutput("output",R.Vector3)}getClassName(){return"ViewDirectionBlock"}get worldPosition(){return this._inputs[0]}get cameraPosition(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===it.CameraPosition);t||(t=new et("cameraPosition"),t.setAsSystemValue(it.CameraPosition)),t.output.connectTo(this.cameraPosition)}}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = normalize(${this.cameraPosition.associatedVariableName} - ${this.worldPosition.associatedVariableName}.xyz);\r\n`,this}}le("BABYLON.ViewDirectionBlock",tz),le("BABYLON.FresnelBlock",class sae extends De{constructor(e){super(e,B.Neutral),this.registerInput("worldNormal",R.Vector4),this.registerInput("viewDirection",R.Vector3),this.registerInput("bias",R.Float),this.registerInput("power",R.Float),this.registerOutput("fresnel",R.Float)}getClassName(){return"FresnelBlock"}get worldNormal(){return this._inputs[0]}get viewDirection(){return this._inputs[1]}get bias(){return this._inputs[2]}get power(){return this._inputs[3]}get fresnel(){return this._outputs[0]}autoConfigure(e){if(!this.viewDirection.isConnected){const t=new tz("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){const t=new et("bias");t.value=0,t.output.connectTo(this.bias)}if(!this.power.isConnected){const t=new et("power");t.value=1,t.output.connectTo(this.power)}}_buildBlock(e){return super._buildBlock(e),e._emitFunctionFromInclude("fresnelFunction",`//${this.name}`,{removeIfDef:!0}),e.compilationString+=this._declareOutput(this.fresnel,e)+` = computeFresnelTerm(${this.viewDirection.associatedVariableName}.xyz, ${this.worldNormal.associatedVariableName}.xyz, ${this.bias.associatedVariableName}, ${this.power.associatedVariableName});\r\n`,this}}),le("BABYLON.MaxBlock",class rae extends De{constructor(e){super(e,B.Neutral),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MaxBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r\n`,this}}),le("BABYLON.MinBlock",class nae extends De{constructor(e){super(e,B.Neutral),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MinBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r\n`,this}}),le("BABYLON.DistanceBlock",class oae extends De{constructor(e){super(e,B.Neutral),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerOutput("output",R.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(R.Float),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[1].excludedConnectionPointTypes.push(R.Float),this._inputs[1].excludedConnectionPointTypes.push(R.Matrix)}getClassName(){return"DistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = length(${this.left.associatedVariableName} - ${this.right.associatedVariableName});\r\n`,this}}),le("BABYLON.LengthBlock",class aae extends De{constructor(e){super(e,B.Neutral),this.registerInput("value",R.AutoDetect),this.registerOutput("output",R.Float),this._inputs[0].excludedConnectionPointTypes.push(R.Float),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix)}getClassName(){return"LengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = length(${this.value.associatedVariableName});\r\n`,this}}),le("BABYLON.NegateBlock",class lae extends De{constructor(e){super(e,B.Neutral),this.registerInput("value",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NegateBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = -1.0 * ${this.value.associatedVariableName};\r\n`,this}}),le("BABYLON.PowBlock",class cae extends De{constructor(e){super(e,B.Neutral),this.registerInput("value",R.AutoDetect),this.registerInput("power",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"PowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = pow(${this.value.associatedVariableName}, ${this.power.associatedVariableName});\r\n`,this}}),le("BABYLON.RandomNumberBlock",class hae extends De{constructor(e){super(e,B.Neutral),this.registerInput("seed",R.AutoDetect),this.registerOutput("output",R.Float),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(R.Vector2|R.Vector3|R.Vector4|R.Color3|R.Color4)}getClassName(){return"RandomNumberBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e._emitFunctionFromInclude("helperFunctions",`//${this.name}`),e.compilationString+=this._declareOutput(t,e)+` = getRand(${this.seed.associatedVariableName}.xy);\r\n`,this}}),le("BABYLON.ArcTan2Block",class uae extends De{constructor(e){super(e,B.Neutral),this.registerInput("x",R.Float),this.registerInput("y",R.Float),this.registerOutput("output",R.Float)}getClassName(){return"ArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = atan(${this.x.associatedVariableName}, ${this.y.associatedVariableName});\r\n`,this}}),le("BABYLON.SmoothStepBlock",class dae extends De{constructor(e){super(e,B.Neutral),this.registerInput("value",R.AutoDetect),this.registerInput("edge0",R.Float),this.registerInput("edge1",R.Float),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = smoothstep(${this.edge0.associatedVariableName}, ${this.edge1.associatedVariableName}, ${this.value.associatedVariableName});\r\n`,this}}),le("BABYLON.ReciprocalBlock",class fae extends De{constructor(e){super(e,B.Neutral),this.registerInput("input",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ReciprocalBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this.input.type===R.Matrix?this._declareOutput(t,e)+` = inverse(${this.input.associatedVariableName});\r\n`:this._declareOutput(t,e)+` = 1. / ${this.input.associatedVariableName};\r\n`,this}}),le("BABYLON.ReplaceColorBlock",class pae extends De{constructor(e){super(e,B.Neutral),this.registerInput("value",R.AutoDetect),this.registerInput("reference",R.AutoDetect),this.registerInput("distance",R.Float),this.registerInput("replacement",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(R.Float),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[1].excludedConnectionPointTypes.push(R.Float),this._inputs[1].excludedConnectionPointTypes.push(R.Matrix),this._inputs[3].excludedConnectionPointTypes.push(R.Float),this._inputs[3].excludedConnectionPointTypes.push(R.Matrix)}getClassName(){return"ReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+";\r\n",e.compilationString+=`if (length(${this.value.associatedVariableName} - ${this.reference.associatedVariableName}) < ${this.distance.associatedVariableName}) {\r\n`,e.compilationString+=`${t.associatedVariableName} = ${this.replacement.associatedVariableName};\r\n`,e.compilationString+="} else {\r\n",e.compilationString+=`${t.associatedVariableName} = ${this.value.associatedVariableName};\r\n`,e.compilationString+="}\r\n",this}}),le("BABYLON.PosterizeBlock",class _ae extends De{constructor(e){super(e,B.Neutral),this.registerInput("value",R.AutoDetect),this.registerInput("steps",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[1].excludedConnectionPointTypes.push(R.Matrix)}getClassName(){return"PosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = floor(${this.value.associatedVariableName} / (1.0 / ${this.steps.associatedVariableName})) * (1.0 / ${this.steps.associatedVariableName});\r\n`,this}});var Ih=(()=>{return(r=Ih||(Ih={}))[r.SawTooth=0]="SawTooth",r[r.Square=1]="Square",r[r.Triangle=2]="Triangle",Ih;var r})();le("BABYLON.WaveBlock",class mae extends De{constructor(e){super(e,B.Neutral),this.kind=Ih.SawTooth,this.registerInput("input",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(R.Matrix)}getClassName(){return"WaveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];switch(this.kind){case Ih.SawTooth:e.compilationString+=this._declareOutput(t,e)+` = ${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName});\r\n`;break;case Ih.Square:e.compilationString+=this._declareOutput(t,e)+` = 1.0 - 2.0 * round(fract(${this.input.associatedVariableName}));\r\n`;break;case Ih.Triangle:e.compilationString+=this._declareOutput(t,e)+` = 2.0 * abs(2.0 * (${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName}))) - 1.0;\r\n`}return this}serialize(){const e=super.serialize();return e.kind=this.kind,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.kind=e.kind}});class jC{get step(){return this._step}set step(e){this._step=e}get color(){return this._color}set color(e){this._color=e}constructor(e,t){this.step=e,this.color=t}}le("BABYLON.GradientBlock",class gae extends De{colorStepsUpdated(){this.onValueChangedObservable.notifyObservers(this)}constructor(e){super(e,B.Neutral),this.colorSteps=[new jC(0,re.Black()),new jC(1,re.White())],this.onValueChangedObservable=new z,this.registerInput("gradient",R.AutoDetect),this.registerOutput("output",R.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(R.Float|R.Vector2|R.Vector3|R.Vector4|R.Color3|R.Color4)}getClassName(){return"GradientBlock"}get gradient(){return this._inputs[0]}get output(){return this._outputs[0]}_writeColorConstant(e){const t=this.colorSteps[e];return`vec3(${t.color.r}, ${t.color.g}, ${t.color.b})`}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];if(!this.colorSteps.length||!this.gradient.connectedPoint)return void(e.compilationString+=this._declareOutput(t,e)+" = vec3(0., 0., 0.);\r\n");const i=e._getFreeVariableName("gradientTempColor"),s=e._getFreeVariableName("gradientTempPosition");e.compilationString+=`vec3 ${i} = ${this._writeColorConstant(0)};\r\n`,e.compilationString+=`float ${s};\r\n`;let n=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==R.Float&&(n+=".x");for(let o=1;o<this.colorSteps.length;o++){const a=this.colorSteps[o],l=this.colorSteps[o-1];e.compilationString+=`${s} = clamp((${n} - ${e._emitFloat(l.step)}) / (${e._emitFloat(a.step)} -  ${e._emitFloat(l.step)}), 0.0, 1.0) * step(${e._emitFloat(o)}, ${e._emitFloat(this.colorSteps.length-1)});\r\n`,e.compilationString+=`${i} = mix(${i}, ${this._writeColorConstant(o)}, ${s});\r\n`}return e.compilationString+=this._declareOutput(t,e)+` = ${i};\r\n`,this}serialize(){const e=super.serialize();e.colorSteps=[];for(const t of this.colorSteps)e.colorSteps.push({step:t.step,color:{r:t.color.r,g:t.color.g,b:t.color.b}});return e}_deserialize(e,t,i){super._deserialize(e,t,i),this.colorSteps.length=0;for(const s of e.colorSteps)this.colorSteps.push(new jC(s.step,new re(s.color.r,s.color.g,s.color.b)))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();e+=`${this._codeVariableName}.colorSteps = [];\r\n`;for(const t of this.colorSteps)e+=`${this._codeVariableName}.colorSteps.push(new BABYLON.GradientBlockColorStep(${t.step}, new BABYLON.Color3(${t.color.r}, ${t.color.g}, ${t.color.b})));\r\n`;return e}}),le("BABYLON.NLerpBlock",class vae extends De{constructor(e){super(e,B.Neutral),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerInput("gradient",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(R.Float)}getClassName(){return"NLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = normalize(mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName}));\r\n`,this}});class iz extends De{constructor(e){super(e,B.Neutral),this.manhattanDistance=!1,this.registerInput("seed",R.Vector3),this.registerInput("jitter",R.Float),this.registerOutput("output",R.Vector2),this.registerOutput("x",R.Float),this.registerOutput("y",R.Float)}getClassName(){return"WorleyNoise3DBlock"}get seed(){return this._inputs[0]}get jitter(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)return;let t="vec3 permute(vec3 x){\r\n";t+="    return mod((34.0 * x + 1.0) * x, 289.0);\r\n",t+="}\r\n\r\n",t+="vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\r\n",t+="    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\r\n",t+="}\r\n\r\n",t+="vec2 worley(vec3 P, float jitter, bool manhattanDistance){\r\n",t+="    float K = 0.142857142857; // 1/7\r\n",t+="    float Ko = 0.428571428571; // 1/2-K/2\r\n",t+="    float  K2 = 0.020408163265306; // 1/(7*7)\r\n",t+="    float Kz = 0.166666666667; // 1/6\r\n",t+="    float Kzo = 0.416666666667; // 1/2-1/6*2\r\n",t+="\r\n",t+="    vec3 Pi = mod(floor(P), 289.0);\r\n",t+="    vec3 Pf = fract(P) - 0.5;\r\n",t+="\r\n",t+="    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\r\n",t+="    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\r\n",t+="    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\r\n",t+="\r\n",t+="    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\r\n",t+="    vec3 p1 = permute(p + Pi.y - 1.0);\r\n",t+="    vec3 p2 = permute(p + Pi.y);\r\n",t+="    vec3 p3 = permute(p + Pi.y + 1.0);\r\n",t+="\r\n",t+="    vec3 p11 = permute(p1 + Pi.z - 1.0);\r\n",t+="    vec3 p12 = permute(p1 + Pi.z);\r\n",t+="    vec3 p13 = permute(p1 + Pi.z + 1.0);\r\n",t+="\r\n",t+="    vec3 p21 = permute(p2 + Pi.z - 1.0);\r\n",t+="    vec3 p22 = permute(p2 + Pi.z);\r\n",t+="    vec3 p23 = permute(p2 + Pi.z + 1.0);\r\n",t+="\r\n",t+="    vec3 p31 = permute(p3 + Pi.z - 1.0);\r\n",t+="    vec3 p32 = permute(p3 + Pi.z);\r\n",t+="    vec3 p33 = permute(p3 + Pi.z + 1.0);\r\n",t+="\r\n",t+="    vec3 ox11 = fract(p11*K) - Ko;\r\n",t+="    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\r\n",t+="\r\n",t+="    vec3 ox12 = fract(p12*K) - Ko;\r\n",t+="    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 ox13 = fract(p13*K) - Ko;\r\n",t+="    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 ox21 = fract(p21*K) - Ko;\r\n",t+="    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 ox22 = fract(p22*K) - Ko;\r\n",t+="    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 ox23 = fract(p23*K) - Ko;\r\n",t+="    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 ox31 = fract(p31*K) - Ko;\r\n",t+="    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 ox32 = fract(p32*K) - Ko;\r\n",t+="    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 ox33 = fract(p33*K) - Ko;\r\n",t+="    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 dx11 = Pfx + jitter*ox11;\r\n",t+="    vec3 dy11 = Pfy.x + jitter*oy11;\r\n",t+="    vec3 dz11 = Pfz.x + jitter*oz11;\r\n",t+="\r\n",t+="    vec3 dx12 = Pfx + jitter*ox12;\r\n",t+="    vec3 dy12 = Pfy.x + jitter*oy12;\r\n",t+="    vec3 dz12 = Pfz.y + jitter*oz12;\r\n",t+="\r\n",t+="    vec3 dx13 = Pfx + jitter*ox13;\r\n",t+="    vec3 dy13 = Pfy.x + jitter*oy13;\r\n",t+="    vec3 dz13 = Pfz.z + jitter*oz13;\r\n",t+="\r\n",t+="    vec3 dx21 = Pfx + jitter*ox21;\r\n",t+="    vec3 dy21 = Pfy.y + jitter*oy21;\r\n",t+="    vec3 dz21 = Pfz.x + jitter*oz21;\r\n",t+="\r\n",t+="    vec3 dx22 = Pfx + jitter*ox22;\r\n",t+="    vec3 dy22 = Pfy.y + jitter*oy22;\r\n",t+="    vec3 dz22 = Pfz.y + jitter*oz22;\r\n",t+="\r\n",t+="    vec3 dx23 = Pfx + jitter*ox23;\r\n",t+="    vec3 dy23 = Pfy.y + jitter*oy23;\r\n",t+="    vec3 dz23 = Pfz.z + jitter*oz23;\r\n",t+="\r\n",t+="    vec3 dx31 = Pfx + jitter*ox31;\r\n",t+="    vec3 dy31 = Pfy.z + jitter*oy31;\r\n",t+="    vec3 dz31 = Pfz.x + jitter*oz31;\r\n",t+="\r\n",t+="    vec3 dx32 = Pfx + jitter*ox32;\r\n",t+="    vec3 dy32 = Pfy.z + jitter*oy32;\r\n",t+="    vec3 dz32 = Pfz.y + jitter*oz32;\r\n",t+="\r\n",t+="    vec3 dx33 = Pfx + jitter*ox33;\r\n",t+="    vec3 dy33 = Pfy.z + jitter*oy33;\r\n",t+="    vec3 dz33 = Pfz.z + jitter*oz33;\r\n",t+="\r\n",t+="    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\r\n",t+="    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\r\n",t+="    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\r\n",t+="    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\r\n",t+="    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\r\n",t+="    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\r\n",t+="    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\r\n",t+="    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\r\n",t+="    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\r\n",t+="\r\n",t+="    vec3 d1a = min(d11, d12);\r\n",t+="    d12 = max(d11, d12);\r\n",t+="    d11 = min(d1a, d13); // Smallest now not in d12 or d13\r\n",t+="    d13 = max(d1a, d13);\r\n",t+="    d12 = min(d12, d13); // 2nd smallest now not in d13\r\n",t+="    vec3 d2a = min(d21, d22);\r\n",t+="    d22 = max(d21, d22);\r\n",t+="    d21 = min(d2a, d23); // Smallest now not in d22 or d23\r\n",t+="    d23 = max(d2a, d23);\r\n",t+="    d22 = min(d22, d23); // 2nd smallest now not in d23\r\n",t+="    vec3 d3a = min(d31, d32);\r\n",t+="    d32 = max(d31, d32);\r\n",t+="    d31 = min(d3a, d33); // Smallest now not in d32 or d33\r\n",t+="    d33 = max(d3a, d33);\r\n",t+="    d32 = min(d32, d33); // 2nd smallest now not in d33\r\n",t+="    vec3 da = min(d11, d21);\r\n",t+="    d21 = max(d11, d21);\r\n",t+="    d11 = min(da, d31); // Smallest now in d11\r\n",t+="    d31 = max(da, d31); // 2nd smallest now not in d31\r\n",t+="    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\r\n",t+="    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\r\n",t+="    d12 = min(d12, d21); // 2nd smallest now not in d21\r\n",t+="    d12 = min(d12, d22); // nor in d22\r\n",t+="    d12 = min(d12, d31); // nor in d31\r\n",t+="    d12 = min(d12, d32); // nor in d32\r\n",t+="    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\r\n",t+="    d11.y = min(d11.y,d12.z); // Only two more to go\r\n",t+="    d11.y = min(d11.y,d11.z); // Done! (Phew!)\r\n",t+="    return sqrt(d11.xy); // F1, F2\r\n",t+="}\r\n\r\n",e._emitFunction("worley3D","vec3 permute(vec3 x){\r\n    return mod((34.0 * x + 1.0) * x, 289.0);\r\n}\r\n\r\nvec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\r\n    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\r\n}\r\n\r\nvec2 worley(vec3 P, float jitter, bool manhattanDistance){\r\n    float K = 0.142857142857; // 1/7\r\n    float Ko = 0.428571428571; // 1/2-K/2\r\n    float  K2 = 0.020408163265306; // 1/(7*7)\r\n    float Kz = 0.166666666667; // 1/6\r\n    float Kzo = 0.416666666667; // 1/2-1/6*2\r\n\r\n    vec3 Pi = mod(floor(P), 289.0);\r\n    vec3 Pf = fract(P) - 0.5;\r\n\r\n    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\r\n    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\r\n    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\r\n\r\n    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\r\n    vec3 p1 = permute(p + Pi.y - 1.0);\r\n    vec3 p2 = permute(p + Pi.y);\r\n    vec3 p3 = permute(p + Pi.y + 1.0);\r\n\r\n    vec3 p11 = permute(p1 + Pi.z - 1.0);\r\n    vec3 p12 = permute(p1 + Pi.z);\r\n    vec3 p13 = permute(p1 + Pi.z + 1.0);\r\n\r\n    vec3 p21 = permute(p2 + Pi.z - 1.0);\r\n    vec3 p22 = permute(p2 + Pi.z);\r\n    vec3 p23 = permute(p2 + Pi.z + 1.0);\r\n\r\n    vec3 p31 = permute(p3 + Pi.z - 1.0);\r\n    vec3 p32 = permute(p3 + Pi.z);\r\n    vec3 p33 = permute(p3 + Pi.z + 1.0);\r\n\r\n    vec3 ox11 = fract(p11*K) - Ko;\r\n    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\r\n    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\r\n\r\n    vec3 ox12 = fract(p12*K) - Ko;\r\n    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\r\n    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\r\n\r\n    vec3 ox13 = fract(p13*K) - Ko;\r\n    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\r\n    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\r\n\r\n    vec3 ox21 = fract(p21*K) - Ko;\r\n    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\r\n    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\r\n\r\n    vec3 ox22 = fract(p22*K) - Ko;\r\n    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\r\n    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\r\n\r\n    vec3 ox23 = fract(p23*K) - Ko;\r\n    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\r\n    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\r\n\r\n    vec3 ox31 = fract(p31*K) - Ko;\r\n    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\r\n    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\r\n\r\n    vec3 ox32 = fract(p32*K) - Ko;\r\n    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\r\n    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\r\n\r\n    vec3 ox33 = fract(p33*K) - Ko;\r\n    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\r\n    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\r\n\r\n    vec3 dx11 = Pfx + jitter*ox11;\r\n    vec3 dy11 = Pfy.x + jitter*oy11;\r\n    vec3 dz11 = Pfz.x + jitter*oz11;\r\n\r\n    vec3 dx12 = Pfx + jitter*ox12;\r\n    vec3 dy12 = Pfy.x + jitter*oy12;\r\n    vec3 dz12 = Pfz.y + jitter*oz12;\r\n\r\n    vec3 dx13 = Pfx + jitter*ox13;\r\n    vec3 dy13 = Pfy.x + jitter*oy13;\r\n    vec3 dz13 = Pfz.z + jitter*oz13;\r\n\r\n    vec3 dx21 = Pfx + jitter*ox21;\r\n    vec3 dy21 = Pfy.y + jitter*oy21;\r\n    vec3 dz21 = Pfz.x + jitter*oz21;\r\n\r\n    vec3 dx22 = Pfx + jitter*ox22;\r\n    vec3 dy22 = Pfy.y + jitter*oy22;\r\n    vec3 dz22 = Pfz.y + jitter*oz22;\r\n\r\n    vec3 dx23 = Pfx + jitter*ox23;\r\n    vec3 dy23 = Pfy.y + jitter*oy23;\r\n    vec3 dz23 = Pfz.z + jitter*oz23;\r\n\r\n    vec3 dx31 = Pfx + jitter*ox31;\r\n    vec3 dy31 = Pfy.z + jitter*oy31;\r\n    vec3 dz31 = Pfz.x + jitter*oz31;\r\n\r\n    vec3 dx32 = Pfx + jitter*ox32;\r\n    vec3 dy32 = Pfy.z + jitter*oy32;\r\n    vec3 dz32 = Pfz.y + jitter*oz32;\r\n\r\n    vec3 dx33 = Pfx + jitter*ox33;\r\n    vec3 dy33 = Pfy.z + jitter*oy33;\r\n    vec3 dz33 = Pfz.z + jitter*oz33;\r\n\r\n    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\r\n    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\r\n    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\r\n    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\r\n    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\r\n    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\r\n    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\r\n    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\r\n    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\r\n\r\n    vec3 d1a = min(d11, d12);\r\n    d12 = max(d11, d12);\r\n    d11 = min(d1a, d13); // Smallest now not in d12 or d13\r\n    d13 = max(d1a, d13);\r\n    d12 = min(d12, d13); // 2nd smallest now not in d13\r\n    vec3 d2a = min(d21, d22);\r\n    d22 = max(d21, d22);\r\n    d21 = min(d2a, d23); // Smallest now not in d22 or d23\r\n    d23 = max(d2a, d23);\r\n    d22 = min(d22, d23); // 2nd smallest now not in d23\r\n    vec3 d3a = min(d31, d32);\r\n    d32 = max(d31, d32);\r\n    d31 = min(d3a, d33); // Smallest now not in d32 or d33\r\n    d33 = max(d3a, d33);\r\n    d32 = min(d32, d33); // 2nd smallest now not in d33\r\n    vec3 da = min(d11, d21);\r\n    d21 = max(d11, d21);\r\n    d11 = min(da, d31); // Smallest now in d11\r\n    d31 = max(da, d31); // 2nd smallest now not in d31\r\n    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\r\n    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\r\n    d12 = min(d12, d21); // 2nd smallest now not in d21\r\n    d12 = min(d12, d22); // nor in d22\r\n    d12 = min(d12, d31); // nor in d31\r\n    d12 = min(d12, d32); // nor in d32\r\n    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\r\n    d11.y = min(d11.y,d12.z); // Only two more to go\r\n    d11.y = min(d11.y,d11.z); // Done! (Phew!)\r\n    return sqrt(d11.xy); // F1, F2\r\n}\r\n\r\n","// Worley3D");const i=e._getFreeVariableName("worleyTemp");return e.compilationString+=`vec2 ${i} = worley(${this.seed.associatedVariableName}, ${this.jitter.associatedVariableName}, ${this.manhattanDistance});\r\n`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${i};\r\n`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${i}.x;\r\n`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${i}.y;\r\n`),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.manhattanDistance = ${this.manhattanDistance};\r\n`}serialize(){const e=super.serialize();return e.manhattanDistance=this.manhattanDistance,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.manhattanDistance=e.manhattanDistance}}E([_t("Use Manhattan Distance",lt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],iz.prototype,"manhattanDistance",void 0),le("BABYLON.WorleyNoise3DBlock",iz),le("BABYLON.SimplexPerlin3DBlock",class bae extends De{constructor(e){super(e,B.Neutral),this.registerInput("seed",R.Vector3),this.registerOutput("output",R.Float)}getClassName(){return"SimplexPerlin3DBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;let t="const float SKEWFACTOR = 1.0/3.0;\r\n";return t+="const float UNSKEWFACTOR = 1.0/6.0;\r\n",t+="const float SIMPLEX_CORNER_POS = 0.5;\r\n",t+="const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\r\n",t+="float SimplexPerlin3D( vec3 P ){\r\n",t+="    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\r\n",t+="    P *= SIMPLEX_TETRAHADRON_HEIGHT;\r\n",t+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",t+="    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\r\n",t+="    vec3 g = step(x0.yzx, x0.xyz);\r\n",t+="    vec3 l = 1.0 - g;\r\n",t+="    vec3 Pi_1 = min( g.xyz, l.zxy );\r\n",t+="    vec3 Pi_2 = max( g.xyz, l.zxy );\r\n",t+="    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\r\n",t+="    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\r\n",t+="    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\r\n",t+="    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\r\n",t+="    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\r\n",t+="    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\r\n",t+="    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\r\n",t+="    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\r\n",t+="    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\r\n",t+="    Pt *= Pt;\r\n",t+="    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\r\n",t+="    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\r\n",t+="    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\r\n",t+="    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\r\n",t+="    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\r\n",t+="    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\r\n",t+="    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\r\n",t+="    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\r\n",t+="    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\r\n",t+="    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\r\n",t+="    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\r\n",t+="    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\r\n",t+="    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\r\n",t+="    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\r\n",t+="    kernel_weights = max(0.5 - kernel_weights, 0.0);\r\n",t+="    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\r\n",t+="    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\r\n",t+="}\r\n",e._emitFunction("SimplexPerlin3D","const float SKEWFACTOR = 1.0/3.0;\r\nconst float UNSKEWFACTOR = 1.0/6.0;\r\nconst float SIMPLEX_CORNER_POS = 0.5;\r\nconst float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\r\nfloat SimplexPerlin3D( vec3 P ){\r\n    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\r\n    P *= SIMPLEX_TETRAHADRON_HEIGHT;\r\n    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\r\n    vec3 g = step(x0.yzx, x0.xyz);\r\n    vec3 l = 1.0 - g;\r\n    vec3 Pi_1 = min( g.xyz, l.zxy );\r\n    vec3 Pi_2 = max( g.xyz, l.zxy );\r\n    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\r\n    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\r\n    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\r\n    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\r\n    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\r\n    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\r\n    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\r\n    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\r\n    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\r\n    Pt *= Pt;\r\n    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\r\n    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\r\n    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\r\n    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\r\n    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\r\n    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\r\n    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\r\n    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\r\n    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\r\n    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\r\n    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\r\n    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\r\n    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\r\n    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\r\n    kernel_weights = max(0.5 - kernel_weights, 0.0);\r\n    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\r\n    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\r\n}\r\n","// SimplexPerlin3D"),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = SimplexPerlin3D(${this.seed.associatedVariableName});\r\n`,this}}),le("BABYLON.NormalBlendBlock",class yae extends De{constructor(e){super(e,B.Neutral),this.registerInput("normalMap0",R.AutoDetect),this.registerInput("normalMap1",R.AutoDetect),this.registerOutput("output",R.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(R.Color3|R.Color4|R.Vector3|R.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(R.Color3|R.Color4|R.Vector3|R.Vector4)}getClassName(){return"NormalBlendBlock"}get normalMap0(){return this._inputs[0]}get normalMap1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0],s=this._inputs[1],n=e._getFreeVariableName("stepR"),o=e._getFreeVariableName("stepG");return e.compilationString+=`float ${n} = step(0.5, ${i.associatedVariableName}.r);\r\n`,e.compilationString+=`float ${o} = step(0.5, ${i.associatedVariableName}.g);\r\n`,e.compilationString+=this._declareOutput(t,e)+";\r\n",e.compilationString+=`${t.associatedVariableName}.r = (1.0 - ${n}) * ${i.associatedVariableName}.r * ${s.associatedVariableName}.r * 2.0 + ${n} * (1.0 - (1.0 - ${i.associatedVariableName}.r) * (1.0 - ${s.associatedVariableName}.r) * 2.0);\r\n`,e.compilationString+=`${t.associatedVariableName}.g = (1.0 - ${o}) * ${i.associatedVariableName}.g * ${s.associatedVariableName}.g * 2.0 + ${o} * (1.0 - (1.0 - ${i.associatedVariableName}.g) * (1.0 - ${s.associatedVariableName}.g) * 2.0);\r\n`,e.compilationString+=`${t.associatedVariableName}.b = ${i.associatedVariableName}.b * ${s.associatedVariableName}.b;\r\n`,this}}),le("BABYLON.Rotate2dBlock",class xae extends De{constructor(e){super(e,B.Neutral),this.registerInput("input",R.Vector2),this.registerInput("angle",R.Float),this.registerOutput("output",R.Vector2)}getClassName(){return"Rotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new et("angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e);const i=this.angle,s=this.input;return e.compilationString+=this._declareOutput(this._outputs[0],e)+` = vec2(cos(${i.associatedVariableName}) * ${s.associatedVariableName}.x - sin(${i.associatedVariableName}) * ${s.associatedVariableName}.y, sin(${i.associatedVariableName}) * ${s.associatedVariableName}.x + cos(${i.associatedVariableName}) * ${s.associatedVariableName}.y);\r\n`,this}}),le("BABYLON.ReflectBlock",class Tae extends De{constructor(e){super(e,B.Neutral),this.registerInput("incident",R.AutoDetect),this.registerInput("normal",R.AutoDetect),this.registerOutput("output",R.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(R.Vector3|R.Vector4|R.Color3|R.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(R.Vector3|R.Vector4|R.Color3|R.Color4)}getClassName(){return"ReflectBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = reflect(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz);\r\n`,this}}),le("BABYLON.RefractBlock",class Sae extends De{constructor(e){super(e,B.Neutral),this.registerInput("incident",R.AutoDetect),this.registerInput("normal",R.AutoDetect),this.registerInput("ior",R.Float),this.registerOutput("output",R.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(R.Vector3|R.Vector4|R.Color3|R.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(R.Vector3|R.Vector4|R.Color3|R.Color4)}getClassName(){return"RefractBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get ior(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = refract(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz, ${this.ior.associatedVariableName});\r\n`,this}}),le("BABYLON.DesaturateBlock",class Eae extends De{constructor(e){super(e,B.Neutral),this.registerInput("color",R.Color3),this.registerInput("level",R.Float),this.registerOutput("output",R.Color3)}getClassName(){return"DesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],s=this.color.associatedVariableName,n=e._getFreeVariableName("colorMin"),o=e._getFreeVariableName("colorMax"),a=e._getFreeVariableName("colorMerge");return e.compilationString+=`float ${n} = min(min(${s}.x, ${s}.y), ${s}.z);\r\n`,e.compilationString+=`float ${o} = max(max(${s}.x, ${s}.y), ${s}.z);\r\n`,e.compilationString+=`float ${a} = 0.5 * (${n} + ${o});\r\n`,e.compilationString+=this._declareOutput(t,e)+` = mix(${s}, vec3(${a}, ${a}, ${a}), ${this.level.associatedVariableName});\r\n`,this}});class hd extends De{constructor(e){super(e,B.Fragment),this.albedoScaling=!1,this.linkSheenWithAlbedo=!1,this._isUnique=!0,this.registerInput("intensity",R.Float,!0,B.Fragment),this.registerInput("color",R.Color3,!0,B.Fragment),this.registerInput("roughness",R.Float,!0,B.Fragment),this.registerOutput("sheen",R.Object,B.Fragment,new Qi("sheen",this,Ei.Output,hd,"SheenBlock"))}initialize(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")}getClassName(){return"SheenBlock"}get intensity(){return this._inputs[0]}get color(){return this._inputs[1]}get roughness(){return this._inputs[2]}get sheen(){return this._outputs[0]}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("SHEEN",!0),i.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),i.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),i.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)}getCode(e){let t="";return t=`#ifdef SHEEN\n            sheenOutParams sheenOut;\n\n            vec4 vSheenColor = vec4(${this.color.isConnected?this.color.associatedVariableName:"vec3(1.)"}, ${this.intensity.isConnected?this.intensity.associatedVariableName:"1."});\n\n            sheenBlock(\n                vSheenColor,\n            #ifdef SHEEN_ROUGHNESS\n                ${this.roughness.isConnected?this.roughness.associatedVariableName:"0."},\n            #endif\n                roughness,\n            #ifdef SHEEN_TEXTURE\n                vec4(0.),\n                1.0,\n            #endif\n                reflectance,\n            #ifdef SHEEN_LINKWITHALBEDO\n                baseColor,\n                surfaceAlbedo,\n            #endif\n            #ifdef ENVIRONMENTBRDF\n                NdotV,\n                environmentBrdf,\n            #endif\n            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n                AARoughnessFactors,\n                ${e?._vReflectionMicrosurfaceInfosName},\n                ${e?._vReflectionInfosName},\n                ${e?.reflectionColor},\n                vLightingIntensity,\n                #ifdef ${e?._define3DName}\n                    ${e?._cubeSamplerName},\n                #else\n                    ${e?._2DSamplerName},\n                #endif\n                reflectionOut.reflectionCoords,\n                NdotVUnclamped,\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${e?._define3DName}\n                        ${e?._cubeSamplerName},\n                        ${e?._cubeSamplerName},\n                    #else\n                        ${e?._2DSamplerName},\n                        ${e?._2DSamplerName},\n                    #endif\n                #endif\n                #if !defined(${e?._defineSkyboxName}) && defined(RADIANCEOCCLUSION)\n                    seo,\n                #endif\n                #if !defined(${e?._defineSkyboxName}) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(${e?._define3DName})\n                    eho,\n                #endif\n            #endif\n                sheenOut\n            );\n\n            #ifdef SHEEN_LINKWITHALBEDO\n                surfaceAlbedo = sheenOut.surfaceAlbedo;\n            #endif\n        #endif\r\n`,t}_buildBlock(e){return e.target===B.Fragment&&e.sharedData.blocksWithDefines.push(this),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.albedoScaling = ${this.albedoScaling};\r\n`,e+=`${this._codeVariableName}.linkSheenWithAlbedo = ${this.linkSheenWithAlbedo};\r\n`,e}serialize(){const e=super.serialize();return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo}}E([_t("Albedo scaling",lt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],hd.prototype,"albedoScaling",void 0),E([_t("Link sheen with albedo",lt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],hd.prototype,"linkSheenWithAlbedo",void 0),le("BABYLON.SheenBlock",hd);class db extends De{constructor(e){super(e,B.Fragment),this._tangentCorrectionFactorName="",this._isUnique=!0,this.registerInput("intensity",R.Float,!0,B.Fragment),this.registerInput("direction",R.Vector2,!0,B.Fragment),this.registerInput("uv",R.Vector2,!0),this.registerInput("worldTangent",R.Vector4,!0),this.registerInput("TBN",R.Object,!0,B.VertexAndFragment,new Qi("TBN",this,Ei.Input,cd,"TBNBlock")),this.registerOutput("anisotropy",R.Object,B.Fragment,new Qi("anisotropy",this,Ei.Output,db,"AnisotropyBlock"))}initialize(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")}getClassName(){return"AnisotropyBlock"}get intensity(){return this._inputs[0]}get direction(){return this._inputs[1]}get uv(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get TBN(){return this._inputs[4]}get anisotropy(){return this._outputs[0]}_generateTBNSpace(e){let t="";const i=`//${this.name}`,s=this.uv,n=this.worldPositionConnectionPoint,o=this.worldNormalConnectionPoint,a=this.worldTangent;s.isConnected||console.error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const l={search:/defined\(TANGENT\)/g,replace:a.isConnected?"defined(TANGENT)":"defined(IGNORE)"},c=this.TBN;return c.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${c.associatedVariableName};\n            #endif\n            `:a.isConnected&&(t+=`vec3 tbnNormal = normalize(${o.associatedVariableName}.xyz);\r\n`,t+=`vec3 tbnTangent = normalize(${a.associatedVariableName}.xyz);\r\n`,t+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\r\n`,t+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r\n"),t+=`\n            #if defined(${a.isConnected?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                mat3 TBN = vTBN;\n            #else\n                mat3 TBN = cotangent_frame(${o.associatedVariableName+".xyz"}, ${"v_"+n.associatedVariableName+".xyz"}, ${s.isConnected?s.associatedVariableName:"vec2(0.)"}, vec2(1., 1.));\n            #endif\r\n`,e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[l]}),t}getCode(e,t=!1){let i="";return t&&(i+=this._generateTBNSpace(e)),i+=`anisotropicOutParams anisotropicOut;\n            anisotropicBlock(\n                vec3(${this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)"}, ${this.intensity.isConnected?this.intensity.associatedVariableName:"1.0"}),\n            #ifdef ANISOTROPIC_TEXTURE\n                vec3(0.),\n            #endif\n                TBN,\n                normalW,\n                viewDirectionW,\n                anisotropicOut\n            );\r\n`,i}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("ANISOTROPIC",!0),i.setValue("ANISOTROPIC_TEXTURE",!1,!0)}bind(e,t,i){super.bind(e,t,i),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_buildBlock(e){return e.target===B.Fragment&&(e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float")),this}}le("BABYLON.AnisotropyBlock",db);class ud extends Wp{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The position input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?B.Fragment:B.Vertex,this.generateOnlyFragmentCode&&(this.forceIrradianceInFragment=!0)}constructor(e){super(e),this.useSphericalHarmonics=!0,this.forceIrradianceInFragment=!1,this._isUnique=!0,this.registerInput("position",R.AutoDetect,!1,B.Vertex),this.registerInput("world",R.Matrix,!1,B.Vertex),this.registerInput("color",R.Color3,!0,B.Fragment),this.registerOutput("reflection",R.Object,B.Fragment,new Qi("reflection",this,Ei.Output,ud,"ReflectionBlock")),this.position.addExcludedConnectionPointFromAllowedTypes(R.Color3|R.Vector3|R.Vector4)}getClassName(){return"ReflectionBlock"}get position(){return this._inputs[0]}get worldPosition(){return this.worldPositionConnectionPoint}get worldNormal(){return this.worldNormalConnectionPoint}get world(){return this._inputs[1]}get cameraPosition(){return this.cameraPositionConnectionPoint}get view(){return this.viewConnectionPoint}get color(){return this._inputs[2]}get reflection(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}get reflectionColor(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const s=this._getTexture(),n=s&&s.getTextureMatrix;i.setValue("REFLECTION",n,!0),n&&(i.setValue(this._defineLODReflectionAlpha,s.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularReflection,s.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!s.invertZ:s.invertZ,!0),i.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),i.setValue("GAMMAREFLECTION",s.gammaSpace,!0),i.setValue("RGBDREFLECTION",s.isRGBD,!0),s&&s.coordinatesMode!==U.SKYBOX_MODE&&s.isCube&&(i.setValue("USESPHERICALFROMREFLECTIONMAP",!0),i.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?i.setValue("USESPHERICALINVERTEX",!1):i.setValue("USESPHERICALINVERTEX",!0)))}bind(e,t,i,s){super.bind(e,t,i);const n=this._getTexture();if(!n||!s)return;e.setTexture(n.isCube?this._cubeSamplerName:this._2DSamplerName,n);const o=n.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,o,n.lodGenerationScale,n.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,o,oe.Log2(o));const a=s.materialDefines,l=n.sphericalPolynomial;if(a.USESPHERICALFROMREFLECTIONMAP&&l)if(a.SPHERICAL_HARMONICS){const c=l.preScaledHarmonics;e.setVector3("vSphericalL00",c.l00),e.setVector3("vSphericalL1_1",c.l1_1),e.setVector3("vSphericalL10",c.l10),e.setVector3("vSphericalL11",c.l11),e.setVector3("vSphericalL2_2",c.l2_2),e.setVector3("vSphericalL2_1",c.l2_1),e.setVector3("vSphericalL20",c.l20),e.setVector3("vSphericalL21",c.l21),e.setVector3("vSphericalL22",c.l22)}else e.setFloat3("vSphericalX",l.x.x,l.x.y,l.x.z),e.setFloat3("vSphericalY",l.y.x,l.y.y,l.y.z),e.setFloat3("vSphericalZ",l.z.x,l.z.y,l.z.z),e.setFloat3("vSphericalXX_ZZ",l.xx.x-l.zz.x,l.xx.y-l.zz.y,l.xx.z-l.zz.z),e.setFloat3("vSphericalYY_ZZ",l.yy.x-l.zz.x,l.yy.y-l.zz.y,l.yy.z-l.zz.z),e.setFloat3("vSphericalZZ",l.zz.x,l.zz.y,l.zz.z),e.setFloat3("vSphericalXY",l.xy.x,l.xy.y,l.xy.z),e.setFloat3("vSphericalYZ",l.yz.x,l.yz.y,l.yz.z),e.setFloat3("vSphericalZX",l.zx.x,l.zx.y,l.zx.z)}handleVertexSide(e){let t=super.handleVertexSide(e);e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});const i=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,"vec3","defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX","vec3","SPHERICAL_HARMONICS",!0),t+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n                vec3 ${i} = vec3(${this._reflectionMatrixName} * vec4(normalize(${this.worldNormal.associatedVariableName}).xyz, 0)).xyz;\n                #ifdef ${this._defineOppositeZ}\n                    ${i}.z *= -1.0;\n                #endif\n                ${this._vEnvironmentIrradianceName} = computeEnvironmentIrradiance(${i});\n            #endif\r\n`,t}getCode(e,t){let i="";this.handleFragmentSideInits(e),e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),e._emitFunction("sampleReflection",`\n            #ifdef ${this._define3DName}\n                #define sampleReflection(s, c) textureCube(s, c)\n            #else\n                #define sampleReflection(s, c) texture2D(s, c)\n            #endif\r\n`,`//${this.name}`),e._emitFunction("sampleReflectionLod",`\n            #ifdef ${this._define3DName}\n                #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)\n            #else\n                #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)\n            #endif\r\n`,`//${this.name}`);const s=`\n            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {\n                ${this.handleFragmentSideCodeReflectionCoords("worldNormal","worldPos",!0,!0)}\n                return ${this._reflectionVectorName};\n            }\r\n`;return e._emitFunction("computeReflectionCoordsPBR",s,`//${this.name}`),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,"vec3"),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,"vec2"),i+=`#ifdef REFLECTION\n            vec2 ${this._vReflectionInfosName} = vec2(1., 0.);\n\n            reflectionOutParams reflectionOut;\n\n            reflectionBlock(\n                ${this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName}.xyz,\n                ${t},\n                alphaG,\n                ${this._vReflectionMicrosurfaceInfosName},\n                ${this._vReflectionInfosName},\n                ${this.reflectionColor},\n            #ifdef ANISOTROPIC\n                anisotropicOut,\n            #endif\n            #if defined(${this._defineLODReflectionAlpha}) && !defined(${this._defineSkyboxName})\n                NdotVUnclamped,\n            #endif\n            #ifdef ${this._defineLinearSpecularReflection}\n                roughness,\n            #endif\n            #ifdef ${this._define3DName}\n                ${this._cubeSamplerName},\n            #else\n                ${this._2DSamplerName},\n            #endif\n            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n                ${this._vEnvironmentIrradianceName},\n            #endif\n            #ifdef USESPHERICALFROMREFLECTIONMAP\n                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n                    ${this._reflectionMatrixName},\n                #endif\n            #endif\n            #ifdef USEIRRADIANCEMAP\n                irradianceSampler, // ** not handled **\n            #endif\n            #ifndef LODBASEDMICROSFURACE\n                #ifdef ${this._define3DName}\n                    ${this._cubeSamplerName},\n                    ${this._cubeSamplerName},\n                #else\n                    ${this._2DSamplerName},\n                    ${this._2DSamplerName},\n                #endif\n            #endif\n            #ifdef REALTIME_FILTERING\n                ${this._vReflectionFilteringInfoName},\n            #endif\n                reflectionOut\n            );\n        #endif\r\n`,i}_buildBlock(e){return this._scene=e.sharedData.scene,e.target!==B.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture.gammaSpace = ${this.texture.gammaSpace};\r\n`),e+=`${this._codeVariableName}.useSphericalHarmonics = ${this.useSphericalHarmonics};\r\n`,e+=`${this._codeVariableName}.forceIrradianceInFragment = ${this.forceIrradianceInFragment};\r\n`,e}serialize(){var e,t;const i=super.serialize();return i.useSphericalHarmonics=this.useSphericalHarmonics,i.forceIrradianceInFragment=this.forceIrradianceInFragment,i.gammaSpace=null===(t=null===(e=this.texture)||void 0===e?void 0:e.gammaSpace)||void 0===t||t,i}_deserialize(e,t,i){super._deserialize(e,t,i),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)}}E([_t("Spherical Harmonics",lt.Boolean,"ADVANCED",{notifiers:{update:!0}})],ud.prototype,"useSphericalHarmonics",void 0),E([_t("Force irradiance in fragment",lt.Boolean,"ADVANCED",{notifiers:{update:!0}})],ud.prototype,"forceIrradianceInFragment",void 0),le("BABYLON.ReflectionBlock",ud);class dd extends De{constructor(e){super(e,B.Fragment),this._tangentCorrectionFactorName="",this.remapF0OnInterfaceChange=!0,this._isUnique=!0,this.registerInput("intensity",R.Float,!1,B.Fragment),this.registerInput("roughness",R.Float,!0,B.Fragment),this.registerInput("indexOfRefraction",R.Float,!0,B.Fragment),this.registerInput("normalMapColor",R.Color3,!0,B.Fragment),this.registerInput("uv",R.Vector2,!0,B.Fragment),this.registerInput("tintColor",R.Color3,!0,B.Fragment),this.registerInput("tintAtDistance",R.Float,!0,B.Fragment),this.registerInput("tintThickness",R.Float,!0,B.Fragment),this.registerInput("worldTangent",R.Vector4,!0),this.registerInput("worldNormal",R.AutoDetect,!0),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(R.Color4|R.Vector4|R.Vector3),this.registerInput("TBN",R.Object,!0,B.VertexAndFragment,new Qi("TBN",this,Ei.Input,cd,"TBNBlock")),this.registerOutput("clearcoat",R.Object,B.Fragment,new Qi("clearcoat",this,Ei.Output,dd,"ClearCoatBlock"))}initialize(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams"),e._excludeVariableName("vGeometricNormaClearCoatW")}getClassName(){return"ClearCoatBlock"}get intensity(){return this._inputs[0]}get roughness(){return this._inputs[1]}get indexOfRefraction(){return this._inputs[2]}get normalMapColor(){return this._inputs[3]}get uv(){return this._inputs[4]}get tintColor(){return this._inputs[5]}get tintAtDistance(){return this._inputs[6]}get tintThickness(){return this._inputs[7]}get worldTangent(){return this._inputs[8]}get worldNormal(){return this._inputs[9]}get TBN(){return this._inputs[10]}get clearcoat(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new et("ClearCoat intensity",B.Fragment,R.Float);e.value=1,e.output.connectTo(this.intensity)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("CLEARCOAT",!0),i.setValue("CLEARCOAT_TEXTURE",!1,!0),i.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),i.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),i.setValue("CLEARCOAT_DEFAULTIOR",!this.indexOfRefraction.isConnected||this.indexOfRefraction.connectInputBlock.value===Cs._DefaultIndexOfRefraction,!0),i.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)}bind(e,t,i){var s,n;super.bind(e,t,i);const o=null!==(n=null===(s=this.indexOfRefraction.connectInputBlock)||void 0===s?void 0:s.value)&&void 0!==n?n:Cs._DefaultIndexOfRefraction,a=1-o,l=1+o,c=Math.pow(-a/l,2);e.setFloat4("vClearCoatRefractionParams",c,1/o,a,l);const u=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,d=u?.perturbedNormal.isConnected?u.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",d?.invertX?1:-1,d?.invertY?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",d?.invertX?-1:1,d?.invertY?-1:1),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_generateTBNSpace(e,t,i){let s="";const n=`//${this.name}`,o=this.worldTangent;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const a={search:/defined\(TANGENT\)/g,replace:o.isConnected?"defined(TANGENT)":"defined(IGNORE)"},l=this.TBN;return l.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${l.associatedVariableName};\n            #endif\n            `:o.isConnected&&(s+=`vec3 tbnNormal = normalize(${i}.xyz);\r\n`,s+=`vec3 tbnTangent = normalize(${o.associatedVariableName}.xyz);\r\n`,s+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\r\n`,s+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r\n"),e._emitFunctionFromInclude("bumpFragmentMainFunctions",n,{replaceStrings:[a]}),s}static GetCode(e,t,i,s,n,o,a){let l="";const c=t?.intensity.isConnected?t.intensity.associatedVariableName:"1.",h=t?.roughness.isConnected?t.roughness.associatedVariableName:"0.",u=t?.normalMapColor.isConnected?t.normalMapColor.associatedVariableName:"vec3(0.)",d=t?.uv.isConnected?t.uv.associatedVariableName:"vec2(0.)",f=t?.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",p=t?.tintThickness.isConnected?t.tintThickness.associatedVariableName:"1.",_=t?.tintAtDistance.isConnected?t.tintAtDistance.associatedVariableName:"1.";if(t){e._emitUniformFromString("vClearCoatRefractionParams","vec4"),e._emitUniformFromString("vClearCoatTangentSpaceParams","vec2");const g=t.worldNormal;l+=`vec3 vGeometricNormaClearCoatW = ${g.isConnected?"normalize("+g.associatedVariableName+".xyz)":"geometricNormalW"};\r\n`}else l+="vec3 vGeometricNormaClearCoatW = geometricNormalW;\r\n";return n&&t&&(l+=t._generateTBNSpace(e,s,a),o=t.worldTangent.isConnected),l+=`clearcoatOutParams clearcoatOut;\n\n        #ifdef CLEARCOAT\n            vec2 vClearCoatParams = vec2(${c}, ${h});\n            vec4 vClearCoatTintParams = vec4(${f}, ${p});\n\n            clearcoatBlock(\n                ${s}.xyz,\n                vGeometricNormaClearCoatW,\n                viewDirectionW,\n                vClearCoatParams,\n                specularEnvironmentR0,\n            #ifdef CLEARCOAT_TEXTURE\n                vec2(0.),\n            #endif\n            #ifdef CLEARCOAT_TINT\n                vClearCoatTintParams,\n                ${_},\n                vClearCoatRefractionParams,\n                #ifdef CLEARCOAT_TINT_TEXTURE\n                    vec4(0.),\n                #endif\n            #endif\n            #ifdef CLEARCOAT_BUMP\n                vec2(0., 1.),\n                vec4(${u}, 0.),\n                ${d},\n                #if defined(${o?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                    vTBN,\n                #else\n                    vClearCoatTangentSpaceParams,\n                #endif\n                #ifdef OBJECTSPACE_NORMALMAP\n                    normalMatrix,\n                #endif\n            #endif\n            #if defined(FORCENORMALFORWARD) && defined(NORMAL)\n                faceNormal,\n            #endif\n            #ifdef REFLECTION\n                ${i?._vReflectionMicrosurfaceInfosName},\n                ${i?._vReflectionInfosName},\n                ${i?.reflectionColor},\n                vLightingIntensity,\n                #ifdef ${i?._define3DName}\n                    ${i?._cubeSamplerName},\n                #else\n                    ${i?._2DSamplerName},\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${i?._define3DName}\n                        ${i?._cubeSamplerName},\n                        ${i?._cubeSamplerName},\n                    #else\n                        ${i?._2DSamplerName},\n                        ${i?._2DSamplerName},\n                    #endif\n                #endif\n            #endif\n            #if defined(ENVIRONMENTBRDF) && !defined(${i?._defineSkyboxName})\n                #ifdef RADIANCEOCCLUSION\n                    ambientMonochrome,\n                #endif\n            #endif\n            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n                (gl_FrontFacing ? 1. : -1.),\n            #endif\n                clearcoatOut\n            );\n        #else\n            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;\n        #endif\r\n`,l}_buildBlock(e){return this._scene=e.sharedData.scene,e.target===B.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.remapF0OnInterfaceChange = ${this.remapF0OnInterfaceChange};\r\n`,e}serialize(){const e=super.serialize();return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.remapF0OnInterfaceChange=null===(s=e.remapF0OnInterfaceChange)||void 0===s||s}}E([_t("Remap F0 on interface change",lt.Boolean,"ADVANCED")],dd.prototype,"remapF0OnInterfaceChange",void 0),le("BABYLON.ClearCoatBlock",dd);class Xp extends De{constructor(e){super(e,B.Fragment),this._isUnique=!0,this.registerInput("intensity",R.Float,!0,B.Fragment),this.registerInput("indexOfRefraction",R.Float,!0,B.Fragment),this.registerInput("thickness",R.Float,!0,B.Fragment),this.registerOutput("iridescence",R.Object,B.Fragment,new Qi("iridescence",this,Ei.Output,Xp,"IridescenceBlock"))}initialize(e){e._excludeVariableName("iridescenceOut"),e._excludeVariableName("vIridescenceParams")}getClassName(){return"IridescenceBlock"}get intensity(){return this._inputs[0]}get indexOfRefraction(){return this._inputs[1]}get thickness(){return this._inputs[2]}get iridescence(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new et("Iridescence intensity",B.Fragment,R.Float);e.value=1,e.output.connectTo(this.intensity);const t=new et("Iridescence ior",B.Fragment,R.Float);t.value=1.3,t.output.connectTo(this.indexOfRefraction);const i=new et("Iridescence thickness",B.Fragment,R.Float);i.value=400,i.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("IRIDESCENCE",!0,!0),i.setValue("IRIDESCENCE_TEXTURE",!1,!0),i.setValue("IRIDESCENCE_THICKNESS_TEXTURE",!1,!0)}static GetCode(e){let t="";return t+=`iridescenceOutParams iridescenceOut;\n\n        #ifdef IRIDESCENCE\n            iridescenceBlock(\n                vec4(${e?.intensity.isConnected?e.intensity.associatedVariableName:"1."}, ${e?.indexOfRefraction.isConnected?e.indexOfRefraction.associatedVariableName:xr._DefaultIndexOfRefraction}, 1., ${e?.thickness.isConnected?e.thickness.associatedVariableName:xr._DefaultMaximumThickness}),\n                NdotV,\n                specularEnvironmentR0,\n                #ifdef CLEARCOAT\n                    NdotVUnclamped,\n                #endif\n                iridescenceOut\n            );\n\n            float iridescenceIntensity = iridescenceOut.iridescenceIntensity;\n            specularEnvironmentR0 = iridescenceOut.specularEnvironmentR0;\n        #endif\r\n`,t}_buildBlock(e){return e.target===B.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this}serialize(){return super.serialize()}_deserialize(e,t,i){super._deserialize(e,t,i)}}le("BABYLON.IridescenceBlock",Xp);class Mh extends De{constructor(e){super(e,B.Fragment),this.linkRefractionWithTransparency=!1,this.invertRefractionY=!1,this.useThicknessAsDepth=!1,this._isUnique=!0,this.registerInput("intensity",R.Float,!1,B.Fragment),this.registerInput("tintAtDistance",R.Float,!0,B.Fragment),this.registerInput("volumeIndexOfRefraction",R.Float,!0,B.Fragment),this.registerOutput("refraction",R.Object,B.Fragment,new Qi("refraction",this,Ei.Output,Mh,"RefractionBlock"))}initialize(e){e._excludeVariableName("vRefractionPosition"),e._excludeVariableName("vRefractionSize")}getClassName(){return"RefractionBlock"}get intensity(){return this._inputs[0]}get tintAtDistance(){return this._inputs[1]}get volumeIndexOfRefraction(){return this._inputs[2]}get view(){return this.viewConnectionPoint}get refraction(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}autoConfigure(e){if(!this.intensity.isConnected){const t=new et("Refraction intensity",B.Fragment,R.Float);t.value=1,t.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===it.View);t||(t=new et("view"),t.setAsSystemValue(it.View)),t.output.connectTo(this.view)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const s=this._getTexture(),n=s&&s.getTextureMatrix;i.setValue("SS_REFRACTION",n,!0),n&&(i.setValue(this._define3DName,s.isCube,!0),i.setValue(this._defineLODRefractionAlpha,s.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularRefraction,s.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!s.invertZ:s.invertZ,!0),i.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),i.setValue("SS_GAMMAREFRACTION",s.gammaSpace,!0),i.setValue("SS_RGBDREFRACTION",s.isRGBD,!0),i.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!s.boundingBoxSize,!0),i.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){var s,n,o,a;super.bind(e,t,i);const l=this._getTexture();if(!l)return;e.setTexture(l.isCube?this._cubeSamplerName:this._2DSamplerName,l),e.setMatrix(this._refractionMatrixName,l.getReflectionTextureMatrix());let c=1;l.isCube||l.depth&&(c=l.depth);const h=null!==(a=null!==(n=null===(s=this.volumeIndexOfRefraction.connectInputBlock)||void 0===s?void 0:s.value)&&void 0!==n?n:null===(o=this.indexOfRefractionConnectionPoint.connectInputBlock)||void 0===o?void 0:o.value)&&void 0!==a?a:1.5;e.setFloat4(this._vRefractionInfosName,l.level,1/h,c,this.invertRefractionY?-1:1),e.setFloat4(this._vRefractionMicrosurfaceInfosName,l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset,1/h);const u=l.getSize().width;if(e.setFloat2(this._vRefractionFilteringInfoName,u,oe.Log2(u)),l.boundingBoxSize){const d=l;e.setVector3("vRefractionPosition",d.boundingBoxPosition),e.setVector3("vRefractionSize",d.boundingBoxSize)}}getCode(e){return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),e._samplerDeclaration+=`#ifdef ${this._define3DName}\r\n`,e._samplerDeclaration+=`uniform samplerCube ${this._cubeSamplerName};\r\n`,e._samplerDeclaration+="#else\r\n",e._samplerDeclaration+=`uniform sampler2D ${this._2DSamplerName};\r\n`,e._samplerDeclaration+="#endif\r\n",e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,"mat4"),e._emitFunction("sampleRefraction",`\n            #ifdef ${this._define3DName}\n                #define sampleRefraction(s, c) textureCube(s, c)\n            #else\n                #define sampleRefraction(s, c) texture2D(s, c)\n            #endif\r\n`,`//${this.name}`),e._emitFunction("sampleRefractionLod",`\n            #ifdef ${this._define3DName}\n                #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)\n            #else\n                #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)\n            #endif\r\n`,`//${this.name}`),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,"vec4"),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,"vec4"),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,"vec2"),e._emitUniformFromString("vRefractionPosition","vec3"),e._emitUniformFromString("vRefractionSize","vec3"),""}_buildBlock(e){return this._scene=e.sharedData.scene,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e=this.texture.isCube?`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}");\r\n`:`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}");\r\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r\n`),e+=`${this._codeVariableName}.linkRefractionWithTransparency = ${this.linkRefractionWithTransparency};\r\n`,e+=`${this._codeVariableName}.invertRefractionY = ${this.invertRefractionY};\r\n`,e+=`${this._codeVariableName}.useThicknessAsDepth = ${this.useThicknessAsDepth};\r\n`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e.useThicknessAsDepth=this.useThicknessAsDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=e.texture.isCube?os.Parse(e.texture,t,i):U.Parse(e.texture,t,i)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY,this.useThicknessAsDepth=!!e.useThicknessAsDepth}}E([_t("Link refraction to transparency",lt.Boolean,"ADVANCED",{notifiers:{update:!0}})],Mh.prototype,"linkRefractionWithTransparency",void 0),E([_t("Invert refraction Y",lt.Boolean,"ADVANCED",{notifiers:{update:!0}})],Mh.prototype,"invertRefractionY",void 0),E([_t("Use thickness as depth",lt.Boolean,"ADVANCED",{notifiers:{update:!0}})],Mh.prototype,"useThicknessAsDepth",void 0),le("BABYLON.RefractionBlock",Mh);class jp extends De{constructor(e){super(e,B.Fragment),this._isUnique=!0,this.registerInput("thickness",R.Float,!1,B.Fragment),this.registerInput("tintColor",R.Color3,!0,B.Fragment),this.registerInput("translucencyIntensity",R.Float,!0,B.Fragment),this.registerInput("translucencyDiffusionDist",R.Color3,!0,B.Fragment),this.registerInput("refraction",R.Object,!0,B.Fragment,new Qi("refraction",this,Ei.Input,Mh,"RefractionBlock")),this.registerOutput("subsurface",R.Object,B.Fragment,new Qi("subsurface",this,Ei.Output,jp,"SubSurfaceBlock"))}initialize(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vSubSurfaceIntensity")}getClassName(){return"SubSurfaceBlock"}get thickness(){return this._inputs[0]}get tintColor(){return this._inputs[1]}get translucencyIntensity(){return this._inputs[2]}get translucencyDiffusionDist(){return this._inputs[3]}get refraction(){return this._inputs[4]}get subsurface(){return this._outputs[0]}autoConfigure(){if(!this.thickness.isConnected){const e=new et("SubSurface thickness",B.Fragment,R.Float);e.value=0,e.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const s=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;i.setValue("SUBSURFACE",s||this.refraction.isConnected,!0),i.setValue("SS_TRANSLUCENCY",s,!0),i.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),i.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),i.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),i.setValue("SS_MASK_FROM_THICKNESS_TEXTURE",!1,!0),i.setValue("SS_USE_GLTF_TEXTURES",!1,!0)}static GetCode(e,t,i,s){var n,o,a,l,c,h,u,d,f,p,_,m,g,b,y,T;let x="";const S=t?.thickness.isConnected?t.thickness.associatedVariableName:"0.",C=t?.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",D=t?.translucencyIntensity.isConnected?t?.translucencyIntensity.associatedVariableName:"1.",P=t?.translucencyDiffusionDist.isConnected?t?.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",M=t?.refraction.isConnected?null===(n=t?.refraction.connectedPoint)||void 0===n?void 0:n.ownerBlock:null,w=M?.tintAtDistance.isConnected?M.tintAtDistance.associatedVariableName:"1.",k=M?.intensity.isConnected?M.intensity.associatedVariableName:"1.",X=M?.view.isConnected?M.view.associatedVariableName:"";return x+=null!==(o=M?.getCode(e))&&void 0!==o?o:"",x+=`subSurfaceOutParams subSurfaceOut;\n\n        #ifdef SUBSURFACE\n            vec2 vThicknessParam = vec2(0., ${S});\n            vec4 vTintColor = vec4(${C}, ${w});\n            vec3 vSubSurfaceIntensity = vec3(${k}, ${D}, 0.);\n\n            subSurfaceBlock(\n                vSubSurfaceIntensity,\n                vThicknessParam,\n                vTintColor,\n                normalW,\n                specularEnvironmentReflectance,\n            #ifdef SS_THICKNESSANDMASK_TEXTURE\n                vec4(0.),\n            #endif\n            #ifdef REFLECTION\n                #ifdef SS_TRANSLUCENCY\n                    ${i?._reflectionMatrixName},\n                    #ifdef USESPHERICALFROMREFLECTIONMAP\n                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n                            reflectionOut.irradianceVector,\n                        #endif\n                        #if defined(REALTIME_FILTERING)\n                            ${i?._cubeSamplerName},\n                            ${i?._vReflectionFilteringInfoName},\n                        #endif\n                        #endif\n                    #ifdef USEIRRADIANCEMAP\n                        irradianceSampler,\n                    #endif\n                #endif\n            #endif\n            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n                surfaceAlbedo,\n            #endif\n            #ifdef SS_REFRACTION\n                ${s}.xyz,\n                viewDirectionW,\n                ${X},\n                ${null!==(a=M?._vRefractionInfosName)&&void 0!==a?a:""},\n                ${null!==(l=M?._refractionMatrixName)&&void 0!==l?l:""},\n                ${null!==(c=M?._vRefractionMicrosurfaceInfosName)&&void 0!==c?c:""},\n                vLightingIntensity,\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    alpha,\n                #endif\n                #ifdef ${null!==(h=M?._defineLODRefractionAlpha)&&void 0!==h?h:"IGNORE"}\n                    NdotVUnclamped,\n                #endif\n                #ifdef ${null!==(u=M?._defineLinearSpecularRefraction)&&void 0!==u?u:"IGNORE"}\n                    roughness,\n                #endif\n                alphaG,\n                #ifdef ${null!==(d=M?._define3DName)&&void 0!==d?d:"IGNORE"}\n                    ${null!==(f=M?._cubeSamplerName)&&void 0!==f?f:""},\n                #else\n                    ${null!==(p=M?._2DSamplerName)&&void 0!==p?p:""},\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${null!==(_=M?._define3DName)&&void 0!==_?_:"IGNORE"}\n                        ${null!==(m=M?._cubeSamplerName)&&void 0!==m?m:""},\n                        ${null!==(g=M?._cubeSamplerName)&&void 0!==g?g:""},\n                    #else\n                        ${null!==(b=M?._2DSamplerName)&&void 0!==b?b:""},\n                        ${null!==(y=M?._2DSamplerName)&&void 0!==y?y:""},\n                    #endif\n                #endif\n                #ifdef ANISOTROPIC\n                    anisotropicOut,\n                #endif\n                #ifdef REALTIME_FILTERING\n                    ${null!==(T=M?._vRefractionFilteringInfoName)&&void 0!==T?T:""},\n                #endif\n                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n                    vRefractionPosition,\n                    vRefractionSize,\n                #endif\n            #endif\n            #ifdef SS_TRANSLUCENCY\n                ${P},\n            #endif\n                subSurfaceOut\n            );\n\n            #ifdef SS_REFRACTION\n                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    alpha = subSurfaceOut.alpha;\n                #endif\n            #endif\n        #else\n            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;\n        #endif\r\n`,x}_buildBlock(e){return e.target===B.Fragment&&e.sharedData.blocksWithDefines.push(this),this}}le("BABYLON.SubSurfaceBlock",jp);const Cae={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["shadow",""],alpha:["alpha",""]};class gs extends De{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?B.Fragment:B.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?B.Fragment:B.Vertex}constructor(e){super(e,B.VertexAndFragment),this._environmentBRDFTexture=null,this._metallicReflectanceColor=re.White(),this._metallicF0Factor=1,this.directIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.lightFalloff=0,this.useAlphaTest=!1,this.alphaTestCutoff=.5,this.useAlphaBlending=!1,this.useRadianceOverAlpha=!0,this.useSpecularOverAlpha=!0,this.enableSpecularAntiAliasing=!1,this.realTimeFiltering=!1,this.realTimeFilteringQuality=8,this.useEnergyConservation=!0,this.useRadianceOcclusion=!0,this.useHorizonOcclusion=!0,this.unlit=!1,this.forceNormalForward=!1,this.generateOnlyFragmentCode=!1,this.debugMode=0,this.debugLimit=0,this.debugFactor=1,this._isUnique=!0,this.registerInput("worldPosition",R.Vector4,!1,B.Vertex),this.registerInput("worldNormal",R.Vector4,!1,B.Fragment),this.registerInput("view",R.Matrix,!1),this.registerInput("cameraPosition",R.Vector3,!1,B.Fragment),this.registerInput("perturbedNormal",R.Vector4,!0,B.Fragment),this.registerInput("baseColor",R.Color3,!0,B.Fragment),this.registerInput("metallic",R.Float,!1,B.Fragment),this.registerInput("roughness",R.Float,!1,B.Fragment),this.registerInput("ambientOcc",R.Float,!0,B.Fragment),this.registerInput("opacity",R.Float,!0,B.Fragment),this.registerInput("indexOfRefraction",R.Float,!0,B.Fragment),this.registerInput("ambientColor",R.Color3,!0,B.Fragment),this.registerInput("reflection",R.Object,!0,B.Fragment,new Qi("reflection",this,Ei.Input,ud,"ReflectionBlock")),this.registerInput("clearcoat",R.Object,!0,B.Fragment,new Qi("clearcoat",this,Ei.Input,dd,"ClearCoatBlock")),this.registerInput("sheen",R.Object,!0,B.Fragment,new Qi("sheen",this,Ei.Input,hd,"SheenBlock")),this.registerInput("subsurface",R.Object,!0,B.Fragment,new Qi("subsurface",this,Ei.Input,jp,"SubSurfaceBlock")),this.registerInput("anisotropy",R.Object,!0,B.Fragment,new Qi("anisotropy",this,Ei.Input,db,"AnisotropyBlock")),this.registerInput("iridescence",R.Object,!0,B.Fragment,new Qi("iridescence",this,Ei.Input,Xp,"IridescenceBlock")),this.registerOutput("ambientClr",R.Color3,B.Fragment),this.registerOutput("diffuseDir",R.Color3,B.Fragment),this.registerOutput("specularDir",R.Color3,B.Fragment),this.registerOutput("clearcoatDir",R.Color3,B.Fragment),this.registerOutput("sheenDir",R.Color3,B.Fragment),this.registerOutput("diffuseInd",R.Color3,B.Fragment),this.registerOutput("specularInd",R.Color3,B.Fragment),this.registerOutput("clearcoatInd",R.Color3,B.Fragment),this.registerOutput("sheenInd",R.Color3,B.Fragment),this.registerOutput("refraction",R.Color3,B.Fragment),this.registerOutput("lighting",R.Color3,B.Fragment),this.registerOutput("shadow",R.Float,B.Fragment),this.registerOutput("alpha",R.Float,B.Fragment)}initialize(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode")}getClassName(){return"PBRMetallicRoughnessBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get view(){return this._inputs[2]}get cameraPosition(){return this._inputs[3]}get perturbedNormal(){return this._inputs[4]}get baseColor(){return this._inputs[5]}get metallic(){return this._inputs[6]}get roughness(){return this._inputs[7]}get ambientOcc(){return this._inputs[8]}get opacity(){return this._inputs[9]}get indexOfRefraction(){return this._inputs[10]}get ambientColor(){return this._inputs[11]}get reflection(){return this._inputs[12]}get clearcoat(){return this._inputs[13]}get sheen(){return this._inputs[14]}get subsurface(){return this._inputs[15]}get anisotropy(){return this._inputs[16]}get iridescence(){return this._inputs[17]}get ambientClr(){return this._outputs[0]}get diffuseDir(){return this._outputs[1]}get specularDir(){return this._outputs[2]}get clearcoatDir(){return this._outputs[3]}get sheenDir(){return this._outputs[4]}get diffuseInd(){return this._outputs[5]}get specularInd(){return this._outputs[6]}get clearcoatInd(){return this._outputs[7]}get sheenInd(){return this._outputs[8]}get refraction(){return this._outputs[9]}get lighting(){return this._outputs[10]}get shadow(){return this._outputs[11]}get alpha(){return this._outputs[12]}autoConfigure(e){if(!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===it.CameraPosition);t||(t=new et("cameraPosition"),t.setAsSystemValue(it.CameraPosition)),t.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===it.View);t||(t=new et("view"),t.setAsSystemValue(it.View)),t.output.connectTo(this.view)}}prepareDefines(e,t,i){i.setValue("PBR",!0),i.setValue("METALLICWORKFLOW",!0),i.setValue("DEBUGMODE",this.debugMode,!0),i.setValue("NORMALXYSCALE",!0),i.setValue("BUMP",this.perturbedNormal.isConnected,!0),i.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),i.setValue("ALBEDO",!1,!0),i.setValue("OPACITY",this.opacity.isConnected,!0),i.setValue("AMBIENT",!0,!0),i.setValue("AMBIENTINGRAYSCALE",!1,!0),i.setValue("REFLECTIVITY",!1,!0),i.setValue("AOSTOREINMETALMAPRED",!1,!0),i.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===Vt.LIGHTFALLOFF_STANDARD?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===Vt.LIGHTFALLOFF_GLTF?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!0)):(i.setValue("USEPHYSICALLIGHTFALLOFF",!0),i.setValue("USEGLTFLIGHTFALLOFF",!1));const s=this.alphaTestCutoff.toString();i.setValue("ALPHABLEND",this.useAlphaBlending,!0),i.setValue("ALPHAFROMALBEDO",!1,!0),i.setValue("ALPHATEST",this.useAlphaTest,!0),i.setValue("ALPHATESTVALUE",s.indexOf(".")<0?s+".":s,!0),i.setValue("OPACITYRGB",!1,!0),i.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),i.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),i.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),i.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);const n=e.getScene();if(n.getEngine()._features.needTypeSuffixInShaderConstants?i.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):i.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),i.setValue("BRDF_V_HEIGHT_CORRELATED",!0),i.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),i.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),i.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),i.setValue("UNLIT",this.unlit,!0),i.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&pe.ReflectionTextureEnabled?(i.setValue("ENVIRONMENTBRDF",!0),i.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(i.setValue("ENVIRONMENTBRDF",!1),i.setValue("ENVIRONMENTBRDF_RGBD",!1)),i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i),i._areLightsDirty)if(this.light){const a={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};ce.PrepareDefinesForLight(n,e,this.light,this._lightId,i,!0,a),a.needRebuild&&i.rebuild()}else ce.PrepareDefinesForLights(n,e,i,!0,t.maxSimultaneousLights),i._needNormals=!0,ce.PrepareDefinesForMultiview(n,i)}updateUniformsAndSamples(e,t,i,s){for(let n=0;n<t.maxSimultaneousLights&&i["LIGHT"+n];n++){const o=e.uniforms.indexOf("vLightData"+n)>=0;ce.PrepareUniformsAndSamplersForLight(n,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+n],s,o)}}isReady(e,t,i){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady()||i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}bind(e,t,i){var s,n;if(!i)return;const o=i.getScene();this.light?ce.BindLight(this.light,this._lightId,o,e,!0):ce.BindLights(o,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);const a=this._scene.ambientColor;a&&e.setColor3("ambientFromScene",a),e.setFloat(this._invertNormalName,o.useRightHandedSystem===(null!=o._mirroredCameraPosition)?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);const h=null!==(n=null===(s=this.indexOfRefraction.connectInputBlock)||void 0===s?void 0:s.value)&&void 0!==n?n:1.5,u=Math.pow((h-1)/(h+1),2);this._metallicReflectanceColor.scaleToRef(u*this._metallicF0Factor,wt.Color3[0]),e.setColor4(this._vMetallicReflectanceFactorsName,wt.Color3[0],this._metallicF0Factor),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_injectVertexCode(e){var t,i;const s=this.worldPosition,n=`//${this.name}`;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",n,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",n,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const o="v_"+s.associatedVariableName;e._emitVaryingFromString(o,"vec4")&&(e.compilationString+=`${o} = ${s.associatedVariableName};\r\n`);const a=this.reflection.isConnected?null===(t=this.reflection.connectedPoint)||void 0===t?void 0:t.ownerBlock:null;a&&(a.viewConnectionPoint=this.view),e.compilationString+=null!==(i=a?.handleVertexSide(e))&&void 0!==i?i:"",e._emitVaryingFromString("vClipSpacePosition","vec4","defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+="#if DEBUGMODE > 0\r\n",e._injectAtEnd+="vClipSpacePosition = gl_Position;\r\n",e._injectAtEnd+="#endif\r\n"),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",n,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:s.associatedVariableName}]}):(e.compilationString+=`vec4 worldPos = ${s.associatedVariableName};\r\n`,this.view.isConnected&&(e.compilationString+=`mat4 view = ${this.view.associatedVariableName};\r\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",n,{repeatKey:"maxSimultaneousLights"}))}_getAlbedoOpacityCode(){let e="albedoOpacityOutParams albedoOpacityOut;\r\n";return e+=`albedoOpacityBlock(\n                vec4(${this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)"}, 1.),\n            #ifdef ALBEDO\n                vec4(1.),\n                vec2(1., 1.),\n            #endif\n            #ifdef OPACITY\n                vec4(${this.opacity.isConnected?this.opacity.associatedVariableName:"1."}),\n                vec2(1., 1.),\n            #endif\n                albedoOpacityOut\n            );\n\n            vec3 surfaceAlbedo = albedoOpacityOut.surfaceAlbedo;\n            float alpha = albedoOpacityOut.alpha;\r\n`,e}_getAmbientOcclusionCode(){let e="ambientOcclusionOutParams aoOut;\r\n";return e+=`ambientOcclusionBlock(\n            #ifdef AMBIENT\n                vec3(${this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1."}),\n                vec4(0., 1.0, 1.0, 0.),\n            #endif\n                aoOut\n            );\r\n`,e}_getReflectivityCode(e){let t="reflectivityOutParams reflectivityOut;\r\n";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,"vec4"),t+=`vec3 baseColor = surfaceAlbedo;\n\n            reflectivityBlock(\n                vec4(${this.metallic.associatedVariableName}, ${this.roughness.associatedVariableName}, 0., 0.),\n            #ifdef METALLICWORKFLOW\n                surfaceAlbedo,\n                ${this._vMetallicReflectanceFactorsName},\n            #endif\n            #ifdef REFLECTIVITY\n                vec3(0., 0., 1.),\n                vec4(1.),\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)\n                aoOut.ambientOcclusionColor,\n            #endif\n            #ifdef MICROSURFACEMAP\n                microSurfaceTexel, <== not handled!\n            #endif\n                reflectivityOut\n            );\n\n            float microSurface = reflectivityOut.microSurface;\n            float roughness = reflectivityOut.roughness;\n\n            #ifdef METALLICWORKFLOW\n                surfaceAlbedo = reflectivityOut.surfaceAlbedo;\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;\n            #endif\r\n`,t}_buildBlock(e){var t,i,s,n,o,a,l,c,h,u,d,f,p,_,m,g,b,y,T,x,S,C,D,P,M,w,k,X,te,J,Q,me,ae,W,K,O,H,Y,he,Le,Fe;super._buildBlock(e),this._scene=e.sharedData.scene,this._environmentBRDFTexture||(this._environmentBRDFTexture=$v(this._scene));const se=this.reflection.isConnected?null===(t=this.reflection.connectedPoint)||void 0===t?void 0:t.ownerBlock:null;if(se&&(se.worldPositionConnectionPoint=this.worldPosition,se.cameraPositionConnectionPoint=this.cameraPosition,se.worldNormalConnectionPoint=this.worldNormal,se.viewConnectionPoint=this.view),e.target!==B.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const _e=`//${this.name}`,rt=this.perturbedNormal;let Ze=this.worldPosition.associatedVariableName;this.generateOnlyFragmentCode?(Ze=e._getFreeVariableName("globalWorldPos"),e._emitFunction("pbr_globalworldpos",`vec3 ${Ze};\r\n`,_e),e.compilationString+=`${Ze} = ${this.worldPosition.associatedVariableName}.xyz;\r\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",_e,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${this.worldPosition.associatedVariableName}`:void 0}),e.compilationString+="#if DEBUGMODE > 0\r\n",e.compilationString+="vec4 vClipSpacePosition = vec4((vec2(gl_FragCoord.xy) / vec2(1.0)) * 2.0 - 1.0, 0.0, 1.0);\r\n",e.compilationString+="#endif\r\n"):Ze="v_"+Ze,this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitUniformFromString("vDebugMode","vec2","defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene","vec3"),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",_e,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",_e,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),e._emitFunctionFromInclude("helperFunctions",_e),e._emitFunctionFromInclude("importanceSampling",_e),e._emitFunctionFromInclude("pbrHelperFunctions",_e),e._emitFunctionFromInclude("imageProcessingDeclaration",_e),e._emitFunctionFromInclude("imageProcessingFunctions",_e),e._emitFunctionFromInclude("shadowsFragmentFunctions",_e,{replaceStrings:[{search:/vPositionW/g,replace:Ze+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",_e,{replaceStrings:[{search:/vPositionW/g,replace:Ze+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",_e),e._emitFunctionFromInclude("pbrBRDFFunctions",_e,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(i=se?._defineSkyboxName)&&void 0!==i?i:"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",_e),e._emitFunctionFromInclude("pbrDirectLightingFunctions",_e,{replaceStrings:[{search:/vPositionW/g,replace:Ze+".xyz"}]}),e._emitFunctionFromInclude("pbrIBLFunctions",_e),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",_e),e._emitFunctionFromInclude("pbrBlockReflectivity",_e),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",_e),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",_e),e._emitFunctionFromInclude("pbrBlockAnisotropic",_e),e._emitUniformFromString("vLightingIntensity","vec4"),se?.generateOnlyFragmentCode&&(e.compilationString+=se.handleVertexSide(e)),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+=`vec4 ${this._vNormalWName} = normalize(${this.worldNormal.associatedVariableName});\r\n`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${Ze}.xyz);\r\n`),e.compilationString+=`vec3 geometricNormalW = ${this._vNormalWName}.xyz;\r\n`,e.compilationString+=`vec3 normalW = ${rt.isConnected?"normalize("+rt.associatedVariableName+".xyz)":"geometricNormalW"};\r\n`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,"float"),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",_e,{replaceStrings:[{search:/vPositionW/g,replace:Ze+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(),e.compilationString+=e._emitCodeFromInclude("depthPrePass",_e),e.compilationString+=this._getAmbientOcclusionCode(),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",_e),e.compilationString+="#ifdef UNLIT\n                vec3 diffuseBase = vec3(1., 1., 1.);\n            #else\r\n",e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",_e,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(s=se?._defineSkyboxName)&&void 0!==s?s:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:null!==(n=se?._define3DName)&&void 0!==n?n:"REFLECTIONMAP_3D"}]});const Ae=this.anisotropy.isConnected?null===(o=this.anisotropy.connectedPoint)||void 0===o?void 0:o.ownerBlock:null;Ae&&(Ae.worldPositionConnectionPoint=this.worldPosition,Ae.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=Ae.getCode(e,!this.perturbedNormal.isConnected)),se&&se.hasTexture&&(e.compilationString+=se.getCode(e,Ae?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",_e,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:null!==(a=se?._define3DName)&&void 0!==a?a:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(l=se?._defineOppositeZ)&&void 0!==l?l:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(c=se?._defineProjectionName)&&void 0!==c?c:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(h=se?._defineSkyboxName)&&void 0!==h?h:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(u=se?._defineLODReflectionAlpha)&&void 0!==u?u:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(d=se?._defineLinearSpecularReflection)&&void 0!==d?d:"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:null!==(f=se?._vReflectionFilteringInfoName)&&void 0!==f?f:"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",_e,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:this._vMetallicReflectanceFactorsName}]});const Ie=this.sheen.isConnected?null===(p=this.sheen.connectedPoint)||void 0===p?void 0:p.ownerBlock:null;Ie&&(e.compilationString+=Ie.getCode(se)),e._emitFunctionFromInclude("pbrBlockSheen",_e,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:null!==(_=se?._define3DName)&&void 0!==_?_:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(m=se?._defineSkyboxName)&&void 0!==m?m:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(g=se?._defineLODReflectionAlpha)&&void 0!==g?g:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(b=se?._defineLinearSpecularReflection)&&void 0!==b?b:"LINEARSPECULARREFLECTION"}]});const ct=this.iridescence.isConnected?null===(y=this.iridescence.connectedPoint)||void 0===y?void 0:y.ownerBlock:null;e.compilationString+=Xp.GetCode(ct),e._emitFunctionFromInclude("pbrBlockIridescence",_e,{replaceStrings:[]});const Ct=this.clearcoat.isConnected?null===(T=this.clearcoat.connectedPoint)||void 0===T?void 0:T.ownerBlock:null,Mt=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,Ke=this.perturbedNormal.isConnected&&(null===(S=(null===(x=this.perturbedNormal.connectedPoint)||void 0===x?void 0:x.ownerBlock).worldTangent)||void 0===S?void 0:S.isConnected),as=this.anisotropy.isConnected&&(null===(C=this.anisotropy.connectedPoint)||void 0===C?void 0:C.ownerBlock).worldTangent.isConnected;let Xi=Ke||!this.perturbedNormal.isConnected&&as;e.compilationString+=dd.GetCode(e,Ct,se,Ze,Mt,Xi,this.worldNormal.associatedVariableName),Mt&&(Xi=null!==(D=Ct?.worldTangent.isConnected)&&void 0!==D&&D),e._emitFunctionFromInclude("pbrBlockClearcoat",_e,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:null!==(P=se?._define3DName)&&void 0!==P?P:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(M=se?._defineOppositeZ)&&void 0!==M?M:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(w=se?._defineProjectionName)&&void 0!==w?w:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(k=se?._defineSkyboxName)&&void 0!==k?k:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(X=se?._defineLODReflectionAlpha)&&void 0!==X?X:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(te=se?._defineLinearSpecularReflection)&&void 0!==te?te:"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:Xi?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",_e,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(J=se?._defineSkyboxName)&&void 0!==J?J:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:null!==(Q=se?._define3DName)&&void 0!==Q?Q:"REFLECTIONMAP_3D"}]});const gr=this.subsurface.isConnected?null===(me=this.subsurface.connectedPoint)||void 0===me?void 0:me.ownerBlock:null,ri=this.subsurface.isConnected?null===(W=(null===(ae=this.subsurface.connectedPoint)||void 0===ae?void 0:ae.ownerBlock).refraction.connectedPoint)||void 0===W?void 0:W.ownerBlock:null;ri&&(ri.viewConnectionPoint=this.view,ri.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=jp.GetCode(e,gr,se,Ze),e._emitFunctionFromInclude("pbrBlockSubSurface",_e,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:null!==(K=se?._define3DName)&&void 0!==K?K:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(O=se?._defineOppositeZ)&&void 0!==O?O:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(H=se?._defineProjectionName)&&void 0!==H?H:"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:null!==(Y=ri?._define3DName)&&void 0!==Y?Y:"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:null!==(he=ri?._defineLODRefractionAlpha)&&void 0!==he?he:"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:null!==(Le=ri?._defineLinearSpecularRefraction)&&void 0!==Le?Le:"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:null!==(Fe=ri?._defineOppositeZ)&&void 0!==Fe?Fe:"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",_e),e.compilationString+=e._emitCodeFromInclude("lightFragment",_e,this.light?{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}:{repeatKey:"maxSimultaneousLights"}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",_e),e.compilationString+="#endif\r\n";const ni=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:"vec3(0., 0., 0.)";let bi=Vt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();-1===bi.indexOf(".")&&(bi+="."),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",_e,{replaceStrings:[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:/vAmbientColor/g,replace:ni+" * ambientFromScene"},{search:/vAmbientInfos\.w/g,replace:bi}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",_e,{replaceStrings:[{search:/finalEmissive/g,replace:"vec3(0.)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",_e,{replaceStrings:[{search:/visibility/g,replace:"1."}]}),e.compilationString+=e._emitCodeFromInclude("pbrDebug",_e,{replaceStrings:[{search:/vNormalW/g,replace:this._vNormalWName},{search:/vPositionW/g,replace:Ze},{search:/albedoTexture\.rgb;/g,replace:"vec3(1.);\r\ngl_FragColor.rgb = toGammaSpace(gl_FragColor.rgb);\r\n"}]});for(const Bs of this._outputs)if(Bs.hasEndpoints){const ji=Cae[Bs.name];if(ji){const[cn,As]=ji;As&&(e.compilationString+=`#if ${As}\r\n`),e.compilationString+=`${this._declareOutput(Bs,e)} = ${cn};\r\n`,As&&(e.compilationString+="#else\r\n",e.compilationString+=`${this._declareOutput(Bs,e)} = vec3(0.);\r\n`,e.compilationString+="#endif\r\n")}else console.error(`There's no remapping for the ${Bs.name} end point! No code generated`)}return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.lightFalloff = ${this.lightFalloff};\r\n`,e+=`${this._codeVariableName}.useAlphaTest = ${this.useAlphaTest};\r\n`,e+=`${this._codeVariableName}.alphaTestCutoff = ${this.alphaTestCutoff};\r\n`,e+=`${this._codeVariableName}.useAlphaBlending = ${this.useAlphaBlending};\r\n`,e+=`${this._codeVariableName}.useRadianceOverAlpha = ${this.useRadianceOverAlpha};\r\n`,e+=`${this._codeVariableName}.useSpecularOverAlpha = ${this.useSpecularOverAlpha};\r\n`,e+=`${this._codeVariableName}.enableSpecularAntiAliasing = ${this.enableSpecularAntiAliasing};\r\n`,e+=`${this._codeVariableName}.realTimeFiltering = ${this.realTimeFiltering};\r\n`,e+=`${this._codeVariableName}.realTimeFilteringQuality = ${this.realTimeFilteringQuality};\r\n`,e+=`${this._codeVariableName}.useEnergyConservation = ${this.useEnergyConservation};\r\n`,e+=`${this._codeVariableName}.useRadianceOcclusion = ${this.useRadianceOcclusion};\r\n`,e+=`${this._codeVariableName}.useHorizonOcclusion = ${this.useHorizonOcclusion};\r\n`,e+=`${this._codeVariableName}.unlit = ${this.unlit};\r\n`,e+=`${this._codeVariableName}.forceNormalForward = ${this.forceNormalForward};\r\n`,e+=`${this._codeVariableName}.debugMode = ${this.debugMode};\r\n`,e+=`${this._codeVariableName}.debugLimit = ${this.debugLimit};\r\n`,e+=`${this._codeVariableName}.debugFactor = ${this.debugFactor};\r\n`,e}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){var s,n;super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=null!==(s=e.lightFalloff)&&void 0!==s?s:0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=null!==(n=e.realTimeFilteringQuality)&&void 0!==n?n:8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor,this.generateOnlyFragmentCode=!!e.generateOnlyFragmentCode,this._setTarget()}}E([_t("Direct lights",lt.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],gs.prototype,"directIntensity",void 0),E([_t("Environment lights",lt.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],gs.prototype,"environmentIntensity",void 0),E([_t("Specular highlights",lt.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],gs.prototype,"specularIntensity",void 0),E([_t("Light falloff",lt.List,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:Vt.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:Vt.LIGHTFALLOFF_GLTF},{label:"Standard",value:Vt.LIGHTFALLOFF_STANDARD}]})],gs.prototype,"lightFalloff",void 0),E([_t("Alpha Testing",lt.Boolean,"OPACITY")],gs.prototype,"useAlphaTest",void 0),E([_t("Alpha CutOff",lt.Float,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],gs.prototype,"alphaTestCutoff",void 0),E([_t("Alpha blending",lt.Boolean,"OPACITY")],gs.prototype,"useAlphaBlending",void 0),E([_t("Radiance over alpha",lt.Boolean,"RENDERING",{notifiers:{update:!0}})],gs.prototype,"useRadianceOverAlpha",void 0),E([_t("Specular over alpha",lt.Boolean,"RENDERING",{notifiers:{update:!0}})],gs.prototype,"useSpecularOverAlpha",void 0),E([_t("Specular anti-aliasing",lt.Boolean,"RENDERING",{notifiers:{update:!0}})],gs.prototype,"enableSpecularAntiAliasing",void 0),E([_t("Realtime filtering",lt.Boolean,"RENDERING",{notifiers:{update:!0}})],gs.prototype,"realTimeFiltering",void 0),E([_t("Realtime filtering quality",lt.List,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],gs.prototype,"realTimeFilteringQuality",void 0),E([_t("Energy Conservation",lt.Boolean,"ADVANCED",{notifiers:{update:!0}})],gs.prototype,"useEnergyConservation",void 0),E([_t("Radiance occlusion",lt.Boolean,"ADVANCED",{notifiers:{update:!0}})],gs.prototype,"useRadianceOcclusion",void 0),E([_t("Horizon occlusion",lt.Boolean,"ADVANCED",{notifiers:{update:!0}})],gs.prototype,"useHorizonOcclusion",void 0),E([_t("Unlit",lt.Boolean,"ADVANCED",{notifiers:{update:!0}})],gs.prototype,"unlit",void 0),E([_t("Force normal forward",lt.Boolean,"ADVANCED",{notifiers:{update:!0}})],gs.prototype,"forceNormalForward",void 0),E([_t("Generate only fragment code",lt.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:gs._OnGenerateOnlyFragmentCodeChanged}})],gs.prototype,"generateOnlyFragmentCode",void 0),E([_t("Debug mode",lt.List,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87}]})],gs.prototype,"debugMode",void 0),E([_t("Split position",lt.Float,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],gs.prototype,"debugLimit",void 0),E([_t("Output factor",lt.Float,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],gs.prototype,"debugFactor",void 0),le("BABYLON.PBRMetallicRoughnessBlock",gs),le("BABYLON.ModBlock",class Aae extends De{constructor(e){super(e,B.Neutral),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"ModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = mod(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r\n`,this}}),le("BABYLON.MatrixBuilder",class Rae extends De{constructor(e){super(e,B.Neutral),this.registerInput("row0",R.Vector4),this.registerInput("row1",R.Vector4),this.registerInput("row2",R.Vector4),this.registerInput("row3",R.Vector4),this.registerOutput("output",R.Matrix)}getClassName(){return"MatrixBuilder"}get row0(){return this._inputs[0]}get row1(){return this._inputs[1]}get row2(){return this._inputs[2]}get row3(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(){if(!this.row0.isConnected){const e=new et("row0");e.value=new vt(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){const e=new et("row1");e.value=new vt(0,1,0,0),e.output.connectTo(this.row1)}if(!this.row2.isConnected){const e=new et("row2");e.value=new vt(0,0,1,0),e.output.connectTo(this.row2)}if(!this.row3.isConnected){const e=new et("row3");e.value=new vt(0,0,0,1),e.output.connectTo(this.row3)}}_buildBlock(e){super._buildBlock(e);const i=this.row0,s=this.row1,n=this.row2,o=this.row3;return e.compilationString+=this._declareOutput(this._outputs[0],e)+` = mat4(${i.associatedVariableName}, ${s.associatedVariableName}, ${n.associatedVariableName}, ${o.associatedVariableName});\r\n`,this}});var vn=(()=>{return(r=vn||(vn={}))[r.Equal=0]="Equal",r[r.NotEqual=1]="NotEqual",r[r.LessThan=2]="LessThan",r[r.GreaterThan=3]="GreaterThan",r[r.LessOrEqual=4]="LessOrEqual",r[r.GreaterOrEqual=5]="GreaterOrEqual",r[r.Xor=6]="Xor",r[r.Or=7]="Or",r[r.And=8]="And",vn;var r})();le("BABYLON.ConditionalBlock",class Iae extends De{constructor(e){super(e,B.Neutral),this.condition=vn.LessThan,this.registerInput("a",R.Float),this.registerInput("b",R.Float),this.registerInput("true",R.AutoDetect,!0),this.registerInput("false",R.AutoDetect,!0),this.registerOutput("output",R.BasedOnInput),this._linkConnectionTypes(2,3),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=R.Float}getClassName(){return"ConditionalBlock"}get a(){return this._inputs[0]}get b(){return this._inputs[1]}get true(){return this._inputs[2]}get false(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",s=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case vn.Equal:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} == ${this.b.associatedVariableName} ? ${i} : ${s};\r\n`;break;case vn.NotEqual:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} != ${this.b.associatedVariableName} ? ${i} : ${s};\r\n`;break;case vn.LessThan:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} < ${this.b.associatedVariableName} ? ${i} : ${s};\r\n`;break;case vn.LessOrEqual:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} <= ${this.b.associatedVariableName} ? ${i} : ${s};\r\n`;break;case vn.GreaterThan:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} > ${this.b.associatedVariableName} ? ${i} : ${s};\r\n`;break;case vn.GreaterOrEqual:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} >= ${this.b.associatedVariableName} ? ${i} : ${s};\r\n`;break;case vn.Xor:e.compilationString+=this._declareOutput(t,e)+` = (mod(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 2.0) > 0.0) ? ${i} : ${s};\r\n`;break;case vn.Or:e.compilationString+=this._declareOutput(t,e)+` = (min(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 1.0) > 0.0) ? ${i} : ${s};\r\n`;break;case vn.And:e.compilationString+=this._declareOutput(t,e)+` = (${this.a.associatedVariableName} * ${this.b.associatedVariableName} > 0.0)  ? ${i} : ${s};\r\n`}return this}serialize(){const e=super.serialize();return e.condition=this.condition,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.condition=e.condition}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.condition = BABYLON.ConditionalBlockConditions.${vn[this.condition]};\r\n`}});class sz extends De{constructor(e){super(e,B.Neutral),this.octaves=6,this.registerInput("seed",R.AutoDetect),this.registerInput("chaos",R.AutoDetect,!0),this.registerInput("offsetX",R.Float,!0),this.registerInput("offsetY",R.Float,!0),this.registerInput("offsetZ",R.Float,!0),this.registerOutput("output",R.Float),this._inputs[0].acceptedConnectionPointTypes.push(R.Vector2),this._inputs[0].acceptedConnectionPointTypes.push(R.Vector3),this._linkConnectionTypes(0,1)}getClassName(){return"CloudBlock"}get seed(){return this._inputs[0]}get chaos(){return this._inputs[1]}get offsetX(){return this._inputs[2]}get offsetY(){return this._inputs[3]}get offsetZ(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){var t,i;if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;const o=`fbm${this.octaves}`;e._emitFunction("CloudBlockCode","\n\n        float cloudRandom(in float p) { p = fract(p * 0.011); p *= p + 7.5; p *= p + p; return fract(p); }\n\n        // Based on Morgan McGuire @morgan3d\n        // https://www.shadertoy.com/view/4dS3Wd\n        float cloudNoise(in vec2 x, in vec2 chaos) {\n            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);\n\n            vec2 i = floor(x);\n            vec2 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec2 u = f * f * (3.0 - 2.0 * f);\n            return mix(\n                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),\n                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),\n                    u.y\n                );\n        }\n\n        float cloudNoise(in vec3 x, in vec3 chaos) {\n            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);\n\n            vec3 i = floor(x);\n            vec3 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec3 u = f * f * (3.0 - 2.0 * f);\n            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),\n                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);\n        }","// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,"\n        float fbm(in vec2 st, in vec2 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = .5;\n            float frequency = 0.;\n\n            // Loop of octaves\n            for (int i = 0; i < OCTAVES; i++) {\n                value += amplitude * cloudNoise(st, chaos);\n                st *= 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }\n\n        float fbm(in vec3 x, in vec3 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = 0.5;\n            for (int i = 0; i < OCTAVES; ++i) {\n                value += amplitude * cloudNoise(x, chaos);\n                x = x * 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }".replace(/fbm/gi,o).replace(/OCTAVES/gi,(0|this.octaves).toString()),"// CloudBlockCode FBM");const a=e._getFreeVariableName("st"),l=(null===(t=this.seed.connectedPoint)||void 0===t?void 0:t.type)===R.Vector2?"vec2":"vec3";e.compilationString+=`${l} ${a} = ${this.seed.associatedVariableName};\r\n`,this.offsetX.isConnected&&(e.compilationString+=`${a}.x += 0.1 * ${this.offsetX.associatedVariableName};\r\n`),this.offsetY.isConnected&&(e.compilationString+=`${a}.y += 0.1 * ${this.offsetY.associatedVariableName};\r\n`),this.offsetZ.isConnected&&"vec3"===l&&(e.compilationString+=`${a}.z += 0.1 * ${this.offsetZ.associatedVariableName};\r\n`);let c="";return c=this.chaos.isConnected?this.chaos.associatedVariableName:(null===(i=this.seed.connectedPoint)||void 0===i?void 0:i.type)===R.Vector2?"vec2(0., 0.)":"vec3(0., 0., 0.)",e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${o}(${a}, ${c});\r\n`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.octaves = ${this.octaves};\r\n`}serialize(){const e=super.serialize();return e.octaves=this.octaves,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.octaves=e.octaves}}E([_t("Octaves",lt.Int)],sz.prototype,"octaves",void 0),le("BABYLON.CloudBlock",sz),le("BABYLON.VoronoiNoiseBlock",class Mae extends De{constructor(e){super(e,B.Neutral),this.registerInput("seed",R.Vector2),this.registerInput("offset",R.Float),this.registerInput("density",R.Float),this.registerOutput("output",R.Float),this.registerOutput("cells",R.Float)}getClassName(){return"VoronoiNoiseBlock"}get seed(){return this._inputs[0]}get offset(){return this._inputs[1]}get density(){return this._inputs[2]}get output(){return this._outputs[0]}get cells(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;let t="vec2 voronoiRandom(vec2 seed, float offset){\n            mat2 m = mat2(15.27, 47.63, 99.41, 89.98);\n            vec2 uv = fract(sin(m * seed) * 46839.32);\n            return vec2(sin(uv.y * offset) * 0.5 + 0.5, cos(uv.x * offset) * 0.5 + 0.5);\n        }\n        ";e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t="void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){\n            vec2 g = floor(seed * density);\n            vec2 f = fract(seed * density);\n            float t = 8.0;\n            vec3 res = vec3(8.0, 0.0, 0.0);\n\n            for(int y=-1; y<=1; y++)\n            {\n                for(int x=-1; x<=1; x++)\n                {\n                    vec2 lattice = vec2(x,y);\n                    vec2 randomOffset = voronoiRandom(lattice + g, offset);\n                    float d = distance(lattice + randomOffset, f);\n                    if(d < res.x)\n                    {\n                        res = vec3(d, randomOffset.x, randomOffset.y);\n                        outValue = res.x;\n                        cells = res.y;\n                    }\n                }\n            }\n        }\n        ",e._emitFunction("voronoi",t,"// Voronoi");const i=e._getFreeVariableName("tempOutput"),s=e._getFreeVariableName("tempCells");return e.compilationString+=`float ${i} = 0.0;\r\n`,e.compilationString+=`float ${s} = 0.0;\r\n`,e.compilationString+=`voronoi(${this.seed.associatedVariableName}, ${this.offset.associatedVariableName}, ${this.density.associatedVariableName}, ${i}, ${s});\r\n`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${i};\r\n`),this.cells.hasEndpoints&&(e.compilationString+=this._declareOutput(this.cells,e)+` = ${s};\r\n`),this}}),le("BABYLON.ElbowBlock",class Pae extends De{constructor(e){super(e,B.Neutral),this.registerInput("input",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==B.VertexAndFragment)return t.target;if(e.connectedPoint.target!==B.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){0==(this._target&e)&&(this._target=e)}_buildBlock(e){super._buildBlock(e);const i=this._inputs[0];return e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${i.associatedVariableName};\r\n`,this}});class rz extends De{get texture(){var e;return this.source.isConnected?(null===(e=this.source.connectedPoint)||void 0===e?void 0:e.ownerBlock).texture:this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=e?.getScene())&&void 0!==t?t:be.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,s=>s.hasTexture(this._texture)),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,s=>s.hasTexture(e))}get textureY(){var e;return this.sourceY.isConnected?(null===(e=this.sourceY.connectedPoint)||void 0===e?void 0:e.ownerBlock).texture:null}get textureZ(){var e,t;return null!==(e=this.sourceZ)&&void 0!==e&&e.isConnected?(null===(t=this.sourceY.connectedPoint)||void 0===t?void 0:t.ownerBlock).texture:null}_getImageSourceBlock(e){return e?.isConnected?e.connectedPoint.ownerBlock:null}get samplerName(){const e=this._getImageSourceBlock(this.source);return e?e.samplerName:this._samplerName}get samplerYName(){var e,t;return null!==(t=null===(e=this._getImageSourceBlock(this.sourceY))||void 0===e?void 0:e.samplerName)&&void 0!==t?t:null}get samplerZName(){var e,t;return null!==(t=null===(e=this._getImageSourceBlock(this.sourceZ))||void 0===e?void 0:e.samplerName)&&void 0!==t?t:null}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){var t;e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)&&(null!==(t=this.texture.getScene())&&void 0!==t?t:be.LastCreatedScene)?.markAllMaterialsAsDirty(1,s=>s.hasTexture(this.texture))}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){var t;e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)&&(null!==(t=this.texture.getScene())&&void 0!==t?t:be.LastCreatedScene)?.markAllMaterialsAsDirty(1,s=>s.hasTexture(this.texture))}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,B.Neutral),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this.registerInput("position",R.AutoDetect,!1),this.registerInput("normal",R.AutoDetect,!1),this.registerInput("sharpness",R.Float,!0),this.registerInput("source",R.Object,!0,B.VertexAndFragment,new Qi("source",this,Ei.Input,Rh,"ImageSourceBlock")),this.registerInput("sourceY",R.Object,!0,B.VertexAndFragment,new Qi("sourceY",this,Ei.Input,Rh,"ImageSourceBlock")),t||this.registerInput("sourceZ",R.Object,!0,B.VertexAndFragment,new Qi("sourceZ",this,Ei.Input,Rh,"ImageSourceBlock")),this.registerOutput("rgba",R.Color4,B.Neutral),this.registerOutput("rgb",R.Color3,B.Neutral),this.registerOutput("r",R.Float,B.Neutral),this.registerOutput("g",R.Float,B.Neutral),this.registerOutput("b",R.Float,B.Neutral),this.registerOutput("a",R.Float,B.Neutral),this.registerOutput("level",R.Float,B.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(R.Color3|R.Vector3|R.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(R.Color3|R.Vector3|R.Vector4)}getClassName(){return"TriPlanarBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get sharpness(){return this._inputs[2]}get source(){return this._inputs[3]}get sourceY(){return this._inputs[4]}get sourceZ(){return this._inputs[5]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const n=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,!0),i.setValue(this._gammaDefineName,n,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){!this.texture||(e.setFloat(this._textureInfoName,this.texture.level),this._imageSource||e.setTexture(this._samplerName,this.texture))}_generateTextureLookup(e){var t,i;const s=this.samplerName,n=null!==(t=this.samplerYName)&&void 0!==t?t:s,o=null!==(i=this.samplerZName)&&void 0!==i?i:s,a=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",l=e._getFreeVariableName("x"),c=e._getFreeVariableName("y"),h=e._getFreeVariableName("z"),u=e._getFreeVariableName("z");e.compilationString+=`\n            vec4 ${l} = texture2D(${s}, ${this.position.associatedVariableName}.yz);\n            vec4 ${c} = texture2D(${n}, ${this.position.associatedVariableName}.zx);\n            vec4 ${h} = texture2D(${o}, ${this.position.associatedVariableName}.xy);\n            \n            // blend weights\n            vec3 ${u} = pow(abs(${this.normal.associatedVariableName}.xyz), vec3(${a}));\n\n            // blend and return\n            vec4 ${this._tempTextureRead} = (${l}*${u}.x + ${c}*${u}.y + ${h}*${u}.z) / (${u}.x + ${u}.y + ${u}.z);        \n        `}_generateConversionCode(e,t,i){"a"!==i&&((!this.texture||!this.texture.gammaSpace)&&(e.compilationString+=`#ifdef ${this._linearDefineName}\n                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n                    #endif\n                `),e.compilationString+=`#ifdef ${this._gammaDefineName}\n                ${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n                #endif\n            `)}_writeOutput(e,t,i){let s="";this.disableLevelMultiplication||(s=` * ${this._textureInfoName}`),e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i}${s};\r\n`,this._generateConversionCode(e,t,i)}_buildBlock(e){super._buildBlock(e),this._imageSource=this.source.isConnected?this.source.connectedPoint.ownerBlock:null,this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e._emitFunctionFromInclude("helperFunctions",`//${this.name}`),e._emitUniformFromString(this._textureInfoName,"float"),this._generateTextureLookup(e);for(const i of this._outputs)i.hasEndpoints&&"level"!==i.name&&this._writeOutput(e,i,i.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\r\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\r\n`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\r\n`,this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\r\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\r\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\r\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\r\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\r\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\r\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\r\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\r\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\r\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\r\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r\n`),e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.disableLevelMultiplication=this.disableLevelMultiplication,!this.hasImageSource&&this.texture&&!this.texture.isRenderTarget&&"VideoTexture"!==this.texture.getClassName()&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!Ri.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=U.Parse(e.texture,t,i))}}le("BABYLON.TriPlanarBlock",rz),le("BABYLON.BiPlanarBlock",class Dae extends rz{constructor(e){super(e,!0)}getClassName(){return"BiPlanarBlock"}_generateTextureLookup(e){var t;const i=this.samplerName,s=null!==(t=this.samplerYName)&&void 0!==t?t:this.samplerName,n=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",o=e._getFreeVariableName("dpdx"),a=e._getFreeVariableName("dpdy"),l=e._getFreeVariableName("n"),c=e._getFreeVariableName("ma"),h=e._getFreeVariableName("mi"),u=e._getFreeVariableName("me"),d=e._getFreeVariableName("x"),f=e._getFreeVariableName("y"),p=e._getFreeVariableName("y");e.compilationString+=`\n            // grab coord derivatives for texturing\n            vec3 ${o} = dFdx(${this.position.associatedVariableName}.xyz);\n            vec3 ${a} = dFdy(${this.position.associatedVariableName}.xyz);\n            vec3 ${l} = abs(${this.normal.associatedVariableName}.xyz);\n        \n            // determine major axis (in x; yz are following axis)\n            ivec3 ${c} = (${l}.x>${l}.y && ${l}.x>${l}.z) ? ivec3(0,1,2) :\n                    (${l}.y>${l}.z)            ? ivec3(1,2,0) :\n                                            ivec3(2,0,1) ;\n            // determine minor axis (in x; yz are following axis)\n            ivec3 ${h} = (${l}.x<${l}.y && ${l}.x<${l}.z) ? ivec3(0,1,2) :\n                    (${l}.y<${l}.z)            ? ivec3(1,2,0) :\n                                            ivec3(2,0,1) ;\n            // determine median axis (in x;  yz are following axis)\n            ivec3 ${u} = ivec3(3) - ${h} - ${c};\n            \n            // project+fetch\n            vec4 ${d} = textureGrad( ${i}, vec2(   ${this.position.associatedVariableName}[${c}.y],   ${this.position.associatedVariableName}[${c}.z]), \n                                    vec2(${o}[${c}.y],${o}[${c}.z]), \n                                    vec2(${a}[${c}.y],${a}[${c}.z]) );\n            vec4 ${f} = textureGrad( ${s}, vec2(   ${this.position.associatedVariableName}[${u}.y],   ${this.position.associatedVariableName}[${u}.z]), \n                                    vec2(${o}[${u}.y],${o}[${u}.z]),\n                                    vec2(${a}[${u}.y],${a}[${u}.z]) );\n            \n            // blend factors\n            vec2 ${p} = vec2(${l}[${c}.x],${l}[${u}.x]);\n            // make local support\n            ${p} = clamp( (${p}-0.5773)/(1.0-0.5773), 0.0, 1.0 );\n            // shape transition\n            ${p} = pow( ${p}, vec2(${n}/8.0) );\n            // blend and return\n            vec4 ${this._tempTextureRead} = (${d}*${p}.x + ${f}*${p}.y) / (${p}.x + ${p}.y);\n        `}}),le("BABYLON.MatrixDeterminantBlock",class wae extends De{constructor(e){super(e,B.Neutral),this.registerInput("input",R.Matrix),this.registerOutput("output",R.Float)}getClassName(){return"MatrixDeterminantBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=this._declareOutput(t,e)+`${t.associatedVariableName} = determinant(${i.associatedVariableName});\r\n`,this}}),le("BABYLON.MatrixTransposeBlock",class Oae extends De{constructor(e){super(e,B.Neutral),this.registerInput("input",R.Matrix),this.registerOutput("output",R.Matrix)}getClassName(){return"MatrixTransposeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=this._declareOutput(t,e)+`${t.associatedVariableName} = transpose(${i.associatedVariableName});\r\n`,this}});class Fae extends Un{constructor(){super(...arguments),this.DECAL=!1,this.DECALDIRECTUV=0,this.DECAL_SMOOTHALPHA=!1,this.GAMMADECAL=!1}}class fb extends Wo{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"DecalMap",150,new Fae,t),this._isEnabled=!1,this.isEnabled=!1,this._smoothAlpha=!1,this.smoothAlpha=!1,this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i,s){const n=s.getMesh().decalMap;return!(this._isEnabled&&n?.texture&&pe.DecalMapEnabled&&t.texturesEnabled)||n.isReady()}prepareDefines(e,t,i){const s=i.decalMap;this._isEnabled&&s?.texture&&pe.DecalMapEnabled&&t.texturesEnabled?((!e.DECAL||e.GAMMADECAL!==s.texture.gammaSpace)&&e.markAsTexturesDirty(),e.DECAL=!0,e.GAMMADECAL=s.texture.gammaSpace,e.DECAL_SMOOTHALPHA=this._smoothAlpha,ce.PrepareDefinesForMergedUV(s.texture,e,"DECAL")):(e.DECAL&&e.markAsTexturesDirty(),e.DECAL=!1)}hardBindForSubMesh(e,t,i,s){const n=s.getMesh().decalMap;if(!(this._isEnabled&&n?.texture&&pe.DecalMapEnabled&&t.texturesEnabled))return;const a=n.texture;(!e.useUbo||!this._material.isFrozen||!e.isSync)&&(e.updateFloat4("vDecalInfos",a.coordinatesIndex,0,0,0),ce.BindTextureMatrix(a,e,"decal")),e.setTexture("decalSampler",a)}getClassName(){return"DecalMapConfiguration"}getSamplers(e){e.push("decalSampler")}getUniforms(){return{ubo:[{name:"vDecalInfos",size:4,type:"vec4"},{name:"decalMatrix",size:16,type:"mat4"}]}}}function YC(r,e,t,i,s,n){const o=new r.DecoderBuffer;o.Init(e,e.byteLength);const a=new r.Decoder;let l,c;try{const h=a.GetEncodedGeometryType(o);switch(h){case r.TRIANGULAR_MESH:l=new r.Mesh,c=a.DecodeBufferToMesh(o,l);break;case r.POINT_CLOUD:l=new r.PointCloud,c=a.DecodeBufferToPointCloud(o,l);break;default:throw new Error(`Invalid geometry type ${h}`)}if(!c.ok()||!l.ptr)throw new Error(c.error_msg());if(h===r.TRIANGULAR_MESH){const f=3*l.num_faces(),p=4*f,_=r._malloc(p);try{a.GetTrianglesUInt32Array(l,p,_);const m=new Uint32Array(f);m.set(new Uint32Array(r.HEAPF32.buffer,_,f)),i(m)}finally{r._free(_)}}const u=(d,f,p=1)=>{const _=f.num_components(),m=l.num_points(),g=m*_,b=g*Float32Array.BYTES_PER_ELEMENT,y=r._malloc(b);try{a.GetAttributeDataArrayForAllPoints(l,f,r.DT_FLOAT32,b,y);const T=new Float32Array(r.HEAPF32.buffer,y,g);if("color"===d&&3===_){const x=new Float32Array(4*m);for(let S=0,C=0;S<x.length;S+=4,C+=_)x[S+0]=T[C+0],x[S+1]=T[C+1],x[S+2]=T[C+2],x[S+3]=1;s(d,x)}else{const x=new Float32Array(g);if(x.set(new Float32Array(r.HEAPF32.buffer,y,g)),1!==p)for(let S=0;S<x.length;S++)x[S]=x[S]/p;s(d,x)}}finally{r._free(y)}};if(t)for(const d in t){u(d,a.GetAttributeByUniqueId(l,t[d]),n&&n[d]||1)}else{const d={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"};for(const f in d){const p=a.GetAttributeId(l,r[d[f]]);-1!==p&&u(f,a.GetAttribute(l,p))}}}finally{l&&r.destroy(l),r.destroy(a),r.destroy(o)}}function Bae(){let r;onmessage=e=>{const t=e.data;switch(t.id){case"init":{const i=t.decoder;i.url&&(importScripts(i.url),r=DracoDecoderModule({wasmBinary:i.wasmBinary})),postMessage("done");break}case"decodeMesh":if(!r)throw new Error("Draco decoder module is not available");r.then(i=>{YC(i,t.dataView,t.attributes,s=>{postMessage({id:"indices",value:s},[s.buffer])},(s,n)=>{postMessage({id:s,value:n},[n.buffer])}),postMessage("done")})}}}E([I(),ne("_markAllSubMeshesAsTexturesDirty")],fb.prototype,"isEnabled",void 0),E([I(),ne("_markAllSubMeshesAsTexturesDirty")],fb.prototype,"smoothAlpha",void 0),Object.defineProperty(fe.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new fb(this)}return this._decalMap},enumerable:!0,configurable:!0}),Object.defineProperty(Vt.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new fb(this)}return this._decalMap},enumerable:!0,configurable:!0}),Object.defineProperty(Zt.prototype,"decalMap",{get:function(){return this._decalMap},set:function(r){this._decalMap=r},enumerable:!0,configurable:!0});class bn{static get DecoderAvailable(){const e=bn.Configuration.decoder;return!!(e.wasmUrl&&e.wasmBinaryUrl&&"object"==typeof WebAssembly||e.fallbackUrl)}static GetDefaultNumWorkers(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static get Default(){return bn._Default||(bn._Default=new bn),bn._Default}constructor(e=bn.DefaultNumWorkers){const t=bn.Configuration.decoder,i=t.wasmUrl&&t.wasmBinaryUrl&&"object"==typeof WebAssembly?{url:q.GetAbsoluteUrl(t.wasmUrl),wasmBinaryPromise:q.LoadFileAsync(q.GetAbsoluteUrl(t.wasmBinaryUrl))}:{url:q.GetAbsoluteUrl(t.fallbackUrl),wasmBinaryPromise:Promise.resolve(void 0)};e&&"function"==typeof Worker&&"function"==typeof URL?this._workerPoolPromise=i.wasmBinaryPromise.then(s=>{const o=URL.createObjectURL(new Blob([`${YC}(${Bae})()`],{type:"application/javascript"}));return new N3(e,()=>new Promise((a,l)=>{const c=new Worker(o),h=d=>{c.removeEventListener("error",h),c.removeEventListener("message",u),l(d)},u=d=>{"done"===d.data&&(c.removeEventListener("error",h),c.removeEventListener("message",u),a(c))};c.addEventListener("error",h),c.addEventListener("message",u),c.postMessage({id:"init",decoder:{url:i.url,wasmBinary:s}})}))}):this._decoderModulePromise=i.wasmBinaryPromise.then(s=>{if(!i.url)throw new Error("Draco decoder module is not available");return q.LoadScriptAsync(i.url).then(()=>function Lae(r){return new Promise(e=>{DracoDecoderModule({wasmBinary:r}).then(t=>{e({module:t})})})}(s))})}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._decoderModulePromise}whenReadyAsync(){return this._workerPoolPromise?this._workerPoolPromise.then(()=>{}):this._decoderModulePromise?this._decoderModulePromise.then(()=>{}):Promise.resolve()}decodeMeshAsync(e,t,i){const s=e instanceof ArrayBuffer?new Uint8Array(e):e;if(this._workerPoolPromise)return this._workerPoolPromise.then(n=>new Promise((o,a)=>{n.push((l,c)=>{const h=new ue,u=p=>{l.removeEventListener("error",u),l.removeEventListener("message",d),a(p),c()},d=p=>{if("done"===p.data)l.removeEventListener("error",u),l.removeEventListener("message",d),o(h),c();else if("indices"===p.data.id)h.indices=p.data.value;else{const _=i&&i[p.data.id]?i[p.data.id]:1;if(1!==_)for(let m=0;m<p.data.value.length;m++)p.data.value[m]=p.data.value[m]/_;h.set(p.data.value,p.data.id)}};l.addEventListener("error",u),l.addEventListener("message",d);const f=new Uint8Array(s.byteLength);f.set(new Uint8Array(s.buffer,s.byteOffset,s.byteLength)),l.postMessage({id:"decodeMesh",dataView:f,attributes:t},[f.buffer])})}));if(this._decoderModulePromise)return this._decoderModulePromise.then(n=>{const o=new ue;return YC(n.module,s,t,a=>{o.indices=a},(a,l)=>{o.set(l,a)},i),o});throw new Error("Draco decoder module is not available")}}bn.Configuration={decoder:{wasmUrl:"https://preview.babylonjs.com/draco_wasm_wrapper_gltf.js",wasmBinaryUrl:"https://preview.babylonjs.com/draco_decoder_gltf.wasm",fallbackUrl:"https://preview.babylonjs.com/draco_decoder_gltf.js"}},bn.DefaultNumWorkers=bn.GetDefaultNumWorkers(),bn._Default=null;let Vae=(()=>{class r{static get Default(){return r._Default||(r._Default=new r),r._Default}constructor(){this._decoderModulePromise=q.LoadScriptAsync(q.GetAbsoluteUrl(r.Configuration.decoder.url)).then(()=>MeshoptDecoder.ready)}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(t,i,s,n,o){return this._decoderModulePromise.then(()=>{const a=new Uint8Array(i*s);return MeshoptDecoder.decodeGltfBuffer(a,i,s,t,n,o),a})}}return r.Configuration={decoder:{url:"https://preview.babylonjs.com/meshopt_decoder.js"}},r._Default=null,r})();j.ShadersStore.meshUVSpaceRendererVertexShader="precision highp float;\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\nuniform mat4 projMatrix;\nvarying vec2 vDecalTC;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nvoid main(void) {\nvec3 positionUpdated=position;\nvec3 normalUpdated=normal;\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\nmat3 normWorldSM=mat3(finalWorld);\nvec3 vNormalW;\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));\nvNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvNormalW=normalize(normWorldSM*normalUpdated);\n#endif\nvec3 normalView=normalize((projMatrix*vec4(vNormalW,0.0)).xyz);\nvec3 decalTC=(projMatrix*worldPos).xyz;\nvDecalTC=decalTC.xy;\ngl_Position=vec4(uv*2.0-1.0,normalView.z>0.0 ? 2. : decalTC.z,1.0);\n}\n";j.ShadersStore.meshUVSpaceRendererPixelShader="precision highp float;\nvarying vec2 vDecalTC;\nuniform sampler2D textureSampler;\nvoid main(void) {\nif (vDecalTC.x<0. || vDecalTC.x>1. || vDecalTC.y<0. || vDecalTC.y>1.) {\ndiscard;\n}\ngl_FragColor=texture2D(textureSampler,vDecalTC);\n}\n",G._GoldbergMeshParser=(r,e)=>_b.Parse(r,e);class _b extends G{constructor(){super(...arguments),this.goldbergData={faceColors:[],faceCenters:[],faceZaxis:[],faceXaxis:[],faceYaxis:[],nbSharedFaces:0,nbUnsharedFaces:0,nbFaces:0,nbFacesAtPole:0,adjacentFaces:[]}}relatedGoldbergFace(e,t){return void 0===t?(e>this.goldbergData.nbUnsharedFaces-1&&(V.Warn("Maximum number of unshared faces used"),e=this.goldbergData.nbUnsharedFaces-1),this.goldbergData.nbUnsharedFaces+e):(e>11&&(V.Warn("Last pole used"),e=11),t>this.goldbergData.nbFacesAtPole-1&&(V.Warn("Maximum number of faces at a pole used"),t=this.goldbergData.nbFacesAtPole-1),12+e*this.goldbergData.nbFacesAtPole+t)}_changeGoldbergFaceColors(e){for(let i=0;i<e.length;i++){const n=e[i][1],o=e[i][2];for(let a=e[i][0];a<n+1;a++)this.goldbergData.faceColors[a]=o}const t=[];for(let i=0;i<12;i++)for(let s=0;s<5;s++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);for(let i=12;i<this.goldbergData.faceColors.length;i++)for(let s=0;s<6;s++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);return t}setGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.setVerticesData(A.ColorKind,t)}updateGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.updateVerticesData(A.ColorKind,t)}_changeGoldbergFaceUVs(e){const t=this.getVerticesData(A.UVKind);for(let i=0;i<e.length;i++){const s=e[i][0],n=e[i][1],o=e[i][2],a=e[i][3],l=e[i][4],c=[],h=[];let u,d;for(let f=0;f<5;f++)u=o.x+a*Math.cos(l+f*Math.PI/2.5),d=o.y+a*Math.sin(l+f*Math.PI/2.5),u<0&&(u=0),u>1&&(u=1),c.push(u,d);for(let f=0;f<6;f++)u=o.x+a*Math.cos(l+f*Math.PI/3),d=o.y+a*Math.sin(l+f*Math.PI/3),u<0&&(u=0),u>1&&(u=1),h.push(u,d);for(let f=s;f<Math.min(12,n+1);f++)for(let p=0;p<5;p++)t[10*f+2*p]=c[2*p],t[10*f+2*p+1]=c[2*p+1];for(let f=Math.max(12,s);f<n+1;f++)for(let p=0;p<6;p++)t[12*f-24+2*p]=h[2*p],t[12*f-23+2*p]=h[2*p+1]}return t}setGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.setVerticesData(A.UVKind,t)}updateGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.updateVerticesData(A.UVKind,t)}placeOnGoldbergFaceAt(e,t,i){const s=v.RotationFromAxis(this.goldbergData.faceXaxis[t],this.goldbergData.faceYaxis[t],this.goldbergData.faceZaxis[t]);e.rotation=s,e.position=this.goldbergData.faceCenters[t].add(this.goldbergData.faceXaxis[t].scale(i.x)).add(this.goldbergData.faceYaxis[t].scale(i.y)).add(this.goldbergData.faceZaxis[t].scale(i.z))}serialize(e){super.serialize(e),e.type="GoldbergMesh";const t={};if(t.adjacentFaces=this.goldbergData.adjacentFaces,t.nbSharedFaces=this.goldbergData.nbSharedFaces,t.nbUnsharedFaces=this.goldbergData.nbUnsharedFaces,t.nbFaces=this.goldbergData.nbFaces,t.nbFacesAtPole=this.goldbergData.nbFacesAtPole,this.goldbergData.faceColors){t.faceColors=[];for(const i of this.goldbergData.faceColors)t.faceColors.push(i.asArray())}if(this.goldbergData.faceCenters){t.faceCenters=[];for(const i of this.goldbergData.faceCenters)t.faceCenters.push(i.asArray())}if(this.goldbergData.faceZaxis){t.faceZaxis=[];for(const i of this.goldbergData.faceZaxis)t.faceZaxis.push(i.asArray())}if(this.goldbergData.faceYaxis){t.faceYaxis=[];for(const i of this.goldbergData.faceYaxis)t.faceYaxis.push(i.asArray())}if(this.goldbergData.faceXaxis){t.faceXaxis=[];for(const i of this.goldbergData.faceXaxis)t.faceXaxis.push(i.asArray())}e.goldbergData=t}static Parse(e,t){const i=e.goldbergData;i.faceColors=i.faceColors.map(n=>Te.FromArray(n)),i.faceCenters=i.faceCenters.map(n=>v.FromArray(n)),i.faceZaxis=i.faceZaxis.map(n=>v.FromArray(n)),i.faceXaxis=i.faceXaxis.map(n=>v.FromArray(n)),i.faceYaxis=i.faceYaxis.map(n=>v.FromArray(n));const s=new _b(e.name,t);return s.goldbergData=i,s}}function Yp(r){const e=r.pattern||G.NO_FLIP,t=r.tileWidth||r.tileSize||1,i=r.tileHeight||r.tileSize||1,s=r.alignHorizontal||0,n=r.alignVertical||0,o=r.width||r.size||1,a=Math.floor(o/t);let l=o-a*t;const c=r.height||r.size||1,h=Math.floor(c/i);let u=c-h*i;const d=t*a/2,f=i*h/2;let p=0,_=0,m=0,g=0,b=0,y=0;if(l>0||u>0){switch(m=-d,g=-f,b=d,y=f,s){case G.CENTER:l/=2,m-=l,b+=l;break;case G.LEFT:b+=l,p=-l/2;break;case G.RIGHT:m-=l,p=l/2}switch(n){case G.CENTER:u/=2,g-=u,y+=u;break;case G.BOTTOM:y+=u,_=-u/2;break;case G.TOP:g-=u,_=u/2}}const T=[],x=[],S=[];S[0]=[0,0,1,0,1,1,0,1],S[1]=[0,0,1,0,1,1,0,1],(e===G.ROTATE_TILE||e===G.ROTATE_ROW)&&(S[1]=[1,1,0,1,0,0,1,0]),(e===G.FLIP_TILE||e===G.FLIP_ROW)&&(S[1]=[1,0,0,0,0,1,1,1]),(e===G.FLIP_N_ROTATE_TILE||e===G.FLIP_N_ROTATE_ROW)&&(S[1]=[0,1,1,1,1,0,0,0]);let C=[];const D=[],P=[];let M=0;for(let te=0;te<h;te++)for(let J=0;J<a;J++)T.push(J*t-d+p,te*i-f+_,0),T.push((J+1)*t-d+p,te*i-f+_,0),T.push((J+1)*t-d+p,(te+1)*i-f+_,0),T.push(J*t-d+p,(te+1)*i-f+_,0),P.push(M,M+1,M+3,M+1,M+2,M+3),C=C.concat(e===G.FLIP_TILE||e===G.ROTATE_TILE||e===G.FLIP_N_ROTATE_TILE?S[(J%2+te%2)%2]:e===G.FLIP_ROW||e===G.ROTATE_ROW||e===G.FLIP_N_ROTATE_ROW?S[te%2]:S[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),x.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1),M+=4;if(l>0||u>0){const te=u>0&&(n===G.CENTER||n===G.TOP),J=u>0&&(n===G.CENTER||n===G.BOTTOM),Q=l>0&&(s===G.CENTER||s===G.RIGHT),me=l>0&&(s===G.CENTER||s===G.LEFT);let W,K,O,H,ae=[];if(te&&Q&&(T.push(m+p,g+_,0),T.push(-d+p,g+_,0),T.push(-d+p,g+u+_,0),T.push(m+p,g+u+_,0),P.push(M,M+1,M+3,M+1,M+2,M+3),M+=4,W=1-l/t,K=1-u/i,O=1,H=1,ae=[W,K,O,K,O,H,W,H],e===G.ROTATE_ROW&&(ae=[1-W,1-K,1-O,1-K,1-O,1-H,1-W,1-H]),e===G.FLIP_ROW&&(ae=[1-W,K,1-O,K,1-O,H,1-W,H]),e===G.FLIP_N_ROTATE_ROW&&(ae=[W,1-K,O,1-K,O,1-H,W,1-H]),C=C.concat(ae),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),x.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),te&&me&&(T.push(d+p,g+_,0),T.push(b+p,g+_,0),T.push(b+p,g+u+_,0),T.push(d+p,g+u+_,0),P.push(M,M+1,M+3,M+1,M+2,M+3),M+=4,W=0,K=1-u/i,O=l/t,H=1,ae=[W,K,O,K,O,H,W,H],(e===G.ROTATE_ROW||e===G.ROTATE_TILE&&a%2==0)&&(ae=[1-W,1-K,1-O,1-K,1-O,1-H,1-W,1-H]),(e===G.FLIP_ROW||e===G.FLIP_TILE&&a%2==0)&&(ae=[1-W,K,1-O,K,1-O,H,1-W,H]),(e===G.FLIP_N_ROTATE_ROW||e===G.FLIP_N_ROTATE_TILE&&a%2==0)&&(ae=[W,1-K,O,1-K,O,1-H,W,1-H]),C=C.concat(ae),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),x.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),J&&Q&&(T.push(m+p,f+_,0),T.push(-d+p,f+_,0),T.push(-d+p,y+_,0),T.push(m+p,y+_,0),P.push(M,M+1,M+3,M+1,M+2,M+3),M+=4,W=1-l/t,K=0,O=1,H=u/i,ae=[W,K,O,K,O,H,W,H],(e===G.ROTATE_ROW&&h%2==1||e===G.ROTATE_TILE&&h%1==0)&&(ae=[1-W,1-K,1-O,1-K,1-O,1-H,1-W,1-H]),(e===G.FLIP_ROW&&h%2==1||e===G.FLIP_TILE&&h%2==0)&&(ae=[1-W,K,1-O,K,1-O,H,1-W,H]),(e===G.FLIP_N_ROTATE_ROW&&h%2==1||e===G.FLIP_N_ROTATE_TILE&&h%2==0)&&(ae=[W,1-K,O,1-K,O,1-H,W,1-H]),C=C.concat(ae),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),x.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),J&&me&&(T.push(d+p,f+_,0),T.push(b+p,f+_,0),T.push(b+p,y+_,0),T.push(d+p,y+_,0),P.push(M,M+1,M+3,M+1,M+2,M+3),M+=4,W=0,K=0,O=l/t,H=u/i,ae=[W,K,O,K,O,H,W,H],(e===G.ROTATE_ROW&&h%2==1||e===G.ROTATE_TILE&&(h+a)%2==1)&&(ae=[1-W,1-K,1-O,1-K,1-O,1-H,1-W,1-H]),(e===G.FLIP_ROW&&h%2==1||e===G.FLIP_TILE&&(h+a)%2==1)&&(ae=[1-W,K,1-O,K,1-O,H,1-W,H]),(e===G.FLIP_N_ROTATE_ROW&&h%2==1||e===G.FLIP_N_ROTATE_TILE&&(h+a)%2==1)&&(ae=[W,1-K,O,1-K,O,1-H,W,1-H]),C=C.concat(ae),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),x.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),te){const Y=[];W=0,K=1-u/i,O=1,H=1,Y[0]=[W,K,O,K,O,H,W,H],Y[1]=[W,K,O,K,O,H,W,H],(e===G.ROTATE_TILE||e===G.ROTATE_ROW)&&(Y[1]=[1-W,1-K,1-O,1-K,1-O,1-H,1-W,1-H]),(e===G.FLIP_TILE||e===G.FLIP_ROW)&&(Y[1]=[1-W,K,1-O,K,1-O,H,1-W,H]),(e===G.FLIP_N_ROTATE_TILE||e===G.FLIP_N_ROTATE_ROW)&&(Y[1]=[W,1-K,O,1-K,O,1-H,W,1-H]);for(let he=0;he<a;he++)T.push(he*t-d+p,g+_,0),T.push((he+1)*t-d+p,g+_,0),T.push((he+1)*t-d+p,g+u+_,0),T.push(he*t-d+p,g+u+_,0),P.push(M,M+1,M+3,M+1,M+2,M+3),M+=4,C=C.concat(e===G.FLIP_TILE||e===G.ROTATE_TILE||e===G.FLIP_N_ROTATE_TILE?Y[(he+1)%2]:e===G.FLIP_ROW||e===G.ROTATE_ROW||e===G.FLIP_N_ROTATE_ROW?Y[1]:Y[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),x.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(J){const Y=[];W=0,K=0,O=1,H=u/i,Y[0]=[W,K,O,K,O,H,W,H],Y[1]=[W,K,O,K,O,H,W,H],(e===G.ROTATE_TILE||e===G.ROTATE_ROW)&&(Y[1]=[1-W,1-K,1-O,1-K,1-O,1-H,1-W,1-H]),(e===G.FLIP_TILE||e===G.FLIP_ROW)&&(Y[1]=[1-W,K,1-O,K,1-O,H,1-W,H]),(e===G.FLIP_N_ROTATE_TILE||e===G.FLIP_N_ROTATE_ROW)&&(Y[1]=[W,1-K,O,1-K,O,1-H,W,1-H]);for(let he=0;he<a;he++)T.push(he*t-d+p,y-u+_,0),T.push((he+1)*t-d+p,y-u+_,0),T.push((he+1)*t-d+p,y+_,0),T.push(he*t-d+p,y+_,0),P.push(M,M+1,M+3,M+1,M+2,M+3),M+=4,C=C.concat(e===G.FLIP_TILE||e===G.ROTATE_TILE||e===G.FLIP_N_ROTATE_TILE?Y[(he+h)%2]:e===G.FLIP_ROW||e===G.ROTATE_ROW||e===G.FLIP_N_ROTATE_ROW?Y[h%2]:Y[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),x.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(Q){const Y=[];W=1-l/t,K=0,O=1,H=1,Y[0]=[W,K,O,K,O,H,W,H],Y[1]=[W,K,O,K,O,H,W,H],(e===G.ROTATE_TILE||e===G.ROTATE_ROW)&&(Y[1]=[1-W,1-K,1-O,1-K,1-O,1-H,1-W,1-H]),(e===G.FLIP_TILE||e===G.FLIP_ROW)&&(Y[1]=[1-W,K,1-O,K,1-O,H,1-W,H]),(e===G.FLIP_N_ROTATE_TILE||e===G.FLIP_N_ROTATE_ROW)&&(Y[1]=[W,1-K,O,1-K,O,1-H,W,1-H]);for(let he=0;he<h;he++)T.push(m+p,he*i-f+_,0),T.push(m+l+p,he*i-f+_,0),T.push(m+l+p,(he+1)*i-f+_,0),T.push(m+p,(he+1)*i-f+_,0),P.push(M,M+1,M+3,M+1,M+2,M+3),M+=4,C=C.concat(e===G.FLIP_TILE||e===G.ROTATE_TILE||e===G.FLIP_N_ROTATE_TILE?Y[(he+1)%2]:e===G.FLIP_ROW||e===G.ROTATE_ROW||e===G.FLIP_N_ROTATE_ROW?Y[he%2]:Y[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),x.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(me){const Y=[];W=0,K=0,O=l/i,H=1,Y[0]=[W,K,O,K,O,H,W,H],Y[1]=[W,K,O,K,O,H,W,H],(e===G.ROTATE_TILE||e===G.ROTATE_ROW)&&(Y[1]=[1-W,1-K,1-O,1-K,1-O,1-H,1-W,1-H]),(e===G.FLIP_TILE||e===G.FLIP_ROW)&&(Y[1]=[1-W,K,1-O,K,1-O,H,1-W,H]),(e===G.FLIP_N_ROTATE_TILE||e===G.FLIP_N_ROTATE_ROW)&&(Y[1]=[W,1-K,O,1-K,O,1-H,W,1-H]);for(let he=0;he<h;he++)T.push(b-l+p,he*i-f+_,0),T.push(b+p,he*i-f+_,0),T.push(b+p,(he+1)*i-f+_,0),T.push(b-l+p,(he+1)*i-f+_,0),P.push(M,M+1,M+3,M+1,M+2,M+3),M+=4,C=C.concat(e===G.FLIP_TILE||e===G.ROTATE_TILE||e===G.FLIP_N_ROTATE_TILE?Y[(he+a)%2]:e===G.FLIP_ROW||e===G.ROTATE_ROW||e===G.FLIP_N_ROTATE_ROW?Y[he%2]:Y[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),x.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}}const w=0===r.sideOrientation?0:r.sideOrientation||ue.DEFAULTSIDE;ue._ComputeSides(w,T,P,x,C,r.frontUVs,r.backUVs);const k=new ue;k.indices=P,k.positions=T,k.normals=x,k.uvs=C;const X=w===ue.DOUBLESIDE?D.concat(D):D;return k.colors=X,k}function uz(r){const t=r.faceUV||new Array(6),i=r.faceColors,s=r.pattern||G.NO_FLIP,n=r.width||r.size||1,o=r.height||r.size||1,a=r.depth||r.size||1,l=r.tileWidth||r.tileSize||1,c=r.tileHeight||r.tileSize||1,h=r.alignHorizontal||0,u=r.alignVertical||0,d=0===r.sideOrientation?0:r.sideOrientation||ue.DEFAULTSIDE;for(let O=0;O<6;O++)void 0===t[O]&&(t[O]=new vt(0,0,1,1)),i&&void 0===i[O]&&(i[O]=new Te(1,1,1,1));const f=n/2,p=o/2,_=a/2,m=[];for(let O=0;O<2;O++)m[O]=Yp({pattern:s,tileWidth:l,tileHeight:c,width:n,height:o,alignVertical:u,alignHorizontal:h,sideOrientation:d});for(let O=2;O<4;O++)m[O]=Yp({pattern:s,tileWidth:l,tileHeight:c,width:a,height:o,alignVertical:u,alignHorizontal:h,sideOrientation:d});let g=u;u===G.BOTTOM?g=G.TOP:u===G.TOP&&(g=G.BOTTOM);for(let O=4;O<6;O++)m[O]=Yp({pattern:s,tileWidth:l,tileHeight:c,width:n,height:a,alignVertical:g,alignHorizontal:h,sideOrientation:d});let b=[],y=[],T=[],x=[];const S=[],C=[],D=[],P=[];let M=0,w=0;for(let O=0;O<6;O++){const H=m[O].positions.length;C[O]=[],D[O]=[];for(let Y=0;Y<H/3;Y++)C[O].push(new v(m[O].positions[3*Y],m[O].positions[3*Y+1],m[O].positions[3*Y+2])),D[O].push(new v(m[O].normals[3*Y],m[O].normals[3*Y+1],m[O].normals[3*Y+2]));M=m[O].uvs.length,P[O]=[];for(let Y=0;Y<M;Y+=2)P[O][Y]=t[O].x+(t[O].z-t[O].x)*m[O].uvs[Y],P[O][Y+1]=t[O].y+(t[O].w-t[O].y)*m[O].uvs[Y+1],It.UseOpenGLOrientationForUV&&(P[O][Y+1]=1-P[O][Y+1]);if(T=T.concat(P[O]),x=x.concat(m[O].indices.map(Y=>Y+w)),w+=C[O].length,i)for(let Y=0;Y<4;Y++)S.push(i[O].r,i[O].g,i[O].b,i[O].a)}const k=new v(0,0,_),X=F.RotationY(Math.PI);b=C[0].map(O=>v.TransformNormal(O,X).add(k)).map(O=>[O.x,O.y,O.z]).reduce((O,H)=>O.concat(H),[]),y=D[0].map(O=>v.TransformNormal(O,X)).map(O=>[O.x,O.y,O.z]).reduce((O,H)=>O.concat(H),[]),b=b.concat(C[1].map(O=>O.subtract(k)).map(O=>[O.x,O.y,O.z]).reduce((O,H)=>O.concat(H),[])),y=y.concat(D[1].map(O=>[O.x,O.y,O.z]).reduce((O,H)=>O.concat(H),[]));const te=new v(f,0,0),J=F.RotationY(-Math.PI/2);b=b.concat(C[2].map(O=>v.TransformNormal(O,J).add(te)).map(O=>[O.x,O.y,O.z]).reduce((O,H)=>O.concat(H),[])),y=y.concat(D[2].map(O=>v.TransformNormal(O,J)).map(O=>[O.x,O.y,O.z]).reduce((O,H)=>O.concat(H),[]));const Q=F.RotationY(Math.PI/2);b=b.concat(C[3].map(O=>v.TransformNormal(O,Q).subtract(te)).map(O=>[O.x,O.y,O.z]).reduce((O,H)=>O.concat(H),[])),y=y.concat(D[3].map(O=>v.TransformNormal(O,Q)).map(O=>[O.x,O.y,O.z]).reduce((O,H)=>O.concat(H),[]));const me=new v(0,p,0),ae=F.RotationX(Math.PI/2);b=b.concat(C[4].map(O=>v.TransformNormal(O,ae).add(me)).map(O=>[O.x,O.y,O.z]).reduce((O,H)=>O.concat(H),[])),y=y.concat(D[4].map(O=>v.TransformNormal(O,ae)).map(O=>[O.x,O.y,O.z]).reduce((O,H)=>O.concat(H),[]));const W=F.RotationX(-Math.PI/2);b=b.concat(C[5].map(O=>v.TransformNormal(O,W).subtract(me)).map(O=>[O.x,O.y,O.z]).reduce((O,H)=>O.concat(H),[])),y=y.concat(D[5].map(O=>v.TransformNormal(O,W)).map(O=>[O.x,O.y,O.z]).reduce((O,H)=>O.concat(H),[])),ue._ComputeSides(d,b,x,y,T);const K=new ue;if(K.indices=x,K.positions=b,K.normals=y,K.uvs=T,i){const O=d===ue.DOUBLESIDE?S.concat(S):S;K.colors=O}return K}function fz(r){const e=new Array,t=new Array,i=new Array,s=new Array,n=r.radius||2,o=r.tube||.5,a=r.radialSegments||32,l=r.tubularSegments||32,c=r.p||2,h=r.q||3,u=0===r.sideOrientation?0:r.sideOrientation||ue.DEFAULTSIDE,d=m=>{const g=Math.cos(m),b=Math.sin(m),y=h/c*m,T=Math.cos(y),x=n*(2+T)*.5*g,S=n*(2+T)*b*.5,C=n*Math.sin(y)*.5;return new v(x,S,C)};let f,p;for(f=0;f<=a;f++){const g=f%a/a*2*c*Math.PI,b=d(g),y=d(g+.01),T=y.subtract(b);let x=y.add(b);const S=v.Cross(T,x);for(x=v.Cross(S,T),S.normalize(),x.normalize(),p=0;p<l;p++){const D=p%l/l*2*Math.PI,P=-o*Math.cos(D),M=o*Math.sin(D);t.push(b.x+P*x.x+M*S.x),t.push(b.y+P*x.y+M*S.y),t.push(b.z+P*x.z+M*S.z),s.push(f/a),s.push(It.UseOpenGLOrientationForUV?1-p/l:p/l)}}for(f=0;f<a;f++)for(p=0;p<l;p++){const m=(p+1)%l,g=f*l+p,b=(f+1)*l+p,y=(f+1)*l+m,T=f*l+m;e.push(T),e.push(b),e.push(g),e.push(T),e.push(y),e.push(b)}ue.ComputeNormals(t,e,i),ue._ComputeSides(u,t,e,i,s,r.frontUVs,r.backUVs);const _=new ue;return _.indices=e,_.positions=t,_.normals=i,_.uvs=s,_}function KC(r,e={},t){const i=new G(r,t);return e.sideOrientation=G._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,fz(e).applyToMesh(i,e.updatable),i}ue.CreateTiledPlane=Yp,ue.CreateTiledBox=uz,ue.CreateTorusKnot=fz,G.CreateTorusKnot=(r,e,t,i,s,n,o,a,l,c)=>KC(r,{radius:e,tube:t,radialSegments:i,tubularSegments:s,p:n,q:o,sideOrientation:c,updatable:l},a);class kae extends de{constructor(e,t){super(e.x,e.y),this.index=t}}class QC{constructor(){this.elements=new Array}add(e){const t=new Array;return e.forEach(i=>{const s=new kae(i,this.elements.length);t.push(s),this.elements.push(s)}),t}computeBounds(){const e=new de(this.elements[0].x,this.elements[0].y),t=new de(this.elements[0].x,this.elements[0].y);return this.elements.forEach(i=>{i.x<e.x?e.x=i.x:i.x>t.x&&(t.x=i.x),i.y<e.y?e.y=i.y:i.y>t.y&&(t.y=i.y)}),{min:e,max:t,width:t.x-e.x,height:t.y-e.y}}}class Gae{_addToepoint(e){for(const t of e)this._epoints.push(t.x,t.y)}constructor(e,t,i,s=earcut){let n;this._points=new QC,this._outlinepoints=new QC,this._holes=new Array,this._epoints=new Array,this._eholes=new Array,this.bjsEarcut=s,this._name=e,this._scene=i||be.LastCreatedScene,n=t instanceof vE?t.getPoints():t,this._addToepoint(n),this._points.add(n),this._outlinepoints.add(n),typeof this.bjsEarcut>"u"&&V.Warn("Earcut was not found, the polygon will not be built.")}addHole(e){this._points.add(e);const t=new QC;return t.add(e),this._holes.push(t),this._eholes.push(this._epoints.length/2),this._addToepoint(e),this}build(e=!1,t=0,i=2){const s=new G(this._name,this._scene),n=this.buildVertexData(t,i);return s.setVerticesData(A.PositionKind,n.positions,e),s.setVerticesData(A.NormalKind,n.normals,e),s.setVerticesData(A.UVKind,n.uvs,e),s.setIndices(n.indices),s}buildVertexData(e=0,t=2){const i=new ue,s=new Array,n=new Array,o=new Array,a=this._points.computeBounds();this._points.elements.forEach(h=>{s.push(0,1,0),n.push(h.x,0,h.y),o.push((h.x-a.min.x)/a.width,(h.y-a.min.y)/a.height)});const l=new Array,c=this.bjsEarcut(this._epoints,this._eholes,2);for(let h=0;h<c.length;h++)l.push(c[h]);if(e>0){const h=n.length/3;this._points.elements.forEach(d=>{s.push(0,-1,0),n.push(d.x,-e,d.y),o.push(1-(d.x-a.min.x)/a.width,1-(d.y-a.min.y)/a.height)});const u=l.length;for(let d=0;d<u;d+=3){const f=l[d+0],p=l[d+1];l.push(l[d+2]+h),l.push(p+h),l.push(f+h)}this._addSide(n,s,o,l,a,this._outlinepoints,e,!1,t),this._holes.forEach(d=>{this._addSide(n,s,o,l,a,d,e,!0,t)})}return i.indices=l,i.positions=n,i.normals=s,i.uvs=o,i}_addSide(e,t,i,s,n,o,a,l,c){let h=e.length/3,u=0;for(let d=0;d<o.elements.length;d++){const f=o.elements[d],p=o.elements[(d+1)%o.elements.length];e.push(f.x,0,f.y),e.push(f.x,-a,f.y),e.push(p.x,0,p.y),e.push(p.x,-a,p.y);const _=o.elements[(d+o.elements.length-1)%o.elements.length],m=o.elements[(d+2)%o.elements.length];let g=new v(-(p.y-f.y),0,p.x-f.x),b=new v(-(f.y-_.y),0,f.x-_.x),y=new v(-(m.y-p.y),0,m.x-p.x);l||(g=g.scale(-1),b=b.scale(-1),y=y.scale(-1));const T=g.normalizeToNew();let x=b.normalizeToNew(),S=y.normalizeToNew();const C=v.Dot(x,T);x=C>c?C<ot-1?new v(f.x,0,f.y).subtract(new v(p.x,0,p.y)).normalize():b.add(g).normalize():T;const D=v.Dot(y,g);S=D>c?D<ot-1?new v(p.x,0,p.y).subtract(new v(f.x,0,f.y)).normalize():y.add(g).normalize():T,i.push(u/n.width,0),i.push(u/n.width,1),u+=g.length(),i.push(u/n.width,0),i.push(u/n.width,1),t.push(x.x,x.y,x.z),t.push(x.x,x.y,x.z),t.push(S.x,S.y,S.z),t.push(S.x,S.y,S.z),l?(s.push(h),s.push(h+2),s.push(h+1),s.push(h+1),s.push(h+2),s.push(h+3)):(s.push(h),s.push(h+1),s.push(h+2),s.push(h+1),s.push(h+3),s.push(h+2)),h+=4}}}function pz(r,e,t,i,s,n,o){const a=t||new Array(3),l=i,c=[],h=o||!1;for(let P=0;P<3;P++)void 0===a[P]&&(a[P]=new vt(0,0,1,1)),l&&void 0===l[P]&&(l[P]=new Te(1,1,1,1));const u=r.getVerticesData(A.PositionKind),d=r.getVerticesData(A.NormalKind),f=r.getVerticesData(A.UVKind),p=r.getIndices(),_=u.length/9;let m=0,g=0,b=0,y=0,T=0;const x=[0];if(h)for(let P=_;P<u.length/3;P+=4)g=u[3*(P+2)]-u[3*P],b=u[3*(P+2)+2]-u[3*P+2],y=Math.sqrt(g*g+b*b),T+=y,x.push(T);let S=0,C=0;for(let P=0;P<d.length;P+=3)Math.abs(d[P+1])<.001&&(C=1),Math.abs(d[P+1]-1)<.001&&(C=0),Math.abs(d[P+1]+1)<.001&&(C=2),S=P/3,1===C?(m=S-_,f[2*S]=m%4<1.5?h?a[C].x+(a[C].z-a[C].x)*x[Math.floor(m/4)]/T:a[C].x:h?a[C].x+(a[C].z-a[C].x)*x[Math.floor(m/4)+1]/T:a[C].z,f[2*S+1]=m%2==0?It.UseOpenGLOrientationForUV?1-a[C].w:a[C].w:It.UseOpenGLOrientationForUV?1-a[C].y:a[C].y):(f[2*S]=(1-f[2*S])*a[C].x+f[2*S]*a[C].z,f[2*S+1]=(1-f[2*S+1])*a[C].y+f[2*S+1]*a[C].w,It.UseOpenGLOrientationForUV&&(f[2*S+1]=1-f[2*S+1])),l&&c.push(l[C].r,l[C].g,l[C].b,l[C].a);ue._ComputeSides(e,u,p,d,f,s,n);const D=new ue;if(D.indices=p,D.positions=u,D.normals=d,D.uvs=f,l){const P=e===ue.DOUBLESIDE?c.concat(c):c;D.colors=P}return D}function mb(r,e,t=null,i=earcut){e.sideOrientation=G._GetDefaultSideOrientation(e.sideOrientation);const s=e.shape,n=e.holes||[],o=e.depth||0,a=e.smoothingThreshold||2,l=[];let c=[];for(let p=0;p<s.length;p++)l[p]=new de(s[p].x,s[p].z);l[0].equalsWithEpsilon(l[l.length-1],1e-8)&&l.pop();const u=new Gae(r,l,t||be.LastCreatedScene,i);for(let p=0;p<n.length;p++){c=[];for(let _=0;_<n[p].length;_++)c.push(new de(n[p][_].x,n[p][_].z));u.addHole(c)}const d=u.build(!1,o,a);return d._originalBuilderSideOrientation=e.sideOrientation,pz(d,e.sideOrientation,e.faceUV,e.faceColors,e.frontUVs,e.backUVs,e.wrap).applyToMesh(d,e.updatable),d}function ZC(r,e,t=null,i=earcut){return mb(r,e,t,i)}function JC(r,e,t=null){const i=e.arc?e.arc<=0||e.arc>1?1:e.arc:1,s=void 0===e.closed||e.closed,n=e.shape,o=e.radius||1,a=e.tessellation||64,l=e.clip||0,c=e.updatable,h=G._GetDefaultSideOrientation(e.sideOrientation),u=e.cap||G.NO_CAP,d=2*Math.PI,f=new Array,p=e.invertUV||!1;let _=0,m=0;const g=d/a*i;let b,y;for(_=0;_<=a-l;_++){for(y=[],(u==G.CAP_START||u==G.CAP_ALL)&&(y.push(new v(0,n[0].y,0)),y.push(new v(Math.cos(_*g)*n[0].x*o,n[0].y,Math.sin(_*g)*n[0].x*o))),m=0;m<n.length;m++)b=new v(Math.cos(_*g)*n[m].x*o,n[m].y,Math.sin(_*g)*n[m].x*o),y.push(b);(u==G.CAP_END||u==G.CAP_ALL)&&(y.push(new v(Math.cos(_*g)*n[n.length-1].x*o,n[n.length-1].y,Math.sin(_*g)*n[n.length-1].x*o)),y.push(new v(0,n[n.length-1].y,0))),f.push(y)}return nc(r,{pathArray:f,closeArray:s,sideOrientation:h,updatable:c,invertUV:p,frontUVs:e.frontUVs,backUVs:e.backUVs},t)}function e0(r,e,t=null){const i=e.path;let s=e.instance,n=1;void 0!==e.radius?n=e.radius:s&&(n=s._creationDataStorage.radius);const o=e.tessellation||64,a=e.radiusFunction||null;let l=e.cap||G.NO_CAP;const c=e.invertUV||!1,h=e.updatable,u=G._GetDefaultSideOrientation(e.sideOrientation);e.arc=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1;const d=(g,b,y,T,x,S,C,D)=>{const P=b.getTangents(),M=b.getNormals(),w=b.getDistances(),X=2*Math.PI/x*D,J=S||(()=>T);let Q,me,ae,W;const K=L.Matrix[0];let O=C===G.NO_CAP||C===G.CAP_END?0:2;for(let Y=0;Y<g.length;Y++){me=J(Y,w[Y]),Q=Array(),ae=M[Y];for(let he=0;he<x;he++)F.RotationAxisToRef(P[Y],X*he,K),W=Q[he]?Q[he]:v.Zero(),v.TransformCoordinatesToRef(ae,K,W),W.scaleInPlace(me).addInPlace(g[Y]),Q[he]=W;y[O]=Q,O++}const H=(Y,he)=>{const Le=Array();for(let Fe=0;Fe<Y;Fe++)Le.push(g[he]);return Le};switch(C){case G.NO_CAP:break;case G.CAP_START:y[0]=H(x,0),y[1]=y[2].slice(0);break;case G.CAP_END:y[O]=y[O-1].slice(0),y[O+1]=H(x,g.length-1);break;case G.CAP_ALL:y[0]=H(x,0),y[1]=y[2].slice(0),y[O]=y[O-1].slice(0),y[O+1]=H(x,g.length-1)}return y};let f,p;if(s){const g=s._creationDataStorage,b=e.arc||g.arc;return f=g.path3D.update(i),p=d(i,f,g.pathArray,n,g.tessellation,a,g.cap,b),s=nc("",{pathArray:p,instance:s}),g.path3D=f,g.pathArray=p,g.arc=b,g.radius=n,s}f=new pp(i),l=l<0||l>3?0:l,p=d(i,f,new Array,n,o,a,l,e.arc);const m=nc(r,{pathArray:p,closePath:!0,closeArray:!1,updatable:h,sideOrientation:u,invertUV:c,frontUVs:e.frontUVs,backUVs:e.backUVs},t);return m._creationDataStorage.pathArray=p,m._creationDataStorage.path3D=f,m._creationDataStorage.tessellation=o,m._creationDataStorage.cap=l,m._creationDataStorage.arc=e.arc,m._creationDataStorage.radius=n,m}ue.CreatePolygon=pz,G.CreatePolygon=(r,e,t,i,s,n,o=earcut)=>mb(r,{shape:e,holes:i,updatable:s,sideOrientation:n},t,o),G.ExtrudePolygon=(r,e,t,i,s,n,o,a=earcut)=>ZC(r,{shape:e,holes:s,depth:t,updatable:n,sideOrientation:o},i,a),G.CreateLathe=(r,e,t,i,s,n,o)=>JC(r,{shape:e,radius:t,tessellation:i,sideOrientation:o,updatable:n},s),G.CreateTube=(r,e,t,i,s,n,o,a,l,c)=>e0(r,{path:e,radius:t,tessellation:i,radiusFunction:s,arc:1,cap:n,updatable:a,sideOrientation:l,instance:c},o);const zae=new v(1,0,0),Hae=new v(-1,0,0),Wae=new v(0,1,0),Xae=new v(0,-1,0),jae=new v(0,0,1),Yae=new v(0,0,-1);class gb{constructor(e=v.Zero(),t=v.Up(),i=de.Zero(),s=0,n=0,o=null,a=null,l=null,c=null){this.position=e,this.normal=t,this.uv=i,this.vertexIdx=s,this.vertexIdxForBones=n,this.localPositionOverride=o,this.localNormalOverride=a,this.matrixIndicesOverride=l,this.matrixWeightsOverride=c}clone(){var e,t,i,s;return new gb(this.position.clone(),this.normal.clone(),this.uv.clone(),this.vertexIdx,this.vertexIdxForBones,null===(e=this.localPositionOverride)||void 0===e?void 0:e.slice(),null===(t=this.localNormalOverride)||void 0===t?void 0:t.slice(),null===(i=this.matrixIndicesOverride)||void 0===i?void 0:i.slice(),null===(s=this.matrixWeightsOverride)||void 0===s?void 0:s.slice())}}function t0(r,e,t){const i=!!e.skeleton,s=t.localMode||i,n=null!=e.overrideMaterialSideOrientation,o=e.getIndices(),a=i?e.getPositionData(!0,!0):e.getVerticesData(A.PositionKind),l=i?e.getNormalsData(!0,!0):e.getVerticesData(A.NormalKind),c=s?i?e.getVerticesData(A.PositionKind):a:null,h=s?i?e.getVerticesData(A.NormalKind):l:null,u=e.getVerticesData(A.UVKind),d=i?e.getVerticesData(A.MatricesIndicesKind):null,f=i?e.getVerticesData(A.MatricesWeightsKind):null,p=i?e.getVerticesData(A.MatricesIndicesExtraKind):null,_=i?e.getVerticesData(A.MatricesWeightsExtraKind):null,m=t.position||v.Zero();let g=t.normal||v.Up();const b=t.size||v.One(),y=t.angle||0;if(!g){const ae=new v(0,0,1),W=e.getScene().activeCamera,K=v.TransformCoordinates(ae,W.getWorldMatrix());g=W.globalPosition.subtract(K)}const T=-Math.atan2(g.z,g.x)-Math.PI/2,x=Math.sqrt(g.x*g.x+g.z*g.z),S=Math.atan2(g.y,x),C=F.RotationYawPitchRoll(T,S,y).multiply(F.Translation(m.x,m.y,m.z)),D=F.Invert(C),M=e.getWorldMatrix().multiply(D),w=new ue;w.indices=[],w.positions=[],w.normals=[],w.uvs=[],w.matricesIndices=i?[]:null,w.matricesWeights=i?[]:null,w.matricesIndicesExtra=p?[]:null,w.matricesWeightsExtra=_?[]:null;let k=0;const X=ae=>{const W=new gb;if(!o||!a||!l)return W;const K=o[ae];if(W.vertexIdx=3*K,W.vertexIdxForBones=4*K,W.position=new v(a[3*K],a[3*K+1],a[3*K+2]),v.TransformCoordinatesToRef(W.position,M,W.position),W.normal=new v(l[3*K],l[3*K+1],l[3*K+2]),v.TransformNormalToRef(W.normal,M,W.normal),t.captureUVS&&u){const O=u[2*K+1];W.uv=new de(u[2*K],It.UseOpenGLOrientationForUV?1-O:O)}return W},te=[0,0,0,0],J=(ae,W)=>{if(0===ae.length)return ae;const K=.5*Math.abs(v.Dot(b,W)),O=(he,Le,Fe,se)=>{for(let _e=0;_e<se;++_e)if(he[Fe+_e]===Le)return Fe+_e;return-1},H=(he,Le)=>{var Fe,se,_e,rt,Ze,Ae,Ie,ct,Ct,Mt,Ke,as,Xi,gr,ri,ni;const bi=v.GetClipFactor(he.position,Le.position,W,K);let Bs=te,ji=te;if(d&&f){const bs=he.matrixIndicesOverride?0:he.vertexIdxForBones,Vh=null!==(Fe=he.matrixIndicesOverride)&&void 0!==Fe?Fe:d,S_=null!==(se=he.matrixWeightsOverride)&&void 0!==se?se:f,Pd=Le.matrixIndicesOverride?0:Le.vertexIdxForBones,E_=null!==(_e=Le.matrixIndicesOverride)&&void 0!==_e?_e:d,C_=null!==(rt=Le.matrixWeightsOverride)&&void 0!==rt?rt:f;Bs=[0,0,0,0],ji=[0,0,0,0];let En=0;for(let Br=0;Br<4;++Br)if(S_[bs+Br]>0){const Ac=O(E_,Vh[bs+Br],Pd,4);Bs[En]=Vh[bs+Br],ji[En]=oe.Lerp(S_[bs+Br],Ac>=0?C_[Ac]:0,bi),En++}for(let Br=0;Br<4&&En<4;++Br){const Ac=E_[Pd+Br];-1===O(Vh,Ac,bs,4)&&(Bs[En]=Ac,ji[En]=oe.Lerp(0,C_[Pd+Br],bi),En++)}const Ko=ji[0]+ji[1]+ji[2]+ji[3];ji[0]/=Ko,ji[1]/=Ko,ji[2]/=Ko,ji[3]/=Ko}const cn=he.localPositionOverride?he.localPositionOverride[0]:null!==(Ze=c?.[he.vertexIdx])&&void 0!==Ze?Ze:0,As=he.localPositionOverride?he.localPositionOverride[1]:null!==(Ae=c?.[he.vertexIdx+1])&&void 0!==Ae?Ae:0,Ca=he.localPositionOverride?he.localPositionOverride[2]:null!==(Ie=c?.[he.vertexIdx+2])&&void 0!==Ie?Ie:0,Aa=Le.localPositionOverride?Le.localPositionOverride[0]:null!==(ct=c?.[Le.vertexIdx])&&void 0!==ct?ct:0,Al=Le.localPositionOverride?Le.localPositionOverride[1]:null!==(Ct=c?.[Le.vertexIdx+1])&&void 0!==Ct?Ct:0,yi=Le.localPositionOverride?Le.localPositionOverride[2]:null!==(Mt=c?.[Le.vertexIdx+2])&&void 0!==Mt?Mt:0,Rd=he.localNormalOverride?he.localNormalOverride[0]:null!==(Ke=h?.[he.vertexIdx])&&void 0!==Ke?Ke:0,Id=he.localNormalOverride?he.localNormalOverride[1]:null!==(as=h?.[he.vertexIdx+1])&&void 0!==as?as:0,T_=he.localNormalOverride?he.localNormalOverride[2]:null!==(Xi=h?.[he.vertexIdx+2])&&void 0!==Xi?Xi:0,Md=Rd+((Le.localNormalOverride?Le.localNormalOverride[0]:null!==(gr=h?.[Le.vertexIdx])&&void 0!==gr?gr:0)-Rd)*bi,Ec=Id+((Le.localNormalOverride?Le.localNormalOverride[1]:null!==(ri=h?.[Le.vertexIdx+1])&&void 0!==ri?ri:0)-Id)*bi,Bh=T_+((Le.localNormalOverride?Le.localNormalOverride[2]:null!==(ni=h?.[Le.vertexIdx+2])&&void 0!==ni?ni:0)-T_)*bi,Cc=Math.sqrt(Md*Md+Ec*Ec+Bh*Bh);return new gb(v.Lerp(he.position,Le.position,bi),v.Lerp(he.normal,Le.normal,bi).normalize(),de.Lerp(he.uv,Le.uv,bi),-1,-1,c?[cn+(Aa-cn)*bi,As+(Al-As)*bi,Ca+(yi-Ca)*bi]:null,h?[Md/Cc,Ec/Cc,Bh/Cc]:null,Bs,ji)};let Y=null;ae.length>3&&(Y=new Array);for(let he=0;he<ae.length;he+=3){let Le=0,Fe=null,se=null,_e=null,rt=null;const ct=v.Dot(ae[he].position,W)-K>0,Ct=v.Dot(ae[he+1].position,W)-K>0,Mt=v.Dot(ae[he+2].position,W)-K>0;switch(Le=(ct?1:0)+(Ct?1:0)+(Mt?1:0),Le){case 0:ae.length>3?(Y.push(ae[he]),Y.push(ae[he+1]),Y.push(ae[he+2])):Y=ae;break;case 1:if(Y=Y??new Array,ct&&(Fe=ae[he+1],se=ae[he+2],_e=H(ae[he],Fe),rt=H(ae[he],se)),Ct){Fe=ae[he],se=ae[he+2],_e=H(ae[he+1],Fe),rt=H(ae[he+1],se),Y.push(_e),Y.push(se.clone()),Y.push(Fe.clone()),Y.push(se.clone()),Y.push(_e.clone()),Y.push(rt);break}Mt&&(Fe=ae[he],se=ae[he+1],_e=H(ae[he+2],Fe),rt=H(ae[he+2],se)),Fe&&se&&_e&&rt&&(Y.push(Fe.clone()),Y.push(se.clone()),Y.push(_e),Y.push(rt),Y.push(_e.clone()),Y.push(se.clone()));break;case 2:Y=Y??new Array,ct||(Fe=ae[he].clone(),se=H(Fe,ae[he+1]),_e=H(Fe,ae[he+2]),Y.push(Fe),Y.push(se),Y.push(_e)),Ct||(Fe=ae[he+1].clone(),se=H(Fe,ae[he+2]),_e=H(Fe,ae[he]),Y.push(Fe),Y.push(se),Y.push(_e)),Mt||(Fe=ae[he+2].clone(),se=H(Fe,ae[he]),_e=H(Fe,ae[he+1]),Y.push(Fe),Y.push(se),Y.push(_e))}}return Y},Q=new Array(3);for(let ae=0;ae<o.length;ae+=3){let W=Q;if(W[0]=X(ae),n&&s?(W[1]=X(ae+2),W[2]=X(ae+1)):(W[1]=X(ae+1),W[2]=X(ae+2)),!(t.cullBackFaces&&-W[0].normal.z<=0&&-W[1].normal.z<=0&&-W[2].normal.z<=0)&&(W=J(W,zae),W&&(W=J(W,Hae),W&&(W=J(W,Wae),W&&(W=J(W,Xae),W&&(W=J(W,jae),W&&(W=J(W,Yae),W)))))))for(let K=0;K<W.length;K++){const O=W[K];if(w.indices.push(k),s?(O.localPositionOverride?(w.positions[3*k]=O.localPositionOverride[0],w.positions[3*k+1]=O.localPositionOverride[1],w.positions[3*k+2]=O.localPositionOverride[2]):c&&(w.positions[3*k]=c[O.vertexIdx],w.positions[3*k+1]=c[O.vertexIdx+1],w.positions[3*k+2]=c[O.vertexIdx+2]),O.localNormalOverride?(w.normals[3*k]=O.localNormalOverride[0],w.normals[3*k+1]=O.localNormalOverride[1],w.normals[3*k+2]=O.localNormalOverride[2]):h&&(w.normals[3*k]=h[O.vertexIdx],w.normals[3*k+1]=h[O.vertexIdx+1],w.normals[3*k+2]=h[O.vertexIdx+2])):(O.position.toArray(w.positions,3*k),O.normal.toArray(w.normals,3*k)),w.matricesIndices&&w.matricesWeights&&(O.matrixIndicesOverride?(w.matricesIndices[4*k]=O.matrixIndicesOverride[0],w.matricesIndices[4*k+1]=O.matrixIndicesOverride[1],w.matricesIndices[4*k+2]=O.matrixIndicesOverride[2],w.matricesIndices[4*k+3]=O.matrixIndicesOverride[3]):(d&&(w.matricesIndices[4*k]=d[O.vertexIdxForBones],w.matricesIndices[4*k+1]=d[O.vertexIdxForBones+1],w.matricesIndices[4*k+2]=d[O.vertexIdxForBones+2],w.matricesIndices[4*k+3]=d[O.vertexIdxForBones+3]),p&&w.matricesIndicesExtra&&(w.matricesIndicesExtra[4*k]=p[O.vertexIdxForBones],w.matricesIndicesExtra[4*k+1]=p[O.vertexIdxForBones+1],w.matricesIndicesExtra[4*k+2]=p[O.vertexIdxForBones+2],w.matricesIndicesExtra[4*k+3]=p[O.vertexIdxForBones+3])),O.matrixWeightsOverride?(w.matricesWeights[4*k]=O.matrixWeightsOverride[0],w.matricesWeights[4*k+1]=O.matrixWeightsOverride[1],w.matricesWeights[4*k+2]=O.matrixWeightsOverride[2],w.matricesWeights[4*k+3]=O.matrixWeightsOverride[3]):(f&&(w.matricesWeights[4*k]=f[O.vertexIdxForBones],w.matricesWeights[4*k+1]=f[O.vertexIdxForBones+1],w.matricesWeights[4*k+2]=f[O.vertexIdxForBones+2],w.matricesWeights[4*k+3]=f[O.vertexIdxForBones+3]),_&&w.matricesWeightsExtra&&(w.matricesWeightsExtra[4*k]=_[O.vertexIdxForBones],w.matricesWeightsExtra[4*k+1]=_[O.vertexIdxForBones+1],w.matricesWeightsExtra[4*k+2]=_[O.vertexIdxForBones+2],w.matricesWeightsExtra[4*k+3]=_[O.vertexIdxForBones+3]))),t.captureUVS)O.uv.toArray(w.uvs,2*k);else{w.uvs.push(.5+O.position.x/b.x);const H=.5+O.position.y/b.y;w.uvs.push(It.UseOpenGLOrientationForUV?1-H:H)}k++}}const me=new G(r,e.getScene());return w.applyToMesh(me),s?(me.skeleton=e.skeleton,me.parent=e):(me.position=m.clone(),me.rotation=new v(S,T,y)),me.computeWorldMatrix(!0),me.refreshBoundingInfo(!0,!0),me}G.CreateDecal=(r,e,t,i,s,n)=>t0(r,e,{position:t,normal:i,size:s,angle:n});class Ci{constructor(e=0,t=0){this.x=e,this.y=t,e!==Math.floor(e)&&(Math.floor(e),V.Warn("x is not an integer, floor(x) used")),t!==Math.floor(t)&&(Math.floor(t),V.Warn("y is not an integer, floor(y) used"))}clone(){return new Ci(this.x,this.y)}rotate60About(e){const t=this.x;return this.x=e.x+e.y-this.y,this.y=t+this.y-e.x,this}rotateNeg60About(e){const t=this.x;return this.x=t+this.y-e.y,this.y=e.x+e.y-t,this}rotate120(e,t){e!==Math.floor(e)&&(Math.floor(e),V.Warn("m not an integer only floor(m) used")),t!==Math.floor(t)&&(Math.floor(t),V.Warn("n not an integer only floor(n) used"));const i=this.x;return this.x=e-i-this.y,this.y=t+i,this}rotateNeg120(e,t){e!==Math.floor(e)&&(Math.floor(e),V.Warn("m is not an integer, floor(m) used")),t!==Math.floor(t)&&(Math.floor(t),V.Warn("n is not an integer,   floor(n) used"));const i=this.x;return this.x=this.y-t,this.y=e+t-i-this.y,this}toCartesianOrigin(e,t){const i=v.Zero();return i.x=e.x+2*this.x*t+this.y*t,i.y=e.y+Math.sqrt(3)*this.y*t,i}static Zero(){return new Ci(0,0)}}class _z{constructor(){this.cartesian=[],this.vertices=[],this.max=[],this.min=[],this.closestTo=[],this.innerFacets=[],this.isoVecsABOB=[],this.isoVecsOBOA=[],this.isoVecsBAOA=[],this.vertexTypes=[],this.IDATA=new s0("icosahedron","Regular",[[0,ts,-1],[-ts,1,0],[-1,0,-ts],[1,0,-ts],[ts,1,0],[0,ts,1],[-1,0,ts],[-ts,-1,0],[0,-ts,-1],[ts,-1,0],[1,0,ts],[0,-ts,1]],[[0,2,1],[0,3,2],[0,4,3],[0,5,4],[0,1,5],[7,6,1],[8,7,2],[9,8,3],[10,9,4],[6,10,5],[2,7,1],[3,8,2],[4,9,3],[5,10,4],[1,6,5],[11,6,7],[11,7,8],[11,8,9],[11,9,10],[11,10,6]])}setIndices(){let e=12;const t={},i=this.m,s=this.n;let l,c,h,u,d,n=i,o=1,a=0;0!==s&&(n=oe.HCF(i,s)),o=i/n,a=s/n;const f=Ci.Zero(),p=new Ci(i,s),_=new Ci(-s,i+s),m=Ci.Zero(),g=Ci.Zero(),b=Ci.Zero();let T,x,S,C,y=[];const D=[],P=this.vertByDist,M=(w,k,X,te)=>{T=w+"|"+X,x=k+"|"+te,T in t||x in t?T in t&&!(x in t)?t[x]=t[T]:x in t&&!(T in t)&&(t[T]=t[x]):(t[T]=e,t[x]=e,e++),D[t[T]]=P[X][0]>2?[-P[X][0],P[X][1],t[T]]:[y[P[X][0]],P[X][1],t[T]]};this.IDATA.edgematch=[[1,"B"],[2,"B"],[3,"B"],[4,"B"],[0,"B"],[10,"O",14,"A"],[11,"O",10,"A"],[12,"O",11,"A"],[13,"O",12,"A"],[14,"O",13,"A"],[0,"O"],[1,"O"],[2,"O"],[3,"O"],[4,"O"],[19,"B",5,"A"],[15,"B",6,"A"],[16,"B",7,"A"],[17,"B",8,"A"],[18,"B",9,"A"]];for(let w=0;w<20;w++){if(y=this.IDATA.face[w],h=y[2],u=y[1],d=y[0],S=f.x+"|"+f.y,T=w+"|"+S,T in t||(t[T]=h,D[h]=[y[P[S][0]],P[S][1]]),S=p.x+"|"+p.y,T=w+"|"+S,T in t||(t[T]=u,D[u]=[y[P[S][0]],P[S][1]]),S=_.x+"|"+_.y,T=w+"|"+S,T in t||(t[T]=d,D[d]=[y[P[S][0]],P[S][1]]),l=this.IDATA.edgematch[w][0],c=this.IDATA.edgematch[w][1],"B"===c)for(let k=1;k<n;k++)g.x=i-k*(o+a),g.y=s+k*o,b.x=-k*a,b.y=k*(o+a),S=g.x+"|"+g.y,C=b.x+"|"+b.y,M(w,l,S,C);if("O"===c)for(let k=1;k<n;k++)b.x=-k*a,b.y=k*(o+a),m.x=k*o,m.y=k*a,S=b.x+"|"+b.y,C=m.x+"|"+m.y,M(w,l,S,C);if(l=this.IDATA.edgematch[w][2],c=this.IDATA.edgematch[w][3],c&&"A"===c)for(let k=1;k<n;k++)m.x=k*o,m.y=k*a,g.x=i-(n-k)*(o+a),g.y=s+(n-k)*o,S=m.x+"|"+m.y,C=g.x+"|"+g.y,M(w,l,S,C);for(let k=0;k<this.vertices.length;k++)S=this.vertices[k].x+"|"+this.vertices[k].y,T=w+"|"+S,T in t||(t[T]=e++,D[t[T]]=P[S][0]>2?[-P[S][0],P[S][1],t[T]]:[y[P[S][0]],P[S][1],t[T]])}this.closestTo=D,this.vecToidx=t}calcCoeffs(){const e=this.m,t=this.n,i=Math.sqrt(3)/3,s=e*e+t*t+e*t;this.coau=(e+t)/s,this.cobu=-t/s,this.coav=-i*(e-t)/s,this.cobv=i*(2*e+t)/s}createInnerFacets(){const e=this.m,t=this.n;for(let i=0;i<t+e+1;i++)for(let s=this.min[i];s<this.max[i]+1;s++)s<this.max[i]&&s<this.max[i+1]+1&&this.innerFacets.push(["|"+s+"|"+i,"|"+s+"|"+(i+1),"|"+(s+1)+"|"+i]),i>0&&s<this.max[i-1]&&s+1<this.max[i]+1&&this.innerFacets.push(["|"+s+"|"+i,"|"+(s+1)+"|"+i,"|"+(s+1)+"|"+(i-1)])}edgeVecsABOB(){const e=this.m,t=this.n,i=new Ci(-t,e+t);for(let s=1;s<e+t;s++){const n=new Ci(this.min[s],s),o=new Ci(this.min[s-1],s-1),a=new Ci(this.min[s+1],s+1),l=n.clone(),c=o.clone(),h=a.clone();l.rotate60About(i),c.rotate60About(i),h.rotate60About(i);const u=new Ci(this.max[l.y],l.y),d=new Ci(this.max[l.y-1],l.y-1),f=new Ci(this.max[l.y-1]-1,l.y-1);(l.x!==u.x||l.y!==u.y)&&(l.x!==d.x?(this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([n,d,f]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([n,f,u])):l.y===h.y?(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([n,o,d]),this.vertexTypes.push([1,0,1]),this.isoVecsABOB.push([n,d,a])):(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([n,o,d]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([n,d,u])))}}mapABOBtoOBOA(){const e=new Ci(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let s=0;s<3;s++)e.x=this.isoVecsABOB[t][s].x,e.y=this.isoVecsABOB[t][s].y,0===this.vertexTypes[t][s]&&e.rotateNeg120(this.m,this.n),i.push(e.clone());this.isoVecsOBOA.push(i)}}mapABOBtoBAOA(){const e=new Ci(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let s=0;s<3;s++)e.x=this.isoVecsABOB[t][s].x,e.y=this.isoVecsABOB[t][s].y,1===this.vertexTypes[t][s]&&e.rotate120(this.m,this.n),i.push(e.clone());this.isoVecsBAOA.push(i)}}MapToFace(e,t){const i=this.IDATA.face[e],n=i[1],o=i[0],a=v.FromArray(this.IDATA.vertex[i[2]]),l=v.FromArray(this.IDATA.vertex[n]),c=v.FromArray(this.IDATA.vertex[o]),h=l.subtract(a),u=c.subtract(a),d=h.scale(this.coau).add(u.scale(this.cobu)),f=h.scale(this.coav).add(u.scale(this.cobv)),p=[];let _,m=L.Vector3[0];for(let g=0;g<this.cartesian.length;g++)m=d.scale(this.cartesian[g].x).add(f.scale(this.cartesian[g].y)).add(a),p[g]=[m.x,m.y,m.z],_=e+"|"+this.vertices[g].x+"|"+this.vertices[g].y,t.vertex[this.vecToidx[_]]=[m.x,m.y,m.z]}build(e,t){const i=new Array,s=Ci.Zero(),n=new Ci(e,t),o=new Ci(-t,e+t);i.push(s,n,o);for(let x=t;x<e+1;x++)for(let S=0;S<e+1-x;S++)i.push(new Ci(S,x));if(t>0){const x=oe.HCF(e,t),S=e/x,C=t/x;for(let P=1;P<x;P++)i.push(new Ci(P*S,P*C)),i.push(new Ci(-P*C,P*(S+C))),i.push(new Ci(e-P*(S+C),t+P*S));const D=e/t;for(let P=1;P<t;P++)for(let M=0;M<P*D;M++)i.push(new Ci(M,P)),i.push(new Ci(M,P).rotate120(e,t)),i.push(new Ci(M,P).rotateNeg120(e,t))}i.sort((x,S)=>x.x-S.x),i.sort((x,S)=>x.y-S.y);const a=new Array(e+t+1),l=new Array(e+t+1);for(let x=0;x<a.length;x++)a[x]=1/0,l[x]=-1/0;let c=0,h=0;const u=i.length;for(let x=0;x<u;x++)h=i[x].x,c=i[x].y,a[c]=Math.min(h,a[c]),l[c]=Math.max(h,l[c]);const d=(x,S)=>{const C=x.clone();return"A"===S&&C.rotateNeg120(e,t),"B"===S&&C.rotate120(e,t),C.x<0?C.y:C.x+C.y},f=[],p=[],_=[],m=[],g={},b=[];let y=-1,T=-1;for(let x=0;x<u;x++)f[x]=i[x].toCartesianOrigin(new Ci(0,0),.5),p[x]=d(i[x],"O"),_[x]=d(i[x],"A"),m[x]=d(i[x],"B"),p[x]===_[x]&&_[x]===m[x]?(y=3,T=p[x]):p[x]===_[x]?(y=4,T=p[x]):_[x]===m[x]?(y=5,T=_[x]):m[x]===p[x]&&(y=6,T=p[x]),p[x]<_[x]&&p[x]<m[x]&&(y=2,T=p[x]),_[x]<p[x]&&_[x]<m[x]&&(y=1,T=_[x]),m[x]<_[x]&&m[x]<p[x]&&(y=0,T=m[x]),b.push([y,T,i[x].x,i[x].y]);b.sort((x,S)=>x[2]-S[2]),b.sort((x,S)=>x[3]-S[3]),b.sort((x,S)=>x[1]-S[1]),b.sort((x,S)=>x[0]-S[0]);for(let x=0;x<b.length;x++)g[b[x][2]+"|"+b[x][3]]=[b[x][0],b[x][1],x];return this.m=e,this.n=t,this.vertices=i,this.vertByDist=g,this.cartesian=f,this.min=a,this.max=l,this}}class s0{constructor(e,t,i,s){this.name=e,this.category=t,this.vertex=i,this.face=s}}class vb extends s0{innerToData(e,t){for(let i=0;i<t.innerFacets.length;i++)this.face.push(t.innerFacets[i].map(s=>t.vecToidx[e+s]))}mapABOBtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let s=0;s<t.isoVecsABOB.length;s++){const n=[];for(let o=0;o<3;o++)n.push(0===t.vertexTypes[s][o]?e+"|"+t.isoVecsABOB[s][o].x+"|"+t.isoVecsABOB[s][o].y:i+"|"+t.isoVecsABOB[s][o].x+"|"+t.isoVecsABOB[s][o].y);this.face.push([t.vecToidx[n[0]],t.vecToidx[n[1]],t.vecToidx[n[2]]])}}mapOBOAtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let s=0;s<t.isoVecsOBOA.length;s++){const n=[];for(let o=0;o<3;o++)n.push(1===t.vertexTypes[s][o]?e+"|"+t.isoVecsOBOA[s][o].x+"|"+t.isoVecsOBOA[s][o].y:i+"|"+t.isoVecsOBOA[s][o].x+"|"+t.isoVecsOBOA[s][o].y);this.face.push([t.vecToidx[n[0]],t.vecToidx[n[1]],t.vecToidx[n[2]]])}}mapBAOAtoDATA(e,t){const i=t.IDATA.edgematch[e][2];for(let s=0;s<t.isoVecsBAOA.length;s++){const n=[];for(let o=0;o<3;o++)n.push(1===t.vertexTypes[s][o]?e+"|"+t.isoVecsBAOA[s][o].x+"|"+t.isoVecsBAOA[s][o].y:i+"|"+t.isoVecsBAOA[s][o].x+"|"+t.isoVecsBAOA[s][o].y);this.face.push([t.vecToidx[n[0]],t.vecToidx[n[1]],t.vecToidx[n[2]]])}}orderData(e){const t=[];for(let o=0;o<13;o++)t[o]=[];const i=e.closestTo;for(let o=0;o<i.length;o++)i[o][0]>-1?i[o][1]>0&&t[i[o][0]].push([o,i[o][1]]):t[12].push([o,i[o][0]]);const s=[];for(let o=0;o<12;o++)s[o]=o;let n=12;for(let o=0;o<12;o++){t[o].sort((a,l)=>a[1]-l[1]);for(let a=0;a<t[o].length;a++)s[t[o][a][0]]=n++}for(let o=0;o<t[12].length;o++)s[t[12][o][0]]=n++;for(let o=0;o<this.vertex.length;o++)this.vertex[o].push(s[o]);this.vertex.sort((o,a)=>o[3]-a[3]);for(let o=0;o<this.vertex.length;o++)this.vertex[o].pop();for(let o=0;o<this.face.length;o++)for(let a=0;a<this.face[o].length;a++)this.face[o][a]=s[this.face[o][a]];this.sharedNodes=t[12].length,this.poleNodes=this.vertex.length-this.sharedNodes}setOrder(e,t){const i=[],s=[];let n=t.pop();s.push(n);let o=this.face[n].indexOf(e);o=(o+2)%3;let a=this.face[n][o];i.push(a);let l=0;for(;t.length>0;)n=t[l],this.face[n].indexOf(a)>-1?(o=(this.face[n].indexOf(a)+1)%3,a=this.face[n][o],i.push(a),s.push(n),t.splice(l,1),l=0):l++;return this.adjacentFaces.push(i),s}toGoldbergPolyhedronData(){const e=new s0("GeoDual","Goldberg",[],[]);e.name="GD dual";const t=this.vertex.length,i=new Array(t);for(let c=0;c<t;c++)i[c]=[];for(let c=0;c<this.face.length;c++)for(let h=0;h<3;h++)i[this.face[c][h]].push(c);let s=0,n=0,o=0,a=[],l=[];this.adjacentFaces=[];for(let c=0;c<i.length;c++)e.face[c]=this.setOrder(c,i[c].concat([])),i[c].forEach(h=>{s=0,n=0,o=0,a=this.face[h];for(let u=0;u<3;u++)l=this.vertex[a[u]],s+=l[0],n+=l[1],o+=l[2];e.vertex[h]=[s/3,n/3,o/3]});return e}static BuildGeodesicData(e){const t=new vb("Geodesic-m-n","Geodesic",[[0,ts,-1],[-ts,1,0],[-1,0,-ts],[1,0,-ts],[ts,1,0],[0,ts,1],[-1,0,ts],[-ts,-1,0],[0,-ts,-1],[ts,-1,0],[1,0,ts],[0,-ts,1]],[]);e.setIndices(),e.calcCoeffs(),e.createInnerFacets(),e.edgeVecsABOB(),e.mapABOBtoOBOA(),e.mapABOBtoBAOA();for(let s=0;s<e.IDATA.face.length;s++)e.MapToFace(s,t),t.innerToData(s,e),"B"===e.IDATA.edgematch[s][1]&&t.mapABOBtoDATA(s,e),"O"===e.IDATA.edgematch[s][1]&&t.mapOBOAtoDATA(s,e),"A"===e.IDATA.edgematch[s][3]&&t.mapBAOAtoDATA(s,e);return t.orderData(e),t.vertex=t.vertex.map(function(s){const n=s[0],o=s[1],a=s[2],l=Math.sqrt(n*n+o*o+a*a);return s[0]*=1/l,s[1]*=1/l,s[2]*=1/l,s}),t}}function mz(r,e,t=null){const i=e.size,s=e.sizeX||i||1,n=e.sizeY||i||1,o=e.sizeZ||i||1;let a=e.m||1;a!==Math.floor(a)&&(Math.floor(a),V.Warn("m not an integer only floor(m) used"));let l=e.n||0;if(l!==Math.floor(l)&&(Math.floor(l),V.Warn("n not an integer only floor(n) used")),l>a){const p=l;l=a,a=p,V.Warn("n > m therefore m and n swapped")}const c=new _z;c.build(a,l);const h=vb.BuildGeodesicData(c),u=h.toGoldbergPolyhedronData(),d=new _b(r,t);e.sideOrientation=G._GetDefaultSideOrientation(e.sideOrientation),d._originalBuilderSideOrientation=e.sideOrientation,function $ae(r,e){const t=r.size,i=r.sizeX||t||1,s=r.sizeY||t||1,n=r.sizeZ||t||1,o=0===r.sideOrientation?0:r.sideOrientation||ue.DEFAULTSIDE,a=new Array,l=new Array,c=new Array,h=new Array;let u=1/0,d=-1/0,f=1/0,p=-1/0;for(let g=0;g<e.vertex.length;g++)u=Math.min(u,e.vertex[g][0]*i),d=Math.max(d,e.vertex[g][0]*i),f=Math.min(f,e.vertex[g][1]*s),p=Math.max(p,e.vertex[g][1]*s);let _=0;for(let g=0;g<e.face.length;g++){const b=e.face[g],y=v.FromArray(e.vertex[b[0]]),T=v.FromArray(e.vertex[b[2]]),x=v.FromArray(e.vertex[b[1]]),S=T.subtract(y),C=x.subtract(y),D=v.Cross(C,S).normalize();for(let P=0;P<b.length;P++){c.push(D.x,D.y,D.z);const M=e.vertex[b[P]];a.push(M[0]*i,M[1]*s,M[2]*n);const w=(M[1]*s-f)/(p-f);h.push((M[0]*i-u)/(d-u),It.UseOpenGLOrientationForUV?1-w:w)}for(let P=0;P<b.length-2;P++)l.push(_,_+P+2,_+P+1);_+=b.length}ue._ComputeSides(o,a,l,c,h);const m=new ue;return m.positions=a,m.indices=l,m.normals=c,m.uvs=h,m}(e,u).applyToMesh(d,e.updatable),d.goldbergData.nbSharedFaces=h.sharedNodes,d.goldbergData.nbUnsharedFaces=h.poleNodes,d.goldbergData.adjacentFaces=h.adjacentFaces,d.goldbergData.nbFaces=d.goldbergData.nbSharedFaces+d.goldbergData.nbUnsharedFaces,d.goldbergData.nbFacesAtPole=(d.goldbergData.nbUnsharedFaces-12)/12;for(let p=0;p<h.vertex.length;p++)d.goldbergData.faceCenters.push(v.FromArray(h.vertex[p])),d.goldbergData.faceCenters[p].x*=s,d.goldbergData.faceCenters[p].y*=n,d.goldbergData.faceCenters[p].z*=o,d.goldbergData.faceColors.push(new Te(1,1,1,1));for(let p=0;p<u.face.length;p++){const _=u.face[p],m=v.FromArray(u.vertex[_[0]]),g=v.FromArray(u.vertex[_[2]]),b=v.FromArray(u.vertex[_[1]]),y=g.subtract(m),T=b.subtract(m),x=v.Cross(T,y).normalize(),S=v.Cross(T,x).normalize();d.goldbergData.faceXaxis.push(T.normalize()),d.goldbergData.faceYaxis.push(x),d.goldbergData.faceZaxis.push(S)}return d}G.CreateGoldberg=mz;const Dh={CreateBox:Rp,CreateTiledBox:function dz(r,e,t=null){const i=new G(r,t);return e.sideOrientation=G._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,uz(e).applyToMesh(i,e.updatable),i},CreateSphere:po,CreateDisc:Yv,CreateIcoSphere:fv,CreateRibbon:nc,CreateCylinder:sc,CreateTorus:pa,CreateTorusKnot:KC,CreateLineSystem:eC,CreateLines:Ip,CreateDashedLines:tC,ExtrudeShape:Ov,ExtrudeShapeCustom:iC,CreateLathe:JC,CreateTiledPlane:function hz(r,e,t=null){const i=new G(r,t);return e.sideOrientation=G._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Yp(e).applyToMesh(i,e.updatable),i},CreatePlane:rh,CreateGround:Ep,CreateTiledGround:qE,CreateGroundFromHeightMap:$E,CreatePolygon:mb,ExtrudePolygon:ZC,CreateTube:e0,CreatePolyhedron:jv,CreateGeodesic:function qae(r,e,t=null){let i=e.m||1;i!==Math.floor(i)&&(Math.floor(i),V.Warn("m not an integer only floor(m) used"));let s=e.n||0;if(s!==Math.floor(s)&&(Math.floor(s),V.Warn("n not an integer only floor(n) used")),s>i){const c=s;s=i,i=c,V.Warn("n > m therefore m and n swapped")}const n=new _z;return n.build(i,s),jv(r,{custom:vb.BuildGeodesicData(n),size:e.size,sizeX:e.sizeX,sizeY:e.sizeY,sizeZ:e.sizeZ,faceUV:e.faceUV,faceColors:e.faceColors,flat:e.flat,updatable:e.updatable,sideOrientation:e.sideOrientation,frontUVs:e.frontUVs,backUVs:e.backUVs},t)},CreateGoldberg:mz,CreateDecal:t0,CreateCapsule:ZE};class Kae{constructor(){this.running=!1,this._simplificationArray=[]}addTask(e){this._simplificationArray.push(e)}executeNext(){const e=this._simplificationArray.pop();e?(this.running=!0,this.runSimplification(e)):this.running=!1}runSimplification(e){if(e.parallelProcessing)e.settings.forEach(t=>{this._getSimplifier(e).simplify(t,s=>{void 0!==t.distance&&e.mesh.addLODLevel(t.distance,s),s.isVisible=!0,t.quality===e.settings[e.settings.length-1].quality&&e.successCallback&&e.successCallback(),this.executeNext()})});else{const t=this._getSimplifier(e),i=(s,n)=>{t.simplify(s,o=>{void 0!==s.distance&&e.mesh.addLODLevel(s.distance,o),o.isVisible=!0,n()})};ho.Run(e.settings.length,s=>{i(e.settings[s.index],()=>{s.executeNext()})},()=>{e.successCallback&&e.successCallback(),this.executeNext()})}}_getSimplifier(e){return new ele(e.mesh)}}var qp=(()=>{return(r=qp||(qp={}))[r.QUADRATIC=0]="QUADRATIC",qp;var r})();class Qae{constructor(e){this._vertices=e,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}}class Zae{constructor(e,t){this.position=e,this.id=t,this.isBorder=!0,this.q=new fd,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}updatePosition(e){this.position.copyFrom(e)}}class fd{constructor(e){this.data=new Array(10);for(let t=0;t<10;++t)this.data[t]=e&&e[t]?e[t]:0}det(e,t,i,s,n,o,a,l,c){return this.data[e]*this.data[n]*this.data[c]+this.data[i]*this.data[s]*this.data[l]+this.data[t]*this.data[o]*this.data[a]-this.data[i]*this.data[n]*this.data[a]-this.data[e]*this.data[o]*this.data[l]-this.data[t]*this.data[s]*this.data[c]}addInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e.data[t]}addArrayInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e[t]}add(e){const t=new fd;for(let i=0;i<10;++i)t.data[i]=this.data[i]+e.data[i];return t}static FromData(e,t,i,s){return new fd(fd.DataFromNumbers(e,t,i,s))}static DataFromNumbers(e,t,i,s){return[e*e,e*t,e*i,e*s,t*t,t*i,t*s,i*i,i*s,s*s]}}class Jae{constructor(e,t){this.vertexId=e,this.triangleId=t}}class ele{constructor(e){this._mesh=e,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=ot}simplify(e,t){this._initDecimatedMesh(),ho.Run(this._mesh.subMeshes.length,i=>{this._initWithMesh(i.index,()=>{this._runDecimation(e,i.index,()=>{i.executeNext()})},e.optimizeMesh)},()=>{setTimeout(()=>{t(this._reconstructedMesh)},0)})}_runDecimation(e,t,i){const s=~~(this._triangles.length*e.quality);let n=0;const o=this._triangles.length,a=(l,c)=>{setTimeout(()=>{l%5==0&&this._updateMesh(0===l);for(let d=0;d<this._triangles.length;++d)this._triangles[d].isDirty=!1;const h=1e-9*Math.pow(l+3,this.aggressiveness);ho.SyncAsyncForLoop(this._triangles.length,this.syncIterations,d=>{const p=this._triangles[~~((this._triangles.length/2+d)%this._triangles.length)];if(p&&!(p.error[3]>h||p.deleted||p.isDirty))for(let _=0;_<3;++_)if(p.error[_]<h){const m=[],g=[],b=p._vertices[_],y=p._vertices[(_+1)%3];if(b.isBorder||y.isBorder)continue;const T=v.Zero();this._calculateError(b,y,T);const x=new Array;if(this._isFlipped(b,y,T,m,x)||this._isFlipped(y,b,T,g,x)||m.indexOf(!0)<0||g.indexOf(!0)<0)continue;const S=new Array;if(x.forEach(P=>{-1===S.indexOf(P)&&(P.deletePending=!0,S.push(P))}),S.length%2!=0)continue;b.q=y.q.add(b.q),b.updatePosition(T);const C=this._references.length;n=this._updateTriangles(b,b,m,n),n=this._updateTriangles(b,y,g,n);const D=this._references.length-C;if(D<=b.triangleCount){if(D)for(let P=0;P<D;P++)this._references[b.triangleStart+P]=this._references[C+P]}else b.triangleStart=C;b.triangleCount=D;break}},c,()=>o-n<=s)},0)};ho.Run(this.decimationIterations,l=>{o-n<=s?l.breakLoop():a(l.index,()=>{l.executeNext()})},()=>{setTimeout(()=>{this._reconstructMesh(t),i()},0)})}_initWithMesh(e,t,i){this._vertices=[],this._triangles=[];const s=this._mesh.getVerticesData(A.PositionKind),n=this._mesh.getIndices(),o=this._mesh.subMeshes[e],a=u=>{if(i)for(let d=0;d<this._vertices.length;++d)if(this._vertices[d].position.equalsWithEpsilon(u,1e-4))return this._vertices[d];return null},l=[];ho.SyncAsyncForLoop(o.verticesCount,this.syncIterations/4>>0,u=>{if(!s)return;const d=u+o.verticesStart,f=v.FromArray(s,3*d),p=a(f)||new Zae(f,this._vertices.length);p.originalOffsets.push(d),p.id===this._vertices.length&&this._vertices.push(p),l.push(p.id)},()=>{ho.SyncAsyncForLoop(o.indexCount/3,this.syncIterations,d=>{if(!n)return;const p=3*(o.indexStart/3+d),x=new Qae([this._vertices[l[n[p+0]-o.verticesStart]],this._vertices[l[n[p+1]-o.verticesStart]],this._vertices[l[n[p+2]-o.verticesStart]]]);x.originalOffset=p,this._triangles.push(x)},()=>{this._init(t)})})}_init(e){ho.SyncAsyncForLoop(this._triangles.length,this.syncIterations,i=>{const s=this._triangles[i];s.normal=v.Cross(s._vertices[1].position.subtract(s._vertices[0].position),s._vertices[2].position.subtract(s._vertices[0].position)).normalize();for(let n=0;n<3;n++)s._vertices[n].q.addArrayInPlace(fd.DataFromNumbers(s.normal.x,s.normal.y,s.normal.z,-v.Dot(s.normal,s._vertices[0].position)))},()=>{ho.SyncAsyncForLoop(this._triangles.length,this.syncIterations,s=>{const n=this._triangles[s];for(let o=0;o<3;++o)n.error[o]=this._calculateError(n._vertices[o],n._vertices[(o+1)%3]);n.error[3]=Math.min(n.error[0],n.error[1],n.error[2])},()=>{e()})})}_reconstructMesh(e){const t=[];let i,s,n;for(i=0;i<this._vertices.length;++i)this._vertices[i].triangleCount=0;for(i=0;i<this._triangles.length;++i)if(!this._triangles[i].deleted){for(s=this._triangles[i],n=0;n<3;++n)s._vertices[n].triangleCount=1;t.push(s)}const o=this._reconstructedMesh.getVerticesData(A.PositionKind)||[],a=this._reconstructedMesh.getVerticesData(A.NormalKind)||[],l=this._reconstructedMesh.getVerticesData(A.UVKind)||[],c=this._reconstructedMesh.getVerticesData(A.ColorKind)||[],h=this._mesh.getVerticesData(A.NormalKind),u=this._mesh.getVerticesData(A.UVKind),d=this._mesh.getVerticesData(A.ColorKind);let f=0;for(i=0;i<this._vertices.length;++i){const T=this._vertices[i];T.id=f,T.triangleCount&&T.originalOffsets.forEach(x=>{o.push(T.position.x),o.push(T.position.y),o.push(T.position.z),h&&h.length&&(a.push(h[3*x]),a.push(h[3*x+1]),a.push(h[3*x+2])),u&&u.length&&(l.push(u[2*x]),l.push(u[2*x+1])),d&&d.length&&(c.push(d[4*x]),c.push(d[4*x+1]),c.push(d[4*x+2]),c.push(d[4*x+3])),++f})}const p=this._reconstructedMesh.getTotalIndices(),_=this._reconstructedMesh.getTotalVertices(),m=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];const g=this._reconstructedMesh.getIndices(),b=this._mesh.getIndices();for(i=0;i<t.length;++i)s=t[i],[0,1,2].forEach(T=>{let S=s._vertices[T].originalOffsets.indexOf(b[s.originalOffset+T]);S<0&&(S=0),g.push(s._vertices[T].id+S+_)});this._reconstructedMesh.setIndices(g),this._reconstructedMesh.setVerticesData(A.PositionKind,o),a.length>0&&this._reconstructedMesh.setVerticesData(A.NormalKind,a),l.length>0&&this._reconstructedMesh.setVerticesData(A.UVKind,l),c.length>0&&this._reconstructedMesh.setVerticesData(A.ColorKind,c);const y=this._mesh.subMeshes[e];e>0&&(this._reconstructedMesh.subMeshes=[],m.forEach(T=>{fr.AddToMesh(T.materialIndex,T.verticesStart,T.verticesCount,T.indexStart,T.indexCount,T.getMesh())}),fr.AddToMesh(y.materialIndex,_,f,p,3*t.length,this._reconstructedMesh))}_initDecimatedMesh(){this._reconstructedMesh=new G(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId}_isFlipped(e,t,i,s,n){for(let o=0;o<e.triangleCount;++o){const a=this._triangles[this._references[e.triangleStart+o].triangleId];if(a.deleted)continue;const l=this._references[e.triangleStart+o].vertexId,c=a._vertices[(l+1)%3],h=a._vertices[(l+2)%3];if(c===t||h===t){s[o]=!0,n.push(a);continue}let u=c.position.subtract(i);u=u.normalize();let d=h.position.subtract(i);if(d=d.normalize(),Math.abs(v.Dot(u,d))>.999)return!0;const f=v.Cross(u,d).normalize();if(s[o]=!1,v.Dot(f,a.normal)<.2)return!0}return!1}_updateTriangles(e,t,i,s){let n=s;for(let o=0;o<t.triangleCount;++o){const a=this._references[t.triangleStart+o],l=this._triangles[a.triangleId];if(!l.deleted){if(i[o]&&l.deletePending){l.deleted=!0,n++;continue}l._vertices[a.vertexId]=e,l.isDirty=!0,l.error[0]=this._calculateError(l._vertices[0],l._vertices[1])+l.borderFactor/2,l.error[1]=this._calculateError(l._vertices[1],l._vertices[2])+l.borderFactor/2,l.error[2]=this._calculateError(l._vertices[2],l._vertices[0])+l.borderFactor/2,l.error[3]=Math.min(l.error[0],l.error[1],l.error[2]),this._references.push(a)}}return n}_identifyBorder(){for(let e=0;e<this._vertices.length;++e){const t=[],i=[],s=this._vertices[e];let n;for(n=0;n<s.triangleCount;++n){const o=this._triangles[this._references[s.triangleStart+n].triangleId];for(let a=0;a<3;a++){let l=0;const c=o._vertices[a];for(;l<t.length&&i[l]!==c.id;)++l;l===t.length?(t.push(1),i.push(c.id)):t[l]++}}for(n=0;n<t.length;++n)this._vertices[i[n]].isBorder=1===t[n]}}_updateMesh(e=!1){let t,i,s,n;if(!e){const l=[];for(t=0;t<this._triangles.length;++t)this._triangles[t].deleted||l.push(this._triangles[t]);this._triangles=l}for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleCount=0,this._vertices[t].triangleStart=0;for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],s=0;s<3;++s)n=i._vertices[s],n.triangleCount++;let o=0;for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleStart=o,o+=this._vertices[t].triangleCount,this._vertices[t].triangleCount=0;const a=new Array(3*this._triangles.length);for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],s=0;s<3;++s)n=i._vertices[s],a[n.triangleStart+n.triangleCount]=new Jae(s,t),n.triangleCount++;this._references=a,e&&this._identifyBorder()}_vertexError(e,t){const i=t.x,s=t.y,n=t.z;return e.data[0]*i*i+2*e.data[1]*i*s+2*e.data[2]*i*n+2*e.data[3]*i+e.data[4]*s*s+2*e.data[5]*s*n+2*e.data[6]*s+e.data[7]*n*n+2*e.data[8]*n+e.data[9]}_calculateError(e,t,i){const s=e.q.add(t.q),n=e.isBorder&&t.isBorder;let o=0;const a=s.det(0,1,2,1,4,5,2,5,7);if(0===a||n){const l=e.position.add(t.position).divide(new v(2,2,2)),c=this._vertexError(s,e.position),h=this._vertexError(s,t.position),u=this._vertexError(s,l);o=Math.min(c,h,u),o===c?i&&i.copyFrom(e.position):o===h?i&&i.copyFrom(t.position):i&&i.copyFrom(l)}else i||(i=v.Zero()),i.x=-1/a*s.det(1,2,3,4,5,6,5,7,8),i.y=1/a*s.det(0,2,3,1,5,6,2,7,8),i.z=-1/a*s.det(0,1,3,1,4,6,2,5,8),o=this._vertexError(s,i);return o}}Object.defineProperty(ge.prototype,"simplificationQueue",{get:function(){if(!this._simplificationQueue){this._simplificationQueue=new Kae;let r=this._getComponent(Me.NAME_SIMPLIFICATIONQUEUE);r||(r=new tle(this),this._addComponent(r))}return this._simplificationQueue},set:function(r){this._simplificationQueue=r},enumerable:!0,configurable:!0}),G.prototype.simplify=function(r,e=!0,t=qp.QUADRATIC,i){return this.getScene().simplificationQueue.addTask({settings:r,parallelProcessing:e,mesh:this,simplificationType:t,successCallback:i}),this};class tle{constructor(e){this.name=Me.NAME_SIMPLIFICATIONQUEUE,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(Me.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this._beforeCameraUpdate)}rebuild(){}dispose(){}_beforeCameraUpdate(){this.scene._simplificationQueue&&!this.scene._simplificationQueue.running&&this.scene._simplificationQueue.executeNext()}}G.prototype.thinInstanceAdd=function(r,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return V.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(r)?r.length:1);const t=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(r))for(let i=0;i<r.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,r[i],i===r.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,r,e);return t},G.prototype.thinInstanceAddSelf=function(r=!0){return this.thinInstanceAdd(F.IdentityReadOnly,r)},G.prototype.thinInstanceRegisterAttribute=function(r,e){r===A.ColorKind&&(r=A.ColorInstanceKind),this.removeVerticesData(r),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[r]=e,this._userThinInstanceBuffersStorage.sizes[r]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[r]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[r]),this._userThinInstanceBuffersStorage.vertexBuffers[r]=new A(this.getEngine(),this._userThinInstanceBuffersStorage.data[r],r,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[r])},G.prototype.thinInstanceSetMatrixAt=function(r,e,t=!0){return!(!this._thinInstanceDataStorage.matrixData||r>=this._thinInstanceDataStorage.instancesCount)&&(e.copyToArray(this._thinInstanceDataStorage.matrixData,16*r),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[r]=e),t&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0)},G.prototype.thinInstanceSetAttributeAt=function(r,e,t,i=!0){return r===A.ColorKind&&(r=A.ColorInstanceKind),!(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[r]||e>=this._thinInstanceDataStorage.instancesCount||(this._thinInstanceUpdateBufferSize(r,0),this._userThinInstanceBuffersStorage.data[r].set(t,e*this._userThinInstanceBuffersStorage.strides[r]),i&&this.thinInstanceBufferUpdated(r),0))},Object.defineProperty(G.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(r){var e,t;const i=null!==(e=this._thinInstanceDataStorage.matrixData)&&void 0!==e?e:null===(t=this.source)||void 0===t?void 0:t._thinInstanceDataStorage.matrixData;r<=(i?i.length/16:0)&&(this._thinInstanceDataStorage.instancesCount=r)},enumerable:!0,configurable:!0}),G.prototype._thinInstanceCreateMatrixBuffer=function(r,e,t=!1){r===A.ColorKind&&(r=A.ColorInstanceKind);const i=new kn(this.getEngine(),e,!t,16,!1,!0);for(let s=0;s<4;s++)this.setVerticesBuffer(i.createVertexBuffer(r+s,4*s,4));return i},G.prototype.thinInstanceSetBuffer=function(r,e,t=0,i=!1){var s,n,o;t=t||16,"matrix"===r?(null===(s=this._thinInstanceDataStorage.matrixBuffer)||void 0===s||s.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*t,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,null!==e?(this._thinInstanceDataStorage.instancesCount=e.length/t,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,i),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):"previousMatrix"===r?(null===(n=this._thinInstanceDataStorage.previousMatrixBuffer)||void 0===n||n.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,null!==e&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,i))):(r===A.ColorKind&&(r=A.ColorInstanceKind),null===e?null!==(o=this._userThinInstanceBuffersStorage)&&void 0!==o&&o.data[r]&&(this.removeVerticesData(r),delete this._userThinInstanceBuffersStorage.data[r],delete this._userThinInstanceBuffersStorage.strides[r],delete this._userThinInstanceBuffersStorage.sizes[r],delete this._userThinInstanceBuffersStorage.vertexBuffers[r]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[r]=e,this._userThinInstanceBuffersStorage.strides[r]=t,this._userThinInstanceBuffersStorage.sizes[r]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[r]=new A(this.getEngine(),e,r,!i,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[r])))},G.prototype.thinInstanceBufferUpdated=function(r){var e,t,i;"matrix"===r?null===(e=this._thinInstanceDataStorage.matrixBuffer)||void 0===e||e.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount):"previousMatrix"===r?null===(t=this._thinInstanceDataStorage.previousMatrixBuffer)||void 0===t||t.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount):(r===A.ColorKind&&(r=A.ColorInstanceKind),null!==(i=this._userThinInstanceBuffersStorage)&&void 0!==i&&i.vertexBuffers[r]&&this._userThinInstanceBuffersStorage.vertexBuffers[r].updateDirectly(this._userThinInstanceBuffersStorage.data[r],0))},G.prototype.thinInstancePartialBufferUpdate=function(r,e,t){var i;"matrix"===r?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,t):(r===A.ColorKind&&(r=A.ColorInstanceKind),null!==(i=this._userThinInstanceBuffersStorage)&&void 0!==i&&i.vertexBuffers[r]&&this._userThinInstanceBuffersStorage.vertexBuffers[r].updateDirectly(e,t))},G.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];const r=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=new Array;for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=F.FromArray(r,16*e)}return this._thinInstanceDataStorage.worldMatrices},G.prototype.thinInstanceRefreshBoundingInfo=function(r=!1,e=!1,t=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const i=this._thinInstanceDataStorage.boundingVectors;r&&(i.length=0,this.refreshBoundingInfo(e,t));const s=this.getBoundingInfo(),n=this._thinInstanceDataStorage.matrixData;if(0===i.length)for(let o=0;o<s.boundingBox.vectors.length;++o)i.push(s.boundingBox.vectors[o].clone());L.Vector3[0].setAll(Number.POSITIVE_INFINITY),L.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let o=0;o<this._thinInstanceDataStorage.instancesCount;++o){F.FromArrayToRef(n,16*o,L.Matrix[0]);for(let a=0;a<i.length;++a)v.TransformCoordinatesToRef(i[a],L.Matrix[0],L.Vector3[2]),L.Vector3[0].minimizeInPlace(L.Vector3[2]),L.Vector3[1].maximizeInPlace(L.Vector3[2])}s.reConstruct(L.Vector3[0],L.Vector3[1]),this._updateBoundingInfo()},G.prototype._thinInstanceUpdateBufferSize=function(r,e=1){var t,i,s;r===A.ColorKind&&(r=A.ColorInstanceKind);const n="matrix"===r;if(!(n||this._userThinInstanceBuffersStorage&&this._userThinInstanceBuffersStorage.strides[r]))return;const o=n?16:this._userThinInstanceBuffersStorage.strides[r],a=n?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[r];let l=n?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[r];const c=(this._thinInstanceDataStorage.instancesCount+e)*o;let h=a;for(;h<c;)h*=2;if(!l||a!=h){if(l){const u=new Float32Array(h);u.set(l,0),l=u}else l=new Float32Array(h);n?(null===(t=this._thinInstanceDataStorage.matrixBuffer)||void 0===t||t.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",l,!1),this._thinInstanceDataStorage.matrixData=l,this._thinInstanceDataStorage.matrixBufferSize=h,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&(null===(i=this._thinInstanceDataStorage.previousMatrixBuffer)||void 0===i||i.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",l,!1))):(null===(s=this._userThinInstanceBuffersStorage.vertexBuffers[r])||void 0===s||s.dispose(),this._userThinInstanceBuffersStorage.data[r]=l,this._userThinInstanceBuffersStorage.sizes[r]=h,this._userThinInstanceBuffersStorage.vertexBuffers[r]=new A(this.getEngine(),l,r,!0,!1,o,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[r]))}},G.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})},G.prototype._disposeThinInstanceSpecificData=function(){var r;null!==(r=this._thinInstanceDataStorage)&&void 0!==r&&r.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)},ee.OfflineProviderFactory=(r,e,t=!1)=>new sle(r,e,t);let sle=(()=>{class r{get enableSceneOffline(){return this._enableSceneOffline}get enableTexturesOffline(){return this._enableTexturesOffline}constructor(t,i,s=!1){this._idbFactory=typeof indexedDB<"u"?indexedDB:void 0,this._currentSceneUrl=r._ReturnFullUrlLocation(t),this._db=null,this._enableSceneOffline=!1,this._enableTexturesOffline=!1,this._manifestVersionFound=0,this._mustUpdateRessources=!1,this._hasReachedQuota=!1,r.IDBStorageEnabled?s?(this._enableSceneOffline=!0,this._enableTexturesOffline=!0,this._manifestVersionFound=1,q.SetImmediate(()=>{i(!0)})):this._checkManifestFile(i):i(!0)}_checkManifestFile(t){const i=()=>{this._enableSceneOffline=!1,this._enableTexturesOffline=!1,t(!1)},s=()=>{try{if("function"==typeof URL&&0===this._currentSceneUrl.indexOf("http")){const l=new URL(this._currentSceneUrl);return l.pathname+=".manifest",l.toString()}}catch{}return`${this._currentSceneUrl}.manifest`};let n=!1,o=s();const a=new Yi;navigator.onLine&&(n=!0,o=o+(null==o.match(/\?/)?"?":"&")+Date.now()),a.open("GET",o),a.addEventListener("load",()=>{if(200===a.status||r._ValidateXHRData(a,1))try{const l=JSON.parse(a.response);this._enableSceneOffline=l.enableSceneOffline,this._enableTexturesOffline=l.enableTexturesOffline&&r._IsUASupportingBlobStorage,l.version&&!isNaN(parseInt(l.version))&&(this._manifestVersionFound=l.version),t(!0)}catch{i()}else i()},!1),a.addEventListener("error",()=>{if(n){n=!1;const l=s();a.open("GET",l),a.send()}else i()},!1);try{a.send()}catch{V.Error("Error on XHR send request."),t(!1)}}open(t,i){const s=()=>{this._isSupported=!1,i&&i()};if(this._idbFactory&&(this._enableSceneOffline||this._enableTexturesOffline))if(this._db)t&&t();else{this._hasReachedQuota=!1,this._isSupported=!0;const n=this._idbFactory.open("babylonjs",1);n.onerror=()=>{s()},n.onblocked=()=>{V.Error("IDB request blocked. Please reload the page."),s()},n.onsuccess=()=>{this._db=n.result,t()},n.onupgradeneeded=o=>{if(this._db=o.target.result,this._db)try{this._db.createObjectStore("scenes",{keyPath:"sceneUrl"}),this._db.createObjectStore("versions",{keyPath:"sceneUrl"}),this._db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(a){V.Error("Error while creating object stores. Exception: "+a.message),s()}}}else this._isSupported=!1,i&&i()}loadImage(t,i){const s=r._ReturnFullUrlLocation(t),n=()=>{this._hasReachedQuota||null===this._db?i.src=t:this._saveImageIntoDBAsync(s,i)};this._mustUpdateRessources?n():this._loadImageFromDBAsync(s,i,n)}_loadImageFromDBAsync(t,i,s){if(this._isSupported&&null!==this._db){let n;const o=this._db.transaction(["textures"]);o.onabort=()=>{i.src=t},o.oncomplete=()=>{let l;n&&"function"==typeof URL?(l=URL.createObjectURL(n.data),i.onerror=()=>{V.Error("Error loading image from blob URL: "+l+" switching back to web url: "+t),i.src=t},i.src=l):s()};const a=o.objectStore("textures").get(t);a.onsuccess=l=>{n=l.target.result},a.onerror=()=>{V.Error("Error loading texture "+t+" from DB."),i.src=t}}else V.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),i.src=t}_saveImageIntoDBAsync(t,i){let s;if(this._isSupported){const n=()=>{let o;if(s&&"function"==typeof URL)try{o=URL.createObjectURL(s)}catch{o=URL.createObjectURL(s)}o&&(i.src=o)};if(r._IsUASupportingBlobStorage){const o=new Yi;o.open("GET",t),o.responseType="blob",o.addEventListener("load",()=>{if(200===o.status&&this._db){s=o.response;const a=this._db.transaction(["textures"],"readwrite");a.onabort=c=>{try{const u=c.target.error;u&&"QuotaExceededError"===u.name&&(this._hasReachedQuota=!0)}catch{}n()},a.oncomplete=()=>{n()};const l={textureUrl:t,data:s};try{const c=a.objectStore("textures").put(l);c.onsuccess=()=>{},c.onerror=()=>{n()}}catch(c){25===c.code&&(r._IsUASupportingBlobStorage=!1,this._enableTexturesOffline=!1),i.src=t}}else i.src=t},!1),o.addEventListener("error",()=>{V.Error("Error in XHR request in BABYLON.Database."),i.src=t},!1),o.send()}else i.src=t}else V.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),i.src=t}_checkVersionFromDB(t,i){this._loadVersionFromDBAsync(t,i,()=>{this._saveVersionIntoDBAsync(t,i)})}_loadVersionFromDBAsync(t,i,s){if(this._isSupported&&this._db){let n;try{const o=this._db.transaction(["versions"]);o.oncomplete=()=>{n?this._manifestVersionFound!==n.data?(this._mustUpdateRessources=!0,s()):i(n.data):(this._mustUpdateRessources=!0,s())},o.onabort=()=>{i(-1)};const a=o.objectStore("versions").get(t);a.onsuccess=l=>{n=l.target.result},a.onerror=()=>{V.Error("Error loading version for scene "+t+" from DB."),i(-1)}}catch(o){V.Error("Error while accessing 'versions' object store (READ OP). Exception: "+o.message),i(-1)}}else V.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),i(-1)}_saveVersionIntoDBAsync(t,i){if(this._isSupported&&!this._hasReachedQuota&&this._db)try{const s=this._db.transaction(["versions"],"readwrite");s.onabort=a=>{try{const l=a.target.error;l&&"QuotaExceededError"===l.name&&(this._hasReachedQuota=!0)}catch{}i(-1)},s.oncomplete=()=>{i(this._manifestVersionFound)};const n={sceneUrl:t,data:this._manifestVersionFound},o=s.objectStore("versions").put(n);o.onsuccess=()=>{},o.onerror=()=>{V.Error("Error in DB add version request in BABYLON.Database.")}}catch(s){V.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+s.message),i(-1)}else i(-1)}loadFile(t,i,s,n,o){const a=r._ReturnFullUrlLocation(t),l=()=>{this._saveFileAsync(a,i,s,o,n)};this._checkVersionFromDB(a,c=>{-1!==c?this._mustUpdateRessources?this._saveFileAsync(a,i,s,o,n):this._loadFileAsync(a,i,l):n&&n()})}_loadFileAsync(t,i,s){if(this._isSupported&&this._db){let n,o;n=-1!==t.indexOf(".babylon")?"scenes":"textures";const a=this._db.transaction([n]);a.oncomplete=()=>{o?i(o.data):s()},a.onabort=()=>{s()};const l=a.objectStore(n).get(t);l.onsuccess=c=>{o=c.target.result},l.onerror=()=>{V.Error("Error loading file "+t+" from DB."),s()}}else V.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),i()}_saveFileAsync(t,i,s,n,o){if(this._isSupported){let a;a=-1!==t.indexOf(".babylon")?"scenes":"textures";const l=new Yi;let c;l.open("GET",t+(null==t.match(/\?/)?"?":"&")+Date.now()),n&&(l.responseType="arraybuffer"),s&&(l.onprogress=s),l.addEventListener("load",()=>{if(200===l.status||l.status<400&&r._ValidateXHRData(l,n?6:1))if(c=n?l.response:l.responseText,!this._hasReachedQuota&&this._db){const h=this._db.transaction([a],"readwrite");let u;h.onabort=d=>{try{const f=d.target.error;f&&"QuotaExceededError"===f.name&&(this._hasReachedQuota=!0)}catch{}i(c)},h.oncomplete=()=>{i(c)},u="scenes"===a?{sceneUrl:t,data:c,version:this._manifestVersionFound}:{textureUrl:t,data:c};try{const d=h.objectStore(a).put(u);d.onsuccess=()=>{},d.onerror=()=>{V.Error("Error in DB add file request in BABYLON.Database.")}}catch{i(c)}}else i(c);else l.status>=400&&o?o(l):i()},!1),l.addEventListener("error",()=>{V.Error("error on XHR request."),o&&o()},!1),l.send()}else V.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),o&&o()}static _ValidateXHRData(t,i=7){try{if(1&i){if(t.responseText&&t.responseText.length>0)return!0;if(1===i)return!1}if(2&i){const s=ab(t.response);if(s.width&&s.height&&s.width>0&&s.height>0)return!0;if(2===i)return!1}if(4&i){const s=new Uint8Array(t.response,0,3);return 68===s[0]&&68===s[1]&&83===s[2]}}catch{}return!1}}return r._IsUASupportingBlobStorage=!0,r.IDBStorageEnabled=!1,r._ParseURL=e=>{document.createElement("a").href=e;const i=e.substring(0,e.lastIndexOf("#")),s=e.substring(i.lastIndexOf("/")+1,e.length);return e.substring(0,e.indexOf(s,0))},r._ReturnFullUrlLocation=e=>-1===e.indexOf("http:/")&&-1===e.indexOf("https:/")&&typeof window<"u"?r._ParseURL(window.location.href)+e:e,r})();class gz{_isUbo(e){return void 0!==e.addUniform}constructor(e){this._isUbo(e)?(this.setMatrix3x3=e.updateMatrix3x3.bind(e),this.setMatrix2x2=e.updateMatrix2x2.bind(e),this.setFloat=e.updateFloat.bind(e),this.setFloat2=e.updateFloat2.bind(e),this.setFloat3=e.updateFloat3.bind(e),this.setFloat4=e.updateFloat4.bind(e),this.setFloatArray=e.updateFloatArray.bind(e),this.setArray=e.updateArray.bind(e),this.setIntArray=e.updateIntArray.bind(e),this.setMatrix=e.updateMatrix.bind(e),this.setMatrices=e.updateMatrices.bind(e),this.setVector3=e.updateVector3.bind(e),this.setVector4=e.updateVector4.bind(e),this.setColor3=e.updateColor3.bind(e),this.setColor4=e.updateColor4.bind(e),this.setDirectColor4=e.updateDirectColor4.bind(e),this.setInt=e.updateInt.bind(e),this.setInt2=e.updateInt2.bind(e),this.setInt3=e.updateInt3.bind(e),this.setInt4=e.updateInt4.bind(e)):(this.setMatrix3x3=e.setMatrix3x3.bind(e),this.setMatrix2x2=e.setMatrix2x2.bind(e),this.setFloat=e.setFloat.bind(e),this.setFloat2=e.setFloat2.bind(e),this.setFloat3=e.setFloat3.bind(e),this.setFloat4=e.setFloat4.bind(e),this.setFloatArray=e.setFloatArray.bind(e),this.setArray=e.setArray.bind(e),this.setIntArray=e.setIntArray.bind(e),this.setMatrix=e.setMatrix.bind(e),this.setMatrices=e.setMatrices.bind(e),this.setVector3=e.setVector3.bind(e),this.setVector4=e.setVector4.bind(e),this.setColor3=e.setColor3.bind(e),this.setColor4=e.setColor4.bind(e),this.setDirectColor4=e.setDirectColor4.bind(e),this.setInt=e.setInt.bind(e),this.setInt2=e.setInt2.bind(e),this.setInt3=e.setInt3.bind(e),this.setInt4=e.setInt4.bind(e))}}j.ShadersStore.gpuUpdateParticlesPixelShader="#version 300 es\nvoid main() {\ndiscard;\n}\n";j.ShadersStore.gpuUpdateParticlesVertexShader="#version 300 es\n#define PI 3.14159\nuniform float currentCount;\nuniform float timeDelta;\nuniform float stopFactor;\n#ifndef LOCAL\nuniform mat4 emitterWM;\n#endif\nuniform vec2 lifeTime;\nuniform vec2 emitPower;\nuniform vec2 sizeRange;\nuniform vec4 scaleRange;\n#ifndef COLORGRADIENTS\nuniform vec4 color1;\nuniform vec4 color2;\n#endif\nuniform vec3 gravity;\nuniform sampler2D randomSampler;\nuniform sampler2D randomSampler2;\nuniform vec4 angleRange;\n#ifdef BOXEMITTER\nuniform vec3 direction1;\nuniform vec3 direction2;\nuniform vec3 minEmitBox;\nuniform vec3 maxEmitBox;\n#endif\n#ifdef POINTEMITTER\nuniform vec3 direction1;\nuniform vec3 direction2;\n#endif\n#ifdef HEMISPHERICEMITTER\nuniform float radius;\nuniform float radiusRange;\nuniform float directionRandomizer;\n#endif\n#ifdef SPHEREEMITTER\nuniform float radius;\nuniform float radiusRange;\n#ifdef DIRECTEDSPHEREEMITTER\nuniform vec3 direction1;\nuniform vec3 direction2;\n#else\nuniform float directionRandomizer;\n#endif\n#endif\n#ifdef CYLINDEREMITTER\nuniform float radius;\nuniform float height;\nuniform float radiusRange;\n#ifdef DIRECTEDCYLINDEREMITTER\nuniform vec3 direction1;\nuniform vec3 direction2;\n#else\nuniform float directionRandomizer;\n#endif\n#endif\n#ifdef CONEEMITTER\nuniform vec2 radius;\nuniform float coneAngle;\nuniform vec2 height;\nuniform float directionRandomizer;\n#endif\nin vec3 position;\n#ifdef CUSTOMEMITTER\nin vec3 initialPosition;\n#endif\nin float age;\nin float life;\nin vec4 seed;\nin vec3 size;\n#ifndef COLORGRADIENTS\nin vec4 color;\n#endif\nin vec3 direction;\n#ifndef BILLBOARD\nin vec3 initialDirection;\n#endif\n#ifdef ANGULARSPEEDGRADIENTS\nin float angle;\n#else\nin vec2 angle;\n#endif\n#ifdef ANIMATESHEET\nin float cellIndex;\n#ifdef ANIMATESHEETRANDOMSTART\nin float cellStartOffset;\n#endif\n#endif\n#ifdef NOISE\nin vec3 noiseCoordinates1;\nin vec3 noiseCoordinates2;\n#endif\nout vec3 outPosition;\n#ifdef CUSTOMEMITTER\nout vec3 outInitialPosition;\n#endif\nout float outAge;\nout float outLife;\nout vec4 outSeed;\nout vec3 outSize;\n#ifndef COLORGRADIENTS\nout vec4 outColor;\n#endif\nout vec3 outDirection;\n#ifndef BILLBOARD\nout vec3 outInitialDirection;\n#endif\n#ifdef ANGULARSPEEDGRADIENTS\nout float outAngle;\n#else\nout vec2 outAngle;\n#endif\n#ifdef ANIMATESHEET\nout float outCellIndex;\n#ifdef ANIMATESHEETRANDOMSTART\nout float outCellStartOffset;\n#endif\n#endif\n#ifdef NOISE\nout vec3 outNoiseCoordinates1;\nout vec3 outNoiseCoordinates2;\n#endif\n#ifdef SIZEGRADIENTS\nuniform sampler2D sizeGradientSampler;\n#endif \n#ifdef ANGULARSPEEDGRADIENTS\nuniform sampler2D angularSpeedGradientSampler;\n#endif \n#ifdef VELOCITYGRADIENTS\nuniform sampler2D velocityGradientSampler;\n#endif\n#ifdef LIMITVELOCITYGRADIENTS\nuniform sampler2D limitVelocityGradientSampler;\nuniform float limitVelocityDamping;\n#endif\n#ifdef DRAGGRADIENTS\nuniform sampler2D dragGradientSampler;\n#endif\n#ifdef NOISE\nuniform vec3 noiseStrength;\nuniform sampler2D noiseSampler;\n#endif\n#ifdef ANIMATESHEET\nuniform vec4 cellInfos;\n#endif\nvec3 getRandomVec3(float offset) {\nreturn texture(randomSampler2,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;\n}\nvec4 getRandomVec4(float offset) {\nreturn texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));\n}\nvoid main() {\nfloat newAge=age+timeDelta; \nif (newAge>=life && stopFactor != 0.) {\nvec3 newPosition;\nvec3 newDirection;\nvec4 randoms=getRandomVec4(seed.x);\noutLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;\noutAge=newAge-life;\noutSeed=seed;\n#ifdef SIZEGRADIENTS \noutSize.x=texture(sizeGradientSampler,vec2(0,0)).r;\n#else\noutSize.x=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;\n#endif\noutSize.y=scaleRange.x+(scaleRange.y-scaleRange.x)*randoms.b;\noutSize.z=scaleRange.z+(scaleRange.w-scaleRange.z)*randoms.a; \n#ifndef COLORGRADIENTS\noutColor=color1+(color2-color1)*randoms.b;\n#endif\n#ifndef ANGULARSPEEDGRADIENTS \noutAngle.y=angleRange.x+(angleRange.y-angleRange.x)*randoms.a;\noutAngle.x=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;\n#else\noutAngle=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;\n#endif \n#ifdef POINTEMITTER\nvec3 randoms2=getRandomVec3(seed.y);\nvec3 randoms3=getRandomVec3(seed.z);\nnewPosition=vec3(0,0,0);\nnewDirection=direction1+(direction2-direction1)*randoms3;\n#elif defined(BOXEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);\nvec3 randoms3=getRandomVec3(seed.z);\nnewPosition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;\nnewDirection=direction1+(direction2-direction1)*randoms3; \n#elif defined(HEMISPHERICEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);\nvec3 randoms3=getRandomVec3(seed.z);\nfloat phi=2.0*PI*randoms2.x;\nfloat theta=acos(2.0*randoms2.y-1.0);\nfloat randX=cos(phi)*sin(theta);\nfloat randY=cos(theta);\nfloat randZ=sin(phi)*sin(theta);\nnewPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,abs(randY),randZ);\nnewDirection=newPosition+directionRandomizer*randoms3; \n#elif defined(SPHEREEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);\nvec3 randoms3=getRandomVec3(seed.z);\nfloat phi=2.0*PI*randoms2.x;\nfloat theta=acos(2.0*randoms2.y-1.0);\nfloat randX=cos(phi)*sin(theta);\nfloat randY=cos(theta);\nfloat randZ=sin(phi)*sin(theta);\nnewPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,randY,randZ);\n#ifdef DIRECTEDSPHEREEMITTER\nnewDirection=normalize(direction1+(direction2-direction1)*randoms3);\n#else\nnewDirection=normalize(newPosition+directionRandomizer*randoms3);\n#endif\n#elif defined(CYLINDEREMITTER)\nvec3 randoms2=getRandomVec3(seed.y);\nvec3 randoms3=getRandomVec3(seed.z);\nfloat yPos=(randoms2.x-0.5)*height;\nfloat angle=randoms2.y*PI*2.;\nfloat inverseRadiusRangeSquared=((1.-radiusRange)*(1.-radiusRange));\nfloat positionRadius=radius*sqrt(inverseRadiusRangeSquared+(randoms2.z*(1.-inverseRadiusRangeSquared)));\nfloat xPos=positionRadius*cos(angle);\nfloat zPos=positionRadius*sin(angle);\nnewPosition=vec3(xPos,yPos,zPos);\n#ifdef DIRECTEDCYLINDEREMITTER\nnewDirection=direction1+(direction2-direction1)*randoms3;\n#else\nangle=angle+((randoms3.x-0.5)*PI)*directionRandomizer;\nnewDirection=vec3(cos(angle),(randoms3.y-0.5)*directionRandomizer,sin(angle));\nnewDirection=normalize(newDirection);\n#endif\n#elif defined(CONEEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);\nfloat s=2.0*PI*randoms2.x;\n#ifdef CONEEMITTERSPAWNPOINT\nfloat h=0.0001;\n#else\nfloat h=randoms2.y*height.y;\nh=1.-h*h; \n#endif\nfloat lRadius=radius.x-radius.x*randoms2.z*radius.y;\nlRadius=lRadius*h;\nfloat randX=lRadius*sin(s);\nfloat randZ=lRadius*cos(s);\nfloat randY=h *height.x;\nnewPosition=vec3(randX,randY,randZ); \nif (abs(cos(coneAngle))==1.0) {\nnewDirection=vec3(0.,1.0,0.);\n} else {\nvec3 randoms3=getRandomVec3(seed.z);\nnewDirection=normalize(newPosition+directionRandomizer*randoms3); \n}\n#elif defined(CUSTOMEMITTER)\nnewPosition=initialPosition;\noutInitialPosition=initialPosition;\n#else \nnewPosition=vec3(0.,0.,0.);\nnewDirection=2.0*(getRandomVec3(seed.w)-vec3(0.5,0.5,0.5));\n#endif\nfloat power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;\n#ifdef LOCAL\noutPosition=newPosition;\n#else\noutPosition=(emitterWM*vec4(newPosition,1.)).xyz;\n#endif\n#ifdef CUSTOMEMITTER\noutDirection=direction;\n#ifndef BILLBOARD \noutInitialDirection=direction;\n#endif\n#else\n#ifdef LOCAL\nvec3 initial=newDirection;\n#else \nvec3 initial=(emitterWM*vec4(newDirection,0.)).xyz;\n#endif\noutDirection=initial*power;\n#ifndef BILLBOARD \noutInitialDirection=initial;\n#endif\n#endif\n#ifdef ANIMATESHEET \noutCellIndex=cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\noutCellStartOffset=randoms.a*outLife;\n#endif \n#endif\n#ifdef NOISE\noutNoiseCoordinates1=noiseCoordinates1;\noutNoiseCoordinates2=noiseCoordinates2;\n#endif\n} else {\nfloat directionScale=timeDelta;\noutAge=newAge;\nfloat ageGradient=newAge/life;\n#ifdef VELOCITYGRADIENTS\ndirectionScale*=texture(velocityGradientSampler,vec2(ageGradient,0)).r;\n#endif\n#ifdef DRAGGRADIENTS\ndirectionScale*=1.0-texture(dragGradientSampler,vec2(ageGradient,0)).r;\n#endif\n#if defined(CUSTOMEMITTER)\noutPosition=position+(direction-position)*ageGradient; \noutInitialPosition=initialPosition;\n#else\noutPosition=position+direction*directionScale;\n#endif\noutLife=life;\noutSeed=seed;\n#ifndef COLORGRADIENTS \noutColor=color;\n#endif\n#ifdef SIZEGRADIENTS\noutSize.x=texture(sizeGradientSampler,vec2(ageGradient,0)).r;\noutSize.yz=size.yz;\n#else\noutSize=size;\n#endif \n#ifndef BILLBOARD \noutInitialDirection=initialDirection;\n#endif\n#ifdef CUSTOMEMITTER\noutDirection=direction;\n#else\nvec3 updatedDirection=direction+gravity*timeDelta;\n#ifdef LIMITVELOCITYGRADIENTS\nfloat limitVelocity=texture(limitVelocityGradientSampler,vec2(ageGradient,0)).r;\nfloat currentVelocity=length(updatedDirection);\nif (currentVelocity>limitVelocity) {\nupdatedDirection=updatedDirection*limitVelocityDamping;\n}\n#endif\noutDirection=updatedDirection;\n#ifdef NOISE\nfloat fetchedR=texture(noiseSampler,vec2(noiseCoordinates1.x,noiseCoordinates1.y)*vec2(0.5)+vec2(0.5)).r;\nfloat fetchedG=texture(noiseSampler,vec2(noiseCoordinates1.z,noiseCoordinates2.x)*vec2(0.5)+vec2(0.5)).r;\nfloat fetchedB=texture(noiseSampler,vec2(noiseCoordinates2.y,noiseCoordinates2.z)*vec2(0.5)+vec2(0.5)).r;\nvec3 force=vec3(2.*fetchedR-1.,2.*fetchedG-1.,2.*fetchedB-1.)*noiseStrength;\noutDirection=outDirection+force*timeDelta;\noutNoiseCoordinates1=noiseCoordinates1;\noutNoiseCoordinates2=noiseCoordinates2;\n#endif \n#endif \n#ifdef ANGULARSPEEDGRADIENTS\nfloat angularSpeed=texture(angularSpeedGradientSampler,vec2(ageGradient,0)).r;\noutAngle=angle+angularSpeed*timeDelta;\n#else\noutAngle=vec2(angle.x+angle.y*timeDelta,angle.y);\n#endif\n#ifdef ANIMATESHEET \nfloat offsetAge=outAge;\nfloat dist=cellInfos.y-cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\noutCellStartOffset=cellStartOffset;\noffsetAge+=cellStartOffset;\n#else\nfloat cellStartOffset=0.;\n#endif \nfloat ratio=0.;\nif (cellInfos.w==1.0) {\nratio=clamp(mod(cellStartOffset+cellInfos.z*offsetAge,life)/life,0.,1.0);\n}\nelse {\nratio=clamp(cellStartOffset+cellInfos.z*offsetAge/life,0.,1.0);\n}\noutCellIndex=float(int(cellInfos.x+ratio*dist));\n#endif\n}\n}",le("BABYLON.WebGL2ParticleSystem",class rle{constructor(e,t){this._renderVAO=[],this._updateVAO=[],this.alignDataInBuffer=!1,this._parent=e,this._engine=t,this._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]}}isUpdateBufferCreated(){return!!this._updateEffect}isUpdateBufferReady(){var e,t;return null!==(t=null===(e=this._updateEffect)||void 0===e?void 0:e.isReady())&&void 0!==t&&t}createUpdateBuffer(e){return this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._parent.particleEmitterType instanceof lh&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._parent._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._parent._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._parent.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this._parent.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this._parent.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this._updateEffectOptions.defines=e,this._updateEffect=new Ot("gpuUpdateParticles",this._updateEffectOptions,this._engine),new gz(this._updateEffect)}createVertexBuffers(e,t){this._updateVAO.push(this._createUpdateVAO(e)),this._renderVAO.push(this._engine.recordVertexArrayObject(t,null,this._parent._getWrapper(this._parent.blendMode).effect)),this._engine.bindArrayBuffer(null)}createParticleBuffer(e){return e}bindDrawBuffers(e){this._engine.bindVertexArrayObject(this._renderVAO[e],null)}preUpdateParticleBuffer(){const e=this._engine;if(this._engine.enableEffect(this._updateEffect),!e.setState)throw new Error("GPU particles cannot work without a full Engine. ThinEngine is not supported")}updateParticleBuffer(e,t,i){this._updateEffect.setTexture("randomSampler",this._parent._randomTexture),this._updateEffect.setTexture("randomSampler2",this._parent._randomTexture2),this._parent._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateEffect.setTexture("limitVelocityGradientSampler",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateEffect.setTexture("noiseSampler",this._parent.noiseTexture),this._engine.bindVertexArrayObject(this._updateVAO[e],null);const s=this._engine;s.bindTransformFeedbackBuffer(t.getBuffer()),s.setRasterizerState(!1),s.beginTransformFeedback(!0),s.drawArraysType(3,0,i),s.endTransformFeedback(),s.setRasterizerState(!0),s.bindTransformFeedbackBuffer(null)}releaseBuffers(){}releaseVertexBuffers(){for(let e=0;e<this._updateVAO.length;e++)this._engine.releaseVertexArrayObject(this._updateVAO[e]);this._updateVAO.length=0;for(let e=0;e<this._renderVAO.length;e++)this._engine.releaseVertexArrayObject(this._renderVAO[e]);this._renderVAO.length=0}_createUpdateVAO(e){const t={};t.position=e.createVertexBuffer("position",0,3);let i=3;t.age=e.createVertexBuffer("age",i,1),i+=1,t.size=e.createVertexBuffer("size",i,3),i+=3,t.life=e.createVertexBuffer("life",i,1),i+=1,t.seed=e.createVertexBuffer("seed",i,4),i+=4,t.direction=e.createVertexBuffer("direction",i,3),i+=3,this._parent.particleEmitterType instanceof lh&&(t.initialPosition=e.createVertexBuffer("initialPosition",i,3),i+=3),this._parent._colorGradientsTexture||(t.color=e.createVertexBuffer("color",i,4),i+=4),this._parent._isBillboardBased||(t.initialDirection=e.createVertexBuffer("initialDirection",i,3),i+=3),this._parent.noiseTexture&&(t.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",i,3),i+=3,t.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",i,3),i+=3),this._parent._angularSpeedGradientsTexture?(t.angle=e.createVertexBuffer("angle",i,1),i+=1):(t.angle=e.createVertexBuffer("angle",i,2),i+=2),this._parent._isAnimationSheetEnabled&&(t.cellIndex=e.createVertexBuffer("cellIndex",i,1),i+=1,this._parent.spriteRandomStartCell&&(t.cellStartOffset=e.createVertexBuffer("cellStartOffset",i,1),i+=1));const s=this._engine.recordVertexArrayObject(t,null,this._updateEffect);return this._engine.bindArrayBuffer(null),s}});j.ShadersStoreWGSL.gpuUpdateParticlesComputeShader="struct Particle {\nposition : vec3<f32>,\nage : f32,\nsize : vec3<f32>,\nlife : f32,\nseed : vec4<f32>,\ndirection : vec3<f32>,\ndummy0: f32,\n#ifdef CUSTOMEMITTER\ninitialPosition : vec3<f32>,\ndummy1: f32,\n#endif\n#ifndef COLORGRADIENTS\ncolor : vec4<f32>,\n#endif\n#ifndef BILLBOARD\ninitialDirection : vec3<f32>,\ndummy2: f32,\n#endif\n#ifdef NOISE\nnoiseCoordinates1 : vec3<f32>,\ndummy3: f32,\nnoiseCoordinates2 : vec3<f32>,\ndummy4: f32,\n#endif\n#ifdef ANGULARSPEEDGRADIENTS\nangle : f32,\n#else\nangle : vec2<f32>,\n#endif\n#ifdef ANIMATESHEET\ncellIndex : f32,\n#ifdef ANIMATESHEETRANDOMSTART\ncellStartOffset : f32,\n#endif\n#endif\n};\nstruct Particles {\nparticles : array<Particle>,\n};\nstruct SimParams {\ncurrentCount : f32,\ntimeDelta : f32,\nstopFactor : f32,\nrandomTextureSize: i32,\nlifeTime : vec2<f32>,\nemitPower : vec2<f32>,\n#ifndef COLORGRADIENTS\ncolor1 : vec4<f32>,\ncolor2 : vec4<f32>,\n#endif\nsizeRange : vec2<f32>,\nscaleRange : vec4<f32>,\nangleRange : vec4<f32>,\ngravity : vec3<f32>,\n#ifdef LIMITVELOCITYGRADIENTS\nlimitVelocityDamping : f32,\n#endif\n#ifdef ANIMATESHEET\ncellInfos : vec4<f32>,\n#endif\n#ifdef NOISE\nnoiseStrength : vec3<f32>,\n#endif\n#ifndef LOCAL\nemitterWM : mat4x4<f32>,\n#endif\n#ifdef BOXEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\nminEmitBox : vec3<f32>,\nmaxEmitBox : vec3<f32>,\n#endif\n#ifdef CONEEMITTER\nradius : vec2<f32>,\nconeAngle : f32,\nheight : vec2<f32>,\ndirectionRandomizer : f32,\n#endif\n#ifdef CYLINDEREMITTER\nradius : f32,\nheight : f32,\nradiusRange : f32,\n#ifdef DIRECTEDCYLINDEREMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#else\ndirectionRandomizer : f32,\n#endif\n#endif\n#ifdef HEMISPHERICEMITTER\nradius : f32,\nradiusRange : f32,\ndirectionRandomizer : f32,\n#endif\n#ifdef POINTEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#endif\n#ifdef SPHEREEMITTER\nradius : f32,\nradiusRange : f32,\n#ifdef DIRECTEDSPHEREEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#else\ndirectionRandomizer : f32,\n#endif\n#endif\n};\n@binding(0) @group(0) var<uniform> params : SimParams;\n@binding(1) @group(0) var<storage,read> particlesIn : Particles;\n@binding(2) @group(0) var<storage,read_write> particlesOut : Particles;\n@binding(3) @group(0) var randomTexture : texture_2d<f32>;\n@binding(4) @group(0) var randomTexture2 : texture_2d<f32>;\n#ifdef SIZEGRADIENTS\n@binding(0) @group(1) var sizeGradientSampler : sampler;\n@binding(1) @group(1) var sizeGradientTexture : texture_2d<f32>;\n#endif \n#ifdef ANGULARSPEEDGRADIENTS\n@binding(2) @group(1) var angularSpeedGradientSampler : sampler;\n@binding(3) @group(1) var angularSpeedGradientTexture : texture_2d<f32>;\n#endif \n#ifdef VELOCITYGRADIENTS\n@binding(4) @group(1) var velocityGradientSampler : sampler;\n@binding(5) @group(1) var velocityGradientTexture : texture_2d<f32>;\n#endif\n#ifdef LIMITVELOCITYGRADIENTS\n@binding(6) @group(1) var limitVelocityGradientSampler : sampler;\n@binding(7) @group(1) var limitVelocityGradientTexture : texture_2d<f32>;\n#endif\n#ifdef DRAGGRADIENTS\n@binding(8) @group(1) var dragGradientSampler : sampler;\n@binding(9) @group(1) var dragGradientTexture : texture_2d<f32>;\n#endif\n#ifdef NOISE\n@binding(10) @group(1) var noiseSampler : sampler;\n@binding(11) @group(1) var noiseTexture : texture_2d<f32>;\n#endif\nfn getRandomVec3(offset : f32,vertexID : f32)->vec3<f32> {\nreturn textureLoad(randomTexture2,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0).rgb;\n}\nfn getRandomVec4(offset : f32,vertexID : f32)->vec4<f32> {\nreturn textureLoad(randomTexture,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0);\n}\n@compute @workgroup_size(64)\nfn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {\nlet index : u32=GlobalInvocationID.x;\nlet vertexID : f32=f32(index);\nif (index>=u32(params.currentCount)) {\nreturn;\n}\nlet PI : f32=3.14159;\nlet timeDelta : f32=params.timeDelta;\nlet newAge : f32=particlesIn.particles[index].age+timeDelta;\nlet life : f32=particlesIn.particles[index].life;\nlet seed : vec4<f32>=particlesIn.particles[index].seed;\nlet direction : vec3<f32>=particlesIn.particles[index].direction;\nif (newAge>=life && params.stopFactor != 0.) {\nvar newPosition : vec3<f32>;\nvar newDirection : vec3<f32>;\nlet randoms : vec4<f32>=getRandomVec4(seed.x,vertexID);\nlet outLife : f32=params.lifeTime.x+(params.lifeTime.y-params.lifeTime.x)*randoms.r;\nparticlesOut.particles[index].life=outLife;\nparticlesOut.particles[index].age=newAge-life;\nparticlesOut.particles[index].seed=seed;\nvar sizex : f32;\n#ifdef SIZEGRADIENTS \nsizex=textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(0.,0.),0.).r;\n#else\nsizex=params.sizeRange.x+(params.sizeRange.y-params.sizeRange.x)*randoms.g;\n#endif\nparticlesOut.particles[index].size=vec3<f32>(\nsizex,\nparams.scaleRange.x+(params.scaleRange.y-params.scaleRange.x)*randoms.b,\nparams.scaleRange.z+(params.scaleRange.w-params.scaleRange.z)*randoms.a);\n#ifndef COLORGRADIENTS\nparticlesOut.particles[index].color=params.color1+(params.color2-params.color1)*randoms.b;\n#endif\n#ifndef ANGULARSPEEDGRADIENTS \nparticlesOut.particles[index].angle=vec2<f32>(\nparams.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r,\nparams.angleRange.x+(params.angleRange.y-params.angleRange.x)*randoms.a);\n#else\nparticlesOut.particles[index].angle=params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r;\n#endif \n#if defined(POINTEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);\nlet randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);\nnewPosition=vec3<f32>(0.,0.,0.);\nnewDirection=params.direction1+(params.direction2-params.direction1)*randoms3;\n#elif defined(BOXEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);\nlet randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);\nnewPosition=params.minEmitBox+(params.maxEmitBox-params.minEmitBox)*randoms2;\nnewDirection=params.direction1+(params.direction2-params.direction1)*randoms3; \n#elif defined(HEMISPHERICEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);\nlet randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);\nlet phi : f32=2.0*PI*randoms2.x;\nlet theta : f32=acos(-1.0+2.0*randoms2.y);\nlet randX : f32=cos(phi)*sin(theta);\nlet randY : f32=cos(theta);\nlet randZ : f32=sin(phi)*sin(theta);\nnewPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,abs(randY),randZ);\nnewDirection=normalize(newPosition+params.directionRandomizer*randoms3);\n#elif defined(SPHEREEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);\nlet randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);\nlet phi : f32=2.0*PI*randoms2.x;\nlet theta : f32=acos(-1.0+2.0*randoms2.y);\nlet randX : f32=cos(phi)*sin(theta);\nlet randY : f32=cos(theta);\nlet randZ : f32=sin(phi)*sin(theta);\nnewPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,randY,randZ);\n#ifdef DIRECTEDSPHEREEMITTER\nnewDirection=normalize(params.direction1+(params.direction2-params.direction1)*randoms3);\n#else\nnewDirection=normalize(newPosition+params.directionRandomizer*randoms3);\n#endif\n#elif defined(CYLINDEREMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);\nlet randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);\nlet yPos : f32=(-0.5+randoms2.x)*params.height;\nvar angle : f32=randoms2.y*PI*2.;\nlet inverseRadiusRangeSquared : f32=(1.-params.radiusRange)*(1.-params.radiusRange);\nlet positionRadius : f32=params.radius*sqrt(inverseRadiusRangeSquared+randoms2.z*(1.-inverseRadiusRangeSquared));\nlet xPos : f32=positionRadius*cos(angle);\nlet zPos : f32=positionRadius*sin(angle);\nnewPosition=vec3<f32>(xPos,yPos,zPos);\n#ifdef DIRECTEDCYLINDEREMITTER\nnewDirection=params.direction1+(params.direction2-params.direction1)*randoms3;\n#else\nangle=angle+(-0.5+randoms3.x)*PI*params.directionRandomizer;\nnewDirection=vec3<f32>(cos(angle),(-0.5+randoms3.y)*params.directionRandomizer,sin(angle));\nnewDirection=normalize(newDirection);\n#endif\n#elif defined(CONEEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);\nlet s : f32=2.0*PI*randoms2.x;\n#ifdef CONEEMITTERSPAWNPOINT\nlet h : f32=0.0001;\n#else\nvar h : f32=randoms2.y*params.height.y;\nh=1.-h*h; \n#endif\nvar lRadius : f32=params.radius.x-params.radius.x*randoms2.z*params.radius.y;\nlRadius=lRadius*h;\nlet randX : f32=lRadius*sin(s);\nlet randZ : f32=lRadius*cos(s);\nlet randY : f32=h *params.height.x;\nnewPosition=vec3<f32>(randX,randY,randZ); \nif (abs(cos(params.coneAngle))==1.0) {\nnewDirection=vec3<f32>(0.,1.0,0.);\n} else {\nlet randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);\nnewDirection=normalize(newPosition+params.directionRandomizer*randoms3); \n}\n#elif defined(CUSTOMEMITTER)\nnewPosition=particlesIn.particles[index].initialPosition;\nparticlesOut.particles[index].initialPosition=newPosition;\n#else \nnewPosition=vec3<f32>(0.,0.,0.);\nnewDirection=2.0*(getRandomVec3(seed.w,vertexID)-vec3<f32>(0.5,0.5,0.5));\n#endif\nlet power : f32=params.emitPower.x+(params.emitPower.y-params.emitPower.x)*randoms.a;\n#ifdef LOCAL\nparticlesOut.particles[index].position=newPosition;\n#else\nparticlesOut.particles[index].position=(params.emitterWM*vec4<f32>(newPosition,1.)).xyz;\n#endif\n#ifdef CUSTOMEMITTER\nparticlesOut.particles[index].direction=direction;\n#ifndef BILLBOARD \nparticlesOut.particles[index].initialDirection=direction;\n#endif\n#else\n#ifdef LOCAL\nlet initial : vec3<f32>=newDirection;\n#else \nlet initial : vec3<f32>=(params.emitterWM*vec4<f32>(newDirection,0.)).xyz;\n#endif\nparticlesOut.particles[index].direction=initial*power;\n#ifndef BILLBOARD \nparticlesOut.particles[index].initialDirection=initial;\n#endif\n#endif\n#ifdef ANIMATESHEET \nparticlesOut.particles[index].cellIndex=params.cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\nparticlesOut.particles[index].cellStartOffset=randoms.a*outLife;\n#endif \n#endif\n#ifdef NOISE\nparticlesOut.particles[index].noiseCoordinates1=particlesIn.particles[index].noiseCoordinates1;\nparticlesOut.particles[index].noiseCoordinates2=particlesIn.particles[index].noiseCoordinates2;\n#endif\n} else {\nvar directionScale : f32=timeDelta;\nparticlesOut.particles[index].age=newAge;\nlet ageGradient : f32=newAge/life;\n#ifdef VELOCITYGRADIENTS\ndirectionScale=directionScale*textureSampleLevel(velocityGradientTexture,velocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;\n#endif\n#ifdef DRAGGRADIENTS\ndirectionScale=directionScale*(1.0-textureSampleLevel(dragGradientTexture,dragGradientSampler,vec2<f32>(ageGradient,0.),0.).r);\n#endif\nlet position : vec3<f32>=particlesIn.particles[index].position;\n#if defined(CUSTOMEMITTER)\nparticlesOut.particles[index].position=position+(direction-position)*ageGradient; \nparticlesOut.particles[index].initialPosition=particlesIn.particles[index].initialPosition;\n#else\nparticlesOut.particles[index].position=position+direction*directionScale;\n#endif\nparticlesOut.particles[index].life=life;\nparticlesOut.particles[index].seed=seed;\n#ifndef COLORGRADIENTS \nparticlesOut.particles[index].color=particlesIn.particles[index].color;\n#endif\n#ifdef SIZEGRADIENTS\nparticlesOut.particles[index].size=vec3<f32>(\ntextureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(ageGradient,0.),0.).r,\nparticlesIn.particles[index].size.yz);\n#else\nparticlesOut.particles[index].size=particlesIn.particles[index].size;\n#endif \n#ifndef BILLBOARD \nparticlesOut.particles[index].initialDirection=particlesIn.particles[index].initialDirection;\n#endif\n#ifdef CUSTOMEMITTER\nparticlesOut.particles[index].direction=direction;\n#else\nvar updatedDirection : vec3<f32>=direction+params.gravity*timeDelta;\n#ifdef LIMITVELOCITYGRADIENTS\nlet limitVelocity : f32=textureSampleLevel(limitVelocityGradientTexture,limitVelocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;\nlet currentVelocity : f32=length(updatedDirection);\nif (currentVelocity>limitVelocity) {\nupdatedDirection=updatedDirection*params.limitVelocityDamping;\n}\n#endif\nparticlesOut.particles[index].direction=updatedDirection;\n#ifdef NOISE\nlet noiseCoordinates1 : vec3<f32>=particlesIn.particles[index].noiseCoordinates1;\nlet noiseCoordinates2 : vec3<f32>=particlesIn.particles[index].noiseCoordinates2;\nlet fetchedR : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.x,noiseCoordinates1.y)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;\nlet fetchedG : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.z,noiseCoordinates2.x)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;\nlet fetchedB : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates2.y,noiseCoordinates2.z)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;\nlet force : vec3<f32>=vec3<f32>(-1.+2.*fetchedR,-1.+2.*fetchedG,-1.+2.*fetchedB)*params.noiseStrength;\nparticlesOut.particles[index].direction=particlesOut.particles[index].direction+force*timeDelta;\nparticlesOut.particles[index].noiseCoordinates1=noiseCoordinates1;\nparticlesOut.particles[index].noiseCoordinates2=noiseCoordinates2;\n#endif \n#endif \n#ifdef ANGULARSPEEDGRADIENTS\nlet angularSpeed : f32=textureSampleLevel(angularSpeedGradientTexture,angularSpeedGradientSampler,vec2<f32>(ageGradient,0.),0.).r;\nparticlesOut.particles[index].angle=particlesIn.particles[index].angle+angularSpeed*timeDelta;\n#else\nlet angle : vec2<f32>=particlesIn.particles[index].angle;\nparticlesOut.particles[index].angle=vec2<f32>(angle.x+angle.y*timeDelta,angle.y);\n#endif\n#ifdef ANIMATESHEET \nvar offsetAge : f32=particlesOut.particles[index].age;\nlet dist : f32=params.cellInfos.y-params.cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\nlet cellStartOffset : f32=particlesIn.particles[index].cellStartOffset;\nparticlesOut.particles[index].cellStartOffset=cellStartOffset;\noffsetAge=offsetAge+cellStartOffset;\n#else\nlet cellStartOffset : f32=0.;\n#endif \nvar ratio : f32;\nif (params.cellInfos.w==1.0) {\nratio=clamp(((cellStartOffset+params.cellInfos.z*offsetAge) % life)/life,0.,1.0);\n}\nelse {\nratio=clamp((cellStartOffset+params.cellInfos.z*offsetAge)/life,0.,1.0);\n}\nparticlesOut.particles[index].cellIndex=f32(i32(params.cellInfos.x+ratio*dist));\n#endif\n}\n}\n",le("BABYLON.ComputeShaderParticleSystem",class nle{constructor(e,t){this._bufferComputeShader=[],this._renderVertexBuffers=[],this.alignDataInBuffer=!0,this._parent=e,this._engine=t}isUpdateBufferCreated(){return!!this._updateComputeShader}isUpdateBufferReady(){var e,t;return null!==(t=null===(e=this._updateComputeShader)||void 0===e?void 0:e.isReady())&&void 0!==t&&t}createUpdateBuffer(e){var t;const i={params:{group:0,binding:0},particlesIn:{group:0,binding:1},particlesOut:{group:0,binding:2},randomTexture:{group:0,binding:3},randomTexture2:{group:0,binding:4}};return this._parent._sizeGradientsTexture&&(i.sizeGradientTexture={group:1,binding:1}),this._parent._angularSpeedGradientsTexture&&(i.angularSpeedGradientTexture={group:1,binding:3}),this._parent._velocityGradientsTexture&&(i.velocityGradientTexture={group:1,binding:5}),this._parent._limitVelocityGradientsTexture&&(i.limitVelocityGradientTexture={group:1,binding:7}),this._parent._dragGradientsTexture&&(i.dragGradientTexture={group:1,binding:9}),this._parent.noiseTexture&&(i.noiseTexture={group:1,binding:11}),this._updateComputeShader=new Cp("updateParticles",this._engine,"gpuUpdateParticles",{bindingsMapping:i,defines:e.split("\n")}),null===(t=this._simParamsComputeShader)||void 0===t||t.dispose(),this._simParamsComputeShader=new Se(this._engine),this._simParamsComputeShader.addUniform("currentCount",1),this._simParamsComputeShader.addUniform("timeDelta",1),this._simParamsComputeShader.addUniform("stopFactor",1),this._simParamsComputeShader.addUniform("randomTextureSize",1),this._simParamsComputeShader.addUniform("lifeTime",2),this._simParamsComputeShader.addUniform("emitPower",2),this._parent._colorGradientsTexture||(this._simParamsComputeShader.addUniform("color1",4),this._simParamsComputeShader.addUniform("color2",4)),this._simParamsComputeShader.addUniform("sizeRange",2),this._simParamsComputeShader.addUniform("scaleRange",4),this._simParamsComputeShader.addUniform("angleRange",4),this._simParamsComputeShader.addUniform("gravity",3),this._parent._limitVelocityGradientsTexture&&this._simParamsComputeShader.addUniform("limitVelocityDamping",1),this._parent.isAnimationSheetEnabled&&this._simParamsComputeShader.addUniform("cellInfos",4),this._parent.noiseTexture&&this._simParamsComputeShader.addUniform("noiseStrength",3),this._parent.isLocal||this._simParamsComputeShader.addUniform("emitterWM",16),this._parent.particleEmitterType&&this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader),this._updateComputeShader.setUniformBuffer("params",this._simParamsComputeShader),new gz(this._simParamsComputeShader)}createVertexBuffers(e,t){this._renderVertexBuffers.push(t)}createParticleBuffer(e){const t=new Ese(this._engine,4*e.length,11);return t.update(e),this._bufferComputeShader.push(t),t.getBuffer()}bindDrawBuffers(e,t){this._engine.bindBuffers(this._renderVertexBuffers[e],null,t)}preUpdateParticleBuffer(){}updateParticleBuffer(e,t,i){this._simParamsComputeShader.update(),this._updateComputeShader.setTexture("randomTexture",this._parent._randomTexture,!1),this._updateComputeShader.setTexture("randomTexture2",this._parent._randomTexture2,!1),this._parent._sizeGradientsTexture&&this._updateComputeShader.setTexture("sizeGradientTexture",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateComputeShader.setTexture("angularSpeedGradientTexture",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateComputeShader.setTexture("velocityGradientTexture",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateComputeShader.setTexture("limitVelocityGradientTexture",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateComputeShader.setTexture("dragGradientTexture",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateComputeShader.setTexture("noiseTexture",this._parent.noiseTexture),this._updateComputeShader.setStorageBuffer("particlesIn",this._bufferComputeShader[e]),this._updateComputeShader.setStorageBuffer("particlesOut",this._bufferComputeShader[1^e]),this._updateComputeShader.dispatch(Math.ceil(i/64))}releaseBuffers(){var e;for(let t=0;t<this._bufferComputeShader.length;++t)this._bufferComputeShader[t].dispose();this._bufferComputeShader.length=0,null===(e=this._simParamsComputeShader)||void 0===e||e.dispose(),this._simParamsComputeShader=null,this._updateComputeShader=null}releaseVertexBuffers(){this._renderVertexBuffers.length=0}});class Ez{constructor(e,t,i){this.gradient=e,this.color1=t,this.color2=i}getColorToRef(e){this.color2?Te.LerpToRef(this.color1,this.color2,Math.random(),e):e.copyFrom(this.color1)}}class ole{constructor(e,t){this.gradient=e,this.color=t}}class Cz{constructor(e,t,i){this.gradient=e,this.factor1=t,this.factor2=i}getFactor(){return void 0===this.factor2||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()}}class yn{static GetCurrentGradient(e,t,i){if(t[0].gradient>e)return void i(t[0],t[0],1);for(let n=0;n<t.length-1;n++){const o=t[n],a=t[n+1];if(e>=o.gradient&&e<=a.gradient)return void i(o,a,(e-o.gradient)/(a.gradient-o.gradient))}const s=t.length-1;i(t[s],t[s],1)}}let ale=(()=>{class r{constructor(t){this.particleSystem=t,this.position=v.Zero(),this.direction=v.Zero(),this.color=new Te(0,0,0,0),this.colorStep=new Te(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new de(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new Te(0,0,0,0),this._currentColor2=new Te(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=r._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}_updateCellInfoFromSystem(){this.cellIndex=this.particleSystem.startSpriteCellID}updateCellIndex(){let t=this.age,i=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(void 0===this._randomCellOffset&&(this._randomCellOffset=Math.random()*this.lifeTime),0===i?(i=1,t=this._randomCellOffset):t+=this._randomCellOffset);const s=this._initialEndSpriteCellID-this._initialStartSpriteCellID;let n;n=oe.Clamp(this._initialSpriteCellLoop?t*i%this.lifeTime/this.lifeTime:t*i/this.lifeTime),this.cellIndex=this._initialStartSpriteCellID+n*s|0}_inheritParticleInfoToSubEmitter(t){if(t.particleSystem.emitter.position){const i=t.particleSystem.emitter;if(i.position.copyFrom(this.position),t.inheritDirection){const s=L.Vector3[0];this.direction.normalizeToRef(s),i.setDirection(s,0,Math.PI/2)}}else t.particleSystem.emitter.copyFrom(this.position);this.direction.scaleToRef(t.inheritedVelocityAmount/2,L.Vector3[0]),t.particleSystem._inheritedVelocityOffset.copyFrom(L.Vector3[0])}_inheritParticleInfoToSubEmitters(){this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach(t=>{this._inheritParticleInfoToSubEmitter(t)})}_reset(){this.age=0,this.id=r._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0}copyTo(t){t.position.copyFrom(this.position),this._initialDirection?t._initialDirection?t._initialDirection.copyFrom(this._initialDirection):t._initialDirection=this._initialDirection.clone():t._initialDirection=null,t.direction.copyFrom(this.direction),this._localPosition&&(t._localPosition?t._localPosition.copyFrom(this._localPosition):t._localPosition=this._localPosition.clone()),t.color.copyFrom(this.color),t.colorStep.copyFrom(this.colorStep),t.lifeTime=this.lifeTime,t.age=this.age,t._randomCellOffset=this._randomCellOffset,t.size=this.size,t.scale.copyFrom(this.scale),t.angle=this.angle,t.angularSpeed=this.angularSpeed,t.particleSystem=this.particleSystem,t.cellIndex=this.cellIndex,t.id=this.id,t._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(t._currentColorGradient=this._currentColorGradient,t._currentColor1.copyFrom(this._currentColor1),t._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(t._currentSizeGradient=this._currentSizeGradient,t._currentSize1=this._currentSize1,t._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(t._currentAngularSpeedGradient=this._currentAngularSpeedGradient,t._currentAngularSpeed1=this._currentAngularSpeed1,t._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(t._currentVelocityGradient=this._currentVelocityGradient,t._currentVelocity1=this._currentVelocity1,t._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(t._currentLimitVelocityGradient=this._currentLimitVelocityGradient,t._currentLimitVelocity1=this._currentLimitVelocity1,t._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(t._currentDragGradient=this._currentDragGradient,t._currentDrag1=this._currentDrag1,t._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(t._initialStartSpriteCellID=this._initialStartSpriteCellID,t._initialEndSpriteCellID=this._initialEndSpriteCellID,t._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(t.remapData&&this.remapData?t.remapData.copyFrom(this.remapData):t.remapData=new vt(0,0,0,0)),this._randomNoiseCoordinates1&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),t._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(t._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),t._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))}}return r._Count=0,r})();var pd=(()=>{return(r=pd||(pd={}))[r.ATTACHED=0]="ATTACHED",r[r.END=1]="END",pd;var r})();class fc{constructor(e){if(this.particleSystem=e,this.type=pd.END,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!e.emitter||!e.emitter.dispose){const t=hs("BABYLON.AbstractMesh");e.emitter=new t("SubemitterSystemEmitter",e.getScene()),e._disposeEmitterOnDispose=!0}}clone(){let e=this.particleSystem.emitter;e?e instanceof v?e=e.clone():-1!==e.getClassName().indexOf("Mesh")&&(e=new(hs("BABYLON.Mesh"))("",e.getScene()),e.isVisible=!1):e=new v;const t=new fc(this.particleSystem.clone(this.particleSystem.name,e));return t.particleSystem.name+="Clone",t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem._disposeEmitterOnDispose=!0,t.particleSystem.disposeOnStop=!0,t}serialize(e=!1){const t={};return t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem=this.particleSystem.serialize(e),t}static _ParseParticleSystem(e,t,i,s=!1){throw Ge("ParseParticle")}static Parse(e,t,i){const n=new fc(fc._ParseParticleSystem(e.particleSystem,t,i,!0));return n.type=e.type,n.inheritDirection=e.inheritDirection,n.inheritedVelocityAmount=e.inheritedVelocityAmount,n.particleSystem._isSubEmitter=!0,n}dispose(){this.particleSystem.dispose()}}j.ShadersStore.particlesPixelShader="#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nvarying vec2 vUV;\nvarying vec4 vColor;\nuniform vec4 textureMask;\nuniform sampler2D diffuseSampler;\n#include<clipPlaneFragmentDeclaration>\n#include<imageProcessingDeclaration>\n#include<logDepthDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#ifdef RAMPGRADIENT\nvarying vec4 remapRanges;\nuniform sampler2D rampSampler;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec4 textureColor=texture2D(diffuseSampler,vUV);\nvec4 baseColor=(textureColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;\n#ifdef RAMPGRADIENT\nfloat alpha=baseColor.a;\nfloat remappedColorIndex=clamp((alpha-remapRanges.x)/remapRanges.y,0.0,1.0);\nvec4 rampColor=texture2D(rampSampler,vec2(1.0-remappedColorIndex,0.));\nbaseColor.rgb*=rampColor.rgb;\nfloat finalAlpha=baseColor.a;\nbaseColor.a=clamp((alpha*rampColor.a-remapRanges.z)/remapRanges.w,0.0,1.0);\n#endif\n#ifdef BLENDMULTIPLYMODE\nfloat sourceAlpha=vColor.a*textureColor.a;\nbaseColor.rgb=baseColor.rgb*sourceAlpha+vec3(1.0)*(1.0-sourceAlpha);\n#endif\n#include<logDepthFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\nbaseColor.rgb=toLinearSpace(baseColor.rgb);\n#else\n#ifdef IMAGEPROCESSING\nbaseColor.rgb=toLinearSpace(baseColor.rgb);\nbaseColor=applyImageProcessing(baseColor);\n#endif\n#endif\ngl_FragColor=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";j.ShadersStore.particlesVertexShader="attribute vec3 position;\nattribute vec4 color;\nattribute float angle;\nattribute vec2 size;\n#ifdef ANIMATESHEET\nattribute float cellIndex;\n#endif\n#ifndef BILLBOARD\nattribute vec3 direction;\n#endif\n#ifdef BILLBOARDSTRETCHED\nattribute vec3 direction;\n#endif\n#ifdef RAMPGRADIENT\nattribute vec4 remapData;\n#endif\nattribute vec2 offset;\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec2 translationPivot;\n#ifdef ANIMATESHEET\nuniform vec3 particlesInfos; \n#endif\nvarying vec2 vUV;\nvarying vec4 vColor;\nvarying vec3 vPositionW;\n#ifdef RAMPGRADIENT\nvarying vec4 remapRanges;\n#endif\n#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)\nuniform mat4 invView;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<logDepthDeclaration>\n#ifdef BILLBOARD\nuniform vec3 eyePosition;\n#endif\nvec3 rotate(vec3 yaxis,vec3 rotatedCorner) {\nvec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));\nvec3 zaxis=normalize(cross(yaxis,xaxis));\nvec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);\nvec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);\nvec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);\nmat3 rotMatrix= mat3(row0,row1,row2);\nvec3 alignedCorner=rotMatrix*rotatedCorner;\nreturn position+alignedCorner;\n}\n#ifdef BILLBOARDSTRETCHED\nvec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {\nvec3 normalizedToCamera=normalize(toCamera);\nvec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));\nvec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);\nvec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);\n#ifdef BILLBOARDSTRETCHED_LOCAL\nvec3 row1=direction;\n#else\nvec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));\nvec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);\n#endif\nmat3 rotMatrix= mat3(row0,row1,row2);\nvec3 alignedCorner=rotMatrix*rotatedCorner;\nreturn position+alignedCorner;\n}\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec2 cornerPos;\ncornerPos=(vec2(offset.x-0.5,offset.y -0.5)-translationPivot)*size+translationPivot;\n#ifdef BILLBOARD\nvec3 rotatedCorner;\n#ifdef BILLBOARDY\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.y=0.;\nvec3 yaxis=position-eyePosition;\nyaxis.y=0.;\nvPositionW=rotate(normalize(yaxis),rotatedCorner);\nvec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;\n#elif defined(BILLBOARDSTRETCHED)\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\nvec3 toCamera=position-eyePosition;\nvPositionW=rotateAlign(toCamera,rotatedCorner);\nvec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;\n#else\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\nvec3 viewPos=(view*vec4(position,1.0)).xyz+rotatedCorner;\nvPositionW=(invView*vec4(viewPos,1)).xyz;\n#endif\n#ifdef RAMPGRADIENT\nremapRanges=remapData;\n#endif\ngl_Position=projection*vec4(viewPos,1.0);\n#else\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.y=0.;\nvec3 yaxis=normalize(direction);\nvPositionW=rotate(yaxis,rotatedCorner);\ngl_Position=projection*view*vec4(vPositionW,1.0);\n#endif\nvColor=color;\n#ifdef ANIMATESHEET\nfloat rowOffset=floor(cellIndex*particlesInfos.z);\nfloat columnOffset=cellIndex-rowOffset/particlesInfos.z;\nvec2 uvScale=particlesInfos.xy;\nvec2 uvOffset=vec2(offset.x ,1.0-offset.y);\nvUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;\n#else\nvUV=offset;\n#endif\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nvec4 worldPos=vec4(vPositionW,1.0);\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";let Hi=(()=>{class r extends hv{set onDispose(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)}get useRampGradients(){return this._useRampGradients}set useRampGradients(t){this._useRampGradients!==t&&(this._useRampGradients=t,this._resetEffect())}get particles(){return this._particles}getActiveCount(){return this._particles.length}getClassName(){return"ParticleSystem"}isStopping(){return this._stopped&&this.isAlive()}getCustomEffect(t=0){var i,s;return null!==(s=null===(i=this._customWrappers[t])||void 0===i?void 0:i.effect)&&void 0!==s?s:this._customWrappers[0].effect}_getCustomDrawWrapper(t=0){var i;return null!==(i=this._customWrappers[t])&&void 0!==i?i:this._customWrappers[0]}setCustomEffect(t,i=0){this._customWrappers[i]=new $i(this._engine),this._customWrappers[i].effect=t,this._customWrappers[i].drawContext&&(this._customWrappers[i].drawContext.useInstancing=this._useInstancing)}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new z),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"particles"}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}constructor(t,i,s,n=null,o=!1,a=.01){super(t),this._emitterInverseWorldMatrix=F.Identity(),this._inheritedVelocityOffset=new v,this.onDisposeObservable=new z,this.onStoppedObservable=new z,this._particles=new Array,this._stockParticles=new Array,this._newPartsExcess=0,this._vertexBuffers={},this._scaledColorStep=new Te(0,0,0,0),this._colorDiff=new Te(0,0,0,0),this._scaledDirection=v.Zero(),this._scaledGravity=v.Zero(),this._currentRenderId=-1,this._useInstancing=!1,this._started=!1,this._stopped=!1,this._actualFrame=0,this._currentEmitRate1=0,this._currentEmitRate2=0,this._currentStartSize1=0,this._currentStartSize2=0,this.updateInAnimate=!0,this._rawTextureWidth=256,this._useRampGradients=!1,this._disposeEmitterOnDispose=!1,this.isLocal=!1,this.isGPU=!1,this._onBeforeDrawParticlesObservable=null,this.recycleParticle=c=>{const h=this._particles.pop();h!==c&&h.copyTo(c),this._stockParticles.push(h)},this._createParticle=()=>{let c;if(0!==this._stockParticles.length?(c=this._stockParticles.pop(),c._reset()):c=new ale(this),this._subEmitters&&this._subEmitters.length>0){const h=this._subEmitters[Math.floor(Math.random()*this._subEmitters.length)];c._attachedSubEmitters=[],h.forEach(u=>{if(u.type===pd.ATTACHED){const d=u.clone();c._attachedSubEmitters.push(d),d.particleSystem.start()}})}return c},this._emitFromParticle=c=>{if(!this._subEmitters||0===this._subEmitters.length)return;const h=Math.floor(Math.random()*this._subEmitters.length);this._subEmitters[h].forEach(u=>{if(u.type===pd.END){const d=u.clone();c._inheritParticleInfoToSubEmitter(d),d.particleSystem._rootParticleSystem=this,this.activeSubSystems.push(d.particleSystem),d.particleSystem.start()}})},this._capacity=i,this._epsilon=a,this._isAnimationSheetEnabled=o,s&&"Scene"!==s.getClassName()?(this._engine=s,this.defaultProjectionMatrix=F.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)):(this._scene=s||be.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._attachImageProcessingConfiguration(null),this._customWrappers={0:new $i(this._engine)},this._customWrappers[0].effect=n,this._drawWrappers=[],this._useInstancing=this._engine.getCaps().instancedArrays,this._createIndexBuffer(),this._createVertexBuffers(),this.particleEmitterType=new ah;let l=null;this.updateFunction=c=>{var h;let u=null;this.noiseTexture&&(u=this.noiseTexture.getSize(),null===(h=this.noiseTexture.getContent())||void 0===h||h.then(d=>{l=d}));for(let d=0;d<c.length;d++){const f=c[d];let p=this._scaledUpdateSpeed;const _=f.age;f.age+=p,f.age>f.lifeTime&&(p=(f.lifeTime-_)*p/(f.age-_),f.age=f.lifeTime);const m=f.age/f.lifeTime;this._colorGradients&&this._colorGradients.length>0?yn.GetCurrentGradient(m,this._colorGradients,(b,y,T)=>{b!==f._currentColorGradient&&(f._currentColor1.copyFrom(f._currentColor2),y.getColorToRef(f._currentColor2),f._currentColorGradient=b),Te.LerpToRef(f._currentColor1,f._currentColor2,T,f.color)}):(f.colorStep.scaleToRef(p,this._scaledColorStep),f.color.addInPlace(this._scaledColorStep),f.color.a<0&&(f.color.a=0)),this._angularSpeedGradients&&this._angularSpeedGradients.length>0&&yn.GetCurrentGradient(m,this._angularSpeedGradients,(b,y,T)=>{b!==f._currentAngularSpeedGradient&&(f._currentAngularSpeed1=f._currentAngularSpeed2,f._currentAngularSpeed2=y.getFactor(),f._currentAngularSpeedGradient=b),f.angularSpeed=oe.Lerp(f._currentAngularSpeed1,f._currentAngularSpeed2,T)}),f.angle+=f.angularSpeed*p;let g=p;if(this._velocityGradients&&this._velocityGradients.length>0&&yn.GetCurrentGradient(m,this._velocityGradients,(b,y,T)=>{b!==f._currentVelocityGradient&&(f._currentVelocity1=f._currentVelocity2,f._currentVelocity2=y.getFactor(),f._currentVelocityGradient=b),g*=oe.Lerp(f._currentVelocity1,f._currentVelocity2,T)}),f.direction.scaleToRef(g,this._scaledDirection),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&yn.GetCurrentGradient(m,this._limitVelocityGradients,(b,y,T)=>{b!==f._currentLimitVelocityGradient&&(f._currentLimitVelocity1=f._currentLimitVelocity2,f._currentLimitVelocity2=y.getFactor(),f._currentLimitVelocityGradient=b);const x=oe.Lerp(f._currentLimitVelocity1,f._currentLimitVelocity2,T);f.direction.length()>x&&f.direction.scaleInPlace(this.limitVelocityDamping)}),this._dragGradients&&this._dragGradients.length>0&&yn.GetCurrentGradient(m,this._dragGradients,(b,y,T)=>{b!==f._currentDragGradient&&(f._currentDrag1=f._currentDrag2,f._currentDrag2=y.getFactor(),f._currentDragGradient=b);const x=oe.Lerp(f._currentDrag1,f._currentDrag2,T);this._scaledDirection.scaleInPlace(1-x)}),this.isLocal&&f._localPosition?(f._localPosition.addInPlace(this._scaledDirection),v.TransformCoordinatesToRef(f._localPosition,this._emitterWorldMatrix,f.position)):f.position.addInPlace(this._scaledDirection),l&&u&&f._randomNoiseCoordinates1){const b=this._fetchR(f._randomNoiseCoordinates1.x,f._randomNoiseCoordinates1.y,u.width,u.height,l),y=this._fetchR(f._randomNoiseCoordinates1.z,f._randomNoiseCoordinates2.x,u.width,u.height,l),T=this._fetchR(f._randomNoiseCoordinates2.y,f._randomNoiseCoordinates2.z,u.width,u.height,l),x=L.Vector3[0],S=L.Vector3[1];x.copyFromFloats((2*b-1)*this.noiseStrength.x,(2*y-1)*this.noiseStrength.y,(2*T-1)*this.noiseStrength.z),x.scaleToRef(p,S),f.direction.addInPlace(S)}this.gravity.scaleToRef(p,this._scaledGravity),f.direction.addInPlace(this._scaledGravity),this._sizeGradients&&this._sizeGradients.length>0&&yn.GetCurrentGradient(m,this._sizeGradients,(b,y,T)=>{b!==f._currentSizeGradient&&(f._currentSize1=f._currentSize2,f._currentSize2=y.getFactor(),f._currentSizeGradient=b),f.size=oe.Lerp(f._currentSize1,f._currentSize2,T)}),this._useRampGradients&&(this._colorRemapGradients&&this._colorRemapGradients.length>0&&yn.GetCurrentGradient(m,this._colorRemapGradients,(b,y,T)=>{const x=oe.Lerp(b.factor1,y.factor1,T),S=oe.Lerp(b.factor2,y.factor2,T);f.remapData.x=x,f.remapData.y=S-x}),this._alphaRemapGradients&&this._alphaRemapGradients.length>0&&yn.GetCurrentGradient(m,this._alphaRemapGradients,(b,y,T)=>{const x=oe.Lerp(b.factor1,y.factor1,T),S=oe.Lerp(b.factor2,y.factor2,T);f.remapData.z=x,f.remapData.w=S-x})),this._isAnimationSheetEnabled&&f.updateCellIndex(),f._inheritParticleInfoToSubEmitters(),f.age>=f.lifeTime&&(this._emitFromParticle(f),f._attachedSubEmitters&&(f._attachedSubEmitters.forEach(b=>{b.particleSystem.disposeOnStop=!0,b.particleSystem.stop()}),f._attachedSubEmitters=null),this.recycleParticle(f),d--)}}}_addFactorGradient(t,i,s,n){const o=new Cz(i,s,n);t.push(o),t.sort((a,l)=>a.gradient<l.gradient?-1:a.gradient>l.gradient?1:0)}_removeFactorGradient(t,i){if(!t)return;let s=0;for(const n of t){if(n.gradient===i){t.splice(s,1);break}s++}}addLifeTimeGradient(t,i,s){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,t,i,s),this}removeLifeTimeGradient(t){return this._removeFactorGradient(this._lifeTimeGradients,t),this}addSizeGradient(t,i,s){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,t,i,s),this}removeSizeGradient(t){return this._removeFactorGradient(this._sizeGradients,t),this}addColorRemapGradient(t,i,s){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,t,i,s),this}removeColorRemapGradient(t){return this._removeFactorGradient(this._colorRemapGradients,t),this}addAlphaRemapGradient(t,i,s){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,t,i,s),this}removeAlphaRemapGradient(t){return this._removeFactorGradient(this._alphaRemapGradients,t),this}addAngularSpeedGradient(t,i,s){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,t,i,s),this}removeAngularSpeedGradient(t){return this._removeFactorGradient(this._angularSpeedGradients,t),this}addVelocityGradient(t,i,s){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,t,i,s),this}removeVelocityGradient(t){return this._removeFactorGradient(this._velocityGradients,t),this}addLimitVelocityGradient(t,i,s){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,t,i,s),this}removeLimitVelocityGradient(t){return this._removeFactorGradient(this._limitVelocityGradients,t),this}addDragGradient(t,i,s){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,t,i,s),this}removeDragGradient(t){return this._removeFactorGradient(this._dragGradients,t),this}addEmitRateGradient(t,i,s){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,t,i,s),this}removeEmitRateGradient(t){return this._removeFactorGradient(this._emitRateGradients,t),this}addStartSizeGradient(t,i,s){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,t,i,s),this}removeStartSizeGradient(t){return this._removeFactorGradient(this._startSizeGradients,t),this}_createRampGradientTexture(){if(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)return;const t=new Uint8Array(4*this._rawTextureWidth),i=wt.Color3[0];for(let s=0;s<this._rawTextureWidth;s++)yn.GetCurrentGradient(s/this._rawTextureWidth,this._rampGradients,(o,a,l)=>{re.LerpToRef(o.color,a.color,l,i),t[4*s]=255*i.r,t[4*s+1]=255*i.g,t[4*s+2]=255*i.b,t[4*s+3]=255});this._rampGradientsTexture=pr.CreateRGBATexture(t,this._rawTextureWidth,1,this._scene,!1,!1,1)}getRampGradients(){return this._rampGradients}forceRefreshGradients(){this._syncRampGradientTexture()}_syncRampGradientTexture(){!this._rampGradients||(this._rampGradients.sort((t,i)=>t.gradient<i.gradient?-1:t.gradient>i.gradient?1:0),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())}addRampGradient(t,i){this._rampGradients||(this._rampGradients=[]);const s=new ole(t,i);return this._rampGradients.push(s),this._syncRampGradientTexture(),this}removeRampGradient(t){return this._removeGradientAndTexture(t,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this}addColorGradient(t,i,s){this._colorGradients||(this._colorGradients=[]);const n=new Ez(t,i,s);return this._colorGradients.push(n),this._colorGradients.sort((o,a)=>o.gradient<a.gradient?-1:o.gradient>a.gradient?1:0),this}removeColorGradient(t){if(!this._colorGradients)return this;let i=0;for(const s of this._colorGradients){if(s.gradient===t){this._colorGradients.splice(i,1);break}i++}return this}resetDrawCache(){for(const t of this._drawWrappers)if(t)for(const i of t)i?.dispose();this._drawWrappers=[]}_fetchR(t,i,s,n,o){return o[4*(((t=.5*Math.abs(t)+.5)*s%s|0)+((i=.5*Math.abs(i)+.5)*n%n|0)*s)]/255}_reset(){this._resetEffect()}_resetEffect(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()}_createVertexBuffers(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),(!this._isBillboardBased||this.billboardMode===r.BILLBOARDMODE_STRETCHED||this.billboardMode===r.BILLBOARDMODE_STRETCHED_LOCAL)&&(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);const t=this._engine,i=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*i),this._vertexBuffer=new kn(t,this._vertexData,!0,i);let s=0;const n=this._vertexBuffer.createVertexBuffer(A.PositionKind,s,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[A.PositionKind]=n,s+=3;const o=this._vertexBuffer.createVertexBuffer(A.ColorKind,s,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[A.ColorKind]=o,s+=4;const a=this._vertexBuffer.createVertexBuffer("angle",s,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=a,s+=1;const l=this._vertexBuffer.createVertexBuffer("size",s,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=l,s+=2,this._isAnimationSheetEnabled){const h=this._vertexBuffer.createVertexBuffer("cellIndex",s,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=h,s+=1}if(!this._isBillboardBased||this.billboardMode===r.BILLBOARDMODE_STRETCHED||this.billboardMode===r.BILLBOARDMODE_STRETCHED_LOCAL){const h=this._vertexBuffer.createVertexBuffer("direction",s,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=h,s+=3}if(this._useRampGradients){const h=this._vertexBuffer.createVertexBuffer("remapData",s,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=h,s+=4}let c;if(this._useInstancing){const h=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new kn(t,h,!1,2),c=this._spriteBuffer.createVertexBuffer("offset",0,2)}else c=this._vertexBuffer.createVertexBuffer("offset",s,2,this._vertexBufferSize,this._useInstancing),s+=2;this._vertexBuffers.offset=c,this.resetDrawCache()}_createIndexBuffer(){if(this._useInstancing)return;const t=[];let i=0;for(let s=0;s<this._capacity;s++)t.push(i),t.push(i+1),t.push(i+2),t.push(i),t.push(i+2),t.push(i+3),i+=4;this._indexBuffer=this._engine.createIndexBuffer(t)}getCapacity(){return this._capacity}isAlive(){return this._alive}isStarted(){return this._started}_prepareSubEmitterInternalArray(){this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach(t=>{t instanceof r?this._subEmitters.push([new fc(t)]):t instanceof fc?this._subEmitters.push([t]):t instanceof Array&&this._subEmitters.push(t)})}start(t=this.startDelay){var i;if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(t)setTimeout(()=>{this.start(0)},t);else{if(this._prepareSubEmitterInternalArray(),this._started=!0,this._stopped=!1,this._actualFrame=0,this._subEmitters&&0!=this._subEmitters.length&&(this.activeSubSystems=new Array),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){-1!==(null===(i=this.emitter)||void 0===i?void 0:i.getClassName().indexOf("Mesh"))&&this.emitter.computeWorldMatrix(!0);const s=this.noiseTexture;if(s&&s.onGeneratedObservable)s.onGeneratedObservable.addOnce(()=>{setTimeout(()=>{for(let n=0;n<this.preWarmCycles;n++)this.animate(!0),s.render()})});else for(let n=0;n<this.preWarmCycles;n++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}}stop(t=!0){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,t&&this._stopSubEmitters())}reset(){this._stockParticles.length=0,this._particles.length=0}_appendParticleVertex(t,i,s,n){let o=t*this._vertexBufferSize;if(this._vertexData[o++]=i.position.x+this.worldOffset.x,this._vertexData[o++]=i.position.y+this.worldOffset.y,this._vertexData[o++]=i.position.z+this.worldOffset.z,this._vertexData[o++]=i.color.r,this._vertexData[o++]=i.color.g,this._vertexData[o++]=i.color.b,this._vertexData[o++]=i.color.a,this._vertexData[o++]=i.angle,this._vertexData[o++]=i.scale.x*i.size,this._vertexData[o++]=i.scale.y*i.size,this._isAnimationSheetEnabled&&(this._vertexData[o++]=i.cellIndex),this._isBillboardBased)(this.billboardMode===r.BILLBOARDMODE_STRETCHED||this.billboardMode===r.BILLBOARDMODE_STRETCHED_LOCAL)&&(this._vertexData[o++]=i.direction.x,this._vertexData[o++]=i.direction.y,this._vertexData[o++]=i.direction.z);else if(i._initialDirection){let a=i._initialDirection;this.isLocal&&(v.TransformNormalToRef(a,this._emitterWorldMatrix,L.Vector3[0]),a=L.Vector3[0]),0===a.x&&0===a.z&&(a.x=.001),this._vertexData[o++]=a.x,this._vertexData[o++]=a.y,this._vertexData[o++]=a.z}else{let a=i.direction;this.isLocal&&(v.TransformNormalToRef(a,this._emitterWorldMatrix,L.Vector3[0]),a=L.Vector3[0]),0===a.x&&0===a.z&&(a.x=.001),this._vertexData[o++]=a.x,this._vertexData[o++]=a.y,this._vertexData[o++]=a.z}this._useRampGradients&&i.remapData&&(this._vertexData[o++]=i.remapData.x,this._vertexData[o++]=i.remapData.y,this._vertexData[o++]=i.remapData.z,this._vertexData[o++]=i.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(0===s?s=this._epsilon:1===s&&(s=1-this._epsilon),0===n?n=this._epsilon:1===n&&(n=1-this._epsilon)),this._vertexData[o++]=s,this._vertexData[o++]=n)}_stopSubEmitters(){!this.activeSubSystems||(this.activeSubSystems.forEach(t=>{t.stop(!0)}),this.activeSubSystems=new Array)}_removeFromRoot(){if(!this._rootParticleSystem)return;const t=this._rootParticleSystem.activeSubSystems.indexOf(this);-1!==t&&this._rootParticleSystem.activeSubSystems.splice(t,1),this._rootParticleSystem=null}_update(t){if(this._alive=this._particles.length>0,this.emitter.position)this._emitterWorldMatrix=this.emitter.getWorldMatrix();else{const s=this.emitter;this._emitterWorldMatrix=F.Translation(s.x,s.y,s.z)}let i;this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles);for(let s=0;s<t&&this._particles.length!==this._capacity;s++){if(i=this._createParticle(),this._particles.push(i),this.targetStopDuration&&this._lifeTimeGradients&&this._lifeTimeGradients.length>0){const o=oe.Clamp(this._actualFrame/this.targetStopDuration);yn.GetCurrentGradient(o,this._lifeTimeGradients,(a,l)=>{const c=a,h=l,u=c.getFactor(),d=h.getFactor();i.lifeTime=oe.Lerp(u,d,(o-c.gradient)/(h.gradient-c.gradient))})}else i.lifeTime=oe.RandomRange(this.minLifeTime,this.maxLifeTime);const n=oe.RandomRange(this.minEmitPower,this.maxEmitPower);if(this.startPositionFunction?this.startPositionFunction(this._emitterWorldMatrix,i.position,i,this.isLocal):this.particleEmitterType.startPositionFunction(this._emitterWorldMatrix,i.position,i,this.isLocal),this.isLocal&&(i._localPosition?i._localPosition.copyFrom(i.position):i._localPosition=i.position.clone(),v.TransformCoordinatesToRef(i._localPosition,this._emitterWorldMatrix,i.position)),this.startDirectionFunction?this.startDirectionFunction(this._emitterWorldMatrix,i.direction,i,this.isLocal):this.particleEmitterType.startDirectionFunction(this._emitterWorldMatrix,i.direction,i,this.isLocal,this._emitterInverseWorldMatrix),0===n?i._initialDirection?i._initialDirection.copyFrom(i.direction):i._initialDirection=i.direction.clone():i._initialDirection=null,i.direction.scaleInPlace(n),this._sizeGradients&&0!==this._sizeGradients.length?(i._currentSizeGradient=this._sizeGradients[0],i._currentSize1=i._currentSizeGradient.getFactor(),i.size=i._currentSize1,i._currentSize2=this._sizeGradients.length>1?this._sizeGradients[1].getFactor():i._currentSize1):i.size=oe.RandomRange(this.minSize,this.maxSize),i.scale.copyFromFloats(oe.RandomRange(this.minScaleX,this.maxScaleX),oe.RandomRange(this.minScaleY,this.maxScaleY)),this._startSizeGradients&&this._startSizeGradients[0]&&this.targetStopDuration&&yn.GetCurrentGradient(this._actualFrame/this.targetStopDuration,this._startSizeGradients,(a,l,c)=>{a!==this._currentStartSizeGradient&&(this._currentStartSize1=this._currentStartSize2,this._currentStartSize2=l.getFactor(),this._currentStartSizeGradient=a);const h=oe.Lerp(this._currentStartSize1,this._currentStartSize2,c);i.scale.scaleInPlace(h)}),this._angularSpeedGradients&&0!==this._angularSpeedGradients.length?(i._currentAngularSpeedGradient=this._angularSpeedGradients[0],i.angularSpeed=i._currentAngularSpeedGradient.getFactor(),i._currentAngularSpeed1=i.angularSpeed,i._currentAngularSpeed2=this._angularSpeedGradients.length>1?this._angularSpeedGradients[1].getFactor():i._currentAngularSpeed1):i.angularSpeed=oe.RandomRange(this.minAngularSpeed,this.maxAngularSpeed),i.angle=oe.RandomRange(this.minInitialRotation,this.maxInitialRotation),this._velocityGradients&&this._velocityGradients.length>0&&(i._currentVelocityGradient=this._velocityGradients[0],i._currentVelocity1=i._currentVelocityGradient.getFactor(),i._currentVelocity2=this._velocityGradients.length>1?this._velocityGradients[1].getFactor():i._currentVelocity1),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&(i._currentLimitVelocityGradient=this._limitVelocityGradients[0],i._currentLimitVelocity1=i._currentLimitVelocityGradient.getFactor(),i._currentLimitVelocity2=this._limitVelocityGradients.length>1?this._limitVelocityGradients[1].getFactor():i._currentLimitVelocity1),this._dragGradients&&this._dragGradients.length>0&&(i._currentDragGradient=this._dragGradients[0],i._currentDrag1=i._currentDragGradient.getFactor(),i._currentDrag2=this._dragGradients.length>1?this._dragGradients[1].getFactor():i._currentDrag1),this._colorGradients&&0!==this._colorGradients.length)i._currentColorGradient=this._colorGradients[0],i._currentColorGradient.getColorToRef(i.color),i._currentColor1.copyFrom(i.color),this._colorGradients.length>1?this._colorGradients[1].getColorToRef(i._currentColor2):i._currentColor2.copyFrom(i.color);else{const o=oe.RandomRange(0,1);Te.LerpToRef(this.color1,this.color2,o,i.color),this.colorDead.subtractToRef(i.color,this._colorDiff),this._colorDiff.scaleToRef(1/i.lifeTime,i.colorStep)}this._isAnimationSheetEnabled&&(i._initialStartSpriteCellID=this.startSpriteCellID,i._initialEndSpriteCellID=this.endSpriteCellID,i._initialSpriteCellLoop=this.spriteCellLoop),i.direction.addInPlace(this._inheritedVelocityOffset),this._useRampGradients&&(i.remapData=new vt(0,1,0,1)),this.noiseTexture&&(i._randomNoiseCoordinates1?(i._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),i._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(i._randomNoiseCoordinates1=new v(Math.random(),Math.random(),Math.random()),i._randomNoiseCoordinates2=new v(Math.random(),Math.random(),Math.random()))),i._inheritParticleInfoToSubEmitters()}}static _GetAttributeNamesOrOptions(t=!1,i=!1,s=!1){const n=[A.PositionKind,A.ColorKind,"angle","offset","size"];return t&&n.push("cellIndex"),i||n.push("direction"),s&&n.push("remapData"),n}static _GetEffectCreationOptions(t=!1,i=!1){const s=["invView","view","projection","textureMask","translationPivot","eyePosition"];return Uo(s),t&&s.push("particlesInfos"),i&&s.push("logarithmicDepthConstant"),s}fillDefines(t,i){if(this._scene&&Za(this,this._scene,t),this._isAnimationSheetEnabled&&t.push("#define ANIMATESHEET"),this.useLogarithmicDepth&&t.push("#define LOGARITHMICDEPTH"),i===r.BLENDMODE_MULTIPLY&&t.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&t.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(t.push("#define BILLBOARD"),this.billboardMode){case r.BILLBOARDMODE_Y:t.push("#define BILLBOARDY");break;case r.BILLBOARDMODE_STRETCHED:case r.BILLBOARDMODE_STRETCHED_LOCAL:t.push("#define BILLBOARDSTRETCHED"),this.billboardMode===r.BILLBOARDMODE_STRETCHED_LOCAL&&t.push("#define BILLBOARDSTRETCHED_LOCAL");break;case r.BILLBOARDMODE_ALL:t.push("#define BILLBOARDMODE_ALL")}this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),t.push(this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(t,i,s){i.push(...r._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==r.BILLBOARDMODE_STRETCHED&&this.billboardMode!==r.BILLBOARDMODE_STRETCHED_LOCAL,this._useRampGradients)),t.push(...r._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth)),s.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(at.PrepareUniforms(t,this._imageProcessingConfigurationDefines),at.PrepareSamplers(s,this._imageProcessingConfigurationDefines))}_getWrapper(t){const i=this._getCustomDrawWrapper(t);if(i?.effect)return i;const s=[];this.fillDefines(s,t);const n=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0;let o=this._drawWrappers[n];o||(o=this._drawWrappers[n]=[]);let a=o[t];a||(a=new $i(this._engine),a.drawContext&&(a.drawContext.useInstancing=this._useInstancing),o[t]=a);const l=s.join("\n");if(a.defines!==l){const c=[],h=[],u=[];this.fillUniformsAttributesAndSamplerNames(h,c,u),a.setEffect(this._engine.createEffect("particles",c,h,u,l),l)}return a}animate(t=!1){var i;if(!this._started)return;if(!t&&this._scene){if(!this.isReady()||this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}let s;if(this._scaledUpdateSpeed=this.updateSpeed*(t?this.preWarmStepOffset:(null===(i=this._scene)||void 0===i?void 0:i.getAnimationRatio())||1),this.manualEmitCount>-1)s=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{let n=this.emitRate;this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration&&yn.GetCurrentGradient(this._actualFrame/this.targetStopDuration,this._emitRateGradients,(a,l,c)=>{a!==this._currentEmitRateGradient&&(this._currentEmitRate1=this._currentEmitRate2,this._currentEmitRate2=l.getFactor(),this._currentEmitRateGradient=a),n=oe.Lerp(this._currentEmitRate1,this._currentEmitRate2,c)}),s=n*this._scaledUpdateSpeed>>0,this._newPartsExcess+=n*this._scaledUpdateSpeed-s}if(this._newPartsExcess>1&&(s+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?s=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(s),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!t){let n=0;for(let o=0;o<this._particles.length;o++)this._appendParticleVertices(n,this._particles[o]),n+=this._useInstancing?1:4;this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}0===this.manualEmitCount&&this.disposeOnStop&&this.stop()}_appendParticleVertices(t,i){this._appendParticleVertex(t++,i,0,0),this._useInstancing||(this._appendParticleVertex(t++,i,1,0),this._appendParticleVertex(t++,i,1,1),this._appendParticleVertex(t++,i,0,1))}rebuild(){var t,i;this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),null===(t=this._spriteBuffer)||void 0===t||t._rebuild(),null===(i=this._vertexBuffer)||void 0===i||i._rebuild();for(const s in this._vertexBuffers)this._vertexBuffers[s]._rebuild();this.resetDrawCache()}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==r.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(r.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(r.BLENDMODE_ADD).effect.isReady())return!1;return!0}_render(t){var i,s;const n=this._getWrapper(t),o=n.effect,a=this._engine;a.enableEffect(n);const l=null!==(i=this.defaultViewMatrix)&&void 0!==i?i:this._scene.getViewMatrix();if(o.setTexture("diffuseSampler",this.particleTexture),o.setMatrix("view",l),o.setMatrix("projection",null!==(s=this.defaultProjectionMatrix)&&void 0!==s?s:this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){const h=this.particleTexture.getBaseSize();o.setFloat3("particlesInfos",this.spriteCellWidth/h.width,this.spriteCellHeight/h.height,this.spriteCellWidth/h.width)}o.setVector2("translationPivot",this.translationPivot),o.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene&&o.setVector3("eyePosition",this._scene.activeCamera.globalPosition),this._rampGradientsTexture&&((!this._rampGradients||!this._rampGradients.length)&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),o.setTexture("rampSampler",this._rampGradientsTexture));const c=o.defines;switch(this._scene&&fo(o,this,this._scene),c.indexOf("#define BILLBOARDMODE_ALL")>=0&&(l.invertToRef(L.Matrix[0]),o.setMatrix("invView",L.Matrix[0])),void 0!==this._vertexArrayObject?(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,o)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):a.bindBuffers(this._vertexBuffers,this._indexBuffer,o),this.useLogarithmicDepth&&this._scene&&ce.BindLogDepth(c,o,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(o),t){case r.BLENDMODE_ADD:a.setAlphaMode(1);break;case r.BLENDMODE_ONEONE:a.setAlphaMode(6);break;case r.BLENDMODE_STANDARD:a.setAlphaMode(2);break;case r.BLENDMODE_MULTIPLY:a.setAlphaMode(4)}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(o),this._useInstancing?a.drawArraysType(7,0,4,this._particles.length):a.drawElementsType(0,0,6*this._particles.length),this._particles.length}render(){if(!this.isReady()||!this._particles.length)return 0;const t=this._engine;t.setState&&(t.setState(!1),this.forceDepthWrite&&t.setDepthWrite(!0));let i=0;return i=this.blendMode===r.BLENDMODE_MULTIPLYADD?this._render(r.BLENDMODE_MULTIPLY)+this._render(r.BLENDMODE_ADD):this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),i}dispose(t=!0){if(this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),t&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),t&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),this._subEmitters&&this._subEmitters.length){for(let i=0;i<this._subEmitters.length;i++)for(const s of this._subEmitters[i])s.dispose();this._subEmitters=[],this.subEmitters=[]}if(this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){const i=this._scene.particleSystems.indexOf(this);i>-1&&this._scene.particleSystems.splice(i,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()}clone(t,i,s=!1){const n={...this._customWrappers};let o=null;const a=this._engine;if(a.createEffectForParticles&&null!=this.customShader){o=this.customShader;const h=o.shaderOptions.defines.length>0?o.shaderOptions.defines.join("\n"):"",u=a.createEffectForParticles(o.shaderPath.fragmentElement,o.shaderOptions.uniforms,o.shaderOptions.samplers,h);n[0]?n[0].effect=u:this.setCustomEffect(u,0)}const l=this.serialize(s),c=r.Parse(l,this._scene||this._engine,this._rootUrl);return c.name=t,c.customShader=o,c._customWrappers=n,void 0===i&&(i=this.emitter),this.noiseTexture&&(c.noiseTexture=this.noiseTexture.clone()),c.emitter=i,this.preventAutoStart||c.start(),c}serialize(t=!1){const i={};if(r._Serialize(i,this,t),i.textureMask=this.textureMask.asArray(),i.customShader=this.customShader,i.preventAutoStart=this.preventAutoStart,this.subEmitters){i.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(const s of this._subEmitters){const n=[];for(const o of s)n.push(o.serialize(t));i.subEmitters.push(n)}}return i}static _Serialize(t,i,s){t.name=i.name,t.id=i.id,t.capacity=i.getCapacity(),t.disposeOnStop=i.disposeOnStop,t.manualEmitCount=i.manualEmitCount,i.emitter.position?t.emitterId=i.emitter.id:t.emitter=i.emitter.asArray(),i.particleEmitterType&&(t.particleEmitterType=i.particleEmitterType.serialize()),i.particleTexture&&(s?t.texture=i.particleTexture.serialize():(t.textureName=i.particleTexture.name,t.invertY=!!i.particleTexture._invertY)),t.isLocal=i.isLocal,Ce.AppendSerializedAnimations(i,t),t.beginAnimationOnStart=i.beginAnimationOnStart,t.beginAnimationFrom=i.beginAnimationFrom,t.beginAnimationTo=i.beginAnimationTo,t.beginAnimationLoop=i.beginAnimationLoop,t.startDelay=i.startDelay,t.renderingGroupId=i.renderingGroupId,t.isBillboardBased=i.isBillboardBased,t.billboardMode=i.billboardMode,t.minAngularSpeed=i.minAngularSpeed,t.maxAngularSpeed=i.maxAngularSpeed,t.minSize=i.minSize,t.maxSize=i.maxSize,t.minScaleX=i.minScaleX,t.maxScaleX=i.maxScaleX,t.minScaleY=i.minScaleY,t.maxScaleY=i.maxScaleY,t.minEmitPower=i.minEmitPower,t.maxEmitPower=i.maxEmitPower,t.minLifeTime=i.minLifeTime,t.maxLifeTime=i.maxLifeTime,t.emitRate=i.emitRate,t.gravity=i.gravity.asArray(),t.noiseStrength=i.noiseStrength.asArray(),t.color1=i.color1.asArray(),t.color2=i.color2.asArray(),t.colorDead=i.colorDead.asArray(),t.updateSpeed=i.updateSpeed,t.targetStopDuration=i.targetStopDuration,t.blendMode=i.blendMode,t.preWarmCycles=i.preWarmCycles,t.preWarmStepOffset=i.preWarmStepOffset,t.minInitialRotation=i.minInitialRotation,t.maxInitialRotation=i.maxInitialRotation,t.startSpriteCellID=i.startSpriteCellID,t.spriteCellLoop=i.spriteCellLoop,t.endSpriteCellID=i.endSpriteCellID,t.spriteCellChangeSpeed=i.spriteCellChangeSpeed,t.spriteCellWidth=i.spriteCellWidth,t.spriteCellHeight=i.spriteCellHeight,t.spriteRandomStartCell=i.spriteRandomStartCell,t.isAnimationSheetEnabled=i.isAnimationSheetEnabled,t.useLogarithmicDepth=i.useLogarithmicDepth;const n=i.getColorGradients();if(n){t.colorGradients=[];for(const g of n){const b={gradient:g.gradient,color1:g.color1.asArray()};b.color2=g.color2?g.color2.asArray():g.color1.asArray(),t.colorGradients.push(b)}}const o=i.getRampGradients();if(o){t.rampGradients=[];for(const g of o){const b={gradient:g.gradient,color:g.color.asArray()};t.rampGradients.push(b)}t.useRampGradients=i.useRampGradients}const a=i.getColorRemapGradients();if(a){t.colorRemapGradients=[];for(const g of a){const b={gradient:g.gradient,factor1:g.factor1};b.factor2=void 0!==g.factor2?g.factor2:g.factor1,t.colorRemapGradients.push(b)}}const l=i.getAlphaRemapGradients();if(l){t.alphaRemapGradients=[];for(const g of l){const b={gradient:g.gradient,factor1:g.factor1};b.factor2=void 0!==g.factor2?g.factor2:g.factor1,t.alphaRemapGradients.push(b)}}const c=i.getSizeGradients();if(c){t.sizeGradients=[];for(const g of c){const b={gradient:g.gradient,factor1:g.factor1};b.factor2=void 0!==g.factor2?g.factor2:g.factor1,t.sizeGradients.push(b)}}const h=i.getAngularSpeedGradients();if(h){t.angularSpeedGradients=[];for(const g of h){const b={gradient:g.gradient,factor1:g.factor1};b.factor2=void 0!==g.factor2?g.factor2:g.factor1,t.angularSpeedGradients.push(b)}}const u=i.getVelocityGradients();if(u){t.velocityGradients=[];for(const g of u){const b={gradient:g.gradient,factor1:g.factor1};b.factor2=void 0!==g.factor2?g.factor2:g.factor1,t.velocityGradients.push(b)}}const d=i.getDragGradients();if(d){t.dragGradients=[];for(const g of d){const b={gradient:g.gradient,factor1:g.factor1};b.factor2=void 0!==g.factor2?g.factor2:g.factor1,t.dragGradients.push(b)}}const f=i.getEmitRateGradients();if(f){t.emitRateGradients=[];for(const g of f){const b={gradient:g.gradient,factor1:g.factor1};b.factor2=void 0!==g.factor2?g.factor2:g.factor1,t.emitRateGradients.push(b)}}const p=i.getStartSizeGradients();if(p){t.startSizeGradients=[];for(const g of p){const b={gradient:g.gradient,factor1:g.factor1};b.factor2=void 0!==g.factor2?g.factor2:g.factor1,t.startSizeGradients.push(b)}}const _=i.getLifeTimeGradients();if(_){t.lifeTimeGradients=[];for(const g of _){const b={gradient:g.gradient,factor1:g.factor1};b.factor2=void 0!==g.factor2?g.factor2:g.factor1,t.lifeTimeGradients.push(b)}}const m=i.getLimitVelocityGradients();if(m){t.limitVelocityGradients=[];for(const g of m){const b={gradient:g.gradient,factor1:g.factor1};b.factor2=void 0!==g.factor2?g.factor2:g.factor1,t.limitVelocityGradients.push(b)}t.limitVelocityDamping=i.limitVelocityDamping}i.noiseTexture&&(t.noiseTexture=i.noiseTexture.serialize())}static _Parse(t,i,s,n){var o,a,l;let c;c=s instanceof we?null:s;const h=hs("BABYLON.Texture");if(h&&c&&(t.texture?i.particleTexture=h.Parse(t.texture,c,n):t.textureName&&(i.particleTexture=new h(n+t.textureName,c,!1,void 0===t.invertY||t.invertY),i.particleTexture.name=t.textureName)),i.emitter=t.emitterId||0===t.emitterId||void 0!==t.emitter?t.emitterId&&c?c.getLastMeshById(t.emitterId):v.FromArray(t.emitter):v.Zero(),i.isLocal=!!t.isLocal,void 0!==t.renderingGroupId&&(i.renderingGroupId=t.renderingGroupId),void 0!==t.isBillboardBased&&(i.isBillboardBased=t.isBillboardBased),void 0!==t.billboardMode&&(i.billboardMode=t.billboardMode),void 0!==t.useLogarithmicDepth&&(i.useLogarithmicDepth=t.useLogarithmicDepth),t.animations){for(let d=0;d<t.animations.length;d++){const f=t.animations[d],p=hs("BABYLON.Animation");p&&i.animations.push(p.Parse(f))}i.beginAnimationOnStart=t.beginAnimationOnStart,i.beginAnimationFrom=t.beginAnimationFrom,i.beginAnimationTo=t.beginAnimationTo,i.beginAnimationLoop=t.beginAnimationLoop}if(t.autoAnimate&&c&&c.beginAnimation(i,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),i.startDelay=0|t.startDelay,i.minAngularSpeed=t.minAngularSpeed,i.maxAngularSpeed=t.maxAngularSpeed,i.minSize=t.minSize,i.maxSize=t.maxSize,t.minScaleX&&(i.minScaleX=t.minScaleX,i.maxScaleX=t.maxScaleX,i.minScaleY=t.minScaleY,i.maxScaleY=t.maxScaleY),void 0!==t.preWarmCycles&&(i.preWarmCycles=t.preWarmCycles,i.preWarmStepOffset=t.preWarmStepOffset),void 0!==t.minInitialRotation&&(i.minInitialRotation=t.minInitialRotation,i.maxInitialRotation=t.maxInitialRotation),i.minLifeTime=t.minLifeTime,i.maxLifeTime=t.maxLifeTime,i.minEmitPower=t.minEmitPower,i.maxEmitPower=t.maxEmitPower,i.emitRate=t.emitRate,i.gravity=v.FromArray(t.gravity),t.noiseStrength&&(i.noiseStrength=v.FromArray(t.noiseStrength)),i.color1=Te.FromArray(t.color1),i.color2=Te.FromArray(t.color2),i.colorDead=Te.FromArray(t.colorDead),i.updateSpeed=t.updateSpeed,i.targetStopDuration=t.targetStopDuration,i.blendMode=t.blendMode,t.colorGradients)for(const d of t.colorGradients)i.addColorGradient(d.gradient,Te.FromArray(d.color1),d.color2?Te.FromArray(d.color2):void 0);if(t.rampGradients){for(const d of t.rampGradients)i.addRampGradient(d.gradient,re.FromArray(d.color));i.useRampGradients=t.useRampGradients}if(t.colorRemapGradients)for(const d of t.colorRemapGradients)i.addColorRemapGradient(d.gradient,void 0!==d.factor1?d.factor1:d.factor,d.factor2);if(t.alphaRemapGradients)for(const d of t.alphaRemapGradients)i.addAlphaRemapGradient(d.gradient,void 0!==d.factor1?d.factor1:d.factor,d.factor2);if(t.sizeGradients)for(const d of t.sizeGradients)i.addSizeGradient(d.gradient,void 0!==d.factor1?d.factor1:d.factor,d.factor2);if(t.angularSpeedGradients)for(const d of t.angularSpeedGradients)i.addAngularSpeedGradient(d.gradient,void 0!==d.factor1?d.factor1:d.factor,d.factor2);if(t.velocityGradients)for(const d of t.velocityGradients)i.addVelocityGradient(d.gradient,void 0!==d.factor1?d.factor1:d.factor,d.factor2);if(t.dragGradients)for(const d of t.dragGradients)i.addDragGradient(d.gradient,void 0!==d.factor1?d.factor1:d.factor,d.factor2);if(t.emitRateGradients)for(const d of t.emitRateGradients)i.addEmitRateGradient(d.gradient,void 0!==d.factor1?d.factor1:d.factor,d.factor2);if(t.startSizeGradients)for(const d of t.startSizeGradients)i.addStartSizeGradient(d.gradient,void 0!==d.factor1?d.factor1:d.factor,d.factor2);if(t.lifeTimeGradients)for(const d of t.lifeTimeGradients)i.addLifeTimeGradient(d.gradient,void 0!==d.factor1?d.factor1:d.factor,d.factor2);if(t.limitVelocityGradients){for(const d of t.limitVelocityGradients)i.addLimitVelocityGradient(d.gradient,void 0!==d.factor1?d.factor1:d.factor,d.factor2);i.limitVelocityDamping=t.limitVelocityDamping}if(t.noiseTexture&&c){const d=hs("BABYLON.ProceduralTexture");i.noiseTexture=d.Parse(t.noiseTexture,c,n)}let u;if(t.particleEmitterType){switch(t.particleEmitterType.type){case"SphereParticleEmitter":u=new bp;break;case"SphereDirectedParticleEmitter":u=new cv;break;case"ConeEmitter":case"ConeParticleEmitter":u=new nv;break;case"CylinderParticleEmitter":u=new vp;break;case"CylinderDirectedParticleEmitter":u=new ov;break;case"HemisphericParticleEmitter":u=new av;break;case"PointParticleEmitter":u=new lv;break;case"MeshParticleEmitter":u=new OE;break;default:u=new ah}u.parse(t.particleEmitterType,c)}else u=new ah,u.parse(t,c);i.particleEmitterType=u,i.startSpriteCellID=t.startSpriteCellID,i.endSpriteCellID=t.endSpriteCellID,i.spriteCellLoop=null===(o=t.spriteCellLoop)||void 0===o||o,i.spriteCellWidth=t.spriteCellWidth,i.spriteCellHeight=t.spriteCellHeight,i.spriteCellChangeSpeed=t.spriteCellChangeSpeed,i.spriteRandomStartCell=t.spriteRandomStartCell,i.disposeOnStop=null!==(a=t.disposeOnStop)&&void 0!==a&&a,i.manualEmitCount=null!==(l=t.manualEmitCount)&&void 0!==l?l:-1}static Parse(t,i,s,n=!1,o){const a=t.name;let h,u,l=null,c=null;if(i instanceof we?h=i:(u=i,h=u.getEngine()),t.customShader&&h.createEffectForParticles){c=t.customShader;const f=c.shaderOptions.defines.length>0?c.shaderOptions.defines.join("\n"):"";l=h.createEffectForParticles(c.shaderPath.fragmentElement,c.shaderOptions.uniforms,c.shaderOptions.samplers,f)}const d=new r(a,o||t.capacity,i,l,t.isAnimationSheetEnabled);if(d.customShader=c,d._rootUrl=s,t.id&&(d.id=t.id),t.subEmitters){d.subEmitters=[];for(const f of t.subEmitters){const p=[];for(const _ of f)p.push(fc.Parse(_,i,s));d.subEmitters.push(p)}}return r._Parse(t,d,i,s),t.textureMask&&(d.textureMask=Te.FromArray(t.textureMask)),t.preventAutoStart&&(d.preventAutoStart=t.preventAutoStart),!n&&!d.preventAutoStart&&d.start(),d}}return r.BILLBOARDMODE_Y=2,r.BILLBOARDMODE_ALL=7,r.BILLBOARDMODE_STRETCHED=8,r.BILLBOARDMODE_STRETCHED_LOCAL=9,r})();fc._ParseParticleSystem=Hi.Parse;j.IncludesShadersStore.clipPlaneFragmentDeclaration2="#ifdef CLIPPLANE\nin float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nin float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nin float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nin float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nin float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nin float fClipDistance6;\n#endif\n";j.ShadersStore.gpuRenderParticlesPixelShader="precision highp float;\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform sampler2D diffuseSampler;\nvarying vec2 vUV;\nvarying vec4 vColor;\n#include<clipPlaneFragmentDeclaration2> \n#include<imageProcessingDeclaration>\n#include<logDepthDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\nvoid main() {\n#include<clipPlaneFragment> \nvec4 textureColor=texture2D(diffuseSampler,vUV);\ngl_FragColor=textureColor*vColor;\n#ifdef BLENDMULTIPLYMODE\nfloat alpha=vColor.a*textureColor.a;\ngl_FragColor.rgb=gl_FragColor.rgb*alpha+vec3(1.0)*(1.0-alpha);\n#endif \n#include<logDepthFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ngl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);\n#else\n#ifdef IMAGEPROCESSING\ngl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);\ngl_FragColor=applyImageProcessing(gl_FragColor);\n#endif\n#endif\n}\n";j.IncludesShadersStore.clipPlaneVertexDeclaration2="#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nout float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nuniform vec4 vClipPlane2;\nout float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nuniform vec4 vClipPlane3;\nout float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nuniform vec4 vClipPlane4;\nout float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nuniform vec4 vClipPlane5;\nout float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nuniform vec4 vClipPlane6;\nout float fClipDistance6;\n#endif\n";j.ShadersStore.gpuRenderParticlesVertexShader="precision highp float;\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec2 translationPivot;\nuniform vec3 worldOffset;\n#ifdef LOCAL\nuniform mat4 emitterWM;\n#endif\nattribute vec3 position;\nattribute float age;\nattribute float life;\nattribute vec3 size;\n#ifndef BILLBOARD\nattribute vec3 initialDirection;\n#endif\n#ifdef BILLBOARDSTRETCHED\nattribute vec3 direction;\n#endif\nattribute float angle;\n#ifdef ANIMATESHEET\nattribute float cellIndex;\n#endif\nattribute vec2 offset;\nattribute vec2 uv;\nvarying vec2 vUV;\nvarying vec4 vColor;\nvarying vec3 vPositionW;\n#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)\nuniform mat4 invView;\n#endif\n#include<clipPlaneVertexDeclaration2>\n#include<logDepthDeclaration>\n#ifdef COLORGRADIENTS\nuniform sampler2D colorGradientSampler;\n#else\nuniform vec4 colorDead;\nattribute vec4 color;\n#endif\n#ifdef ANIMATESHEET\nuniform vec3 sheetInfos;\n#endif\n#ifdef BILLBOARD\nuniform vec3 eyePosition;\n#endif\nvec3 rotate(vec3 yaxis,vec3 rotatedCorner) {\nvec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));\nvec3 zaxis=normalize(cross(yaxis,xaxis));\nvec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);\nvec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);\nvec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);\nmat3 rotMatrix= mat3(row0,row1,row2);\nvec3 alignedCorner=rotMatrix*rotatedCorner;\n#ifdef LOCAL\nreturn ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;\n#else\nreturn (position+worldOffset)+alignedCorner;\n#endif\n}\n#ifdef BILLBOARDSTRETCHED\nvec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {\nvec3 normalizedToCamera=normalize(toCamera);\nvec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));\nvec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));\nvec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);\nvec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);\nvec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);\nmat3 rotMatrix= mat3(row0,row1,row2);\nvec3 alignedCorner=rotMatrix*rotatedCorner;\n#ifdef LOCAL\nreturn ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;\n#else\nreturn (position+worldOffset)+alignedCorner;\n#endif\n}\n#endif\nvoid main() {\n#ifdef ANIMATESHEET\nfloat rowOffset=floor(cellIndex/sheetInfos.z);\nfloat columnOffset=cellIndex-rowOffset*sheetInfos.z;\nvec2 uvScale=sheetInfos.xy;\nvec2 uvOffset=vec2(uv.x ,1.0-uv.y);\nvUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;\n#else\nvUV=uv;\n#endif\nfloat ratio=age/life;\n#ifdef COLORGRADIENTS\nvColor=texture2D(colorGradientSampler,vec2(ratio,0));\n#else\nvColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);\n#endif\nvec2 cornerPos=(offset-translationPivot)*size.yz*size.x+translationPivot;\n#ifdef BILLBOARD\nvec4 rotatedCorner;\nrotatedCorner.w=0.;\n#ifdef BILLBOARDY\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.y=0.;\nvec3 yaxis=(position+worldOffset)-eyePosition;\nyaxis.y=0.;\nvPositionW=rotate(normalize(yaxis),rotatedCorner.xyz);\nvec4 viewPosition=(view*vec4(vPositionW,1.0));\n#elif defined(BILLBOARDSTRETCHED)\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\nvec3 toCamera=(position+worldOffset)-eyePosition;\nvPositionW=rotateAlign(toCamera,rotatedCorner.xyz);\nvec4 viewPosition=(view*vec4(vPositionW,1.0));\n#else\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\n#ifdef LOCAL\nvec4 viewPosition=view*vec4(((emitterWM*vec4(position,1.0)).xyz+worldOffset),1.0)+rotatedCorner;\n#else\nvec4 viewPosition=view*vec4((position+worldOffset),1.0)+rotatedCorner;\n#endif\nvPositionW=(invView*viewPosition).xyz;\n#endif\n#else\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=0.;\nrotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nvec3 yaxis=normalize(initialDirection);\nvPositionW=rotate(yaxis,rotatedCorner);\nvec4 viewPosition=view*vec4(vPositionW,1.0);\n#endif\ngl_Position=projection*viewPosition;\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nvec4 worldPos=vec4(vPositionW,1.0);\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n}";class Yo extends hv{static get IsSupported(){if(!be.LastCreatedEngine)return!1;const e=be.LastCreatedEngine.getCaps();return e.supportTransformFeedbacks||e.supportComputeShaders}getCapacity(){return this._capacity}get activeParticleCount(){return this._activeCount}set activeParticleCount(e){this._activeCount=Math.min(e,this._capacity)}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==Hi.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(Hi.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(Hi.BLENDMODE_ADD).effect.isReady())return!1;return this._platform.isUpdateBufferCreated()?this._platform.isUpdateBufferReady():(this._recreateUpdateEffect(),!1)}isStarted(){return this._started}isStopped(){return this._stopped}isStopping(){return!1}getActiveCount(){return this._currentActiveCount}start(e=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";e?setTimeout(()=>{this.start(0)},e):(this._started=!0,this._stopped=!1,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop))}stop(){this._stopped||(this._stopped=!0)}reset(){this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._currentActiveCount=0,this._targetIndex=0}getClassName(){return"GPUParticleSystem"}getCustomEffect(e=0){var t,i;return null!==(i=null===(t=this._customWrappers[e])||void 0===t?void 0:t.effect)&&void 0!==i?i:this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){var t;return null!==(t=this._customWrappers[e])&&void 0!==t?t:this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new $i(this._engine),this._customWrappers[t].effect=e}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new z),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"gpuRenderParticles"}get vertexBuffers(){return this._renderVertexBuffers[1^this._targetIndex]}get indexBuffer(){return null}_removeGradientAndTexture(e,t,i){return super._removeGradientAndTexture(e,t,i),this._releaseBuffers(),this}addColorGradient(e,t){this._colorGradients||(this._colorGradients=[]);const i=new Ez(e,t);return this._colorGradients.push(i),this._refreshColorGradient(!0),this._releaseBuffers(),this}_refreshColorGradient(e=!1){this._colorGradients&&(e&&this._colorGradients.sort((t,i)=>t.gradient<i.gradient?-1:t.gradient>i.gradient?1:0),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))}forceRefreshGradients(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()}removeColorGradient(e){return this._removeGradientAndTexture(e,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this}resetDrawCache(){var e;for(const t in this._drawWrappers)null===(e=this._drawWrappers[t].drawContext)||void 0===e||e.reset()}_addFactorGradient(e,t,i){const s=new Cz(t,i);e.push(s),this._releaseBuffers()}addSizeGradient(e,t){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this}removeSizeGradient(e){return this._removeGradientAndTexture(e,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this}_refreshFactorGradient(e,t,i=!1){if(!e)return;i&&e.sort((n,o)=>n.gradient<o.gradient?-1:n.gradient>o.gradient?1:0);const s=this;s[t]&&(s[t].dispose(),s[t]=null)}addAngularSpeedGradient(e,t){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this}removeAngularSpeedGradient(e){return this._removeGradientAndTexture(e,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this}addVelocityGradient(e,t){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this}removeVelocityGradient(e){return this._removeGradientAndTexture(e,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this}addLimitVelocityGradient(e,t){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this}removeLimitVelocityGradient(e){return this._removeGradientAndTexture(e,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this}addDragGradient(e,t){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this}removeDragGradient(e){return this._removeGradientAndTexture(e,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this}addEmitRateGradient(){return this}removeEmitRateGradient(){return this}addStartSizeGradient(){return this}removeStartSizeGradient(){return this}addColorRemapGradient(){return this}removeColorRemapGradient(){return this}addAlphaRemapGradient(){return this}removeAlphaRemapGradient(){return this}addRampGradient(){return this}removeRampGradient(){return this}getRampGradients(){return null}get useRampGradients(){return!1}set useRampGradients(e){}addLifeTimeGradient(){return this}removeLifeTimeGradient(){return this}constructor(e,t,i,s=null,n=!1){if(super(e),this.layerMask=268435455,this._accumulatedCount=0,this._renderVertexBuffers=[],this._targetIndex=0,this._currentRenderId=-1,this._currentRenderingCameraUniqueId=-1,this._started=!1,this._stopped=!1,this._timeDelta=0,this.updateInAnimate=!1,this._actualFrame=0,this._rawTextureWidth=256,this.onDisposeObservable=new z,this.onStoppedObservable=new z,this.forceDepthWrite=!1,this._preWarmDone=!1,this.isLocal=!1,this.isGPU=!0,this._onBeforeDrawParticlesObservable=null,i&&"Scene"!==i.getClassName()?(this._engine=i,this.defaultProjectionMatrix=F.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)):(this._scene=i||be.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)),this._engine.getCaps().supportComputeShaders){if(!hs("BABYLON.ComputeShaderParticleSystem"))throw new Error("The ComputeShaderParticleSystem class is not available! Make sure you have imported it.");this._platform=new(hs("BABYLON.ComputeShaderParticleSystem"))(this,this._engine)}else{if(!hs("BABYLON.WebGL2ParticleSystem"))throw new Error("The WebGL2ParticleSystem class is not available! Make sure you have imported it.");this._platform=new(hs("BABYLON.WebGL2ParticleSystem"))(this,this._engine)}this._customWrappers={0:new $i(this._engine)},this._customWrappers[0].effect=s,this._drawWrappers={0:new $i(this._engine)},this._drawWrappers[0].drawContext&&(this._drawWrappers[0].drawContext.useInstancing=!0),this._attachImageProcessingConfiguration(null),(t=t??{}).randomTextureSize||delete t.randomTextureSize;const o={capacity:5e4,randomTextureSize:this._engine.getCaps().maxTextureSize,...t},a=t;isFinite(a)&&(o.capacity=a),this._capacity=o.capacity,this._activeCount=o.capacity,this._currentActiveCount=0,this._isAnimationSheetEnabled=n,this.particleEmitterType=new ah;const l=Math.min(this._engine.getCaps().maxTextureSize,o.randomTextureSize);let c=[];for(let h=0;h<l;++h)c.push(Math.random()),c.push(Math.random()),c.push(Math.random()),c.push(Math.random());this._randomTexture=new pr(new Float32Array(c),l,1,5,i,!1,!1,1,1),this._randomTexture.name="GPUParticleSystem_random1",this._randomTexture.wrapU=1,this._randomTexture.wrapV=1,c=[];for(let h=0;h<l;++h)c.push(Math.random()),c.push(Math.random()),c.push(Math.random()),c.push(Math.random());this._randomTexture2=new pr(new Float32Array(c),l,1,5,i,!1,!1,1,1),this._randomTexture2.name="GPUParticleSystem_random2",this._randomTexture2.wrapU=1,this._randomTexture2.wrapV=1,this._randomTextureSize=l}_reset(){this._releaseBuffers()}_createVertexBuffers(e,t,i){const s={};s.position=t.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);let n=3;s.age=t.createVertexBuffer("age",n,1,this._attributesStrideSize,!0),n+=1,s.size=t.createVertexBuffer("size",n,3,this._attributesStrideSize,!0),n+=3,s.life=t.createVertexBuffer("life",n,1,this._attributesStrideSize,!0),n+=1,n+=4,this.billboardMode===Hi.BILLBOARDMODE_STRETCHED&&(s.direction=t.createVertexBuffer("direction",n,3,this._attributesStrideSize,!0)),n+=3,this._platform.alignDataInBuffer&&(n+=1),this.particleEmitterType instanceof lh&&(n+=3,this._platform.alignDataInBuffer&&(n+=1)),this._colorGradientsTexture||(s.color=t.createVertexBuffer("color",n,4,this._attributesStrideSize,!0),n+=4),this._isBillboardBased||(s.initialDirection=t.createVertexBuffer("initialDirection",n,3,this._attributesStrideSize,!0),n+=3,this._platform.alignDataInBuffer&&(n+=1)),this.noiseTexture&&(s.noiseCoordinates1=t.createVertexBuffer("noiseCoordinates1",n,3,this._attributesStrideSize,!0),n+=3,this._platform.alignDataInBuffer&&(n+=1),s.noiseCoordinates2=t.createVertexBuffer("noiseCoordinates2",n,3,this._attributesStrideSize,!0),n+=3,this._platform.alignDataInBuffer&&(n+=1)),s.angle=t.createVertexBuffer("angle",n,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?n++:n+=2,this._isAnimationSheetEnabled&&(s.cellIndex=t.createVertexBuffer("cellIndex",n,1,this._attributesStrideSize,!0),n+=1,this.spriteRandomStartCell&&(s.cellStartOffset=t.createVertexBuffer("cellStartOffset",n,1,this._attributesStrideSize,!0),n+=1)),s.offset=i.createVertexBuffer("offset",0,2),s.uv=i.createVertexBuffer("uv",2,2),this._renderVertexBuffers.push(s),this._platform.createVertexBuffers(e,s),this.resetDrawCache()}_initialize(e=!1){if(this._buffer0&&!e)return;const t=this._engine,i=new Array;this._attributesStrideSize=21,this._targetIndex=0,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1),this.particleEmitterType instanceof lh&&(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this.isBillboardBased||(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=2)),this._platform.alignDataInBuffer&&(this._attributesStrideSize+=3-(this._attributesStrideSize+3&3));const s=this.particleEmitterType instanceof lh,n=L.Vector3[0];let o=0;for(let h=0;h<this._capacity;h++)if(i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),s?(this.particleEmitterType.particleDestinationGenerator(h,null,n),i.push(n.x),i.push(n.y),i.push(n.z)):(i.push(0),i.push(0),i.push(0)),this._platform.alignDataInBuffer&&i.push(0),o+=16,s&&(this.particleEmitterType.particlePositionGenerator(h,null,n),i.push(n.x),i.push(n.y),i.push(n.z),this._platform.alignDataInBuffer&&i.push(0),o+=4),this._colorGradientsTexture||(i.push(0),i.push(0),i.push(0),i.push(0),o+=4),this.isBillboardBased||(i.push(0),i.push(0),i.push(0),this._platform.alignDataInBuffer&&i.push(0),o+=4),this.noiseTexture&&(i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),o+=8),i.push(0),o+=1,this._angularSpeedGradientsTexture||(i.push(0),o+=1),this._isAnimationSheetEnabled&&(i.push(0),o+=1,this.spriteRandomStartCell&&(i.push(0),o+=1)),this._platform.alignDataInBuffer){let u=3-(o+3&3);for(o+=u;u-- >0;)i.push(0)}const a=new Float32Array([.5,.5,1,1,-.5,.5,0,1,.5,-.5,1,0,-.5,-.5,0,0]),l=this._platform.createParticleBuffer(i),c=this._platform.createParticleBuffer(i);this._buffer0=new kn(t,l,!1,this._attributesStrideSize),this._buffer1=new kn(t,c,!1,this._attributesStrideSize),this._spriteBuffer=new kn(t,a,!1,4),this._renderVertexBuffers=[],this._createVertexBuffers(this._buffer0,this._buffer1,this._spriteBuffer),this._createVertexBuffers(this._buffer1,this._buffer0,this._spriteBuffer),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}_recreateUpdateEffect(){this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture();let e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";return this._isBillboardBased&&(e+="\n#define BILLBOARD"),this._colorGradientsTexture&&(e+="\n#define COLORGRADIENTS"),this._sizeGradientsTexture&&(e+="\n#define SIZEGRADIENTS"),this._angularSpeedGradientsTexture&&(e+="\n#define ANGULARSPEEDGRADIENTS"),this._velocityGradientsTexture&&(e+="\n#define VELOCITYGRADIENTS"),this._limitVelocityGradientsTexture&&(e+="\n#define LIMITVELOCITYGRADIENTS"),this._dragGradientsTexture&&(e+="\n#define DRAGGRADIENTS"),this.isAnimationSheetEnabled&&(e+="\n#define ANIMATESHEET",this.spriteRandomStartCell&&(e+="\n#define ANIMATESHEETRANDOMSTART")),this.noiseTexture&&(e+="\n#define NOISE"),this.isLocal&&(e+="\n#define LOCAL"),!(!this._platform.isUpdateBufferCreated()||this._cachedUpdateDefines!==e)||(this._cachedUpdateDefines=e,this._updateBuffer=this._platform.createUpdateBuffer(e),this._platform.isUpdateBufferReady())}_getWrapper(e){const t=this._getCustomDrawWrapper(e);if(t?.effect)return t;const i=[];this.fillDefines(i,e);let s=this._drawWrappers[e];s||(s=new $i(this._engine),s.drawContext&&(s.drawContext.useInstancing=!0),this._drawWrappers[e]=s);const n=i.join("\n");if(s.defines!==n){const o=[],a=[],l=[];this.fillUniformsAttributesAndSamplerNames(a,o,l),s.setEffect(this._engine.createEffect("gpuRenderParticles",o,a,l,n),n)}return s}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1,s=!1){const n=[A.PositionKind,"age","life","size","angle"];return e||n.push(A.ColorKind),t&&n.push("cellIndex"),i||n.push("initialDirection"),s||n.push("direction"),n.push("offset",A.UVKind),n}static _GetEffectCreationOptions(e=!1,t=!1){const i=["emitterWM","worldOffset","view","projection","colorDead","invView","translationPivot","eyePosition"];return Uo(i),e&&i.push("sheetInfos"),t&&i.push("logarithmicDepthConstant"),i}fillDefines(e,t=0){if(this._scene&&Za(this,this._scene,e),t===Hi.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this.isLocal&&e.push("#define LOCAL"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case Hi.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case Hi.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case Hi.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL")}this._colorGradientsTexture&&e.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(""+this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...Yo._GetAttributeNamesOrOptions(!!this._colorGradientsTexture,this._isAnimationSheetEnabled,this._isBillboardBased,this._isBillboardBased&&this.billboardMode===Hi.BILLBOARDMODE_STRETCHED)),e.push(...Yo._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth)),i.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(at.PrepareUniforms(e,this._imageProcessingConfigurationDefines),at.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}animate(e=!1){var t;this._timeDelta=this.updateSpeed*(e?this.preWarmStepOffset:(null===(t=this._scene)||void 0===t?void 0:t.getAnimationRatio())||1),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop(),this.updateInAnimate&&this._update()}_createFactorGradientTexture(e,t){if(!e||!e.length||this[t])return;const s=new Float32Array(this._rawTextureWidth);for(let n=0;n<this._rawTextureWidth;n++)yn.GetCurrentGradient(n/this._rawTextureWidth,e,(a,l,c)=>{s[n]=oe.Lerp(a.factor1,l.factor1,c)});this[t]=pr.CreateRTexture(s,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1),this[t].name=t.substring(1)}_createSizeGradientTexture(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")}_createAngularSpeedGradientTexture(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")}_createVelocityGradientTexture(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")}_createLimitVelocityGradientTexture(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")}_createDragGradientTexture(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")}_createColorGradientTexture(){if(!this._colorGradients||!this._colorGradients.length||this._colorGradientsTexture)return;const e=new Uint8Array(4*this._rawTextureWidth),t=wt.Color4[0];for(let i=0;i<this._rawTextureWidth;i++)yn.GetCurrentGradient(i/this._rawTextureWidth,this._colorGradients,(n,o,a)=>{Te.LerpToRef(n.color1,o.color1,a,t),e[4*i]=255*t.r,e[4*i+1]=255*t.g,e[4*i+2]=255*t.b,e[4*i+3]=255*t.a});this._colorGradientsTexture=pr.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1),this._colorGradientsTexture.name="colorGradients"}_render(e,t){var i,s;const n=this._getWrapper(e),o=n.effect;this._engine.enableEffect(n);const a=(null===(i=this._scene)||void 0===i?void 0:i.getViewMatrix())||F.IdentityReadOnly;if(o.setMatrix("view",a),o.setMatrix("projection",null!==(s=this.defaultProjectionMatrix)&&void 0!==s?s:this._scene.getProjectionMatrix()),o.setTexture("diffuseSampler",this.particleTexture),o.setVector2("translationPivot",this.translationPivot),o.setVector3("worldOffset",this.worldOffset),this.isLocal&&o.setMatrix("emitterWM",t),this._colorGradientsTexture?o.setTexture("colorGradientSampler",this._colorGradientsTexture):o.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){const c=this.particleTexture.getBaseSize();o.setFloat3("sheetInfos",this.spriteCellWidth/c.width,this.spriteCellHeight/c.height,c.width/this.spriteCellWidth)}this._isBillboardBased&&this._scene&&o.setVector3("eyePosition",this._scene.activeCamera.globalPosition);const l=o.defines;if(this._scene&&fo(o,this,this._scene),l.indexOf("#define BILLBOARDMODE_ALL")>=0){const c=a.clone();c.invert(),o.setMatrix("invView",c)}switch(this.useLogarithmicDepth&&this._scene&&ce.BindLogDepth(l,o,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(o),e){case Hi.BLENDMODE_ADD:this._engine.setAlphaMode(1);break;case Hi.BLENDMODE_ONEONE:this._engine.setAlphaMode(6);break;case Hi.BLENDMODE_STANDARD:this._engine.setAlphaMode(2);break;case Hi.BLENDMODE_MULTIPLY:this._engine.setAlphaMode(4)}return this._platform.bindDrawBuffers(this._targetIndex,o),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(o),this._engine.drawArraysType(7,0,4,this._currentActiveCount),this._engine.setAlphaMode(0),this._currentActiveCount}_update(e){if(!this.emitter||!this._targetBuffer||!this._recreateUpdateEffect())return;if(!e)if(this.emitter.position)e=this.emitter.getWorldMatrix();else{const i=this.emitter;F.TranslationToRef(i.x,i.y,i.z,e=L.Matrix[0])}this._platform.preUpdateParticleBuffer(),this._updateBuffer.setFloat("currentCount",this._currentActiveCount),this._updateBuffer.setFloat("timeDelta",this._timeDelta),this._updateBuffer.setFloat("stopFactor",this._stopped?0:1),this._updateBuffer.setInt("randomTextureSize",this._randomTextureSize),this._updateBuffer.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateBuffer.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateBuffer.setDirectColor4("color1",this.color1),this._updateBuffer.setDirectColor4("color2",this.color2)),this._updateBuffer.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateBuffer.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateBuffer.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateBuffer.setVector3("gravity",this.gravity),this._limitVelocityGradientsTexture&&this._updateBuffer.setFloat("limitVelocityDamping",this.limitVelocityDamping),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateBuffer),this._isAnimationSheetEnabled&&this._updateBuffer.setFloat4("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed,this.spriteCellLoop?1:0),this.noiseTexture&&this._updateBuffer.setVector3("noiseStrength",this.noiseStrength),this.isLocal||this._updateBuffer.setMatrix("emitterWM",e),this._platform.updateParticleBuffer(this._targetIndex,this._targetBuffer,this._currentActiveCount),this._targetIndex++,2===this._targetIndex&&(this._targetIndex=0);const t=this._sourceBuffer;this._sourceBuffer=this._targetBuffer,this._targetBuffer=t}render(e=!1,t=!1){if(!this._started||!this.isReady())return 0;if(!e&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(let o=0;o<this.preWarmCycles;o++)this.animate(!0),this.render(!0,!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getFrameId()&&(!this._scene.activeCamera||this._scene.activeCamera&&this._currentRenderingCameraUniqueId===this._scene.activeCamera.uniqueId))return 0;this._currentRenderId=this._scene.getFrameId(),this._scene.activeCamera&&(this._currentRenderingCameraUniqueId=this._scene.activeCamera.uniqueId)}if(this._initialize(),this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>1){const o=0|this._accumulatedCount;this._accumulatedCount-=o,this._currentActiveCount=Math.min(this._activeCount,this._currentActiveCount+o)}if(!this._currentActiveCount)return 0;let i;if(this.emitter.position)i=this.emitter.getWorldMatrix();else{const o=this.emitter;i=L.Matrix[0],F.TranslationToRef(o.x,o.y,o.z,i)}const s=this._engine;this.updateInAnimate||this._update(i);let n=0;return!e&&!t&&(s.setState(!1),this.forceDepthWrite&&s.setDepthWrite(!0),n=this.blendMode===Hi.BLENDMODE_MULTIPLYADD?this._render(Hi.BLENDMODE_MULTIPLY,i)+this._render(Hi.BLENDMODE_ADD,i):this._render(this.blendMode,i),this._engine.setAlphaMode(0)),n}rebuild(){this._initialize(!0)}_releaseBuffers(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._platform.releaseBuffers()}dispose(e=!0){for(const t in this._drawWrappers)this._drawWrappers[t].dispose();if(this._drawWrappers={},this._scene){const t=this._scene.particleSystems.indexOf(this);t>-1&&this._scene.particleSystems.splice(t,1)}this._releaseBuffers(),this._platform.releaseVertexBuffers();for(let t=0;t<this._renderVertexBuffers.length;++t){const i=this._renderVertexBuffers[t];for(const s in i)i[s].dispose()}this._renderVertexBuffers=[],this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}clone(e,t,i=!1){const s={...this._customWrappers};let n=null;const o=this._engine;if(o.createEffectForParticles&&null!=this.customShader){n=this.customShader;const c=n.shaderOptions.defines.length>0?n.shaderOptions.defines.join("\n"):"";s[0]=o.createEffectForParticles(n.shaderPath.fragmentElement,n.shaderOptions.uniforms,n.shaderOptions.samplers,c,void 0,void 0,void 0,this)}const a=this.serialize(i),l=Yo.Parse(a,this._scene||this._engine,this._rootUrl);return l.name=e,l.customShader=n,l._customWrappers=s,void 0===t&&(t=this.emitter),this.noiseTexture&&(l.noiseTexture=this.noiseTexture.clone()),l.emitter=t,l}serialize(e=!1){const t={};return Hi._Serialize(t,this,e),t.activeParticleCount=this.activeParticleCount,t.randomTextureSize=this._randomTextureSize,t.customShader=this.customShader,t}static Parse(e,t,i,s=!1,n){const o=e.name;let a,l;t instanceof we?a=t:(l=t,a=l.getEngine());const c=new Yo(o,{capacity:n||e.capacity,randomTextureSize:e.randomTextureSize},t,null,e.isAnimationSheetEnabled);if(c._rootUrl=i,e.customShader&&a.createEffectForParticles){const h=e.customShader,u=h.shaderOptions.defines.length>0?h.shaderOptions.defines.join("\n"):"",d=a.createEffectForParticles(h.shaderPath.fragmentElement,h.shaderOptions.uniforms,h.shaderOptions.samplers,u,void 0,void 0,void 0,c);c.setCustomEffect(d,0),c.customShader=h}return e.id&&(c.id=e.id),e.activeParticleCount&&(c.activeParticleCount=e.activeParticleCount),Hi._Parse(e,c,t,i),e.preventAutoStart&&(c.preventAutoStart=e.preventAutoStart),!s&&!c.preventAutoStart&&c.start(),c}}let r0=(()=>{class r{constructor(){this._emitterNodeIsOwned=!0,this.systems=new Array}get emitterNode(){return this._emitterNode}set emitterNode(t){this._emitterNodeIsOwned&&this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!1);for(const i of this.systems)i.emitter=t;this._emitterNode=t}setEmitterAsSphere(t,i,s){this._emitterNodeIsOwned&&this._emitterNode&&this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!0,this._emitterCreationOptions={kind:"Sphere",options:t,renderingGroupId:i};const n=po("emitterSphere",{diameter:t.diameter,segments:t.segments},s);n.renderingGroupId=i;const o=new fe("emitterSphereMaterial",s);o.emissiveColor=t.color,n.material=o;for(const a of this.systems)a.emitter=n;this._emitterNode=n}start(t){for(const i of this.systems)t&&(i.emitter=t),i.start()}dispose(){for(const t of this.systems)t.dispose();this.systems.length=0,this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNode=null)}serialize(t=!1){const i={systems:[]};for(const s of this.systems)i.systems.push(s.serialize(t));return this._emitterNode&&(i.emitter=this._emitterCreationOptions),i}static Parse(t,i,s=!1,n){const o=new r,a=this.BaseAssetsUrl+"/textures/";i=i||be.LastCreatedScene;for(const l of t.systems)o.systems.push(s?Yo.Parse(l,i,a,!0,n):Hi.Parse(l,i,a,!0,n));if(t.emitter){const l=t.emitter.options;"Sphere"===t.emitter.kind&&o.setEmitterAsSphere({diameter:l.diameter,segments:l.segments,color:re.FromArray(l.color)},t.emitter.renderingGroupId,i)}return o}}return r.BaseAssetsUrl="https://assets.babylonjs.com/particles",r})();class _d{static CreateDefault(e,t=500,i,s=!1){let n;return n=s?new Yo("default system",{capacity:t},i):new Hi("default system",t,i),n.emitter=e,n.particleTexture=new U("https://assets.babylonjs.com/textures/flare.png",n.getScene()),n.createConeEmitter(.1,Math.PI/4),n.color1=new Te(1,1,1,1),n.color2=new Te(1,1,1,1),n.colorDead=new Te(1,1,1,0),n.minSize=.1,n.maxSize=.1,n.minEmitPower=2,n.maxEmitPower=2,n.updateSpeed=1/60,n.emitRate=30,n}static CreateAsync(e,t,i=!1,s){t||(t=be.LastCreatedScene);const n={};return t.addPendingData(n),new Promise((o,a)=>{if(i&&!Yo.IsSupported)return t.removePendingData(n),a("Particle system with GPU is not supported.");q.LoadFile(`${_d.BaseAssetsUrl}/systems/${e}.json`,l=>{t.removePendingData(n);const c=JSON.parse(l.toString());return o(r0.Parse(c,t,i,s))},void 0,void 0,void 0,()=>(t.removePendingData(n),a(`An error occurred with the creation of your particle system. Check if your type '${e}' exists.`)))})}static ExportSet(e){const t=new r0;for(const i of e)t.systems.push(i);return t}static ParseFromFileAsync(e,t,i,s=!1,n="",o){return new Promise((a,l)=>{const c=new Yi;c.addEventListener("readystatechange",()=>{if(4==c.readyState)if(200==c.status){const h=JSON.parse(c.responseText);let u;u=s?Yo.Parse(h,i,n,!1,o):Hi.Parse(h,i,n,!1,o),e&&(u.name=e),a(u)}else l("Unable to load the particle system")}),c.open("GET",t),c.send()})}static ParseFromSnippetAsync(e,t,i=!1,s="",n){if("_BLANK"===e){const o=this.CreateDefault(null);return o.start(),Promise.resolve(o)}return new Promise((o,a)=>{const l=new Yi;l.addEventListener("readystatechange",()=>{if(4==l.readyState)if(200==l.status){const c=JSON.parse(JSON.parse(l.responseText).jsonPayload),h=JSON.parse(c.particleSystem);let u;u=i?Yo.Parse(h,t,s,!1,n):Hi.Parse(h,t,s,!1,n),u.snippetId=e,o(u)}else a("Unable to load the snippet "+e)}),l.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),l.send()})}}_d.BaseAssetsUrl=r0.BaseAssetsUrl,_d.SnippetUrl="https://snippet.babylonjs.com",_d.CreateFromSnippetAsync=_d.ParseFromSnippetAsync,es.AddParser(Me.NAME_PARTICLESYSTEM,(r,e,t,i)=>{const s=es.GetIndividualParser(Me.NAME_PARTICLESYSTEM);if(s&&null!=r.particleSystems)for(let n=0,o=r.particleSystems.length;n<o;n++)t.particleSystems.push(s(r.particleSystems[n],e,i))}),es.AddIndividualParser(Me.NAME_PARTICLESYSTEM,(r,e,t)=>r.activeParticleCount?Yo.Parse(r,e,t):Hi.Parse(r,e,t)),ee.prototype.createEffectForParticles=function(r,e=[],t=[],i="",s,n,o,a){var l;let c=[],h=[];const u=[];return a?a.fillUniformsAttributesAndSamplerNames(h,c,u):(c=Hi._GetAttributeNamesOrOptions(),h=Hi._GetEffectCreationOptions()),-1===i.indexOf(" BILLBOARD")&&(i+="\n#define BILLBOARD\n"),a?.isAnimationSheetEnabled&&-1===i.indexOf(" ANIMATESHEET")&&(i+="\n#define ANIMATESHEET\n"),-1===t.indexOf("diffuseSampler")&&t.push("diffuseSampler"),this.createEffect({vertex:null!==(l=a?.vertexShaderName)&&void 0!==l?l:"particles",fragmentElement:r},c,h.concat(e),u.concat(t),i,s,n,o)},G.prototype.getEmittedParticleSystems=function(){const r=new Array;for(let e=0;e<this.getScene().particleSystems.length;e++){const t=this.getScene().particleSystems[e];t.emitter===this&&r.push(t)}return r},G.prototype.getHierarchyEmittedParticleSystems=function(){const r=new Array,e=this.getDescendants();e.push(this);for(let t=0;t<this.getScene().particleSystems.length;t++){const i=this.getScene().particleSystems[t],s=i.emitter;s.position&&-1!==e.indexOf(s)&&r.push(i)}return r},Object.defineProperty(Zt.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(r){this._physicsImpostor!==r&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=r,r&&(this._disposePhysicsObserver=this.onDisposeObservable.add(()=>{this.physicsImpostor&&(this.physicsImpostor.dispose(),this.physicsImpostor=null)})))},enumerable:!0,configurable:!0}),Zt.prototype.getPhysicsImpostor=function(){return this.physicsImpostor},Zt.prototype.applyImpulse=function(r,e){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(r,e),this):this},Zt.prototype.setPhysicsLinkWith=function(r,e,t,i){return this.physicsImpostor&&r.physicsImpostor?(this.physicsImpostor.createJoint(r.physicsImpostor,$t.HingeJoint,{mainPivot:e,connectedPivot:t,nativeParams:i}),this):this};class n0{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw Ge("")}constructor(e,t=n0.DefaultPluginFactory()){this._physicsPlugin=t,this._physicsBodies=[],this._subTimeStep=0,e=e||new v(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}_step(e){e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._physicsBodies)}addBody(e){this._physicsBodies.push(e)}removeBody(e){const t=this._physicsBodies.indexOf(e);t>-1&&this._physicsBodies.splice(t,1)}getBodies(){return this._physicsBodies}getPhysicsPlugin(){return this._physicsPlugin}raycastToRef(e,t,i){this._physicsPlugin.raycast(e,t,i)}raycast(e,t){const i=new tb;return this._physicsPlugin.raycast(e,t,i),i}}class $p{constructor(e,t,i){if(this._pluginData=void 0,this._pluginDataInstances=[],this.disablePreStep=!0,!i)return;const s=i.getPhysicsEngine();if(!s)throw new Error("No Physics Engine available.");if(this._physicsEngine=s,2!=s.getPluginVersion())throw new Error("Plugin version is incorrect. Expected version 2.");const n=s.getPhysicsPlugin();if(!n)throw new Error("No Physics Plugin available.");this._physicsPlugin=n,e.rotationQuaternion||(e.rotationQuaternion=Z.FromEulerAngles(e.rotation.x,e.rotation.y,e.rotation.z)),e.hasThinInstances?this._physicsPlugin.initBodyInstances(this,t,e):this._physicsPlugin.initBody(this,t,e.position,e.rotationQuaternion),this.transformNode=e,e.physicsBody=this,s.addBody(this),this._nodeDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}updateBodyInstances(){const e=this.transformNode;e.hasThinInstances&&this._physicsPlugin.updateBodyInstances(this,e)}addNodeShape(e){this._physicsPlugin.addNodeShape(this,e)}setShape(e){this._physicsPlugin.setShape(this,e)}getShape(){return this._physicsPlugin.getShape(this)}setFilterGroup(e){this._physicsPlugin.setFilterGroup(this,e)}getFilterGroup(){return this._physicsPlugin.getFilterGroup(this)}setEventMask(e){this._physicsPlugin.setEventMask(this,e)}getEventMask(){return this._physicsPlugin.getEventMask(this)}setMotionType(e){this._physicsPlugin.setMotionType(this,e)}getMotionType(){return this._physicsPlugin.getMotionType(this)}computeMassProperties(){return this._physicsPlugin.computeMassProperties(this)}setMassProperties(e){this._physicsPlugin.setMassProperties(this,e)}getMassProperties(){return this._physicsPlugin.getMassProperties(this)}setLinearDamping(e){this._physicsPlugin.setLinearDamping(this,e)}getLinearDamping(){return this._physicsPlugin.getLinearDamping(this)}setAngularDamping(e){this._physicsPlugin.setAngularDamping(this,e)}getAngularDamping(){return this._physicsPlugin.getAngularDamping(this)}setLinearVelocity(e){this._physicsPlugin.setLinearVelocity(this,e)}getLinearVelocityToRef(e){return this._physicsPlugin.getLinearVelocityToRef(this,e)}setAngularVelocity(e){this._physicsPlugin.setAngularVelocity(this,e)}getAngularVelocityToRef(e){return this._physicsPlugin.getAngularVelocityToRef(this,e)}applyImpulse(e,t){this._physicsPlugin.applyImpulse(this,e,t)}applyForce(e,t){this._physicsPlugin.applyForce(this,e,t)}getGeometry(){return this._physicsPlugin.getBodyGeometry(this)}getCollisionObservable(){return this._physicsPlugin.getCollisionObservable(this)}setCollisionCallbackEnabled(e){return this._physicsPlugin.setCollisionCallbackEnabled(this,e)}getObjectExtents(){const e=this.transformNode;if(e.getBoundingInfo){const t=this.transformNode.rotationQuaternion,i=this.transformNode.scaling.clone();this.transformNode.rotationQuaternion=$p._IDENTITY_QUATERNION;const s=this.transformNode.computeWorldMatrix&&this.transformNode.computeWorldMatrix(!0);s&&s.decompose(i,void 0,void 0),e.refreshBoundingInfo();const o=e.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(i);return o.x=Math.abs(o.x),o.y=Math.abs(o.y),o.z=Math.abs(o.z),this.transformNode.rotationQuaternion=t,this.transformNode.computeWorldMatrix&&this.transformNode.computeWorldMatrix(!0),o}return $p._DEFAULT_OBJECT_SIZE}getObjectCenterDelta(){const e=this.transformNode;if(e.getBoundingInfo){const t=new v,i=e.getBoundingInfo();return this.transformNode.computeWorldMatrix(!0),e.refreshBoundingInfo(),t.copyFrom(i.boundingBox.centerWorld),t.subtractInPlace(e.getAbsolutePosition()),t.x/=e.scaling.x,t.y/=e.scaling.y,t.z/=e.scaling.z,t}return v.Zero()}getObjectCenter(){return this.transformNode.getBoundingInfo?this.transformNode.getBoundingInfo().boundingBox.centerWorld:this.transformNode.position}addConstraint(e,t){this._physicsPlugin.addConstraint(this,e,t)}syncWithBone(e,t,i,s,n,o){const a=this.transformNode;if(a.rotationQuaternion)if(n){const h=L.Quaternion[0];e.getRotationQuaternionToRef($e.WORLD,t,h),h.multiplyToRef(n,a.rotationQuaternion)}else e.getRotationQuaternionToRef($e.WORLD,t,a.rotationQuaternion);const l=L.Vector3[0],c=L.Vector3[1];o||((o=L.Vector3[2]).x=0,o.y=1,o.z=0),e.getDirectionToRef(o,t,c),e.getAbsolutePositionToRef(t,l),null==s&&i&&(s=i.length()),null!=s&&(l.x+=c.x*s,l.y+=c.y*s,l.z+=c.z*s),a.setAbsolutePosition(l)}dispose(){this._nodeDisposeObserver&&(this.transformNode.onDisposeObservable.remove(this._nodeDisposeObserver),this._nodeDisposeObserver=null),this._physicsEngine.removeBody(this),this._physicsPlugin.removeBody(this),this._physicsPlugin.disposeBody(this),this._pluginData=null,this._pluginDataInstances.length=0}}$p._DEFAULT_OBJECT_SIZE=new v(1,1,1),$p._IDENTITY_QUATERNION=Z.Identity(),ge.prototype.getPhysicsEngine=function(){return this._physicsEngine},ge.prototype.enablePhysics=function(r=null,e){if(this._physicsEngine)return!0;let t=this._getComponent(Me.NAME_PHYSICSENGINE);t||(t=new lle(this),this._addComponent(t));try{if(e&&1!==e?.getPluginVersion()){if(2!==e?.getPluginVersion())throw new Error("Unsupported Physics plugin version.");this._physicsEngine=new n0(r,e)}else this._physicsEngine=new ib(r,e);return this._physicsTimeAccumulator=0,!0}catch(i){return V.Error(i.message),!1}},ge.prototype.disablePhysicsEngine=function(){!this._physicsEngine||(this._physicsEngine.dispose(),this._physicsEngine=null)},ge.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},ge.prototype.deleteCompoundImpostor=function(r){const e=r.parts[0].mesh;e.physicsImpostor&&(e.physicsImpostor.dispose(),e.physicsImpostor=null)},ge.prototype._advancePhysicsEngineStep=function(r){if(this._physicsEngine){const e=this._physicsEngine.getSubTimeStep();if(e>0)for(this._physicsTimeAccumulator+=r;this._physicsTimeAccumulator>e;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=e;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(r/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};class lle{constructor(e){this.name=Me.NAME_PHYSICSENGINE,this.scene=e,this.scene.onBeforePhysicsObservable=new z,this.scene.onAfterPhysicsObservable=new z,this.scene.getDeterministicFrameTime=()=>this.scene._physicsEngine?1e3*this.scene._physicsEngine.getTimeStep():1e3/60}register(){}rebuild(){}dispose(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()}}class bb{constructor(e,t,i){this._scene=e,this._origin=t,this._options=i,this._originTop=v.Zero(),this._originDirection=v.Zero(),this._cylinderPosition=v.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options={...new Hz,...this._options},this._origin.addToRef(new v(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new v(0,this._options.height,0),this._originTop),this._options.updraftMode===gd.Perpendicular&&(this._originDirection=this._origin.subtract(this._originTop).normalize()),this._tickCallback=this._tick.bind(this),this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){!this._cylinder||(e?this._cylinder.dispose():setTimeout(()=>{this._dataFetched||this._cylinder.dispose()},0))}_getHitData(e,t){let i;i=this._options.updraftMode===gd.Perpendicular?this._originDirection:e.subtract(this._originTop);const s=v.Distance(this._origin,e),n=-1*this._options.strength,o=i.multiplyByFloats(n,n,n);t.force=o,t.contactPoint=e,t.distanceFromOrigin=s}_getBodyHitData(e,t){if("Mesh"!==e.transformNode.getClassName()&&"InstancedMesh"!==e.transformNode.getClassName())return!1;if(!this._intersectsWithCylinder(e.transformNode))return!1;const s=e.getObjectCenter();return this._getHitData(s,t),!0}_getImpostorHitData(e,t){if(0===e.mass)return!1;if(!this._intersectsWithCylinder(e.object))return!1;const s=e.getObjectCenter();return this._getHitData(s,t),!0}_tick(){const e=bb.hitData;1===this._physicsEngine.getPluginVersion()?this._physicsEngine.getImpostors().forEach(t=>{!this._getImpostorHitData(t,e)||t.applyForce(e.force,e.contactPoint)}):this._physicsEngine.getBodies().forEach(t=>{!this._getBodyHitData(t,e)||t.applyForce(e.force,e.contactPoint)})}_prepareCylinder(){this._cylinder||(this._cylinder=sc("updraftEventCylinder",{height:this._options.height,diameter:2*this._options.radius},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(e){return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0)}}bb.hitData={force:new v,contactPoint:new v,distanceFromOrigin:0};class md{constructor(e,t,i){this._scene=e,this._origin=t,this._options=i,this._originTop=v.Zero(),this._cylinderPosition=v.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options={...new Wz,...this._options},this._origin.addToRef(new v(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new v(0,this._options.height,0),this._originTop),this._tickCallback=this._tick.bind(this),this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){e?this._cylinder.dispose():setTimeout(()=>{this._dataFetched||this._cylinder.dispose()},0)}_getHitData(e,t,i){const s=md.originOnPlane;s.set(this._origin.x,t.y,this._origin.z);const n=t.subtract(s),a=new Qe(s,n,this._options.radius).intersectsMesh(e),l=a.pickedPoint;if(!l)return!1;const c=a.distance/this._options.radius;let u,d,f,h=l.normalize();if(c>this._options.centripetalForceThreshold&&(h=h.negate()),c>this._options.centripetalForceThreshold)u=h.x*this._options.centripetalForceMultiplier,d=h.y*this._options.updraftForceMultiplier,f=h.z*this._options.centripetalForceMultiplier;else{const _=v.Cross(s,t).normalize();u=(_.x+h.x)*this._options.centrifugalForceMultiplier,d=this._originTop.y*this._options.updraftForceMultiplier,f=(_.z+h.z)*this._options.centrifugalForceMultiplier}let p=new v(u,d,f);return p=p.multiplyByFloats(this._options.strength,this._options.strength,this._options.strength),i.force=p,i.contactPoint=t,i.distanceFromOrigin=c,!0}_getBodyHitData(e,t){if("Mesh"!==e.transformNode.getClassName()&&"InstancedMesh"!==e.transformNode.getClassName())return!1;const i=e.transformNode;if(!this._intersectsWithCylinder(i))return!1;const s=e.getObjectCenter();return this._getHitData(i,s,t),!0}_getImpostorHitData(e,t){if(0===e.mass||"Mesh"!==e.object.getClassName()&&"InstancedMesh"!==e.object.getClassName())return!1;const i=e.object;if(!this._intersectsWithCylinder(i))return!1;const s=e.getObjectCenter();return this._getHitData(i,s,t),!0}_tick(){const e=md.hitData;1===this._physicsEngine.getPluginVersion()?this._physicsEngine.getImpostors().forEach(t=>{!this._getImpostorHitData(t,e)||t.applyForce(e.force,e.contactPoint)}):this._physicsEngine.getBodies().forEach(t=>{!this._getBodyHitData(t,e)||t.applyForce(e.force,e.contactPoint)})}_prepareCylinder(){this._cylinder||(this._cylinder=sc("vortexEventCylinder",{height:this._options.height,diameter:2*this._options.radius},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(e){return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0)}}md.originOnPlane=v.Zero(),md.hitData={force:new v,contactPoint:new v,distanceFromOrigin:0};class Hz{constructor(){this.radius=5,this.strength=10,this.height=10,this.updraftMode=gd.Center}}class Wz{constructor(){this.radius=5,this.strength=10,this.height=10,this.centripetalForceThreshold=.7,this.centripetalForceMultiplier=5,this.centrifugalForceMultiplier=.5,this.updraftForceMultiplier=.02}}var gd=(()=>{return(r=gd||(gd={}))[r.Center=0]="Center",r[r.Perpendicular=1]="Perpendicular",gd;var r})();j.ShadersStore.blackAndWhitePixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform float degree;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\nvec3 color=texture2D(textureSampler,vUV).rgb;\nfloat luminance=dot(color,vec3(0.3,0.59,0.11)); \nvec3 blackAndWhite=vec3(luminance,luminance,luminance);\ngl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);\n}";class yb extends Pe{getClassName(){return"BlackAndWhitePostProcess"}constructor(e,t,i,s,n,o){super(e,"blackAndWhite",["degree"],null,t,i,s,n,o),this.degree=1,this.onApplyObservable.add(a=>{a.setFloat("degree",this.degree)})}static _Parse(e,t,i,s){return Ce.Parse(()=>new yb(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,s)}}E([I()],yb.prototype,"degree",void 0),le("BABYLON.BlackAndWhitePostProcess",yb);class Ut{constructor(e,t,i,s){this._name=t,this._singleInstance=s||!0,this._getPostProcesses=i,this._cameras={},this._indicesForCamera={},this._postProcesses={}}get isSupported(){for(const e in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,e)){const t=this._postProcesses[e];for(let i=0;i<t.length;i++)if(!t[i].isSupported)return!1}return!0}_update(){}_attachCameras(e){let t;const i=q.MakeArray(e||this._cameras);if(i)for(let s=0;s<i.length;s++){const n=i[s];if(!n)continue;const o=n.name;if(t=this._singleInstance?0:o,!this._postProcesses[t]){const a=this._getPostProcesses();a&&(this._postProcesses[t]=Array.isArray(a)?a:[a])}this._indicesForCamera[o]||(this._indicesForCamera[o]=[]),this._postProcesses[t].forEach(a=>{const l=n.attachPostProcess(a);this._indicesForCamera[o].push(l)}),this._cameras[o]||(this._cameras[o]=n)}}_detachCameras(e){const t=q.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){const s=t[i],n=s.name,o=this._postProcesses[this._singleInstance?0:n];o&&o.forEach(a=>{s.detachPostProcess(a)}),this._cameras[n]&&(this._cameras[n]=null)}}_enable(e){const t=q.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){const s=t[i],n=s.name;for(let o=0;o<this._indicesForCamera[n].length;o++)null==s._postProcesses[this._indicesForCamera[n][o]]&&this._postProcesses[this._singleInstance?0:n].forEach(a=>{t[i].attachPostProcess(a,this._indicesForCamera[n][o])})}}_disable(e){const t=q.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){const s=t[i],n=s.name;this._postProcesses[this._singleInstance?0:n].forEach(o=>{s.detachPostProcess(o)})}}getPostProcesses(e){return this._singleInstance?this._postProcesses[0]:e?this._postProcesses[e.name]:null}}j.ShadersStore.extractHighlightsPixelShader="#include<helperFunctions>\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform float threshold;\nuniform float exposure;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\ngl_FragColor=texture2D(textureSampler,vUV);\nfloat luma=dot(LuminanceEncodeApprox,gl_FragColor.rgb*exposure);\ngl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;\n}";class o0 extends Pe{getClassName(){return"ExtractHighlightsPostProcess"}constructor(e,t,i,s,n,o,a=0,l=!1){super(e,"extractHighlights",["threshold","exposure"],null,t,i,s,n,o,null,a,void 0,null,l),this.threshold=.9,this._exposure=1,this._inputPostProcess=null,this.onApplyObservable.add(c=>{this.externalTextureSamplerBinding=!!this._inputPostProcess,this._inputPostProcess&&c.setTextureFromPostProcess("textureSampler",this._inputPostProcess),c.setFloat("threshold",Math.pow(this.threshold,Jf)),c.setFloat("exposure",this._exposure)})}}E([I()],o0.prototype,"threshold",void 0),le("BABYLON.ExtractHighlightsPostProcess",o0);j.ShadersStore.bloomMergePixelShader="uniform sampler2D textureSampler;\nuniform sampler2D bloomBlur;\nvarying vec2 vUV;\nuniform float bloomWeight;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\ngl_FragColor=texture2D(textureSampler,vUV);\nvec3 blurred=texture2D(bloomBlur,vUV).rgb;\ngl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight); \n}\n";class a0 extends Pe{getClassName(){return"BloomMergePostProcess"}constructor(e,t,i,s,n,o,a,l,c,h=0,u=!1){super(e,"bloomMerge",["bloomWeight"],["bloomBlur"],n,o,a,l,c,null,h,void 0,null,!0),this.weight=1,this.weight=s,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add(d=>{d.setTextureFromPostProcess("textureSampler",t),d.setTextureFromPostProcessOutput("bloomBlur",i),d.setFloat("bloomWeight",this.weight)}),u||this.updateEffect()}}E([I()],a0.prototype,"weight",void 0),le("BABYLON.BloomMergePostProcess",a0);class Zz extends Ut{get threshold(){return this._downscale.threshold}set threshold(e){this._downscale.threshold=e}get weight(){return this._merge.weight}set weight(e){this._merge.weight=e}get kernel(){return this._blurX.kernel/this._bloomScale}set kernel(e){this._blurX.kernel=e*this._bloomScale,this._blurY.kernel=e*this._bloomScale}constructor(e,t,i,s,n=0,o=!1){super(e.getEngine(),"bloom",()=>this._effects,!0),this._bloomScale=t,this._effects=[],this._downscale=new o0("highlights",1,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,o),this._blurX=new _s("horizontal blur",new de(1,0),10,t,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,void 0,o),this._blurX.alwaysForcePOT=!0,this._blurX.autoClear=!1,this._blurY=new _s("vertical blur",new de(0,1),10,t,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,void 0,o),this._blurY.alwaysForcePOT=!0,this._blurY.autoClear=!1,this.kernel=s,this._effects=[this._downscale,this._blurX,this._blurY],this._merge=new a0("bloomMerge",this._downscale,this._blurY,i,t,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,o),this._merge.autoClear=!1,this._effects.push(this._merge)}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}j.ShadersStore.chromaticAberrationPixelShader="uniform sampler2D textureSampler; \nuniform float chromatic_aberration;\nuniform float radialIntensity;\nuniform vec2 direction;\nuniform vec2 centerPosition;\nuniform float screen_width;\nuniform float screen_height;\nvarying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);\nvec2 directionOfEffect=direction;\nif(directionOfEffect.x==0. && directionOfEffect.y==0.){\ndirectionOfEffect=normalize(centered_screen_pos);\n}\nfloat radius2=centered_screen_pos.x*centered_screen_pos.x\n+ centered_screen_pos.y*centered_screen_pos.y;\nfloat radius=sqrt(radius2);\nvec4 original=texture2D(textureSampler,vUV);\nvec3 ref_indices=vec3(-0.3,0.0,0.3);\nfloat ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;\nfloat ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;\nvec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);\nvec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);\nvec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);\noriginal.r=texture2D(textureSampler,ref_coords_r).r;\noriginal.g=texture2D(textureSampler,ref_coords_g).g;\noriginal.b=texture2D(textureSampler,ref_coords_b).b;\noriginal.a=clamp(texture2D(textureSampler,ref_coords_r).a+texture2D(textureSampler,ref_coords_g).a+texture2D(textureSampler,ref_coords_b).a,0.,1.);\ngl_FragColor=original;\n}";class Sa extends Pe{getClassName(){return"ChromaticAberrationPostProcess"}constructor(e,t,i,s,n,o,a,l,c=0,h=!1){super(e,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],s,n,o,a,l,null,c,void 0,null,h),this.aberrationAmount=30,this.radialIntensity=0,this.direction=new de(.707,.707),this.centerPosition=new de(.5,.5),this.screenWidth=t,this.screenHeight=i,this.onApplyObservable.add(u=>{u.setFloat("chromatic_aberration",this.aberrationAmount),u.setFloat("screen_width",t),u.setFloat("screen_height",i),u.setFloat("radialIntensity",this.radialIntensity),u.setFloat2("direction",this.direction.x,this.direction.y),u.setFloat2("centerPosition",this.centerPosition.x,this.centerPosition.y)})}static _Parse(e,t,i,s){return Ce.Parse(()=>new Sa(e.name,e.screenWidth,e.screenHeight,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1),e,i,s)}}E([I()],Sa.prototype,"aberrationAmount",void 0),E([I()],Sa.prototype,"radialIntensity",void 0),E([I()],Sa.prototype,"direction",void 0),E([I()],Sa.prototype,"centerPosition",void 0),E([I()],Sa.prototype,"screenWidth",void 0),E([I()],Sa.prototype,"screenHeight",void 0),le("BABYLON.ChromaticAberrationPostProcess",Sa);j.ShadersStore.circleOfConfusionPixelShader="uniform sampler2D depthSampler;\nvarying vec2 vUV;\nuniform vec2 cameraMinMaxZ;\nuniform float focusDistance;\nuniform float cocPrecalculation;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nfloat depth=texture2D(depthSampler,vUV).r;\n#define CUSTOM_COC_DEPTH\nfloat pixelDistance=(cameraMinMaxZ.x+cameraMinMaxZ.y*depth)*1000.0; \n#define CUSTOM_COC_PIXELDISTANCE\nfloat coc=abs(cocPrecalculation*((focusDistance-pixelDistance)/pixelDistance));\ncoc=clamp(coc,0.0,1.0);\ngl_FragColor=vec4(coc,coc,coc,1.0);\n}\n";class vd extends Pe{getClassName(){return"CircleOfConfusionPostProcess"}constructor(e,t,i,s,n,o,a,l=0,c=!1){super(e,"circleOfConfusion",["cameraMinMaxZ","focusDistance","cocPrecalculation"],["depthSampler"],i,s,n,o,a,null,l,void 0,null,c),this.lensSize=50,this.fStop=1.4,this.focusDistance=2e3,this.focalLength=50,this._depthTexture=null,this._depthTexture=t,this.onApplyObservable.add(h=>{if(!this._depthTexture)return void V.Warn("No depth texture set on CircleOfConfusionPostProcess");h.setTexture("depthSampler",this._depthTexture);const d=this.lensSize/this.fStop*this.focalLength/(this.focusDistance-this.focalLength);h.setFloat("focusDistance",this.focusDistance),h.setFloat("cocPrecalculation",d);const f=this._depthTexture.activeCamera;h.setFloat2("cameraMinMaxZ",f.minZ,f.maxZ-f.minZ)})}set depthTexture(e){this._depthTexture=e}}E([I()],vd.prototype,"lensSize",void 0),E([I()],vd.prototype,"fStop",void 0),E([I()],vd.prototype,"focusDistance",void 0),E([I()],vd.prototype,"focalLength",void 0),le("BABYLON.CircleOfConfusionPostProcess",vd);j.ShadersStore.colorCorrectionPixelShader="uniform sampler2D textureSampler; \nuniform sampler2D colorTable; \nvarying vec2 vUV;\nconst float SLICE_COUNT=16.0; \nvec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {\nfloat sliceSize=1.0/width; \nfloat slicePixelSize=sliceSize/width; \nfloat sliceInnerSize=slicePixelSize*(width-1.0); \nfloat zSlice0=min(floor(uv.z*width),width-1.0);\nfloat zSlice1=min(zSlice0+1.0,width-1.0);\nfloat xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;\nfloat s0=xOffset+(zSlice0*sliceSize);\nfloat s1=xOffset+(zSlice1*sliceSize);\nvec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));\nvec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));\nfloat zOffset=mod(uv.z*width,1.0);\nvec4 result=mix(slice0Color,slice1Color,zOffset);\nreturn result;\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec4 screen_color=texture2D(textureSampler,vUV);\ngl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);\n}";class xb extends Pe{getClassName(){return"ColorCorrectionPostProcess"}constructor(e,t,i,s,n,o,a){super(e,"colorCorrection",null,["colorTable"],i,s,n,o,a);const l=s?.getScene()||null;this._colorTableTexture=new U(t,l,!0,!1,U.TRILINEAR_SAMPLINGMODE),this._colorTableTexture.anisotropicFilteringLevel=1,this._colorTableTexture.wrapU=U.CLAMP_ADDRESSMODE,this._colorTableTexture.wrapV=U.CLAMP_ADDRESSMODE,this.colorTableUrl=t,this.onApply=c=>{c.setTexture("colorTable",this._colorTableTexture)}}static _Parse(e,t,i,s){return Ce.Parse(()=>new xb(e.name,e.colorTableUrl,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,s)}}E([I()],xb.prototype,"colorTableUrl",void 0),le("BABYLON.ColorCorrectionPostProcess",xb);j.ShadersStore.convolutionPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\nuniform float kernel[9];\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec2 onePixel=vec2(1.0,1.0)/screenSize;\nvec4 colorSum =\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];\nfloat kernelWeight =\nkernel[0] +\nkernel[1] +\nkernel[2] +\nkernel[3] +\nkernel[4] +\nkernel[5] +\nkernel[6] +\nkernel[7] +\nkernel[8];\nif (kernelWeight<=0.0) {\nkernelWeight=1.0;\n}\ngl_FragColor=vec4((colorSum/kernelWeight).rgb,1);\n}";class Ea extends Pe{getClassName(){return"ConvolutionPostProcess"}constructor(e,t,i,s,n,o,a,l=0){super(e,"convolution",["kernel","screenSize"],null,i,s,n,o,a,null,l),this.kernel=t,this.onApply=c=>{c.setFloat2("screenSize",this.width,this.height),c.setArray("kernel",this.kernel)}}static _Parse(e,t,i,s){return Ce.Parse(()=>new Ea(e.name,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType),e,i,s)}}Ea.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],Ea.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],Ea.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],Ea.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],Ea.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],Ea.GaussianKernel=[0,1,0,1,1,1,0,1,0],E([I()],Ea.prototype,"kernel",void 0),le("BABYLON.ConvolutionPostProcess",Ea);class Tb extends _s{getClassName(){return"DepthOfFieldBlurPostProcess"}constructor(e,t,i,s,n,o,a,l=null,c=U.BILINEAR_SAMPLINGMODE,h,u,d=0,f=!1,p=5){super(e,i,s,n,o,2,h,u,d,"#define DOF 1\r\n",f,p),this.direction=i,this.externalTextureSamplerBinding=!!l,this.onApplyObservable.add(_=>{null!=l&&_.setTextureFromPostProcess("textureSampler",l),_.setTextureFromPostProcessOutput("circleOfConfusionSampler",a)})}}E([I()],Tb.prototype,"direction",void 0),le("BABYLON.DepthOfFieldBlurPostProcess",Tb);j.ShadersStore.depthOfFieldMergePixelShader="uniform sampler2D textureSampler;\nvarying vec2 vUV;\nuniform sampler2D circleOfConfusionSampler;\nuniform sampler2D blurStep0;\n#if BLUR_LEVEL>0\nuniform sampler2D blurStep1;\n#endif\n#if BLUR_LEVEL>1\nuniform sampler2D blurStep2;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nfloat coc=texture2D(circleOfConfusionSampler,vUV).r;\n#if BLUR_LEVEL==0\nvec4 original=texture2D(textureSampler,vUV);\nvec4 blurred0=texture2D(blurStep0,vUV);\ngl_FragColor=mix(original,blurred0,coc);\n#endif\n#if BLUR_LEVEL==1\nif(coc<0.5){\nvec4 original=texture2D(textureSampler,vUV);\nvec4 blurred1=texture2D(blurStep1,vUV);\ngl_FragColor=mix(original,blurred1,coc/0.5);\n}else{\nvec4 blurred0=texture2D(blurStep0,vUV);\nvec4 blurred1=texture2D(blurStep1,vUV);\ngl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);\n}\n#endif\n#if BLUR_LEVEL==2\nif(coc<0.33){\nvec4 original=texture2D(textureSampler,vUV);\nvec4 blurred2=texture2D(blurStep2,vUV);\ngl_FragColor=mix(original,blurred2,coc/0.33);\n}else if(coc<0.66){\nvec4 blurred1=texture2D(blurStep1,vUV);\nvec4 blurred2=texture2D(blurStep2,vUV);\ngl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);\n}else{\nvec4 blurred0=texture2D(blurStep0,vUV);\nvec4 blurred1=texture2D(blurStep1,vUV);\ngl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);\n}\n#endif\n}\n";class hle extends Pe{getClassName(){return"DepthOfFieldMergePostProcess"}constructor(e,t,i,s,n,o,a,l,c,h=0,u=!1){super(e,"depthOfFieldMerge",[],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"],n,o,a,l,c,null,h,void 0,null,!0),this._blurSteps=s,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add(d=>{d.setTextureFromPostProcess("textureSampler",t),d.setTextureFromPostProcessOutput("circleOfConfusionSampler",i),s.forEach((f,p)=>{d.setTextureFromPostProcessOutput("blurStep"+(s.length-p-1),f)})}),u||this.updateEffect()}updateEffect(e=null,t=null,i=null,s,n,o){e||(e="",e+="#define BLUR_LEVEL "+(this._blurSteps.length-1)+"\n"),super.updateEffect(e,t,i,s,n,o)}}var wh=(()=>{return(r=wh||(wh={}))[r.Low=0]="Low",r[r.Medium=1]="Medium",r[r.High=2]="High",wh;var r})();class c4 extends Ut{set focalLength(e){this._circleOfConfusion.focalLength=e}get focalLength(){return this._circleOfConfusion.focalLength}set fStop(e){this._circleOfConfusion.fStop=e}get fStop(){return this._circleOfConfusion.fStop}set focusDistance(e){this._circleOfConfusion.focusDistance=e}get focusDistance(){return this._circleOfConfusion.focusDistance}set lensSize(e){this._circleOfConfusion.lensSize=e}get lensSize(){return this._circleOfConfusion.lensSize}constructor(e,t,i=wh.Low,s=0,n=!1){super(e.getEngine(),"depth of field",()=>this._effects,!0),this._effects=[];const o=e.getEngine(),a=o.isWebGPU||o.webGLVersion>1?6:5;this._circleOfConfusion=new vd("circleOfConfusion",t,1,null,U.BILINEAR_SAMPLINGMODE,o,!1,s,n),this._depthOfFieldBlurY=[],this._depthOfFieldBlurX=[];let l=1,c=15;switch(i){case wh.High:l=3,c=51;break;case wh.Medium:l=2,c=31;break;default:c=15,l=1}const h=c/Math.pow(2,l-1);let u=1;for(let d=0;d<l;d++){const f=new Tb("vertical blur",e,new de(0,1),h,u,null,this._circleOfConfusion,0==d?this._circleOfConfusion:null,U.BILINEAR_SAMPLINGMODE,o,!1,s,n,0==d?a:5);f.autoClear=!1,u=.75/Math.pow(2,d);const p=new Tb("horizontal blur",e,new de(1,0),h,u,null,this._circleOfConfusion,null,U.BILINEAR_SAMPLINGMODE,o,!1,s,n);p.autoClear=!1,this._depthOfFieldBlurY.push(f),this._depthOfFieldBlurX.push(p)}this._effects=[this._circleOfConfusion];for(let d=0;d<this._depthOfFieldBlurX.length;d++)this._effects.push(this._depthOfFieldBlurY[d]),this._effects.push(this._depthOfFieldBlurX[d]);this._dofMerge=new hle("dofMerge",this._circleOfConfusion,this._circleOfConfusion,this._depthOfFieldBlurX,u,null,U.BILINEAR_SAMPLINGMODE,o,!1,s,n),this._dofMerge.autoClear=!1,this._effects.push(this._dofMerge)}getClassName(){return"DepthOfFieldEffect"}set depthTexture(e){this._circleOfConfusion.depthTexture=e}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}j.ShadersStore.displayPassPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D passSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\ngl_FragColor=texture2D(passSampler,vUV);\n}";class l0 extends Pe{getClassName(){return"DisplayPassPostProcess"}constructor(e,t,i,s,n,o){super(e,"displayPass",["passSampler"],["passSampler"],t,i,s,n,o)}static _Parse(e,t,i,s){return Ce.Parse(()=>new l0(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,s)}}le("BABYLON.DisplayPassPostProcess",l0);j.ShadersStore.filterPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform mat4 kernelMatrix;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec3 baseColor=texture2D(textureSampler,vUV).rgb;\nvec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;\ngl_FragColor=vec4(updatedColor,1.0);\n}";class Sb extends Pe{getClassName(){return"FilterPostProcess"}constructor(e,t,i,s,n,o,a){super(e,"filter",["kernelMatrix"],null,i,s,n,o,a),this.kernelMatrix=t,this.onApply=l=>{l.setMatrix("kernelMatrix",this.kernelMatrix)}}static _Parse(e,t,i,s){return Ce.Parse(()=>new Sb(e.name,e.kernelMatrix,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,s)}}E([KF()],Sb.prototype,"kernelMatrix",void 0),le("BABYLON.FilterPostProcess",Sb);j.ShadersStore.fxaaPixelShader="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\nuniform sampler2D textureSampler;\nuniform vec2 texelSize;\nvarying vec2 vUV;\nvarying vec2 sampleCoordS;\nvarying vec2 sampleCoordE;\nvarying vec2 sampleCoordN;\nvarying vec2 sampleCoordW;\nvarying vec2 sampleCoordNW;\nvarying vec2 sampleCoordSE;\nvarying vec2 sampleCoordNE;\nvarying vec2 sampleCoordSW;\nconst float fxaaQualitySubpix=1.0;\nconst float fxaaQualityEdgeThreshold=0.166;\nconst float fxaaQualityEdgeThresholdMin=0.0833;\nconst vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);\n#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)\nvoid main(){\nvec2 posM;\nposM.x=vUV.x;\nposM.y=vUV.y;\nvec4 rgbyM=TEXTUREFUNC(textureSampler,vUV,0.0);\nfloat lumaM=FxaaLuma(rgbyM);\nfloat lumaS=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordS,0.0));\nfloat lumaE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordE,0.0));\nfloat lumaN=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordN,0.0));\nfloat lumaW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordW,0.0));\nfloat maxSM=max(lumaS,lumaM);\nfloat minSM=min(lumaS,lumaM);\nfloat maxESM=max(lumaE,maxSM);\nfloat minESM=min(lumaE,minSM);\nfloat maxWN=max(lumaN,lumaW);\nfloat minWN=min(lumaN,lumaW);\nfloat rangeMax=max(maxWN,maxESM);\nfloat rangeMin=min(minWN,minESM);\nfloat rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;\nfloat range=rangeMax-rangeMin;\nfloat rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);\n#ifndef MALI\nif(range<rangeMaxClamped) \n{\ngl_FragColor=rgbyM;\nreturn;\n}\n#endif\nfloat lumaNW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNW,0.0));\nfloat lumaSE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSE,0.0));\nfloat lumaNE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNE,0.0));\nfloat lumaSW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSW,0.0));\nfloat lumaNS=lumaN+lumaS;\nfloat lumaWE=lumaW+lumaE;\nfloat subpixRcpRange=1.0/range;\nfloat subpixNSWE=lumaNS+lumaWE;\nfloat edgeHorz1=(-2.0*lumaM)+lumaNS;\nfloat edgeVert1=(-2.0*lumaM)+lumaWE;\nfloat lumaNESE=lumaNE+lumaSE;\nfloat lumaNWNE=lumaNW+lumaNE;\nfloat edgeHorz2=(-2.0*lumaE)+lumaNESE;\nfloat edgeVert2=(-2.0*lumaN)+lumaNWNE;\nfloat lumaNWSW=lumaNW+lumaSW;\nfloat lumaSWSE=lumaSW+lumaSE;\nfloat edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);\nfloat edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);\nfloat edgeHorz3=(-2.0*lumaW)+lumaNWSW;\nfloat edgeVert3=(-2.0*lumaS)+lumaSWSE;\nfloat edgeHorz=abs(edgeHorz3)+edgeHorz4;\nfloat edgeVert=abs(edgeVert3)+edgeVert4;\nfloat subpixNWSWNESE=lumaNWSW+lumaNESE;\nfloat lengthSign=texelSize.x;\nbool horzSpan=edgeHorz>=edgeVert;\nfloat subpixA=subpixNSWE*2.0+subpixNWSWNESE;\nif (!horzSpan)\n{\nlumaN=lumaW;\n}\nif (!horzSpan) \n{\nlumaS=lumaE;\n}\nif (horzSpan) \n{\nlengthSign=texelSize.y;\n}\nfloat subpixB=(subpixA*(1.0/12.0))-lumaM;\nfloat gradientN=lumaN-lumaM;\nfloat gradientS=lumaS-lumaM;\nfloat lumaNN=lumaN+lumaM;\nfloat lumaSS=lumaS+lumaM;\nbool pairN=abs(gradientN)>=abs(gradientS);\nfloat gradient=max(abs(gradientN),abs(gradientS));\nif (pairN)\n{\nlengthSign=-lengthSign;\n}\nfloat subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);\nvec2 posB;\nposB.x=posM.x;\nposB.y=posM.y;\nvec2 offNP;\noffNP.x=(!horzSpan) ? 0.0 : texelSize.x;\noffNP.y=(horzSpan) ? 0.0 : texelSize.y;\nif (!horzSpan) \n{\nposB.x+=lengthSign*0.5;\n}\nif (horzSpan)\n{\nposB.y+=lengthSign*0.5;\n}\nvec2 posN;\nposN.x=posB.x-offNP.x*1.5;\nposN.y=posB.y-offNP.y*1.5;\nvec2 posP;\nposP.x=posB.x+offNP.x*1.5;\nposP.y=posB.y+offNP.y*1.5;\nfloat subpixD=((-2.0)*subpixC)+3.0;\nfloat lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN,0.0));\nfloat subpixE=subpixC*subpixC;\nfloat lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP,0.0));\nif (!pairN) \n{\nlumaNN=lumaSS;\n}\nfloat gradientScaled=gradient*1.0/4.0;\nfloat lumaMM=lumaM-lumaNN*0.5;\nfloat subpixF=subpixD*subpixE;\nbool lumaMLTZero=lumaMM<0.0;\nlumaEndN-=lumaNN*0.5;\nlumaEndP-=lumaNN*0.5;\nbool doneN=abs(lumaEndN)>=gradientScaled;\nbool doneP=abs(lumaEndP)>=gradientScaled;\nif (!doneN) \n{\nposN.x-=offNP.x*3.0;\n}\nif (!doneN) \n{\nposN.y-=offNP.y*3.0;\n}\nbool doneNP=(!doneN) || (!doneP);\nif (!doneP) \n{\nposP.x+=offNP.x*3.0;\n}\nif (!doneP)\n{\nposP.y+=offNP.y*3.0;\n}\nif (doneNP)\n{\nif (!doneN) lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN.xy,0.0));\nif (!doneP) lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP.xy,0.0));\nif (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;\nif (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;\ndoneN=abs(lumaEndN)>=gradientScaled;\ndoneP=abs(lumaEndP)>=gradientScaled;\nif (!doneN) posN.x-=offNP.x*12.0;\nif (!doneN) posN.y-=offNP.y*12.0;\ndoneNP=(!doneN) || (!doneP);\nif (!doneP) posP.x+=offNP.x*12.0;\nif (!doneP) posP.y+=offNP.y*12.0;\n}\nfloat dstN=posM.x-posN.x;\nfloat dstP=posP.x-posM.x;\nif (!horzSpan)\n{\ndstN=posM.y-posN.y;\n}\nif (!horzSpan) \n{\ndstP=posP.y-posM.y;\n}\nbool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;\nfloat spanLength=(dstP+dstN);\nbool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;\nfloat spanLengthRcp=1.0/spanLength;\nbool directionN=dstN<dstP;\nfloat dst=min(dstN,dstP);\nbool goodSpan=directionN ? goodSpanN : goodSpanP;\nfloat subpixG=subpixF*subpixF;\nfloat pixelOffset=(dst*(-spanLengthRcp))+0.5;\nfloat subpixH=subpixG*fxaaQualitySubpix;\nfloat pixelOffsetGood=goodSpan ? pixelOffset : 0.0;\nfloat pixelOffsetSubpix=max(pixelOffsetGood,subpixH);\nif (!horzSpan)\n{\nposM.x+=pixelOffsetSubpix*lengthSign;\n}\nif (horzSpan)\n{\nposM.y+=pixelOffsetSubpix*lengthSign;\n}\n#ifdef MALI\nif(range<rangeMaxClamped) \n{\ngl_FragColor=rgbyM;\n}\nelse\n{\ngl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);\n}\n#else\ngl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);\n#endif\n}";j.ShadersStore.fxaaVertexShader="attribute vec2 position;\nuniform vec2 texelSize;\nvarying vec2 vUV;\nvarying vec2 sampleCoordS;\nvarying vec2 sampleCoordE;\nvarying vec2 sampleCoordN;\nvarying vec2 sampleCoordW;\nvarying vec2 sampleCoordNW;\nvarying vec2 sampleCoordSE;\nvarying vec2 sampleCoordNE;\nvarying vec2 sampleCoordSW;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd);\nsampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;\nsampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;\nsampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;\nsampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;\nsampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;\nsampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;\nsampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;\nsampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class bd extends Pe{getClassName(){return"FxaaPostProcess"}constructor(e,t,i=null,s,n,o,a=0){super(e,"fxaa",["texelSize"],null,t,i,s||U.BILINEAR_SAMPLINGMODE,n,o,null,a,"fxaa",void 0,!0);const l=this._getDefines();this.updateEffect(l),this.onApplyObservable.add(c=>{const h=this.texelSize;c.setFloat2("texelSize",h.x,h.y)})}_getDefines(){const e=this.getEngine();if(!e)return null;const t=e.getGlInfo();return t&&t.renderer&&t.renderer.toLowerCase().indexOf("mali")>-1?"#define MALI 1\n":null}static _Parse(e,t,i,s){return Ce.Parse(()=>new bd(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,s)}}le("BABYLON.FxaaPostProcess",bd);j.ShadersStore.grainPixelShader="#include<helperFunctions>\nuniform sampler2D textureSampler; \nuniform float intensity;\nuniform float animatedSeed;\nvarying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\ngl_FragColor=texture2D(textureSampler,vUV);\nvec2 seed=vUV*(animatedSeed);\nfloat grain=dither(seed,intensity);\nfloat lum=getLuminance(gl_FragColor.rgb);\nfloat grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;\ngl_FragColor.rgb+=grain*grainAmount;\ngl_FragColor.rgb=max(gl_FragColor.rgb,0.0);\n}";class yd extends Pe{getClassName(){return"GrainPostProcess"}constructor(e,t,i,s,n,o,a=0,l=!1){super(e,"grain",["intensity","animatedSeed"],[],t,i,s,n,o,null,a,void 0,null,l),this.intensity=30,this.animated=!1,this.onApplyObservable.add(c=>{c.setFloat("intensity",this.intensity),c.setFloat("animatedSeed",this.animated?Math.random()+1:1)})}static _Parse(e,t,i,s){return Ce.Parse(()=>new yd(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,s)}}E([I()],yd.prototype,"intensity",void 0),E([I()],yd.prototype,"animated",void 0),le("BABYLON.GrainPostProcess",yd);j.ShadersStore.highlightsPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nconst vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\nvec4 tex=texture2D(textureSampler,vUV);\nvec3 c=tex.rgb;\nfloat luma=dot(c.rgb,RGBLuminanceCoefficients);\ngl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a); \n}";j.IncludesShadersStore.mrtFragmentDeclaration="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nlayout(location=0) out vec4 glFragData[{X}];\n#endif\n";j.ShadersStore.geometryPixelShader="#extension GL_EXT_draw_buffers : require\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\n#ifdef BUMP\nvarying mat4 vWorldView;\nvarying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#ifdef VELOCITY\nvarying vec4 vCurrentPosition;\nvarying vec4 vPreviousPosition;\n#endif\n#ifdef NEED_UV\nvarying vec2 vUV;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#if defined(REFLECTIVITY)\n#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nuniform sampler2D reflectivitySampler;\nvarying vec2 vReflectivityUV;\n#endif\n#ifdef ALBEDOTEXTURE\nvarying vec2 vAlbedoUV;\nuniform sampler2D albedoSampler;\n#endif\n#ifdef REFLECTIVITYCOLOR\nuniform vec3 reflectivityColor;\n#endif\n#ifdef ALBEDOCOLOR\nuniform vec3 albedoColor;\n#endif\n#ifdef METALLIC\nuniform float metallic;\n#endif\n#if defined(ROUGHNESS) || defined(GLOSSINESS)\nuniform float glossiness;\n#endif\n#endif\n#if defined(ALPHATEST) && defined(NEED_UV)\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<mrtFragmentDeclaration>[RENDER_TARGET_COUNT]\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<helperFunctions>\nvoid main() {\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\nvec3 normalOutput;\n#ifdef BUMP\nvec3 normalW=normalize(vNormalW);\n#include<bumpFragment>\nnormalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));\n#else\nnormalOutput=normalize(vNormalV);\n#endif\n#ifdef PREPASS\n#ifdef PREPASS_DEPTH\ngl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);\n#endif\n#ifdef PREPASS_NORMAL\ngl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);\n#endif\n#else\ngl_FragData[0]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);\ngl_FragData[1]=vec4(normalOutput,1.0);\n#endif\n#ifdef POSITION\ngl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);\n#endif\n#ifdef VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;\nvec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;\nvec2 velocity=abs(a-b);\nvelocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;\ngl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);\n#endif\n#ifdef REFLECTIVITY\nvec4 reflectivity=vec4(0.0,0.0,0.0,1.0);\n#ifdef METALLICWORKFLOW\nfloat metal=1.0;\nfloat roughness=1.0;\n#ifdef ORMTEXTURE\nmetal*=texture2D(reflectivitySampler,vReflectivityUV).b;\nroughness*=texture2D(reflectivitySampler,vReflectivityUV).g;\n#endif\n#ifdef METALLIC\nmetal*=metallic;\n#endif\n#ifdef ROUGHNESS\nroughness*=(1.0-glossiness); \n#endif\nreflectivity.a-=roughness;\nvec3 color=vec3(1.0);\n#ifdef ALBEDOTEXTURE\ncolor=texture2D(albedoSampler,vAlbedoUV).rgb;\n#ifdef GAMMAALBEDO\ncolor=toLinearSpace(color);\n#endif\n#endif\n#ifdef ALBEDOCOLOR\ncolor*=albedoColor.xyz;\n#endif\nreflectivity.rgb=mix(vec3(0.04),color,metal);\n#else\n#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nreflectivity=texture2D(reflectivitySampler,vReflectivityUV);\n#ifdef GAMMAREFLECTIVITYTEXTURE\nreflectivity.rgb=toLinearSpace(reflectivity.rgb);\n#endif\n#else \n#ifdef REFLECTIVITYCOLOR\nreflectivity.rgb=toLinearSpace(reflectivityColor.xyz);\nreflectivity.a=1.0;\n#endif\n#endif\n#ifdef GLOSSINESSS\nreflectivity.a*=glossiness; \n#endif\n#endif\ngl_FragData[REFLECTIVITY_INDEX]=reflectivity;\n#endif\n}\n";j.IncludesShadersStore.geometryVertexDeclaration="uniform mat4 viewProjection;\nuniform mat4 view;";j.IncludesShadersStore.geometryUboDeclaration="#include<sceneUboDeclaration>\n";j.ShadersStore.geometryVertexShader="precision highp float;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\n#include<__decl__geometryVertex>\n#include<clipPlaneVertexDeclaration>\nattribute vec3 position;\nattribute vec3 normal;\n#ifdef NEED_UV\nvarying vec2 vUV;\n#ifdef ALPHATEST\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef BUMP\nuniform mat4 bumpMatrix;\nvarying vec2 vBumpUV;\n#endif\n#ifdef REFLECTIVITY\nuniform mat4 reflectivityMatrix;\nuniform mat4 albedoMatrix;\nvarying vec2 vReflectivityUV;\nvarying vec2 vAlbedoUV;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef BUMP\nvarying mat4 vWorldView;\n#endif\n#ifdef BUMP\nvarying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#ifdef VELOCITY\nuniform mat4 previousViewProjection;\nvarying vec4 vCurrentPosition;\nvarying vec4 vPreviousPosition;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\nvec3 normalUpdated=normal;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#if defined(VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=vec4(finalWorld*vec4(positionUpdated,1.0));\n#ifdef BUMP\nvWorldView=view*finalWorld;\nvNormalW=normalUpdated;\n#else\nvNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));\n#endif\nvViewPos=view*worldPos;\n#if defined(VELOCITY) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;\npreviousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n#if defined(POSITION) || defined(BUMP)\nvPositionW=worldPos.xyz/worldPos.w;\n#endif\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\n#ifdef NEED_UV\n#ifdef UV1\n#if defined(ALPHATEST) && defined(ALPHATEST_UV1)\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#else\nvUV=uv;\n#endif\n#ifdef BUMP_UV1\nvBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV1\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef ALBEDO_UV1\nvAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#endif\n#ifdef UV2\n#if defined(ALPHATEST) && defined(ALPHATEST_UV2)\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#else\nvUV=uv2;\n#endif\n#ifdef BUMP_UV2\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV2\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));\n#endif\n#ifdef ALBEDO_UV2\nvAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#endif\n#include<bumpVertex>\n}\n";const w4=["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];Uo(w4);let Zn=(()=>{class r{_linkPrePassRenderer(t){this._linkedWithPrePass=!0,this._prePassRenderer=t,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add(()=>{}))}_unlinkPrePassRenderer(){this._linkedWithPrePass=!1,this._createRenderTargets()}_resetLayout(){this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._attachmentsFromPrePass=[]}_forceTextureType(t,i){t===r.POSITION_TEXTURE_TYPE?(this._positionIndex=i,this._enablePosition=!0):t===r.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=i,this._enableVelocity=!0):t===r.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=i,this._enableReflectivity=!0):t===r.DEPTH_TEXTURE_TYPE?this._depthIndex=i:t===r.NORMAL_TEXTURE_TYPE&&(this._normalIndex=i)}_setAttachments(t){this._attachmentsFromPrePass=t}_linkInternalTexture(t){this._multiRenderTarget.setInternalTexture(t,0,!1)}get renderList(){return this._multiRenderTarget.renderList}set renderList(t){this._multiRenderTarget.renderList=t}get isSupported(){return this._multiRenderTarget.isSupported}getTextureIndex(t){switch(t){case r.POSITION_TEXTURE_TYPE:return this._positionIndex;case r.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case r.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;default:return-1}}get enablePosition(){return this._enablePosition}set enablePosition(t){this._enablePosition=t,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableVelocity(){return this._enableVelocity}set enableVelocity(t){this._enableVelocity=t,t||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=t}get enableReflectivity(){return this._enableReflectivity}set enableReflectivity(t){this._enableReflectivity=t,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get scene(){return this._scene}get ratio(){return this._ratio}constructor(t,i=1,s=15){this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this._resizeObserver=null,this._enablePosition=!1,this._enableVelocity=!1,this._enableReflectivity=!1,this._clearColor=new Te(0,0,0,0),this._clearDepthColor=new Te(1e8,0,0,1),this._positionIndex=-1,this._velocityIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._linkedWithPrePass=!1,this.useSpecificClearForDepthTexture=!1,this._scene=t,this._ratio=i,this._useUbo=t.getEngine().supportsUniformBuffers,this._depthFormat=s,r._SceneComponentInitialization(this._scene),this._createRenderTargets()}isReady(t,i){const s=t.getMaterial();if(s&&s.disableDepthWrite)return!1;const n=[],o=[A.PositionKind,A.NormalKind],a=t.getMesh();if(s){let p=!1;if(s.needAlphaTesting()&&s.getAlphaTestTexture()&&(n.push("#define ALPHATEST"),n.push(`#define ALPHATEST_UV${s.getAlphaTestTexture().coordinatesIndex+1}`),p=!0),s.bumpTexture&&pe.BumpTextureEnabled&&(n.push("#define BUMP"),n.push(`#define BUMP_UV${s.bumpTexture.coordinatesIndex+1}`),p=!0),this._enableReflectivity){let _=!1;"PBRMetallicRoughnessMaterial"===s.getClassName()?(null!==s.metallicRoughnessTexture&&(n.push("#define ORMTEXTURE"),n.push(`#define REFLECTIVITY_UV${s.metallicRoughnessTexture.coordinatesIndex+1}`),n.push("#define METALLICWORKFLOW"),p=!0,_=!0),null!==s.metallic&&(n.push("#define METALLIC"),n.push("#define METALLICWORKFLOW"),_=!0),null!==s.roughness&&(n.push("#define ROUGHNESS"),n.push("#define METALLICWORKFLOW"),_=!0),_&&(null!==s.baseTexture&&(n.push("#define ALBEDOTEXTURE"),n.push(`#define ALBEDO_UV${s.baseTexture.coordinatesIndex+1}`),s.baseTexture.gammaSpace&&n.push("#define GAMMAALBEDO"),p=!0),null!==s.baseColor&&n.push("#define ALBEDOCOLOR"))):"PBRSpecularGlossinessMaterial"===s.getClassName()?(null!==s.specularGlossinessTexture?(n.push("#define SPECULARGLOSSINESSTEXTURE"),n.push(`#define REFLECTIVITY_UV${s.specularGlossinessTexture.coordinatesIndex+1}`),p=!0,s.specularGlossinessTexture.gammaSpace&&n.push("#define GAMMAREFLECTIVITYTEXTURE")):null!==s.specularColor&&n.push("#define REFLECTIVITYCOLOR"),null!==s.glossiness&&n.push("#define GLOSSINESSS")):"PBRMaterial"===s.getClassName()?(null!==s.metallicTexture&&(n.push("#define ORMTEXTURE"),n.push(`#define REFLECTIVITY_UV${s.metallicTexture.coordinatesIndex+1}`),n.push("#define METALLICWORKFLOW"),p=!0,_=!0),null!==s.metallic&&(n.push("#define METALLIC"),n.push("#define METALLICWORKFLOW"),_=!0),null!==s.roughness&&(n.push("#define ROUGHNESS"),n.push("#define METALLICWORKFLOW"),_=!0),_?(null!==s.albedoTexture&&(n.push("#define ALBEDOTEXTURE"),n.push(`#define ALBEDO_UV${s.albedoTexture.coordinatesIndex+1}`),s.albedoTexture.gammaSpace&&n.push("#define GAMMAALBEDO"),p=!0),null!==s.albedoColor&&n.push("#define ALBEDOCOLOR")):(null!==s.reflectivityTexture?(n.push("#define SPECULARGLOSSINESSTEXTURE"),n.push(`#define REFLECTIVITY_UV${s.reflectivityTexture.coordinatesIndex+1}`),s.reflectivityTexture.gammaSpace&&n.push("#define GAMMAREFLECTIVITYTEXTURE"),p=!0):null!==s.reflectivityColor&&n.push("#define REFLECTIVITYCOLOR"),null!==s.microSurface&&n.push("#define GLOSSINESSS"))):"StandardMaterial"===s.getClassName()&&(null!==s.specularTexture&&(n.push("#define REFLECTIVITYTEXTURE"),n.push(`#define REFLECTIVITY_UV${s.specularTexture.coordinatesIndex+1}`),s.specularTexture.gammaSpace&&n.push("#define GAMMAREFLECTIVITYTEXTURE"),p=!0),null!==s.specularColor&&n.push("#define REFLECTIVITYCOLOR"))}p&&(n.push("#define NEED_UV"),a.isVerticesDataPresent(A.UVKind)&&(o.push(A.UVKind),n.push("#define UV1")),a.isVerticesDataPresent(A.UV2Kind)&&(o.push(A.UV2Kind),n.push("#define UV2")))}this._linkedWithPrePass&&(n.push("#define PREPASS"),-1!==this._depthIndex&&(n.push("#define DEPTH_INDEX "+this._depthIndex),n.push("#define PREPASS_DEPTH")),-1!==this._normalIndex&&(n.push("#define NORMAL_INDEX "+this._normalIndex),n.push("#define PREPASS_NORMAL"))),this._enablePosition&&(n.push("#define POSITION"),n.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(n.push("#define VELOCITY"),n.push("#define VELOCITY_INDEX "+this._velocityIndex),-1===this.excludedSkinnedMeshesFromVelocity.indexOf(a)&&n.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(n.push("#define REFLECTIVITY"),n.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),a.useBones&&a.computeBonesUsingShaders?(o.push(A.MatricesIndicesKind),o.push(A.MatricesWeightsKind),a.numBoneInfluencers>4&&(o.push(A.MatricesIndicesExtraKind),o.push(A.MatricesWeightsExtraKind)),n.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers),n.push("#define BonesPerMesh "+(a.skeleton?a.skeleton.bones.length+1:0))):n.push("#define NUM_BONE_INFLUENCERS 0");const l=a.morphTargetManager;let c=0;l&&l.numInfluencers>0&&(c=l.numInfluencers,n.push("#define MORPHTARGETS"),n.push("#define NUM_MORPH_INFLUENCERS "+c),l.isUsingTextureForTargets&&n.push("#define MORPHTARGETS_TEXTURE"),ce.PrepareAttributesForMorphTargetsInfluencers(o,a,c)),i&&(n.push("#define INSTANCES"),ce.PushAttributesForInstances(o,this._enableVelocity),t.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES")),n.push(this._linkedWithPrePass?"#define RENDER_TARGET_COUNT "+this._attachmentsFromPrePass.length:"#define RENDER_TARGET_COUNT "+this._multiRenderTarget.textures.length),Za(s,this._scene,n);const h=this._scene.getEngine(),u=t._getDrawWrapper(void 0,!0),d=u.defines,f=n.join("\n");return d!==f&&u.setEffect(h.createEffect("geometry",{attributes:o,uniformsNames:w4,samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets"],defines:f,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:c}},h),f),u.effect.isReady()}getGBuffer(){return this._multiRenderTarget}get samples(){return this._multiRenderTarget.samples}set samples(t){this._multiRenderTarget.samples=t}dispose(){this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.getGBuffer().dispose()}_assignRenderTargetIndices(){const t=[];let i=2;return t.push("gBuffer_Depth","gBuffer_Normal"),this._enablePosition&&(this._positionIndex=i,i++,t.push("gBuffer_Position")),this._enableVelocity&&(this._velocityIndex=i,i++,t.push("gBuffer_Velocity")),this._enableReflectivity&&(this._reflectivityIndex=i,i++,t.push("gBuffer_Reflectivity")),[i,t]}_createRenderTargets(){const t=this._scene.getEngine(),[i,s]=this._assignRenderTargetIndices();let n=0;if(t._caps.textureFloat&&t._caps.textureFloatLinearFiltering?n=1:t._caps.textureHalfFloat&&t._caps.textureHalfFloatLinearFiltering&&(n=2),this._multiRenderTarget=new Ah("gBuffer",{width:t.getRenderWidth()*this._ratio,height:t.getRenderHeight()*this._ratio},i,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,defaultType:n,depthTextureFormat:this._depthFormat},s.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this._multiRenderTarget.wrapU=U.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=U.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null;const o=[!0],a=[!1],l=[!0];for(let f=1;f<i;++f)o.push(!0),l.push(!1),a.push(!0);const c=t.buildTextureLayout(o),h=t.buildTextureLayout(a),u=t.buildTextureLayout(l);this._multiRenderTarget.onClearObservable.add(f=>{f.bindAttachments(this.useSpecificClearForDepthTexture?h:c),f.clear(this._clearColor,!0,!0,!0),this.useSpecificClearForDepthTexture&&(f.bindAttachments(u),f.clear(this._clearDepthColor,!0,!0,!0)),f.bindAttachments(c)}),this._resizeObserver=t.onResizeObservable.add(()=>{this._multiRenderTarget&&this._multiRenderTarget.resize({width:t.getRenderWidth()*this._ratio,height:t.getRenderHeight()*this._ratio})});const d=f=>{const p=f.getRenderingMesh(),_=f.getEffectiveMesh(),m=this._scene,g=m.getEngine(),b=f.getMaterial();if(!b)return;if(_._internalAbstractMeshDataInfo._isActiveIntermediate=!1,this._enableVelocity&&!this._previousTransformationMatrices[_.uniqueId]&&(this._previousTransformationMatrices[_.uniqueId]={world:F.Identity(),viewProjection:m.getTransformMatrix()},p.skeleton)){const S=p.skeleton.getTransformMatrices(p);this._previousBonesTransformationMatrices[p.uniqueId]=this._copyBonesTransformationMatrices(S,new Float32Array(S.length))}const y=p._getInstancesRenderList(f._id,!!f.getReplacementMesh());if(y.mustReturn)return;const T=g.getCaps().instancedArrays&&(null!==y.visibleInstances[f._id]||p.hasThinInstances),x=_.getWorldMatrix();if(this.isReady(f,T)){const S=f._getDrawWrapper();if(!S)return;const C=S.effect;let D;g.enableEffect(S),T||p._bind(f,C,b.fillMode),this._useUbo?(ce.BindSceneUniformBuffer(C,this._scene.getSceneUniformBuffer()),this._scene.finalizeSceneUbo()):(C.setMatrix("viewProjection",m.getTransformMatrix()),C.setMatrix("view",m.getViewMatrix()));const P=p._instanceDataStorage;if(P.isFrozen||!b.backFaceCulling&&null===p.overrideMaterialSideOrientation)D=P.sideOrientation;else{const M=_._getWorldMatrixDeterminant();D=p.overrideMaterialSideOrientation,null===D&&(D=b.sideOrientation),M<0&&(D=D===ie.ClockWiseSideOrientation?ie.CounterClockWiseSideOrientation:ie.ClockWiseSideOrientation)}if(b._preBind(S,D),b.needAlphaTesting()){const M=b.getAlphaTestTexture();M&&(C.setTexture("diffuseSampler",M),C.setMatrix("diffuseMatrix",M.getTextureMatrix()))}b.bumpTexture&&m.getEngine().getCaps().standardDerivatives&&pe.BumpTextureEnabled&&(C.setFloat3("vBumpInfos",b.bumpTexture.coordinatesIndex,1/b.bumpTexture.level,b.parallaxScaleBias),C.setMatrix("bumpMatrix",b.bumpTexture.getTextureMatrix()),C.setTexture("bumpSampler",b.bumpTexture),C.setFloat2("vTangentSpaceParams",b.invertNormalMapX?-1:1,b.invertNormalMapY?-1:1)),this._enableReflectivity&&("PBRMetallicRoughnessMaterial"===b.getClassName()?(null!==b.metallicRoughnessTexture&&(C.setTexture("reflectivitySampler",b.metallicRoughnessTexture),C.setMatrix("reflectivityMatrix",b.metallicRoughnessTexture.getTextureMatrix())),null!==b.metallic&&C.setFloat("metallic",b.metallic),null!==b.roughness&&C.setFloat("glossiness",1-b.roughness),null!==b.baseTexture&&(C.setTexture("albedoSampler",b.baseTexture),C.setMatrix("albedoMatrix",b.baseTexture.getTextureMatrix())),null!==b.baseColor&&C.setColor3("albedoColor",b.baseColor)):"PBRSpecularGlossinessMaterial"===b.getClassName()?(null!==b.specularGlossinessTexture?(C.setTexture("reflectivitySampler",b.specularGlossinessTexture),C.setMatrix("reflectivityMatrix",b.specularGlossinessTexture.getTextureMatrix())):null!==b.specularColor&&C.setColor3("reflectivityColor",b.specularColor),null!==b.glossiness&&C.setFloat("glossiness",b.glossiness)):"PBRMaterial"===b.getClassName()?(null!==b.metallicTexture&&(C.setTexture("reflectivitySampler",b.metallicTexture),C.setMatrix("reflectivityMatrix",b.metallicTexture.getTextureMatrix())),null!==b.metallic&&C.setFloat("metallic",b.metallic),null!==b.roughness&&C.setFloat("glossiness",1-b.roughness),null!==b.roughness||null!==b.metallic||null!==b.metallicTexture?(null!==b.albedoTexture&&(C.setTexture("albedoSampler",b.albedoTexture),C.setMatrix("albedoMatrix",b.albedoTexture.getTextureMatrix())),null!==b.albedoColor&&C.setColor3("albedoColor",b.albedoColor)):(null!==b.reflectivityTexture?(C.setTexture("reflectivitySampler",b.reflectivityTexture),C.setMatrix("reflectivityMatrix",b.reflectivityTexture.getTextureMatrix())):null!==b.reflectivityColor&&C.setColor3("reflectivityColor",b.reflectivityColor),null!==b.microSurface&&C.setFloat("glossiness",b.microSurface))):"StandardMaterial"===b.getClassName()&&(null!==b.specularTexture&&(C.setTexture("reflectivitySampler",b.specularTexture),C.setMatrix("reflectivityMatrix",b.specularTexture.getTextureMatrix())),null!==b.specularColor&&C.setColor3("reflectivityColor",b.specularColor))),fo(C,b,this._scene),p.useBones&&p.computeBonesUsingShaders&&p.skeleton&&(C.setMatrices("mBones",p.skeleton.getTransformMatrices(p)),this._enableVelocity&&C.setMatrices("mPreviousBones",this._previousBonesTransformationMatrices[p.uniqueId])),ce.BindMorphTargetParameters(p,C),p.morphTargetManager&&p.morphTargetManager.isUsingTextureForTargets&&p.morphTargetManager._bind(C),this._enableVelocity&&(C.setMatrix("previousWorld",this._previousTransformationMatrices[_.uniqueId].world),C.setMatrix("previousViewProjection",this._previousTransformationMatrices[_.uniqueId].viewProjection)),T&&p.hasThinInstances&&C.setMatrix("world",x),p._processRendering(_,f,C,b.fillMode,y,T,(M,w)=>{M||C.setMatrix("world",w)})}this._enableVelocity&&(this._previousTransformationMatrices[_.uniqueId].world=x.clone(),this._previousTransformationMatrices[_.uniqueId].viewProjection=this._scene.getTransformMatrix().clone(),p.skeleton&&this._copyBonesTransformationMatrices(p.skeleton.getTransformMatrices(p),this._previousBonesTransformationMatrices[_.uniqueId]))};this._multiRenderTarget.customIsReadyFunction=(f,p,_)=>{if((_||0===p)&&f.subMeshes)for(let m=0;m<f.subMeshes.length;++m){const g=f.subMeshes[m],b=g.getMaterial(),y=g.getRenderingMesh();if(!b)continue;const T=y._getInstancesRenderList(g._id,!!g.getReplacementMesh()),x=t.getCaps().instancedArrays&&(null!==T.visibleInstances[g._id]||y.hasThinInstances);if(!this.isReady(g,x))return!1}return!0},this._multiRenderTarget.customRenderFunction=(f,p,_,m)=>{let g;if(this._linkedWithPrePass){if(!this._prePassRenderer.enabled)return;this._scene.getEngine().bindAttachments(this._attachmentsFromPrePass)}if(m.length){for(t.setColorWrite(!1),g=0;g<m.length;g++)d(m.data[g]);t.setColorWrite(!0)}for(g=0;g<f.length;g++)d(f.data[g]);for(t.setDepthWrite(!1),g=0;g<p.length;g++)d(p.data[g]);if(this.renderTransparentMeshes)for(g=0;g<_.length;g++)d(_.data[g]);t.setDepthWrite(!0)}}_copyBonesTransformationMatrices(t,i){for(let s=0;s<t.length;s++)i[s]=t[s];return i}}return r.DEPTH_TEXTURE_TYPE=0,r.NORMAL_TEXTURE_TYPE=1,r.POSITION_TEXTURE_TYPE=2,r.VELOCITY_TEXTURE_TYPE=3,r.REFLECTIVITY_TEXTURE_TYPE=4,r._SceneComponentInitialization=e=>{throw Ge("GeometryBufferRendererSceneComponent")},r})();class ule{constructor(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}}Object.defineProperty(ge.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(r){r&&r.isSupported&&(this._geometryBufferRenderer=r)},enumerable:!0,configurable:!0}),ge.prototype.enableGeometryBufferRenderer=function(r=1,e=15){return this._geometryBufferRenderer||(this._geometryBufferRenderer=new Zn(this,r,e),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null)),this._geometryBufferRenderer},ge.prototype.disableGeometryBufferRenderer=function(){!this._geometryBufferRenderer||(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};class dle{constructor(e){this.name=Me.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Me.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())}}Zn._SceneComponentInitialization=r=>{let e=r._getComponent(Me.NAME_GEOMETRYBUFFERRENDERER);e||(e=new dle(r),r._addComponent(e))};j.ShadersStore.motionBlurPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform float motionStrength;\nuniform float motionScale;\nuniform vec2 screenSize;\n#ifdef OBJECT_BASED\nuniform sampler2D velocitySampler;\n#else\nuniform sampler2D depthSampler;\nuniform mat4 inverseViewProjection;\nuniform mat4 prevViewProjection;\nuniform mat4 projection;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#ifdef GEOMETRY_SUPPORTED\n#ifdef OBJECT_BASED\nvec2 texelSize=1.0/screenSize;\nvec4 velocityColor=texture2D(velocitySampler,vUV);\nvelocityColor.rg=velocityColor.rg*2.0-vec2(1.0);\nvec2 velocity=vec2(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0))*velocityColor.a;\nvelocity*=motionScale*motionStrength;\nfloat speed=length(velocity/texelSize);\nint samplesCount=int(clamp(speed,1.0,SAMPLES));\nvelocity=normalize(velocity)*texelSize;\nfloat hlim=float(-samplesCount)*0.5+0.5;\nvec4 result=texture2D(textureSampler,vUV);\nfor (int i=1; i<int(SAMPLES); ++i)\n{\nif (i>=samplesCount)\nbreak;\nvec2 offset=vUV+velocity*(hlim+float(i));\nresult+=texture2D(textureSampler,offset);\n}\ngl_FragColor=result/float(samplesCount);\ngl_FragColor.a=1.0;\n#else\nvec2 texelSize=1.0/screenSize;\nfloat depth=texture2D(depthSampler,vUV).r;\ndepth=projection[2].z+projection[3].z/depth; \nvec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);\ncpos=inverseViewProjection*cpos;\ncpos/=cpos.w;\nvec4 ppos=prevViewProjection*cpos;\nppos/=ppos.w;\nppos.xy=ppos.xy*0.5+0.5;\nvec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;\nfloat speed=length(velocity/texelSize);\nint nSamples=int(clamp(speed,1.0,SAMPLES));\nvec4 result=texture2D(textureSampler,vUV);\nfor (int i=1; i<int(SAMPLES); ++i) {\nif (i>=nSamples)\nbreak;\nvec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);\nresult+=texture2D(textureSampler,offset1);\n}\ngl_FragColor=result/float(nSamples);\n#endif\n#else\ngl_FragColor=texture2D(textureSampler,vUV);\n#endif\n}\n";class Oh extends Pe{get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this._motionBlurSamples=e,this._updateEffect()}get isObjectBased(){return this._isObjectBased}set isObjectBased(e){this._isObjectBased!==e&&(this._isObjectBased=e,this._applyMode())}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"MotionBlurPostProcess"}constructor(e,t,i,s,n,o,a,l=0,c=!1,h=!1){super(e,"motionBlur",["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection","projection"],["velocitySampler","depthSampler"],i,s,n,o,a,"#define GEOMETRY_SUPPORTED\n#define SAMPLES 64.0\n#define OBJECT_BASED",l,void 0,null,c),this.motionStrength=1,this._motionBlurSamples=32,this._isObjectBased=!0,this._forceGeometryBuffer=!1,this._invViewProjection=null,this._previousViewProjection=null,this._forceGeometryBuffer=h,this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=!0)):(t.enablePrePassRenderer(),this._prePassRenderer&&(this._prePassRenderer.markAsDirty(),this._prePassEffectConfiguration=new ule)),this._applyMode()}excludeSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}t.push(e)}}removeExcludedSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}const i=t.indexOf(e);-1!==i&&t.splice(i,1)}}dispose(e){this._geometryBufferRenderer&&(this._geometryBufferRenderer._previousTransformationMatrices={},this._geometryBufferRenderer._previousBonesTransformationMatrices={},this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity=[]),super.dispose(e)}_applyMode(){if(!this._geometryBufferRenderer&&!this._prePassRenderer)return V.Warn("Multiple Render Target support needed to compute object based motion blur"),this.updateEffect();this._updateEffect(),this._invViewProjection=null,this._previousViewProjection=null,this.isObjectBased?(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=2),this.onApply=e=>this._onApplyObjectBased(e)):(this._invViewProjection=F.Identity(),this._previousViewProjection=this._scene.getTransformMatrix().clone(),this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=5),this.onApply=e=>this._onApplyScreenBased(e))}_onApplyObjectBased(e){if(e.setVector2("screenSize",new de(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(Zn.VELOCITY_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(2);e.setTexture("velocitySampler",this._prePassRenderer.getRenderTarget().textures[t])}}_onApplyScreenBased(e){const t=L.Matrix[0];if(t.copyFrom(this._scene.getTransformMatrix()),t.invertToRef(this._invViewProjection),e.setMatrix("inverseViewProjection",this._invViewProjection),e.setMatrix("prevViewProjection",this._previousViewProjection),this._previousViewProjection.copyFrom(t),e.setMatrix("projection",this._scene.getProjectionMatrix()),e.setVector2("screenSize",new de(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const i=this._geometryBufferRenderer.getTextureIndex(Zn.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[i])}else if(this._prePassRenderer){const i=this._prePassRenderer.getIndex(5);e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[i])}}_updateEffect(){if(this._geometryBufferRenderer||this._prePassRenderer){const e=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this._motionBlurSamples.toFixed(1),this._isObjectBased?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(e.join("\n"))}}static _Parse(e,t,i,s){return Ce.Parse(()=>new Oh(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1),e,i,s)}}E([I()],Oh.prototype,"motionStrength",void 0),E([I()],Oh.prototype,"motionBlurSamples",null),E([I()],Oh.prototype,"isObjectBased",null),le("BABYLON.MotionBlurPostProcess",Oh);j.ShadersStore.refractionPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D refractionSampler;\nuniform vec3 baseColor;\nuniform float depth;\nuniform float colorLevel;\nvoid main() {\nfloat ref=1.0-texture2D(refractionSampler,vUV).r;\nvec2 uv=vUV-vec2(0.5);\nvec2 offset=uv*depth*ref;\nvec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;\ngl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);\n}";class Nh extends Pe{get refractionTexture(){return this._refTexture}set refractionTexture(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1}getClassName(){return"RefractionPostProcess"}constructor(e,t,i,s,n,o,a,l,c,h){super(e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],o,a,l,c,h),this._ownRefractionTexture=!0,this.color=i,this.depth=s,this.colorLevel=n,this.refractionTextureUrl=t,this.onActivateObservable.add(u=>{this._refTexture=this._refTexture||new U(t,u.getScene())}),this.onApplyObservable.add(u=>{u.setColor3("baseColor",this.color),u.setFloat("depth",this.depth),u.setFloat("colorLevel",this.colorLevel),u.setTexture("refractionSampler",this._refTexture)})}dispose(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),super.dispose(e)}static _Parse(e,t,i,s){return Ce.Parse(()=>new Nh(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,s)}}E([I()],Nh.prototype,"color",void 0),E([I()],Nh.prototype,"depth",void 0),E([I()],Nh.prototype,"colorLevel",void 0),E([I()],Nh.prototype,"refractionTextureUrl",void 0),le("BABYLON.RefractionPostProcess",Nh);j.ShadersStore.sharpenPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\nuniform vec2 sharpnessAmounts;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec2 onePixel=vec2(1.0,1.0)/screenSize;\nvec4 color=texture2D(textureSampler,vUV);\nvec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1)) -\ncolor*4.0;\ngl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);\n}";class xd extends Pe{getClassName(){return"SharpenPostProcess"}constructor(e,t,i,s,n,o,a=0,l=!1){super(e,"sharpen",["sharpnessAmounts","screenSize"],null,t,i,s,n,o,null,a,void 0,null,l),this.colorAmount=1,this.edgeAmount=.3,this.onApply=c=>{c.setFloat2("screenSize",this.width,this.height),c.setFloat2("sharpnessAmounts",this.edgeAmount,this.colorAmount)}}static _Parse(e,t,i,s){return Ce.Parse(()=>new xd(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,s)}}E([I()],xd.prototype,"colorAmount",void 0),E([I()],xd.prototype,"edgeAmount",void 0),le("BABYLON.SharpenPostProcess",xd);class Td{get name(){return this._name}get cameras(){return this._cameras}constructor(e,t){this._engine=e,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}getClassName(){return"PostProcessRenderPipeline"}get isSupported(){for(const e in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&!this._renderEffects[e].isSupported)return!1;return!0}addEffect(e){this._renderEffects[e._name]=e}_rebuild(){}_enableEffect(e,t){const i=this._renderEffects[e];!i||i._enable(q.MakeArray(t||this._cameras))}_disableEffect(e,t){const i=this._renderEffects[e];!i||i._disable(q.MakeArray(t||this._cameras))}_attachCameras(e,t){const i=q.MakeArray(e||this._cameras);if(!i)return;const s=[];let n;for(n=0;n<i.length;n++){const o=i[n];!o||(-1===this._cameras.indexOf(o)?this._cameras.push(o):t&&s.push(n))}for(n=0;n<s.length;n++)i.splice(s[n],1);for(const o in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,o)&&this._renderEffects[o]._attachCameras(i)}_detachCameras(e){const t=q.MakeArray(e||this._cameras);if(t){for(const i in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,i)&&this._renderEffects[i]._detachCameras(t);for(let i=0;i<t.length;i++)this._cameras.splice(this._cameras.indexOf(t[i]),1)}}_update(){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._update();for(let e=0;e<this._cameras.length;e++){if(!this._cameras[e])continue;const t=this._cameras[e].name;this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()}}_reset(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array}_enableMSAAOnFirstPostProcess(e){if(!this._engine._features.supportMSAA)return!1;const t=Object.keys(this._renderEffects);if(t.length>0){const i=this._renderEffects[t[0]].getPostProcesses();i&&(i[0].samples=e)}return!0}setPrePassRenderer(e){return!1}dispose(){}}E([I()],Td.prototype,"_name",void 0);class fle{constructor(){this._renderPipelines={}}get supportedPipelines(){const e=[];for(const t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){const i=this._renderPipelines[t];i.isSupported&&e.push(i)}return e}addPipeline(e){this._renderPipelines[e._name]=e}attachCamerasToRenderPipeline(e,t,i=!1){const s=this._renderPipelines[e];!s||s._attachCameras(t,i)}detachCamerasFromRenderPipeline(e,t){const i=this._renderPipelines[e];!i||i._detachCameras(t)}enableEffectInPipeline(e,t,i){const s=this._renderPipelines[e];!s||s._enableEffect(t,i)}disableEffectInPipeline(e,t,i){const s=this._renderPipelines[e];!s||s._disableEffect(t,i)}update(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){const t=this._renderPipelines[e];t.isSupported?t._update():(t.dispose(),delete this._renderPipelines[e])}}_rebuild(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e]._rebuild()}dispose(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e].dispose()}}Object.defineProperty(ge.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let r=this._getComponent(Me.NAME_POSTPROCESSRENDERPIPELINEMANAGER);r||(r=new ple(this),this._addComponent(r)),this._postProcessRenderPipelineManager=new fle}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});class ple{constructor(e){this.name=Me.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Me.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}}class qs extends Td{get automaticBuild(){return this._buildAllowed}set automaticBuild(e){this._buildAllowed=e}get scene(){return this._scene}set sharpenEnabled(e){this._sharpenEnabled!==e&&(this._sharpenEnabled=e,this._buildPipeline())}get sharpenEnabled(){return this._sharpenEnabled}get bloomKernel(){return this._bloomKernel}set bloomKernel(e){this._bloomKernel=e,this.bloom.kernel=e/this._hardwareScaleLevel}set bloomWeight(e){this._bloomWeight!==e&&(this.bloom.weight=e,this._bloomWeight=e)}get bloomWeight(){return this._bloomWeight}set bloomThreshold(e){this._bloomThreshold!==e&&(this.bloom.threshold=e,this._bloomThreshold=e)}get bloomThreshold(){return this._bloomThreshold}set bloomScale(e){this._bloomScale!==e&&(this._bloomScale=e,this._rebuildBloom(),this._buildPipeline())}get bloomScale(){return this._bloomScale}set bloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get bloomEnabled(){return this._bloomEnabled}_rebuildBloom(){const e=this.bloom;this.bloom=new Zz(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(let t=0;t<this._cameras.length;t++)e.disposeEffects(this._cameras[t])}get depthOfFieldEnabled(){return this._depthOfFieldEnabled}set depthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get depthOfFieldBlurLevel(){return this._depthOfFieldBlurLevel}set depthOfFieldBlurLevel(e){if(this._depthOfFieldBlurLevel===e)return;this._depthOfFieldBlurLevel=e;const t=this.depthOfField;this.depthOfField=new c4(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=t.focalLength,this.depthOfField.focusDistance=t.focusDistance,this.depthOfField.fStop=t.fStop,this.depthOfField.lensSize=t.lensSize;for(let i=0;i<this._cameras.length;i++)t.disposeEffects(this._cameras[i]);this._buildPipeline()}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}set imageProcessingEnabled(e){this._imageProcessingEnabled!==e&&(this._scene.imageProcessingConfiguration.isEnabled=e)}get imageProcessingEnabled(){return this._imageProcessingEnabled}set glowLayerEnabled(e){e&&!this._glowLayer?this._glowLayer=new Kn("",this._scene):!e&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)}get glowLayerEnabled(){return null!=this._glowLayer}get glowLayer(){return this._glowLayer}set chromaticAberrationEnabled(e){this._chromaticAberrationEnabled!==e&&(this._chromaticAberrationEnabled=e,this._buildPipeline())}get chromaticAberrationEnabled(){return this._chromaticAberrationEnabled}set grainEnabled(e){this._grainEnabled!==e&&(this._grainEnabled=e,this._buildPipeline())}get grainEnabled(){return this._grainEnabled}constructor(e="",t=!0,i=be.LastCreatedScene,s,n=!0){super(i.getEngine(),e),this._camerasToBeAttached=[],this.SharpenPostProcessId="SharpenPostProcessEffect",this.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",this.FxaaPostProcessId="FxaaPostProcessEffect",this.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",this.GrainPostProcessId="GrainPostProcessEffect",this._glowLayer=null,this.animations=[],this._imageProcessingConfigurationObserver=null,this._sharpenEnabled=!1,this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._depthOfFieldBlurLevel=wh.Low,this._fxaaEnabled=!1,this._imageProcessingEnabled=!0,this._bloomScale=.5,this._chromaticAberrationEnabled=!1,this._grainEnabled=!1,this._buildAllowed=!0,this.onBuildObservable=new z,this._resizeObserver=null,this._hardwareScaleLevel=1,this._bloomKernel=64,this._bloomWeight=.15,this._bloomThreshold=.9,this._samples=1,this._hasCleared=!1,this._prevPostProcess=null,this._prevPrevPostProcess=null,this._depthOfFieldSceneObserver=null,this._activeCameraChangedObserver=null,this._activeCamerasChangedObserver=null,this._cameras=s||i.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._buildAllowed=n,this._scene=i;const o=this._scene.getEngine().getCaps();this._hdr=t&&(o.textureHalfFloatRender||o.textureFloatRender),this._hdr?o.textureHalfFloatRender?this._defaultPipelineTextureType=2:o.textureFloatRender&&(this._defaultPipelineTextureType=1):this._defaultPipelineTextureType=0,i.postProcessRenderPipelineManager.addPipeline(this);const a=this._scene.getEngine();this.sharpen=new xd("sharpen",1,null,U.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._sharpenEffect=new Ut(a,this.SharpenPostProcessId,()=>this.sharpen,!0),this.depthOfField=new c4(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!0),this._hardwareScaleLevel=a.getHardwareScalingLevel(),this._resizeObserver=a.onResizeObservable.add(()=>{this._hardwareScaleLevel=a.getHardwareScalingLevel(),this.bloomKernel=this._bloomKernel}),this.bloom=new Zz(this._scene,this._bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!0),this.chromaticAberration=new Sa("ChromaticAberration",a.getRenderWidth(),a.getRenderHeight(),1,null,U.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._chromaticAberrationEffect=new Ut(a,this.ChromaticAberrationPostProcessId,()=>this.chromaticAberration,!0),this.grain=new yd("Grain",1,null,U.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._grainEffect=new Ut(a,this.GrainPostProcessId,()=>this.grain,!0),this._imageProcessingConfigurationObserver=this._scene.imageProcessingConfiguration.onUpdateParameters.add(()=>{this.bloom._downscale._exposure=this._scene.imageProcessingConfiguration.exposure,this.imageProcessingEnabled!==this._scene.imageProcessingConfiguration.isEnabled&&(this._imageProcessingEnabled=this._scene.imageProcessingConfiguration.isEnabled,q.SetImmediate(()=>{this._buildPipeline()}))}),this._buildPipeline()}getClassName(){return"DefaultRenderingPipeline"}prepare(){const e=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=e}_setAutoClearAndTextureSharing(e,t=!1){this._hasCleared?e.autoClear=!1:(e.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),t||(this._prevPrevPostProcess?e.shareOutputWith(this._prevPrevPostProcess):e.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=e)}_buildPipeline(){if(!this._buildAllowed)return;this._scene.autoClear=!0;const e=this._scene.getEngine();if(this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(const t of this._cameras)this._scene.enableDepthRenderer(t).useOnlyInActiveCamera=!0;this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add(t=>{this._cameras.indexOf(t.activeCamera)>-1&&(this.depthOfField.depthTexture=t.enableDepthRenderer(t.activeCamera).getDepthMap())})}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);const t=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=t.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new Av("imageProcessing",1,null,U.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType,this.scene.imageProcessingConfiguration),this._hdr?(this.addEffect(new Ut(e,this.ImageProcessingPostProcessId,()=>this.imageProcessing,!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,(!this._cameras||0===this._cameras.length)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new bd("fxaa",1,null,U.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType),this.addEffect(new Ut(e,this.FxaaPostProcessId,()=>this.fxaa,!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),(this._scene.activeCameras&&this._scene.activeCameras.length>1||this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera))&&(this._scene.autoClear=!0),this._activeCameraChangedObserver||(this._activeCameraChangedObserver=this._scene.onActiveCameraChanged.add(()=>{this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera)&&(this._scene.autoClear=!0)})),this._activeCamerasChangedObserver||(this._activeCamerasChangedObserver=this._scene.onActiveCamerasChanged.add(()=>{this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0)})),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&V.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}_disposePostProcesses(e=!1){for(let t=0;t<this._cameras.length;t++){const i=this._cameras[t];this.imageProcessing&&this.imageProcessing.dispose(i),this.fxaa&&this.fxaa.dispose(i),e&&(this.sharpen&&this.sharpen.dispose(i),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(i)),this.bloom&&this.bloom.disposeEffects(i),this.chromaticAberration&&this.chromaticAberration.dispose(i),this.grain&&this.grain.dispose(i),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,e&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._buildAllowed=!1,this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.onActiveCameraChanged.remove(this._activeCameraChangedObserver),this._scene.onActiveCamerasChanged.remove(this._activeCamerasChangedObserver),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),super.dispose()}serialize(){const e=Ce.Serialize(this);return e.customType="DefaultRenderingPipeline",e}static Parse(e,t,i){return Ce.Parse(()=>new qs(e._name,e._name._hdr,t),e,t,i)}}E([I()],qs.prototype,"sharpenEnabled",null),E([I()],qs.prototype,"bloomKernel",null),E([I()],qs.prototype,"_bloomWeight",void 0),E([I()],qs.prototype,"_bloomThreshold",void 0),E([I()],qs.prototype,"_hdr",void 0),E([I()],qs.prototype,"bloomWeight",null),E([I()],qs.prototype,"bloomThreshold",null),E([I()],qs.prototype,"bloomScale",null),E([I()],qs.prototype,"bloomEnabled",null),E([I()],qs.prototype,"depthOfFieldEnabled",null),E([I()],qs.prototype,"depthOfFieldBlurLevel",null),E([I()],qs.prototype,"fxaaEnabled",null),E([I()],qs.prototype,"samples",null),E([I()],qs.prototype,"imageProcessingEnabled",null),E([I()],qs.prototype,"glowLayerEnabled",null),E([I()],qs.prototype,"chromaticAberrationEnabled",null),E([I()],qs.prototype,"grainEnabled",null),le("BABYLON.DefaultRenderingPipeline",qs);j.ShadersStore.lensHighlightsPixelShader="uniform sampler2D textureSampler; \nuniform float gain;\nuniform float threshold;\nuniform float screen_width;\nuniform float screen_height;\nvarying vec2 vUV;\nvec4 highlightColor(vec4 color) {\nvec4 highlight=color;\nfloat luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));\nfloat lum_threshold;\nif (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }\nelse { lum_threshold=0.5+0.44*threshold; }\nluminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);\nhighlight*=luminance*gain;\nhighlight.a=1.0;\nreturn highlight;\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec4 original=texture2D(textureSampler,vUV);\nif (gain==-1.0) {\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\nreturn;\n}\nfloat w=2.0/screen_width;\nfloat h=2.0/screen_height;\nfloat weight=1.0;\nvec4 blurred=vec4(0.0,0.0,0.0,0.0);\n#ifdef PENTAGON\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));\n#else\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));\n#endif\nblurred/=39.0;\ngl_FragColor=blurred;\n}";j.ShadersStore.depthOfFieldPixelShader="uniform sampler2D textureSampler;\nuniform sampler2D highlightsSampler;\nuniform sampler2D depthSampler;\nuniform sampler2D grainSampler;\nuniform float grain_amount;\nuniform bool blur_noise;\nuniform float screen_width;\nuniform float screen_height;\nuniform float distortion;\nuniform bool dof_enabled;\nuniform float screen_distance; \nuniform float aperture;\nuniform float darken;\nuniform float edge_blur;\nuniform bool highlights;\nuniform float near;\nuniform float far;\nvarying vec2 vUV;\n#define PI 3.14159265\n#define TWOPI 6.28318530\n#define inverse_focal_length 0.1 \nvec2 centered_screen_pos;\nvec2 distorted_coords;\nfloat radius2;\nfloat radius;\nvec2 rand(vec2 co)\n{\nfloat noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));\nfloat noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));\nreturn clamp(vec2(noise1,noise2),0.0,1.0);\n}\nvec2 getDistortedCoords(vec2 coords) {\nif (distortion==0.0) { return coords; }\nvec2 direction=1.0*normalize(centered_screen_pos);\nvec2 dist_coords=vec2(0.5,0.5);\ndist_coords.x=0.5+direction.x*radius2*1.0;\ndist_coords.y=0.5+direction.y*radius2*1.0;\nfloat dist_amount=clamp(distortion*0.23,0.0,1.0);\ndist_coords=mix(coords,dist_coords,dist_amount);\nreturn dist_coords;\n}\nfloat sampleScreen(inout vec4 color,in vec2 offset,in float weight) {\nvec2 coords=distorted_coords;\nfloat angle=rand(coords*100.0).x*TWOPI;\ncoords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));\ncolor+=texture2D(textureSampler,coords)*weight;\nreturn weight;\n}\nfloat getBlurLevel(float size) {\nreturn min(3.0,ceil(size/1.0));\n}\nvec4 getBlurColor(float size) {\nvec4 col=texture2D(textureSampler,distorted_coords);\nfloat blur_level=getBlurLevel(size);\nfloat w=(size/screen_width);\nfloat h=(size/screen_height);\nfloat total_weight=1.0;\nvec2 sample_coords;\ntotal_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);\ntotal_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);\ntotal_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);\ntotal_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);\ntotal_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);\ntotal_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);\ntotal_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);\ntotal_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);\ntotal_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);\ntotal_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);\nif (blur_level>1.0) {\ntotal_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);\ntotal_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);\ntotal_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);\ntotal_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);\ntotal_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);\ntotal_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);\ntotal_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);\ntotal_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);\ntotal_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);\ntotal_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);\n}\nif (blur_level>2.0) {\ntotal_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);\ntotal_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);\ntotal_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);\ntotal_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);\ntotal_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);\ntotal_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);\ntotal_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);\ntotal_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);\ntotal_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);\n}\ncol/=total_weight; \nif (darken>0.0) {\ncol.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);\n}\nreturn col;\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\ncentered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);\nradius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;\nradius=sqrt(radius2);\ndistorted_coords=getDistortedCoords(vUV); \nvec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); \nfloat depth=texture2D(depthSampler,distorted_coords).r; \nfloat distance=near+(far-near)*depth; \nvec4 color=texture2D(textureSampler,vUV); \nfloat coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));\nif (dof_enabled==false || coc<0.07) { coc=0.0; }\nfloat edge_blur_amount=0.0;\nif (edge_blur>0.0) {\nedge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;\n}\nfloat blur_amount=max(edge_blur_amount,coc);\nif (blur_amount==0.0) {\ngl_FragColor=texture2D(textureSampler,distorted_coords);\n}\nelse {\ngl_FragColor=getBlurColor(blur_amount*1.7);\nif (highlights) {\ngl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;\n}\nif (blur_noise) {\nvec2 noise=rand(distorted_coords)*0.01*blur_amount;\nvec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);\ngl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;\n}\n}\nif (grain_amount>0.0) {\nvec4 grain_color=texture2D(grainSampler,texels_coords*0.003);\ngl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;\n}\n}\n";class _le{constructor(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}}j.ShadersStore.ssao2PixelShader="precision highp float;\nuniform sampler2D textureSampler;\nvarying vec2 vUV;\n#ifdef SSAO\nfloat scales[16]=float[16](\n0.1,\n0.11406250000000001,\n0.131640625,\n0.15625,\n0.187890625,\n0.2265625,\n0.272265625,\n0.325,\n0.384765625,\n0.4515625,\n0.525390625,\n0.60625,\n0.694140625,\n0.7890625,\n0.891015625,\n1.0\n);\nuniform float near;\nuniform float radius;\nuniform sampler2D depthSampler;\nuniform sampler2D randomSampler;\nuniform sampler2D normalSampler;\nuniform float randTextureTiles;\nuniform float samplesFactor;\nuniform vec3 sampleSphere[SAMPLES];\nuniform float totalStrength;\nuniform float base;\nuniform float xViewport;\nuniform float yViewport;\nuniform mat3 depthProjection;\nuniform float maxZ;\nuniform float minZAspect;\nuniform vec2 texelSize;\nuniform mat4 projection;\nvoid main()\n{\nvec3 random=textureLod(randomSampler,vUV*randTextureTiles,0.0).rgb;\nfloat depth=textureLod(depthSampler,vUV,0.0).r;\nfloat depthSign=depth/abs(depth);\ndepth=depth*depthSign;\nvec3 normal=textureLod(normalSampler,vUV,0.0).rgb;\nfloat occlusion=0.0;\nfloat correctedRadius=min(radius,minZAspect*depth/near);\nvec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);\nvec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);\nvec3 origin=vViewRay*vDepthFactor;\nvec3 rvec=random*2.0-1.0;\nrvec.z=0.0;\nfloat dotProduct=dot(rvec,normal);\nrvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);\nvec3 tangent=normalize(rvec-normal*dot(rvec,normal));\nvec3 bitangent=cross(normal,tangent);\nmat3 tbn=mat3(tangent,bitangent,normal);\nfloat difference;\nfor (int i=0; i<SAMPLES; ++i) {\nvec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];\nsamplePosition=samplePosition*correctedRadius+origin;\nvec4 offset=vec4(samplePosition,1.0);\noffset=projection*offset;\noffset.xyz/=offset.w;\noffset.xy=offset.xy*0.5+0.5;\nif (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {\ncontinue;\n}\nfloat sampleDepth=abs(textureLod(depthSampler,offset.xy,0.0).r);\ndifference=depthSign*samplePosition.z-sampleDepth;\nfloat rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);\nocclusion+=step(EPSILON,difference)*rangeCheck;\n}\nocclusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;\nfloat result=clamp(ao+base,0.0,1.0);\ngl_FragColor=vec4(vec3(result),1.0);\n}\n#endif\n#ifdef BLUR\nuniform float outSize;\nuniform float soften;\nuniform float tolerance;\nuniform int samples;\n#ifndef BLUR_BYPASS\nuniform sampler2D depthSampler;\n#ifdef BLUR_LEGACY\nfloat blur13Bilateral(sampler2D image,vec2 uv,vec2 step) {\nfloat result=0.0;\nvec2 off1=vec2(1.411764705882353)*step;\nvec2 off2=vec2(3.2941176470588234)*step;\nvec2 off3=vec2(5.176470588235294)*step;\nfloat compareDepth=abs(textureLod(depthSampler,uv,0.0).r);\nfloat sampleDepth;\nfloat weight;\nfloat weightSum=30.0;\nresult+=textureLod(image,uv,0.0).r*30.0;\nsampleDepth=abs(textureLod(depthSampler,uv+off1,0.0).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+= weight;\nresult+=textureLod(image,uv+off1,0.0).r*weight;\nsampleDepth=abs(textureLod(depthSampler,uv-off1,0.0).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+= weight;\nresult+=textureLod(image,uv-off1,0.0).r*weight;\nsampleDepth=abs(textureLod(depthSampler,uv+off2,0.0).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\nresult+=textureLod(image,uv+off2,0.0).r*weight;\nsampleDepth=abs(textureLod(depthSampler,uv-off2,0.0).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\nresult+=textureLod(image,uv-off2,0.0).r*weight;\nsampleDepth=abs(textureLod(depthSampler,uv+off3,0.0).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\nresult+=textureLod(image,uv+off3,0.0).r*weight;\nsampleDepth=abs(textureLod(depthSampler,uv-off3,0.0).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\nresult+=textureLod(image,uv-off3,0.0).r*weight;\nreturn result/weightSum;\n}\n#endif\n#endif\nvoid main()\n{\nfloat result=0.0;\n#ifdef BLUR_BYPASS\nresult=textureLod(textureSampler,vUV,0.0).r;\n#else\n#ifdef BLUR_H\nvec2 step=vec2(1.0/outSize,0.0);\n#else\nvec2 step=vec2(0.0,1.0/outSize);\n#endif\n#ifdef BLUR_LEGACY\nresult=blur13Bilateral(textureSampler,vUV,step);\n#else\nfloat compareDepth=abs(textureLod(depthSampler,vUV,0.0).r);\nfloat weightSum=0.0;\nfor (int i=-samples; i<samples; i+=2)\n{\nvec2 samplePos=vUV+step*(float(i)+0.5);\nfloat sampleDepth=abs(textureLod(depthSampler,samplePos,0.0).r);\nfloat falloff=smoothstep(0.0,\nfloat(samples),\nfloat(samples)-abs(float(i))*soften);\nfloat minDivider=tolerance*0.5+0.003;\nfloat weight=falloff/( minDivider+abs(compareDepth-sampleDepth));\nresult+=textureLod(textureSampler,samplePos,0.0).r*weight;\nweightSum+=weight;\n}\nresult/=weightSum;\n#endif\n#endif\ngl_FragColor.rgb=vec3(result);\ngl_FragColor.a=1.0;\n}\n#endif\n";j.ShadersStore.ssaoCombinePixelShader="uniform sampler2D textureSampler;\nuniform sampler2D originalColor;\nuniform vec4 viewport;\nvarying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 ssaoColor=texture2D(textureSampler,viewport.xy+vUV*viewport.zw);\nvec4 sceneColor=texture2D(originalColor,vUV);\ngl_FragColor=sceneColor*ssaoColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";class vs extends Td{set epsilon(e){this._epsilon=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO())}get epsilon(){return this._epsilon}set samples(e){this._samples=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()}get samples(){return this._samples}set textureSamples(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e}get textureSamples(){return this._textureSamples}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}set bypassBlur(e){const t=this._getDefinesForBlur(this.expensiveBlur,e),i=this._getSamplersForBlur(e);this._blurHPostProcess.updateEffect(t.h,null,i),this._blurVPostProcess.updateEffect(t.v,null,i),this._bypassBlur=e}get bypassBlur(){return this._bypassBlur}set expensiveBlur(e){const t=this._getDefinesForBlur(e,this._bypassBlur);this._blurHPostProcess.updateEffect(t.h),this._blurVPostProcess.updateEffect(t.v),this._expensiveBlur=e}get expensiveBlur(){return this._expensiveBlur}static get IsSupported(){const e=be.LastCreatedEngine;return!!e&&e._features.supportSSAO2}get scene(){return this._scene}constructor(e,t,i,s,n=!1,o=0){if(super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.maxZ=100,this.minZAspect=.2,this._epsilon=.02,this._samples=8,this._textureSamples=1,this._forceGeometryBuffer=!1,this.radius=2,this.base=0,this._bypassBlur=!1,this._expensiveBlur=!0,this.bilateralSamples=16,this.bilateralSoften=0,this.bilateralTolerance=0,this._bits=new Uint32Array(1),this._scene=t,this._ratio=i,this._textureType=o,this._forceGeometryBuffer=n,!this.isSupported)return void V.Error("The current engine does not support SSAO 2.");const a=this._ratio.ssaoRatio||i,l=this._ratio.blurRatio||i;this._forceGeometryBuffer?t.enableGeometryBufferRenderer():t.enablePrePassRenderer(),this._createRandomTexture(),this._originalColorPostProcess=new fa("SSAOOriginalSceneColor",1,null,U.BILINEAR_SAMPLINGMODE,t.getEngine(),void 0,this._textureType),this._originalColorPostProcess.samples=this.textureSamples,this._createSSAOPostProcess(1,o),this._createBlurPostProcess(a,l,this._textureType),this._createSSAOCombinePostProcess(l,this._textureType),this.addEffect(new Ut(t.getEngine(),this.SSAOOriginalSceneColorEffect,()=>this._originalColorPostProcess,!0)),this.addEffect(new Ut(t.getEngine(),this.SSAORenderEffect,()=>this._ssaoPostProcess,!0)),this.addEffect(new Ut(t.getEngine(),this.SSAOBlurHRenderEffect,()=>this._blurHPostProcess,!0)),this.addEffect(new Ut(t.getEngine(),this.SSAOBlurVRenderEffect,()=>this._blurVPostProcess,!0)),this.addEffect(new Ut(t.getEngine(),this.SSAOCombineRenderEffect,()=>this._ssaoCombinePostProcess,!0)),t.postProcessRenderPipelineManager.addPipeline(this),s&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,s)}getClassName(){return"SSAO2RenderingPipeline"}dispose(e=!1){for(let t=0;t<this._scene.cameras.length;t++){const i=this._scene.cameras[t];this._originalColorPostProcess.dispose(i),this._ssaoPostProcess.dispose(i),this._blurHPostProcess.dispose(i),this._blurVPostProcess.dispose(i),this._ssaoCombinePostProcess.dispose(i)}this._randomTexture.dispose(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_rebuild(){super._rebuild()}_getSamplersForBlur(e){return e?["textureSampler"]:["textureSampler","depthSampler"]}_getDefinesForBlur(e,t){let i="#define BLUR\n";return t&&(i+="#define BLUR_BYPASS\n"),e||(i+="#define BLUR_LEGACY\n"),{h:i+"#define BLUR_H\n",v:i}}_createBlurPostProcess(e,t,i){const s=this._getDefinesForBlur(this.expensiveBlur,this.bypassBlur),n=this._getSamplersForBlur(this.bypassBlur);this._blurHPostProcess=this._createBlurFilter("BlurH",n,e,s.h,i,!0),this._blurVPostProcess=this._createBlurFilter("BlurV",n,t,s.v,i,!1)}_createBlurFilter(e,t,i,s,n,o){const a=new Pe(e,"ssao2",["outSize","samples","soften","tolerance"],t,i,null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,s,n);return a.onApply=l=>{if(!this._scene.activeCamera)return;const c=o?this._ssaoCombinePostProcess.width:this._ssaoCombinePostProcess.height;l.setFloat("outSize",c>0?c:o?this._originalColorPostProcess.width:this._originalColorPostProcess.height),l.setInt("samples",this.bilateralSamples),l.setFloat("soften",this.bilateralSoften),l.setFloat("tolerance",this.bilateralTolerance),this._geometryBufferRenderer?l.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&l.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)])},a.samples=this.textureSamples,a}_radicalInverse_VdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(1431655765&this._bits[0])<<1|(2863311530&this._bits[0])>>>1>>>0,this._bits[0]=(858993459&this._bits[0])<<2|(3435973836&this._bits[0])>>>2>>>0,this._bits[0]=(252645135&this._bits[0])<<4|(4042322160&this._bits[0])>>>4>>>0,this._bits[0]=(16711935&this._bits[0])<<8|(4278255360&this._bits[0])>>>8>>>0,2.3283064365386963e-10*this._bits[0]}_hammersley(e,t){return[e/t,this._radicalInverse_VdC(e)]}_hemisphereSample_uniform(e,t){const i=2*t*Math.PI,s=1-.85*e,n=Math.sqrt(1-s*s);return new v(Math.cos(i)*n,Math.sin(i)*n,s)}_generateHemisphere(){const e=this.samples,t=[];let i,s=0;for(;s<e;){if(e<16)i=this._hemisphereSample_uniform(Math.random(),Math.random());else{const n=this._hammersley(s,e);i=this._hemisphereSample_uniform(n[0],n[1])}t.push(i.x,i.y,i.z),s++}return t}_getDefinesForSSAO(){return`#define SSAO\n#define SAMPLES ${this.samples}\n#define EPSILON ${this.epsilon.toFixed(4)}`}_createSSAOPostProcess(e,t){this._sampleSphere=this._generateHemisphere();const i=this._getDefinesForSSAO();this._ssaoPostProcess=new Pe("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],["randomSampler","depthSampler","normalSampler"],e,null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i,t),this._ssaoPostProcess.onApply=n=>{var o,a,l,c;if(this._scene.activeCamera){if(n.setArray3("sampleSphere",this._sampleSphere),n.setFloat("randTextureTiles",32),n.setFloat("samplesFactor",1/this.samples),n.setFloat("totalStrength",this.totalStrength),n.setFloat2("texelSize",1/this._ssaoPostProcess.width,1/this._ssaoPostProcess.height),n.setFloat("radius",this.radius),n.setFloat("maxZ",this.maxZ),n.setFloat("minZAspect",this.minZAspect),n.setFloat("base",this.base),n.setFloat("near",this._scene.activeCamera.minZ),this._scene.activeCamera.mode===ve.PERSPECTIVE_CAMERA)n.setMatrix3x3("depthProjection",vs.PERSPECTIVE_DEPTH_PROJECTION),n.setFloat("xViewport",Math.tan(this._scene.activeCamera.fov/2)*this._scene.getEngine().getAspectRatio(this._scene.activeCamera,!0)),n.setFloat("yViewport",Math.tan(this._scene.activeCamera.fov/2));else{const h=this._scene.getEngine().getRenderWidth()/2,u=this._scene.getEngine().getRenderHeight()/2,d=null!==(o=this._scene.activeCamera.orthoLeft)&&void 0!==o?o:-h,f=null!==(a=this._scene.activeCamera.orthoRight)&&void 0!==a?a:h,p=null!==(l=this._scene.activeCamera.orthoBottom)&&void 0!==l?l:-u,_=null!==(c=this._scene.activeCamera.orthoTop)&&void 0!==c?c:u;n.setMatrix3x3("depthProjection",vs.ORTHO_DEPTH_PROJECTION),n.setFloat("xViewport",.5*(f-d)),n.setFloat("yViewport",.5*(_-p))}n.setMatrix("projection",this._scene.getProjectionMatrix()),this._geometryBufferRenderer?(n.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]),n.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[1])):this._prePassRenderer&&(n.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),n.setTexture("normalSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(6)])),n.setTexture("randomSampler",this._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new _le)}_createSSAOCombinePostProcess(e,t){this._ssaoCombinePostProcess=new Pe("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,void 0,t),this._ssaoCombinePostProcess.onApply=i=>{const s=this._scene.activeCamera.viewport;i.setVector4("viewport",L.Vector4[0].copyFromFloats(s.x,s.y,s.width,s.height)),i.setTextureFromPostProcessOutput("originalColor",this._originalColorPostProcess)},this._ssaoCombinePostProcess.samples=this.textureSamples}_createRandomTexture(){this._randomTexture=new ic("SSAORandomTexture",128,this._scene,!1,U.BILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=U.WRAP_ADDRESSMODE,this._randomTexture.wrapV=U.WRAP_ADDRESSMODE;const t=this._randomTexture.getContext(),i=(n,o)=>Math.random()*(o-n)+n,s=v.Zero();for(let n=0;n<128;n++)for(let o=0;o<128;o++)s.x=i(0,1),s.y=i(0,1),s.z=0,s.normalize(),s.scaleInPlace(255),s.x=Math.floor(s.x),s.y=Math.floor(s.y),t.fillStyle="rgb("+s.x+", "+s.y+", "+s.z+")",t.fillRect(n,o,1,1);this._randomTexture.update(!1)}serialize(){const e=Ce.Serialize(this);return e.customType="SSAO2RenderingPipeline",e}static Parse(e,t,i){return Ce.Parse(()=>new vs(e._name,t,e._ratio,void 0,e._forceGeometryBuffer,e._textureType),e,t,i)}}vs.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1],vs.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1],E([I()],vs.prototype,"totalStrength",void 0),E([I()],vs.prototype,"maxZ",void 0),E([I()],vs.prototype,"minZAspect",void 0),E([I("epsilon")],vs.prototype,"_epsilon",void 0),E([I("samples")],vs.prototype,"_samples",void 0),E([I("textureSamples")],vs.prototype,"_textureSamples",void 0),E([I()],vs.prototype,"_forceGeometryBuffer",void 0),E([I()],vs.prototype,"_ratio",void 0),E([I()],vs.prototype,"_textureType",void 0),E([I()],vs.prototype,"radius",void 0),E([I()],vs.prototype,"base",void 0),E([I("bypassBlur")],vs.prototype,"_bypassBlur",void 0),E([I("expensiveBlur")],vs.prototype,"_expensiveBlur",void 0),E([I()],vs.prototype,"bilateralSamples",void 0),E([I()],vs.prototype,"bilateralSoften",void 0),E([I()],vs.prototype,"bilateralTolerance",void 0),le("BABYLON.SSAO2RenderingPipeline",vs);j.ShadersStore.ssaoPixelShader="uniform sampler2D textureSampler;\nvarying vec2 vUV;\n#ifdef SSAO\nuniform sampler2D randomSampler;\nuniform float randTextureTiles;\nuniform float samplesFactor;\nuniform vec3 sampleSphere[SAMPLES];\nuniform float totalStrength;\nuniform float radius;\nuniform float area;\nuniform float fallOff;\nuniform float base;\nvec3 normalFromDepth(float depth,vec2 coords)\n{\nvec2 offset1=vec2(0.0,radius);\nvec2 offset2=vec2(radius,0.0);\nfloat depth1=texture2D(textureSampler,coords+offset1).r;\nfloat depth2=texture2D(textureSampler,coords+offset2).r;\nvec3 p1=vec3(offset1,depth1-depth);\nvec3 p2=vec3(offset2,depth2-depth);\nvec3 normal=cross(p1,p2);\nnormal.z=-normal.z;\nreturn normalize(normal);\n}\nvoid main()\n{\nvec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);\nfloat depth=texture2D(textureSampler,vUV).r;\nvec3 position=vec3(vUV,depth);\nvec3 normal=normalFromDepth(depth,vUV);\nfloat radiusDepth=radius/depth;\nfloat occlusion=0.0;\nvec3 ray;\nvec3 hemiRay;\nfloat occlusionDepth;\nfloat difference;\nfor (int i=0; i<SAMPLES; i++)\n{\nray=radiusDepth*reflect(sampleSphere[i],random);\nhemiRay=position+sign(dot(ray,normal))*ray;\nocclusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;\ndifference=depth-occlusionDepth;\nocclusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));\n}\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;\nfloat result=clamp(ao+base,0.0,1.0);\ngl_FragColor.r=result;\ngl_FragColor.g=result;\ngl_FragColor.b=result;\ngl_FragColor.a=1.0;\n}\n#endif\n";class Qp extends Td{get scene(){return this._scene}constructor(e,t,i,s){super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.base=.5,this._firstUpdate=!0,this._scene=t,this._createRandomTexture();const n=i.ssaoRatio||i,o=i.combineRatio||i;this._originalColorPostProcess=new fa("SSAOOriginalSceneColor",o,null,U.BILINEAR_SAMPLINGMODE,t.getEngine(),!1),this._createSSAOPostProcess(n),this._createBlurPostProcess(n),this._createSSAOCombinePostProcess(o),this.addEffect(new Ut(t.getEngine(),this.SSAOOriginalSceneColorEffect,()=>this._originalColorPostProcess,!0)),this.addEffect(new Ut(t.getEngine(),this.SSAORenderEffect,()=>this._ssaoPostProcess,!0)),this.addEffect(new Ut(t.getEngine(),this.SSAOBlurHRenderEffect,()=>this._blurHPostProcess,!0)),this.addEffect(new Ut(t.getEngine(),this.SSAOBlurVRenderEffect,()=>this._blurVPostProcess,!0)),this.addEffect(new Ut(t.getEngine(),this.SSAOCombineRenderEffect,()=>this._ssaoCombinePostProcess,!0)),t.postProcessRenderPipelineManager.addPipeline(this),s&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,s)}_attachCameras(e,t){super._attachCameras(e,t);for(const i of this._cameras)this._scene.enableDepthRenderer(i).getDepthMap()}getClassName(){return"SSAORenderingPipeline"}dispose(e=!1){for(let t=0;t<this._scene.cameras.length;t++){const i=this._scene.cameras[t];this._originalColorPostProcess.dispose(i),this._ssaoPostProcess.dispose(i),this._blurHPostProcess.dispose(i),this._blurVPostProcess.dispose(i),this._ssaoCombinePostProcess.dispose(i)}this._randomTexture.dispose(),e&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_createBlurPostProcess(e){this._blurHPostProcess=new _s("BlurH",new de(1,0),16,e,null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new _s("BlurV",new de(0,1),16,e,null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add(()=>{const i=this._blurHPostProcess.width/this._scene.getEngine().getRenderWidth();this._blurHPostProcess.kernel=16*i}),this._blurVPostProcess.onActivateObservable.add(()=>{const i=this._blurVPostProcess.height/this._scene.getEngine().getRenderHeight();this._blurVPostProcess.kernel=16*i})}_rebuild(){this._firstUpdate=!0,super._rebuild()}_createSSAOPostProcess(e){const i=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271];this._ssaoPostProcess=new Pe("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES 16\n#define SSAO"),this._ssaoPostProcess.externalTextureSamplerBinding=!0,this._ssaoPostProcess.onApply=n=>{this._firstUpdate&&(n.setArray3("sampleSphere",i),n.setFloat("samplesFactor",.0625),n.setFloat("randTextureTiles",4)),n.setFloat("totalStrength",this.totalStrength),n.setFloat("radius",this.radius),n.setFloat("area",this.area),n.setFloat("fallOff",this.fallOff),n.setFloat("base",this.base),n.setTexture("textureSampler",this._scene.enableDepthRenderer(this._scene.activeCamera).getDepthMap()),n.setTexture("randomSampler",this._randomTexture)}}_createSSAOCombinePostProcess(e){this._ssaoCombinePostProcess=new Pe("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,U.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=t=>{t.setVector4("viewport",L.Vector4[0].copyFromFloats(0,0,1,1)),t.setTextureFromPostProcess("originalColor",this._originalColorPostProcess)}}_createRandomTexture(){this._randomTexture=new ic("SSAORandomTexture",512,this._scene,!1,U.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=U.WRAP_ADDRESSMODE,this._randomTexture.wrapV=U.WRAP_ADDRESSMODE;const t=this._randomTexture.getContext(),i=(n,o)=>Math.random()*(o-n)+n,s=v.Zero();for(let n=0;n<512;n++)for(let o=0;o<512;o++)s.x=Math.floor(255*Math.max(0,i(-1,1))),s.y=Math.floor(255*Math.max(0,i(-1,1))),s.z=Math.floor(255*Math.max(0,i(-1,1))),t.fillStyle="rgb("+s.x+", "+s.y+", "+s.z+")",t.fillRect(n,o,1,1);this._randomTexture.update(!1)}}E([I()],Qp.prototype,"totalStrength",void 0),E([I()],Qp.prototype,"radius",void 0),E([I()],Qp.prototype,"area",void 0),E([I()],Qp.prototype,"fallOff",void 0),E([I()],Qp.prototype,"base",void 0);class mle{constructor(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}}j.ShadersStore.screenSpaceReflectionPixelShader="uniform sampler2D textureSampler;\n#ifdef SSR_SUPPORTED\nuniform sampler2D reflectivitySampler;\nuniform sampler2D normalSampler;\nuniform sampler2D positionSampler;\n#endif\nuniform mat4 view;\nuniform mat4 projection;\nuniform float stepSize;\nuniform float strength;\nuniform float threshold;\nuniform float roughnessFactor;\nuniform float reflectionSpecularFalloffExponent;\nvarying vec2 vUV;\n#ifdef SSR_SUPPORTED\nstruct ReflectionInfo {\nvec3 color;\nvec4 coords;\n};\n/**\n* According to specular,see https:\n*/\nvec3 fresnelSchlick(float cosTheta,vec3 F0)\n{\nreturn F0+(1.0-F0)*pow(1.0-cosTheta,5.0);\n}\n/**\n* Once the pixel's coordinates has been found,let's adjust (smooth) a little bit\n* by sampling multiple reflection pixels.\n*/\nReflectionInfo smoothReflectionInfo(vec3 dir,vec3 hitCoord)\n{\nReflectionInfo info;\ninfo.color=vec3(0.0);\nvec4 projectedCoord;\nfloat sampledDepth;\nfor(int i=0; i<SMOOTH_STEPS; i++)\n{\nprojectedCoord=projection*vec4(hitCoord,1.0);\nprojectedCoord.xy/=projectedCoord.w;\nprojectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);\nsampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;\nfloat depth=sampledDepth-hitCoord.z;\ndir*=0.5;\nif(depth>0.0)\nhitCoord-=dir;\nelse\nhitCoord+=dir;\ninfo.color+=texture2D(textureSampler,projectedCoord.xy).rgb;\n}\nprojectedCoord=projection*vec4(hitCoord,1.0);\nprojectedCoord.xy/=projectedCoord.w;\nprojectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);\ninfo.coords=vec4(projectedCoord.xy,sampledDepth,1.0);\ninfo.color+=texture2D(textureSampler,projectedCoord.xy).rgb;\ninfo.color/=float(SMOOTH_STEPS+1);\nreturn info;\n}\n/**\n* Tests the given world position (hitCoord) according to the given reflection vector (dir)\n* until it finds a collision (means that depth is enough close to say \"it's the pixel to sample!\").\n*/\nReflectionInfo getReflectionInfo(vec3 dir,vec3 hitCoord)\n{\nReflectionInfo info;\nvec4 projectedCoord;\nfloat sampledDepth;\ndir*=stepSize;\nfor(int i=0; i<REFLECTION_SAMPLES; i++)\n{\nhitCoord+=dir;\nprojectedCoord=projection*vec4(hitCoord,1.0);\nprojectedCoord.xy/=projectedCoord.w;\nprojectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);\nsampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;\nfloat depth=sampledDepth-hitCoord.z;\n#ifdef RIGHT_HANDED_SCENE\ndepth*=-1.0;\n#endif\nif(((depth-dir.z)<threshold) && depth<=0.0)\n{\n#ifdef ENABLE_SMOOTH_REFLECTIONS\nreturn smoothReflectionInfo(dir,hitCoord);\n#else\ninfo.color=texture2D(textureSampler,projectedCoord.xy).rgb;\ninfo.coords=vec4(projectedCoord.xy,sampledDepth,0.0);\nreturn info;\n#endif\n}\n}\ninfo.color=texture2D(textureSampler,projectedCoord.xy).rgb;\ninfo.coords=vec4(projectedCoord.xy,sampledDepth,0.0);\nreturn info;\n}\nvec3 hash(vec3 a)\n{\na=fract(a*0.8);\na+=dot(a,a.yxz+19.19);\nreturn fract((a.xxy+a.yxx)*a.zyx);\n}\n#endif\nvoid main()\n{\n#ifdef SSR_SUPPORTED\nvec4 albedoFull=texture2D(textureSampler,vUV);\nvec3 albedo=albedoFull.rgb;\nfloat spec=texture2D(reflectivitySampler,vUV).r;\nif (spec==0.0) {\ngl_FragColor=albedoFull;\nreturn;\n}\nvec3 normal=(texture2D(normalSampler,vUV)).xyz;\nvec3 position=(view*texture2D(positionSampler,vUV)).xyz;\nvec3 reflected=normalize(reflect(normalize(position),normalize(normal)));\nfloat roughness=1.0-texture2D(reflectivitySampler,vUV).a;\nvec3 jitt=mix(vec3(0.0),hash(position),roughness)*roughnessFactor;\nReflectionInfo info=getReflectionInfo(jitt+reflected,position);\nvec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-info.coords.xy));\nfloat screenEdgefactor=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);\nvec3 F0=vec3(0.04);\nF0 =mix(F0,albedo,spec);\nvec3 fresnel=fresnelSchlick(max(dot(normalize(normal),normalize(position)),0.0),F0);\n#ifdef RIGHT_HANDED_SCENE\nreflected.z*=-1.0;\n#endif\nfloat reflectionMultiplier=clamp(pow(spec*strength,reflectionSpecularFalloffExponent)*screenEdgefactor*reflected.z,0.0,0.9);\nfloat albedoMultiplier=1.0-reflectionMultiplier;\nvec3 SSR=info.color*fresnel;\ngl_FragColor=vec4((albedo*albedoMultiplier)+(SSR*reflectionMultiplier),albedoFull.a);\n#else\ngl_FragColor=texture2D(textureSampler,vUV);\n#endif\n}\n";class mo extends Pe{get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"ScreenSpaceReflectionPostProcess"}constructor(e,t,i,s,n,o,a,l=0,c=!1,h=!1){if(super(e,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","stepSize","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],i,s,n,o,a,"#define SSR_SUPPORTED\n#define REFLECTION_SAMPLES 64\n#define SMOOTH_STEPS 5\n",l,void 0,null,c),this.threshold=1.2,this.strength=1,this.reflectionSpecularFalloffExponent=3,this.step=1,this.roughnessFactor=.2,this._forceGeometryBuffer=!1,this._enableSmoothReflections=!1,this._reflectionSamples=64,this._smoothSteps=5,this._forceGeometryBuffer=h,this._forceGeometryBuffer){const u=t.enableGeometryBufferRenderer();u&&u.isSupported&&(u.enablePosition=!0,u.enableReflectivity=!0)}else t.enablePrePassRenderer()?.markAsDirty(),this._prePassEffectConfiguration=new mle;this._updateEffectDefines(),this.onApply=u=>{const d=this._geometryBufferRenderer,f=this._prePassRenderer;if(!f&&!d)return;if(d){const g=d.getTextureIndex(Zn.POSITION_TEXTURE_TYPE),b=d.getTextureIndex(Zn.REFLECTIVITY_TEXTURE_TYPE);u.setTexture("normalSampler",d.getGBuffer().textures[1]),u.setTexture("positionSampler",d.getGBuffer().textures[g]),u.setTexture("reflectivitySampler",d.getGBuffer().textures[b])}else if(f){const g=f.getIndex(1),b=f.getIndex(3),y=f.getIndex(6);u.setTexture("normalSampler",f.getRenderTarget().textures[y]),u.setTexture("positionSampler",f.getRenderTarget().textures[g]),u.setTexture("reflectivitySampler",f.getRenderTarget().textures[b])}const p=t.activeCamera;if(!p)return;const _=p.getViewMatrix(!0),m=p.getProjectionMatrix(!0);u.setMatrix("projection",m),u.setMatrix("view",_),u.setFloat("threshold",this.threshold),u.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),u.setFloat("strength",this.strength),u.setFloat("stepSize",this.step),u.setFloat("roughnessFactor",this.roughnessFactor)},this._isSceneRightHanded=t.useRightHandedSystem}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get reflectionSamples(){return this._reflectionSamples}set reflectionSamples(e){e!==this._reflectionSamples&&(this._reflectionSamples=e,this._updateEffectDefines())}get smoothSteps(){return this._smoothSteps}set smoothSteps(e){e!==this._smoothSteps&&(this._smoothSteps=e,this._updateEffectDefines())}_updateEffectDefines(){const e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define ENABLE_SMOOTH_REFLECTIONS"),this._isSceneRightHanded&&e.push("#define RIGHT_HANDED_SCENE"),e.push("#define REFLECTION_SAMPLES "+(this._reflectionSamples>>0)),e.push("#define SMOOTH_STEPS "+(this._smoothSteps>>0)),this.updateEffect(e.join("\n"))}static _Parse(e,t,i,s){return Ce.Parse(()=>new mo(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,s)}}E([I()],mo.prototype,"threshold",void 0),E([I()],mo.prototype,"strength",void 0),E([I()],mo.prototype,"reflectionSpecularFalloffExponent",void 0),E([I()],mo.prototype,"step",void 0),E([I()],mo.prototype,"roughnessFactor",void 0),E([I()],mo.prototype,"enableSmoothReflections",null),E([I()],mo.prototype,"reflectionSamples",null),E([I()],mo.prototype,"smoothSteps",null),le("BABYLON.ScreenSpaceReflectionPostProcess",mo);j.ShadersStore.standardPixelShader="uniform sampler2D textureSampler;\nvarying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#if defined(PASS_POST_PROCESS)\nvoid main(void)\n{\nvec4 color=texture2D(textureSampler,vUV);\ngl_FragColor=color;\n}\n#endif\n#if defined(DOWN_SAMPLE_X4)\nuniform vec2 dsOffsets[16];\nvoid main(void)\n{\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+dsOffsets[0]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[1]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[2]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[3]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[4]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[5]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[6]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[7]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[8]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[9]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[10]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[11]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[12]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[13]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[14]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[15]);\naverage/=16.0;\ngl_FragColor=average;\n}\n#endif\n#if defined(BRIGHT_PASS)\nuniform vec2 dsOffsets[4];\nuniform float brightThreshold;\nvoid main(void)\n{\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));\naverage*=0.25;\nfloat luminance=length(average.rgb);\nif (luminance<brightThreshold) {\naverage=vec4(0.0,0.0,0.0,1.0);\n}\ngl_FragColor=average;\n}\n#endif\n#if defined(TEXTURE_ADDER)\nuniform sampler2D otherSampler;\nuniform sampler2D lensSampler;\nuniform float exposure;\nvoid main(void)\n{\nvec3 colour=texture2D(textureSampler,vUV).rgb;\ncolour*=exposure;\nvec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);\nvec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);\ncolour=retColor*retColor;\ncolour+=colour*texture2D(lensSampler,vUV).rgb;\nvec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);\ngl_FragColor=finalColor;\n}\n#endif\n#if defined(VLS)\n#define PI 3.1415926535897932384626433832795\nuniform mat4 shadowViewProjection;\nuniform mat4 lightWorld;\nuniform vec3 cameraPosition;\nuniform vec3 sunDirection;\nuniform vec3 sunColor;\nuniform vec2 depthValues;\nuniform float scatteringCoefficient;\nuniform float scatteringPower;\nuniform sampler2D shadowMapSampler;\nuniform sampler2D positionSampler;\nfloat computeScattering(float lightDotView)\n{\nfloat result=1.0-scatteringCoefficient*scatteringCoefficient;\nresult/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));\nreturn result;\n}\nvoid main(void)\n{\nvec3 worldPos=texture2D(positionSampler,vUV).rgb;\nvec3 startPosition=cameraPosition;\nvec3 rayVector=worldPos-startPosition;\nfloat rayLength=length(rayVector);\nvec3 rayDirection=rayVector/rayLength;\nfloat stepLength=rayLength/NB_STEPS;\nvec3 stepL=rayDirection*stepLength;\nvec3 currentPosition=startPosition;\nvec3 accumFog=vec3(0.0);\nfor (int i=0; i<int(NB_STEPS); i++)\n{\nvec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);\nfloat depthMetric= (worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depthMetric,0.0,1.0);\nworldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;\nworldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);\nfloat shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;\nif (shadowMapValue>shadowPixelDepth)\naccumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));\ncurrentPosition+=stepL;\n}\naccumFog/=NB_STEPS;\nvec3 color=accumFog*scatteringPower;\ngl_FragColor=vec4(color*exp(color) ,1.0);\n}\n#endif\n#if defined(VLSMERGE)\nuniform sampler2D originalSampler;\nvoid main(void)\n{\ngl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);\n}\n#endif\n#if defined(LUMINANCE)\nuniform vec2 lumOffsets[4];\nvoid main()\n{\nfloat average=0.0;\nvec4 color=vec4(0.0);\nfloat maximum=-1e20;\nvec3 weight=vec3(0.299,0.587,0.114);\nfor (int i=0; i<4; i++)\n{\ncolor=texture2D(textureSampler,vUV+ lumOffsets[i]);\nfloat GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));\n#ifdef WEIGHTED_AVERAGE\nfloat GreyValue=dot(color.rgb,weight);\n#endif\n#ifdef BRIGHTNESS\nfloat GreyValue=max(color.r,max(color.g,color.b));\n#endif\n#ifdef HSL_COMPONENT\nfloat GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));\n#endif\n#ifdef MAGNITUDE\nfloat GreyValue=length(color.rgb);\n#endif\nmaximum=max(maximum,GreyValue);\naverage+=(0.25*log(1e-5+GreyValue));\n}\naverage=exp(average);\ngl_FragColor=vec4(average,maximum,0.0,1.0);\n}\n#endif\n#if defined(LUMINANCE_DOWN_SAMPLE)\nuniform vec2 dsOffsets[9];\nuniform float halfDestPixelSize;\n#ifdef FINAL_DOWN_SAMPLER\n#include<packingFunctions>\n#endif\nvoid main()\n{\nvec4 color=vec4(0.0);\nfloat average=0.0;\nfor (int i=0; i<9; i++)\n{\ncolor=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);\naverage+=color.r;\n}\naverage/=9.0;\n#ifdef FINAL_DOWN_SAMPLER\ngl_FragColor=pack(average);\n#else\ngl_FragColor=vec4(average,average,0.0,1.0);\n#endif\n}\n#endif\n#if defined(HDR)\nuniform sampler2D textureAdderSampler;\nuniform float averageLuminance;\nvoid main()\n{\nvec4 color=texture2D(textureAdderSampler,vUV);\n#ifndef AUTO_EXPOSURE\nvec4 adjustedColor=color/averageLuminance;\ncolor=adjustedColor;\ncolor.a=1.0;\n#endif\ngl_FragColor=color;\n}\n#endif\n#if defined(LENS_FLARE)\n#define GHOSTS 3\nuniform sampler2D lensColorSampler;\nuniform float strength;\nuniform float ghostDispersal;\nuniform float haloWidth;\nuniform vec2 resolution;\nuniform float distortionStrength;\nfloat hash(vec2 p)\n{\nfloat h=dot(p,vec2(127.1,311.7));\nreturn -1.0+2.0*fract(sin(h)*43758.5453123);\n}\nfloat noise(in vec2 p)\n{\nvec2 i=floor(p);\nvec2 f=fract(p);\nvec2 u=f*f*(3.0-2.0*f);\nreturn mix(mix(hash(i+vec2(0.0,0.0)),\nhash(i+vec2(1.0,0.0)),u.x),\nmix(hash(i+vec2(0.0,1.0)),\nhash(i+vec2(1.0,1.0)),u.x),u.y);\n}\nfloat fbm(vec2 p)\n{\nfloat f=0.0;\nf+=0.5000*noise(p); p*=2.02;\nf+=0.2500*noise(p); p*=2.03;\nf+=0.1250*noise(p); p*=2.01;\nf+=0.0625*noise(p); p*=2.04;\nf/=0.9375;\nreturn f;\n}\nvec3 pattern(vec2 uv)\n{\nvec2 p=-1.0+2.0*uv;\nfloat p2=dot(p,p);\nfloat f=fbm(vec2(15.0*p2))/2.0;\nfloat r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));\nfloat g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));\nfloat b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));\nreturn (1.0-f)*vec3(r,g,b);\n}\nfloat luminance(vec3 color)\n{\nreturn dot(color.rgb,vec3(0.2126,0.7152,0.0722));\n}\nvec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)\n{\nreturn vec4(\ntexture2D(tex,texcoord+direction*distortion.r).r,\ntexture2D(tex,texcoord+direction*distortion.g).g,\ntexture2D(tex,texcoord+direction*distortion.b).b,\n1.0\n);\n}\nvoid main(void)\n{\nvec2 uv=-vUV+vec2(1.0);\nvec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;\nvec2 texelSize=1.0/resolution;\nvec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);\nvec4 result=vec4(0.0);\nfloat ghostIndice=1.0;\nfor (int i=0; i<GHOSTS; ++i)\n{\nvec2 offset=fract(uv+ghostDir*ghostIndice);\nfloat weight=length(vec2(0.5)-offset)/length(vec2(0.5));\nweight=pow(1.0-weight,10.0);\nresult+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;\nghostIndice+=1.0;\n}\nvec2 haloVec=normalize(ghostDir)*haloWidth;\nfloat weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));\nweight=pow(1.0-weight,10.0);\nresult+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;\nresult*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));\ngl_FragColor=result;\n}\n#endif\n#if defined(LENS_FLARE_COMPOSE)\nuniform sampler2D otherSampler;\nuniform sampler2D lensDirtSampler;\nuniform sampler2D lensStarSampler;\nuniform mat4 lensStarMatrix;\nvoid main(void)\n{\nvec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;\nvec4 lensMod=texture2D(lensDirtSampler,vUV);\nlensMod+=texture2D(lensStarSampler,vUV/*lensFlareCoords*/);\nvec4 result=texture2D(textureSampler,vUV)*lensMod;\ngl_FragColor=texture2D(otherSampler,vUV)+result;\n}\n#endif\n#if defined(DEPTH_OF_FIELD)\nuniform sampler2D otherSampler;\nuniform sampler2D depthSampler;\nuniform float distance;\nvoid main(void)\n{\nvec4 sharp=texture2D(otherSampler,vUV);\nvec4 blur=texture2D(textureSampler,vUV);\nfloat dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);\nfloat factor=0.0;\nif (dist<0.05)\nfactor=1.0;\nelse if (dist<0.1)\nfactor=20.0*(0.1-dist);\nelse if (dist<0.5)\nfactor=0.0;\nelse\nfactor=2.0*(dist-0.5);\nfactor=clamp(factor,0.0,0.90);\ngl_FragColor=mix(sharp,blur,factor);\n}\n#endif\n#if defined(MOTION_BLUR)\nuniform mat4 inverseViewProjection;\nuniform mat4 prevViewProjection;\nuniform vec2 screenSize;\nuniform float motionScale;\nuniform float motionStrength;\nuniform sampler2D depthSampler;\nvoid main(void)\n{\nvec2 texelSize=1.0/screenSize;\nfloat depth=texture2D(depthSampler,vUV).r;\nvec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);\ncpos=cpos*inverseViewProjection;\nvec4 ppos=cpos*prevViewProjection;\nppos.xyz/=ppos.w;\nppos.xy=ppos.xy*0.5+0.5;\nvec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;\nfloat speed=length(velocity/texelSize);\nint nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));\nvec4 result=texture2D(textureSampler,vUV);\nfor (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {\nif (i>=nSamples)\nbreak;\nvec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);\nresult+=texture2D(textureSampler,offset1);\n}\ngl_FragColor=result/float(nSamples);\n}\n#endif\n";class Ft extends Td{get exposure(){return this._fixedExposure}set exposure(e){this._fixedExposure=e,this._currentExposure=e}get hdrAutoExposure(){return this._hdrAutoExposure}set hdrAutoExposure(e){if(this._hdrAutoExposure=e,this.hdrPostProcess){const t=["#define HDR"];e&&t.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(t.join("\n"))}}get motionStrength(){return this._motionStrength}set motionStrength(e){this._motionStrength=e,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=e)}get objectBasedMotionBlur(){return this._isObjectBasedMotionBlur}set objectBasedMotionBlur(e){const t=this._isObjectBasedMotionBlur!==e;this._isObjectBasedMotionBlur=e,t&&this._buildPipeline()}get BloomEnabled(){return this._bloomEnabled}set BloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get DepthOfFieldEnabled(){return this._depthOfFieldEnabled}set DepthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get LensFlareEnabled(){return this._lensFlareEnabled}set LensFlareEnabled(e){this._lensFlareEnabled!==e&&(this._lensFlareEnabled=e,this._buildPipeline())}get HDREnabled(){return this._hdrEnabled}set HDREnabled(e){this._hdrEnabled!==e&&(this._hdrEnabled=e,this._buildPipeline())}get VLSEnabled(){return this._vlsEnabled}set VLSEnabled(e){if(this._vlsEnabled!==e){if(e&&!this._scene.enableGeometryBufferRenderer())return void V.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");this._vlsEnabled=e,this._buildPipeline()}}get MotionBlurEnabled(){return this._motionBlurEnabled}set MotionBlurEnabled(e){this._motionBlurEnabled!==e&&(this._motionBlurEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get screenSpaceReflectionsEnabled(){return this._screenSpaceReflectionsEnabled}set screenSpaceReflectionsEnabled(e){this._screenSpaceReflectionsEnabled!==e&&(this._screenSpaceReflectionsEnabled=e,this._buildPipeline())}get volumetricLightStepsCount(){return this._volumetricLightStepsCount}set volumetricLightStepsCount(e){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect("#define VLS\n#define NB_STEPS "+e.toFixed(1)),this._volumetricLightStepsCount=e}get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=e:this.motionBlurPostProcess.updateEffect("#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+e.toFixed(1))),this._motionBlurSamples=e}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}constructor(e,t,i,s=null,n){super(t.getEngine(),e),this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.blurHPostProcesses=[],this.blurVPostProcesses=[],this.textureAdderPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.luminancePostProcess=null,this.luminanceDownSamplePostProcesses=[],this.hdrPostProcess=null,this.textureAdderFinalPostProcess=null,this.lensFlareFinalPostProcess=null,this.hdrFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.motionBlurPostProcess=null,this.depthOfFieldPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.brightThreshold=1,this.blurWidth=512,this.horizontalBlur=!1,this.lensTexture=null,this.volumetricLightCoefficient=.2,this.volumetricLightPower=4,this.volumetricLightBlurScale=64,this.sourceLight=null,this.hdrMinimumLuminance=1,this.hdrDecreaseRate=.5,this.hdrIncreaseRate=.5,this.lensColorTexture=null,this.lensFlareStrength=20,this.lensFlareGhostDispersal=1.4,this.lensFlareHaloWidth=.7,this.lensFlareDistortionStrength=16,this.lensFlareBlurWidth=512,this.lensStarTexture=null,this.lensFlareDirtTexture=null,this.depthOfFieldDistance=10,this.depthOfFieldBlurWidth=64,this.animations=[],this._currentDepthOfFieldSource=null,this._fixedExposure=1,this._currentExposure=1,this._hdrAutoExposure=!1,this._hdrCurrentLuminance=1,this._motionStrength=1,this._isObjectBasedMotionBlur=!1,this._camerasToBeAttached=[],this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._vlsEnabled=!1,this._lensFlareEnabled=!1,this._hdrEnabled=!1,this._motionBlurEnabled=!1,this._fxaaEnabled=!1,this._screenSpaceReflectionsEnabled=!1,this._motionBlurSamples=64,this._volumetricLightStepsCount=50,this._samples=1,this._cameras=n||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._basePostProcess=s,this._ratio=i,this._floatTextureType=t.getEngine().getCaps().textureFloatRender?1:2,t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline()}_buildPipeline(){const e=this._ratio,t=this._scene;this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new mo("HDRPass",t,e,null,U.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add(()=>{this._currentDepthOfFieldSource=this.screenSpaceReflectionPostProcess}),this.addEffect(new Ut(t.getEngine(),"HDRScreenSpaceReflections",()=>this.screenSpaceReflectionPostProcess,!0))),this.originalPostProcess=this._basePostProcess?this._basePostProcess:new Pe("HDRPass","standard",[],[],e,null,U.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add(()=>{this._currentDepthOfFieldSource=this.originalPostProcess}),this.addEffect(new Ut(t.getEngine(),"HDRPassPostProcess",()=>this.originalPostProcess,!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(t,e/4),this._createBrightPassPostProcess(t,e/4),this._createBlurPostProcesses(t,e/4,1),this._createTextureAdderPostProcess(t,e),this.textureAdderFinalPostProcess=new Pe("HDRDepthOfFieldSource","standard",[],[],e,null,U.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Ut(t.getEngine(),"HDRBaseDepthOfFieldSource",()=>this.textureAdderFinalPostProcess,!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(t,e),this.volumetricLightFinalPostProcess=new Pe("HDRVLSFinal","standard",[],[],e,null,U.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Ut(t.getEngine(),"HDRVLSFinal",()=>this.volumetricLightFinalPostProcess,!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(t,e),this.lensFlareFinalPostProcess=new Pe("HDRPostLensFlareDepthOfFieldSource","standard",[],[],e,null,U.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Ut(t.getEngine(),"HDRPostLensFlareDepthOfFieldSource",()=>this.lensFlareFinalPostProcess,!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(t,this._floatTextureType),this._createHdrPostProcess(t,e),this.hdrFinalPostProcess=new Pe("HDRPostHDReDepthOfFieldSource","standard",[],[],e,null,U.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Ut(t.getEngine(),"HDRPostHDReDepthOfFieldSource",()=>this.hdrFinalPostProcess,!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(t,e/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(t,e)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(t,e),this._fxaaEnabled&&(this.fxaaPostProcess=new bd("fxaa",1,null,U.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,0),this.addEffect(new Ut(t.getEngine(),"HDRFxaa",()=>this.fxaaPostProcess,!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&V.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}_createDownSampleX4PostProcess(e,t){const i=new Array(32);this.downSampleX4PostProcess=new Pe("HDRDownSampleX4","standard",["dsOffsets"],[],t,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=s=>{let n=0;const o=this.downSampleX4PostProcess.width,a=this.downSampleX4PostProcess.height;for(let l=-2;l<2;l++)for(let c=-2;c<2;c++)i[n]=(l+.5)*(1/o),i[n+1]=(c+.5)*(1/a),n+=2;s.setArray2("dsOffsets",i)},this.addEffect(new Ut(e.getEngine(),"HDRDownSampleX4",()=>this.downSampleX4PostProcess,!0))}_createBrightPassPostProcess(e,t){const i=new Array(8);this.brightPassPostProcess=new Pe("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],t,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=s=>{const n=1/this.brightPassPostProcess.width,o=1/this.brightPassPostProcess.height;i[0]=-.5*n,i[1]=.5*o,i[2]=.5*n,i[3]=.5*o,i[4]=-.5*n,i[5]=-.5*o,i[6]=.5*n,i[7]=-.5*o,s.setArray2("dsOffsets",i),s.setFloat("brightThreshold",this.brightThreshold)},this.addEffect(new Ut(e.getEngine(),"HDRBrightPass",()=>this.brightPassPostProcess,!0))}_createBlurPostProcesses(e,t,i,s="blurWidth"){const n=e.getEngine(),o=new _s("HDRBlurH_"+i,new de(1,0),this[s],t,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType),a=new _s("HDRBlurV_"+i,new de(0,1),this[s],t,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType);o.onActivateObservable.add(()=>{const l=o.width/n.getRenderWidth();o.kernel=this[s]*l}),a.onActivateObservable.add(()=>{const l=a.height/n.getRenderHeight();a.kernel=this.horizontalBlur?64*l:this[s]*l}),this.addEffect(new Ut(e.getEngine(),"HDRBlurH"+i,()=>o,!0)),this.addEffect(new Ut(e.getEngine(),"HDRBlurV"+i,()=>a,!0)),this.blurHPostProcesses.push(o),this.blurVPostProcesses.push(a)}_createTextureAdderPostProcess(e,t){this.textureAdderPostProcess=new Pe("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],t,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=i=>{i.setTextureFromPostProcess("otherSampler",this._vlsEnabled?this._currentDepthOfFieldSource:this.originalPostProcess),i.setTexture("lensSampler",this.lensTexture),i.setFloat("exposure",this._currentExposure),this._currentDepthOfFieldSource=this.textureAdderFinalPostProcess},this.addEffect(new Ut(e.getEngine(),"HDRTextureAdder",()=>this.textureAdderPostProcess,!0))}_createVolumetricLightPostProcess(e,t){const i=e.enableGeometryBufferRenderer();i.enablePosition=!0;const s=i.getGBuffer();this.volumetricLightPostProcess=new Pe("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],t/8,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLS\n#define NB_STEPS "+this._volumetricLightStepsCount.toFixed(1));const n=de.Zero();this.volumetricLightPostProcess.onApply=o=>{if(this.sourceLight&&this.sourceLight.getShadowGenerator()&&this._scene.activeCamera){const a=this.sourceLight.getShadowGenerator();o.setTexture("shadowMapSampler",a.getShadowMap()),o.setTexture("positionSampler",s.textures[2]),o.setColor3("sunColor",this.sourceLight.diffuse),o.setVector3("sunDirection",this.sourceLight.getShadowDirection()),o.setVector3("cameraPosition",this._scene.activeCamera.globalPosition),o.setMatrix("shadowViewProjection",a.getTransformMatrix()),o.setFloat("scatteringCoefficient",this.volumetricLightCoefficient),o.setFloat("scatteringPower",this.volumetricLightPower),n.x=this.sourceLight.getDepthMinZ(this._scene.activeCamera),n.y=this.sourceLight.getDepthMaxZ(this._scene.activeCamera),o.setVector2("depthValues",n)}},this.addEffect(new Ut(e.getEngine(),"HDRVLS",()=>this.volumetricLightPostProcess,!0)),this._createBlurPostProcesses(e,t/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new Pe("HDRVLSMerge","standard",[],["originalSampler"],t,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=o=>{o.setTextureFromPostProcess("originalSampler",this._bloomEnabled?this.textureAdderFinalPostProcess:this.originalPostProcess),this._currentDepthOfFieldSource=this.volumetricLightFinalPostProcess},this.addEffect(new Ut(e.getEngine(),"HDRVLSMerge",()=>this.volumetricLightMergePostProces,!0))}_createLuminancePostProcesses(e,t){let i=Math.pow(3,Ft.LuminanceSteps);this.luminancePostProcess=new Pe("HDRLuminance","standard",["lumOffsets"],[],{width:i,height:i},null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE",t);const s=[];this.luminancePostProcess.onApply=o=>{const a=1/this.luminancePostProcess.width,l=1/this.luminancePostProcess.height;s[0]=-.5*a,s[1]=.5*l,s[2]=.5*a,s[3]=.5*l,s[4]=-.5*a,s[5]=-.5*l,s[6]=.5*a,s[7]=-.5*l,o.setArray2("lumOffsets",s)},this.addEffect(new Ut(e.getEngine(),"HDRLuminance",()=>this.luminancePostProcess,!0));for(let o=Ft.LuminanceSteps-1;o>=0;o--){i=Math.pow(3,o);let a="#define LUMINANCE_DOWN_SAMPLE\n";0===o&&(a+="#define FINAL_DOWN_SAMPLER");const l=new Pe("HDRLuminanceDownSample"+o,"standard",["dsOffsets","halfDestPixelSize"],[],{width:i,height:i},null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,a,t);this.luminanceDownSamplePostProcesses.push(l)}let n=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach((o,a)=>{const l=new Array(18);o.onApply=c=>{if(!n)return;let h=0;for(let u=-1;u<2;u++)for(let d=-1;d<2;d++)l[h]=u/n.width,l[h+1]=d/n.height,h+=2;c.setArray2("dsOffsets",l),c.setFloat("halfDestPixelSize",.5/n.width),n=a===this.luminanceDownSamplePostProcesses.length-1?this.luminancePostProcess:o},a===this.luminanceDownSamplePostProcesses.length-1&&(o.onAfterRender=()=>{const c=e.getEngine().readPixels(0,0,1,1),h=new vt(1/16581375,1/65025,1/255,1);c.then(u=>{const d=new Uint8Array(u.buffer);this._hdrCurrentLuminance=(d[0]*h.x+d[1]*h.y+d[2]*h.z+d[3]*h.w)/100})}),this.addEffect(new Ut(e.getEngine(),"HDRLuminanceDownSample"+a,()=>o,!0))})}_createHdrPostProcess(e,t){const i=["#define HDR"];this._hdrAutoExposure&&i.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new Pe("HDR","standard",["averageLuminance"],["textureAdderSampler"],t,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,i.join("\n"),0);let s=1,n=0,o=0;this.hdrPostProcess.onApply=a=>{if(a.setTextureFromPostProcess("textureAdderSampler",this._currentDepthOfFieldSource),n+=e.getEngine().getDeltaTime(),s<0)s=this._hdrCurrentLuminance;else{const l=(o-n)/1e3;this._hdrCurrentLuminance<s+this.hdrDecreaseRate*l?s+=this.hdrDecreaseRate*l:this._hdrCurrentLuminance>s-this.hdrIncreaseRate*l?s-=this.hdrIncreaseRate*l:s=this._hdrCurrentLuminance}this.hdrAutoExposure?this._currentExposure=this._fixedExposure/s:(s=oe.Clamp(s,this.hdrMinimumLuminance,1e20),a.setFloat("averageLuminance",s)),o=n,this._currentDepthOfFieldSource=this.hdrFinalPostProcess},this.addEffect(new Ut(e.getEngine(),"HDR",()=>this.hdrPostProcess,!0))}_createLensFlarePostProcess(e,t){this.lensFlarePostProcess=new Pe("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],t/2,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new Ut(e.getEngine(),"HDRLensFlare",()=>this.lensFlarePostProcess,!0)),this._createBlurPostProcesses(e,t/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new Pe("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],t,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new Ut(e.getEngine(),"HDRLensFlareCompose",()=>this.lensFlareComposePostProcess,!0));const i=new de(0,0);this.lensFlarePostProcess.externalTextureSamplerBinding=!0,this.lensFlarePostProcess.onApply=o=>{o.setTextureFromPostProcess("textureSampler",this._bloomEnabled?this.blurHPostProcesses[0]:this.originalPostProcess),o.setTexture("lensColorSampler",this.lensColorTexture),o.setFloat("strength",this.lensFlareStrength),o.setFloat("ghostDispersal",this.lensFlareGhostDispersal),o.setFloat("haloWidth",this.lensFlareHaloWidth),i.x=this.lensFlarePostProcess.width,i.y=this.lensFlarePostProcess.height,o.setVector2("resolution",i),o.setFloat("distortionStrength",this.lensFlareDistortionStrength)};const s=F.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),n=F.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=o=>{if(!this._scene.activeCamera)return;o.setTextureFromPostProcess("otherSampler",this.lensFlarePostProcess),o.setTexture("lensDirtSampler",this.lensFlareDirtTexture),o.setTexture("lensStarSampler",this.lensStarTexture);const a=this._scene.activeCamera.getViewMatrix().getRow(0),l=this._scene.activeCamera.getViewMatrix().getRow(2);let c=v.Dot(a.toVector3(),new v(1,0,0))+v.Dot(l.toVector3(),new v(0,0,1));c*=4;const h=F.FromValues(.5*Math.cos(c),-Math.sin(c),0,0,Math.sin(c),.5*Math.cos(c),0,0,0,0,1,0,0,0,0,1),u=n.multiply(h).multiply(s);o.setMatrix("lensStarMatrix",u),this._currentDepthOfFieldSource=this.lensFlareFinalPostProcess}}_createDepthOfFieldPostProcess(e,t){this.depthOfFieldPostProcess=new Pe("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],t,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=i=>{i.setTextureFromPostProcess("otherSampler",this._currentDepthOfFieldSource),i.setTexture("depthSampler",this._getDepthTexture()),i.setFloat("distance",this.depthOfFieldDistance)},this.addEffect(new Ut(e.getEngine(),"HDRDepthOfField",()=>this.depthOfFieldPostProcess,!0))}_createMotionBlurPostProcess(e,t){if(this._isObjectBasedMotionBlur){const i=new Oh("HDRMotionBlur",e,t,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,0);i.motionStrength=this.motionStrength,i.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=i}else{this.motionBlurPostProcess=new Pe("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],t,null,U.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+this.motionBlurSamples.toFixed(1),0);let i=0,s=F.Identity();const n=F.Identity();let o=F.Identity();const a=de.Zero();this.motionBlurPostProcess.onApply=l=>{o=e.getProjectionMatrix().multiply(e.getViewMatrix()),o.invertToRef(n),l.setMatrix("inverseViewProjection",n),l.setMatrix("prevViewProjection",s),s=o,a.x=this.motionBlurPostProcess.width,a.y=this.motionBlurPostProcess.height,l.setVector2("screenSize",a),i=e.getEngine().getFps()/60,l.setFloat("motionScale",i),l.setFloat("motionStrength",this.motionStrength),l.setTexture("depthSampler",this._getDepthTexture())}}this.addEffect(new Ut(e.getEngine(),"HDRMotionBlur",()=>this.motionBlurPostProcess,!0))}_getDepthTexture(){return this._scene.getEngine().getCaps().drawBuffersExtension?this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]:this._scene.enableDepthRenderer().getDepthMap()}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this.originalPostProcess&&this.originalPostProcess.dispose(t),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(t),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(t),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(t),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(t),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(t),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(t),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(t),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(t),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(t),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(t),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(t);for(let i=0;i<this.luminanceDownSamplePostProcesses.length;i++)this.luminanceDownSamplePostProcesses[i].dispose(t);this.luminancePostProcess&&this.luminancePostProcess.dispose(t),this.hdrPostProcess&&this.hdrPostProcess.dispose(t),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(t),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(t),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(t),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(t);for(let i=0;i<this.blurHPostProcesses.length;i++)this.blurHPostProcesses[i].dispose(t);for(let i=0;i<this.blurVPostProcesses.length;i++)this.blurVPostProcesses[i].dispose(t)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses.length=0,this.blurHPostProcesses.length=0,this.blurVPostProcesses.length=0}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}serialize(){const e=Ce.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(e.screenSpaceReflectionPostProcess=Ce.Serialize(this.screenSpaceReflectionPostProcess)),e.customType="StandardRenderingPipeline",e}static Parse(e,t,i){const s=Ce.Parse(()=>new Ft(e._name,t,e._ratio),e,t,i);return e.sourceLightId&&(s.sourceLight=t.getLightById(e.sourceLightId)),e.screenSpaceReflectionPostProcess&&Ce.Parse(()=>s.screenSpaceReflectionPostProcess,e.screenSpaceReflectionPostProcess,t,i),s}}Ft.LuminanceSteps=6,E([I()],Ft.prototype,"brightThreshold",void 0),E([I()],Ft.prototype,"blurWidth",void 0),E([I()],Ft.prototype,"horizontalBlur",void 0),E([I()],Ft.prototype,"exposure",null),E([ht("lensTexture")],Ft.prototype,"lensTexture",void 0),E([I()],Ft.prototype,"volumetricLightCoefficient",void 0),E([I()],Ft.prototype,"volumetricLightPower",void 0),E([I()],Ft.prototype,"volumetricLightBlurScale",void 0),E([I()],Ft.prototype,"hdrMinimumLuminance",void 0),E([I()],Ft.prototype,"hdrDecreaseRate",void 0),E([I()],Ft.prototype,"hdrIncreaseRate",void 0),E([I()],Ft.prototype,"hdrAutoExposure",null),E([ht("lensColorTexture")],Ft.prototype,"lensColorTexture",void 0),E([I()],Ft.prototype,"lensFlareStrength",void 0),E([I()],Ft.prototype,"lensFlareGhostDispersal",void 0),E([I()],Ft.prototype,"lensFlareHaloWidth",void 0),E([I()],Ft.prototype,"lensFlareDistortionStrength",void 0),E([I()],Ft.prototype,"lensFlareBlurWidth",void 0),E([ht("lensStarTexture")],Ft.prototype,"lensStarTexture",void 0),E([ht("lensFlareDirtTexture")],Ft.prototype,"lensFlareDirtTexture",void 0),E([I()],Ft.prototype,"depthOfFieldDistance",void 0),E([I()],Ft.prototype,"depthOfFieldBlurWidth",void 0),E([I()],Ft.prototype,"motionStrength",null),E([I()],Ft.prototype,"objectBasedMotionBlur",null),E([I()],Ft.prototype,"_ratio",void 0),E([I()],Ft.prototype,"BloomEnabled",null),E([I()],Ft.prototype,"DepthOfFieldEnabled",null),E([I()],Ft.prototype,"LensFlareEnabled",null),E([I()],Ft.prototype,"HDREnabled",null),E([I()],Ft.prototype,"VLSEnabled",null),E([I()],Ft.prototype,"MotionBlurEnabled",null),E([I()],Ft.prototype,"fxaaEnabled",null),E([I()],Ft.prototype,"screenSpaceReflectionsEnabled",null),E([I()],Ft.prototype,"volumetricLightStepsCount",null),E([I()],Ft.prototype,"motionBlurSamples",null),E([I()],Ft.prototype,"samples",null),le("BABYLON.StandardRenderingPipeline",Ft);class gle{constructor(){this.enabled=!1,this.name="screenSpaceReflections2",this.texturesRequired=[6,3,5]}}j.IncludesShadersStore.screenSpaceRayTrace="float distanceSquared(vec2 a,vec2 b) { a-=b; return dot(a,a); }\n/**\nparam csOrigin Camera-space ray origin,which must be \nwithin the view volume and must have z>0.01 and project within the valid screen rectangle\nparam csDirection Unit length camera-space ray direction\nparam projectToPixelMatrix A projection matrix that maps to **pixel** coordinates \n(**not** [-1,+1] normalized device coordinates).\nparam csZBuffer The camera-space Z buffer\nparam csZBufferSize Dimensions of csZBuffer\nparam csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer\nparam nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value\nfor clipping rays headed towards the camera\nparam stride Step in horizontal or vertical pixels between samples. This is a float\nbecause integer math is slow on GPUs,but should be set to an integer>=1\nparam jitterFraction Number between 0 and 1 for how far to bump the ray in stride units\nto conceal banding artifacts,plus the stride ray offset.\nparam maxSteps Maximum number of iterations. Higher gives better images but may be slow\nparam maxRayTraceDistance Maximum camera-space distance to trace before returning a miss\nparam selfCollisionNumSkip Number of steps to skip at start when raytracing to avoid self collisions.\n1 is a reasonable value,depending on the scene you may need to set this value to 2\nparam hitPixel Pixel coordinates of the first intersection with the scene\nparam numIterations number of iterations performed\nparam csHitPoint Camera space location of the ray hit\n*/\n#define inline\nbool traceScreenSpaceRay1(\nvec3 csOrigin,\nvec3 csDirection,\nmat4 projectToPixelMatrix,\nsampler2D csZBuffer,\nvec2 csZBufferSize,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nsampler2D csZBackBuffer,\nfloat csZBackSizeFactor,\n#endif\nfloat csZThickness,\nfloat nearPlaneZ,\nfloat stride,\nfloat jitterFraction,\nfloat maxSteps,\nfloat maxRayTraceDistance,\nfloat selfCollisionNumSkip,\nout vec2 startPixel,\nout vec2 hitPixel,\nout vec3 csHitPoint,\nout float numIterations\n#ifdef SSRAYTRACE_DEBUG\n,out vec3 debugColor\n#endif\n)\n{\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nfloat rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ ? (-nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;\n#else\nfloat rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ ? (nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;\n#endif\nvec3 csEndPoint=csOrigin+csDirection*rayLength;\nhitPixel=vec2(-1.0,-1.0);\nvec4 H0=projectToPixelMatrix*vec4(csOrigin,1.0);\nvec4 H1=projectToPixelMatrix*vec4(csEndPoint,1.0);\nfloat k0=1.0/H0.w;\nfloat k1=1.0/H1.w;\nvec3 Q0=csOrigin*k0;\nvec3 Q1=csEndPoint*k1;\nvec2 P0=H0.xy*k0;\nvec2 P1=H1.xy*k1;\n#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM\nfloat xMax=csZBufferSize.x-0.5,xMin=0.5,yMax=csZBufferSize.y-0.5,yMin=0.5;\nfloat alpha=0.0;\nif ((P1.y>yMax) || (P1.y<yMin)) {\nalpha=(P1.y-((P1.y>yMax) ? yMax : yMin))/(P1.y-P0.y);\n}\nif ((P1.x>xMax) || (P1.x<xMin)) {\nalpha=max(alpha,(P1.x-((P1.x>xMax) ? xMax : xMin))/(P1.x-P0.x));\n}\nP1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);\n#endif\nP1+=vec2((distanceSquared(P0,P1)<0.0001) ? 0.01 : 0.0);\nvec2 delta=P1-P0;\nbool permute=false;\nif (abs(delta.x)<abs(delta.y)) { \npermute=true;\ndelta=delta.yx;\nP0=P0.yx;\nP1=P1.yx; \n}\nfloat stepDirection=sign(delta.x);\nfloat invdx=stepDirection/delta.x;\nvec2 dP=vec2(stepDirection,delta.y*invdx);\nvec3 dQ=(Q1-Q0)*invdx;\nfloat dk=(k1-k0)*invdx;\nfloat zMin=min(csEndPoint.z,csOrigin.z);\nfloat zMax=max(csEndPoint.z,csOrigin.z);\ndP*=stride; dQ*=stride; dk*=stride;\nP0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;\nvec4 pqk=vec4(P0,Q0.z,k0);\nvec4 dPQK=vec4(dP,dQ.z,dk);\nstartPixel=permute ? P0.yx : P0.xy;\nfloat prevZMaxEstimate=csOrigin.z;\nfloat rayZMin=prevZMaxEstimate,rayZMax=prevZMaxEstimate;\nfloat sceneZMax=rayZMax+1e4;\nfloat end=P1.x*stepDirection;\nbool hit=false;\nfloat stepCount;\nfor (stepCount=0.0;\nstepCount<=selfCollisionNumSkip ||\n(pqk.x*stepDirection)<=end &&\nstepCount<maxSteps &&\n!hit &&\nsceneZMax != 0.0; \npqk+=dPQK,++stepCount)\n{\nhitPixel=permute ? pqk.yx : pqk.xy;\nrayZMin=prevZMaxEstimate;\nrayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);\nrayZMax=clamp(rayZMax,zMin,zMax);\nprevZMaxEstimate=rayZMax;\nif (rayZMin>rayZMax) { \nfloat t=rayZMin; rayZMin=rayZMax; rayZMax=t;\n}\nsceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nfloat sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;\nhit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);\n#else\nhit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);\n#endif\n#else\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nfloat sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;\nhit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);\n#else\nhit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);\n#endif\n#endif\n}\npqk-=dPQK;\nstepCount-=1.0;\n#ifdef SSRAYTRACE_ENABLE_REFINEMENT\nif (stride>1.0 && hit) {\npqk-=dPQK;\nstepCount-=1.0;\nfloat invStride=1.0/stride;\ndPQK*=invStride;\nfloat refinementStepCount=0.0;\nprevZMaxEstimate=pqk.z/pqk.w;\nrayZMax=prevZMaxEstimate;\nsceneZMax=rayZMax+1e7;\nfor (;\nrefinementStepCount<=1.0 ||\n(refinementStepCount<=stride*1.4) &&\n(rayZMax<sceneZMax) && (sceneZMax != 0.0);\npqk+=dPQK,refinementStepCount+=1.0)\n{\nrayZMin=prevZMaxEstimate;\nrayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);\nrayZMax=clamp(rayZMax,zMin,zMax);\nprevZMaxEstimate=rayZMax;\nrayZMax=max(rayZMax,rayZMin);\nhitPixel=permute ? pqk.yx : pqk.xy;\nsceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;\n}\npqk-=dPQK;\nrefinementStepCount-=1.0;\nstepCount+=refinementStepCount/stride;\n}\n#endif\nQ0.xy+=dQ.xy*stepCount;\nQ0.z=pqk.z;\ncsHitPoint=Q0/pqk.w;\nnumIterations=stepCount+1.0;\n#ifdef SSRAYTRACE_DEBUG\nif (((pqk.x+dPQK.x)*stepDirection)>end) {\ndebugColor=vec3(0,0,1);\n} else if ((stepCount+1.0)>=maxSteps) {\ndebugColor=vec3(1,0,0);\n} else if (sceneZMax==0.0) {\ndebugColor=vec3(1,1,0);\n} else {\ndebugColor=vec3(0,stepCount/maxSteps,0);\n}\n#endif\nreturn hit;\n}\n";j.ShadersStore.screenSpaceReflection2PixelShader="uniform sampler2D textureSampler;\nvarying vec2 vUV;\n#ifdef SSR_SUPPORTED\nuniform sampler2D reflectivitySampler;\nuniform sampler2D normalSampler;\nuniform sampler2D depthSampler;\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nuniform sampler2D backDepthSampler;\nuniform float backSizeFactor;\n#endif\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nuniform samplerCube envCubeSampler;\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize;\n#endif\n#endif\nuniform mat4 view;\nuniform mat4 invView;\nuniform mat4 projection;\nuniform mat4 invProjectionMatrix;\nuniform mat4 projectionPixel;\nuniform float nearPlaneZ;\nuniform float stepSize;\nuniform float maxSteps;\nuniform float strength;\nuniform float thickness;\nuniform float roughnessFactor;\nuniform float reflectionSpecularFalloffExponent;\nuniform float maxDistance;\nuniform float selfCollisionNumSkip;\nuniform float reflectivityThreshold;\n#include<helperFunctions>\n#include<screenSpaceRayTrace>\nvec3 fresnelSchlick(float cosTheta,vec3 F0)\n{\nreturn F0+(1.0-F0)*pow(1.0-cosTheta,5.0);\n}\nvec3 hash(vec3 a)\n{\na=fract(a*0.8);\na+=dot(a,a.yxz+19.19);\nreturn fract((a.xxy+a.yxx)*a.zyx);\n}\nvec3 computeViewPosFromUVDepth(vec2 texCoord,float depth) {\nvec4 ndc;\nndc.xy=texCoord*2.0-1.0;\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nndc.z=-projection[2].z-projection[3].z/depth;\n#else\nndc.z=projection[2].z+projection[3].z/depth;\n#endif\nndc.w=1.0;\nvec4 eyePos=invProjectionMatrix*ndc;\neyePos.xyz/=eyePos.w;\nreturn eyePos.xyz;\n}\nfloat computeAttenuationForIntersection(ivec2 hitPixel,vec2 hitUV,vec3 vsRayOrigin,vec3 vsHitPoint,vec3 reflectionVector,float maxRayDistance,float numIterations) {\nfloat attenuation=1.0;\n#ifdef SSR_ATTENUATE_SCREEN_BORDERS\nvec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-hitUV.xy));\nattenuation*=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_DISTANCE\nattenuation*=1.0-clamp(distance(vsRayOrigin,vsHitPoint)/maxRayDistance,0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_NUMITERATIONS\nattenuation*=1.0-(numIterations/maxSteps);\n#endif\n#ifdef SSR_ATTENUATE_BACKFACE_REFLECTION\nvec3 reflectionNormal=texelFetch(normalSampler,hitPixel,0).xyz;\nfloat directionBasedAttenuation=smoothstep(-0.17,0.0,dot(reflectionNormal,-reflectionVector));\nattenuation*=directionBasedAttenuation;\n#endif\nreturn attenuation;\n}\n#endif\nvoid main()\n{\n#ifdef SSR_SUPPORTED\nvec4 colorFull=texture2D(textureSampler,vUV);\nvec3 color=colorFull.rgb;\nvec4 reflectivity=texture2D(reflectivitySampler,vUV);\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {\n#ifdef SSR_USE_BLUR\ngl_FragColor=vec4(0.);\n#else\ngl_FragColor=colorFull;\n#endif\nreturn;\n}\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpace(color);\n#endif\nvec2 texSize=vec2(textureSize(depthSampler,0));\nvec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz; \nfloat depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;\nvec3 csPosition=computeViewPosFromUVDepth(vUV,depth);\nvec3 csViewDirection=normalize(csPosition);\nvec3 csReflectedVector=reflect(csViewDirection,csNormal);\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nvec3 wReflectedVector=vec3(invView*vec4(csReflectedVector,0.0));\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nvec4 worldPos=invView*vec4(csPosition,1.0);\nwReflectedVector=parallaxCorrectNormal(worldPos.xyz,normalize(wReflectedVector),vReflectionSize,vReflectionPosition);\n#endif\n#ifdef SSR_INVERTCUBICMAP\nwReflectedVector.y*=-1.0;\n#endif\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nwReflectedVector.z*=-1.0;\n#endif\nvec3 envColor=textureCube(envCubeSampler,wReflectedVector).xyz;\n#ifdef SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE\nenvColor=toLinearSpace(envColor);\n#endif\n#else\nvec3 envColor=color;\n#endif\nfloat reflectionAttenuation=1.0;\nbool rayHasHit=false;\nvec2 startPixel;\nvec2 hitPixel;\nvec3 hitPoint;\nfloat numIterations;\n#ifdef SSRAYTRACE_DEBUG\nvec3 debugColor;\n#endif\n#ifdef SSR_ATTENUATE_FACING_CAMERA\nreflectionAttenuation*=1.0-smoothstep(0.25,0.5,dot(-csViewDirection,csReflectedVector));\n#endif\nif (reflectionAttenuation>0.0) {\n#ifdef SSR_USE_BLUR\nvec3 jitt=vec3(0.);\n#else\nfloat roughness=1.0-reflectivity.a;\nvec3 jitt=mix(vec3(0.0),hash(csPosition),roughness)*roughnessFactor; \n#endif\nvec2 uv2=vUV*texSize;\nfloat c=(uv2.x+uv2.y)*0.25;\nfloat jitter=mod(c,1.0); \nrayHasHit=traceScreenSpaceRay1(\ncsPosition,\nnormalize(csReflectedVector+jitt),\nprojectionPixel,\ndepthSampler,\ntexSize,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nbackDepthSampler,\nbackSizeFactor,\n#endif\nthickness,\nnearPlaneZ,\nstepSize,\njitter,\nmaxSteps,\nmaxDistance,\nselfCollisionNumSkip,\nstartPixel,\nhitPixel,\nhitPoint,\nnumIterations\n#ifdef SSRAYTRACE_DEBUG\n,debugColor\n#endif\n);\n}\n#ifdef SSRAYTRACE_DEBUG\ngl_FragColor=vec4(debugColor,1.);\nreturn;\n#endif\nvec3 F0=reflectivity.rgb;\nvec3 fresnel=fresnelSchlick(max(dot(csNormal,-csViewDirection),0.0),F0);\nvec3 SSR=envColor;\nif (rayHasHit) {\nvec3 reflectedColor=texelFetch(textureSampler,ivec2(hitPixel),0).rgb;\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\nreflectedColor=toLinearSpace(reflectedColor);\n#endif\nreflectionAttenuation*=computeAttenuationForIntersection(ivec2(hitPixel),hitPixel/texSize,csPosition,hitPoint,csReflectedVector,maxDistance,numIterations);\nSSR=reflectedColor*reflectionAttenuation+(1.0-reflectionAttenuation)*envColor;\n}\nSSR*=fresnel;\n#ifdef SSR_USE_BLUR\nfloat blur_radius=0.0;\nfloat roughness=1.0-reflectivity.a*(1.0-roughnessFactor);\nif (roughness>0.001) {\nfloat cone_angle=min(roughness,0.999)*3.14159265*0.5;\nfloat cone_len=distance(startPixel,hitPixel);\nfloat op_len=2.0*tan(cone_angle)*cone_len; \nfloat a=op_len;\nfloat h=cone_len;\nfloat a2=a*a;\nfloat fh2=4.0f*h*h;\nblur_radius=(a*(sqrt(a2+fh2)-a))/(4.0f*h);\n}\ngl_FragColor=vec4(SSR,blur_radius/255.0); \n#else\nvec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\nvec3 colorMultiplier=1.0-reflectionMultiplier;\nvec3 finalColor=(color*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpace(finalColor);\n#endif\ngl_FragColor=vec4(finalColor,colorFull.a);\n#endif\n#else\ngl_FragColor=texture2D(textureSampler,vUV);\n#endif\n}\n";j.ShadersStore.screenSpaceReflection2BlurPixelShader="uniform sampler2D textureSampler;\nvarying vec2 vUV;\nuniform vec2 texelOffsetScale;\nconst float weights[8]=float[8] (0.071303,0.131514,0.189879,0.321392,0.452906, 0.584419,0.715932,0.847445);\nvoid processSample(vec2 uv,float i,vec2 stepSize,out vec4 accumulator,out float denominator)\n{\nvec2 offsetUV=stepSize*i+uv;\nfloat coefficient=weights[int(2.0-abs(i))];\naccumulator+=texture2D(textureSampler,offsetUV)*coefficient;\ndenominator+=coefficient;\n}\nvoid main()\n{\nvec4 colorFull=texture2D(textureSampler,vUV);\nif (dot(colorFull,vec4(1.0))==0.0) {\ngl_FragColor=colorFull;\nreturn;\n}\nfloat blurRadius=colorFull.a*255.0; \nvec2 stepSize=texelOffsetScale.xy*blurRadius;\nvec4 accumulator=texture2D(textureSampler,vUV)*0.214607;\nfloat denominator=0.214607;\nprocessSample(vUV,1.0,stepSize,accumulator,denominator);\nprocessSample(vUV,1.0*0.2,stepSize,accumulator,denominator);\nprocessSample(vUV,1.0*0.4,stepSize,accumulator,denominator);\nprocessSample(vUV,1.0*0.6,stepSize,accumulator,denominator);\nprocessSample(vUV,1.0*0.8,stepSize,accumulator,denominator);\nprocessSample(vUV,1.0*1.2,stepSize,accumulator,denominator);\nprocessSample(vUV,1.0*1.4,stepSize,accumulator,denominator);\nprocessSample(vUV,1.0*1.6,stepSize,accumulator,denominator);\nprocessSample(vUV,1.0*1.8,stepSize,accumulator,denominator);\nprocessSample(vUV,1.0*2.0,stepSize,accumulator,denominator);\nprocessSample(vUV,-1.0,stepSize,accumulator,denominator);\nprocessSample(vUV,-1.0*0.2,stepSize,accumulator,denominator);\nprocessSample(vUV,-1.0*0.4,stepSize,accumulator,denominator);\nprocessSample(vUV,-1.0*0.6,stepSize,accumulator,denominator);\nprocessSample(vUV,-1.0*0.8,stepSize,accumulator,denominator);\nprocessSample(vUV,-1.0*1.2,stepSize,accumulator,denominator);\nprocessSample(vUV,-1.0*1.4,stepSize,accumulator,denominator);\nprocessSample(vUV,-1.0*1.6,stepSize,accumulator,denominator);\nprocessSample(vUV,-1.0*1.8,stepSize,accumulator,denominator);\nprocessSample(vUV,-1.0*2.0,stepSize,accumulator,denominator);\ngl_FragColor=vec4(accumulator.rgb/denominator,colorFull.a);\n}\n";j.ShadersStore.screenSpaceReflection2BlurCombinerPixelShader="uniform sampler2D textureSampler; \nuniform sampler2D mainSampler;\nuniform sampler2D reflectivitySampler;\nuniform float strength;\nuniform float reflectionSpecularFalloffExponent;\nuniform float reflectivityThreshold;\nvarying vec2 vUV;\n#include<helperFunctions>\nvoid main()\n{\n#ifdef SSRAYTRACE_DEBUG\ngl_FragColor=texture2D(textureSampler,vUV);\n#else\nvec3 SSR=texture2D(textureSampler,vUV).rgb;\nvec4 color=texture2D(mainSampler,vUV);\nvec4 reflectivity=texture2D(reflectivitySampler,vUV);\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {\ngl_FragColor=color;\nreturn;\n}\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpace(color);\n#endif\nvec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\nvec3 colorMultiplier=1.0-reflectionMultiplier;\nvec3 finalColor=(color.rgb*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpace(finalColor);\n#endif\ngl_FragColor=vec4(finalColor,color.a);\n#endif\n}\n";const vle=F.Compose(new v(.5,.5,.5),Z.Identity(),new v(.5,.5,.5)),ble=F.Compose(new v(.5,.5,1),Z.Identity(),new v(.5,.5,0));class hi extends Td{set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}get ssrDownsample(){return this._ssrDownsample}set ssrDownsample(e){e!==this._ssrDownsample&&(this._ssrDownsample=e,this._buildPipeline())}get blurDispersionStrength(){return this._blurDispersionStrength}set blurDispersionStrength(e){if(e===this._blurDispersionStrength)return;const t=0===e&&0!==this._blurDispersionStrength||0!==e&&0===this._blurDispersionStrength;this._blurDispersionStrength=e,t&&this._buildPipeline()}_useBlur(){return this._blurDispersionStrength>0}get blurDownsample(){return this._blurDownsample}set blurDownsample(e){e!==this._blurDownsample&&(this._blurDownsample=e,this._buildPipeline())}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e,this._updateEffectDefines()}get environmentTextureIsProbe(){return this._environmentTextureIsProbe}set environmentTextureIsProbe(e){this._environmentTextureIsProbe=e,this._updateEffectDefines()}get attenuateScreenBorders(){return this._attenuateScreenBorders}set attenuateScreenBorders(e){this._attenuateScreenBorders!==e&&(this._attenuateScreenBorders=e,this._updateEffectDefines())}get attenuateIntersectionDistance(){return this._attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._attenuateIntersectionDistance!==e&&(this._attenuateIntersectionDistance=e,this._updateEffectDefines())}get attenuateIntersectionIterations(){return this._attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._attenuateIntersectionIterations!==e&&(this._attenuateIntersectionIterations=e,this._updateEffectDefines())}get attenuateFacingCamera(){return this._attenuateFacingCamera}set attenuateFacingCamera(e){this._attenuateFacingCamera!==e&&(this._attenuateFacingCamera=e,this._updateEffectDefines())}get attenuateBackfaceReflection(){return this._attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._attenuateBackfaceReflection!==e&&(this._attenuateBackfaceReflection=e,this._updateEffectDefines())}get clipToFrustum(){return this._clipToFrustum}set clipToFrustum(e){this._clipToFrustum!==e&&(this._clipToFrustum=e,this._updateEffectDefines())}get enableAutomaticThicknessComputation(){return this._enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._enableAutomaticThicknessComputation!==e&&(this._enableAutomaticThicknessComputation=e,this._buildPipeline())}get backfaceDepthRenderer(){return this._depthRenderer}get backfaceDepthTextureDownsample(){return this._backfaceDepthTextureDownsample}set backfaceDepthTextureDownsample(e){this._backfaceDepthTextureDownsample!==e&&(this._backfaceDepthTextureDownsample=e,this._resizeDepthRenderer())}get backfaceForceDepthWriteTransparentMeshes(){return this._backfaceForceDepthWriteTransparentMeshes}set backfaceForceDepthWriteTransparentMeshes(e){this._backfaceForceDepthWriteTransparentMeshes!==e&&(this._backfaceForceDepthWriteTransparentMeshes=e,this._depthRenderer&&(this._depthRenderer.forceDepthWriteTransparentMeshes=e))}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)):null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get inputTextureColorIsInGammaSpace(){return this._inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._inputTextureColorIsInGammaSpace!==e&&(this._inputTextureColorIsInGammaSpace=e,this._buildPipeline())}get generateOutputInGammaSpace(){return this._generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._generateOutputInGammaSpace!==e&&(this._generateOutputInGammaSpace=e,this._buildPipeline())}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._buildPipeline())}getScene(){return this._scene}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}get scene(){return this._scene}get isSupported(){const e=this._scene.getEngine().getCaps();return e.drawBuffersExtension&&e.texelFetch}constructor(e,t,i,s=!1,n=0){if(super(t.getEngine(),e),this.SSRRenderEffect="SSRRenderEffect",this.SSRBlurRenderEffect="SSRBlurRenderEffect",this.SSRCombineRenderEffect="SSRCombineRenderEffect",this._samples=1,this.maxDistance=1e3,this.step=1,this.thickness=.5,this.strength=1,this.reflectionSpecularFalloffExponent=1,this.maxSteps=1e3,this.roughnessFactor=.2,this.selfCollisionNumSkip=1,this.reflectivityThreshold=.04,this._ssrDownsample=0,this._blurDispersionStrength=.03,this._blurDownsample=0,this._enableSmoothReflections=!1,this._environmentTextureIsProbe=!1,this._attenuateScreenBorders=!0,this._attenuateIntersectionDistance=!0,this._attenuateIntersectionIterations=!0,this._attenuateFacingCamera=!1,this._attenuateBackfaceReflection=!1,this._clipToFrustum=!0,this._enableAutomaticThicknessComputation=!1,this._backfaceDepthTextureDownsample=0,this._backfaceForceDepthWriteTransparentMeshes=!0,this._isEnabled=!0,this._inputTextureColorIsInGammaSpace=!0,this._generateOutputInGammaSpace=!0,this._debug=!1,this._forceGeometryBuffer=!1,this._isDirty=!1,this._camerasToBeAttached=[],this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=n,this._forceGeometryBuffer=s,this.isSupported){if(t.postProcessRenderPipelineManager.addPipeline(this),this._forceGeometryBuffer){const o=t.enableGeometryBufferRenderer();o&&(o.enableReflectivity=!0,o.useSpecificClearForDepthTexture=!0)}else{const o=t.enablePrePassRenderer();o&&(o.useSpecificClearForDepthTexture=!0,o.markAsDirty())}this._buildPipeline()}}getClassName(){return"SSRRenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(e=!1){this._disposeDepthRenderer(),this._disposePostProcesses(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}_getTextureSize(){var e,t;const i=this._scene.getEngine(),s=this._prePassRenderer;let n={width:i.getRenderWidth(),height:i.getRenderHeight()};if(s&&(null===(e=this._scene.activeCamera)||void 0===e?void 0:e._getFirstPostProcess())===this._ssrPostProcess){const o=s.getRenderTarget();o&&o.textures&&(n=o.textures[s.getIndex(4)].getSize())}else null!==(t=this._ssrPostProcess)&&void 0!==t&&t.inputTexture&&(n.width=this._ssrPostProcess.inputTexture.width,n.height=this._ssrPostProcess.inputTexture.height);return n}_updateEffectDefines(){var e;const t=[];(this._geometryBufferRenderer||this._prePassRenderer)&&t.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&t.push("#define SSRAYTRACE_ENABLE_REFINEMENT"),this._scene.useRightHandedSystem&&t.push("#define SSRAYTRACE_RIGHT_HANDED_SCENE"),this._environmentTexture&&(t.push("#define SSR_USE_ENVIRONMENT_CUBE"),this._environmentTexture.boundingBoxSize&&t.push("#define SSR_USE_LOCAL_REFLECTIONMAP_CUBIC"),this._environmentTexture.gammaSpace&&t.push("#define SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE")),this._environmentTextureIsProbe&&t.push("#define SSR_INVERTCUBICMAP"),this._enableAutomaticThicknessComputation&&t.push("#define SSRAYTRACE_USE_BACK_DEPTHBUFFER"),this._attenuateScreenBorders&&t.push("#define SSR_ATTENUATE_SCREEN_BORDERS"),this._attenuateIntersectionDistance&&t.push("#define SSR_ATTENUATE_INTERSECTION_DISTANCE"),this._attenuateIntersectionIterations&&t.push("#define SSR_ATTENUATE_INTERSECTION_NUMITERATIONS"),this._attenuateFacingCamera&&t.push("#define SSR_ATTENUATE_FACING_CAMERA"),this._attenuateBackfaceReflection&&t.push("#define SSR_ATTENUATE_BACKFACE_REFLECTION"),this._clipToFrustum&&t.push("#define SSRAYTRACE_CLIP_TO_FRUSTUM"),this._useBlur()&&t.push("#define SSR_USE_BLUR"),this._debug&&t.push("#define SSRAYTRACE_DEBUG"),this._inputTextureColorIsInGammaSpace&&t.push("#define SSR_INPUT_IS_GAMMA_SPACE"),this._generateOutputInGammaSpace&&t.push("#define SSR_OUTPUT_IS_GAMMA_SPACE"),null===(e=this._ssrPostProcess)||void 0===e||e.updateEffect(t.join("\n"))}_buildPipeline(){var e;if(!this.isSupported)return;if(!this._isEnabled)return void(this._isDirty=!0);this._isDirty=!1;const t=this._scene.getEngine();if(this._disposeDepthRenderer(),this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._enableAutomaticThicknessComputation){const i=null===(e=this._cameras)||void 0===e?void 0:e[0];i&&(this._depthRendererCamera=i,this._depthRenderer=new Jv(this._scene,void 0,void 0,void 0,1,!0,"SSRBackDepth"),this._depthRenderer.clearColor.r=1e8,this._depthRenderer.reverseCulling=!0,this._depthRenderer.getDepthMap().noPrePassRenderer=!0,this._depthRenderer.forceDepthWriteTransparentMeshes=this._backfaceForceDepthWriteTransparentMeshes,this._resizeDepthRenderer(),i.customRenderTargets.push(this._depthRenderer.getDepthMap()))}this._createSSRPostProcess(),this.addEffect(new Ut(t,this.SSRRenderEffect,()=>this._ssrPostProcess,!0)),this._useBlur()&&(this._createBlurAndCombinerPostProcesses(),this.addEffect(new Ut(t,this.SSRBlurRenderEffect,()=>[this._blurPostProcessX,this._blurPostProcessY],!0)),this.addEffect(new Ut(t,this.SSRCombineRenderEffect,()=>this._blurCombinerPostProcess,!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_resizeDepthRenderer(){if(!this._depthRenderer)return;const e=this._getTextureSize(),t=this._depthRenderer.getDepthMap().getSize(),i=Math.floor(e.width/(this._backfaceDepthTextureDownsample+1)),s=Math.floor(e.height/(this._backfaceDepthTextureDownsample+1));(t.width!==i||t.height!==s)&&this._depthRenderer.getDepthMap().resize({width:i,height:s})}_disposeDepthRenderer(){var e;if(this._depthRenderer){if(this._depthRendererCamera){const t=null!==(e=this._depthRendererCamera.customRenderTargets.indexOf(this._depthRenderer.getDepthMap()))&&void 0!==e?e:-1;-1!==t&&this._depthRendererCamera.customRenderTargets.splice(t,1)}this._depthRendererCamera=null,this._depthRenderer.getDepthMap().dispose()}this._depthRenderer=null}_disposePostProcesses(){var e,t,i,s;for(let n=0;n<this._cameras.length;n++){const o=this._cameras[n];null===(e=this._ssrPostProcess)||void 0===e||e.dispose(o),null===(t=this._blurPostProcessX)||void 0===t||t.dispose(o),null===(i=this._blurPostProcessY)||void 0===i||i.dispose(o),null===(s=this._blurCombinerPostProcess)||void 0===s||s.dispose(o)}this._ssrPostProcess=null,this._blurPostProcessX=null,this._blurPostProcessY=null,this._blurCombinerPostProcess=null}_createSSRPostProcess(){this._ssrPostProcess=new Pe("ssr","screenSpaceReflection2",["projection","invProjectionMatrix","view","invView","thickness","reflectionSpecularFalloffExponent","strength","stepSize","maxSteps","roughnessFactor","projectionPixel","nearPlaneZ","maxDistance","selfCollisionNumSkip","vReflectionPosition","vReflectionSize","backSizeFactor","reflectivityThreshold"],["textureSampler","normalSampler","reflectivitySampler","depthSampler","envCubeSampler","backDepthSampler"],1,null,this._textureType,this._scene.getEngine(),!1,"",this._textureType),this._updateEffectDefines(),this._ssrPostProcess.onApply=e=>{this._resizeDepthRenderer();const t=this._geometryBufferRenderer,i=this._prePassRenderer;if(!i&&!t)return;if(t){const l=t.getTextureIndex(Zn.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("normalSampler",t.getGBuffer().textures[1]),e.setTexture("reflectivitySampler",t.getGBuffer().textures[l]),e.setTexture("depthSampler",t.getGBuffer().textures[0])}else if(i){const l=i.getIndex(5),c=i.getIndex(3),h=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[h]),e.setTexture("depthSampler",i.getRenderTarget().textures[l]),e.setTexture("reflectivitySampler",i.getRenderTarget().textures[c])}this._enableAutomaticThicknessComputation&&this._depthRenderer&&(e.setTexture("backDepthSampler",this._depthRenderer.getDepthMap()),e.setFloat("backSizeFactor",this._backfaceDepthTextureDownsample+1));const s=this._scene.activeCamera;if(!s)return;const n=s.getViewMatrix(!0),o=s.getProjectionMatrix(!0);o.invertToRef(L.Matrix[0]),n.invertToRef(L.Matrix[1]),e.setMatrix("projection",o),e.setMatrix("view",n),e.setMatrix("invView",L.Matrix[1]),e.setMatrix("invProjectionMatrix",L.Matrix[0]),e.setFloat("thickness",this.thickness),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("maxSteps",this.maxSteps),e.setFloat("roughnessFactor",this.roughnessFactor),e.setFloat("nearPlaneZ",s.minZ),e.setFloat("maxDistance",this.maxDistance),e.setFloat("selfCollisionNumSkip",this.selfCollisionNumSkip),e.setFloat("reflectivityThreshold",this.reflectivityThreshold);const a=this._getTextureSize();F.ScalingToRef(a.width,a.height,1,L.Matrix[2]),o.multiplyToRef(this._scene.getEngine().isWebGPU?ble:vle,L.Matrix[3]),L.Matrix[3].multiplyToRef(L.Matrix[2],L.Matrix[4]),e.setMatrix("projectionPixel",L.Matrix[4]),this._environmentTexture&&(e.setTexture("envCubeSampler",this._environmentTexture),this._environmentTexture.boundingBoxSize&&(e.setVector3("vReflectionPosition",this._environmentTexture.boundingBoxPosition),e.setVector3("vReflectionSize",this._environmentTexture.boundingBoxSize)))},this._ssrPostProcess.samples=this.samples,this._forceGeometryBuffer||(this._ssrPostProcess._prePassEffectConfiguration=new gle)}_createBlurAndCombinerPostProcesses(){const e=this._scene.getEngine();this._blurPostProcessX=new Pe("SSRblurX","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._ssrDownsample+1):1,null,2,e,!1,"",this._textureType),this._blurPostProcessX.autoClear=!1,this._blurPostProcessX.onApplyObservable.add(i=>{var s,n;const o=null!==(n=null===(s=this._blurPostProcessX)||void 0===s?void 0:s.inputTexture.width)&&void 0!==n?n:this._scene.getEngine().getRenderWidth();i.setFloat2("texelOffsetScale",this._blurDispersionStrength/o,0)}),this._blurPostProcessY=new Pe("SSRblurY","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._blurDownsample+1):1,null,2,e,!1,"",this._textureType),this._blurPostProcessY.autoClear=!1,this._blurPostProcessY.onApplyObservable.add(i=>{var s,n;const o=null!==(n=null===(s=this._blurPostProcessY)||void 0===s?void 0:s.inputTexture.height)&&void 0!==n?n:this._scene.getEngine().getRenderHeight();i.setFloat2("texelOffsetScale",0,this._blurDispersionStrength/o)});let t="";this._debug&&(t+="#define SSRAYTRACE_DEBUG\n"),this._inputTextureColorIsInGammaSpace&&(t+="#define SSR_INPUT_IS_GAMMA_SPACE\n"),this._generateOutputInGammaSpace&&(t+="#define SSR_OUTPUT_IS_GAMMA_SPACE\n"),this._blurCombinerPostProcess=new Pe("SSRblurCombiner","screenSpaceReflection2BlurCombiner",["strength","reflectionSpecularFalloffExponent","reflectivityThreshold"],["textureSampler","mainSampler","reflectivitySampler"],this._useBlur()?1/(this._blurDownsample+1):1,null,1,e,!1,t,this._textureType),this._blurCombinerPostProcess.autoClear=!1,this._blurCombinerPostProcess.onApplyObservable.add(i=>{var s;const n=this._geometryBufferRenderer,o=this._prePassRenderer;if(o||n){if(o&&(null===(s=this._scene.activeCamera)||void 0===s?void 0:s._getFirstPostProcess())===this._ssrPostProcess){const a=o.getRenderTarget();a&&a.textures&&i.setTexture("mainSampler",a.textures[o.getIndex(4)])}else i.setTextureFromPostProcess("mainSampler",this._ssrPostProcess);if(n){const a=n.getTextureIndex(Zn.REFLECTIVITY_TEXTURE_TYPE);i.setTexture("reflectivitySampler",n.getGBuffer().textures[a])}else if(o){const a=o.getIndex(3);i.setTexture("reflectivitySampler",o.getRenderTarget().textures[a])}i.setFloat("strength",this.strength),i.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),i.setFloat("reflectivityThreshold",this.reflectivityThreshold)}})}serialize(){const e=Ce.Serialize(this);return e.customType="SSRRenderingPipeline",e}static Parse(e,t,i){return Ce.Parse(()=>new hi(e._name,t,e._ratio),e,t,i)}}E([I()],hi.prototype,"samples",null),E([I()],hi.prototype,"maxDistance",void 0),E([I()],hi.prototype,"step",void 0),E([I()],hi.prototype,"thickness",void 0),E([I()],hi.prototype,"strength",void 0),E([I()],hi.prototype,"reflectionSpecularFalloffExponent",void 0),E([I()],hi.prototype,"maxSteps",void 0),E([I()],hi.prototype,"roughnessFactor",void 0),E([I()],hi.prototype,"selfCollisionNumSkip",void 0),E([I()],hi.prototype,"reflectivityThreshold",void 0),E([I("_ssrDownsample")],hi.prototype,"_ssrDownsample",void 0),E([I()],hi.prototype,"ssrDownsample",null),E([I("blurDispersionStrength")],hi.prototype,"_blurDispersionStrength",void 0),E([I("blurDownsample")],hi.prototype,"_blurDownsample",void 0),E([I("enableSmoothReflections")],hi.prototype,"_enableSmoothReflections",void 0),E([I("environmentTexture")],hi.prototype,"_environmentTexture",void 0),E([I("environmentTextureIsProbe")],hi.prototype,"_environmentTextureIsProbe",void 0),E([I("attenuateScreenBorders")],hi.prototype,"_attenuateScreenBorders",void 0),E([I("attenuateIntersectionDistance")],hi.prototype,"_attenuateIntersectionDistance",void 0),E([I("attenuateIntersectionIterations")],hi.prototype,"_attenuateIntersectionIterations",void 0),E([I("attenuateFacingCamera")],hi.prototype,"_attenuateFacingCamera",void 0),E([I("attenuateBackfaceReflection")],hi.prototype,"_attenuateBackfaceReflection",void 0),E([I("clipToFrustum")],hi.prototype,"_clipToFrustum",void 0),E([I("enableAutomaticThicknessComputation")],hi.prototype,"_enableAutomaticThicknessComputation",void 0),E([I("backfaceDepthTextureDownsample")],hi.prototype,"_backfaceDepthTextureDownsample",void 0),E([I("backfaceForceDepthWriteTransparentMeshes")],hi.prototype,"_backfaceForceDepthWriteTransparentMeshes",void 0),E([I("isEnabled")],hi.prototype,"_isEnabled",void 0),E([I("inputTextureColorIsInGammaSpace")],hi.prototype,"_inputTextureColorIsInGammaSpace",void 0),E([I("generateOutputInGammaSpace")],hi.prototype,"_generateOutputInGammaSpace",void 0),E([I("debug")],hi.prototype,"_debug",void 0),le("BABYLON.SSRRenderingPipeline",hi);j.ShadersStore.tonemapPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform float _ExposureAdjustment;\n#if defined(HABLE_TONEMAPPING)\nconst float A=0.15;\nconst float B=0.50;\nconst float C=0.10;\nconst float D=0.20;\nconst float E=0.02;\nconst float F=0.30;\nconst float W=11.2;\n#endif\nfloat Luminance(vec3 c)\n{\nreturn dot(c,vec3(0.22,0.707,0.071));\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\nvec3 colour=texture2D(textureSampler,vUV).rgb;\n#if defined(REINHARD_TONEMAPPING)\nfloat lum=Luminance(colour.rgb); \nfloat lumTm=lum*_ExposureAdjustment;\nfloat scale=lumTm/(1.0+lumTm); \ncolour*=scale/lum;\n#elif defined(HABLE_TONEMAPPING)\ncolour*=_ExposureAdjustment;\nconst float ExposureBias=2.0;\nvec3 x=ExposureBias*colour;\nvec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\nx=vec3(W,W,W);\nvec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);\ncolour=curr*whiteScale;\n#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)\ncolour*=_ExposureAdjustment;\nvec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);\nvec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);\ncolour=retColor*retColor;\n#elif defined(PHOTOGRAPHIC_TONEMAPPING)\ncolour= vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);\n#endif\ngl_FragColor=vec4(colour.rgb,1.0);\n}";j.ShadersStore.volumetricLightScatteringPixelShader="uniform sampler2D textureSampler;\nuniform sampler2D lightScatteringSampler;\nuniform float decay;\nuniform float exposure;\nuniform float weight;\nuniform float density;\nuniform vec2 meshPositionOnScreen;\nvarying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec2 tc=vUV;\nvec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);\ndeltaTexCoord*=1.0/float(NUM_SAMPLES)*density;\nfloat illuminationDecay=1.0;\nvec4 color=texture2D(lightScatteringSampler,tc)*0.4;\nfor(int i=0; i<NUM_SAMPLES; i++) {\ntc-=deltaTexCoord;\nvec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;\ndataSample*=illuminationDecay*weight;\ncolor+=dataSample;\nilluminationDecay*=decay;\n}\nvec4 realColor=texture2D(textureSampler,vUV);\ngl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";j.ShadersStore.volumetricLightScatteringPassVertexShader="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nuniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}\n";j.ShadersStore.volumetricLightScatteringPassPixelShader="#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\n#endif\n#if defined(ALPHATEST)\nuniform sampler2D diffuseSampler;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#if defined(ALPHATEST)\nvec4 diffuseColor=texture2D(diffuseSampler,vUV);\nif (diffuseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\n}\n";class Jn extends Pe{get useDiffuseColor(){return V.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1}set useDiffuseColor(e){V.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")}constructor(e,t,i,s,n=100,o=U.BILINEAR_SAMPLINGMODE,a,l,c){var h,u;super(e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],t.postProcessRatio||t,i,o,a,l,"#define NUM_SAMPLES "+n),this._screenCoordinates=de.Zero(),this.customMeshPosition=v.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=new Array,this.includedMeshes=new Array,this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,a=(c=null!==(u=null!==(h=i?.getScene())&&void 0!==h?h:c)&&void 0!==u?u:this._scene).getEngine(),this._viewPort=new qr(0,0,1,1).toGlobal(a.getRenderWidth(),a.getRenderHeight()),this.mesh=s??Jn.CreateDefaultMesh("VolumetricLightScatteringMesh",c),this._createPass(c,t.passRatio||t),this.onActivate=d=>{this.isSupported||this.dispose(d),this.onActivate=null},this.onApplyObservable.add(d=>{this._updateMeshScreenCoordinates(c),d.setTexture("lightScatteringSampler",this._volumetricLightScatteringRTT),d.setFloat("exposure",this.exposure),d.setFloat("decay",this.decay),d.setFloat("weight",this.weight),d.setFloat("density",this.density),d.setVector2("meshPositionOnScreen",this._screenCoordinates)})}getClassName(){return"VolumetricLightScatteringPostProcess"}_isReady(e,t){var i;const s=e.getMesh();if(s===this.mesh&&s.material)return s.material.isReady(s);const n=null===(i=s._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===i?void 0:i[this._scene.getEngine().currentRenderPassId];if(n)return n.isReadyForSubMesh(s,e,t);const o=[],a=[A.PositionKind],l=e.getMaterial();l&&(l.needAlphaTesting()&&o.push("#define ALPHATEST"),s.isVerticesDataPresent(A.UVKind)&&(a.push(A.UVKind),o.push("#define UV1")),s.isVerticesDataPresent(A.UV2Kind)&&(a.push(A.UV2Kind),o.push("#define UV2"))),s.useBones&&s.computeBonesUsingShaders?(a.push(A.MatricesIndicesKind),a.push(A.MatricesWeightsKind),o.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),o.push("#define BonesPerMesh "+(s.skeleton?s.skeleton.bones.length+1:0))):o.push("#define NUM_BONE_INFLUENCERS 0"),t&&(o.push("#define INSTANCES"),ce.PushAttributesForInstances(a),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES"));const c=e._getDrawWrapper(void 0,!0),h=c.defines,u=o.join("\n");return h!==u&&c.setEffect(s.getScene().getEngine().createEffect("volumetricLightScatteringPass",a,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],u,void 0,void 0,void 0,{maxSimultaneousMorphTargets:s.numBoneInfluencers}),u),c.effect.isReady()}setCustomMeshPosition(e){this.customMeshPosition=e}getCustomMeshPosition(){return this.customMeshPosition}dispose(e){const t=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);-1!==t&&e.getScene().customRenderTargets.splice(t,1),this._volumetricLightScatteringRTT.dispose(),super.dispose(e)}getPass(){return this._volumetricLightScatteringRTT}_meshExcluded(e){return this.includedMeshes.length>0&&-1===this.includedMeshes.indexOf(e)||this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)}_createPass(e,t){const i=e.getEngine();this._volumetricLightScatteringRTT=new Ss("volumetricLightScatteringMap",{width:i.getRenderWidth()*t,height:i.getRenderHeight()*t},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=U.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=U.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;const s=this.getCamera();s?s.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);const n=l=>{var c;const h=l.getRenderingMesh(),u=l.getEffectiveMesh();if(this._meshExcluded(h))return;u._internalAbstractMeshDataInfo._isActiveIntermediate=!1;const d=l.getMaterial();if(!d)return;const f=h.getScene(),p=f.getEngine();p.setState(d.backFaceCulling,void 0,void 0,void 0,d.cullBackFaces);const _=h._getInstancesRenderList(l._id,!!l.getReplacementMesh());if(_.mustReturn)return;const m=p.getCaps().instancedArrays&&(null!==_.visibleInstances[l._id]||h.hasThinInstances);if(this._isReady(l,m)){const g=null===(c=u._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===c?void 0:c[p.currentRenderPassId];let b=l._getDrawWrapper();if(h===this.mesh&&!b&&(b=d._getDrawWrapper()),!b)return;const y=b.effect;if(p.enableEffect(b),m||h._bind(l,y,d.fillMode),h===this.mesh)d.bind(u.getWorldMatrix(),h);else if(g)g.bindForSubMesh(u.getWorldMatrix(),u,l);else{if(y.setMatrix("viewProjection",f.getTransformMatrix()),d&&d.needAlphaTesting()){const T=d.getAlphaTestTexture();y.setTexture("diffuseSampler",T),T&&y.setMatrix("diffuseMatrix",T.getTextureMatrix())}h.useBones&&h.computeBonesUsingShaders&&h.skeleton&&y.setMatrices("mBones",h.skeleton.getTransformMatrices(h))}m&&h.hasThinInstances&&y.setMatrix("world",u.getWorldMatrix()),h._processRendering(u,l,y,ie.TriangleFillMode,_,m,(T,x)=>{T||y.setMatrix("world",x)})}};let o;const a=new Te(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(()=>{o=e.clearColor,e.clearColor=a}),this._volumetricLightScatteringRTT.onAfterRenderObservable.add(()=>{e.clearColor=o}),this._volumetricLightScatteringRTT.customIsReadyFunction=(l,c,h)=>{if((h||0===c)&&l.subMeshes)for(let u=0;u<l.subMeshes.length;++u){const d=l.subMeshes[u],f=d.getMaterial(),p=d.getRenderingMesh();if(!f)continue;const _=p._getInstancesRenderList(d._id,!!d.getReplacementMesh()),m=i.getCaps().instancedArrays&&(null!==_.visibleInstances[d._id]||p.hasThinInstances);if(!this._isReady(d,m))return!1}return!0},this._volumetricLightScatteringRTT.customRenderFunction=(l,c,h,u)=>{const d=e.getEngine();let f;if(u.length){for(d.setColorWrite(!1),f=0;f<u.length;f++)n(u.data[f]);d.setColorWrite(!0)}for(f=0;f<l.length;f++)n(l.data[f]);for(f=0;f<c.length;f++)n(c.data[f]);if(h.length){for(f=0;f<h.length;f++){const _=h.data[f],m=_.getBoundingInfo();m&&e.activeCamera&&(_._alphaIndex=_.getMesh().alphaIndex,_._distanceToCamera=m.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}const p=h.data.slice(0,h.length);for(p.sort((_,m)=>_._alphaIndex>m._alphaIndex?1:_._alphaIndex<m._alphaIndex?-1:_._distanceToCamera<m._distanceToCamera?1:_._distanceToCamera>m._distanceToCamera?-1:0),d.setAlphaMode(2),f=0;f<p.length;f++)n(p[f]);d.setAlphaMode(0)}}}_updateMeshScreenCoordinates(e){const t=e.getTransformMatrix();let i;i=this.useCustomMeshPosition?this.customMeshPosition:this.attachedNode?this.attachedNode.position:this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;const s=v.Project(i,F.Identity(),t,this._viewPort);this._screenCoordinates.x=s.x/this._viewPort.width,this._screenCoordinates.y=s.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)}static CreateDefaultMesh(e,t){const i=rh(e,{size:1},t);i.billboardMode=Zt.BILLBOARDMODE_ALL;const s=new fe(e+"Material",t);return s.emissiveColor=new re(1,1,1),i.material=s,i}}E([Ws()],Jn.prototype,"customMeshPosition",void 0),E([I()],Jn.prototype,"useCustomMeshPosition",void 0),E([I()],Jn.prototype,"invert",void 0),E([ip()],Jn.prototype,"mesh",void 0),E([I()],Jn.prototype,"excludedMeshes",void 0),E([I()],Jn.prototype,"includedMeshes",void 0),E([I()],Jn.prototype,"exposure",void 0),E([I()],Jn.prototype,"decay",void 0),E([I()],Jn.prototype,"weight",void 0),E([I()],Jn.prototype,"density",void 0),le("BABYLON.VolumetricLightScatteringPostProcess",Jn);j.ShadersStore.screenSpaceCurvaturePixelShader="precision highp float;\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D normalSampler;\nuniform float curvature_ridge;\nuniform float curvature_valley;\n#ifndef CURVATURE_OFFSET\n#define CURVATURE_OFFSET 1\n#endif\nfloat curvature_soft_clamp(float curvature,float control)\n{\nif (curvature<0.5/control)\nreturn curvature*(1.0-curvature*control);\nreturn 0.25/control;\n}\nfloat calculate_curvature(ivec2 texel,float ridge,float valley)\n{\nvec2 normal_up =texelFetch(normalSampler,texel+ivec2(0, CURVATURE_OFFSET),0).rb;\nvec2 normal_down =texelFetch(normalSampler,texel+ivec2(0,-CURVATURE_OFFSET),0).rb;\nvec2 normal_left =texelFetch(normalSampler,texel+ivec2(-CURVATURE_OFFSET,0),0).rb;\nvec2 normal_right=texelFetch(normalSampler,texel+ivec2( CURVATURE_OFFSET,0),0).rb;\nfloat normal_diff=((normal_up.g-normal_down.g)+(normal_right.r-normal_left.r));\nif (normal_diff<0.0)\nreturn -2.0*curvature_soft_clamp(-normal_diff,valley);\nreturn 2.0*curvature_soft_clamp(normal_diff,ridge);\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\nivec2 texel=ivec2(gl_FragCoord.xy);\nvec4 baseColor=texture2D(textureSampler,vUV);\nfloat curvature=calculate_curvature(texel,curvature_ridge,curvature_valley);\nbaseColor.rgb*=curvature+1.0;\ngl_FragColor=baseColor;\n}";class Zp extends Pe{getClassName(){return"ScreenSpaceCurvaturePostProcess"}constructor(e,t,i,s,n,o,a,l=0,c=!1){super(e,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],i,s,n,o,a,void 0,l,void 0,null,c),this.ridge=1,this.valley=1,this._geometryBufferRenderer=t.enableGeometryBufferRenderer(),this._geometryBufferRenderer?this.onApply=h=>{h.setFloat("curvature_ridge",.5/Math.max(this.ridge*this.ridge,1e-4)),h.setFloat("curvature_valley",.7/Math.max(this.valley*this.valley,1e-4));const u=this._geometryBufferRenderer.getGBuffer().textures[1];h.setTexture("normalSampler",u)}:V.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first.")}static get IsSupported(){const e=be.LastCreatedEngine;return!!e&&e.getCaps().drawBuffersExtension}static _Parse(e,t,i,s){return Ce.Parse(()=>new Zp(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,s)}}E([I()],Zp.prototype,"ridge",void 0),E([I()],Zp.prototype,"valley",void 0),le("BABYLON.ScreenSpaceCurvaturePostProcess",Zp);j.IncludesShadersStore.boundingBoxRendererFragmentDeclaration="uniform vec4 color;\n";j.IncludesShadersStore.boundingBoxRendererUboDeclaration="#ifdef WEBGL2\nuniform vec4 color;\nuniform mat4 world;\nuniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n#else\nlayout(std140,column_major) uniform;\nuniform BoundingBoxRenderer {\nvec4 color;\nmat4 world;\nmat4 viewProjection;\nmat4 viewProjectionR;\n};\n#endif\n";j.ShadersStore.boundingBoxRendererPixelShader="#include<__decl__boundingBoxRendererFragment>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";j.IncludesShadersStore.boundingBoxRendererVertexDeclaration="uniform mat4 world;\nuniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n";j.ShadersStore.boundingBoxRendererVertexShader="attribute vec3 position;\n#include<__decl__boundingBoxRendererVertex>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec4 worldPos=world*vec4(position,1.0);\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*worldPos;\n} else {\ngl_Position=viewProjectionR*worldPos;\n}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}\n",Object.defineProperty(ge.prototype,"forceShowBoundingBoxes",{get:function(){return this._forceShowBoundingBoxes||!1},set:function(r){this._forceShowBoundingBoxes=r,r&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0}),ge.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new yle(this)),this._boundingBoxRenderer},Object.defineProperty(Zt.prototype,"showBoundingBox",{get:function(){return this._showBoundingBox||!1},set:function(r){this._showBoundingBox=r,r&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});class yle{constructor(e){this.name=Me.NAME_BOUNDINGBOXRENDERER,this.frontColor=new re(1,1,1),this.backColor=new re(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new z,this.onAfterBoxRenderingObservable=new z,this.onResourcesReadyObservable=new z,this.enabled=!0,this.renderList=new ws(32),this._vertexBuffers={},this._fillIndexBuffer=null,this._fillIndexData=null,this.scene=e,e._addComponent(this),this._uniformBufferFront=new Se(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererFront",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferFront),this._uniformBufferBack=new Se(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererBack",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferBack)}_buildUniformLayout(e){e.addUniform("color",4),e.addUniform("world",16),e.addUniform("viewProjection",16),e.addUniform("viewProjectionR",16),e.create()}register(){this.scene._beforeEvaluateActiveMeshStage.registerStep(Me.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene._preActiveMeshStage.registerStep(Me.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this._preActiveMesh),this.scene._evaluateSubMeshStage.registerStep(Me.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this._evaluateSubMesh),this.scene._afterRenderingGroupDrawStage.registerStep(Me.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)}_evaluateSubMesh(e,t){if(e.showSubMeshesBoundingBox){const i=t.getBoundingInfo();null!=i&&(i.boundingBox._tag=e.renderingGroupId,this.renderList.push(i.boundingBox))}}_preActiveMesh(e){if(e.showBoundingBox||this.scene.forceShowBoundingBoxes){const t=e.getBoundingInfo();t.boundingBox._tag=e.renderingGroupId,this.renderList.push(t.boundingBox)}}_prepareResources(){if(this._colorShader)return;this._colorShader=new mn("colorShader",this.scene,"boundingBoxRenderer",{attributes:[A.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!1),this._colorShader.doNotSerialize=!0,this._colorShader.reservedDataStore={hidden:!0},this._colorShaderForOcclusionQuery=new mn("colorShaderOccQuery",this.scene,"boundingBoxRenderer",{attributes:[A.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!0),this._colorShaderForOcclusionQuery.doNotSerialize=!0,this._colorShaderForOcclusionQuery.reservedDataStore={hidden:!0};const e=this.scene.getEngine(),t=QE({size:1});this._vertexBuffers[A.PositionKind]=new A(e,t.positions,A.PositionKind,!1),this._createIndexBuffer(),this._fillIndexData=t.indices,this.onResourcesReadyObservable.notifyObservers(this)}_createIndexBuffer(){const e=this.scene.getEngine();this._indexBuffer=e.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}rebuild(){const e=this._vertexBuffers[A.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}reset(){this.renderList.reset()}render(e){var t,i;if(0===this.renderList.length||!this.enabled||(this._prepareResources(),!this._colorShader.isReady()))return;const s=this.scene.getEngine();s.setDepthWrite(!1);const n=this.frontColor.toColor4(),o=this.backColor.toColor4(),a=this.scene.getTransformMatrix();for(let l=0;l<this.renderList.length;l++){const c=this.renderList.data[l];if(c._tag!==e)continue;this._createWrappersForBoundingBox(c),this.onBeforeBoxRenderingObservable.notifyObservers(c);const h=c.minimum,d=c.maximum.subtract(h),f=h.add(d.scale(.5)),p=F.Scaling(d.x,d.y,d.z).multiply(F.Translation(f.x,f.y,f.z)).multiply(c.getWorldMatrix()),_=s.useReverseDepthBuffer;if(this.showBackLines){const g=null!==(t=c._drawWrapperBack)&&void 0!==t?t:this._colorShader._getDrawWrapper();this._colorShader._preBind(g),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),_?s.setDepthFunctionToLessOrEqual():s.setDepthFunctionToGreaterOrEqual(),this._uniformBufferBack.bindToEffect(g.effect,"BoundingBoxRenderer"),this._uniformBufferBack.updateDirectColor4("color",o),this._uniformBufferBack.updateMatrix("world",p),this._uniformBufferBack.updateMatrix("viewProjection",a),this._uniformBufferBack.update(),s.drawElementsType(ie.LineListDrawMode,0,24)}const m=null!==(i=c._drawWrapperFront)&&void 0!==i?i:this._colorShader._getDrawWrapper();this._colorShader._preBind(m),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),_?s.setDepthFunctionToGreater():s.setDepthFunctionToLess(),this._uniformBufferFront.bindToEffect(m.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateDirectColor4("color",n),this._uniformBufferFront.updateMatrix("world",p),this._uniformBufferFront.updateMatrix("viewProjection",a),this._uniformBufferFront.update(),s.drawElementsType(ie.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(c)}this._colorShader.unbind(),s.setDepthFunctionToLessOrEqual(),s.setDepthWrite(!0)}_createWrappersForBoundingBox(e){if(!e._drawWrapperFront){const t=this.scene.getEngine();e._drawWrapperFront=new $i(t),e._drawWrapperBack=new $i(t),e._drawWrapperFront.setEffect(this._colorShader.getEffect()),e._drawWrapperBack.setEffect(this._colorShader.getEffect())}}renderOcclusionBoundingBox(e){const t=this.scene.getEngine();void 0===this._renderPassIdForOcclusionQuery&&(this._renderPassIdForOcclusionQuery=t.createRenderPassId("Render pass for occlusion query"));const i=t.currentRenderPassId;t.currentRenderPassId=this._renderPassIdForOcclusionQuery,this._prepareResources();const s=e.subMeshes[0];if(!this._colorShaderForOcclusionQuery.isReady(e,void 0,s)||!e.hasBoundingInfo)return void(t.currentRenderPassId=i);this._fillIndexBuffer||(this._fillIndexBuffer=t.createIndexBuffer(this._fillIndexData));const n=t.useReverseDepthBuffer;t.setDepthWrite(!1),t.setColorWrite(!1);const o=e.getBoundingInfo().boundingBox,a=o.minimum,c=o.maximum.subtract(a),h=a.add(c.scale(.5)),u=F.Scaling(c.x,c.y,c.z).multiply(F.Translation(h.x,h.y,h.z)).multiply(o.getWorldMatrix()),d=s._drawWrapper;this._colorShaderForOcclusionQuery._preBind(d),t.bindBuffers(this._vertexBuffers,this._fillIndexBuffer,d.effect),n?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._uniformBufferFront.bindToEffect(d.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateMatrix("world",u),this._uniformBufferFront.updateMatrix("viewProjection",this.scene.getTransformMatrix()),this._uniformBufferFront.update(),t.drawElementsType(ie.TriangleFillMode,0,36),this._colorShaderForOcclusionQuery.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0),t.setColorWrite(!0),t.currentRenderPassId=i}dispose(){if(void 0!==this._renderPassIdForOcclusionQuery&&(this.scene.getEngine().releaseRenderPassId(this._renderPassIdForOcclusionQuery),this._renderPassIdForOcclusionQuery=void 0),!this._colorShader)return;this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this._colorShader.dispose(),this._colorShaderForOcclusionQuery.dispose(),this._uniformBufferFront.dispose(),this._uniformBufferBack.dispose();const e=this._vertexBuffers[A.PositionKind];e&&(e.dispose(),this._vertexBuffers[A.PositionKind]=null),this.scene.getEngine()._releaseBuffer(this._indexBuffer),this._fillIndexBuffer&&(this.scene.getEngine()._releaseBuffer(this._fillIndexBuffer),this._fillIndexBuffer=null)}}ge.prototype.enableDepthRenderer=function(r,e=!1,t=!1,i=3,s=!1){if(!(r=r||this.activeCamera))throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[r.id]){const n=!!this.getEngine().getCaps().textureFloatRender;let o=0;o=!this.getEngine().getCaps().textureHalfFloatRender||t&&n?n?1:0:2,this._depthRenderer[r.id]=new Jv(this,o,r,e,i,s)}return this._depthRenderer[r.id]},ge.prototype.disableDepthRenderer=function(r){(r=r||this.activeCamera)&&this._depthRenderer&&this._depthRenderer[r.id]&&this._depthRenderer[r.id].dispose()};class xle{constructor(e){this.name=Me.NAME_DEPTHRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Me.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(Me.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)}rebuild(){}dispose(){for(const e in this.scene._depthRenderer)this.scene._depthRenderer[e].dispose()}_gatherRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&!i.useOnlyInActiveCamera&&e.push(i.getDepthMap())}}_gatherActiveCameraRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&i.useOnlyInActiveCamera&&this.scene.activeCamera.id===t&&e.push(i.getDepthMap())}}}Jv._SceneComponentInitialization=r=>{let e=r._getComponent(Me.NAME_DEPTHRENDERER);e||(e=new xle(r),r._addComponent(e))};j.ShadersStore.oitFinalPixelShader="precision highp float;\nuniform sampler2D uFrontColor;\nuniform sampler2D uBackColor;\nvoid main() {\nivec2 fragCoord=ivec2(gl_FragCoord.xy);\nvec4 frontColor=texelFetch(uFrontColor,fragCoord,0);\nvec4 backColor=texelFetch(uBackColor,fragCoord,0);\nfloat alphaMultiplier=1.0-frontColor.a;\nglFragColor=vec4(\nfrontColor.rgb+alphaMultiplier*backColor.rgb,\nfrontColor.a+backColor.a\n);\n}";j.ShadersStore.oitBackBlendPixelShader="precision highp float;\nuniform sampler2D uBackColor;\nvoid main() {\nglFragColor=texelFetch(uBackColor,ivec2(gl_FragCoord.xy),0);\nif (glFragColor.a==0.0) { \ndiscard;\n}\n}";class Tle{constructor(){this.enabled=!0,this.name="depthPeeling",this.texturesRequired=[4]}}let Sle=(()=>{class r{get passCount(){return this._passCount}set passCount(t){this._passCount!==t&&(this._passCount=t,this._createRenderPassIds())}get useRenderPasses(){return this._useRenderPasses}set useRenderPasses(t){this._useRenderPasses!==t&&(this._useRenderPasses=t,this._createRenderPassIds())}addExcludedMesh(t){-1===this._excludedMeshes.indexOf(t.uniqueId)&&this._excludedMeshes.push(t.uniqueId)}removeExcludedMesh(t){const i=this._excludedMeshes.indexOf(t.uniqueId);-1!==i&&this._excludedMeshes.splice(i,1)}constructor(t,i=5){if(this._thinTextures=[],this._currentPingPongState=0,this._layoutCacheFormat=[[!0],[!0,!0],[!0,!0,!0]],this._layoutCache=[],this._candidateSubMeshes=new ws(10),this._excludedSubMeshes=new ws(10),this._excludedMeshes=[],this._colorCache=[new Te(r._DEPTH_CLEAR_VALUE,r._DEPTH_CLEAR_VALUE,0,0),new Te(-r._MIN_DEPTH,r._MAX_DEPTH,0,0),new Te(0,0,0,0)],this._scene=t,this._engine=t.getEngine(),this._passCount=i,t.enablePrePassRenderer()){for(let s=0;s<this._layoutCacheFormat.length;++s)this._layoutCache[s]=this._engine.buildTextureLayout(this._layoutCacheFormat[s]);this._renderPassIds=[],this.useRenderPasses=!1,this._prePassEffectConfiguration=new Tle,this._createTextures(),this._createEffects()}else V.Warn("Depth peeling for order independant transparency could not enable PrePass, aborting.")}_createRenderPassIds(){if(this._releaseRenderPassIds(),this._useRenderPasses)for(let t=0;t<this._passCount+1;++t)this._renderPassIds[t]||(this._renderPassIds[t]=this._engine.createRenderPassId(`DepthPeelingRenderer - pass #${t}`))}_releaseRenderPassIds(){for(let t=0;t<this._renderPassIds.length;++t)this._engine.releaseRenderPassId(this._renderPassIds[t]);this._renderPassIds=[]}_createTextures(){const t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()};this._depthMrts=[new Ah("depthPeelingDepth0",t,3,this._scene),new Ah("depthPeelingDepth1",t,3,this._scene)],this._colorMrts=[new Ah("depthPeelingColor0",t,2,this._scene,{generateDepthBuffer:!1}),new Ah("depthPeelingColor1",t,2,this._scene,{generateDepthBuffer:!1})],this._blendBackMrt=new Ah("depthPeelingBack",t,1,this._scene,{generateDepthBuffer:!1}),this._outputRT=new Ss("depthPeelingOutput",t,this._scene,!1);const i=[{format:7,samplingMode:1,type:this._engine.getCaps().textureFloatLinearFiltering?1:2},{format:5,samplingMode:1,type:2}];for(let s=0;s<2;s++){const n=this._engine._createInternalTexture(t,i[0],!1),o=this._engine._createInternalTexture(t,i[1],!1),a=this._engine._createInternalTexture(t,i[1],!1);this._depthMrts[s].setInternalTexture(n,0),this._depthMrts[s].setInternalTexture(o,1),this._depthMrts[s].setInternalTexture(a,2),this._colorMrts[s].setInternalTexture(o,0),this._colorMrts[s].setInternalTexture(a,1),this._thinTextures.push(new ih(n),new ih(o),new ih(a))}}_disposeTextures(){for(let t=0;t<this._thinTextures.length;t++)6!==t&&this._thinTextures[t].dispose();for(let t=0;t<2;t++)this._depthMrts[t].dispose(!0),this._colorMrts[t].dispose(!0),this._blendBackMrt.dispose(!0);this._outputRT.dispose(),this._thinTextures=[],this._colorMrts=[],this._depthMrts=[]}_updateTextures(){return(this._depthMrts[0].getSize().width!==this._engine.getRenderWidth()||this._depthMrts[0].getSize().height!==this._engine.getRenderHeight())&&(this._disposeTextures(),this._createTextures()),this._updateTextureReferences()}_updateTextureReferences(){var t;const i=this._scene.prePassRenderer;if(!i)return!1;const s=i.getIndex(4),n=null!==(t=i.defaultRT.textures)&&void 0!==t&&t.length?i.defaultRT.textures[s].getInternalTexture():null;return!!n&&(this._blendBackTexture!==n&&(this._blendBackTexture=n,this._blendBackMrt.setInternalTexture(this._blendBackTexture,0),this._thinTextures[6]&&this._thinTextures[6].dispose(),this._thinTextures[6]=new ih(this._blendBackTexture),i.defaultRT.renderTarget._shareDepth(this._depthMrts[0].renderTarget)),!0)}_createEffects(){this._blendBackEffectWrapper=new sl({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[]}),this._blendBackEffectWrapperPingPong=new sl({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[]}),this._finalEffectWrapper=new sl({fragmentShader:"oitFinal",useShaderStore:!0,engine:this._engine,samplerNames:["uFrontColor","uBackColor"],uniformNames:[]}),this._effectRenderer=new uv(this._engine)}setPrePassRenderer(t){t.addEffectConfiguration(this._prePassEffectConfiguration)}bind(t){t.setTexture("oitDepthSampler",this._thinTextures[3*this._currentPingPongState]),t.setTexture("oitFrontColorSampler",this._thinTextures[3*this._currentPingPongState+1])}_renderSubMeshes(t){let i;this._useRenderPasses&&(i={});for(let s=0;s<t.length;s++){const n=t.data[s].getMaterial();let o=!0,a=!1;const l=t.data[s];let c,h=!1;if(this._useRenderPasses&&(c=l._getDrawWrapper(),h=!c),n&&(o=n.allowShaderHotSwapping,a=n.backFaceCulling,n.allowShaderHotSwapping=!1,n.backFaceCulling=!1),l.render(!1),h&&(c=l._getDrawWrapper(),c.materialContext)){let u=i[c.materialContext.uniqueId];u||(u=i[c.materialContext.uniqueId]=this._engine.createMaterialContext()),l._getDrawWrapper().materialContext=u}n&&(n.allowShaderHotSwapping=o,n.backFaceCulling=a)}}_finalCompose(t){var i;(null===(i=this._scene.prePassRenderer)||void 0===i?void 0:i.setCustomOutput(this._outputRT))?this._engine.bindFramebuffer(this._outputRT.renderTarget):this._engine.restoreDefaultFramebuffer(),this._engine.setAlphaMode(0),this._engine.applyStates(),this._engine.enableEffect(this._finalEffectWrapper._drawWrapper),this._finalEffectWrapper.effect.setTexture("uFrontColor",this._thinTextures[3*t+1]),this._finalEffectWrapper.effect.setTexture("uBackColor",this._thinTextures[6]),this._effectRenderer.render(this._finalEffectWrapper)}render(t){if(this._candidateSubMeshes.length=0,this._excludedSubMeshes.length=0,!(this._blendBackEffectWrapper.effect.isReady()&&this._blendBackEffectWrapperPingPong.effect.isReady()&&this._finalEffectWrapper.effect.isReady()&&this._updateTextures()))return this._excludedSubMeshes;for(let o=0;o<t.length;o++){const a=t.data[o],l=a.getMaterial();!l||l.fillMode!==ie.TriangleFanDrawMode&&l.fillMode!==ie.TriangleFillMode&&l.fillMode!==ie.TriangleStripDrawMode||-1!==this._excludedMeshes.indexOf(a.getMesh().uniqueId)?this._excludedSubMeshes.push(a):this._candidateSubMeshes.push(a)}if(!this._candidateSubMeshes.length)return this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._finalCompose(1),this._excludedSubMeshes;const i=this._engine.currentRenderPassId;this._scene.prePassRenderer._enabled=!1,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[0]),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[1],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthMask=!1,this._engine.depthCullingState.depthTest=!0,this._engine.applyStates(),this._currentPingPongState=1,this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._scene.resetCachedMaterial();let s=0,n=0;for(let o=0;o<this._passCount;o++){s=o%2,n=1-s,this._currentPingPongState=s,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[o+1]),this._engine.bindFramebuffer(this._depthMrts[n].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[n].renderTarget),this._engine.bindFramebuffer(this._colorMrts[n].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[n].renderTarget),this._engine.bindFramebuffer(this._depthMrts[n].renderTarget),this._engine.bindAttachments(this._layoutCache[2]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthTest=!1,this._engine.applyStates(),this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[n].renderTarget),this._scene.resetCachedMaterial(),this._engine.bindFramebuffer(this._blendBackMrt.renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaEquation(0),this._engine.setAlphaMode(17),this._engine.applyStates();const a=0!==n&&this._useRenderPasses?this._blendBackEffectWrapperPingPong:this._blendBackEffectWrapper;this._engine.enableEffect(a._drawWrapper),a.effect.setTexture("uBackColor",this._thinTextures[3*n+2]),this._effectRenderer.render(a),this._engine.unBindFramebuffer(this._blendBackMrt.renderTarget)}return this._engine.currentRenderPassId=i,this._finalCompose(n),this._scene.prePassRenderer._enabled=!0,this._engine.depthCullingState.depthMask=!0,this._engine.depthCullingState.depthTest=!0,this._excludedSubMeshes}dispose(){this._disposeTextures(),this._blendBackEffectWrapper.dispose(),this._finalEffectWrapper.dispose(),this._effectRenderer.dispose(),this._releaseRenderPassIds()}}return r._DEPTH_CLEAR_VALUE=-99999,r._MIN_DEPTH=0,r._MAX_DEPTH=1,r})();Object.defineProperty(ge.prototype,"depthPeelingRenderer",{get:function(){if(!this._depthPeelingRenderer){let r=this._getComponent(Me.NAME_DEPTHPEELINGRENDERER);r||(r=new Ele(this),this._addComponent(r))}return this._depthPeelingRenderer},set:function(r){this._depthPeelingRenderer=r},enumerable:!0,configurable:!0}),Object.defineProperty(ge.prototype,"useOrderIndependentTransparency",{get:function(){return this._useOrderIndependentTransparency},set:function(r){var e;this._useOrderIndependentTransparency!==r&&(this._useOrderIndependentTransparency=r,this.markAllMaterialsAsDirty(63),null===(e=this.prePassRenderer)||void 0===e||e.markAsDirty())},enumerable:!0,configurable:!0});class Ele{constructor(e){this.name=Me.NAME_DEPTHPEELINGRENDERER,this.scene=e,e.depthPeelingRenderer=new Sle(e)}register(){}rebuild(){}dispose(){var e;null===(e=this.scene.depthPeelingRenderer)||void 0===e||e.dispose(),this.scene.depthPeelingRenderer=null}}j.ShadersStore.linePixelShader="#include<clipPlaneFragmentDeclaration>\nuniform vec4 color;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";j.ShadersStore.lineVertexShader="#include<instancesDeclaration>\n#include<clipPlaneVertexDeclaration>\nattribute vec3 position;\nattribute vec4 normal;\nuniform mat4 viewProjection;\nuniform float width;\nuniform float aspectRatio;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\nmat4 worldViewProjection=viewProjection*finalWorld;\nvec4 viewPosition=worldViewProjection*vec4(position,1.0);\nvec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);\nvec2 currentScreen=viewPosition.xy/viewPosition.w;\nvec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;\ncurrentScreen.x*=aspectRatio;\nnextScreen.x*=aspectRatio;\nvec2 dir=normalize(nextScreen-currentScreen);\nvec2 normalDir=vec2(-dir.y,dir.x);\nnormalDir*=width/2.0;\nnormalDir.x/=aspectRatio;\nvec4 offset=vec4(normalDir*normal.w,0.0,0.0);\ngl_Position=viewPosition+offset;\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nvec4 worldPos=finalWorld*vec4(position,1.0);\n#include<clipPlaneVertex>\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}",Zt.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this},Zt.prototype.enableEdgesRendering=function(r=.95,e=!1,t){return this.disableEdgesRendering(),this._edgesRenderer=new Cb(this,r,e,!0,t),this},Object.defineProperty(Zt.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0}),rc.prototype.enableEdgesRendering=function(r=.95,e=!1){return this.disableEdgesRendering(),this._edgesRenderer=new Ale(this,r,e),this},K2.prototype.enableEdgesRendering=function(r=.95,e=!1){return rc.prototype.enableEdgesRendering.apply(this,arguments),this};class Cle{constructor(){this.edges=new Array,this.edgesConnectedCount=0}}class Cb{get linesPositions(){return this._linesPositions}get linesNormals(){return this._linesNormals}get linesIndices(){return this._linesIndices}get lineShader(){return this._lineShader}set lineShader(e){this._lineShader=e}static _GetShader(e){if(!e._edgeRenderLineShader){const t=new mn("lineShader",e,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"]},!1);t.disableDepthWrite=!0,t.backFaceCulling=!1,t.checkReadyOnEveryCall=e.getEngine().isWebGPU,e._edgeRenderLineShader=t}return e._edgeRenderLineShader}constructor(e,t=.95,i=!1,s=!0,n){var o;this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=new Array,this._linesNormals=new Array,this._linesIndices=new Array,this._buffers={},this._buffersForInstances={},this._checkVerticesInsteadOfIndices=!1,this.isEnabled=!0,this.customInstances=new ws(32),this._source=e,this._checkVerticesInsteadOfIndices=i,this._options=n??null,this._epsilon=t,this._source.getScene().getEngine().isWebGPU&&(this._drawWrapper=new $i(e.getEngine())),this._prepareRessources(),s&&(null===(o=n?.useAlternateEdgeFinder)||void 0===o||o?this._generateEdgesLinesAlternate():this._generateEdgesLines()),this._meshRebuildObserver=this._source.onRebuildObservable.add(()=>{this._rebuild()}),this._meshDisposeObserver=this._source.onDisposeObservable.add(()=>{this.dispose()})}_prepareRessources(){this._lineShader||(this._lineShader=Cb._GetShader(this._source.getScene()))}_rebuild(){let e=this._buffers[A.PositionKind];e&&e._rebuild(),e=this._buffers[A.NormalKind],e&&e._rebuild();const i=this._source.getScene().getEngine();this._ib=i.createIndexBuffer(this._linesIndices)}dispose(){var e;this._source.onRebuildObservable.remove(this._meshRebuildObserver),this._source.onDisposeObservable.remove(this._meshDisposeObserver);let t=this._buffers[A.PositionKind];t&&(t.dispose(),this._buffers[A.PositionKind]=null),t=this._buffers[A.NormalKind],t&&(t.dispose(),this._buffers[A.NormalKind]=null),this._ib&&this._source.getScene().getEngine()._releaseBuffer(this._ib),this._lineShader.dispose(),null===(e=this._drawWrapper)||void 0===e||e.dispose()}_processEdgeForAdjacencies(e,t,i,s,n){return e===i&&t===s||e===s&&t===i?0:e===s&&t===n||e===n&&t===s?1:e===n&&t===i||e===i&&t===n?2:-1}_processEdgeForAdjacenciesWithVertices(e,t,i,s,n){return e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(s,1e-10)||e.equalsWithEpsilon(s,1e-10)&&t.equalsWithEpsilon(i,1e-10)?0:e.equalsWithEpsilon(s,1e-10)&&t.equalsWithEpsilon(n,1e-10)||e.equalsWithEpsilon(n,1e-10)&&t.equalsWithEpsilon(s,1e-10)?1:e.equalsWithEpsilon(n,1e-10)&&t.equalsWithEpsilon(i,1e-10)||e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(n,1e-10)?2:-1}_checkEdge(e,t,i,s,n){let o;o=void 0===t||v.Dot(i[e],i[t])<this._epsilon,o&&this.createLine(s,n,this._linesPositions.length/3)}createLine(e,t,i){this._linesPositions.push(e.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,t.z,t.x,t.y,t.z),this._linesNormals.push(t.x,t.y,t.z,-1,t.x,t.y,t.z,1,e.x,e.y,e.z,-1,e.x,e.y,e.z,1),this._linesIndices.push(i,i+1,i+2,i,i+2,i+3)}_tessellateTriangle(e,t,i,s){const n=(D,P,M)=>{M>=0&&P.push(M);for(let w=0;w<D.length;++w)P.push(D[w][0])};let o=0;e[1].length>=e[0].length&&e[1].length>=e[2].length?o=1:e[2].length>=e[0].length&&e[2].length>=e[1].length&&(o=2);for(let D=0;D<3;++D)e[D].sort(D===o?(P,M)=>P[1]<M[1]?-1:P[1]>M[1]?1:0:(P,M)=>P[1]>M[1]?-1:P[1]<M[1]?1:0);const a=[],l=[];n(e[o],a,-1);const c=a.length;for(let D=o+2;D>=o+1;--D)n(e[D%3],l,D!==o+2?s[i[t+(D+1)%3]]:-1);const h=l.length;i.push(s[i[t+o]],a[0],l[0]),i.push(s[i[t+(o+1)%3]],l[h-1],a[c-1]);const f=c<=h,p=f?c:h,_=f?h:c,m=f?c-1:h-1,g=f?0:1;let b=c+h-2,y=0,T=0;const x=f?a:l,S=f?l:a;let C=0;for(;b-- >0;){let D;g?i.push(x[y],S[T]):i.push(S[T],x[y]),C+=p,C>=_&&y<m?(D=x[++y],C-=_):D=S[++T],i.push(D)}i[t+0]=i[i.length-3],i[t+1]=i[i.length-2],i[t+2]=i[i.length-1],i.length=i.length-3}_generateEdgesLinesAlternate(){var e,t,i,s,n,o,a,l,c,h;const u=this._source.getVerticesData(A.PositionKind);let d=this._source.getIndices();if(!d||!u)return;Array.isArray(d)||(d=Array.from(d));const f=null===(t=null===(e=this._options)||void 0===e?void 0:e.useFastVertexMerger)||void 0===t||t,p=f?Math.round(-Math.log(null!==(s=null===(i=this._options)||void 0===i?void 0:i.epsilonVertexMerge)&&void 0!==s?s:1e-6)/Math.log(10)):null!==(o=null===(n=this._options)||void 0===n?void 0:n.epsilonVertexMerge)&&void 0!==o?o:1e-6,_=[],m=[];if(f){const y={};for(let T=0;T<u.length;T+=3){const S=u[T+1],C=u[T+2],D=u[T+0].toFixed(p)+"|"+S.toFixed(p)+"|"+C.toFixed(p);if(void 0!==y[D])_.push(y[D]);else{const P=T/3;y[D]=P,_.push(P),m.push(P)}}}else for(let y=0;y<u.length;y+=3){const T=u[y+0],x=u[y+1],S=u[y+2];let C=!1;for(let D=0;D<y&&!C;D+=3){const M=u[D+1],w=u[D+2];if(Math.abs(T-u[D+0])<p&&Math.abs(x-M)<p&&Math.abs(S-w)<p){_.push(D/3),C=!0;break}}C||(_.push(y/3),m.push(y/3))}if(null!==(a=this._options)&&void 0!==a&&a.applyTessellation){const y=null!==(c=null===(l=this._options)||void 0===l?void 0:l.epsilonVertexAligned)&&void 0!==c?c:1e-6,T=[];for(let x=0;x<d.length;x+=3){let S;for(let C=0;C<3;++C){const D=_[d[x+C]],P=_[d[x+(C+1)%3]],M=_[d[x+(C+2)%3]];if(D===P)continue;const w=u[3*D+0],k=u[3*D+1],X=u[3*D+2],te=u[3*P+0],J=u[3*P+1],Q=u[3*P+2],me=Math.sqrt((te-w)*(te-w)+(J-k)*(J-k)+(Q-X)*(Q-X));for(let ae=0;ae<m.length-1;ae++){const W=m[ae];if(W===D||W===P||W===M)continue;const K=u[3*W+0],O=u[3*W+1],H=u[3*W+2],Y=Math.sqrt((K-w)*(K-w)+(O-k)*(O-k)+(H-X)*(H-X)),he=Math.sqrt((K-te)*(K-te)+(O-J)*(O-J)+(H-Q)*(H-Q));Math.abs(Y+he-me)<y&&(S||(S={index:x,edgesPoints:[[],[],[]]},T.push(S)),S.edgesPoints[C].push([W,Y]))}}}for(let x=0;x<T.length;++x){const S=T[x];this._tessellateTriangle(S.edgesPoints,S.index,d,_)}T.length=0}const g={};for(let y=0;y<d.length;y+=3){let T;for(let x=0;x<3;++x){let S=_[d[y+x]],C=_[d[y+(x+1)%3]];const D=_[d[y+(x+2)%3]];if(S===C||(S===D||C===D)&&(null===(h=this._options)||void 0===h?void 0:h.removeDegeneratedTriangles))continue;if(L.Vector3[0].copyFromFloats(u[3*S+0],u[3*S+1],u[3*S+2]),L.Vector3[1].copyFromFloats(u[3*C+0],u[3*C+1],u[3*C+2]),L.Vector3[2].copyFromFloats(u[3*D+0],u[3*D+1],u[3*D+2]),T||(L.Vector3[1].subtractToRef(L.Vector3[0],L.Vector3[3]),L.Vector3[2].subtractToRef(L.Vector3[1],L.Vector3[4]),T=v.Cross(L.Vector3[3],L.Vector3[4]),T.normalize()),S>C){const w=S;S=C,C=w}const P=S+"_"+C,M=g[P];M?M.done||(v.Dot(T,M.normal)<this._epsilon&&this.createLine(L.Vector3[0],L.Vector3[1],this._linesPositions.length/3),M.done=!0):g[P]={normal:T,done:!1,index:y,i:x}}}for(const y in g){const T=g[y];if(!T.done){const x=_[d[T.index+T.i]],S=_[d[T.index+(T.i+1)%3]];L.Vector3[0].copyFromFloats(u[3*x+0],u[3*x+1],u[3*x+2]),L.Vector3[1].copyFromFloats(u[3*S+0],u[3*S+1],u[3*S+2]),this.createLine(L.Vector3[0],L.Vector3[1],this._linesPositions.length/3)}}const b=this._source.getScene().getEngine();this._buffers[A.PositionKind]=new A(b,this._linesPositions,A.PositionKind,!1),this._buffers[A.NormalKind]=new A(b,this._linesNormals,A.NormalKind,!1,!1,4),this._buffersForInstances[A.PositionKind]=this._buffers[A.PositionKind],this._buffersForInstances[A.NormalKind]=this._buffers[A.NormalKind],this._ib=b.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}_generateEdgesLines(){const e=this._source.getVerticesData(A.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=new Array,s=new Array;let n,o;for(n=0;n<t.length;n+=3){o=new Cle;const l=t[n],c=t[n+1],h=t[n+2];o.p0=new v(e[3*l],e[3*l+1],e[3*l+2]),o.p1=new v(e[3*c],e[3*c+1],e[3*c+2]),o.p2=new v(e[3*h],e[3*h+1],e[3*h+2]);const u=v.Cross(o.p1.subtract(o.p0),o.p2.subtract(o.p1));u.normalize(),s.push(u),i.push(o)}for(n=0;n<i.length;n++){o=i[n];for(let l=n+1;l<i.length;l++){const c=i[l];if(3===o.edgesConnectedCount)break;if(3===c.edgesConnectedCount)continue;const h=t[3*l],u=t[3*l+1],d=t[3*l+2];for(let f=0;f<3;f++){let p=0;if(void 0===o.edges[f]){switch(f){case 0:p=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(o.p0,o.p1,c.p0,c.p1,c.p2):this._processEdgeForAdjacencies(t[3*n],t[3*n+1],h,u,d);break;case 1:p=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(o.p1,o.p2,c.p0,c.p1,c.p2):this._processEdgeForAdjacencies(t[3*n+1],t[3*n+2],h,u,d);break;case 2:p=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(o.p2,o.p0,c.p0,c.p1,c.p2):this._processEdgeForAdjacencies(t[3*n+2],t[3*n],h,u,d)}if(-1!==p&&(o.edges[f]=l,c.edges[p]=n,o.edgesConnectedCount++,c.edgesConnectedCount++,3===o.edgesConnectedCount))break}}}}for(n=0;n<i.length;n++){const l=i[n];this._checkEdge(n,l.edges[0],s,l.p0,l.p1),this._checkEdge(n,l.edges[1],s,l.p1,l.p2),this._checkEdge(n,l.edges[2],s,l.p2,l.p0)}const a=this._source.getScene().getEngine();this._buffers[A.PositionKind]=new A(a,this._linesPositions,A.PositionKind,!1),this._buffers[A.NormalKind]=new A(a,this._linesNormals,A.NormalKind,!1,!1,4),this._buffersForInstances[A.PositionKind]=this._buffers[A.PositionKind],this._buffersForInstances[A.NormalKind]=this._buffers[A.NormalKind],this._ib=a.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}isReady(){return this._lineShader.isReady(this._source,this._source.hasInstances&&this.customInstances.length>0||this._source.hasThinInstances)}render(){const e=this._source.getScene(),t=this._lineShader._getDrawWrapper();if(this._drawWrapper&&this._lineShader._setDrawWrapper(this._drawWrapper),!this.isReady()||!e.activeCamera)return void this._lineShader._setDrawWrapper(t);const i=this._source.hasInstances&&this.customInstances.length>0,s=i||this._source.hasThinInstances;let n=0;if(s)if(this._buffersForInstances.world0=this._source.getVertexBuffer("world0"),this._buffersForInstances.world1=this._source.getVertexBuffer("world1"),this._buffersForInstances.world2=this._source.getVertexBuffer("world2"),this._buffersForInstances.world3=this._source.getVertexBuffer("world3"),i){const a=this._source._instanceDataStorage;if(n=this.customInstances.length,!a.instancesData)return void(this._source.getScene()._activeMeshesFrozen||this.customInstances.reset());if(!a.isFrozen){let l=0;for(let c=0;c<n;++c)this.customInstances.data[c].copyToArray(a.instancesData,l),l+=16;a.instancesBuffer.updateDirectly(a.instancesData,0,n)}}else n=this._source.thinInstanceCount;const o=e.getEngine();this._lineShader._preBind(),o.setAlphaMode(1!==this._source.edgesColor.a?2:0),o.bindBuffers(s?this._buffersForInstances:this._buffers,this._ib,this._lineShader.getEffect()),e.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),this._lineShader.setFloat("width",e.activeCamera.mode===ve.ORTHOGRAPHIC_CAMERA?this._source.edgesWidth/this.edgesWidthScalerForOrthographic:this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",o.getAspectRatio(e.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix()),o.drawElementsType(ie.TriangleFillMode,0,this._indicesCount,n),this._lineShader.unbind(),s&&o.unbindInstanceAttributes(),this._source.getScene()._activeMeshesFrozen||this.customInstances.reset(),this._lineShader._setDrawWrapper(t)}}class Ale extends Cb{constructor(e,t=.95,i=!1){super(e,t,i,!1),this._generateEdgesLines()}_generateEdgesLines(){const e=this._source.getVerticesData(A.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=L.Vector3[0],s=L.Vector3[1],n=t.length-1;for(let a=0,l=0;a<n;a+=2,l+=4)v.FromArrayToRef(e,3*t[a],i),v.FromArrayToRef(e,3*t[a+1],s),this.createLine(i,s,l);const o=this._source.getScene().getEngine();this._buffers[A.PositionKind]=new A(o,this._linesPositions,A.PositionKind,!1),this._buffers[A.NormalKind]=new A(o,this._linesNormals,A.NormalKind,!1,!1,4),this._ib=o.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}}class Rle extends Ah{constructor(e,t,i,s,n,o){super(e,i,s,n,o),this._beforeCompositionPostProcesses=[],this._internalTextureDirty=!1,this.enabled=!1,this.renderTargetTexture=null,this.renderTargetTexture=t}_createCompositionEffect(){this.imageProcessingPostProcess=new Av("prePassComposition",1,null,void 0,this._engine),this.imageProcessingPostProcess._updateParameters()}_checkSize(){const e=this._engine.getRenderWidth(!0),t=this._engine.getRenderHeight(!0),i=this.getRenderWidth(),s=this.getRenderHeight();(i!==e||s!==t)&&(this.resize({width:e,height:t}),this._internalTextureDirty=!0)}updateCount(e,t,i){super.updateCount(e,t,i),this._internalTextureDirty=!0}_resetPostProcessChain(){this._beforeCompositionPostProcesses.length=0}dispose(){const e=this._scene;if(super.dispose(),e&&e.prePassRenderer){const t=e.prePassRenderer.renderTargets.indexOf(this);-1!==t&&e.prePassRenderer.renderTargets.splice(t,1)}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose(),this.renderTargetTexture&&(this.renderTargetTexture._prePassRenderTarget=null),this._outputPostProcess&&(this._outputPostProcess.autoClear=!0,this._outputPostProcess.restoreDefaultInputTexture())}}let FH=(()=>{class r{getIndex(t){return this._textureIndices[t]}get samples(){return this.defaultRT.samples}set samples(t){this.defaultRT.samples=t}get useSpecificClearForDepthTexture(){return this._useSpecificClearForDepthTexture}set useSpecificClearForDepthTexture(t){this._useSpecificClearForDepthTexture!==t&&(this._useSpecificClearForDepthTexture=t,this._isDirty=!0)}getRenderTarget(){return this._currentTarget}_setRenderTarget(t){t?this._currentTarget=t:(this._currentTarget=this.defaultRT,this._engine.currentRenderPassId=this._currentTarget.renderPassId)}get currentRTisSceneRT(){return this._currentTarget===this.defaultRT}_refreshGeometryBufferRendererLink(){if(this.doNotUseGeometryRendererFallback)this._geometryBuffer&&this._geometryBuffer._unlinkPrePassRenderer(),this._geometryBuffer=null,this._scene.disableGeometryBufferRenderer();else{if(this._geometryBuffer=this._scene.enableGeometryBufferRenderer(),!this._geometryBuffer)return void(this.doNotUseGeometryRendererFallback=!0);this._geometryBuffer._linkPrePassRenderer(this)}}get enabled(){return this._enabled}constructor(t){this.excludedSkinnedMesh=[],this.excludedMaterials=[],this.mrtCount=0,this._mrtTypes=[],this._mrtLayout=[],this._mrtNames=[],this._textureIndices=[],this._useSpecificClearForDepthTexture=!1,this._isDirty=!0,this._effectConfigurations=[],this.doNotUseGeometryRendererFallback=!0,this.renderTargets=[],this._clearColor=new Te(0,0,0,0),this._clearDepthColor=new Te(1e8,0,0,1),this._enabled=!1,this._needsCompositionForThisPass=!1,this.disableGammaTransform=!1,this._scene=t,this._engine=t.getEngine();let i=0;if(this._engine._caps.textureFloat&&this._engine._caps.textureFloatLinearFiltering?i=1:this._engine._caps.textureHalfFloat&&this._engine._caps.textureHalfFloatLinearFiltering&&(i=2),1!==i)for(let s=0;s<r.TextureFormats.length;++s)1===r.TextureFormats[s].type&&(r.TextureFormats[5].type=i);r._SceneComponentInitialization(this._scene),this.defaultRT=this._createRenderTarget("sceneprePassRT",null),this._currentTarget=this.defaultRT}_createRenderTarget(t,i){const s=new Rle(t,i,{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},0,this._scene,{generateMipMaps:!1,generateStencilBuffer:this._engine.isStencilEnable,defaultType:0,types:[],drawOnlyOnFirstAttachmentByDefault:!0});return this.renderTargets.push(s),s}get isSupported(){return this._scene.getEngine().getCaps().drawBuffersExtension}bindAttachmentsForEffect(t,i){const s=i.getMaterial(),n=s&&s.isPrePassCapable,o=s&&-1!==this.excludedMaterials.indexOf(s);this.enabled&&this._currentTarget.enabled&&(t._multiTarget&&n&&!o?this._engine.bindAttachments(this._multiRenderAttachments):(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment(),this._geometryBuffer&&this.currentRTisSceneRT&&!o&&this._geometryBuffer.renderList.push(i.getRenderingMesh())))}_reinitializeAttachments(){const t=[],i=[!1],s=[!1],n=[!0];for(let o=0;o<this.mrtCount;o++)t.push(!0),o>0&&(this._useSpecificClearForDepthTexture&&5===this._mrtLayout[o]?(i.push(!1),s.push(!0)):(i.push(!0),s.push(!1)),n.push(!1));this._multiRenderAttachments=this._engine.buildTextureLayout(t),this._clearAttachments=this._engine.buildTextureLayout(i),this._clearDepthAttachments=this._engine.buildTextureLayout(s),this._defaultAttachments=this._engine.buildTextureLayout(n)}_resetLayout(){for(let t=0;t<r.TextureFormats.length;t++)this._textureIndices[r.TextureFormats[t].purpose]=-1;this._textureIndices[4]=0,this._mrtLayout=[4],this._mrtTypes=[r.TextureFormats[4].type],this._mrtNames=[r.TextureFormats[4].name],this.mrtCount=1}_updateGeometryBufferLayout(){if(this._refreshGeometryBufferRendererLink(),this._geometryBuffer){this._geometryBuffer._resetLayout();const t=[];for(let s=0;s<this._mrtLayout.length;s++)t.push(!1);this._geometryBuffer._linkInternalTexture(this.defaultRT.getInternalTexture());const i=[{prePassConstant:5,geometryBufferConstant:Zn.DEPTH_TEXTURE_TYPE},{prePassConstant:6,geometryBufferConstant:Zn.NORMAL_TEXTURE_TYPE},{prePassConstant:1,geometryBufferConstant:Zn.POSITION_TEXTURE_TYPE},{prePassConstant:3,geometryBufferConstant:Zn.REFLECTIVITY_TEXTURE_TYPE},{prePassConstant:2,geometryBufferConstant:Zn.VELOCITY_TEXTURE_TYPE}];for(let s=0;s<i.length;s++){const n=this._mrtLayout.indexOf(i[s].prePassConstant);-1!==n&&(this._geometryBuffer._forceTextureType(i[s].geometryBufferConstant,n),t[n]=!0)}this._geometryBuffer._setAttachments(this._engine.buildTextureLayout(t))}}restoreAttachments(){this.enabled&&this._currentTarget.enabled&&this._defaultAttachments&&(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment())}_beforeDraw(t,i,s){this._isDirty&&this._update(),this._enabled&&this._currentTarget.enabled&&(this._geometryBuffer&&(this._geometryBuffer.renderList=[]),this._setupOutputForThisPass(this._currentTarget,t))}_prepareFrame(t,i,s){t.renderTargetTexture?t.renderTargetTexture._prepareFrame(this._scene,i,s,t.renderTargetTexture.useCameraPostProcesses):this._postProcessesSourceForThisPass.length?this._scene.postProcessManager._prepareFrame():this._engine.restoreDefaultFramebuffer()}setCustomOutput(t){const i=this._postProcessesSourceForThisPass[0];return!!i&&(i.inputTexture=t.renderTarget,!0)}_renderPostProcesses(t,i){var s;const n=this._postProcessesSourceForThisPass[0],o=n?n.inputTexture:t.renderTargetTexture?t.renderTargetTexture.renderTarget:null;let a=this._currentTarget._beforeCompositionPostProcesses;this._needsCompositionForThisPass&&(a=a.concat([this._currentTarget.imageProcessingPostProcess])),a.length&&(this._scene.postProcessManager._prepareFrame(null===(s=this._currentTarget.renderTarget)||void 0===s?void 0:s.texture,a),this._scene.postProcessManager.directRender(a,o,!1,i))}_afterDraw(t,i){this._enabled&&this._currentTarget.enabled&&(this._prepareFrame(this._currentTarget,t,i),this._renderPostProcesses(this._currentTarget,t))}_clear(){this._enabled&&this._currentTarget.enabled&&(this._bindFrameBuffer(this._currentTarget),this._engine.bindAttachments(this._clearAttachments),this._engine.clear(this._clearColor,!0,!1,!1),this._useSpecificClearForDepthTexture&&(this._engine.bindAttachments(this._clearDepthAttachments),this._engine.clear(this._clearDepthColor,!0,!1,!1)),this._engine.bindAttachments(this._defaultAttachments))}_bindFrameBuffer(t){if(this._enabled&&this._currentTarget.enabled){this._currentTarget._checkSize();const i=this._currentTarget.renderTarget;i&&this._engine.bindFramebuffer(i)}}_setEnabled(t){this._enabled=t}_setRenderTargetEnabled(t,i){t.enabled=i,i||this._unlinkInternalTexture(t)}addEffectConfiguration(t){for(let i=0;i<this._effectConfigurations.length;i++)if(this._effectConfigurations[i].name===t.name)return this._effectConfigurations[i];return this._effectConfigurations.push(t),t}_enable(){const t=this.mrtCount;for(let i=0;i<this._effectConfigurations.length;i++)this._effectConfigurations[i].enabled&&this._enableTextures(this._effectConfigurations[i].texturesRequired);for(let i=0;i<this.renderTargets.length;i++){(this.mrtCount!==t||this.renderTargets[i].count!==this.mrtCount)&&this.renderTargets[i].updateCount(this.mrtCount,{types:this._mrtTypes},this._mrtNames.concat("prePass_DepthBuffer")),this.renderTargets[i]._resetPostProcessChain();for(let s=0;s<this._effectConfigurations.length;s++)this._effectConfigurations[s].enabled&&(!this._effectConfigurations[s].postProcess&&this._effectConfigurations[s].createPostProcess&&this._effectConfigurations[s].createPostProcess(),this._effectConfigurations[s].postProcess&&this.renderTargets[i]._beforeCompositionPostProcesses.push(this._effectConfigurations[s].postProcess))}this._reinitializeAttachments(),this._setEnabled(!0),this._updateGeometryBufferLayout()}_disable(){this._setEnabled(!1);for(let t=0;t<this.renderTargets.length;t++)this._setRenderTargetEnabled(this.renderTargets[t],!1);this._resetLayout();for(let t=0;t<this._effectConfigurations.length;t++)this._effectConfigurations[t].enabled=!1}_getPostProcessesSource(t,i){if(i)return i._postProcesses;if(t.renderTargetTexture){if(t.renderTargetTexture.useCameraPostProcesses){const s=t.renderTargetTexture.activeCamera?t.renderTargetTexture.activeCamera:this._scene.activeCamera;return s?s._postProcesses:[]}return t.renderTargetTexture.postProcesses?t.renderTargetTexture.postProcesses:[]}return this._scene.activeCamera?this._scene.activeCamera._postProcesses:[]}_setupOutputForThisPass(t,i){const s=i&&this._scene.activeCameras&&!!this._scene.activeCameras.length&&0!==this._scene.activeCameras.indexOf(i);this._postProcessesSourceForThisPass=this._getPostProcessesSource(t,i),this._postProcessesSourceForThisPass=this._postProcessesSourceForThisPass.filter(c=>null!=c),this._scene.autoClear=!0;const n=this._hasImageProcessing(this._postProcessesSourceForThisPass);this._needsCompositionForThisPass=!n&&!this.disableGammaTransform&&this._needsImageProcessing()&&!s;const o=this._getFirstPostProcess(this._postProcessesSourceForThisPass),a=t._beforeCompositionPostProcesses&&t._beforeCompositionPostProcesses[0];let l=null;this._scene.imageProcessingConfiguration.applyByPostProcess=this._needsCompositionForThisPass||n,this._needsCompositionForThisPass&&!t.imageProcessingPostProcess&&t._createCompositionEffect(),a?l=a:this._needsCompositionForThisPass?l=t.imageProcessingPostProcess:o&&(l=o),this._bindFrameBuffer(t),this._linkInternalTexture(t,l)}_linkInternalTexture(t,i){i&&(i.autoClear=!1,i.inputTexture=t.renderTarget),t._outputPostProcess!==i&&(t._outputPostProcess&&this._unlinkInternalTexture(t),t._outputPostProcess=i),t._internalTextureDirty&&(this._updateGeometryBufferLayout(),t._internalTextureDirty=!1)}_unlinkInternalTexture(t){t._outputPostProcess&&(t._outputPostProcess.autoClear=!0,t._outputPostProcess.restoreDefaultInputTexture(),t._outputPostProcess=null)}_needsImageProcessing(){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].enabled&&this._effectConfigurations[t].needsImageProcessing)return!0;return!1}_hasImageProcessing(t){var i;let s=!1;if(t)for(let n=0;n<t.length;n++)if("ImageProcessingPostProcess"===(null===(i=t[n])||void 0===i?void 0:i.getClassName())){s=!0;break}return s}_getFirstPostProcess(t){for(let i=0;i<t.length;i++)if(null!==t[i])return t[i];return null}markAsDirty(){this._isDirty=!0}_enableTextures(t){this._scene.needsPreviousWorldMatrices=!1;for(let i=0;i<t.length;i++){const s=t[i];-1===this._textureIndices[s]&&(this._textureIndices[s]=this._mrtLayout.length,this._mrtLayout.push(s),this._mrtTypes.push(r.TextureFormats[s].type),this._mrtNames.push(r.TextureFormats[s].name),this.mrtCount++),2===s&&(this._scene.needsPreviousWorldMatrices=!0)}}_update(){this._disable();let i,t=!1;this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._scene._depthPeelingRenderer&&this._scene.useOrderIndependentTransparency&&(this._scene._depthPeelingRenderer.setPrePassRenderer(this),t=!0);for(let s=0;s<this._scene.materials.length;s++)this._scene.materials[s].setPrePassRenderer(this)&&(t=!0);t&&this._setRenderTargetEnabled(this.defaultRT,!0);for(let s=0;s<this.renderTargets.length;s++){if(this.renderTargets[s].renderTargetTexture)i=this._getPostProcessesSource(this.renderTargets[s]);else{const n=this._scene.activeCamera;if(!n)continue;i=n._postProcesses}if(i&&(i=i.filter(n=>null!=n),i)){for(let n=0;n<i.length;n++)i[n].setPrePassRenderer(this)&&(this._setRenderTargetEnabled(this.renderTargets[s],!0),t=!0);this._hasImageProcessing(i)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!0)}}this._markAllMaterialsAsPrePassDirty(),this._isDirty=!1,t&&this._enable()}_markAllMaterialsAsPrePassDirty(){const t=this._scene.materials;for(let i=0;i<t.length;i++)t[i].markAsDirty(ie.PrePassDirtyFlag)}dispose(){for(let t=this.renderTargets.length-1;t>=0;t--)this.renderTargets[t].dispose();for(let t=0;t<this._effectConfigurations.length;t++)this._effectConfigurations[t].dispose&&this._effectConfigurations[t].dispose()}}return r._SceneComponentInitialization=e=>{throw Ge("PrePassRendererSceneComponent")},r.TextureFormats=[{purpose:0,type:2,name:"prePass_Irradiance"},{purpose:1,type:2,name:"prePass_Position"},{purpose:2,type:0,name:"prePass_Velocity"},{purpose:3,type:0,name:"prePass_Reflectivity"},{purpose:4,type:2,name:"prePass_Color"},{purpose:5,type:1,name:"prePass_Depth"},{purpose:6,type:2,name:"prePass_Normal"},{purpose:7,type:0,name:"prePass_Albedo"}],r})();Object.defineProperty(ge.prototype,"prePassRenderer",{get:function(){return this._prePassRenderer},set:function(r){r&&r.isSupported&&(this._prePassRenderer=r)},enumerable:!0,configurable:!0}),ge.prototype.enablePrePassRenderer=function(){return this._prePassRenderer||(this._prePassRenderer=new FH(this),this._prePassRenderer.isSupported||(this._prePassRenderer=null,V.Error("PrePassRenderer needs WebGL 2 support.\nMaybe you tried to use the following features that need the PrePassRenderer :\n + Subsurface Scattering"))),this._prePassRenderer},ge.prototype.disablePrePassRenderer=function(){!this._prePassRenderer||(this._prePassRenderer.dispose(),this._prePassRenderer=null)};class Ile{constructor(e){this.name=Me.NAME_PREPASSRENDERER,this.scene=e}register(){this.scene._beforeCameraDrawStage.registerStep(Me.STEP_BEFORECAMERADRAW_PREPASS,this,this._beforeCameraDraw),this.scene._afterCameraDrawStage.registerStep(Me.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterCameraDraw),this.scene._beforeRenderTargetDrawStage.registerStep(Me.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this._beforeRenderTargetDraw),this.scene._afterRenderTargetDrawStage.registerStep(Me.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterRenderTargetDraw),this.scene._beforeClearStage.registerStep(Me.STEP_BEFORECLEAR_PREPASS,this,this._beforeClearStage),this.scene._beforeRenderTargetClearStage.registerStep(Me.STEP_BEFORERENDERTARGETCLEAR_PREPASS,this,this._beforeRenderTargetClearStage),this.scene._beforeRenderingMeshStage.registerStep(Me.STEP_BEFORERENDERINGMESH_PREPASS,this,this._beforeRenderingMeshStage),this.scene._afterRenderingMeshStage.registerStep(Me.STEP_AFTERRENDERINGMESH_PREPASS,this,this._afterRenderingMeshStage)}_beforeRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._beforeDraw(void 0,t,i))}_afterRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&this.scene.prePassRenderer._afterDraw(t,i)}_beforeRenderTargetClearStage(e){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(e._prePassRenderTarget||(e._prePassRenderTarget=this.scene.prePassRenderer._createRenderTarget(e.name+"_prePassRTT",e)),this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._clear())}_beforeCameraDraw(e){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._beforeDraw(e))}_afterCameraDraw(){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw()}_beforeClearStage(){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._clear())}_beforeRenderingMeshStage(e,t,i,s){if(!s)return;const n=e.getScene();n.prePassRenderer&&n.prePassRenderer.bindAttachmentsForEffect(s,t)}_afterRenderingMeshStage(e){const t=e.getScene();t.prePassRenderer&&t.prePassRenderer.restoreAttachments()}rebuild(){this.scene.disablePrePassRenderer(),this.scene.enablePrePassRenderer()}dispose(){this.scene.disablePrePassRenderer()}}FH._SceneComponentInitialization=r=>{let e=r._getComponent(Me.NAME_PREPASSRENDERER);e||(e=new Ile(r),r._addComponent(e))};j.IncludesShadersStore.fibonacci="#define rcp(x) 1./x\n#define GOLDEN_RATIO 1.618033988749895\n#define TWO_PI 6.2831855\nvec2 Golden2dSeq(int i,float n)\n{\nreturn vec2(float(i)/n+(0.5/n),fract(float(i)*rcp(GOLDEN_RATIO)));\n}\nvec2 SampleDiskGolden(int i,int sampleCount)\n{\nvec2 f=Golden2dSeq(i,float(sampleCount));\nreturn vec2(sqrt(f.x),TWO_PI*f.y);\n}";j.IncludesShadersStore.diffusionProfile="uniform vec3 diffusionS[5];\nuniform float diffusionD[5];\nuniform float filterRadii[5];";j.ShadersStore.subSurfaceScatteringPixelShader="#include<fibonacci>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<diffusionProfile>\nvarying vec2 vUV;\nuniform vec2 texelSize;\nuniform sampler2D textureSampler;\nuniform sampler2D irradianceSampler;\nuniform sampler2D depthSampler;\nuniform sampler2D albedoSampler;\nuniform vec2 viewportSize;\nuniform float metersPerUnit;\nconst float LOG2_E=1.4426950408889634;\nconst float SSS_PIXELS_PER_SAMPLE=4.;\nconst int _SssSampleBudget=40;\n#define rcp(x) 1./x\n#define Sq(x) x*x\n#define SSS_BILATERAL_FILTER true\nvec3 EvalBurleyDiffusionProfile(float r,vec3 S)\n{\nvec3 exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S); \nvec3 expSum=exp_13*(1.+exp_13*exp_13); \nreturn (S*rcp(8.*PI))*expSum; \n}\nvec2 SampleBurleyDiffusionProfile(float u,float rcpS)\n{\nu=1.-u; \nfloat g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));\nfloat n=exp2(log2(g)*(-1.0/3.0)); \nfloat p=(g*n)*n; \nfloat c=1.+p+n; \nfloat d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u); \nfloat x=(3./LOG2_E)*log2(c)-d; \nfloat rcpExp=((c*c)*c)*rcp((4.*u)*((c*c)+(4.*u)*(4.*u)));\nfloat r=x*rcpS;\nfloat rcpPdf=(8.*PI*rcpS)*rcpExp; \nreturn vec2(r,rcpPdf);\n}\nvec3 ComputeBilateralWeight(float xy2,float z,float mmPerUnit,vec3 S,float rcpPdf)\n{\n#ifndef SSS_BILATERAL_FILTER\nz=0.;\n#endif\nfloat r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));\nfloat area=rcpPdf;\n#if SSS_CLAMP_ARTIFACT\nreturn clamp(EvalBurleyDiffusionProfile(r,S)*area,0.0,1.0);\n#else\nreturn EvalBurleyDiffusionProfile(r,S)*area;\n#endif\n}\nvoid EvaluateSample(int i,int n,vec3 S,float d,vec3 centerPosVS,float mmPerUnit,float pixelsPerMm,\nfloat phase,inout vec3 totalIrradiance,inout vec3 totalWeight)\n{\nfloat scale =rcp(float(n));\nfloat offset=rcp(float(n))*0.5;\nfloat sinPhase,cosPhase;\nsinPhase=sin(phase);\ncosPhase=cos(phase);\nvec2 bdp=SampleBurleyDiffusionProfile(float(i)*scale+offset,d);\nfloat r=bdp.x;\nfloat rcpPdf=bdp.y;\nfloat phi=SampleDiskGolden(i,n).y;\nfloat sinPhi,cosPhi;\nsinPhi=sin(phi);\ncosPhi=cos(phi);\nfloat sinPsi=cosPhase*sinPhi+sinPhase*cosPhi; \nfloat cosPsi=cosPhase*cosPhi-sinPhase*sinPhi; \nvec2 vec=r*vec2(cosPsi,sinPsi);\nvec2 position; \nfloat xy2;\nposition=vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*texelSize;\nxy2 =r*r;\nvec4 textureSample=texture2D(irradianceSampler,position);\nfloat viewZ=texture2D(depthSampler,position).r;\nvec3 irradiance =textureSample.rgb;\nif (testLightingForSSS(textureSample.a))\n{\nfloat relZ=viewZ-centerPosVS.z;\nvec3 weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);\ntotalIrradiance+=weight*irradiance;\ntotalWeight +=weight;\n}\nelse\n{\n}\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\nvec4 irradianceAndDiffusionProfile =texture2D(irradianceSampler,vUV);\nvec3 centerIrradiance=irradianceAndDiffusionProfile.rgb;\nint diffusionProfileIndex=int(round(irradianceAndDiffusionProfile.a*255.));\nfloat centerDepth =0.;\nvec4 inputColor=texture2D(textureSampler,vUV);\nbool passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);\nif (passedStencilTest)\n{\ncenterDepth=texture2D(depthSampler,vUV).r;\n}\nif (!passedStencilTest) { \ngl_FragColor=inputColor;\nreturn;\n}\nfloat distScale =1.;\nvec3 S =diffusionS[diffusionProfileIndex];\nfloat d =diffusionD[diffusionProfileIndex];\nfloat filterRadius=filterRadii[diffusionProfileIndex];\nvec2 centerPosNDC=vUV;\nvec2 cornerPosNDC=vUV+0.5*texelSize;\nvec3 centerPosVS =vec3(centerPosNDC*viewportSize,1.0)*centerDepth; \nvec3 cornerPosVS =vec3(cornerPosNDC*viewportSize,1.0)*centerDepth; \nfloat mmPerUnit =1000.*(metersPerUnit*rcp(distScale));\nfloat unitsPerMm=rcp(mmPerUnit);\nfloat unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);\nfloat pixelsPerMm =rcp(unitsPerPixel)*unitsPerMm;\nfloat filterArea =PI*Sq(filterRadius*pixelsPerMm);\nint sampleCount =int(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));\nint sampleBudget=_SssSampleBudget;\nint texturingMode=0;\nvec3 albedo =texture2D(albedoSampler,vUV).rgb;\nif (distScale==0. || sampleCount<1)\n{\n#ifdef DEBUG_SSS_SAMPLES\nvec3 green=vec3(0.,1.,0.);\ngl_FragColor=vec4(green,1.0);\nreturn;\n#endif\ngl_FragColor=vec4(inputColor.rgb+albedo*centerIrradiance,1.0);\nreturn;\n}\n#ifdef DEBUG_SSS_SAMPLES\nvec3 red =vec3(1.,0.,0.);\nvec3 blue=vec3(0.,0.,1.);\ngl_FragColor=vec4(mix(blue,red,clamp(float(sampleCount)/float(sampleBudget),0.0,1.0)),1.0);\nreturn;\n#endif\nfloat phase=0.;\nint n=min(sampleCount,sampleBudget);\nvec3 centerWeight =vec3(0.); \nvec3 totalIrradiance=vec3(0.);\nvec3 totalWeight =vec3(0.);\nfor (int i=0; i<n; i++)\n{\nEvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,\nphase,totalIrradiance,totalWeight);\n}\ntotalWeight=max(totalWeight,HALF_MIN);\ngl_FragColor=vec4(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3(0.0)),1.);\n}";class Mle extends Pe{getClassName(){return"SubSurfaceScatteringPostProcess"}constructor(e,t,i,s=null,n,o,a,l=0){super(e,"subSurfaceScattering",["texelSize","viewportSize","metersPerUnit"],["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],i,s,n||U.BILINEAR_SAMPLINGMODE,o,a,null,l,"postprocess",void 0,!0),this._scene=t,this.updateEffect(),this.onApplyObservable.add(c=>{if(!t.prePassRenderer||!t.subSurfaceConfiguration)return void V.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");const h=this.texelSize;c.setFloat("metersPerUnit",t.subSurfaceConfiguration.metersPerUnit),c.setFloat2("texelSize",h.x,h.y),c.setTexture("irradianceSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(0)]),c.setTexture("depthSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(5)]),c.setTexture("albedoSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(7)]),c.setFloat2("viewportSize",Math.tan(t.activeCamera.fov/2)*t.getEngine().getAspectRatio(t.activeCamera,!0),Math.tan(t.activeCamera.fov/2)),c.setArray3("diffusionS",t.subSurfaceConfiguration.ssDiffusionS),c.setArray("diffusionD",t.subSurfaceConfiguration.ssDiffusionD),c.setArray("filterRadii",t.subSurfaceConfiguration.ssFilterRadii)})}}let zH=(()=>{class r{get ssDiffusionS(){return this._ssDiffusionS}get ssDiffusionD(){return this._ssDiffusionD}get ssFilterRadii(){return this._ssFilterRadii}constructor(t){this._ssDiffusionS=[],this._ssFilterRadii=[],this._ssDiffusionD=[],this.enabled=!1,this.needsImageProcessing=!0,this.name=Me.NAME_SUBSURFACE,this.ssDiffusionProfileColors=[],this.metersPerUnit=1,this.texturesRequired=[5,7,4,0],this.addDiffusionProfile(new re(1,1,1)),this._scene=t,r._SceneComponentInitialization(this._scene)}addDiffusionProfile(t){if(this.ssDiffusionD.length>=5)return V.Error("You already reached the maximum number of diffusion profiles."),0;for(let i=0;i<this._ssDiffusionS.length/3;i++)if(this._ssDiffusionS[3*i]===t.r&&this._ssDiffusionS[3*i+1]===t.g&&this._ssDiffusionS[3*i+2]===t.b)return i;return this._ssDiffusionS.push(t.r,t.b,t.g),this._ssDiffusionD.push(Math.max(Math.max(t.r,t.b),t.g)),this._ssFilterRadii.push(this.getDiffusionProfileParameters(t)),this.ssDiffusionProfileColors.push(t),this._ssDiffusionD.length-1}createPostProcess(){return this.postProcess=new Mle("subSurfaceScattering",this._scene,1,null,void 0,this._scene.getEngine()),this.postProcess.autoClear=!1,this.postProcess}clearAllDiffusionProfiles(){this._ssDiffusionD=[],this._ssDiffusionS=[],this._ssFilterRadii=[],this.ssDiffusionProfileColors=[]}dispose(){this.clearAllDiffusionProfiles(),this.postProcess&&this.postProcess.dispose()}getDiffusionProfileParameters(t){const s=Math.max(t.r,t.g,t.b);return this._sampleBurleyDiffusionProfile(.997,s)}_sampleBurleyDiffusionProfile(t,i){const s=1+4*(t=1-t)*(2*t+Math.sqrt(1+4*t*t)),n=Math.pow(s,-1/3);return 3*Math.log((1+s*n*n+n)/(4*t))*i}}return r._SceneComponentInitialization=e=>{throw Ge("SubSurfaceSceneComponent")},r})();es.AddParser(Me.NAME_SUBSURFACE,(r,e)=>{if(null!=r.ssDiffusionProfileColors&&(e.enableSubSurfaceForPrePass(),e.subSurfaceConfiguration))for(let t=0,i=r.ssDiffusionProfileColors.length;t<i;t++){const s=r.ssDiffusionProfileColors[t];e.subSurfaceConfiguration.addDiffusionProfile(new re(s.r,s.g,s.b))}}),Object.defineProperty(ge.prototype,"subSurfaceConfiguration",{get:function(){return this._subSurfaceConfiguration},set:function(r){r&&this.enablePrePassRenderer()&&(this._subSurfaceConfiguration=r)},enumerable:!0,configurable:!0}),ge.prototype.enableSubSurfaceForPrePass=function(){if(this._subSurfaceConfiguration)return this._subSurfaceConfiguration;const r=this.enablePrePassRenderer();return r?(this._subSurfaceConfiguration=new zH(this),r.addEffectConfiguration(this._subSurfaceConfiguration),this._subSurfaceConfiguration):null},ge.prototype.disableSubSurfaceForPrePass=function(){!this._subSurfaceConfiguration||(this._subSurfaceConfiguration.dispose(),this._subSurfaceConfiguration=null)};class Ple{constructor(e){this.name=Me.NAME_PREPASSRENDERER,this.scene=e}register(){}serialize(e){if(!this.scene.subSurfaceConfiguration)return;const t=this.scene.subSurfaceConfiguration.ssDiffusionProfileColors;e.ssDiffusionProfileColors=[];for(let i=0;i<t.length;i++)e.ssDiffusionProfileColors.push({r:t[i].r,g:t[i].g,b:t[i].b})}addFromContainer(){}removeFromContainer(){!this.scene.prePassRenderer||this.scene.subSurfaceConfiguration&&this.scene.subSurfaceConfiguration.clearAllDiffusionProfiles()}rebuild(){}dispose(){}}zH._SceneComponentInitialization=r=>{let e=r._getComponent(Me.NAME_SUBSURFACE);e||(e=new Ple(r),r._addComponent(e))};j.ShadersStore.outlinePixelShader="#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform vec4 color;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#include<logDepthFragment>\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";j.ShadersStore.outlineVertexShader="attribute vec3 position;\nattribute vec3 normal;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\nuniform float offset;\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\nvec3 normalUpdated=normal;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\nvec3 offsetPosition=positionUpdated+(normalUpdated*offset);\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(offsetPosition,1.0);\ngl_Position=viewProjection*worldPos;\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n}\n",ge.prototype.getOutlineRenderer=function(){return this._outlineRenderer||(this._outlineRenderer=new Dle(this)),this._outlineRenderer},Object.defineProperty(G.prototype,"renderOutline",{get:function(){return this._renderOutline},set:function(r){r&&this.getScene().getOutlineRenderer(),this._renderOutline=r},enumerable:!0,configurable:!0}),Object.defineProperty(G.prototype,"renderOverlay",{get:function(){return this._renderOverlay},set:function(r){r&&this.getScene().getOutlineRenderer(),this._renderOverlay=r},enumerable:!0,configurable:!0});let Dle=(()=>{class r{constructor(t){this.name=Me.NAME_OUTLINERENDERER,this.zOffset=1,this.zOffsetUnits=4,this.scene=t,this._engine=t.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=[];for(let i=0;i<4;++i)this._passIdForDrawWrapper[i]=this._engine.createRenderPassId(`Outline Renderer (${i})`)}register(){this.scene._beforeRenderingMeshStage.registerStep(Me.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(Me.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){for(let t=0;t<this._passIdForDrawWrapper.length;++t)this._engine.releaseRenderPassId(this._passIdForDrawWrapper[t])}render(t,i,s=!1,n){n=n??this._passIdForDrawWrapper[0];const o=this.scene,a=o.getEngine(),l=a.getCaps().instancedArrays&&(null!=i.visibleInstances[t._id]||t.getRenderingMesh().hasThinInstances);if(!this.isReady(t,l,n))return;const c=t.getMesh(),h=c._internalAbstractMeshDataInfo._actAsRegularMesh?c:null,u=t.getRenderingMesh(),d=h||u,f=t.getMaterial();if(!f||!o.activeCamera)return;const p=t._getDrawWrapper(n),_=$i.GetEffect(p);if(a.enableEffect(p),f.useLogarithmicDepth&&_.setFloat("logarithmicDepthConstant",2/(Math.log(o.activeCamera.maxZ+1)/Math.LN2)),_.setFloat("offset",s?0:u.outlineWidth),_.setColor4("color",s?u.overlayColor:u.outlineColor,s?u.overlayAlpha:f.alpha),_.setMatrix("viewProjection",o.getTransformMatrix()),_.setMatrix("world",d.getWorldMatrix()),u.useBones&&u.computeBonesUsingShaders&&u.skeleton&&_.setMatrices("mBones",u.skeleton.getTransformMatrices(u)),u.morphTargetManager&&u.morphTargetManager.isUsingTextureForTargets&&u.morphTargetManager._bind(_),ce.BindMorphTargetParameters(u,_),l||u._bind(t,_,f.fillMode),f&&f.needAlphaTesting()){const m=f.getAlphaTestTexture();m&&(_.setTexture("diffuseSampler",m),_.setMatrix("diffuseMatrix",m.getTextureMatrix()))}fo(_,f,o),a.setZOffset(-this.zOffset),a.setZOffsetUnits(-this.zOffsetUnits),u._processRendering(d,t,_,f.fillMode,i,l,(m,g)=>{_.setMatrix("world",g)}),a.setZOffset(0),a.setZOffsetUnits(0)}isReady(t,i,s){s=s??this._passIdForDrawWrapper[0];const n=[],o=[A.PositionKind,A.NormalKind],a=t.getMesh(),l=t.getMaterial();if(!l)return!1;const c=a.getScene();l.needAlphaTesting()&&(n.push("#define ALPHATEST"),a.isVerticesDataPresent(A.UVKind)&&(o.push(A.UVKind),n.push("#define UV1")),a.isVerticesDataPresent(A.UV2Kind)&&(o.push(A.UV2Kind),n.push("#define UV2"))),l.useLogarithmicDepth&&n.push("#define LOGARITHMICDEPTH"),Za(l,c,n),a.useBones&&a.computeBonesUsingShaders?(o.push(A.MatricesIndicesKind),o.push(A.MatricesWeightsKind),a.numBoneInfluencers>4&&(o.push(A.MatricesIndicesExtraKind),o.push(A.MatricesWeightsExtraKind)),n.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers),n.push("#define BonesPerMesh "+(a.skeleton?a.skeleton.bones.length+1:0))):n.push("#define NUM_BONE_INFLUENCERS 0");const h=a.morphTargetManager;let u=0;h&&h.numInfluencers>0&&(u=h.numInfluencers,n.push("#define MORPHTARGETS"),n.push("#define NUM_MORPH_INFLUENCERS "+u),h.isUsingTextureForTargets&&n.push("#define MORPHTARGETS_TEXTURE"),ce.PrepareAttributesForMorphTargetsInfluencers(o,a,u)),i&&(n.push("#define INSTANCES"),ce.PushAttributesForInstances(o),t.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES"));const d=t._getDrawWrapper(s,!0),f=d.defines,p=n.join("\n");if(f!==p){const _=["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];Uo(_),d.setEffect(this.scene.getEngine().createEffect("outline",o,_,["diffuseSampler","morphTargets"],p,void 0,void 0,void 0,{maxSimultaneousMorphTargets:u}),p)}return d.effect.isReady()}_beforeRenderingMesh(t,i,s){if(this._savedDepthWrite=this._engine.getDepthWrite(),t.renderOutline){const n=i.getMaterial();n&&n.needAlphaBlendingForMesh(t)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(7681),this._engine.setStencilFunction(519),this._engine.setStencilMask(r._StencilReference),this._engine.setStencilFunctionReference(r._StencilReference),this._engine.stencilStateComposer.useStencilGlobalOnly=!0,this.render(i,s,!0,this._passIdForDrawWrapper[1]),this._engine.setColorWrite(!0),this._engine.setStencilFunction(517)),this._engine.setDepthWrite(!1),this.render(i,s,!1,this._passIdForDrawWrapper[0]),this._engine.setDepthWrite(this._savedDepthWrite),n&&n.needAlphaBlendingForMesh(t)&&(this._engine.stencilStateComposer.useStencilGlobalOnly=!1,this._engine.restoreStencilState())}}_afterRenderingMesh(t,i,s){if(t.renderOverlay){const n=this._engine.getAlphaMode(),o=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(2),this.render(i,s,!0,this._passIdForDrawWrapper[3]),this._engine.setAlphaMode(n),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=o}t.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(i,s,!1,this._passIdForDrawWrapper[2]),this._engine.setColorWrite(!0))}}return r._StencilReference=4,r})();class YH{get particleSize(){return this._particleSize}set particleSize(e){e!==this._particleSize&&(this._particleSize=e,this.onParticleSizeChanged.notifyObservers(this))}get useInstancing(){return!this.indexBuffer}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity===e||!this._hasVelocity()||(this._useVelocity=e,this._effectsAreDirty=!0)}_hasVelocity(){var e;return!(null===(e=this.vertexBuffers)||void 0===e||!e.velocity)}get indexBuffer(){return null}getClassName(){return"FluidRenderingObject"}constructor(e){this.priority=0,this._particleSize=.1,this.onParticleSizeChanged=new z,this.particleThicknessAlpha=.05,this._useVelocity=!1,this._scene=e,this._engine=e.getEngine(),this._effectsAreDirty=!0,this._depthEffectWrapper=null,this._thicknessEffectWrapper=null}_createEffects(){const e=["view","projection","particleRadius","size"],t=["position","offset"],i=[];this._effectsAreDirty=!1,this.useVelocity&&(t.push("velocity"),i.push("#define FLUIDRENDERING_VELOCITY")),this._scene.useRightHandedSystem&&i.push("#define FLUIDRENDERING_RHS"),this._depthEffectWrapper=new sl({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDepth",fragmentShader:"fluidRenderingParticleDepth",attributeNames:t,uniformNames:e,samplerNames:[],defines:i}),e.push("particleAlpha"),this._thicknessEffectWrapper=new sl({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleThickness",fragmentShader:"fluidRenderingParticleThickness",attributeNames:["position","offset"],uniformNames:e,samplerNames:[]})}isReady(){if(this._effectsAreDirty&&this._createEffects(),!this._depthEffectWrapper||!this._thicknessEffectWrapper)return!1;const t=this._thicknessEffectWrapper._drawWrapper.effect;return this._depthEffectWrapper._drawWrapper.effect.isReady()&&t.isReady()}renderDepthTexture(){const e=this.numParticles;if(!this._depthEffectWrapper||0===e)return;const t=this._depthEffectWrapper._drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat2("size",this._particleSize,this._particleSize),i.setFloat("particleRadius",this._particleSize/2),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}renderThicknessTexture(){const e=this.numParticles;if(!this._thicknessEffectWrapper||0===e)return;const t=this._thicknessEffectWrapper._drawWrapper,i=t.effect;this._engine.setAlphaMode(6),this._engine.setDepthWrite(!1),this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat("particleAlpha",this.particleThicknessAlpha),i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0)}renderDiffuseTexture(){}dispose(){var e,t;null===(e=this._depthEffectWrapper)||void 0===e||e.dispose(),null===(t=this._thicknessEffectWrapper)||void 0===t||t.dispose()}}class wle extends YH{get particleSystem(){return this._particleSystem}getClassName(){return"FluidRenderingObjectParticleSystem"}get useTrueRenderingForDiffuseTexture(){return this._useTrueRenderingForDiffuseTexture}set useTrueRenderingForDiffuseTexture(e){this._useTrueRenderingForDiffuseTexture!==e&&(this._useTrueRenderingForDiffuseTexture=e,e?(this._particleSystem.blendMode=this._blendMode,this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null):(this._particleSystem.blendMode=-1,this._onBeforeDrawParticleObserver=this._particleSystem.onBeforeDrawParticlesObservable.add(()=>{this._engine.setAlphaMode(2)})))}get vertexBuffers(){return this._particleSystem.vertexBuffers}get indexBuffer(){return this._particleSystem.indexBuffer}constructor(e,t){super(e),this._useTrueRenderingForDiffuseTexture=!0,this._particleSystem=t,this._originalRender=t.render.bind(t),this._blendMode=t.blendMode,this._onBeforeDrawParticleObserver=null,this._updateInAnimate=this._particleSystem.updateInAnimate,this._particleSystem.updateInAnimate=!0,this._particleSystem.render=()=>0,this.particleSize=(t.minSize+t.maxSize)/2,this.useTrueRenderingForDiffuseTexture=!1}isReady(){return super.isReady()&&this._particleSystem.isReady()}get numParticles(){return this._particleSystem.getActiveCount()}renderDiffuseTexture(){this._originalRender()}dispose(){super.dispose(),this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null,this._particleSystem.render=this._originalRender,this._particleSystem.blendMode=this._blendMode,this._particleSystem.updateInAnimate=this._updateInAnimate}}class c0{get blurNumIterations(){return this._blurNumIterations}set blurNumIterations(e){if(this._blurNumIterations!==e&&(this._blurNumIterations=e,null!==this._blurPostProcesses)){const t=this._blurPostProcesses[0],i=this._blurPostProcesses[1];this._blurPostProcesses=[];for(let s=0;s<2*this._blurNumIterations;++s)this._blurPostProcesses[s]=1&s?i:t}}get renderTarget(){return this._rt}get renderTargetBlur(){return this._rtBlur}get texture(){return this._texture}get textureBlur(){return this._textureBlurred}constructor(e,t,i,s,n,o,a=1,l=6,c=1,h=6,u=!1,d=null,f=!0,p=1){this.enableBlur=!0,this.blurSizeDivisor=1,this.blurFilterSize=7,this._blurNumIterations=3,this.blurMaxFilterSize=100,this.blurDepthScale=10,this.particleSize=.02,this.onDisposeObservable=new z,this._name=e,this._scene=t,this._camera=d,this._engine=t.getEngine(),this._width=i,this._height=s,this._blurTextureSizeX=n,this._blurTextureSizeY=o,this._textureType=a,this._textureFormat=l,this._blurTextureType=c,this._blurTextureFormat=h,this._useStandardBlur=u,this._generateDepthBuffer=f,this._samples=p,this._postProcessRunningIndex=0,this.enableBlur=0!==n&&0!==o,this._rt=null,this._texture=null,this._rtBlur=null,this._textureBlurred=null,this._blurPostProcesses=null}initialize(){if(this.dispose(),this._createRenderTarget(),this.enableBlur&&this._texture){const[e,t,i]=this._createBlurPostProcesses(this._texture,this._blurTextureType,this._blurTextureFormat,this.blurSizeDivisor,this._name,this._useStandardBlur);this._rtBlur=e,this._textureBlurred=t,this._blurPostProcesses=i}}applyBlurPostProcesses(){this.enableBlur&&this._blurPostProcesses&&(this._postProcessRunningIndex=0,this._scene.postProcessManager.directRender(this._blurPostProcesses,this._rtBlur,!0),this._engine.unBindFramebuffer(this._rtBlur))}_createRenderTarget(){this._rt=this._engine.createRenderTargetTexture({width:this._width,height:this._height},{generateMipMaps:!1,type:this._textureType,format:this._textureFormat,samplingMode:1,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:!1,samples:this._samples});const e=this._rt.texture;e.incrementReferences(),this._texture=new U(null,this._scene),this._texture.name="rtt"+this._name,this._texture._texture=e,this._texture.wrapU=U.CLAMP_ADDRESSMODE,this._texture.wrapV=U.CLAMP_ADDRESSMODE,this._texture.anisotropicFilteringLevel=1}_createBlurPostProcesses(e,t,i,s,n,o=!1){const a=this._scene.getEngine(),l=new de(Math.floor(this._blurTextureSizeX/s),Math.floor(this._blurTextureSizeY/s)),c=1===t&&a.getCaps().textureFloatLinearFiltering||2===t&&a.getCaps().textureHalfFloatLinearFiltering,h=this._engine.createRenderTargetTexture({width:l.x,height:l.y},{generateMipMaps:!1,type:t,format:i,samplingMode:c?2:1,generateDepthBuffer:!1,generateStencilBuffer:!1,samples:this._samples}),u=h.texture;u.incrementReferences();const d=new U(null,this._scene);if(d.name="rttBlurred"+n,d._texture=u,d.wrapU=U.CLAMP_ADDRESSMODE,d.wrapV=U.CLAMP_ADDRESSMODE,d.anisotropicFilteringLevel=1,o){const f=new Pe("BilateralBlurX","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);f.samples=this._samples,f.externalTextureSamplerBinding=!0,f.onApplyObservable.add(m=>{0===this._postProcessRunningIndex?m.setTexture("textureSampler",e):m._bindTexture("textureSampler",f.inputTexture.texture),m.setInt("filterSize",this.blurFilterSize),m.setFloat2("blurDir",1/this._blurTextureSizeX,0),this._postProcessRunningIndex++}),f.onSizeChangedObservable.add(()=>{f._textures.forEach(m=>{m.texture.wrapU=U.CLAMP_ADDRESSMODE,m.texture.wrapV=U.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(f);const p=new Pe("BilateralBlurY","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);p.samples=this._samples,p.onApplyObservable.add(m=>{m.setInt("filterSize",this.blurFilterSize),m.setFloat2("blurDir",0,1/this._blurTextureSizeY),this._postProcessRunningIndex++}),p.onSizeChangedObservable.add(()=>{p._textures.forEach(m=>{m.texture.wrapU=U.CLAMP_ADDRESSMODE,m.texture.wrapV=U.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(p),f.autoClear=!1,p.autoClear=!1;const _=[];for(let m=0;m<2*this._blurNumIterations;++m)_[m]=1&m?p:f;return[h,d,_]}{const f=["maxFilterSize","blurDir","projectedParticleConstant","depthThreshold"],p=new Pe("BilateralBlurX","fluidRenderingBilateralBlur",f,null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);p.samples=this._samples,p.externalTextureSamplerBinding=!0,p.onApplyObservable.add(g=>{0===this._postProcessRunningIndex?g.setTexture("textureSampler",e):g._bindTexture("textureSampler",p.inputTexture.texture),g.setInt("maxFilterSize",this.blurMaxFilterSize),g.setFloat2("blurDir",1/this._blurTextureSizeX,0),g.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),g.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++}),p.onSizeChangedObservable.add(()=>{p._textures.forEach(g=>{g.texture.wrapU=U.CLAMP_ADDRESSMODE,g.texture.wrapV=U.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(p);const _=new Pe("BilateralBlurY","fluidRenderingBilateralBlur",f,null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);_.samples=this._samples,_.onApplyObservable.add(g=>{g.setInt("maxFilterSize",this.blurMaxFilterSize),g.setFloat2("blurDir",0,1/this._blurTextureSizeY),g.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),g.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++}),_.onSizeChangedObservable.add(()=>{_._textures.forEach(g=>{g.texture.wrapU=U.CLAMP_ADDRESSMODE,g.texture.wrapV=U.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(_),p.autoClear=!1,_.autoClear=!1;const m=[];for(let g=0;g<2*this._blurNumIterations;++g)m[g]=1&g?_:p;return[h,d,m]}}_fixReusablePostProcess(e){!e.isReusable()||(e.onActivateObservable.add(()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2}),e.onApplyObservable.add(()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2}))}_getProjectedParticleConstant(){var e,t;return this.blurFilterSize*this.particleSize*.05*(this._height/2)/Math.tan((null!==(t=null===(e=this._camera)||void 0===e?void 0:e.fov)&&void 0!==t?t:45*Math.PI/180)/2)}_getDepthThreshold(){return this.particleSize/2*this.blurDepthScale}dispose(){var e,t,i,s;this.onDisposeObservable.hasObservers()&&this.onDisposeObservable.notifyObservers(this),null===(e=this._rt)||void 0===e||e.dispose(),this._rt=null,null===(t=this._texture)||void 0===t||t.dispose(),this._texture=null,null===(i=this._rtBlur)||void 0===i||i.dispose(),this._rtBlur=null,null===(s=this._textureBlurred)||void 0===s||s.dispose(),this._textureBlurred=null,this._blurPostProcesses&&(this._blurPostProcesses[0].dispose(),this._blurPostProcesses[1].dispose()),this._blurPostProcesses=null}}var Tn=(()=>{return(r=Tn||(Tn={}))[r.DepthTexture=0]="DepthTexture",r[r.DepthBlurredTexture=1]="DepthBlurredTexture",r[r.ThicknessTexture=2]="ThicknessTexture",r[r.ThicknessBlurredTexture=3]="ThicknessBlurredTexture",r[r.DiffuseTexture=4]="DiffuseTexture",r[r.Normals=5]="Normals",r[r.DiffuseRendering=6]="DiffuseRendering",Tn;var r})();class qH{get needInitialization(){return this._needInitialization}get generateDiffuseTexture(){return this._generateDiffuseTexture}set generateDiffuseTexture(e){this._generateDiffuseTexture!==e&&(this._generateDiffuseTexture=e,this._needInitialization=!0)}get debugFeature(){return this._debugFeature}set debugFeature(e){this._debugFeature!==e&&(this._needInitialization=!0,this._debugFeature=e)}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._needInitialization=!0)}get environmentMap(){return this._environmentMap}set environmentMap(e){this._environmentMap!==e&&(this._needInitialization=!0,this._environmentMap=e)}get enableBlurDepth(){return this._enableBlurDepth}set enableBlurDepth(e){this._enableBlurDepth!==e&&(this._enableBlurDepth=e,this._needInitialization=!0)}get blurDepthSizeDivisor(){return this._blurDepthSizeDivisor}set blurDepthSizeDivisor(e){this._blurDepthSizeDivisor!==e&&(this._blurDepthSizeDivisor=e,this._needInitialization=!0)}get blurDepthFilterSize(){return this._blurDepthFilterSize}set blurDepthFilterSize(e){this._blurDepthFilterSize!==e&&(this._blurDepthFilterSize=e,this._setBlurParameters())}get blurDepthNumIterations(){return this._blurDepthNumIterations}set blurDepthNumIterations(e){this._blurDepthNumIterations!==e&&(this._blurDepthNumIterations=e,this._setBlurParameters())}get blurDepthMaxFilterSize(){return this._blurDepthMaxFilterSize}set blurDepthMaxFilterSize(e){this._blurDepthMaxFilterSize!==e&&(this._blurDepthMaxFilterSize=e,this._setBlurParameters())}get blurDepthDepthScale(){return this._blurDepthDepthScale}set blurDepthDepthScale(e){this._blurDepthDepthScale!==e&&(this._blurDepthDepthScale=e,this._setBlurParameters())}get enableBlurThickness(){return this._enableBlurThickness}set enableBlurThickness(e){this._enableBlurThickness!==e&&(this._enableBlurThickness=e,this._needInitialization=!0)}get blurThicknessSizeDivisor(){return this._blurThicknessSizeDivisor}set blurThicknessSizeDivisor(e){this._blurThicknessSizeDivisor!==e&&(this._blurThicknessSizeDivisor=e,this._needInitialization=!0)}get blurThicknessFilterSize(){return this._blurThicknessFilterSize}set blurThicknessFilterSize(e){this._blurThicknessFilterSize!==e&&(this._blurThicknessFilterSize=e,this._setBlurParameters())}get blurThicknessNumIterations(){return this._blurThicknessNumIterations}set blurThicknessNumIterations(e){this._blurThicknessNumIterations!==e&&(this._blurThicknessNumIterations=e,this._setBlurParameters())}get useFixedThickness(){return this._useFixedThickness}set useFixedThickness(e){this._useFixedThickness!==e&&(this._useFixedThickness=e,this._needInitialization=!0)}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity!==e&&(this._useVelocity=e,this._needInitialization=!0,this._onUseVelocityChanged.notifyObservers(this))}get depthMapSize(){return this._depthMapSize}set depthMapSize(e){this._depthMapSize!==e&&(this._depthMapSize=e,this._needInitialization=!0)}get thicknessMapSize(){return this._thicknessMapSize}set thicknessMapSize(e){this._thicknessMapSize!==e&&(this._thicknessMapSize=e,this._needInitialization=!0)}get diffuseMapSize(){return this._diffuseMapSize}set diffuseMapSize(e){this._diffuseMapSize!==e&&(this._diffuseMapSize=e,this._needInitialization=!0)}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._needInitialization=!0)}get camera(){return this._camera}constructor(e,t){this._generateDiffuseTexture=!1,this.fluidColor=new re(.085,.6375,.765),this.density=2,this.refractionStrength=.1,this.fresnelClamp=1,this.specularPower=250,this.minimumThickness=0,this.dirLight=new v(-2,-1,1).normalize(),this._debugFeature=Tn.DepthBlurredTexture,this._debug=!1,this._enableBlurDepth=!0,this._blurDepthSizeDivisor=1,this._blurDepthFilterSize=7,this._blurDepthNumIterations=3,this._blurDepthMaxFilterSize=100,this._blurDepthDepthScale=10,this._enableBlurThickness=!0,this._blurThicknessSizeDivisor=1,this._blurThicknessFilterSize=5,this._blurThicknessNumIterations=1,this._useFixedThickness=!1,this._onUseVelocityChanged=new z,this._useVelocity=!1,this._depthMapSize=null,this._thicknessMapSize=null,this._diffuseMapSize=null,this._samples=1,this._scene=e,this._engine=e.getEngine(),this._camera=t??e.activeCamera,this._needInitialization=!0,this._bgDepthTexture=null,this._invProjectionMatrix=new F,this._depthClearColor=new Te(1e6,1e6,1e6,1),this._thicknessClearColor=new Te(0,0,0,1),this._depthRenderTarget=null,this._diffuseRenderTarget=null,this._thicknessRenderTarget=null,this._renderPostProcess=null}_initialize(){var e,t,i;this.dispose(),this._needInitialization=!1;const s=null!==(e=this._depthMapSize)&&void 0!==e?e:this._engine.getRenderWidth(),n=null!==this._depthMapSize?Math.round(this._depthMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();if(this._depthRenderTarget=new c0("Depth",this._scene,s,n,s,n,1,7,1,7,!1,this._camera,!0,this._samples),this._initializeRenderTarget(this._depthRenderTarget),this.generateDiffuseTexture){const l=null!==(t=this._diffuseMapSize)&&void 0!==t?t:this._engine.getRenderWidth(),c=null!==this._diffuseMapSize?Math.round(this._diffuseMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._diffuseRenderTarget=new c0("Diffuse",this._scene,l,c,0,0,0,5,0,5,!0,this._camera,!0,this._samples),this._initializeRenderTarget(this._diffuseRenderTarget)}const o=null!==(i=this._thicknessMapSize)&&void 0!==i?i:this._engine.getRenderWidth(),a=null!==this._thicknessMapSize?Math.round(this._thicknessMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._useFixedThickness||(this._thicknessRenderTarget=new c0("Thickness",this._scene,o,a,o,a,2,6,2,6,!0,this._camera,!1,this._samples),this._initializeRenderTarget(this._thicknessRenderTarget)),this._createLiquidRenderingPostProcess()}_setBlurParameters(e=null){(null===e||e===this._depthRenderTarget)&&this._setBlurDepthParameters(),(null===e||e===this._thicknessRenderTarget)&&this._setBlurThicknessParameters()}_setBlurDepthParameters(){!this._depthRenderTarget||(this._depthRenderTarget.blurFilterSize=this.blurDepthFilterSize,this._depthRenderTarget.blurMaxFilterSize=this.blurDepthMaxFilterSize,this._depthRenderTarget.blurNumIterations=this.blurDepthNumIterations,this._depthRenderTarget.blurDepthScale=this.blurDepthDepthScale)}_setBlurThicknessParameters(){!this._thicknessRenderTarget||(this._thicknessRenderTarget.blurFilterSize=this.blurThicknessFilterSize,this._thicknessRenderTarget.blurNumIterations=this.blurThicknessNumIterations)}_initializeRenderTarget(e){e!==this._diffuseRenderTarget&&(e.enableBlur=e===this._depthRenderTarget?this.enableBlurDepth:this.enableBlurThickness,e.blurSizeDivisor=e===this._depthRenderTarget?this.blurDepthSizeDivisor:this.blurThicknessSizeDivisor),this._setBlurParameters(e),e.initialize()}_createLiquidRenderingPostProcess(){var e;const t=this._scene.getEngine(),i=["viewMatrix","projectionMatrix","invProjectionMatrix","texelSize","dirLight","cameraFar","density","refractionStrength","fresnelClamp","specularPower"],s=["depthSampler"],n=[];if(this.dispose(!0),!this._camera)return;const o=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture,a=new de(1/o.getSize().width,1/o.getSize().height);this._scene.useRightHandedSystem&&n.push("#define FLUIDRENDERING_RHS"),null!==this._environmentMap&&(null!==(e=this._environmentMap)&&void 0!==e?e:this._scene.environmentTexture)&&(s.push("reflectionSampler"),n.push("#define FLUIDRENDERING_ENVIRONMENT")),this._diffuseRenderTarget?(s.push("diffuseSampler"),n.push("#define FLUIDRENDERING_DIFFUSETEXTURE")):i.push("diffuseColor"),this._useVelocity&&(s.push("velocitySampler"),n.push("#define FLUIDRENDERING_VELOCITY")),this._useFixedThickness?(i.push("thickness"),s.push("bgDepthSampler"),n.push("#define FLUIDRENDERING_FIXED_THICKNESS")):(i.push("minimumThickness"),s.push("thicknessSampler")),this._debug&&(n.push("#define FLUIDRENDERING_DEBUG"),this._debugFeature===Tn.Normals?n.push("#define FLUIDRENDERING_DEBUG_SHOWNORMAL"):this._debugFeature===Tn.DiffuseRendering?n.push("#define FLUIDRENDERING_DEBUG_DIFFUSERENDERING"):(n.push("#define FLUIDRENDERING_DEBUG_TEXTURE"),s.push("debugSampler"),(this._debugFeature===Tn.DepthTexture||this._debugFeature===Tn.DepthBlurredTexture)&&n.push("#define FLUIDRENDERING_DEBUG_DEPTH"))),this._renderPostProcess=new Pe("FluidRendering","fluidRenderingRender",i,s,1,null,2,t,!1,null,0,void 0,void 0,!0,void 0),this._renderPostProcess.updateEffect(n.join("\n")),this._renderPostProcess.samples=this._samples,this._renderPostProcess.onApplyObservable.add(l=>{var c,h,u,d,f,p,_,m,g,b,y,T,x,S,C,D,P,M,w,k,X,te,J;if(this._invProjectionMatrix.copyFrom(this._scene.getProjectionMatrix()),this._invProjectionMatrix.invert(),t.isWebGPU&&l.setTextureSampler("textureSamplerSampler",this._renderPostProcess.inputTexture.texture),this._depthRenderTarget.enableBlur?(l.setTexture("depthSampler",this._depthRenderTarget.textureBlur),t.isWebGPU&&l.setTextureSampler("depthSamplerSampler",null!==(d=null===(u=this._depthRenderTarget.textureBlur)||void 0===u?void 0:u.getInternalTexture())&&void 0!==d?d:null)):(l.setTexture("depthSampler",this._depthRenderTarget.texture),t.isWebGPU&&l.setTextureSampler("depthSamplerSampler",null!==(h=null===(c=this._depthRenderTarget.texture)||void 0===c?void 0:c.getInternalTexture())&&void 0!==h?h:null)),this._diffuseRenderTarget?this._diffuseRenderTarget.enableBlur?(l.setTexture("diffuseSampler",this._diffuseRenderTarget.textureBlur),t.isWebGPU&&l.setTextureSampler("diffuseSamplerSampler",null!==(m=null===(_=this._diffuseRenderTarget.textureBlur)||void 0===_?void 0:_.getInternalTexture())&&void 0!==m?m:null)):(l.setTexture("diffuseSampler",this._diffuseRenderTarget.texture),t.isWebGPU&&l.setTextureSampler("diffuseSamplerSampler",null!==(p=null===(f=this._diffuseRenderTarget.texture)||void 0===f?void 0:f.getInternalTexture())&&void 0!==p?p:null)):l.setColor3("diffuseColor",this.fluidColor),this._useFixedThickness?(l.setFloat("thickness",this.minimumThickness),l._bindTexture("bgDepthSampler",this._bgDepthTexture),t.isWebGPU&&l.setTextureSampler("bgDepthSamplerSampler",null!==(g=this._bgDepthTexture)&&void 0!==g?g:null)):(this._thicknessRenderTarget.enableBlur?(l.setTexture("thicknessSampler",this._thicknessRenderTarget.textureBlur),t.isWebGPU&&l.setTextureSampler("thicknessSamplerSampler",null!==(x=null===(T=this._thicknessRenderTarget.textureBlur)||void 0===T?void 0:T.getInternalTexture())&&void 0!==x?x:null)):(l.setTexture("thicknessSampler",this._thicknessRenderTarget.texture),t.isWebGPU&&l.setTextureSampler("thicknessSamplerSampler",null!==(y=null===(b=this._thicknessRenderTarget.texture)||void 0===b?void 0:b.getInternalTexture())&&void 0!==y?y:null)),l.setFloat("minimumThickness",this.minimumThickness)),null!==this._environmentMap){const Q=null!==(S=this._environmentMap)&&void 0!==S?S:this._scene.environmentTexture;Q&&(l.setTexture("reflectionSampler",Q),t.isWebGPU&&l.setTextureSampler("reflectionSamplerSampler",null!==(C=Q?.getInternalTexture())&&void 0!==C?C:null))}if(l.setMatrix("viewMatrix",this._scene.getViewMatrix()),l.setMatrix("invProjectionMatrix",this._invProjectionMatrix),l.setMatrix("projectionMatrix",this._scene.getProjectionMatrix()),l.setVector2("texelSize",a),l.setFloat("density",this.density),l.setFloat("refractionStrength",this.refractionStrength),l.setFloat("fresnelClamp",this.fresnelClamp),l.setFloat("specularPower",this.specularPower),l.setVector3("dirLight",this.dirLight),l.setFloat("cameraFar",this._camera.maxZ),this._debug){let Q=null;switch(this._debugFeature){case Tn.DepthTexture:Q=this._depthRenderTarget.texture;break;case Tn.DepthBlurredTexture:Q=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture;break;case Tn.ThicknessTexture:Q=null!==(P=null===(D=this._thicknessRenderTarget)||void 0===D?void 0:D.texture)&&void 0!==P?P:null;break;case Tn.ThicknessBlurredTexture:Q=null!==(M=this._thicknessRenderTarget)&&void 0!==M&&M.enableBlur?null!==(k=null===(w=this._thicknessRenderTarget)||void 0===w?void 0:w.textureBlur)&&void 0!==k?k:null:null!==(te=null===(X=this._thicknessRenderTarget)||void 0===X?void 0:X.texture)&&void 0!==te?te:null;break;case Tn.DiffuseTexture:this._diffuseRenderTarget&&(Q=this._diffuseRenderTarget.texture)}this._debugFeature!==Tn.Normals&&(l.setTexture("debugSampler",Q),t.isWebGPU&&l.setTextureSampler("debugSamplerSampler",null!==(J=Q?.getInternalTexture())&&void 0!==J?J:null))}})}_clearTargets(){var e,t,i;!(null===(e=this._depthRenderTarget)||void 0===e)&&e.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),this._engine.clear(this._depthClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),!(null===(t=this._diffuseRenderTarget)||void 0===t)&&t.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),null!==(i=this._thicknessRenderTarget)&&void 0!==i&&i.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!1,!1),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget))}_render(e){var t,i,s,n,o,a;if(this._needInitialization||!e.isReady())return;const l=this._engine._currentRenderTarget;this._engine.setState(!1,void 0,void 0,void 0,!0),this._engine.setDepthBuffer(!0),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0),!(null===(t=this._depthRenderTarget)||void 0===t)&&t.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),e.renderDepthTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),!(null===(i=this._diffuseRenderTarget)||void 0===i)&&i.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),e.renderDiffuseTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),!(null===(s=this._thicknessRenderTarget)||void 0===s)&&s.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),e.renderThicknessTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget)),null===(n=this._depthRenderTarget)||void 0===n||n.applyBlurPostProcesses(),null===(o=this._diffuseRenderTarget)||void 0===o||o.applyBlurPostProcesses(),null===(a=this._thicknessRenderTarget)||void 0===a||a.applyBlurPostProcesses(),l&&this._engine.bindFramebuffer(l)}dispose(e=!1){var t,i,s,n;e||(null===(t=this._depthRenderTarget)||void 0===t||t.dispose(),this._depthRenderTarget=null,null===(i=this._diffuseRenderTarget)||void 0===i||i.dispose(),this._diffuseRenderTarget=null,null===(s=this._thicknessRenderTarget)||void 0===s||s.dispose(),this._thicknessRenderTarget=null),this._renderPostProcess&&this._camera&&this._camera.detachPostProcess(this._renderPostProcess),null===(n=this._renderPostProcess)||void 0===n||n.dispose(),this._renderPostProcess=null,this._needInitialization=!1}}class Ole extends YH{getClassName(){return"FluidRenderingObjectCustomParticles"}get vertexBuffers(){return this._vertexBuffers}constructor(e,t,i){super(e),this._numParticles=i,this._diffuseEffectWrapper=null,this._vertexBuffers={},this.addBuffers(t)}addBuffers(e){for(const t in e){let i,s=!0;switch(t){case"velocity":i=3;break;case"offset":s=!1}this._vertexBuffers[t]=new A(this._engine,e[t],t,!0,!1,i,s)}}_createEffects(){super._createEffects(),this._diffuseEffectWrapper=new sl({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDiffuse",fragmentShader:"fluidRenderingParticleDiffuse",attributeNames:["position","offset","color"],uniformNames:["view","projection","size"],samplerNames:[]})}isReady(){var e,t;return this._vertexBuffers.offset||(this._vertexBuffers.offset=new A(this._engine,[0,0,1,0,0,1,1,1],"offset",!1,!1,2)),super.isReady()&&null!==(t=null===(e=this._diffuseEffectWrapper)||void 0===e?void 0:e.effect.isReady())&&void 0!==t&&t}get numParticles(){return this._numParticles}setNumParticles(e){this._numParticles=e}renderDiffuseTexture(){const e=this.numParticles;if(!this._diffuseEffectWrapper||0===e)return;const t=this._diffuseEffectWrapper._drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),null!==this._particleSize&&i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}dispose(){var e;super.dispose(),null===(e=this._diffuseEffectWrapper)||void 0===e||e.dispose();for(const t in this._vertexBuffers)this._vertexBuffers[t].dispose();this._vertexBuffers={}}}j.ShadersStore.copyTextureToTexturePixelShader="uniform float conversion;\nuniform sampler2D textureSampler;\nvarying vec2 vUV;\n#include<helperFunctions>\nvoid main(void) \n{\nvec4 color=texture2D(textureSampler,vUV);\n#ifdef DEPTH_TEXTURE\ngl_FragDepth=color.r;\n#else\nif (conversion==1.) {\ncolor=toLinearSpace(color);\n} else if (conversion==2.) {\ncolor=toGammaSpace(color);\n}\ngl_FragColor=color;\n#endif\n}\n";var Ab=(()=>{return(r=Ab||(Ab={}))[r.None=0]="None",r[r.ToLinearSpace=1]="ToLinearSpace",r[r.ToGammaSpace=2]="ToGammaSpace",Ab;var r})();class Nle{_textureIsInternal(e){return void 0===e.getInternalTexture}constructor(e,t=!1){this._engine=e,this._isDepthTexture=t,this._renderer=new uv(e),this._effectWrapper=new sl({engine:e,name:"CopyTextureToTexture",fragmentShader:"copyTextureToTexture",useShaderStore:!0,uniformNames:["conversion"],samplerNames:["textureSampler"],defines:t?["#define DEPTH_TEXTURE"]:[]}),this._effectWrapper.onApplyObservable.add(()=>{t&&(e.setState(!1),e.setDepthBuffer(!0),e.depthCullingState.depthMask=!0,e.depthCullingState.depthFunc=519),this._textureIsInternal(this._source)?this._effectWrapper.effect._bindTexture("textureSampler",this._source):this._effectWrapper.effect.setTexture("textureSampler",this._source),this._effectWrapper.effect.setFloat("conversion",this._conversion)})}isReady(){return this._effectWrapper.effect.isReady()}copy(e,t,i=Ab.None){if(!this.isReady())return!1;this._source=e,this._conversion=i;const s=this._engine.depthCullingState.depthFunc;return this._renderer.render(this._effectWrapper,t),this._isDepthTexture&&s&&(this._engine.depthCullingState.depthFunc=s),!0}dispose(){this._effectWrapper.dispose(),this._renderer.dispose()}}class Fle{get depthRTWrapper(){return this._depthRTWrapper}constructor(e,t,i,s=1){this._engine=e,this._copyTextureToTexture=new Nle(e,!0),this._depthRTWrapper=this._engine.createRenderTargetTexture({width:t,height:i},{generateMipMaps:!1,type:0,format:6,samplingMode:1,generateDepthBuffer:!0,generateStencilBuffer:!1,samples:s,noColorAttachment:!0}),this._depthRTWrapper.createDepthStencilTexture(0,!1,!1,1)}copy(e){return this._copyTextureToTexture.copy(e,this._depthRTWrapper)}dispose(){this._depthRTWrapper.dispose(),this._copyTextureToTexture.dispose()}}j.ShadersStore.fluidRenderingParticleDepthVertexShader="attribute vec3 position;\nattribute vec2 offset;\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec2 size;\nvarying vec2 uv;\nvarying vec3 viewPos;\nvarying float sphereRadius;\n#ifdef FLUIDRENDERING_VELOCITY\nattribute vec3 velocity;\nvarying float velocityNorm;\n#endif\nvoid main(void) {\nvec3 cornerPos;\ncornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;\ncornerPos.z=0.0;\nviewPos=(view*vec4(position,1.0)).xyz;\ngl_Position=projection*vec4(viewPos+cornerPos,1.0);\nuv=offset;\nsphereRadius=size.x/2.0;\n#ifdef FLUIDRENDERING_VELOCITY\nvelocityNorm=length(velocity);\n#endif\n}\n";j.ShadersStore.fluidRenderingParticleDepthPixelShader="uniform mat4 projection;\nvarying vec2 uv;\nvarying vec3 viewPos;\nvarying float sphereRadius;\n#ifdef FLUIDRENDERING_VELOCITY\nvarying float velocityNorm;\n#endif\nvoid main(void) {\nvec3 normal;\nnormal.xy=uv*2.0-1.0;\nfloat r2=dot(normal.xy,normal.xy);\nif (r2>1.0) discard;\nnormal.z=sqrt(1.0-r2);\n#ifndef FLUIDRENDERING_RHS\nnormal.z=-normal.z;\n#endif\nvec4 realViewPos=vec4(viewPos+normal*sphereRadius,1.0);\nvec4 clipSpacePos=projection*realViewPos;\n#ifdef WEBGPU\ngl_FragDepth=clipSpacePos.z/clipSpacePos.w;\n#else\ngl_FragDepth=(clipSpacePos.z/clipSpacePos.w)*0.5+0.5;\n#endif\n#ifdef FLUIDRENDERING_RHS\nrealViewPos.z=-realViewPos.z;\n#endif\n#ifdef FLUIDRENDERING_VELOCITY\nglFragColor=vec4(realViewPos.z,velocityNorm,0.,1.);\n#else\nglFragColor=vec4(realViewPos.z,0.,0.,1.);\n#endif\n}\n";j.ShadersStore.fluidRenderingParticleThicknessVertexShader="attribute vec3 position;\nattribute vec2 offset;\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec2 size;\nvarying vec2 uv;\nvoid main(void) {\nvec3 cornerPos;\ncornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;\ncornerPos.z=0.0;\nvec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;\ngl_Position=projection*vec4(viewPos,1.0);\nuv=offset;\n}\n";j.ShadersStore.fluidRenderingParticleThicknessPixelShader="uniform float particleAlpha;\nvarying vec2 uv;\nvoid main(void) {\nvec3 normal;\nnormal.xy=uv*2.0-1.0;\nfloat r2=dot(normal.xy,normal.xy);\nif (r2>1.0) discard;\nfloat thickness=sqrt(1.0-r2);\nglFragColor=vec4(vec3(particleAlpha*thickness),1.0);\n}\n";j.ShadersStore.fluidRenderingParticleDiffuseVertexShader="attribute vec3 position;\nattribute vec2 offset;\nattribute vec4 color;\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec2 size;\nvarying vec2 uv;\nvarying vec3 diffuseColor;\nvoid main(void) {\nvec3 cornerPos;\ncornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;\ncornerPos.z=0.0;\nvec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;\ngl_Position=projection*vec4(viewPos,1.0);\nuv=offset;\ndiffuseColor=color.rgb;\n}\n";j.ShadersStore.fluidRenderingParticleDiffusePixelShader="uniform float particleAlpha;\nvarying vec2 uv;\nvarying vec3 diffuseColor;\nvoid main(void) {\nvec3 normal;\nnormal.xy=uv*2.0-1.0;\nfloat r2=dot(normal.xy,normal.xy);\nif (r2>1.0) discard;\nglFragColor=vec4(diffuseColor,1.0);\n}\n";j.ShadersStore.fluidRenderingBilateralBlurPixelShader="uniform sampler2D textureSampler;\nuniform int maxFilterSize;\nuniform vec2 blurDir;\nuniform float projectedParticleConstant;\nuniform float depthThreshold;\nvarying vec2 vUV;\nvoid main(void) {\nfloat depth=textureLod(textureSampler,vUV,0.).x;\nif (depth>=1e6 || depth<=0.) {\nglFragColor=vec4(vec3(depth),1.);\nreturn;\n}\nint filterSize=min(maxFilterSize,int(ceil(projectedParticleConstant/depth)));\nfloat sigma=float(filterSize)/3.0;\nfloat two_sigma2=2.0*sigma*sigma;\nfloat sigmaDepth=depthThreshold/3.0;\nfloat two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;\nfloat sum=0.;\nfloat wsum=0.;\nfloat sumVel=0.;\nfor (int x=-filterSize; x<=filterSize; ++x) {\nvec2 coords=vec2(x);\nvec2 sampleDepthVel=textureLod(textureSampler,vUV+coords*blurDir,0.).rg;\nfloat r=dot(coords,coords);\nfloat w=exp(-r/two_sigma2);\nfloat rDepth=sampleDepthVel.r-depth;\nfloat wd=exp(-rDepth*rDepth/two_sigmaDepth2);\nsum+=sampleDepthVel.r*w*wd;\nsumVel+=sampleDepthVel.g*w*wd;\nwsum+=w*wd;\n}\nglFragColor=vec4(sum/wsum,sumVel/wsum,0.,1.);\n}\n";j.ShadersStore.fluidRenderingStandardBlurPixelShader="uniform sampler2D textureSampler;\nuniform int filterSize;\nuniform vec2 blurDir;\nvarying vec2 vUV;\nvoid main(void) {\nvec4 s=textureLod(textureSampler,vUV,0.);\nif (s.r==0.) {\nglFragColor=vec4(0.,0.,0.,1.);\nreturn;\n}\nfloat sigma=float(filterSize)/3.0;\nfloat twoSigma2=2.0*sigma*sigma;\nvec4 sum=vec4(0.);\nfloat wsum=0.;\nfor (int x=-filterSize; x<=filterSize; ++x) {\nvec2 coords=vec2(x);\nvec4 sampl=textureLod(textureSampler,vUV+coords*blurDir,0.);\nfloat w=exp(-coords.x*coords.x/twoSigma2);\nsum+=sampl*w;\nwsum+=w;\n}\nsum/=wsum;\nglFragColor=vec4(sum.rgb,1.);\n}\n";j.ShadersStore.fluidRenderingRenderPixelShader="#define IOR 1.333\n#define ETA 1.0/IOR\n#define F0 0.02\nuniform sampler2D textureSampler;\nuniform sampler2D depthSampler;\n#ifdef FLUIDRENDERING_DIFFUSETEXTURE\nuniform sampler2D diffuseSampler;\n#else\nuniform vec3 diffuseColor;\n#endif\n#ifdef FLUIDRENDERING_FIXED_THICKNESS\nuniform float thickness;\nuniform sampler2D bgDepthSampler;\n#else\nuniform float minimumThickness;\nuniform sampler2D thicknessSampler;\n#endif\n#ifdef FLUIDRENDERING_ENVIRONMENT\nuniform samplerCube reflectionSampler;\n#endif\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)\nuniform sampler2D debugSampler;\n#endif\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 invProjectionMatrix;\nuniform vec2 texelSize;\nuniform vec3 dirLight;\nuniform float cameraFar;\nuniform float density;\nuniform float refractionStrength;\nuniform float fresnelClamp;\nuniform float specularPower;\nvarying vec2 vUV;\nvec3 computeViewPosFromUVDepth(vec2 texCoord,float depth) {\nvec4 ndc;\nndc.xy=texCoord*2.0-1.0;\n#ifdef FLUIDRENDERING_RHS\nndc.z=-projectionMatrix[2].z+projectionMatrix[3].z/depth;\n#else\nndc.z=projectionMatrix[2].z+projectionMatrix[3].z/depth;\n#endif\nndc.w=1.0;\nvec4 eyePos=invProjectionMatrix*ndc;\neyePos.xyz/=eyePos.w;\nreturn eyePos.xyz;\n}\nvec3 getViewPosFromTexCoord(vec2 texCoord) {\nfloat depth=textureLod(depthSampler,texCoord,0.).x;\nreturn computeViewPosFromUVDepth(texCoord,depth);\n}\nvoid main(void) {\nvec2 texCoord=vUV;\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)\nvec4 color=texture2D(debugSampler,texCoord);\n#ifdef FLUIDRENDERING_DEBUG_DEPTH\nglFragColor=vec4(color.rgb/vec3(2.0),1.);\nif (color.r>0.999 && color.g>0.999) {\nglFragColor=texture2D(textureSampler,texCoord);\n}\n#else\nglFragColor=vec4(color.rgb,1.);\nif (color.r<0.001 && color.g<0.001 && color.b<0.001) {\nglFragColor=texture2D(textureSampler,texCoord);\n}\n#endif\nreturn;\n#endif\nvec2 depthVel=textureLod(depthSampler,texCoord,0.).rg;\nfloat depth=depthVel.r;\n#ifndef FLUIDRENDERING_FIXED_THICKNESS\nfloat thickness=texture2D(thicknessSampler,texCoord).x;\n#else\nfloat bgDepth=texture2D(bgDepthSampler,texCoord).x;\nfloat depthNonLinear=projectionMatrix[2].z+projectionMatrix[3].z/depth;\ndepthNonLinear=depthNonLinear*0.5+0.5;\n#endif\nvec3 backColor=texture2D(textureSampler,texCoord).rgb;\n#ifndef FLUIDRENDERING_FIXED_THICKNESS\nif (depth>=cameraFar || depth<=0. || thickness<=minimumThickness) {\n#else\nif (depth>=cameraFar || depth<=0. || bgDepth<=depthNonLinear) {\n#endif\nglFragColor=vec4(backColor,1.);\nreturn;\n}\nvec3 viewPos=computeViewPosFromUVDepth(texCoord,depth);\nvec3 ddx=getViewPosFromTexCoord(texCoord+vec2(texelSize.x,0.))-viewPos;\nvec3 ddy=getViewPosFromTexCoord(texCoord+vec2(0.,texelSize.y))-viewPos;\nvec3 ddx2=viewPos-getViewPosFromTexCoord(texCoord+vec2(-texelSize.x,0.));\nif (abs(ddx.z)>abs(ddx2.z)) {\nddx=ddx2;\n}\nvec3 ddy2=viewPos-getViewPosFromTexCoord(texCoord+vec2(0.,-texelSize.y));\nif (abs(ddy.z)>abs(ddy2.z)) {\nddy=ddy2;\n}\nvec3 normal=normalize(cross(ddy,ddx));\n#ifdef FLUIDRENDERING_RHS\nnormal=-normal;\n#endif\n#ifndef WEBGPU\nif(isnan(normal.x) || isnan(normal.y) || isnan(normal.z) || isinf(normal.x) || isinf(normal.y) || isinf(normal.z)) {\nnormal=vec3(0.,0.,-1.);\n}\n#endif\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_SHOWNORMAL)\nglFragColor=vec4(normal*0.5+0.5,1.0);\nreturn;\n#endif\nvec3 rayDir=normalize(viewPos); \n#ifdef FLUIDRENDERING_DIFFUSETEXTURE\nvec3 diffuseColor=texture2D(diffuseSampler,texCoord).rgb;\n#endif\nvec3 lightDir=normalize(vec3(viewMatrix*vec4(-dirLight,0.)));\nvec3 H =normalize(lightDir-rayDir);\nfloat specular=pow(max(0.0,dot(H,normal)),specularPower);\n#ifdef FLUIDRENDERING_DEBUG_DIFFUSERENDERING\nfloat diffuse =max(0.0,dot(lightDir,normal))*1.0;\nglFragColor=vec4(vec3(0.1) /*ambient*/+vec3(0.42,0.50,1.00)*diffuse+vec3(0,0,0.2)+specular,1.);\nreturn;\n#endif\nvec3 refractionDir=refract(rayDir,normal,ETA);\nvec3 transmitted=(texture2D(textureSampler,vec2(texCoord+refractionDir.xy*thickness*refractionStrength)).rgb);\nvec3 transmittance=exp(-density*thickness*(1.0-diffuseColor)); \nvec3 refractionColor=transmitted*transmittance;\n#ifdef FLUIDRENDERING_ENVIRONMENT\nvec3 reflectionDir=reflect(rayDir,normal);\nvec3 reflectionColor=(textureCube(reflectionSampler,reflectionDir).rgb);\nfloat fresnel=clamp(F0+(1.0-F0)*pow(1.0-dot(normal,-rayDir),5.0),0.,fresnelClamp);\nvec3 finalColor=mix(refractionColor,reflectionColor,fresnel)+specular;\n#else\nvec3 finalColor=refractionColor+specular;\n#endif\n#ifdef FLUIDRENDERING_VELOCITY\nfloat velocity=depthVel.g;\nfinalColor=mix(finalColor,vec3(1.0),smoothstep(0.3,1.0,velocity/6.0));\n#endif\nglFragColor=vec4(finalColor,1.);\n}\n",Object.defineProperty(ge.prototype,"fluidRenderer",{get:function(){return this._fluidRenderer},set:function(r){this._fluidRenderer=r},enumerable:!0,configurable:!0}),ge.prototype.enableFluidRenderer=function(){return this._fluidRenderer||(this._fluidRenderer=new h0(this)),this._fluidRenderer},ge.prototype.disableFluidRenderer=function(){var r;null===(r=this._fluidRenderer)||void 0===r||r.dispose(),this._fluidRenderer=null};class Ble{constructor(e){this.name=Me.NAME_FLUIDRENDERER,this.scene=e}register(){this.scene._gatherActiveCameraRenderTargetsStage.registerStep(Me.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER,this,this._gatherActiveCameraRenderTargets),this.scene._afterCameraDrawStage.registerStep(Me.STEP_AFTERCAMERADRAW_FLUIDRENDERER,this,this._afterCameraDraw)}_gatherActiveCameraRenderTargets(e){var t;null===(t=this.scene.fluidRenderer)||void 0===t||t._prepareRendering()}_afterCameraDraw(e){var t;null===(t=this.scene.fluidRenderer)||void 0===t||t._render(e)}rebuild(){this.scene._fluidRenderer&&(this.scene.disableFluidRenderer(),this.scene.enableFluidRenderer())}dispose(){this.scene.disableFluidRenderer()}}class h0{static _SceneComponentInitialization(e){let t=e._getComponent(Me.NAME_FLUIDRENDERER);t||(t=new Ble(e),e._addComponent(t))}constructor(e){this._scene=e,this._engine=e.getEngine(),this._onEngineResizeObserver=null,this.renderObjects=[],this.targetRenderers=[],this._cameras=new Map,h0._SceneComponentInitialization(this._scene),this._onEngineResizeObserver=this._engine.onResizeObservable.add(()=>{this._initialize()})}recreate(){this._sortRenderingObjects(),this._initialize()}getRenderObjectFromParticleSystem(e){const t=this._getParticleSystemIndex(e);return-1!==t?this.renderObjects[t]:null}addParticleSystem(e,t,i,s){const n=new wle(this._scene,e);n.onParticleSizeChanged.add(this._setParticleSizeForRenderTargets.bind(this)),i||(i=new qH(this._scene,s),this.targetRenderers.push(i)),i._onUseVelocityChanged.hasObservers()||i._onUseVelocityChanged.add(this._setUseVelocityForRenderObject.bind(this)),void 0!==t&&(i.generateDiffuseTexture=t);const o={object:n,targetRenderer:i};return this.renderObjects.push(o),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),o}addCustomParticles(e,t,i,s,n){const o=new Ole(this._scene,e,t);o.onParticleSizeChanged.add(this._setParticleSizeForRenderTargets.bind(this)),s||(s=new qH(this._scene,n),this.targetRenderers.push(s)),s._onUseVelocityChanged.hasObservers()||s._onUseVelocityChanged.add(this._setUseVelocityForRenderObject.bind(this)),void 0!==i&&(s.generateDiffuseTexture=i);const a={object:o,targetRenderer:s};return this.renderObjects.push(a),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),a}removeRenderObject(e,t=!0){const i=this.renderObjects.indexOf(e);return-1!==i&&(e.object.dispose(),this.renderObjects.splice(i,1),t&&this._removeUnusedTargetRenderers()?this._initialize():this._setParticleSizeForRenderTargets(),!0)}_sortRenderingObjects(){this.renderObjects.sort((e,t)=>e.object.priority<t.object.priority?-1:e.object.priority>t.object.priority?1:0)}_removeUnusedTargetRenderers(){const e={};for(let s=0;s<this.renderObjects.length;++s)e[this.targetRenderers.indexOf(this.renderObjects[s].targetRenderer)]=!0;let t=!1;const i=[];for(let s=0;s<this.targetRenderers.length;++s)e[s]?i.push(this.targetRenderers[s]):(this.targetRenderers[s].dispose(),t=!0);return t&&(this.targetRenderers.length=0,this.targetRenderers.push(...i)),t}_getParticleSystemIndex(e){for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t].object;if(i.particleSystem&&i.particleSystem===e)return t}return-1}_initialize(){for(let i=0;i<this.targetRenderers.length;++i)this.targetRenderers[i].dispose();const e=new Map;for(let i=0;i<this.targetRenderers.length;++i){const s=this.targetRenderers[i];if(s._initialize(),s.camera&&s._renderPostProcess){let n=e.get(s.camera);n||(n=[[],{}],e.set(s.camera,n)),n[0].push(s),s.camera.attachPostProcess(s._renderPostProcess,i)}}let t=e.keys();for(let i=t.next();!0!==i.done;i=t.next()){const s=i.value,n=e.get(s),o=s._getFirstPostProcess();if(!o)continue;const[a,l]=n;o.onSizeChangedObservable.add(()=>{var c;o.inputTexture.depthStencilTexture||o.inputTexture.createDepthStencilTexture(0,!0,this._engine.isStencilEnable,a[0].samples,this._engine.isStencilEnable?13:14);for(const h of a){const u=null===(c=h._thicknessRenderTarget)||void 0===c?void 0:c.renderTarget,d=u?.texture;if(u&&d){const f=d.width+"_"+d.height;let p=l[f];p||(p=l[f]=new Fle(this._engine,d.width,d.height)),p.depthRTWrapper._shareDepth(u)}}})}t=this._cameras.keys();for(let i=t.next();!0!==i.done;i=t.next()){const s=i.value,o=this._cameras.get(s)[1],a=e.get(s);if(a)for(const l in o)a[1][l]||o[l].dispose();else for(const l in o)o[l].dispose()}this._cameras.clear(),this._cameras=e,this._setParticleSizeForRenderTargets()}_setParticleSizeForRenderTargets(){const e=new Map;for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t];let s=e.get(i.targetRenderer);void 0===s&&(s=0),e.set(i.targetRenderer,Math.max(s,i.object.particleSize))}e.forEach((t,i)=>{i._depthRenderTarget&&(i._depthRenderTarget.particleSize=t)})}_setUseVelocityForRenderObject(){for(const e of this.renderObjects)e.object.useVelocity=e.targetRenderer.useVelocity}_prepareRendering(){for(const e of this.targetRenderers)if(e.needInitialization)return void this._initialize()}_render(e){var t;for(let s=0;s<this.targetRenderers.length;++s)(!e||this.targetRenderers[s].camera===e)&&this.targetRenderers[s]._clearTargets();const i=this._cameras.keys();for(let s=i.next();!0!==s.done;s=i.next()){const n=s.value,o=this._cameras.get(n);if(e&&n!==e)continue;const a=n._getFirstPostProcess();if(!a)continue;const l=null===(t=a.inputTexture)||void 0===t?void 0:t.depthStencilTexture;if(l){const[c,h]=o;for(const u of c)u._bgDepthTexture=l;for(const u in h)h[u].copy(l)}}for(let s=0;s<this.renderObjects.length;++s){const n=this.renderObjects[s];(!e||n.targetRenderer.camera===e)&&n.targetRenderer._render(n.object)}}dispose(){this._engine.onResizeObservable.remove(this._onEngineResizeObserver),this._onEngineResizeObserver=null;for(let e=0;e<this.renderObjects.length;++e)this.renderObjects[e].object.dispose();for(let e=0;e<this.targetRenderers.length;++e)this.targetRenderers[e].dispose();this._cameras.forEach(e=>{const t=e[1];for(const i in t)t[i].dispose()}),this.renderObjects=[],this.targetRenderers=[],this._cameras.clear()}}class u0 extends class Vle{get animationStarted(){return this._animationStarted}get fromIndex(){return this._fromIndex}get toIndex(){return this._toIndex}get loopAnimation(){return this._loopAnimation}get delay(){return Math.max(this._delay,1)}constructor(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._onBaseAnimationEnd=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}playAnimation(e,t,i,s,n){this._fromIndex=e,this._toIndex=t,this._loopAnimation=i,this._delay=s||1,this._animationStarted=!0,this._onBaseAnimationEnd=n,e<t?this._direction=1:(this._direction=-1,this._toIndex=e,this._fromIndex=t),this.cellIndex=e,this._time=0}stopAnimation(){this._animationStarted=!1}_animate(e){!this._animationStarted||(this._time+=e,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,(this._direction>0&&this.cellIndex>this._toIndex||this._direction<0&&this.cellIndex<this._fromIndex)&&(this._loopAnimation?this.cellIndex=this._direction>0?this._fromIndex:this._toIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onBaseAnimationEnd&&this._onBaseAnimationEnd()))))}}{get size(){return this.width}set size(e){this.width=e,this.height=e}get manager(){return this._manager}constructor(e,t){super(),this.name=e,this.animations=new Array,this.isPickable=!1,this.useAlphaForPicking=!1,this.onDisposeObservable=new z,this._onAnimationEnd=null,this._endAnimation=()=>{this._onAnimationEnd&&this._onAnimationEnd(),this.disposeWhenFinishedAnimating&&this.dispose()},this.color=new Te(1,1,1,1),this.position=v.Zero(),this._manager=t,this._manager.sprites.push(this),this.uniqueId=this._manager.scene.getUniqueId()}getClassName(){return"Sprite"}get fromIndex(){return this._fromIndex}set fromIndex(e){this.playAnimation(e,this._toIndex,this._loopAnimation,this._delay,this._onAnimationEnd)}get toIndex(){return this._toIndex}set toIndex(e){this.playAnimation(this._fromIndex,e,this._loopAnimation,this._delay,this._onAnimationEnd)}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){this.playAnimation(this._fromIndex,this._toIndex,e,this._delay,this._onAnimationEnd)}get delay(){return Math.max(this._delay,1)}set delay(e){this.playAnimation(this._fromIndex,this._toIndex,this._loopAnimation,e,this._onAnimationEnd)}playAnimation(e,t,i,s,n=null){this._onAnimationEnd=n,super.playAnimation(e,t,i,s,this._endAnimation)}dispose(){for(let e=0;e<this._manager.sprites.length;e++)this._manager.sprites[e]==this&&this._manager.sprites.splice(e,1);this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}serialize(){const e={};return e.name=this.name,e.position=this.position.asArray(),e.color=this.color.asArray(),e.width=this.width,e.height=this.height,e.angle=this.angle,e.cellIndex=this.cellIndex,e.cellRef=this.cellRef,e.invertU=this.invertU,e.invertV=this.invertV,e.disposeWhenFinishedAnimating=this.disposeWhenFinishedAnimating,e.isPickable=this.isPickable,e.isVisible=this.isVisible,e.useAlphaForPicking=this.useAlphaForPicking,e.animationStarted=this.animationStarted,e.fromIndex=this.fromIndex,e.toIndex=this.toIndex,e.loopAnimation=this.loopAnimation,e.delay=this.delay,e}static Parse(e,t){const i=new u0(e.name,t);return i.position=v.FromArray(e.position),i.color=Te.FromArray(e.color),i.width=e.width,i.height=e.height,i.angle=e.angle,i.cellIndex=e.cellIndex,i.cellRef=e.cellRef,i.invertU=e.invertU,i.invertV=e.invertV,i.disposeWhenFinishedAnimating=e.disposeWhenFinishedAnimating,i.isPickable=e.isPickable,i.isVisible=e.isVisible,i.useAlphaForPicking=e.useAlphaForPicking,i.fromIndex=e.fromIndex,i.toIndex=e.toIndex,i.loopAnimation=e.loopAnimation,i.delay=e.delay,e.animationStarted&&i.playAnimation(i.fromIndex,i.toIndex,i.loopAnimation,i.delay),i}}ge.prototype._internalPickSprites=function(r,e,t,i){if(!Os)return null;let s=null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let n=0;n<this.spriteManagers.length;n++){const o=this.spriteManagers[n];if(!o.isPickable)continue;const a=o.intersects(r,i,e,t);if(a&&a.hit&&(t||null==s||!(a.distance>=s.distance))&&(s=a,t))break}return s||new Os},ge.prototype._internalMultiPickSprites=function(r,e,t){if(!Os)return null;let i=new Array;if(!t){if(!this.activeCamera)return null;t=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let s=0;s<this.spriteManagers.length;s++){const n=this.spriteManagers[s];if(!n.isPickable)continue;const o=n.multiIntersects(r,t,e);null!==o&&(i=i.concat(o))}return i},ge.prototype.pickSprite=function(r,e,t,i,s){if(!this._tempSpritePickingRay)return null;this.createPickingRayInCameraSpaceToRef(r,e,this._tempSpritePickingRay,s);const n=this._internalPickSprites(this._tempSpritePickingRay,t,i,s);return n&&(n.ray=this.createPickingRayInCameraSpace(r,e,s)),n},ge.prototype.pickSpriteWithRay=function(r,e,t,i){if(!this._tempSpritePickingRay)return null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}Qe.TransformToRef(r,i.getViewMatrix(),this._tempSpritePickingRay);const s=this._internalPickSprites(this._tempSpritePickingRay,e,t,i);return s&&(s.ray=r),s},ge.prototype.multiPickSprite=function(r,e,t,i){return this.createPickingRayInCameraSpaceToRef(r,e,this._tempSpritePickingRay,i),this._internalMultiPickSprites(this._tempSpritePickingRay,t,i)},ge.prototype.multiPickSpriteWithRay=function(r,e,t){if(!this._tempSpritePickingRay)return null;if(!t){if(!this.activeCamera)return null;t=this.activeCamera}return Qe.TransformToRef(r,t.getViewMatrix(),this._tempSpritePickingRay),this._internalMultiPickSprites(this._tempSpritePickingRay,e,t)},ge.prototype.setPointerOverSprite=function(r){this._pointerOverSprite!==r&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(10,gi.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=r,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(9,gi.CreateNewFromSprite(this._pointerOverSprite,this)))},ge.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};class Ule{constructor(e){this.name=Me.NAME_SPRITE,this.scene=e,this.scene.spriteManagers=new Array,this.scene._tempSpritePickingRay=Qe?Qe.Zero():null,this.scene.onBeforeSpritesRenderingObservable=new z,this.scene.onAfterSpritesRenderingObservable=new z,this._spritePredicate=t=>!!t.actionManager&&t.isPickable&&t.actionManager.hasPointerTriggers}register(){this.scene._pointerMoveStage.registerStep(Me.STEP_POINTERMOVE_SPRITE,this,this._pointerMove),this.scene._pointerDownStage.registerStep(Me.STEP_POINTERDOWN_SPRITE,this,this._pointerDown),this.scene._pointerUpStage.registerStep(Me.STEP_POINTERUP_SPRITE,this,this._pointerUp)}rebuild(){}dispose(){this.scene.onBeforeSpritesRenderingObservable.clear(),this.scene.onAfterSpritesRenderingObservable.clear();const e=this.scene.spriteManagers;if(e)for(;e.length;)e[0].dispose()}_pickSpriteButKeepRay(e,t,i,s,n){const o=this.scene.pickSprite(t,i,this._spritePredicate,s,n);return o&&(o.ray=e?e.ray:null),o}_pointerMove(e,t,i,s,n){const o=this.scene;return s?o.setPointerOverSprite(null):(i=this._pickSpriteButKeepRay(i,e,t,!1,o.cameraToUseForPointers||void 0))&&i.hit&&i.pickedSprite?(o.setPointerOverSprite(i.pickedSprite),!o.doNotHandleCursors&&n&&(n.style.cursor=o._pointerOverSprite&&o._pointerOverSprite.actionManager&&o._pointerOverSprite.actionManager.hoverCursor?o._pointerOverSprite.actionManager.hoverCursor:o.hoverCursor)):o.setPointerOverSprite(null),i}_pointerDown(e,t,i,s){const n=this.scene;if(n._pickedDownSprite=null,n.spriteManagers&&n.spriteManagers.length>0&&(i=n.pickSprite(e,t,this._spritePredicate,!1,n.cameraToUseForPointers||void 0))&&i.hit&&i.pickedSprite&&i.pickedSprite.actionManager){switch(n._pickedDownSprite=i.pickedSprite,s.button){case 0:i.pickedSprite.actionManager.processTrigger(2,gi.CreateNewFromSprite(i.pickedSprite,n,s));break;case 1:i.pickedSprite.actionManager.processTrigger(4,gi.CreateNewFromSprite(i.pickedSprite,n,s));break;case 2:i.pickedSprite.actionManager.processTrigger(3,gi.CreateNewFromSprite(i.pickedSprite,n,s))}i.pickedSprite.actionManager&&i.pickedSprite.actionManager.processTrigger(5,gi.CreateNewFromSprite(i.pickedSprite,n,s))}return i}_pointerUp(e,t,i,s,n){const o=this.scene;if(o.spriteManagers&&o.spriteManagers.length>0){const a=o.pickSprite(e,t,this._spritePredicate,!1,o.cameraToUseForPointers||void 0);a&&(a.hit&&a.pickedSprite&&a.pickedSprite.actionManager&&(a.pickedSprite.actionManager.processTrigger(7,gi.CreateNewFromSprite(a.pickedSprite,o,s)),a.pickedSprite.actionManager&&(this.scene._inputManager._isPointerSwiping()||a.pickedSprite.actionManager.processTrigger(1,gi.CreateNewFromSprite(a.pickedSprite,o,s)),n&&a.pickedSprite.actionManager.processTrigger(6,gi.CreateNewFromSprite(a.pickedSprite,o,s)))),o._pickedDownSprite&&o._pickedDownSprite.actionManager&&o._pickedDownSprite!==a.pickedSprite&&o._pickedDownSprite.actionManager.processTrigger(16,gi.CreateNewFromSprite(o._pickedDownSprite,o,s)))}return i}}j.IncludesShadersStore.imageProcessingCompatibility="#ifdef IMAGEPROCESSINGPOSTPROCESS\ngl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));\n#endif\n";j.ShadersStore.spritesPixelShader="uniform bool alphaTest;\nvarying vec4 vColor;\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#ifdef PIXEL_PERFECT\nvec2 uvPixelPerfect(vec2 uv) {\nvec2 res=vec2(textureSize(diffuseSampler,0));\nuv=uv*res;\nvec2 seam=floor(uv+0.5);\nuv=seam+clamp((uv-seam)/fwidth(uv),-0.5,0.5);\nreturn uv/res;\n}\n#endif\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#ifdef PIXEL_PERFECT\nvec2 uv=uvPixelPerfect(vUV);\n#else\nvec2 uv=vUV;\n#endif\nvec4 color=texture2D(diffuseSampler,uv);\nfloat fAlphaTest=float(alphaTest);\nif (fAlphaTest != 0.)\n{\nif (color.a<0.95)\ndiscard;\n}\ncolor*=vColor;\n#include<fogFragment>\ngl_FragColor=color;\n#include<imageProcessingCompatibility>\n#define CUSTOM_FRAGMENT_MAIN_END\n}";j.ShadersStore.spritesVertexShader="attribute vec4 position;\nattribute vec2 options;\nattribute vec2 offsets;\nattribute vec2 inverts;\nattribute vec4 cellInfo;\nattribute vec4 color;\nuniform mat4 view;\nuniform mat4 projection;\nvarying vec2 vUV;\nvarying vec4 vColor;\n#include<fogVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; \nvec2 cornerPos;\nfloat angle=position.w;\nvec2 size=vec2(options.x,options.y);\nvec2 offset=offsets.xy;\ncornerPos=vec2(offset.x-0.5,offset.y -0.5)*size;\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\nviewPos+=rotatedCorner;\ngl_Position=projection*vec4(viewPos,1.0); \nvColor=color;\nvec2 uvOffset=vec2(abs(offset.x-inverts.x),abs(1.0-offset.y-inverts.y));\nvec2 uvPlace=cellInfo.xy;\nvec2 uvSize=cellInfo.zw;\nvUV.x=uvPlace.x+uvSize.x*uvOffset.x;\nvUV.y=uvPlace.y+uvSize.y*uvOffset.y;\n#ifdef FOG\nvFogDistance=viewPos;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}";class kle{get capacity(){return this._capacity}get pixelPerfect(){return this._pixelPerfect}set pixelPerfect(e){this._pixelPerfect!==e&&(this._pixelPerfect=e,this._createEffects())}constructor(e,t,i=.01,s=null){this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this.fogEnabled=!0,this._pixelPerfect=!1,this._useVAO=!1,this._useInstancing=!1,this._vertexBuffers={},this._capacity=t,this._epsilon=i,this._engine=e,this._useInstancing=e.getCaps().instancedArrays&&e._features.supportSpriteInstancing,this._useVAO=e.getCaps().vertexArrayObject&&!e.disableVertexArrayObjects,this._scene=s,this._useInstancing||this._buildIndexBuffer(),this._vertexBufferSize=this._useInstancing?16:18,this._vertexData=new Float32Array(t*this._vertexBufferSize*(this._useInstancing?1:4)),this._buffer=new kn(e,this._vertexData,!0,this._vertexBufferSize);const n=this._buffer.createVertexBuffer(A.PositionKind,0,4,this._vertexBufferSize,this._useInstancing),o=this._buffer.createVertexBuffer("options",4,2,this._vertexBufferSize,this._useInstancing);let l,a=6;if(this._useInstancing){const d=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new kn(e,d,!1,2),l=this._spriteBuffer.createVertexBuffer("offsets",0,2)}else l=this._buffer.createVertexBuffer("offsets",a,2,this._vertexBufferSize,this._useInstancing),a+=2;const c=this._buffer.createVertexBuffer("inverts",a,2,this._vertexBufferSize,this._useInstancing),h=this._buffer.createVertexBuffer("cellInfo",a+2,4,this._vertexBufferSize,this._useInstancing),u=this._buffer.createVertexBuffer(A.ColorKind,a+6,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[A.PositionKind]=n,this._vertexBuffers.options=o,this._vertexBuffers.offsets=l,this._vertexBuffers.inverts=c,this._vertexBuffers.cellInfo=h,this._vertexBuffers[A.ColorKind]=u,this._createEffects()}_createEffects(){var e,t,i,s;null===(e=this._drawWrapperBase)||void 0===e||e.dispose(),null===(t=this._drawWrapperFog)||void 0===t||t.dispose(),null===(i=this._drawWrapperDepth)||void 0===i||i.dispose(),null===(s=this._drawWrapperFogDepth)||void 0===s||s.dispose(),this._drawWrapperBase=new $i(this._engine),this._drawWrapperFog=new $i(this._engine),this._drawWrapperDepth=new $i(this._engine,!1),this._drawWrapperFogDepth=new $i(this._engine,!1),this._drawWrapperBase.drawContext&&(this._drawWrapperBase.drawContext.useInstancing=this._useInstancing),this._drawWrapperFog.drawContext&&(this._drawWrapperFog.drawContext.useInstancing=this._useInstancing),this._drawWrapperDepth.drawContext&&(this._drawWrapperDepth.drawContext.useInstancing=this._useInstancing),this._drawWrapperFogDepth.drawContext&&(this._drawWrapperFogDepth.drawContext.useInstancing=this._useInstancing);const n=this._pixelPerfect?"#define PIXEL_PERFECT\n":"";this._drawWrapperBase.effect=this._engine.createEffect("sprites",[A.PositionKind,"options","offsets","inverts","cellInfo",A.ColorKind],["view","projection","textureInfos","alphaTest"],["diffuseSampler"],n),this._drawWrapperDepth.effect=this._drawWrapperBase.effect,this._drawWrapperDepth.materialContext=this._drawWrapperBase.materialContext,this._scene&&(this._drawWrapperFog.effect=this._scene.getEngine().createEffect("sprites",[A.PositionKind,"options","offsets","inverts","cellInfo",A.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor"],["diffuseSampler"],n+"#define FOG"),this._drawWrapperFogDepth.effect=this._drawWrapperFog.effect,this._drawWrapperFogDepth.materialContext=this._drawWrapperFog.materialContext)}render(e,t,i,s,n=null){if(!this.texture||!this.texture.isReady()||!e.length)return;let o=this._drawWrapperBase,a=this._drawWrapperDepth,l=!1;this.fogEnabled&&this._scene&&this._scene.fogEnabled&&0!==this._scene.fogMode&&(o=this._drawWrapperFog,a=this._drawWrapperFogDepth,l=!0);const c=o.effect;if(!c.isReady())return;const h=this._engine,u=!(!this._scene||!this._scene.useRightHandedSystem),d=this.texture.getBaseSize(),f=Math.min(this._capacity,e.length);let p=0,_=!0;for(let y=0;y<f;y++){const T=e[y];!T||!T.isVisible||(_=!1,T._animate(t),this._appendSpriteVertex(p++,T,0,0,d,u,n),this._useInstancing||(this._appendSpriteVertex(p++,T,1,0,d,u,n),this._appendSpriteVertex(p++,T,1,1,d,u,n),this._appendSpriteVertex(p++,T,0,1,d,u,n)))}if(_)return;this._buffer.update(this._vertexData);const m=!!h.depthCullingState.cull,g=h.depthCullingState.zOffset,b=h.depthCullingState.zOffsetUnits;if(h.setState(m,g,!1,!1,void 0,void 0,b),h.enableEffect(o),c.setTexture("diffuseSampler",this.texture),c.setMatrix("view",i),c.setMatrix("projection",s),l){const y=this._scene;c.setFloat4("vFogInfos",y.fogMode,y.fogStart,y.fogEnd,y.fogDensity),c.setColor3("vFogColor",y.fogColor)}this._useVAO?(this._vertexArrayObject||(this._vertexArrayObject=h.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,c)),h.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):h.bindBuffers(this._vertexBuffers,this._indexBuffer,c),h.depthCullingState.depthFunc=h.useReverseDepthBuffer?518:515,this.disableDepthWrite||(c.setBool("alphaTest",!0),h.setColorWrite(!1),h.enableEffect(a),this._useInstancing?h.drawArraysType(7,0,4,p):h.drawElementsType(0,0,p/4*6),h.enableEffect(o),h.setColorWrite(!0),c.setBool("alphaTest",!1)),h.setAlphaMode(this.blendMode),this._useInstancing?h.drawArraysType(7,0,4,p):h.drawElementsType(0,0,p/4*6),this.autoResetAlpha&&h.setAlphaMode(0),u&&this._scene.getEngine().setState(m,g,!1,!0,void 0,void 0,b),h.unbindInstanceAttributes()}_appendSpriteVertex(e,t,i,s,n,o,a){let l=e*this._vertexBufferSize;if(0===i?i=this._epsilon:1===i&&(i=1-this._epsilon),0===s?s=this._epsilon:1===s&&(s=1-this._epsilon),a)a(t,n);else{t.cellIndex||(t.cellIndex=0);const c=n.width/this.cellWidth,h=t.cellIndex/c>>0;t._xOffset=(t.cellIndex-h*c)*this.cellWidth/n.width,t._yOffset=h*this.cellHeight/n.height,t._xSize=this.cellWidth,t._ySize=this.cellHeight}this._vertexData[l]=t.position.x,this._vertexData[l+1]=t.position.y,this._vertexData[l+2]=t.position.z,this._vertexData[l+3]=t.angle,this._vertexData[l+4]=t.width,this._vertexData[l+5]=t.height,this._useInstancing?l-=2:(this._vertexData[l+6]=i,this._vertexData[l+7]=s),this._vertexData[l+8]=o?t.invertU?0:1:t.invertU?1:0,this._vertexData[l+9]=t.invertV?1:0,this._vertexData[l+10]=t._xOffset,this._vertexData[l+11]=t._yOffset,this._vertexData[l+12]=t._xSize/n.width,this._vertexData[l+13]=t._ySize/n.height,this._vertexData[l+14]=t.color.r,this._vertexData[l+15]=t.color.g,this._vertexData[l+16]=t.color.b,this._vertexData[l+17]=t.color.a}_buildIndexBuffer(){const e=[];let t=0;for(let i=0;i<this._capacity;i++)e.push(t),e.push(t+1),e.push(t+2),e.push(t),e.push(t+2),e.push(t+3),t+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}rebuild(){var e;this._indexBuffer&&this._buildIndexBuffer(),this._useVAO&&(this._vertexArrayObject=void 0),this._buffer._rebuild();for(const t in this._vertexBuffers)this._vertexBuffers[t]._rebuild();null===(e=this._spriteBuffer)||void 0===e||e._rebuild()}dispose(){this._buffer&&(this._buffer.dispose(),this._buffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this.texture&&(this.texture.dispose(),this.texture=null),this._drawWrapperBase.dispose(),this._drawWrapperFog.dispose(),this._drawWrapperDepth.dispose(),this._drawWrapperFogDepth.dispose()}}class pc{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get children(){return this.sprites}get scene(){return this._scene}get capacity(){return this._spriteRenderer.capacity}get texture(){return this._spriteRenderer.texture}set texture(e){e.wrapU=U.CLAMP_ADDRESSMODE,e.wrapV=U.CLAMP_ADDRESSMODE,this._spriteRenderer.texture=e,this._textureContent=null}get cellWidth(){return this._spriteRenderer.cellWidth}set cellWidth(e){this._spriteRenderer.cellWidth=e}get cellHeight(){return this._spriteRenderer.cellHeight}set cellHeight(e){this._spriteRenderer.cellHeight=e}get fogEnabled(){return this._spriteRenderer.fogEnabled}set fogEnabled(e){this._spriteRenderer.fogEnabled=e}get blendMode(){return this._spriteRenderer.blendMode}set blendMode(e){this._spriteRenderer.blendMode=e}get disableDepthWrite(){return this._disableDepthWrite}set disableDepthWrite(e){this._disableDepthWrite=e,this._spriteRenderer.disableDepthWrite=e}get pixelPerfect(){return this._spriteRenderer.pixelPerfect}set pixelPerfect(e){this._spriteRenderer.pixelPerfect=e}constructor(e,t,i,s,n,o=.01,a=U.TRILINEAR_SAMPLINGMODE,l=!1,c=null){this.name=e,this.sprites=new Array,this.renderingGroupId=0,this.layerMask=268435455,this.isPickable=!1,this.metadata=null,this._wasDispatched=!1,this.onDisposeObservable=new z,this._disableDepthWrite=!1,this._packedAndReady=!1,this._customUpdate=(u,d)=>{u.cellRef||(u.cellIndex=0);const f=u.cellIndex;"number"==typeof f&&isFinite(f)&&Math.floor(f)===f&&(u.cellRef=this._spriteMap[u.cellIndex]),u._xOffset=this._cellData[u.cellRef].frame.x/d.width,u._yOffset=this._cellData[u.cellRef].frame.y/d.height,u._xSize=this._cellData[u.cellRef].frame.w,u._ySize=this._cellData[u.cellRef].frame.h},n||(n=be.LastCreatedScene),n._getComponent(Me.NAME_SPRITE)||n._addComponent(new Ule(n)),this._fromPacked=l,this._scene=n;const h=this._scene.getEngine();if(this._spriteRenderer=new kle(h,i,o,n),s.width&&s.height)this.cellWidth=s.width,this.cellHeight=s.height;else{if(void 0===s)return void(this._spriteRenderer=null);this.cellWidth=s,this.cellHeight=s}this._scene.spriteManagers&&this._scene.spriteManagers.push(this),this.uniqueId=this.scene.getUniqueId(),t&&(this.texture=new U(t,n,!0,!1,a)),this._fromPacked&&this._makePacked(t,c)}getClassName(){return"SpriteManager"}_makePacked(e,t){if(null!==t)try{let i;if(i="string"==typeof t?JSON.parse(t):t,i.frames.length){const n={};for(let o=0;o<i.frames.length;o++){const a=i.frames[o];if("string"!=typeof Object.keys(a)[0])throw new Error("Invalid JSON Format.  Check the frame values and make sure the name is the first parameter.");n[a[Object.keys(a)[0]]]=a}i.frames=n}const s=Reflect.ownKeys(i.frames);this._spriteMap=s,this._packedAndReady=!0,this._cellData=i.frames}catch{throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON from string. Spritesheet managed with constant cell size.")}else{const i=/\./g;let s;do{s=i.lastIndex,i.test(e)}while(i.lastIndex>0);const n=e.substring(0,s-1)+".json";q.LoadFile(n,l=>{try{const c=JSON.parse(l),h=Reflect.ownKeys(c.frames);this._spriteMap=h,this._packedAndReady=!0,this._cellData=c.frames}catch{throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON format. Please check documentation for format specifications.")}},void 0,void 0,!1,()=>{V.Error("JSON ERROR: Unable to load JSON file."),this._fromPacked=!1,this._packedAndReady=!1})}}_checkTextureAlpha(e,t,i,s,n){if(!e.useAlphaForPicking||!this.texture)return!0;const o=this.texture.getSize();this._textureContent||(this._textureContent=new Uint8Array(o.width*o.height*4),this.texture.readPixels(0,0,this._textureContent));const a=L.Vector3[0];a.copyFrom(t.direction),a.normalize(),a.scaleInPlace(i),a.addInPlace(t.origin);const l=(a.x-s.x)/(n.x-s.x)-.5,c=1-(a.y-s.y)/(n.y-s.y)-.5,h=e.angle,u=l*Math.cos(h)-c*Math.sin(h)+.5,d=l*Math.sin(h)+c*Math.cos(h)+.5;return this._textureContent[4*((e._xOffset*o.width+u*e._xSize|0)+(e._yOffset*o.height+d*e._ySize|0)*o.width)+3]>.5}intersects(e,t,i,s){const n=Math.min(this.capacity,this.sprites.length),o=v.Zero(),a=v.Zero();let l=Number.MAX_VALUE,c=null;const h=L.Vector3[0],u=L.Vector3[1],d=t.getViewMatrix();let f=e,p=e;for(let _=0;_<n;_++){const m=this.sprites[_];if(m){if(i){if(!i(m))continue}else if(!m.isPickable)continue;if(v.TransformCoordinatesToRef(m.position,d,u),m.angle?(F.TranslationToRef(-u.x,-u.y,0,L.Matrix[1]),F.TranslationToRef(u.x,u.y,0,L.Matrix[2]),F.RotationZToRef(m.angle,L.Matrix[3]),L.Matrix[1].multiplyToRef(L.Matrix[3],L.Matrix[4]),L.Matrix[4].multiplyToRef(L.Matrix[2],L.Matrix[0]),f=e.clone(),v.TransformCoordinatesToRef(e.origin,L.Matrix[0],f.origin),v.TransformNormalToRef(e.direction,L.Matrix[0],f.direction)):f=e,o.copyFromFloats(u.x-m.width/2,u.y-m.height/2,u.z),a.copyFromFloats(u.x+m.width/2,u.y+m.height/2,u.z),f.intersectsBoxMinMax(o,a)){const g=v.Distance(u,f.origin);if(l>g){if(!this._checkTextureAlpha(m,f,g,o,a))continue;if(p=f,l=g,c=m,s)break}}}}if(c){const _=new Os;d.invertToRef(L.Matrix[0]),_.hit=!0,_.pickedSprite=c,_.distance=l;const m=L.Vector3[2];return m.copyFrom(p.direction),m.normalize(),m.scaleInPlace(l),p.origin.addToRef(m,h),_.pickedPoint=v.TransformCoordinates(h,L.Matrix[0]),_}return null}multiIntersects(e,t,i){const s=Math.min(this.capacity,this.sprites.length),n=v.Zero(),o=v.Zero();let a;const l=[],c=L.Vector3[0].copyFromFloats(0,0,0),h=L.Vector3[1].copyFromFloats(0,0,0),u=t.getViewMatrix();for(let d=0;d<s;d++){const f=this.sprites[d];if(f){if(i){if(!i(f))continue}else if(!f.isPickable)continue;if(v.TransformCoordinatesToRef(f.position,u,h),n.copyFromFloats(h.x-f.width/2,h.y-f.height/2,h.z),o.copyFromFloats(h.x+f.width/2,h.y+f.height/2,h.z),e.intersectsBoxMinMax(n,o)){if(a=v.Distance(h,e.origin),!this._checkTextureAlpha(f,e,a,n,o))continue;const p=new Os;l.push(p),u.invertToRef(L.Matrix[0]),p.hit=!0,p.pickedSprite=f,p.distance=a;const _=L.Vector3[2];_.copyFrom(e.direction),_.normalize(),_.scaleInPlace(a),e.origin.addToRef(_,c),p.pickedPoint=v.TransformCoordinates(c,L.Matrix[0])}}}return l}render(){if(this._fromPacked&&(!this._packedAndReady||!this._spriteMap||!this._cellData))return;const t=this._scene.getEngine().getDeltaTime();this._packedAndReady?this._spriteRenderer.render(this.sprites,t,this._scene.getViewMatrix(),this._scene.getProjectionMatrix(),this._customUpdate):this._spriteRenderer.render(this.sprites,t,this._scene.getViewMatrix(),this._scene.getProjectionMatrix())}rebuild(){var e;null===(e=this._spriteRenderer)||void 0===e||e.rebuild()}dispose(){if(this._spriteRenderer&&(this._spriteRenderer.dispose(),this._spriteRenderer=null),this._textureContent=null,this._scene.spriteManagers){const e=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(e,1)}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null}serialize(e=!1){const t={};t.name=this.name,t.capacity=this.capacity,t.cellWidth=this.cellWidth,t.cellHeight=this.cellHeight,t.fogEnabled=this.fogEnabled,t.blendMode=this.blendMode,t.disableDepthWrite=this.disableDepthWrite,t.pixelPerfect=this.pixelPerfect,this.texture&&(e?t.texture=this.texture.serialize():(t.textureUrl=this.texture.name,t.invertY=this.texture._invertY)),t.sprites=[];for(const i of this.sprites)t.sprites.push(i.serialize());return t.metadata=this.metadata,t}static Parse(e,t,i){const s=new pc(e.name,"",e.capacity,{width:e.cellWidth,height:e.cellHeight},t);void 0!==e.fogEnabled&&(s.fogEnabled=e.fogEnabled),void 0!==e.blendMode&&(s.blendMode=e.blendMode),void 0!==e.disableDepthWrite&&(s.disableDepthWrite=e.disableDepthWrite),void 0!==e.pixelPerfect&&(s.pixelPerfect=e.pixelPerfect),void 0!==e.metadata&&(s.metadata=e.metadata),e.texture?s.texture=U.Parse(e.texture,t,i):e.textureName&&(s.texture=new U(i+e.textureUrl,t,!1,void 0===e.invertY||e.invertY));for(const n of e.sprites)u0.Parse(n,s);return s}static ParseFromFileAsync(e,t,i,s=""){return new Promise((n,o)=>{const a=new Yi;a.addEventListener("readystatechange",()=>{if(4==a.readyState)if(200==a.status){const l=JSON.parse(a.responseText),c=pc.Parse(l,i||be.LastCreatedScene,s);e&&(c.name=e),n(c)}else o("Unable to load the sprite manager")}),a.open("GET",t),a.send()})}static ParseFromSnippetAsync(e,t,i=""){return"_BLANK"===e?Promise.resolve(new pc("Default sprite manager","//playground.babylonjs.com/textures/player.png",500,64,t)):new Promise((s,n)=>{const o=new Yi;o.addEventListener("readystatechange",()=>{if(4==o.readyState)if(200==o.status){const a=JSON.parse(JSON.parse(o.responseText).jsonPayload),l=JSON.parse(a.spriteManager),c=pc.Parse(l,t||be.LastCreatedScene,i);c.snippetId=e,s(c)}else n("Unable to load the snippet "+e)}),o.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),o.send()})}}pc.SnippetUrl="https://snippet.babylonjs.com",pc.CreateFromSnippetAsync=pc.ParseFromSnippetAsync;j.ShadersStore.spriteMapPixelShader="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\nprecision highp float;\nvarying vec3 vPosition;\nvarying vec2 vUV;\nvarying vec2 tUV;\nuniform float time;\nuniform float spriteCount;\nuniform sampler2D spriteSheet;\nuniform vec2 spriteMapSize;\nuniform vec2 outputSize;\nuniform vec2 stageSize;\nuniform sampler2D frameMap;\nuniform sampler2D tileMaps[LAYERS];\nuniform sampler2D animationMap;\nuniform vec3 colorMul;\nfloat mt;\nconst float fdStep=1./4.;\nconst float aFrameSteps=1./MAX_ANIMATION_FRAMES;\nmat4 getFrameData(float frameID){\nfloat fX=frameID/spriteCount;\nreturn mat4(\ntexture2D(frameMap,vec2(fX,0.),0.),\ntexture2D(frameMap,vec2(fX,fdStep*1.),0.),\ntexture2D(frameMap,vec2(fX,fdStep*2.),0.),\nvec4(0.)\n);\n}\nvoid main(){\nvec4 color=vec4(0.);\nvec2 tileUV=fract(tUV);\n#ifdef FLIPU\ntileUV.y=1.0-tileUV.y;\n#endif\nvec2 tileID=floor(tUV);\nvec2 sheetUnits=1./spriteMapSize;\nfloat spriteUnits=1./spriteCount;\nvec2 stageUnits=1./stageSize;\nfor(int i=0; i<LAYERS; i++) {\nfloat frameID;\n#define LAYER_ID_SWITCH\nvec4 animationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,0.),0.);\nif(animationData.y>0.) {\nmt=mod(time*animationData.z,1.0);\nfor(float f=0.; f<MAX_ANIMATION_FRAMES; f++){\nif(animationData.y>mt){\nframeID=animationData.x;\nbreak;\n}\nanimationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,aFrameSteps*f),0.);\n}\n}\nmat4 frameData=getFrameData(frameID+0.5);\nvec2 frameSize=(frameData[0].zw)/spriteMapSize;\nvec2 offset=frameData[0].xy*sheetUnits;\nvec2 ratio=frameData[2].xy/frameData[0].zw;\nif (frameData[2].z==1.){\ntileUV.xy=tileUV.yx;\n}\nvec4 nc=texture2D(spriteSheet,tileUV*frameSize+offset);\nif (i==0){\ncolor=nc;\n} else {\nfloat alpha=min(color.a+nc.a,1.0);\nvec3 mixed=mix(color.xyz,nc.xyz,nc.a);\ncolor=vec4(mixed,alpha);\n}\n}\ncolor.xyz*=colorMul;\ngl_FragColor=color;\n}";j.ShadersStore.spriteMapVertexShader="precision highp float;\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\nvarying vec3 vPosition;\nvarying vec2 vUV;\nvarying vec2 tUV;\nvarying vec2 stageUnits;\nvarying vec2 levelUnits;\nvarying vec2 tileID;\nuniform float time;\nuniform mat4 worldViewProjection;\nuniform vec2 outputSize;\nuniform vec2 stageSize;\nuniform vec2 spriteMapSize;\nuniform float stageScale;\nvoid main() {\nvec4 p=vec4( position,1. );\nvPosition=p.xyz;\nvUV=uv;\ntUV=uv*stageSize; \ngl_Position=worldViewProjection*p;\n}";class Jp{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}}z.prototype.notifyObserversWithPromise=function(){var r=Qt(function*(e,t=-1,i,s,n){let o=Promise.resolve(e);if(!this.observers.length)return o;const a=this._eventState;return a.mask=t,a.target=i,a.currentTarget=s,a.skipNextObservers=!1,a.userInfo=n,this.observers.forEach(l=>{a.skipNextObservers||l._willBeUnregistered||l.mask&t&&(o=o.then(l.scope?c=>(a.lastReturnValue=c,l.callback.apply(l.scope,[e,a])):c=>(a.lastReturnValue=c,l.callback(e,a))),l.unregisterOnNextCall&&this._deferUnregister(l))}),yield o,e});return function(e){return r.apply(this,arguments)}}();let _c=null;function Rb(r,e,t,i,s="image/png",n=!1){const{height:o,width:a}=OW(r,e,t);if(!o||!a)return void V.Error("Invalid 'size' parameter !");_c||(_c=document.createElement("canvas")),_c.width=a,_c.height=o;const l=_c.getContext("2d"),c=r.getRenderWidth()/r.getRenderHeight();let h=a,u=h/c;u>o&&(u=o,h=u*c);const d=Math.max(0,a-h)/2,f=Math.max(0,o-u)/2;e.getScene().activeCamera!==e?Ib(r,e,t,_=>{if(n){const m=new Blob([_]);q.DownloadBlob(m),i&&i("")}else i&&i(_)},s,1,r.getCreationOptions().antialias):r.onEndFrameObservable.addOnce(()=>{const _=r.getRenderingCanvas();l&&_&&l.drawImage(_,d,f,h,u),_c&&(n?(q.EncodeScreenshotCanvasData(_c,void 0,s),i&&i("")):q.EncodeScreenshotCanvasData(_c,i,s))})}function Ib(r,e,t,i,s="image/png",n=1,o=!1,a,l=!1,c=!1,h=!0){const{height:u,width:d}=OW(r,e,t),f={width:d,height:u};if(!u||!d)return void V.Error("Invalid 'size' parameter !");const p={width:r.getRenderWidth(),height:r.getRenderHeight()};r.setSize(d,u);const _=e.getScene(),m=new Ss("screenShot",f,_,!1,!1,0,!1,U.NEAREST_SAMPLINGMODE,void 0,c,void 0,void 0,void 0,n);m.renderList=_.meshes.slice(),m.samples=n,m.renderSprites=l,m.activeCamera=e,m.forceLayerMaskCheck=h;const g=()=>{r.onEndFrameObservable.addOnce(()=>{m.readPixels(void 0,void 0,void 0,!1).then(b=>{_r.DumpData(d,u,b,i,s,a,!0),m.dispose()})}),_.incrementRenderId(),_.resetCachedMaterial(),m.render(!0),_.incrementRenderId(),_.resetCachedMaterial(),r.setSize(p.width,p.height),e.getProjectionMatrix(!0),_.render()};if(o){const b=new bd("antialiasing",1,_.activeCamera);m.addPostProcess(b),b.getEffect().isReady()?g():b.getEffect().onCompiled=()=>{g()}}else g()}function OW(r,e,t){let i=0,s=0;if("object"==typeof t){const n=t.precision?Math.abs(t.precision):1;t.width&&t.height?(i=t.height*n,s=t.width*n):t.width&&!t.height?(s=t.width*n,i=Math.round(s/r.getAspectRatio(e))):t.height&&!t.width?(i=t.height*n,s=Math.round(i*r.getAspectRatio(e))):(s=Math.round(r.getRenderWidth()*n),i=Math.round(s/r.getAspectRatio(e)))}else isNaN(t)||(i=t,s=t);return s&&(s=Math.floor(s)),i&&(i=Math.floor(i)),{height:0|i,width:0|s}}var Mb;q.CreateScreenshot=Rb,q.CreateScreenshotAsync=function DW(r,e,t,i="image/png"){return new Promise((s,n)=>{Rb(r,e,t,o=>{typeof o<"u"?s(o):n(new Error("Data is undefined"))},i)})},q.CreateScreenshotUsingRenderTarget=Ib,q.CreateScreenshotUsingRenderTargetAsync=function wW(r,e,t,i="image/png",s=1,n=!1,o,a=!1,l=!1,c=!0){return new Promise((h,u)=>{Ib(r,e,t,d=>{typeof d<"u"?h(d):u(new Error("Data is undefined"))},i,s,n,o,a,l,c)})};class y0{constructor(e){this.byteOffset=0,this.buffer=e}loadAsync(e){return this.buffer.readAsync(this.byteOffset,e).then(t=>{this._dataView=new DataView(t.buffer,t.byteOffset,t.byteLength),this._dataByteOffset=0})}readUint32(){const e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return(r=>{if(typeof TextDecoder<"u")return(new TextDecoder).decode(r);let e="";for(let t=0;t<r.byteLength;t++)e+=String.fromCharCode(r[t]);return e})(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}}class NW{static _GetStorage(){try{return localStorage.setItem("test",""),localStorage.removeItem("test"),localStorage}catch{const t={};return{getItem:i=>{const s=t[i];return void 0===s?null:s},setItem:(i,s)=>{t[i]=s}}}}static ReadString(e,t){const i=this._Storage.getItem(e);return null!==i?i:t}static WriteString(e,t){this._Storage.setItem(e,t)}static ReadBoolean(e,t){const i=this._Storage.getItem(e);return null!==i?"true"===i:t}static WriteBoolean(e,t){this._Storage.setItem(e,t?"true":"false")}static ReadNumber(e,t){const i=this._Storage.getItem(e);return null!==i?parseFloat(i):t}static WriteNumber(e,t){this._Storage.setItem(e,t.toString())}}NW._Storage=NW._GetStorage(),function(r){class e{serialize(){const s={},n=new Array(this._characterToIdx.size);return this._characterToIdx.forEach((o,a)=>{n[o]=a}),s.characters=n,s.insertionCosts=this._insertionCosts,s.deletionCosts=this._deletionCosts,s.substitutionCosts=this._substitutionCosts,JSON.stringify(s)}static Deserialize(s){const n=JSON.parse(s),o=new e(n.characters);return o._insertionCosts=n.insertionCosts,o._deletionCosts=n.deletionCosts,o._substitutionCosts=n.substitutionCosts,o}constructor(s,n=null,o=null,a=null){let l;n=n??(()=>1),o=o??(()=>1),a=a??((c,h)=>c===h?0:1),this._characterToIdx=new Map,this._insertionCosts=new Array(s.length),this._deletionCosts=new Array(s.length),this._substitutionCosts=new Array(s.length);for(let c=0;c<s.length;++c){l=s[c],this._characterToIdx.set(l,c),this._insertionCosts[c]=n(l),this._deletionCosts[c]=o(l),this._substitutionCosts[c]=new Array(s.length);for(let h=c;h<s.length;++h)this._substitutionCosts[c][h]=a(l,s[h])}}getCharacterIdx(s){return this._characterToIdx.get(s)}getInsertionCost(s){return this._insertionCosts[s]}getDeletionCost(s){return this._deletionCosts[s]}getSubstitutionCost(s,n){const o=Math.min(s,n),a=Math.max(s,n);return this._substitutionCosts[o][a]}}r.Alphabet=e;class t{serialize(){return JSON.stringify(this._characters)}static Deserialize(s,n){const o=new t([],n);return o._characters=JSON.parse(s),o}constructor(s,n){if(s.length>t._MAX_SEQUENCE_LENGTH)throw new Error("Sequences longer than "+t._MAX_SEQUENCE_LENGTH+" not supported.");this._alphabet=n,this._characters=s.map(o=>this._alphabet.getCharacterIdx(o))}distance(s){return t._Distance(this,s)}static _Distance(s,n){const o=s._alphabet;if(o!==n._alphabet)throw new Error("Cannot Levenshtein compare Sequences built from different alphabets.");const a=s._characters,l=n._characters,c=a.length,h=l.length,u=t._CostMatrix;u[0][0]=0;for(let d=0;d<c;++d)u[d+1][0]=u[d][0]+o.getInsertionCost(a[d]);for(let d=0;d<h;++d)u[0][d+1]=u[0][d]+o.getInsertionCost(l[d]);for(let d=0;d<c;++d)for(let f=0;f<h;++f)t._InsertionCost=u[d+1][f]+o.getInsertionCost(l[f]),t._DeletionCost=u[d][f+1]+o.getDeletionCost(a[d]),t._SubstitutionCost=u[d][f]+o.getSubstitutionCost(a[d],l[f]),u[d+1][f+1]=Math.min(t._InsertionCost,t._DeletionCost,t._SubstitutionCost);return u[c][h]}}t._MAX_SEQUENCE_LENGTH=256,t._CostMatrix=[...Array(t._MAX_SEQUENCE_LENGTH+1)].map(()=>new Array(t._MAX_SEQUENCE_LENGTH+1)),r.Sequence=t}(Mb||(Mb={}));class qt{serialize(){return JSON.stringify(this)}static Deserialize(e){const t=JSON.parse(e),i=new qt(t._segmentLength);return i._points=t._points.map(s=>new v(s._x,s._y,s._z)),i}constructor(e=.01){this._points=[],this._segmentLength=e}getLength(){return this._points.length*this._segmentLength}add(e){let t=this._points.length;if(0===t)this._points.push(e.clone());else{const i=()=>this._segmentLength/v.Distance(this._points[t-1],e);for(let s=i();s<=1;s=i()){const n=this._points[t-1].scale(1-s);e.scaleAndAddToRef(s,n),this._points.push(n),++t}}}resampleAtTargetResolution(e){const t=new qt(this.getLength()/e);return this._points.forEach(i=>{t.add(i)}),t}tokenize(e){const t=[],i=new v;for(let s=2;s<this._points.length;++s)qt._TransformSegmentDirToRef(this._points[s-2],this._points[s-1],this._points[s],i)&&t.push(qt._TokenizeSegment(i,e));return t}static _TransformSegmentDirToRef(e,t,i,s){return t.subtractToRef(e,qt._ForwardDir),qt._ForwardDir.normalize(),t.scaleToRef(-1,qt._InverseFromVec),qt._InverseFromVec.normalize(),!(Math.abs(v.Dot(qt._ForwardDir,qt._InverseFromVec))>.98||(v.CrossToRef(qt._ForwardDir,qt._InverseFromVec,qt._UpDir),qt._UpDir.normalize(),F.LookAtLHToRef(e,t,qt._UpDir,qt._LookMatrix),i.subtractToRef(t,qt._FromToVec),qt._FromToVec.normalize(),v.TransformNormalToRef(qt._FromToVec,qt._LookMatrix,s),0))}static _TokenizeSegment(e,t){qt._BestMatch=0,qt._Score=v.Dot(e,t[0]),qt._BestScore=qt._Score;for(let i=1;i<t.length;++i)qt._Score=v.Dot(e,t[i]),qt._Score>qt._BestScore&&(qt._BestMatch=i,qt._BestScore=qt._Score);return qt._BestMatch}}qt._ForwardDir=new v,qt._InverseFromVec=new v,qt._UpDir=new v,qt._FromToVec=new v,qt._LookMatrix=new F;class mc{constructor(e){this._view=new Float32Array(e),this._itemLength=0}get itemLength(){return this._itemLength}at(e){return e<0||e>=this._itemLength?NaN:this._view[e]}subarray(e,t){return e>=t||e<0?new Float32Array(0):(t>this._itemLength&&(t=this._itemLength),this._view.subarray(e,t))}push(e){this._view[this._itemLength]=e,this._itemLength++,this._itemLength>=this._view.length&&this._growArray()}_growArray(){const e=Math.floor(1.5*this._view.length),t=new Float32Array(e);t.set(this._view),this._view=t}}const gc=1800,VW="timestamp",UW="numPoints",sce=/\r/g;class qo{static get SliceDataOffset(){return 2}static get NumberOfPointsOffset(){return 1}constructor(e,t){this._scene=e,this._collectDataAtFrame=()=>{const i=ir.Now-this._startingTimestamp,s=this.datasets.ids.length,n=this.datasets.startingIndices.itemLength;let o=0;if(n>0){const a=this.datasets.startingIndices.at(n-1);o=a+this.datasets.data.at(a+qo.NumberOfPointsOffset)+qo.SliceDataOffset}if(this.datasets.startingIndices.push(o),this.datasets.data.push(i),this.datasets.data.push(s),this.datasets.ids.forEach(a=>{const l=this._strategies.get(a);!l||this.datasets.data.push(l.getData())}),this.datasetObservable.hasObservers()){const a=[i,s];for(let l=0;l<s;l++)a.push(this.datasets.data.at(o+qo.SliceDataOffset+l));this.datasetObservable.notifyObservers(a)}},this.datasets={ids:[],data:new mc(gc),startingIndices:new mc(gc)},this._strategies=new Map,this._datasetMeta=new Map,this._eventRestoreSet=new Set,this._customEventObservable=new z,this.datasetObservable=new z,this.metadataObservable=new z(i=>i.callback(this._datasetMeta,new GF(0))),t&&this.addCollectionStrategies(...t)}registerEvent(e,t,i){var s;if(this._strategies.has(e)&&!t)return;this._strategies.has(e)&&t&&(null===(s=this._strategies.get(e))||void 0===s||s.dispose(),this._strategies.delete(e));const o={name:e};return this._eventRestoreSet.add(e),this.addCollectionStrategies({strategyCallback:a=>{let l=0,c=0;const h=a.onAfterRenderObservable.add(()=>{c=l,l=0}),u=this._customEventObservable.add(d=>{e===d.name&&(void 0!==d.value?l=d.value:l++)});return{id:e,getData:()=>c,dispose:()=>{a.onAfterRenderObservable.remove(h),this._customEventObservable.remove(u)}}},category:i}),o}sendEvent(e){this._customEventObservable.notifyObservers(e)}_restoreStringEvents(){this._eventRestoreSet.size!==this._customEventObservable.observers.length&&this._eventRestoreSet.forEach(e=>{this.registerEvent(e,!0)})}addCollectionStrategies(...e){for(let{strategyCallback:t,category:i,hidden:s}of e){const n=t(this._scene);this._strategies.has(n.id)?n.dispose():(this.datasets.ids.push(n.id),i&&(i=i.replace(new RegExp("@","g"),"")),this._datasetMeta.set(n.id,{color:this._getHexColorFromId(n.id),category:i,hidden:s}),this._strategies.set(n.id,n))}this.metadataObservable.notifyObservers(this._datasetMeta)}_getHexColorFromId(e){let t=0;for(let s=0;s<e.length;s++)t=e.charCodeAt(s)+((t<<5)-t);let i="#";for(let s=0;s<24;s+=8)i+=("0"+(t>>s&255).toString(16)).substr(-2);return i}getCurrentSlice(){const i=[ir.Now-this._startingTimestamp,this.datasets.ids.length];this.datasets.ids.forEach(s=>{const n=this._strategies.get(s);!n||this.datasetObservable.hasObservers()&&i.push(n.getData())}),this.datasetObservable.hasObservers()&&this.datasetObservable.notifyObservers(i)}updateMetadata(e,t,i){const s=this._datasetMeta.get(e);!s||(s[t]=i,this.metadataObservable.notifyObservers(this._datasetMeta))}clear(e){this.datasets.data=new mc(gc),this.datasets.ids.length=0,this.datasets.startingIndices=new mc(gc),this._datasetMeta.clear(),this._strategies.forEach(t=>t.dispose()),this._strategies.clear(),e||this._eventRestoreSet.clear(),this._hasLoadedData=!1}get hasLoadedData(){return this._hasLoadedData}loadFromFileData(e,t){const i=e.replace(sce,"").split("\n").map(u=>u.split(",").filter(d=>d.length>0)).filter(u=>u.length>0),n=qo.NumberOfPointsOffset;if(i.length<2)return!1;const o={ids:[],data:new mc(gc),startingIndices:new mc(gc)},[a,...l]=i;if(a.length<2||a[0]!==VW||a[n]!==UW)return!1;const c=new Map;for(let u=qo.SliceDataOffset;u<a.length;u++){const[d,f]=a[u].split("@");o.ids.push(d),c.set(d,f)}let h=0;for(const u of l){if(u.length<2)return!1;const d=parseFloat(u[0]),f=parseInt(u[n]);if(isNaN(f)||isNaN(d)||(o.data.push(d),o.data.push(f),f+qo.SliceDataOffset!==u.length))return!1;for(let p=qo.SliceDataOffset;p<u.length;p++){const _=parseFloat(u[p]);if(isNaN(_))return!1;o.data.push(_)}o.startingIndices.push(h),h+=u.length}if(this.datasets.ids=o.ids,this.datasets.data=o.data,this.datasets.startingIndices=o.startingIndices,t||this._datasetMeta.clear(),this._strategies.forEach(u=>u.dispose()),this._strategies.clear(),!t)for(const u of this.datasets.ids){const d=c.get(u);this._datasetMeta.set(u,{category:d,color:this._getHexColorFromId(u)})}return this.metadataObservable.notifyObservers(this._datasetMeta),this._hasLoadedData=!0,!0}exportDataToCsv(){let e="";e+=`${VW},${UW}`;for(let i=0;i<this.datasets.ids.length;i++)if(e+=`,${this.datasets.ids[i]}`,this._datasetMeta){const s=this._datasetMeta.get(this.datasets.ids[i]);s?.category&&(e+=`@${s.category}`)}e+="\n";for(let i=0;i<this.datasets.startingIndices.itemLength;i++){const s=this.datasets.startingIndices.at(i),n=this.datasets.data.at(s),o=this.datasets.data.at(s+qo.NumberOfPointsOffset);e+=`${n},${o}`;for(let a=0;a<o;a++)e+=`,${this.datasets.data.at(s+qo.SliceDataOffset+a)}`;for(let a=0;a<this.datasets.ids.length-o;a++)e+=",";e+="\n"}const t=`${(new Date).toISOString()}-perfdata.csv`;q.Download(new Blob([e],{type:"text/csv"}),t)}start(e){e?void 0===this._startingTimestamp&&(this._startingTimestamp=ir.Now):(this.datasets.data=new mc(gc),this.datasets.startingIndices=new mc(gc),this._startingTimestamp=ir.Now),this._scene.onAfterRenderObservable.add(this._collectDataAtFrame),this._restoreStringEvents(),this._isStarted=!0}stop(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._isStarted=!1}get isStarted(){return this._isStarted}dispose(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._datasetMeta.clear(),this._strategies.forEach(e=>{e.dispose()}),this.datasetObservable.clear(),this.metadataObservable.clear(),this._isStarted=!1,this.datasets=null}}ge.prototype.getPerfCollector=function(){return this._perfCollector||(this._perfCollector=new qo(this)),this._perfCollector},z.prototype.runCoroutineAsync=function(r){if(!this._coroutineScheduler){const e=function rce(r){const e=new Array,t=new Array,i=new Array,s=r.add(()=>{const o=e.length;for(let a=0;a<o;a++)ev(e.shift(),t.shift(),i.shift())});return{scheduler:(o,a,l)=>{e.push(o),t.push(a),i.push(l)},dispose:()=>{r.remove(s)}}}(this);this._coroutineScheduler=e.scheduler,this._coroutineSchedulerDispose=e.dispose}return xE(r,this._coroutineScheduler)},z.prototype.cancelAllCoroutines=function(){this._coroutineSchedulerDispose&&this._coroutineSchedulerDispose(),this._coroutineScheduler=void 0,this._coroutineSchedulerDispose=void 0};class vc extends Xs{constructor(e,t={}){super(e),this.options=t,this._direction=new v(0,0,-1),this._mat=new F,this._onSelectEnabled=!1,this._origin=new v(0,0,0),this.lastNativeXRHitResults=[],this.onHitTestResultObservable=new z,this._onHitTestResults=i=>{const s=i.map(n=>{const o=F.FromArray(n.hitMatrix);return this._xrSessionManager.scene.useRightHandedSystem||o.toggleModelMatrixHandInPlace(),this.options.worldParentNode&&o.multiplyToRef(this.options.worldParentNode.getWorldMatrix(),o),{xrHitResult:n,transformationMatrix:o}});this.lastNativeXRHitResults=i,this.onHitTestResultObservable.notifyObservers(s)},this._onSelect=i=>{!this._onSelectEnabled||vc.XRHitTestWithSelectEvent(i,this._xrSessionManager.referenceSpace)},this.xrNativeFeatureName="hit-test",q.Warn("A newer version of this plugin is available")}static XRHitTestWithRay(e,t,i,s){return e.requestHitTest(t,i).then(n=>n.filter(s||(a=>!!a.hitMatrix)))}static XRHitTestWithSelectEvent(e,t){const i=e.frame.getPose(e.inputSource.targetRaySpace,t);if(!i)return Promise.resolve([]);const s=new XRRay(i.transform);return this.XRHitTestWithRay(e.frame.session,s,t)}attach(){return!!super.attach()&&(this.options.testOnPointerDownOnly&&this._xrSessionManager.session.addEventListener("select",this._onSelect,!1),!0)}detach(){return!!super.detach()&&(this._onSelectEnabled=!1,this._xrSessionManager.session.removeEventListener("select",this._onSelect),!0)}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(!this.attached||this.options.testOnPointerDownOnly)return;const t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;F.FromArrayToRef(t.transform.matrix,0,this._mat),v.TransformCoordinatesFromFloatsToRef(0,0,0,this._mat,this._origin),v.TransformCoordinatesFromFloatsToRef(0,0,-1,this._mat,this._direction),this._direction.subtractInPlace(this._origin),this._direction.normalize();const i=new XRRay({x:this._origin.x,y:this._origin.y,z:this._origin.z,w:0},{x:this._direction.x,y:this._direction.y,z:this._direction.z,w:0});vc.XRHitTestWithRay(this._xrSessionManager.session,i,this._xrSessionManager.referenceSpace).then(this._onHitTestResults)}}vc.Name=Ki.HIT_TEST,vc.Version=1,Ai.AddWebXRFeature(vc.Name,(r,e)=>()=>new vc(r,e),vc.Version,!1);let nce=0;class i_ extends Xs{set referenceSpaceForFrameAnchors(e){this._referenceSpaceForFrameAnchors=e}constructor(e,t={}){super(e),this._options=t,this._lastFrameDetected=new Set,this._trackedAnchors=[],this._futureAnchors=[],this.onAnchorAddedObservable=new z,this.onAnchorRemovedObservable=new z,this.onAnchorUpdatedObservable=new z,this._tmpVector=new v,this._tmpQuaternion=new Z,this.xrNativeFeatureName="anchors"}_populateTmpTransformation(e,t){return this._tmpVector.copyFrom(e),this._tmpQuaternion.copyFrom(t),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpVector.z*=-1,this._tmpQuaternion.z*=-1,this._tmpQuaternion.w*=-1),{position:this._tmpVector,rotationQuaternion:this._tmpQuaternion}}addAnchorPointUsingHitTestResultAsync(e,t=new v,i=new Z){var s=this;return Qt(function*(){s._populateTmpTransformation(t,i);const n=new XRRigidTransform({x:s._tmpVector.x,y:s._tmpVector.y,z:s._tmpVector.z},{x:s._tmpQuaternion.x,y:s._tmpQuaternion.y,z:s._tmpQuaternion.z,w:s._tmpQuaternion.w});if(!e.xrHitResult.createAnchor)throw s.detach(),new Error("Anchors not enabled in this environment/browser");try{const o=yield e.xrHitResult.createAnchor(n);return new Promise((a,l)=>{s._futureAnchors.push({nativeAnchor:o,resolved:!1,submitted:!0,xrTransformation:n,resolve:a,reject:l})})}catch(o){throw new Error(o)}})()}addAnchorAtPositionAndRotationAsync(e,t=new Z,i=!1){var s=this;return Qt(function*(){s._populateTmpTransformation(e,t);const n=new XRRigidTransform({x:s._tmpVector.x,y:s._tmpVector.y,z:s._tmpVector.z},{x:s._tmpQuaternion.x,y:s._tmpQuaternion.y,z:s._tmpQuaternion.z,w:s._tmpQuaternion.w}),o=i&&s.attached&&s._xrSessionManager.currentFrame?yield s._createAnchorAtTransformation(n,s._xrSessionManager.currentFrame):void 0;return new Promise((a,l)=>{s._futureAnchors.push({nativeAnchor:o,resolved:!1,submitted:!1,xrTransformation:n,resolve:a,reject:l})})})()}get anchors(){return this._trackedAnchors}detach(){if(!super.detach())return!1;if(!this._options.doNotRemoveAnchorsOnSessionEnded)for(;this._trackedAnchors.length;){const e=this._trackedAnchors.pop();if(e){try{e.remove()}catch{}this.onAnchorRemovedObservable.notifyObservers(e)}}return!0}dispose(){this._futureAnchors.length=0,super.dispose(),this.onAnchorAddedObservable.clear(),this.onAnchorRemovedObservable.clear(),this.onAnchorUpdatedObservable.clear()}_onXRFrame(e){if(!this.attached||!e)return;const t=e.trackedAnchors;if(t){const i=this._trackedAnchors.filter(n=>!t.has(n.xrAnchor)).map(n=>this._trackedAnchors.indexOf(n));let s=0;i.forEach(n=>{const o=this._trackedAnchors.splice(n-s,1)[0];this.onAnchorRemovedObservable.notifyObservers(o),s++}),t.forEach(n=>{if(this._lastFrameDetected.has(n)){const o=this._findIndexInAnchorArray(n),a=this._trackedAnchors[o];try{this._updateAnchorWithXRFrame(n,a,e),a.attachedNode&&(a.attachedNode.rotationQuaternion=a.attachedNode.rotationQuaternion||new Z,a.transformationMatrix.decompose(a.attachedNode.scaling,a.attachedNode.rotationQuaternion,a.attachedNode.position)),this.onAnchorUpdatedObservable.notifyObservers(a)}catch{q.Warn("Anchor could not be updated")}}else{const o={id:nce++,xrAnchor:n,remove:()=>n.delete()},a=this._updateAnchorWithXRFrame(n,o,e);this._trackedAnchors.push(a),this.onAnchorAddedObservable.notifyObservers(a);const c=this._futureAnchors.filter(h=>h.nativeAnchor===n)[0];c&&(c.resolve(a),c.resolved=!0)}}),this._lastFrameDetected=t}this._futureAnchors.forEach(i=>{!i.resolved&&!i.submitted&&(this._createAnchorAtTransformation(i.xrTransformation,e).then(s=>{i.nativeAnchor=s},s=>{i.resolved=!0,i.reject(s)}),i.submitted=!0)})}_findIndexInAnchorArray(e){for(let t=0;t<this._trackedAnchors.length;++t)if(this._trackedAnchors[t].xrAnchor===e)return t;return-1}_updateAnchorWithXRFrame(e,t,i){const s=i.getPose(e.anchorSpace,this._xrSessionManager.referenceSpace);if(s){const n=t.transformationMatrix||new F;F.FromArrayToRef(s.transform.matrix,0,n),this._xrSessionManager.scene.useRightHandedSystem||n.toggleModelMatrixHandInPlace(),t.transformationMatrix=n,this._options.worldParentNode&&n.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),n)}return t}_createAnchorAtTransformation(e,t){var i=this;return Qt(function*(){var s;if(!t.createAnchor)throw i.detach(),new Error("Anchors are not enabled in your browser");try{return t.createAnchor(e,null!==(s=i._referenceSpaceForFrameAnchors)&&void 0!==s?s:i._xrSessionManager.referenceSpace)}catch(n){throw new Error(n)}})()}}i_.Name=Ki.ANCHOR_SYSTEM,i_.Version=1,Ai.AddWebXRFeature(i_.Name,(r,e)=>()=>new i_(r,e),i_.Version);let oce=0;class s_ extends Xs{constructor(e,t={}){super(e),this._options=t,this._detectedPlanes=[],this._enabled=!1,this._lastFrameDetected=new Set,this.onPlaneAddedObservable=new z,this.onPlaneRemovedObservable=new z,this.onPlaneUpdatedObservable=new z,this.xrNativeFeatureName="plane-detection",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){if(!super.detach())return!1;if(!this._options.doNotRemovePlanesOnSessionEnded)for(;this._detectedPlanes.length;){const e=this._detectedPlanes.pop();e&&this.onPlaneRemovedObservable.notifyObservers(e)}return!0}dispose(){super.dispose(),this.onPlaneAddedObservable.clear(),this.onPlaneRemovedObservable.clear(),this.onPlaneUpdatedObservable.clear()}isCompatible(){return typeof XRPlane<"u"}_onXRFrame(e){var t;if(!this.attached||!this._enabled||!e)return;const i=e.detectedPlanes||(null===(t=e.worldInformation)||void 0===t?void 0:t.detectedPlanes);if(i){for(let s=0;s<this._detectedPlanes.length;s++){const n=this._detectedPlanes[s];i.has(n.xrPlane)||(this._detectedPlanes.splice(s--,1),this.onPlaneRemovedObservable.notifyObservers(n))}i.forEach(s=>{if(this._lastFrameDetected.has(s)){if(s.lastChangedTime===this._xrSessionManager.currentTimestamp){const n=this._findIndexInPlaneArray(s),o=this._detectedPlanes[n];this._updatePlaneWithXRPlane(s,o,e),this.onPlaneUpdatedObservable.notifyObservers(o)}}else{const n={id:oce++,xrPlane:s,polygonDefinition:[]},o=this._updatePlaneWithXRPlane(s,n,e);this._detectedPlanes.push(o),this.onPlaneAddedObservable.notifyObservers(o)}}),this._lastFrameDetected=i}}_init(){const e=()=>{this._enabled=!0,this._detectedPlanes.length&&(this._detectedPlanes.length=0)};!!this._xrSessionManager.isNative&&!!this._options.preferredDetectorOptions&&!!this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions(this._options.preferredDetectorOptions),this._xrSessionManager.session.updateWorldTrackingState?(this._xrSessionManager.session.updateWorldTrackingState({planeDetectionState:{enabled:!0}}),e()):e()}_updatePlaneWithXRPlane(e,t,i){t.polygonDefinition=e.polygon.map(n=>new v(n.x,n.y,n.z*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)));const s=i.getPose(e.planeSpace,this._xrSessionManager.referenceSpace);if(s){const n=t.transformationMatrix||new F;F.FromArrayToRef(s.transform.matrix,0,n),this._xrSessionManager.scene.useRightHandedSystem||n.toggleModelMatrixHandInPlace(),t.transformationMatrix=n,this._options.worldParentNode&&n.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),n)}return t}_findIndexInPlaneArray(e){for(let t=0;t<this._detectedPlanes.length;++t)if(this._detectedPlanes[t].xrPlane===e)return t;return-1}}s_.Name=Ki.PLANE_DETECTION,s_.Version=1,Ai.AddWebXRFeature(s_.Name,(r,e)=>()=>new s_(r,e),s_.Version);class r_ extends Xs{constructor(e,t={}){super(e),this.options=t,this.onBackgroundStateChangedObservable=new z}attach(){return this._setBackgroundState(!1),super.attach()}detach(){return this._setBackgroundState(!0),super.detach()}dispose(){super.dispose(),this.onBackgroundStateChangedObservable.clear()}_onXRFrame(e){}_setBackgroundState(e){const t=this._xrSessionManager.scene;if(!this.options.ignoreEnvironmentHelper)if(this.options.environmentHelperRemovalFlags){if(this.options.environmentHelperRemovalFlags.skyBox){const i=t.getMeshByName("BackgroundSkybox");i&&i.setEnabled(e)}if(this.options.environmentHelperRemovalFlags.ground){const i=t.getMeshByName("BackgroundPlane");i&&i.setEnabled(e)}}else{const i=t.getMeshByName("BackgroundHelper");i&&i.setEnabled(e)}this.options.backgroundMeshes&&this.options.backgroundMeshes.forEach(i=>i.setEnabled(e)),this.onBackgroundStateChangedObservable.notifyObservers(e)}}r_.Name=Ki.BACKGROUND_REMOVER,r_.Version=1,Ai.AddWebXRFeature(r_.Name,(r,e)=>()=>new r_(r,e),r_.Version,!0);class n_ extends Xs{_createPhysicsImpostor(e){const t=this._options.physicsProperties.impostorType||Be.SphereImpostor,i=this._options.physicsProperties.impostorSize||.1,s=po("impostor-mesh-"+e.uniqueId,{diameterX:"number"==typeof i?i:i.width,diameterY:"number"==typeof i?i:i.height,diameterZ:"number"==typeof i?i:i.depth});s.isVisible=this._debugMode,s.isPickable=!1,s.rotationQuaternion=new Z;const n=e.grip||e.pointer;s.position.copyFrom(n.position),s.rotationQuaternion.copyFrom(n.rotationQuaternion);const o=new Be(s,t,{mass:0,...this._options.physicsProperties});this._controllers[e.uniqueId]={xrController:e,impostor:o,impostorMesh:s}}constructor(e,t){super(e),this._options=t,this._attachController=i=>{this._controllers[i.uniqueId]||(this._xrSessionManager.scene.isPhysicsEnabled()||V.Warn("physics engine not enabled, skipped. Please add this controller manually."),this._options.physicsProperties.useControllerMesh&&i.inputSource.gamepad?i.onMotionControllerInitObservable.addOnce(s=>{s._doNotLoadControllerMesh?this._createPhysicsImpostor(i):s.onModelLoadedObservable.addOnce(()=>{const n=new Be(s.rootMesh,Be.MeshImpostor,{mass:0,...this._options.physicsProperties}),o=i.grip||i.pointer;this._controllers[i.uniqueId]={xrController:i,impostor:n,oldPos:o.position.clone(),oldRotation:o.rotationQuaternion.clone()}})}):this._createPhysicsImpostor(i))},this._controllers={},this._debugMode=!1,this._delta=0,this._lastTimestamp=0,this._tmpQuaternion=new Z,this._tmpVector=new v,this._options.physicsProperties||(this._options.physicsProperties={})}_enablePhysicsDebug(){this._debugMode=!0,Object.keys(this._controllers).forEach(e=>{const t=this._controllers[e];t.impostorMesh&&(t.impostorMesh.isVisible=!0)})}addController(e){this._attachController(e)}attach(){if(!super.attach())return!1;if(!this._options.xrInput)return!0;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._options.enableHeadsetImpostor){const e=this._options.headsetImpostorParams||{impostorType:Be.SphereImpostor,restitution:.8,impostorSize:.3},t=e.impostorSize||.3;this._headsetMesh=po("headset-mesh",{diameterX:"number"==typeof t?t:t.width,diameterY:"number"==typeof t?t:t.height,diameterZ:"number"==typeof t?t:t.depth}),this._headsetMesh.rotationQuaternion=new Z,this._headsetMesh.isVisible=!1,this._headsetImpostor=new Be(this._headsetMesh,e.impostorType,{mass:0,...e})}return!0}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._headsetMesh&&this._headsetMesh.dispose(),!0)}getHeadsetImpostor(){return this._headsetImpostor}getImpostorForController(e){const t="string"==typeof e?e:e.uniqueId;return this._controllers[t]?this._controllers[t].impostor:null}setPhysicsProperties(e){this._options.physicsProperties={...this._options.physicsProperties,...e}}_onXRFrame(e){var t,i;if(this._delta=this._xrSessionManager.currentTimestamp-this._lastTimestamp,this._lastTimestamp=this._xrSessionManager.currentTimestamp,this._headsetMesh&&this._headsetImpostor){if(this._headsetMesh.position.copyFrom(this._options.xrInput.xrCamera.globalPosition),this._headsetMesh.rotationQuaternion.copyFrom(this._options.xrInput.xrCamera.absoluteRotation),null!==(t=this._options.xrInput.xrCamera._lastXRViewerPose)&&void 0!==t&&t.linearVelocity){const s=this._options.xrInput.xrCamera._lastXRViewerPose.linearVelocity;this._tmpVector.set(s.x,s.y,s.z),this._headsetImpostor.setLinearVelocity(this._tmpVector)}if(null!==(i=this._options.xrInput.xrCamera._lastXRViewerPose)&&void 0!==i&&i.angularVelocity){const s=this._options.xrInput.xrCamera._lastXRViewerPose.angularVelocity;this._tmpVector.set(s.x,s.y,s.z),this._headsetImpostor.setAngularVelocity(this._tmpVector)}}Object.keys(this._controllers).forEach(s=>{var n,o;const a=this._controllers[s],l=a.xrController.grip||a.xrController.pointer,c=a.oldPos||a.impostorMesh.position;if(null!==(n=a.xrController._lastXRPose)&&void 0!==n&&n.linearVelocity){const u=a.xrController._lastXRPose.linearVelocity;this._tmpVector.set(u.x,u.y,u.z),a.impostor.setLinearVelocity(this._tmpVector)}else l.position.subtractToRef(c,this._tmpVector),this._tmpVector.scaleInPlace(1e3/this._delta),a.impostor.setLinearVelocity(this._tmpVector);c.copyFrom(l.position),this._debugMode&&console.log(this._tmpVector,"linear");const h=a.oldRotation||a.impostorMesh.rotationQuaternion;if(null!==(o=a.xrController._lastXRPose)&&void 0!==o&&o.angularVelocity){const u=a.xrController._lastXRPose.angularVelocity;this._tmpVector.set(u.x,u.y,u.z),a.impostor.setAngularVelocity(this._tmpVector)}else if(!h.equalsWithEpsilon(l.rotationQuaternion)){h.conjugateInPlace().multiplyToRef(l.rotationQuaternion,this._tmpQuaternion);const u=Math.sqrt(this._tmpQuaternion.x*this._tmpQuaternion.x+this._tmpQuaternion.y*this._tmpQuaternion.y+this._tmpQuaternion.z*this._tmpQuaternion.z);if(this._tmpVector.set(this._tmpQuaternion.x,this._tmpQuaternion.y,this._tmpQuaternion.z),u<.001)this._tmpVector.scaleInPlace(2);else{const d=2*Math.atan2(u,this._tmpQuaternion.w);this._tmpVector.scaleInPlace(d/(u*(this._delta/1e3)))}a.impostor.setAngularVelocity(this._tmpVector)}h.copyFrom(l.rotationQuaternion),this._debugMode&&console.log(this._tmpVector,this._tmpQuaternion,"angular")})}_detachController(e){const t=this._controllers[e];!t||(t.impostorMesh&&t.impostorMesh.dispose(),delete this._controllers[e])}}n_.Name=Ki.PHYSICS_CONTROLLERS,n_.Version=1,Ai.AddWebXRFeature(n_.Name,(r,e)=>()=>new n_(r,e),n_.Version,!0);class o_ extends Xs{constructor(e,t={}){super(e),this.options=t,this._tmpMat=new F,this._tmpPos=new v,this._tmpQuat=new Z,this._initHitTestSource=i=>{if(!i)return;const s=new XRRay(this.options.offsetRay||{}),n={space:this.options.useReferenceSpace?i:this._xrSessionManager.viewerReferenceSpace,offsetRay:s};this.options.entityTypes&&(n.entityTypes=this.options.entityTypes),n.space?this._xrSessionManager.session.requestHitTestSource(n).then(o=>{this._xrHitTestSource&&this._xrHitTestSource.cancel(),this._xrHitTestSource=o}):q.Warn("waiting for viewer reference space to initialize")},this.autoCloneTransformation=!1,this.onHitTestResultObservable=new z,this.paused=!1,this.xrNativeFeatureName="hit-test",q.Warn("Hit test is an experimental and unstable feature.")}attach(){if(!super.attach()||!this._xrSessionManager.session.requestHitTestSource)return!1;if(this.options.disablePermanentHitTest||(this._xrSessionManager.referenceSpace&&this._initHitTestSource(this._xrSessionManager.referenceSpace),this._xrSessionManager.onXRReferenceSpaceChanged.add(this._initHitTestSource)),this.options.enableTransientHitTest){const e=new XRRay(this.options.transientOffsetRay||{});this._xrSessionManager.session.requestHitTestSourceForTransientInput({profile:this.options.transientHitTestProfile||"generic-touchscreen",offsetRay:e,entityTypes:this.options.entityTypes}).then(t=>{this._transientXrHitTestSource=t})}return!0}detach(){return!!super.detach()&&(this._xrHitTestSource&&(this._xrHitTestSource.cancel(),this._xrHitTestSource=null),this._xrSessionManager.onXRReferenceSpaceChanged.removeCallback(this._initHitTestSource),this._transientXrHitTestSource&&(this._transientXrHitTestSource.cancel(),this._transientXrHitTestSource=null),!0)}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(this.attached&&!this.paused){if(this._xrHitTestSource){const t=e.getHitTestResults(this._xrHitTestSource);this._processWebXRHitTestResult(t)}this._transientXrHitTestSource&&e.getHitTestResultsForTransientInput(this._transientXrHitTestSource).forEach(i=>{this._processWebXRHitTestResult(i.results,i.inputSource)})}}_processWebXRHitTestResult(e,t){const i=[];e.forEach(s=>{const n=s.getPose(this._xrSessionManager.referenceSpace);if(!n)return;const o=n.transform.position,a=n.transform.orientation;this._tmpPos.set(o.x,o.y,o.z),this._tmpQuat.set(a.x,a.y,a.z,a.w),F.FromFloat32ArrayToRefScaled(n.transform.matrix,0,1,this._tmpMat),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpPos.z*=-1,this._tmpQuat.z*=-1,this._tmpQuat.w*=-1,this._tmpMat.toggleModelMatrixHandInPlace());const l={position:this.autoCloneTransformation?this._tmpPos.clone():this._tmpPos,rotationQuaternion:this.autoCloneTransformation?this._tmpQuat.clone():this._tmpQuat,transformationMatrix:this.autoCloneTransformation?this._tmpMat.clone():this._tmpMat,inputSource:t,isTransient:!!t,xrHitResult:s};i.push(l)}),this.onHitTestResultObservable.notifyObservers(i)}}o_.Name=Ki.HIT_TEST,o_.Version=2,Ai.AddWebXRFeature(o_.Name,(r,e)=>()=>new o_(r,e),o_.Version,!1);class a_ extends Xs{get featurePointCloud(){return this._featurePointCloud}constructor(e){super(e),this._enabled=!1,this._featurePointCloud=[],this.onFeaturePointsAddedObservable=new z,this.onFeaturePointsUpdatedObservable=new z,this.xrNativeFeatureName="bjsfeature-points",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){return!!super.detach()&&(this.featurePointCloud.length=0,!0)}dispose(){super.dispose(),this._featurePointCloud.length=0,this.onFeaturePointsUpdatedObservable.clear(),this.onFeaturePointsAddedObservable.clear()}_onXRFrame(e){if(!this.attached||!this._enabled||!e)return;const t=e.featurePointCloud;if(t&&0!==t.length){if(t.length%5!=0)throw new Error("Received malformed feature point cloud of length: "+t.length);const i=t.length/5,s=new Array,n=new Array;for(let o=0;o<i;o++){const a=5*o,l=t[a+4];this._featurePointCloud[l]?s.push(l):(this._featurePointCloud[l]={position:new v,confidenceValue:0},n.push(l)),this._featurePointCloud[l].position.x=t[a],this._featurePointCloud[l].position.y=t[a+1],this._featurePointCloud[l].position.z=t[a+2],this._featurePointCloud[l].confidenceValue=t[a+3]}n.length>0&&this.onFeaturePointsAddedObservable.notifyObservers(n),s.length>0&&this.onFeaturePointsUpdatedObservable.notifyObservers(s)}}_init(){!this._xrSessionManager.session.trySetFeaturePointCloudEnabled||!this._xrSessionManager.session.trySetFeaturePointCloudEnabled(!0)||(this._enabled=!0)}}a_.Name=Ki.FEATURE_POINTS,a_.Version=1,Ai.AddWebXRFeature(a_.Name,r=>()=>new a_(r),a_.Version);let ace=0;class l_ extends Xs{constructor(e,t={}){super(e),this._options=t,this._detectedMeshes=new Map,this.onMeshAddedObservable=new z,this.onMeshRemovedObservable=new z,this.onMeshUpdatedObservable=new z,this.xrNativeFeatureName="mesh-detection",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){return!!super.detach()&&(!!this._xrSessionManager.isNative&&!!this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!1),this._options.doNotRemoveMeshesOnSessionEnded||(this._detectedMeshes.forEach(e=>{this.onMeshRemovedObservable.notifyObservers(e)}),this._detectedMeshes.clear()),!0)}dispose(){super.dispose(),this.onMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onMeshUpdatedObservable.clear()}_onXRFrame(e){var t;try{if(!this.attached||!e)return;const i=null===(t=e.worldInformation)||void 0===t?void 0:t.detectedMeshes;if(i){const s=new Set;this._detectedMeshes.forEach((n,o)=>{i.has(o)||s.add(o)}),s.forEach(n=>{const o=this._detectedMeshes.get(n);o&&(this.onMeshRemovedObservable.notifyObservers(o),this._detectedMeshes.delete(n))}),i.forEach(n=>{if(this._detectedMeshes.has(n)){if(n.lastChangedTime===this._xrSessionManager.currentTimestamp){const o=this._detectedMeshes.get(n);o&&(this._updateVertexDataWithXRMesh(n,o,e),this.onMeshUpdatedObservable.notifyObservers(o))}}else{const o={id:ace++,xrMesh:n},a=this._updateVertexDataWithXRMesh(n,o,e);this._detectedMeshes.set(n,a),this.onMeshAddedObservable.notifyObservers(a)}})}}catch(i){console.log(i.stack)}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!0),this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions(this._options.preferredDetectorOptions))}_updateVertexDataWithXRMesh(e,t,i){if(t.xrMesh=e,t.worldParentNode=this._options.worldParentNode,this._options.convertCoordinateSystems){if(this._xrSessionManager.scene.useRightHandedSystem)t.positions=e.positions,t.normals=e.normals;else{t.positions=new Float32Array(e.positions.length);for(let n=0;n<e.positions.length;n+=3)t.positions[n]=e.positions[n],t.positions[n+1]=e.positions[n+1],t.positions[n+2]=-1*e.positions[n+2];if(e.normals){t.normals=new Float32Array(e.normals.length);for(let n=0;n<e.normals.length;n+=3)t.normals[n]=e.normals[n],t.normals[n+1]=e.normals[n+1],t.normals[n+2]=-1*e.normals[n+2]}}t.indices=e.indices;const s=i.getPose(e.meshSpace,this._xrSessionManager.referenceSpace);if(s){const n=t.transformationMatrix||new F;F.FromArrayToRef(s.transform.matrix,0,n),this._xrSessionManager.scene.useRightHandedSystem||n.toggleModelMatrixHandInPlace(),t.transformationMatrix=n,this._options.worldParentNode&&n.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),n)}}return t}}l_.Name=Ki.MESH_DETECTION,l_.Version=1,Ai.AddWebXRFeature(l_.Name,(r,e)=>()=>new l_(r,e),l_.Version,!1);var $o=(()=>{return(r=$o||($o={}))[r.NotReceived=0]="NotReceived",r[r.Waiting=1]="Waiting",r[r.Received=2]="Received",$o;var r})();class c_ extends Xs{constructor(e,t){super(e),this.options=t,this.onUntrackableImageFoundObservable=new z,this.onTrackableImageFoundObservable=new z,this.onTrackedImageUpdatedObservable=new z,this._trackableScoreStatus=$o.NotReceived,this._trackedImages=[],this.xrNativeFeatureName="image-tracking"}attach(){return super.attach()}detach(){return super.detach()}getTrackedImageById(e){return this._trackedImages[e]||null}dispose(){super.dispose(),this._trackedImages.forEach(e=>{e.originalBitmap.close()}),this._trackedImages.length=0,this.onTrackableImageFoundObservable.clear(),this.onUntrackableImageFoundObservable.clear(),this.onTrackedImageUpdatedObservable.clear()}getXRSessionInitExtension(){var e=this;return Qt(function*(){if(!e.options.images||!e.options.images.length)return{};const t=e.options.images.map(i=>"string"==typeof i.src?e._xrSessionManager.scene.getEngine()._createImageBitmapFromSource(i.src):Promise.resolve(i.src));try{const i=yield Promise.all(t);return e._originalTrackingRequest=i.map((s,n)=>({image:s,widthInMeters:e.options.images[n].estimatedRealWorldWidth})),{trackedImages:e._originalTrackingRequest}}catch{return q.Error("Error loading images for tracking, WebXRImageTracking disabled for this session."),{}}})()}_onXRFrame(e){if(!e.getImageTrackingResults||this._trackableScoreStatus===$o.Waiting)return;if(this._trackableScoreStatus===$o.NotReceived)return void this._checkScoresAsync();const t=e.getImageTrackingResults();for(const i of t){let s=!1;const o=this._trackedImages[i.index];if(!o)continue;o.xrTrackingResult=i,o.realWorldWidth!==i.measuredWidthInMeters&&(o.realWorldWidth=i.measuredWidthInMeters,s=!0);const a=e.getPose(i.imageSpace,this._xrSessionManager.referenceSpace);if(a){const h=o.transformationMatrix;F.FromArrayToRef(a.transform.matrix,0,h),this._xrSessionManager.scene.useRightHandedSystem||h.toggleModelMatrixHandInPlace(),s=!0}const c="emulated"===i.trackingState;o.emulated!==c&&(o.emulated=c,s=!0),s&&this.onTrackedImageUpdatedObservable.notifyObservers(o)}}_checkScoresAsync(){var e=this;return Qt(function*(){if(!e._xrSessionManager.session.getTrackedImageScores||e._trackableScoreStatus!==$o.NotReceived)return;e._trackableScoreStatus=$o.Waiting;const t=yield e._xrSessionManager.session.getTrackedImageScores();if(t&&0!==t.length){for(let i=0;i<t.length;++i)if("untrackable"==t[i])e.onUntrackableImageFoundObservable.notifyObservers(i);else{const s=e._originalTrackingRequest[i].image,n={id:i,originalBitmap:s,transformationMatrix:new F,ratio:s.width/s.height};e._trackedImages[i]=n,e.onTrackableImageFoundObservable.notifyObservers(n)}e._trackableScoreStatus=t.length>0?$o.Received:$o.NotReceived}else e._trackableScoreStatus=$o.NotReceived})()}}c_.Name=Ki.IMAGE_TRACKING,c_.Version=1,Ai.AddWebXRFeature(c_.Name,(r,e)=>()=>new c_(r,e),c_.Version,!1);class h_ extends Xs{constructor(e,t){super(e),this.options=t,this._domOverlayType=null,this._beforeXRSelectListener=null,this._element=null,this.xrNativeFeatureName="dom-overlay",q.Warn("dom-overlay is an experimental and unstable feature.")}attach(){return!(!super.attach()||!this._xrSessionManager.session.domOverlayState||null===this._xrSessionManager.session.domOverlayState.type||(this._domOverlayType=this._xrSessionManager.session.domOverlayState.type,null!==this._element&&!0===this.options.supressXRSelectEvents&&(this._beforeXRSelectListener=e=>{e.preventDefault()},this._element.addEventListener("beforexrselect",this._beforeXRSelectListener)),0))}get domOverlayType(){return this._domOverlayType}dispose(){super.dispose(),null!==this._element&&this._beforeXRSelectListener&&this._element.removeEventListener("beforexrselect",this._beforeXRSelectListener)}_onXRFrame(e){}getXRSessionInitExtension(){var e=this;return Qt(function*(){if(void 0===e.options.element)return q.Warn('"element" option must be provided to attach xr-dom-overlay feature.'),{};if("string"==typeof e.options.element){const t=document.querySelector(e.options.element);if(null===t)return q.Warn(`element not found '${e.options.element}' (not requesting xr-dom-overlay)`),{};e._element=t}else e._element=e.options.element;return{domOverlay:{root:e._element}}})()}}h_.Name=Ki.DOM_OVERLAY,h_.Version=1,Ai.AddWebXRFeature(h_.Name,(r,e)=>()=>new h_(r,e),h_.Version,!1);class bc extends Xs{get movementDirection(){return this._movementDirection}get movementEnabled(){return this._featureContext.movementEnabled}set movementEnabled(e){this._featureContext.movementEnabled=e}get movementOrientationFollowsViewerPose(){return this._featureContext.movementOrientationFollowsViewerPose}set movementOrientationFollowsViewerPose(e){this._featureContext.movementOrientationFollowsViewerPose=e}get movementSpeed(){return this._featureContext.movementSpeed}set movementSpeed(e){this._featureContext.movementSpeed=e}get movementThreshold(){return this._featureContext.movementThreshold}set movementThreshold(e){this._featureContext.movementThreshold=e}get rotationEnabled(){return this._featureContext.rotationEnabled}set rotationEnabled(e){this._featureContext.rotationEnabled=e}get rotationSpeed(){return this._featureContext.rotationSpeed}set rotationSpeed(e){this._featureContext.rotationSpeed=e}get rotationThreshold(){return this._featureContext.rotationThreshold}set rotationThreshold(e){this._featureContext.rotationThreshold=e}constructor(e,t){var i,s,n,o,a,l;super(e),this._controllers={},this._currentRegistrationConfigurations=[],this._movementDirection=null,this._tmpRotationMatrix=F.Identity(),this._tmpTranslationDirection=new v,this._tmpMovementTranslation=new v,this._attachController=c=>{if(this._controllers[c.uniqueId])return;this._controllers[c.uniqueId]={xrController:c,registeredComponents:[]};const h=this._controllers[c.uniqueId];if("tracked-pointer"===h.xrController.inputSource.targetRayMode&&h.xrController.inputSource.gamepad){const u=()=>{if(c.motionController)for(const d of this._currentRegistrationConfigurations){let f=null;if(d.allowedComponentTypes)for(const _ of d.allowedComponentTypes){const m=c.motionController.getComponentOfType(_);if(null!==m){f=m;break}}if(d.mainComponentOnly){const _=c.motionController.getMainComponent();if(null===_)continue;f=_}if("function"==typeof d.componentSelectionPredicate&&(f=d.componentSelectionPredicate(c)),f&&d.forceHandedness&&c.inputSource.handedness!==d.forceHandedness||null===f)continue;const p={registrationConfiguration:d,component:f};h.registeredComponents.push(p),"axisChangedHandler"in d&&(p.onAxisChangedObserver=f.onAxisValueChangedObservable.add(_=>{d.axisChangedHandler(_,this._movementState,this._featureContext,this._xrInput)})),"buttonChangedhandler"in d&&(p.onButtonChangedObserver=f.onButtonStateChangedObservable.add(()=>{f.changes.pressed&&d.buttonChangedhandler(f.changes.pressed,this._movementState,this._featureContext,this._xrInput)}))}};c.motionController?u():c.onMotionControllerInitObservable.addOnce(()=>{u()})}},t&&void 0!==t.xrInput?(this._currentRegistrationConfigurations=Array.isArray(t.customRegistrationConfigurations)?t.customRegistrationConfigurations:bc.REGISTRATIONS.default,this._featureContext={movementEnabled:t.movementEnabled||!0,movementOrientationFollowsViewerPose:null===(i=t.movementOrientationFollowsViewerPose)||void 0===i||i,movementSpeed:null!==(s=t.movementSpeed)&&void 0!==s?s:1,movementThreshold:null!==(n=t.movementThreshold)&&void 0!==n?n:.25,rotationEnabled:null===(o=t.rotationEnabled)||void 0===o||o,rotationSpeed:null!==(a=t.rotationSpeed)&&void 0!==a?a:1,rotationThreshold:null!==(l=t.rotationThreshold)&&void 0!==l?l:.25},this._movementState={moveX:0,moveY:0,rotateX:0,rotateY:0},this._xrInput=t.xrInput):q.Error('WebXRControllerMovement feature requires "xrInput" option.')}attach(){return!!super.attach()&&(this._xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._controllers={},!0)}_onXRFrame(e){if(this.attach){if(null===this._movementDirection&&(this._movementDirection=this._xrInput.xrCamera.rotationQuaternion.clone()),0!==this._movementState.rotateX&&this._featureContext.rotationEnabled){const i=.001*this._xrSessionManager.scene.getEngine().getDeltaTime()*this._featureContext.rotationSpeed*this._movementState.rotateX*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);!0===this._featureContext.movementOrientationFollowsViewerPose?(this._xrInput.xrCamera.cameraRotation.y+=i,this._movementDirection=this._xrInput.xrCamera.rotationQuaternion.multiply(Z.RotationYawPitchRoll(i,0,0))):this._movementDirection.multiplyInPlace(Z.RotationYawPitchRoll(3*i,0,0))}else!0===this._featureContext.movementOrientationFollowsViewerPose&&this._movementDirection.copyFrom(this._xrInput.xrCamera.rotationQuaternion);(0!==this._movementState.moveX||0!==this._movementState.moveY)&&this._featureContext.movementEnabled&&(F.FromQuaternionToRef(this._movementDirection,this._tmpRotationMatrix),this._tmpTranslationDirection.set(this._movementState.moveX,0,this._movementState.moveY*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),v.TransformCoordinatesToRef(this._tmpTranslationDirection,this._tmpRotationMatrix,this._tmpMovementTranslation),this._tmpMovementTranslation.scaleInPlace(this._xrInput.xrCamera._computeLocalCameraSpeed()*this._featureContext.movementSpeed),this._xrInput.xrCamera.cameraDirection.addInPlace(this._tmpMovementTranslation))}}_detachController(e){const t=this._controllers[e];if(t){for(const i of t.registeredComponents)i.onAxisChangedObserver&&i.component.onAxisValueChangedObservable.remove(i.onAxisChangedObserver),i.onButtonChangedObserver&&i.component.onButtonStateChangedObservable.remove(i.onButtonChangedObserver);delete this._controllers[e]}}}bc.Name=Ki.MOVEMENT,bc.REGISTRATIONS={default:[{allowedComponentTypes:[vl.THUMBSTICK_TYPE,vl.TOUCHPAD_TYPE],forceHandedness:"left",axisChangedHandler:(r,e,t)=>{e.rotateX=Math.abs(r.x)>t.rotationThreshold?r.x:0,e.rotateY=Math.abs(r.y)>t.rotationThreshold?r.y:0}},{allowedComponentTypes:[vl.THUMBSTICK_TYPE,vl.TOUCHPAD_TYPE],forceHandedness:"right",axisChangedHandler:(r,e,t)=>{e.moveX=Math.abs(r.x)>t.movementThreshold?r.x:0,e.moveY=Math.abs(r.y)>t.movementThreshold?r.y:0}}]},bc.Version=1,Ai.AddWebXRFeature(bc.Name,(r,e)=>()=>new bc(r,e),bc.Version,!0);class u_ extends Xs{constructor(e,t){super(e),this.options=t,this._canvasContext=null,this._reflectionCubeMap=null,this._xrLightEstimate=null,this._xrLightProbe=null,this._xrWebGLBinding=null,this._lightDirection=v.Up().negateInPlace(),this._lightColor=re.White(),this._intensity=1,this._sphericalHarmonics=new vh,this._cubeMapPollTime=Date.now(),this._lightEstimationPollTime=Date.now(),this._reflectionCubeMapTextureSize=16,this.directionalLight=null,this.onReflectionCubeMapUpdatedObservable=new z,this._updateReflectionCubeMap=()=>{var i;if(!this._xrLightProbe)return;if(this.options.cubeMapPollInterval){const n=Date.now();if(n-this._cubeMapPollTime<this.options.cubeMapPollInterval)return;this._cubeMapPollTime=n}const s=this._getXRGLBinding().getReflectionCubeMap(this._xrLightProbe);if(s&&this._reflectionCubeMap){if(this._reflectionCubeMap._texture)null===(i=this._reflectionCubeMap._texture._hardwareTexture)||void 0===i||i.set(s),this._reflectionCubeMap._texture.getEngine().resetTextureCache();else{const n=new zt(this._xrSessionManager.scene.getEngine(),Ye.Unknown);n.isCube=!0,n.invertY=!1,n._useSRGBBuffer="srgba8"===this.options.reflectionFormat,n.format=5,n.generateMipMaps=!0,n.type="srgba8"!==this.options.reflectionFormat?2:0,n.samplingMode=3,n.width=this._reflectionCubeMapTextureSize,n.height=this._reflectionCubeMapTextureSize,n._cachedWrapU=1,n._cachedWrapV=1,n._hardwareTexture=new lp(s,this._getCanvasContext()),this._reflectionCubeMap._texture=n}this._reflectionCubeMap._texture.isReady=!0,this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap)}},this.xrNativeFeatureName="light-estimation",this.options.createDirectionalLightSource&&(this.directionalLight=new qn("light estimation directional",this._lightDirection,this._xrSessionManager.scene),this.directionalLight.position=new v(0,8,0),this.directionalLight.intensity=0,this.directionalLight.falloffType=ds.FALLOFF_GLTF),q.Warn("light-estimation is an experimental and unstable feature.")}get reflectionCubeMapTexture(){return this._reflectionCubeMap}get xrLightingEstimate(){return this._xrLightEstimate?{lightColor:this._lightColor,lightDirection:this._lightDirection,lightIntensity:this._intensity,sphericalHarmonics:this._sphericalHarmonics}:this._xrLightEstimate}_getCanvasContext(){return null===this._canvasContext&&(this._canvasContext=this._xrSessionManager.scene.getEngine()._gl),this._canvasContext}_getXRGLBinding(){if(null===this._xrWebGLBinding){const e=this._getCanvasContext();this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,e)}return this._xrWebGLBinding}attach(){var e;if(!super.attach())return!1;const t=null!==(e=this.options.reflectionFormat)&&void 0!==e?e:this._xrSessionManager.session.preferredReflectionFormat||"srgba8";return this.options.reflectionFormat=t,this._xrSessionManager.session.requestLightProbe({reflectionFormat:t}).then(i=>{this._xrLightProbe=i,this.options.disableCubeMapReflection||(this._reflectionCubeMap||(this._reflectionCubeMap=new kt(this._xrSessionManager.scene),this._reflectionCubeMap._isCube=!0,this._reflectionCubeMap.coordinatesMode=3,this.options.setSceneEnvironmentTexture&&(this._xrSessionManager.scene.environmentTexture=this._reflectionCubeMap)),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap))}),!0}detach(){const e=super.detach();return null!==this._xrLightProbe&&!this.options.disableCubeMapReflection&&(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._xrLightProbe=null),this._canvasContext=null,this._xrLightEstimate=null,this._xrWebGLBinding=null,e}dispose(){super.dispose(),this.onReflectionCubeMapUpdatedObservable.clear(),this.directionalLight&&(this.directionalLight.dispose(),this.directionalLight=null),null!==this._reflectionCubeMap&&(this._reflectionCubeMap._texture&&this._reflectionCubeMap._texture.dispose(),this._reflectionCubeMap.dispose(),this._reflectionCubeMap=null)}_onXRFrame(e){var t;if(null!==this._xrLightProbe){if(this.options.lightEstimationPollInterval){const i=Date.now();if(i-this._lightEstimationPollTime<this.options.lightEstimationPollInterval)return;this._lightEstimationPollTime=i}if(this._xrLightEstimate=e.getLightEstimate(this._xrLightProbe),this._xrLightEstimate){this._intensity=Math.max(1,this._xrLightEstimate.primaryLightIntensity.x,this._xrLightEstimate.primaryLightIntensity.y,this._xrLightEstimate.primaryLightIntensity.z);const i=this._xrSessionManager.scene.useRightHandedSystem?1:-1;this.options.disableVectorReuse&&(this._lightDirection=new v,this._lightColor=new re,this.directionalLight&&(this.directionalLight.direction=this._lightDirection,this.directionalLight.diffuse=this._lightColor)),this._lightDirection.copyFromFloats(this._xrLightEstimate.primaryLightDirection.x,this._xrLightEstimate.primaryLightDirection.y,this._xrLightEstimate.primaryLightDirection.z*i),this._lightColor.copyFromFloats(this._xrLightEstimate.primaryLightIntensity.x/this._intensity,this._xrLightEstimate.primaryLightIntensity.y/this._intensity,this._xrLightEstimate.primaryLightIntensity.z/this._intensity),this._sphericalHarmonics.updateFromFloatsArray(this._xrLightEstimate.sphericalHarmonicsCoefficients),this._reflectionCubeMap&&!this.options.disableSphericalPolynomial&&(this._reflectionCubeMap.sphericalPolynomial=this._reflectionCubeMap.sphericalPolynomial||new ll,null===(t=this._reflectionCubeMap.sphericalPolynomial)||void 0===t||t.updateFromHarmonics(this._sphericalHarmonics)),this._lightDirection.negateInPlace(),this.directionalLight&&(this.directionalLight.direction.copyFrom(this._lightDirection),this.directionalLight.intensity=Math.min(this._intensity,1),this.directionalLight.diffuse.copyFrom(this._lightColor))}}}}u_.Name=Ki.LIGHT_ESTIMATION,u_.Version=1,Ai.AddWebXRFeature(u_.Name,(r,e)=>()=>new u_(r,e),u_.Version,!1);class d_ extends Xs{constructor(e){super(e),this.onEyeTrackingStartedObservable=new z,this.onEyeTrackingEndedObservable=new z,this.onEyeTrackingFrameUpdateObservable=new z,this._eyeTrackingStartListener=t=>{this._latestEyeSpace=t.gazeSpace,this._gazeRay=new Qe(v.Zero(),v.Forward()),this.onEyeTrackingStartedObservable.notifyObservers(this._gazeRay)},this._eyeTrackingEndListener=()=>{this._latestEyeSpace=null,this._gazeRay=null,this.onEyeTrackingEndedObservable.notifyObservers()},this.xrNativeFeatureName="eye-tracking",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}dispose(){super.dispose(),this._xrSessionManager.session.removeEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.removeEventListener("eyetrackingend",this._eyeTrackingEndListener),this.onEyeTrackingStartedObservable.clear(),this.onEyeTrackingEndedObservable.clear(),this.onEyeTrackingFrameUpdateObservable.clear()}get isEyeGazeValid(){return!!this._gazeRay}getEyeGaze(){return this._gazeRay}_onXRFrame(e){if(this.attached&&e&&this._latestEyeSpace&&this._gazeRay){const t=e.getPose(this._latestEyeSpace,this._xrSessionManager.referenceSpace);if(t){this._gazeRay.origin.set(t.transform.position.x,t.transform.position.y,t.transform.position.z);const i=t.transform.orientation;L.Quaternion[0].set(i.x,i.y,i.z,i.w),this._xrSessionManager.scene.useRightHandedSystem?v.RightHandedForwardReadOnly.rotateByQuaternionToRef(L.Quaternion[0],this._gazeRay.direction):(this._gazeRay.origin.z*=-1,L.Quaternion[0].z*=-1,L.Quaternion[0].w*=-1,v.LeftHandedForwardReadOnly.rotateByQuaternionToRef(L.Quaternion[0],this._gazeRay.direction)),this.onEyeTrackingFrameUpdateObservable.notifyObservers(this._gazeRay)}}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.addEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.addEventListener("eyetrackingend",this._eyeTrackingEndListener))}}d_.Name=Ki.EYE_TRACKING,d_.Version=1,Ai.AddWebXRFeature(d_.Name,r=>()=>new d_(r),d_.Version,!1);class lce{constructor(e,t){this._samples=[],this._idx=0;for(let i=0;i<e;++i)this._samples.push(t?t():de.Zero())}get length(){return this._samples.length}push(e,t){this._idx=(this._idx+this._samples.length-1)%this._samples.length,this.at(0).copyFromFloats(e,t)}at(e){if(e>=this._samples.length)throw new Error("Index out of bounds");return this._samples[(this._idx+e)%this._samples.length]}}class cce{constructor(){this._samples=new lce(20),this._entropy=0,this.onFirstStepDetected=new z}update(e,t,i,s){this._samples.push(e,t);const n=this._samples.at(0);if(this._entropy*=this._entropyDecayFactor,this._entropy+=de.Distance(n,this._samples.at(1)),this._entropy>this._entropyThreshold)return;let o;for(o=this._samePointCheckStartIdx;o<this._samples.length&&!(de.DistanceSquared(n,this._samples.at(o))<this._samePointSquaredDistanceThreshold);++o);if(o===this._samples.length)return;let a=-1,l=0;for(let T,x=1;x<o;++x)T=de.DistanceSquared(n,this._samples.at(x)),T>a&&(l=x,a=T);if(a<this._apexSquaredDistanceThreshold)return;const c=this._samples.at(l),h=c.subtract(n);h.normalize();const u=L.Vector2[0];let d,f,p=0;for(let T=1;T<o;++T)f=this._samples.at(T),f.subtractToRef(n,u),d=de.Dot(h,u),p+=u.lengthSquared()-d*d;if(p>o*this._squaredProjectionDistanceThreshold)return;const _=L.Vector3[0];_.set(i,s,0);const m=L.Vector3[1];m.set(h.x,h.y,0);const g=v.Cross(_,m).z>0,b=n.clone(),y=n.clone();c.subtractToRef(n,h),g?(h.scaleAndAddToRef(this._axisToApexShrinkFactor,b),h.scaleAndAddToRef(this._axisToApexExtendFactor,y)):(h.scaleAndAddToRef(this._axisToApexExtendFactor,b),h.scaleAndAddToRef(this._axisToApexShrinkFactor,y)),this.onFirstStepDetected.notifyObservers({leftApex:b,rightApex:y,currentPosition:n,currentStepDirection:g?"right":"left"})}reset(){for(let e=0;e<this._samples.length;++e)this._samples.at(e).copyFromFloats(0,0)}get _samePointCheckStartIdx(){return Math.floor(this._samples.length/3)}get _samePointSquaredDistanceThreshold(){return 9e-4}get _apexSquaredDistanceThreshold(){return.0081}get _squaredProjectionDistanceThreshold(){return 9e-4}get _axisToApexShrinkFactor(){return.8}get _axisToApexExtendFactor(){return-1.6}get _entropyDecayFactor(){return.93}get _entropyThreshold(){return.4}}class hce{constructor(e,t,i,s){this._leftApex=new de,this._rightApex=new de,this._currentPosition=new de,this._axis=new de,this._axisLength=-1,this._forward=new de,this._steppingLeft=!1,this._t=-1,this._maxT=-1,this._maxTPosition=new de,this._vitality=0,this.onMovement=new z,this.onFootfall=new z,this._reset(e,t,i,"left"===s)}_reset(e,t,i,s){this._leftApex.copyFrom(e),this._rightApex.copyFrom(t),this._steppingLeft=s,this._steppingLeft?(this._leftApex.subtractToRef(this._rightApex,this._axis),this._forward.copyFromFloats(-this._axis.y,this._axis.x)):(this._rightApex.subtractToRef(this._leftApex,this._axis),this._forward.copyFromFloats(this._axis.y,-this._axis.x)),this._axisLength=this._axis.length(),this._forward.scaleInPlace(1/this._axisLength),this._updateTAndVitality(i.x,i.y),this._maxT=this._t,this._maxTPosition.copyFrom(i),this._vitality=1}_updateTAndVitality(e,t){this._currentPosition.copyFromFloats(e,t),this._currentPosition.subtractInPlace(this._steppingLeft?this._rightApex:this._leftApex);const i=this._t,s=de.Dot(this._currentPosition,this._axis);this._t=s/(this._axisLength*this._axisLength);const n=this._currentPosition.lengthSquared()-s/this._axisLength*(s/this._axisLength);this._vitality*=.92-100*Math.max(n-.0016,0)+Math.max(this._t-i,0)}update(e,t){if(this._vitality<this._vitalityThreshold)return!1;const i=this._t;return this._updateTAndVitality(e,t),this._t>this._maxT&&(this._maxT=this._t,this._maxTPosition.copyFromFloats(e,t)),!(this._vitality<this._vitalityThreshold||(this._t>i&&(this.onMovement.notifyObservers({deltaT:this._t-i}),i<.5&&this._t>=.5&&this.onFootfall.notifyObservers({foot:this._steppingLeft?"left":"right"})),this._t<.95*this._maxT&&(this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._leftApex.copyFrom(this._maxTPosition):this._rightApex.copyFrom(this._maxTPosition),this._reset(this._leftApex,this._rightApex,this._currentPosition,!this._steppingLeft)),this._axisLength<.03))}get _vitalityThreshold(){return.1}get forward(){return this._forward}}class f_{static get _MillisecondsPerUpdate(){return 1e3/15}constructor(e){this._detector=new cce,this._walker=null,this._movement=new de,this._millisecondsSinceLastUpdate=f_._MillisecondsPerUpdate,this.movementThisFrame=v.Zero(),this._engine=e,this._detector.onFirstStepDetected.add(t=>{this._walker||(this._walker=new hce(t.leftApex,t.rightApex,t.currentPosition,t.currentStepDirection),this._walker.onFootfall.add(()=>{console.log("Footfall!")}),this._walker.onMovement.add(i=>{this._walker.forward.scaleAndAddToRef(.024*i.deltaT,this._movement)}))})}update(e,t){t.y=0,t.normalize(),this._millisecondsSinceLastUpdate+=this._engine.getDeltaTime(),this._millisecondsSinceLastUpdate>=f_._MillisecondsPerUpdate&&(this._millisecondsSinceLastUpdate-=f_._MillisecondsPerUpdate,this._detector.update(e.x,e.z,t.x,t.z),this._walker&&(this._walker.update(e.x,e.z)||(this._walker=null)),this._movement.scaleInPlace(.85)),this.movementThisFrame.set(this._movement.x,0,this._movement.y)}}class S0 extends Xs{static get Name(){return Ki.WALKING_LOCOMOTION}static get Version(){return 1}get locomotionTarget(){return this._locomotionTarget}set locomotionTarget(e){this._locomotionTarget=e,this._isLocomotionTargetWebXRCamera="WebXRCamera"===this._locomotionTarget.getClassName()}constructor(e,t){super(e),this._up=new v,this._forward=new v,this._position=new v,this._movement=new v,this._sessionManager=e,this.locomotionTarget=t.locomotionTarget,this._isLocomotionTargetWebXRCamera&&V.Warn("Using walking locomotion directly on a WebXRCamera may have unintended interactions with other XR techniques. Using an XR space parent is highly recommended")}isCompatible(){return void 0===this._sessionManager.sessionMode||"immersive-vr"===this._sessionManager.sessionMode}attach(){return!(!this.isCompatible||!super.attach()||(this._walker=new f_(this._sessionManager.scene.getEngine()),0))}detach(){return!!super.detach()&&(this._walker=null,!0)}_onXRFrame(e){const t=e.getViewerPose(this._sessionManager.baseReferenceSpace);if(!t)return;const i=this.locomotionTarget.getScene().useRightHandedSystem?1:-1,s=t.transform.matrix;this._up.copyFromFloats(s[4],s[5],i*s[6]),this._forward.copyFromFloats(s[8],s[9],i*s[10]),this._position.copyFromFloats(s[12],s[13],i*s[14]),this._forward.scaleAndAddToRef(.05,this._position),this._up.scaleAndAddToRef(-.05,this._position),this._walker.update(this._position,this._forward),this._movement.copyFrom(this._walker.movementThisFrame),this._isLocomotionTargetWebXRCamera||v.TransformNormalToRef(this._movement,this.locomotionTarget.getWorldMatrix(),this._movement),this.locomotionTarget.position.addInPlace(this._movement)}}Ai.AddWebXRFeature(S0.Name,(r,e)=>()=>new S0(r,e),S0.Version,!1);class uce extends XE{constructor(e,t,i,s,n,o){super(e,t,i,s,o),this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=s,this.isMultiview=n,this.createRTTProvider=o}}class dce extends jE{constructor(e,t,i){super(e.scene,i),this._xrSessionManager=e,this._xrWebGLBinding=t,this.layerWrapper=i,this._lastSubImages=new Map,this._compositionLayer=i.layer}_getRenderTargetForSubImage(e,t){const i=this._lastSubImages.get(t),s="left"==t?0:1;return(!this._renderTargetTextures[s]||i?.textureWidth!==e.textureWidth||i?.textureHeight!=e.textureHeight)&&(this._renderTargetTextures[s]=this._createRenderTargetTexture(e.textureWidth,e.textureHeight,null,e.colorTexture,e.depthStencilTexture,this.layerWrapper.isMultiview),this._framebufferDimensions={framebufferWidth:e.textureWidth,framebufferHeight:e.textureHeight}),this._lastSubImages.set(t,e),this._renderTargetTextures[s]}_getSubImageForEye(e){const t=this._xrSessionManager.currentFrame;return t?this._xrWebGLBinding.getSubImage(this._compositionLayer,t,e):null}getRenderTargetTextureForEye(e){const t=this._getSubImageForEye(e);return t?this._getRenderTargetForSubImage(t,e):null}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}_setViewportForSubImage(e,t){const i=t.textureWidth,s=t.textureHeight,n=t.viewport;e.x=n.x/i,e.y=n.y/s,e.width=n.width/i,e.height=n.height/s}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForEye(t.eye);return!!i&&(this._setViewportForSubImage(e,i),!0)}}class fce extends uce{constructor(e,t,i){super(()=>e.textureWidth,()=>e.textureHeight,e,"XRProjectionLayer",t,s=>new pce(s,i,this)),this.layer=e}}class pce extends dce{constructor(e,t,i){super(e,t,i),this.layerWrapper=i,this._projectionLayer=i.layer}_getSubImageForView(e){return this._xrWebGLBinding.getViewSubImage(this._projectionLayer,e)}getRenderTargetTextureForView(e){return this._getRenderTargetForSubImage(this._getSubImageForView(e),e.eye)}getRenderTargetTextureForEye(e){const t=this._lastSubImages.get(e);return t?this._getRenderTargetForSubImage(t,e):null}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForView(t);return!!i&&(this._setViewportForSubImage(e,i),!0)}}const _ce={},kW={textureType:"texture",colorFormat:6408,depthFormat:35056,scaleFactor:1};class p_ extends Xs{constructor(e,t={}){super(e),this._options=t,this._existingLayers=[],this.xrNativeFeatureName="layers"}attach(){if(!super.attach())return!1;const e=this._xrSessionManager.scene.getEngine();this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this._existingLayers.length=0;const t={...kW},i=this._options.preferMultiviewOnInit&&e.getCaps().multiview;return i&&(t.textureType="texture-array"),this.addXRSessionLayer(this.createProjectionLayer(t,i)),!0}detach(){return!!super.detach()&&(this._existingLayers.length=0,!0)}createXRWebGLLayer(e=_ce){const t=new XRWebGLLayer(this._xrSessionManager.session,this._glContext,e);return new YE(t)}createProjectionLayer(e=kW,t=!1){if(t&&"texture-array"!==e.textureType)throw new Error("Projection layers can only be made multiview if they use texture arrays. Set the textureType parameter to 'texture-array'.");if(!t&&"texture-array"===e.textureType)throw new Error("We currently only support multiview rendering when the textureType parameter is set to 'texture-array'.");const i=this._xrWebGLBinding.createProjectionLayer(e);return new fce(i,t,this._xrWebGLBinding)}addXRSessionLayer(e){this.setXRSessionLayers([...this._existingLayers,e])}setXRSessionLayers(e){this._existingLayers=e;const t={...this._xrSessionManager.session.renderState};t.baseLayer=void 0,t.layers=e.map(i=>i.layer),this._xrSessionManager.updateRenderState(t),this._xrSessionManager._setBaseLayerWrapper(e.length>0?e[0]:null)}isCompatible(){return!this._xrSessionManager.isNative&&typeof XRWebGLBinding<"u"&&!!XRWebGLBinding.prototype.createProjectionLayer}dispose(){super.dispose()}_onXRFrame(e){}}p_.Name=Ki.LAYERS,p_.Version=1,Ai.AddWebXRFeature(p_.Name,(r,e)=>()=>new p_(r,e),p_.Version,!1);class __ extends Xs{get width(){return this._width}get height(){return this._height}get rawValueToMeters(){return this._rawValueToMeters}get normDepthBufferFromNormView(){return this._normDepthBufferFromNormView}get depthUsage(){switch(this._xrSessionManager.session.depthUsage){case"cpu-optimized":return"cpu";case"gpu-optimized":return"gpu"}}get depthDataFormat(){switch(this._xrSessionManager.session.depthDataFormat){case"luminance-alpha":return"ushort";case"float32":return"float"}}get latestInternalTexture(){var e,t;if(!this._cachedWebGLTexture)return null;const i=this._xrSessionManager.scene.getEngine(),s=new zt(i,Ye.Unknown);return s.isCube=!1,s.invertY=!1,s._useSRGBBuffer=!1,s.format="ushort"===this.depthDataFormat?2:5,s.generateMipMaps=!1,s.type="ushort"===this.depthDataFormat?5:1,s.samplingMode=7,s.width=null!==(e=this.width)&&void 0!==e?e:0,s.height=null!==(t=this.height)&&void 0!==t?t:0,s._cachedWrapU=1,s._cachedWrapV=1,s._hardwareTexture=new lp(this._cachedWebGLTexture,i._gl),s}get latestDepthBuffer(){return this._cachedDepthBuffer?"ushort"===this.depthDataFormat?new Uint16Array(this._cachedDepthBuffer):new Float32Array(this._cachedDepthBuffer):null}get latestDepthImageTexture(){return this._cachedDepthImageTexture}constructor(e,t){super(e),this.options=t,this._width=null,this._height=null,this._rawValueToMeters=null,this._normDepthBufferFromNormView=null,this._cachedDepthBuffer=null,this._cachedWebGLTexture=null,this._cachedDepthImageTexture=null,this.onGetDepthInMetersAvailable=new z,this.xrNativeFeatureName="depth-sensing",q.Warn("depth-sensing is an experimental and unstable feature.")}attach(e){return!(!super.attach(e)||null==this._xrSessionManager.session.depthDataFormat||null==this._xrSessionManager.session.depthUsage||(this._glBinding=new XRWebGLBinding(this._xrSessionManager.session,this._xrSessionManager.scene.getEngine()._gl),0))}dispose(){var e;null===(e=this._cachedDepthImageTexture)||void 0===e||e.dispose()}_onXRFrame(e){const i=e.getViewerPose(this._xrSessionManager.referenceSpace);if(null!=i)for(const s of i.views)switch(this.depthUsage){case"cpu":this._updateDepthInformationAndTextureCPUDepthUsage(e,s,this.depthDataFormat);break;case"gpu":if(!this._glBinding)break;this._updateDepthInformationAndTextureWebGLDepthUsage(this._glBinding,s,this.depthDataFormat);break;default:q.Error("Unknown depth usage"),this.detach()}}_updateDepthInformationAndTextureCPUDepthUsage(e,t,i){const s=e.getDepthInformation(t);if(null===s)return;const{data:n,width:o,height:a,rawValueToMeters:l,getDepthInMeters:c}=s;switch(this._width=o,this._height=a,this._rawValueToMeters=l,this._cachedDepthBuffer=n,this.onGetDepthInMetersAvailable.notifyObservers(c.bind(s)),this._cachedDepthImageTexture||(this._cachedDepthImageTexture=pr.CreateRTexture(null,o,a,this._xrSessionManager.scene,!1,!0,U.NEAREST_SAMPLINGMODE,ee.TEXTURETYPE_FLOAT)),i){case"ushort":this._cachedDepthImageTexture.update(Float32Array.from(new Uint16Array(n)).map(h=>h*l));break;case"float":this._cachedDepthImageTexture.update(new Float32Array(n).map(h=>h*l))}}_updateDepthInformationAndTextureWebGLDepthUsage(e,t,i){const s=e.getDepthInformation(t);if(null===s)return;const{texture:n,width:o,height:a}=s;this._width=o,this._height=a,this._cachedWebGLTexture=n;const l=this._xrSessionManager.scene,h=l.getEngine().wrapWebGLTexture(n);this._cachedDepthImageTexture||(this._cachedDepthImageTexture=pr.CreateRTexture(null,o,a,l,!1,!0,U.NEAREST_SAMPLINGMODE,"ushort"===i?ee.TEXTURETYPE_UNSIGNED_BYTE:ee.TEXTURETYPE_FLOAT)),this._cachedDepthImageTexture._texture=h}getXRSessionInitExtension(){const e=null!=this.options.usagePreference&&0!==this.options.usagePreference.length,t=null!=this.options.dataFormatPreference&&0!==this.options.dataFormatPreference.length;return new Promise(i=>{if(e&&t){i({depthSensing:{usagePreference:this.options.usagePreference.map(o=>{switch(o){case"cpu":return"cpu-optimized";case"gpu":return"gpu-optimized"}}),dataFormatPreference:this.options.dataFormatPreference.map(o=>{switch(o){case"ushort":return"luminance-alpha";case"float":return"float32"}})}})}else i({})})}}__.Name=Ki.DEPTH_SENSING,__.Version=1,Ai.AddWebXRFeature(__.Name,(r,e)=>()=>new __(r,e),__.Version,!1);class mce extends sd{constructor(e,t,i){super(e,gce[i],t,i,!0),this.profileId="generic-hand-select-grasp"}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){}_updateModel(){}}nn.RegisterController("generic-hand-select-grasp",(r,e)=>new mce(e,r.gamepad,r.handedness));const gce={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-none",assetPath:"none.glb"}};let vce=(()=>{class r extends sd{constructor(t,i,s){super(t,bce["left-right"],i,s),this._mapping={defaultButton:{valueNodeName:"VALUE",unpressedNodeName:"UNPRESSED",pressedNodeName:"PRESSED"},defaultAxis:{valueNodeName:"VALUE",minNodeName:"MIN",maxNodeName:"MAX"},buttons:{"xr-standard-trigger":{rootNodeName:"SELECT",componentProperty:"button",states:["default","touched","pressed"]},"xr-standard-squeeze":{rootNodeName:"GRASP",componentProperty:"state",states:["pressed"]},"xr-standard-touchpad":{rootNodeName:"TOUCHPAD_PRESS",labelAnchorNodeName:"squeeze-label",touchPointNodeName:"TOUCH"},"xr-standard-thumbstick":{rootNodeName:"THUMBSTICK_PRESS",componentProperty:"state",states:["pressed"]}},axes:{"xr-standard-touchpad":{"x-axis":{rootNodeName:"TOUCHPAD_TOUCH_X"},"y-axis":{rootNodeName:"TOUCHPAD_TOUCH_Y"}},"xr-standard-thumbstick":{"x-axis":{rootNodeName:"THUMBSTICK_X"},"y-axis":{rootNodeName:"THUMBSTICK_Y"}}}},this.profileId="microsoft-mixed-reality"}_getFilenameAndPath(){let t="";return t="left"===this.handedness?r.MODEL_LEFT_FILENAME:r.MODEL_RIGHT_FILENAME,{filename:t,path:r.MODEL_BASE_URL+"default/"}}_getModelLoadingConstraints(){const t=ke.IsPluginForExtensionAvailable(".glb");return t||V.Warn("glTF / glb loaded was not registered, using generic controller instead"),t}_processLoadedModel(t){!this.rootMesh||(this.getComponentIds().forEach((i,s)=>{if(!this.disableAnimation&&i&&this.rootMesh){const n=this._mapping.buttons[i],o=n.rootNodeName;if(!o)return void V.Log("Skipping unknown button at index: "+s+" with mapped name: "+i);const a=this._getChildByName(this.rootMesh,o);if(!a)return void V.Warn("Missing button mesh with name: "+o);if(n.valueMesh=this._getImmediateChildByName(a,this._mapping.defaultButton.valueNodeName),n.pressedMesh=this._getImmediateChildByName(a,this._mapping.defaultButton.pressedNodeName),n.unpressedMesh=this._getImmediateChildByName(a,this._mapping.defaultButton.unpressedNodeName),n.valueMesh&&n.pressedMesh&&n.unpressedMesh){const l=this.getComponent(i);l&&l.onButtonStateChangedObservable.add(c=>{this._lerpTransform(n,c.value)},void 0,!0)}else V.Warn("Missing button submesh under mesh with name: "+o)}}),this.getComponentIds().forEach(i=>{const s=this.getComponent(i);!s.isAxes()||["x-axis","y-axis"].forEach(n=>{if(!this.rootMesh)return;const o=this._mapping.axes[i][n],a=this._getChildByName(this.rootMesh,o.rootNodeName);a?(o.valueMesh=this._getImmediateChildByName(a,this._mapping.defaultAxis.valueNodeName),o.minMesh=this._getImmediateChildByName(a,this._mapping.defaultAxis.minNodeName),o.maxMesh=this._getImmediateChildByName(a,this._mapping.defaultAxis.maxNodeName),o.valueMesh&&o.minMesh&&o.maxMesh?s&&s.onAxisValueChangedObservable.add(l=>{this._lerpTransform(o,"x-axis"===n?l.x:l.y,!0)},void 0,!0):V.Warn("Missing axis submesh under mesh with name: "+o.rootNodeName)):V.Warn("Missing axis mesh with name: "+o.rootNodeName)})}))}_setRootMesh(t){let i;this.rootMesh=new G(this.profileId+" "+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(let s=0;s<t.length;s++){const n=t[s];n.isPickable=!1,n.parent||(i=n)}i&&i.setParent(this.rootMesh),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=Z.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}return r.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/",r.MODEL_LEFT_FILENAME="left.glb",r.MODEL_RIGHT_FILENAME="right.glb",r})();nn.RegisterController("windows-mixed-reality",(r,e)=>new vce(e,r.gamepad,r.handedness));const bce={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-right",assetPath:"right.glb"}};let GW=(()=>{class r extends sd{constructor(t,i,s,n=!1,o=!1){super(t,yce[s],i,s),this._forceLegacyControllers=o,this.profileId="oculus-touch"}_getFilenameAndPath(){let t="";return t="left"===this.handedness?r.MODEL_LEFT_FILENAME:r.MODEL_RIGHT_FILENAME,{filename:t,path:this._isQuest()?r.QUEST_MODEL_BASE_URL:r.MODEL_BASE_URL}}_getModelLoadingConstraints(){return!0}_processLoadedModel(t){const i=this._isQuest(),s="right"===this.handedness?-1:1;this.getComponentIds().forEach(n=>{const o=n&&this.getComponent(n);o&&o.onButtonStateChangedObservable.add(a=>{if(this.rootMesh&&!this.disableAnimation)switch(n){case"xr-standard-trigger":return void(i||(this._modelRootNode.getChildren()[3].rotation.x=.2*-a.value,this._modelRootNode.getChildren()[3].position.y=.005*-a.value,this._modelRootNode.getChildren()[3].position.z=.005*-a.value));case"xr-standard-squeeze":return void(i||(this._modelRootNode.getChildren()[4].position.x=s*a.value*.0035));case"xr-standard-thumbstick":return;case"a-button":case"x-button":return void(i||(this._modelRootNode.getChildren()[1].position.y=a.pressed?-.001:0));case"b-button":case"y-button":return void(i||(this._modelRootNode.getChildren()[2].position.y=a.pressed?-.001:0))}},void 0,!0)})}_setRootMesh(t){this.rootMesh=new G(this.profileId+" "+this.handedness,this.scene),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=Z.FromEulerAngles(0,Math.PI,0)),t.forEach(i=>{i.isPickable=!1}),this._isQuest()?this._modelRootNode=t[0]:(this._modelRootNode=t[1],this.rootMesh.position.y=.034,this.rootMesh.position.z=.052),this._modelRootNode.parent=this.rootMesh}_updateModel(){}_isQuest(){return!!navigator.userAgent.match(/Quest/gi)&&!this._forceLegacyControllers}}return r.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/",r.MODEL_LEFT_FILENAME="left.babylon",r.MODEL_RIGHT_FILENAME="right.babylon",r.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/",r})();nn.RegisterController("oculus-touch",(r,e)=>new GW(e,r.gamepad,r.handedness)),nn.RegisterController("oculus-touch-legacy",(r,e)=>new GW(e,r.gamepad,r.handedness,!0));const yce={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"x-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"x_button",visualResponses:{}},"y-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"y_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"a-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"a_button",visualResponses:{}},"b-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"b_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-right",assetPath:"right.glb"}};let xce=(()=>{class r extends sd{constructor(t,i,s){super(t,Tce[s],i,s),this.profileId="htc-vive"}_getFilenameAndPath(){return{filename:r.MODEL_FILENAME,path:r.MODEL_BASE_URL}}_getModelLoadingConstraints(){return!0}_processLoadedModel(t){this.getComponentIds().forEach(i=>{const s=i&&this.getComponent(i);s&&s.onButtonStateChangedObservable.add(n=>{if(this.rootMesh&&!this.disableAnimation)switch(i){case"xr-standard-trigger":return void(this._modelRootNode.getChildren()[6].rotation.x=.15*-n.value);case"xr-standard-touchpad":case"xr-standard-squeeze":return}},void 0,!0)})}_setRootMesh(t){this.rootMesh=new G(this.profileId+" "+this.handedness,this.scene),t.forEach(i=>{i.isPickable=!1}),this._modelRootNode=t[1],this._modelRootNode.parent=this.rootMesh,this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=Z.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}return r.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/",r.MODEL_FILENAME="wand.babylon",r})();nn.RegisterController("htc-vive",(r,e)=>new xce(e,r.gamepad,r.handedness));const Tce={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc-vive-none",assetPath:"none.glb"}};function E0(r,e,t,i){const s={externalResourceFunction:n=>i(n).then(o=>new Uint8Array(o))};return t&&(s.uri="file:"===e?t:e+t),r instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(r),s):GLTFValidator.validateString(r,s)}function Ece(){const r=[];onmessage=e=>{const t=e.data;switch(t.id){case"init":importScripts(t.url);break;case"validate":E0(t.data,t.rootUrl,t.fileName,i=>new Promise((s,n)=>{const o=r.length;r.push({resolve:s,reject:n}),postMessage({id:"getExternalResource",index:o,uri:i})})).then(i=>{postMessage({id:"validate.resolve",value:i})},i=>{postMessage({id:"validate.reject",reason:i})});break;case"getExternalResource.resolve":r[t.index].resolve(t.value);break;case"getExternalResource.reject":r[t.index].reject(t.reason)}}}!function Sre(r,e){fC.apply(this,arguments)}("NativeXRFrame",class Sce{get session(){return this._nativeImpl.session}constructor(e){this._nativeImpl=e,this._xrTransform=new XRRigidTransform,this._xrPose={transform:this._xrTransform,emulatedPosition:!1},this._xrPoseVectorData=new Float32Array(8),this.fillPoses=this._nativeImpl.fillPoses.bind(this._nativeImpl),this.getViewerPose=this._nativeImpl.getViewerPose.bind(this._nativeImpl),this.getHitTestResults=this._nativeImpl.getHitTestResults.bind(this._nativeImpl),this.getHitTestResultsForTransientInput=()=>{throw new Error("XRFrame.getHitTestResultsForTransientInput not supported on native.")},this.createAnchor=this._nativeImpl.createAnchor.bind(this._nativeImpl),this.getJointPose=this._nativeImpl.getJointPose.bind(this._nativeImpl),this.fillJointRadii=this._nativeImpl.fillJointRadii.bind(this._nativeImpl),this.getLightEstimate=()=>{throw new Error("XRFrame.getLightEstimate not supported on native.")},this.getImageTrackingResults=()=>{var t;return null!==(t=this._nativeImpl._imageTrackingResults)&&void 0!==t?t:[]}}getPose(e,t){if(!this._nativeImpl.getPoseData(e,t,this._xrPoseVectorData.buffer,this._xrTransform.matrix.buffer))return;const i=this._xrTransform.position;i.x=this._xrPoseVectorData[0],i.y=this._xrPoseVectorData[1],i.z=this._xrPoseVectorData[2],i.w=this._xrPoseVectorData[3];const s=this._xrTransform.orientation;return s.x=this._xrPoseVectorData[4],s.y=this._xrPoseVectorData[5],s.z=this._xrPoseVectorData[6],s.w=this._xrPoseVectorData[7],this._xrPose}get trackedAnchors(){return this._nativeImpl.trackedAnchors}get worldInformation(){return this._nativeImpl.worldInformation}get detectedPlanes(){return this._nativeImpl.detectedPlanes}get featurePointCloud(){return this._nativeImpl.featurePointCloud}getDepthInformation(e){throw new Error("This function is not available in Babylon Native")}});let Cce=(()=>{class r{static ValidateAsync(t,i,s,n){return"function"==typeof Worker?new Promise((o,a)=>{const c=URL.createObjectURL(new Blob([`${E0}(${Ece})()`],{type:"application/javascript"})),h=new Worker(c),u=f=>{h.removeEventListener("error",u),h.removeEventListener("message",d),a(f)},d=f=>{const p=f.data;switch(p.id){case"getExternalResource":n(p.uri).then(_=>{h.postMessage({id:"getExternalResource.resolve",index:p.index,value:_},[_])},_=>{h.postMessage({id:"getExternalResource.reject",index:p.index,reason:_})});break;case"validate.resolve":h.removeEventListener("error",u),h.removeEventListener("message",d),o(p.value),h.terminate();break;case"validate.reject":h.removeEventListener("error",u),h.removeEventListener("message",d),a(p.reason),h.terminate()}};h.addEventListener("error",u),h.addEventListener("message",d),h.postMessage({id:"init",url:this.Configuration.url}),h.postMessage({id:"validate",data:t,rootUrl:i,fileName:s})}):(this._LoadScriptPromise||(this._LoadScriptPromise=q.LoadScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>E0(t,i,s,n)))}}return r.Configuration={url:"https://preview.babylonjs.com/gltf_validator.js"},r})();function zW(r,e,t){try{return Promise.resolve(new Uint8Array(r,e,t))}catch(i){return Promise.reject(i)}}var Ed=(()=>{return(r=Ed||(Ed={}))[r.AUTO=0]="AUTO",r[r.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED",Ed;var r})(),Lh=(()=>{return(r=Lh||(Lh={}))[r.NONE=0]="NONE",r[r.FIRST=1]="FIRST",r[r.ALL=2]="ALL",Lh;var r})(),an=(()=>{return(r=an||(an={}))[r.LOADING=0]="LOADING",r[r.READY=1]="READY",r[r.COMPLETE=2]="COMPLETE",an;var r})();let yc=(()=>{class r{constructor(){this.onParsedObservable=new z,this.coordinateSystemMode=Ed.AUTO,this.animationStartMode=Lh.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.preprocessUrlAsync=t=>Promise.resolve(t),this.onMeshLoadedObservable=new z,this.onSkinLoadedObservable=new z,this.onTextureLoadedObservable=new z,this.onMaterialLoadedObservable=new z,this.onCameraLoadedObservable=new z,this.onCompleteObservable=new z,this.onErrorObservable=new z,this.onDisposeObservable=new z,this.onExtensionLoadedObservable=new z,this.validate=!1,this.onValidatedObservable=new z,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new z,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}set onParsed(t){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(t)}set onMeshLoaded(t){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(t)}set onTextureLoaded(t){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(t)}set onMaterialLoaded(t){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(t)}set onCameraLoaded(t){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(t)}set onComplete(t){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(t)}set onError(t){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(t)}set onDispose(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)}set onExtensionLoaded(t){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(t)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(t){this._loggingEnabled!==t&&(this._loggingEnabled=t,this._log=this._loggingEnabled?this._logEnabled:this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(t){this._capturePerformanceCounters!==t&&(this._capturePerformanceCounters=t,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(t){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(t)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const t of this._requests)t.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=t=>Promise.resolve(t),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(t,i,s,n,o,a){this._progressCallback=n;const l=i.name?"file:":q.GetFolderPath(i),c=i.name||q.GetFilename(i);if(o){if(this.useRangeRequests){this.validate&&V.Warn("glTF validation is not supported when range requests are enabled");const h={abort:()=>{},onCompleteObservable:new z};return this._unpackBinaryAsync(new y0({readAsync:(d,f)=>new Promise((p,_)=>{this._loadFile(t,i,m=>{p(new Uint8Array(m))},!0,m=>{_(m)},m=>{m.setRequestHeader("Range",`bytes=${d}-${d+f-1}`)})}),byteLength:0})).then(d=>{h.onCompleteObservable.notifyObservers(h),s(d)},a?d=>a(void 0,d):void 0),h}return this._loadFile(t,i,h=>{this._validate(t,h,l,c),this._unpackBinaryAsync(new y0({readAsync:(u,d)=>zW(h,u,d),byteLength:h.byteLength})).then(u=>{s(u)},a?u=>a(void 0,u):void 0)},!0,a)}return this._loadFile(t,i,h=>{this._validate(t,h,l,c),s({json:this._parseJson(h)})},o,a)}importMeshAsync(t,i,s,n,o,a){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(s),this.onParsedObservable.clear(),this._log(`Loading ${a||""}`),this._loader=this._getLoader(s),this._loader.importMeshAsync(t,i,null,s,n,o,a)))}loadAsync(t,i,s,n,o){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(i),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(i),this._loader.loadAsync(t,i,s,n,o)))}loadAssetContainerAsync(t,i,s,n,o){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(i),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(i);const a=new E1(t),l=[];this.onMaterialLoadedObservable.add(d=>{l.push(d)});const c=[];this.onTextureLoadedObservable.add(d=>{c.push(d)});const h=[];this.onCameraLoadedObservable.add(d=>{h.push(d)});const u=[];return this.onMeshLoadedObservable.add(d=>{d.morphTargetManager&&u.push(d.morphTargetManager)}),this._loader.importMeshAsync(null,t,a,i,s,n,o).then(d=>(Array.prototype.push.apply(a.geometries,d.geometries),Array.prototype.push.apply(a.meshes,d.meshes),Array.prototype.push.apply(a.particleSystems,d.particleSystems),Array.prototype.push.apply(a.skeletons,d.skeletons),Array.prototype.push.apply(a.animationGroups,d.animationGroups),Array.prototype.push.apply(a.materials,l),Array.prototype.push.apply(a.textures,c),Array.prototype.push.apply(a.lights,d.lights),Array.prototype.push.apply(a.transformNodes,d.transformNodes),Array.prototype.push.apply(a.cameras,h),Array.prototype.push.apply(a.morphTargetManagers,u),a))})}canDirectLoad(t){return-1!==t.indexOf("asset")&&-1!==t.indexOf("version")||t.startsWith("data:base64,"+r._MagicBase64Encoded)||t.startsWith("data:;base64,"+r._MagicBase64Encoded)||t.startsWith("data:application/octet-stream;base64,"+r._MagicBase64Encoded)||t.startsWith("data:model/gltf-binary;base64,"+r._MagicBase64Encoded)}directLoad(t,i){if(i.startsWith("base64,"+r._MagicBase64Encoded)||i.startsWith(";base64,"+r._MagicBase64Encoded)||i.startsWith("application/octet-stream;base64,"+r._MagicBase64Encoded)||i.startsWith("model/gltf-binary;base64,"+r._MagicBase64Encoded)){const s=up(i);return this._validate(t,s),this._unpackBinaryAsync(new y0({readAsync:(n,o)=>zW(s,n,o),byteLength:s.byteLength}))}return this._validate(t,i),Promise.resolve({json:this._parseJson(i)})}createPlugin(){return new r}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((t,i)=>{this.onCompleteObservable.addOnce(()=>{t()}),this.onErrorObservable.addOnce(s=>{i(s)})})}_setState(t){this._state!==t&&(this._state=t,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(an[this._state]))}_loadFile(t,i,s,n,o,a){const l=t._loadFile(i,s,c=>{this._onProgress(c,l)},!0,n,o,a);return l.onCompleteObservable.add(c=>{this._requests.splice(this._requests.indexOf(c),1)}),this._requests.push(l),l}_onProgress(t,i){if(!this._progressCallback)return;i._lengthComputable=t.lengthComputable,i._loaded=t.loaded,i._total=t.total;let s=!0,n=0,o=0;for(const a of this._requests){if(void 0===a._lengthComputable||void 0===a._loaded||void 0===a._total)return;s=s&&a._lengthComputable,n+=a._loaded,o+=a._total}this._progressCallback({lengthComputable:s,loaded:n,total:s?o:0})}_validate(t,i,s="",n=""){!this.validate||(this._startPerformanceCounter("Validate JSON"),Cce.ValidateAsync(i,s,n,o=>this.preprocessUrlAsync(s+o).then(a=>t._loadFileAsync(a,void 0,!0,!0))).then(o=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(o),this.onValidatedObservable.clear()},o=>{this._endPerformanceCounter("Validate JSON"),q.Warn(`Failed to validate: ${o.message}`),this.onValidatedObservable.clear()}))}_getLoader(t){const i=t.json.asset||{};this._log(`Asset version: ${i.version}`),i.minVersion&&this._log(`Asset minimum version: ${i.minVersion}`),i.generator&&this._log(`Asset generator: ${i.generator}`);const s=r._parseVersion(i.version);if(!s)throw new Error("Invalid version: "+i.version);if(void 0!==i.minVersion){const a=r._parseVersion(i.minVersion);if(!a)throw new Error("Invalid minimum version: "+i.minVersion);if(r._compareVersion(a,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+i.minVersion)}const o={1:r._CreateGLTF1Loader,2:r._CreateGLTF2Loader}[s.major];if(!o)throw new Error("Unsupported version: "+i.version);return o(this)}_parseJson(t){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${t.length}`);const i=JSON.parse(t);return this._endPerformanceCounter("Parse JSON"),i}_unpackBinaryAsync(t){return this._startPerformanceCounter("Unpack Binary"),t.loadAsync(20).then(()=>{const s=t.readUint32();if(1179937895!==s)throw new No("Unexpected magic: "+s,2e3);const n=t.readUint32();this.loggingEnabled&&this._log(`Binary version: ${n}`);const o=t.readUint32();let a;switch(!this.useRangeRequests&&o!==t.buffer.byteLength&&V.Warn(`Length in header does not match actual data length: ${o} != ${t.buffer.byteLength}`),n){case 1:a=this._unpackBinaryV1Async(t,o);break;case 2:a=this._unpackBinaryV2Async(t,o);break;default:throw new Error("Unsupported version: "+n)}return this._endPerformanceCounter("Unpack Binary"),a})}_unpackBinaryV1Async(t,i){const n=t.readUint32(),o=t.readUint32();if(0!==o)throw new Error(`Unexpected content format: ${o}`);const a=i-t.byteOffset,l={json:this._parseJson(t.readString(n)),bin:null};if(0!==a){const c=t.byteOffset;l.bin={readAsync:(h,u)=>t.buffer.readAsync(c+h,u),byteLength:a}}return Promise.resolve(l)}_unpackBinaryV2Async(t,i){const n=t.readUint32();if(1313821514!==t.readUint32())throw new Error("First chunk format is not JSON");return t.byteOffset+n===i?t.loadAsync(n).then(()=>({json:this._parseJson(t.readString(n)),bin:null})):t.loadAsync(n+8).then(()=>{const a={json:this._parseJson(t.readString(n)),bin:null},l=()=>{const c=t.readUint32();switch(t.readUint32()){case 1313821514:throw new Error("Unexpected JSON chunk");case 5130562:{const u=t.byteOffset;a.bin={readAsync:(d,f)=>t.buffer.readAsync(u+d,f),byteLength:c},t.skipBytes(c);break}default:t.skipBytes(c)}return t.byteOffset!==i?t.loadAsync(8).then(l):Promise.resolve(a)};return l()})}static _parseVersion(t){if("1.0"===t||"1.0.1"===t)return{major:1,minor:0};const i=(t+"").match(/^(\d+)\.(\d+)/);return i?{major:parseInt(i[1]),minor:parseInt(i[2])}:null}static _compareVersion(t,i){return t.major>i.major?1:t.major<i.major?-1:t.minor>i.minor?1:t.minor<i.minor?-1:0}_logOpen(t){this._log(t),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(t){const i=r._logSpaces.substr(0,2*this._logIndentLevel);V.Log(`${i}${t}`)}_logDisabled(t){}_startPerformanceCounterEnabled(t){q.StartPerformanceCounter(t)}_startPerformanceCounterDisabled(t){}_endPerformanceCounterEnabled(t){q.EndPerformanceCounter(t)}_endPerformanceCounterDisabled(t){}}return r.IncrementalLoading=!0,r.HomogeneousCoordinates=!1,r._MagicBase64Encoded="Z2xURg",r._logSpaces="                                ",r})();ke&&ke.RegisterPlugin(new yc);var xl=(()=>{return(r=xl||(xl={}))[r.BYTE=5120]="BYTE",r[r.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",r[r.SHORT=5122]="SHORT",r[r.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",r[r.FLOAT=5126]="FLOAT",xl;var r})(),Pb=(()=>{return(r=Pb||(Pb={}))[r.FRAGMENT=35632]="FRAGMENT",r[r.VERTEX=35633]="VERTEX",Pb;var r})(),Fr=(()=>{return(r=Fr||(Fr={}))[r.BYTE=5120]="BYTE",r[r.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",r[r.SHORT=5122]="SHORT",r[r.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",r[r.INT=5124]="INT",r[r.UNSIGNED_INT=5125]="UNSIGNED_INT",r[r.FLOAT=5126]="FLOAT",r[r.FLOAT_VEC2=35664]="FLOAT_VEC2",r[r.FLOAT_VEC3=35665]="FLOAT_VEC3",r[r.FLOAT_VEC4=35666]="FLOAT_VEC4",r[r.INT_VEC2=35667]="INT_VEC2",r[r.INT_VEC3=35668]="INT_VEC3",r[r.INT_VEC4=35669]="INT_VEC4",r[r.BOOL=35670]="BOOL",r[r.BOOL_VEC2=35671]="BOOL_VEC2",r[r.BOOL_VEC3=35672]="BOOL_VEC3",r[r.BOOL_VEC4=35673]="BOOL_VEC4",r[r.FLOAT_MAT2=35674]="FLOAT_MAT2",r[r.FLOAT_MAT3=35675]="FLOAT_MAT3",r[r.FLOAT_MAT4=35676]="FLOAT_MAT4",r[r.SAMPLER_2D=35678]="SAMPLER_2D",Fr;var r})(),Cd=(()=>{return(r=Cd||(Cd={}))[r.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",r[r.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",r[r.REPEAT=10497]="REPEAT",Cd;var r})(),vo=(()=>{return(r=vo||(vo={}))[r.NEAREST=9728]="NEAREST",r[r.LINEAR=9728]="LINEAR",r[r.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",r[r.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",r[r.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",r[r.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",vo;var r})(),Db=(()=>{return(r=Db||(Db={}))[r.FRONT=1028]="FRONT",r[r.BACK=1029]="BACK",r[r.FRONT_AND_BACK=1032]="FRONT_AND_BACK",Db;var r})(),Ni=(()=>{return(r=Ni||(Ni={}))[r.ZERO=0]="ZERO",r[r.ONE=1]="ONE",r[r.SRC_COLOR=768]="SRC_COLOR",r[r.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",r[r.DST_COLOR=774]="DST_COLOR",r[r.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",r[r.SRC_ALPHA=770]="SRC_ALPHA",r[r.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",r[r.DST_ALPHA=772]="DST_ALPHA",r[r.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",r[r.CONSTANT_COLOR=32769]="CONSTANT_COLOR",r[r.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",r[r.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",r[r.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",r[r.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",Ni;var r})();let Sn=(()=>{class r{static SetMatrix(t,i,s,n,o){let a=null;if("MODEL"===s.semantic?a=i.getWorldMatrix():"PROJECTION"===s.semantic?a=t.getProjectionMatrix():"VIEW"===s.semantic?a=t.getViewMatrix():"MODELVIEWINVERSETRANSPOSE"===s.semantic?a=F.Transpose(i.getWorldMatrix().multiply(t.getViewMatrix()).invert()):"MODELVIEW"===s.semantic?a=i.getWorldMatrix().multiply(t.getViewMatrix()):"MODELVIEWPROJECTION"===s.semantic?a=i.getWorldMatrix().multiply(t.getTransformMatrix()):"MODELINVERSE"===s.semantic?a=i.getWorldMatrix().invert():"VIEWINVERSE"===s.semantic?a=t.getViewMatrix().invert():"PROJECTIONINVERSE"===s.semantic?a=t.getProjectionMatrix().invert():"MODELVIEWINVERSE"===s.semantic?a=i.getWorldMatrix().multiply(t.getViewMatrix()).invert():"MODELVIEWPROJECTIONINVERSE"===s.semantic?a=i.getWorldMatrix().multiply(t.getTransformMatrix()).invert():"MODELINVERSETRANSPOSE"===s.semantic&&(a=F.Transpose(i.getWorldMatrix().invert())),a)switch(s.type){case Fr.FLOAT_MAT2:o.setMatrix2x2(n,F.GetAsMatrix2x2(a));break;case Fr.FLOAT_MAT3:o.setMatrix3x3(n,F.GetAsMatrix3x3(a));break;case Fr.FLOAT_MAT4:o.setMatrix(n,a)}}static SetUniform(t,i,s,n){switch(n){case Fr.FLOAT:return t.setFloat(i,s),!0;case Fr.FLOAT_VEC2:return t.setVector2(i,de.FromArray(s)),!0;case Fr.FLOAT_VEC3:return t.setVector3(i,v.FromArray(s)),!0;case Fr.FLOAT_VEC4:return t.setVector4(i,vt.FromArray(s)),!0;default:return!1}}static GetWrapMode(t){switch(t){case Cd.CLAMP_TO_EDGE:return U.CLAMP_ADDRESSMODE;case Cd.MIRRORED_REPEAT:return U.MIRROR_ADDRESSMODE;default:return U.WRAP_ADDRESSMODE}}static GetByteStrideFromType(t){switch(t.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(t){switch(t){case vo.LINEAR:case vo.LINEAR_MIPMAP_NEAREST:case vo.LINEAR_MIPMAP_LINEAR:return U.TRILINEAR_SAMPLINGMODE;case vo.NEAREST:case vo.NEAREST_MIPMAP_NEAREST:return U.NEAREST_SAMPLINGMODE;default:return U.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(t,i,s,n,o){const a=t.loadedBufferViews[i.buffer];if((s=i.byteOffset+s)+n>a.byteLength)throw new Error("Buffer access is out of range");const l=a.buffer;switch(s+=a.byteOffset,o){case xl.BYTE:return new Int8Array(l,s,n);case xl.UNSIGNED_BYTE:return new Uint8Array(l,s,n);case xl.SHORT:return new Int16Array(l,s,n);case xl.UNSIGNED_SHORT:return new Uint16Array(l,s,n);default:return new Float32Array(l,s,n)}}static GetBufferFromAccessor(t,i){const s=t.bufferViews[i.bufferView],n=i.count*r.GetByteStrideFromType(i);return r.GetBufferFromBufferView(t,s,i.byteOffset,n,i.componentType)}static DecodeBufferToText(t){let i="";const s=t.byteLength;for(let n=0;n<s;++n)i+=String.fromCharCode(t[n]);return i}static GetDefaultMaterial(t){if(!r._DefaultMaterial){Ot.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join("\n"),Ot.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join("\n");const i={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},s={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};r._DefaultMaterial=new mn("GLTFDefaultMaterial",t,i,s),r._DefaultMaterial.setColor4("u_emission",new Te(.5,.5,.5,1))}return r._DefaultMaterial}}return r._DefaultMaterial=null,r})();var Tl=(()=>{return(r=Tl||(Tl={}))[r.IDENTIFIER=1]="IDENTIFIER",r[r.UNKNOWN=2]="UNKNOWN",r[r.END_OF_INPUT=3]="END_OF_INPUT",Tl;var r})();class HW{constructor(e){this._pos=0,this.currentToken=Tl.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return Tl.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=Tl.UNKNOWN,"_"===this.currentString||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=Tl.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||"_"===this.currentString);)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}}const WW=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],XW=["world","view","projection","worldView","worldViewProjection","mBones"],Ace=["translation","rotation","scale"],Rce=["position","rotationQuaternion","scaling"],Lr=(r,e,t)=>{for(const i in r)t[e][i]=r[i]},Pce=r=>{if(r)for(let e=0;e<r.length/2;e++)r[2*e+1]=1-r[2*e+1]},jW=r=>{if("NORMAL"===r.semantic)return"normal";if("POSITION"===r.semantic)return"position";if("JOINT"===r.semantic)return"matricesIndices";if("WEIGHT"===r.semantic)return"matricesWeights";if("COLOR"===r.semantic)return"color";if(r.semantic&&-1!==r.semantic.indexOf("TEXCOORD_")){const e=Number(r.semantic.split("_")[1]);return"uv"+(0===e?"":e+1)}return null},C0=r=>{let e=null;if(r.translation||r.rotation||r.scale){const t=v.FromArray(r.scale||[1,1,1]),i=Z.FromArray(r.rotation||[0,0,0,1]),s=v.FromArray(r.translation||[0,0,0]);e=F.Compose(t,i,s)}else e=F.FromArray(r.matrix);return e},YW=(r,e,t,i)=>{for(let n=0;n<i.bones.length;n++)if(i.bones[n].name===t)return i.bones[n];const s=r.nodes;for(const n in s){const o=s[n];if(!o.jointName)continue;const a=o.children;for(let l=0;l<a.length;l++){const c=r.nodes[a[l]];if(c.jointName&&c.jointName===t){const h=C0(o),u=new Ht(o.name||"",i,YW(r,e,o.jointName,i),h);return u.id=n,u}}}return null},wce=(r,e)=>{for(let t=0;t<r.length;t++){const i=r[t];for(let s=0;s<i.node.children.length;s++)if(i.node.children[s]===e)return i.bone}return null},A0=(r,e)=>{const t=r.nodes;let i=t[e];if(i)return{node:i,id:e};for(const s in t)if(i=t[s],i.jointName===e)return{node:i,id:s};return null},Oce=(r,e)=>{for(let t=0;t<r.jointNames.length;t++)if(r.jointNames[t]===e)return!0;return!1},qW=(r,e,t,i,s)=>{if(s||(r.scene._blockEntityCollection=!!r.assetContainer,(s=new G(e.name||"",r.scene))._parentContainer=r.assetContainer,r.scene._blockEntityCollection=!1,s.id=i),!e.babylonNode)return s;const n=[];let o=null;const a=new Array,l=new Array,c=new Array,h=new Array;for(let f=0;f<t.length;f++){const _=r.meshes[t[f]];if(_)for(let m=0;m<_.primitives.length;m++){const g=new ue,b=_.primitives[m],y=b.attributes;let T=null,x=null;for(const C in y)if(T=r.accessors[y[C]],x=Sn.GetBufferFromAccessor(r,T),"NORMAL"===C)g.normals=new Float32Array(x.length),g.normals.set(x);else if("POSITION"===C){if(yc.HomogeneousCoordinates){g.positions=new Float32Array(x.length-x.length/4);for(let D=0;D<x.length;D+=4)g.positions[D]=x[D],g.positions[D+1]=x[D+1],g.positions[D+2]=x[D+2]}else g.positions=new Float32Array(x.length),g.positions.set(x);l.push(g.positions.length)}else if(-1!==C.indexOf("TEXCOORD_")){const D=Number(C.split("_")[1]),P=A.UVKind+(0===D?"":D+1),M=new Float32Array(x.length);M.set(x),Pce(M),g.set(M,P)}else"JOINT"===C?(g.matricesIndices=new Float32Array(x.length),g.matricesIndices.set(x)):"WEIGHT"===C?(g.matricesWeights=new Float32Array(x.length),g.matricesWeights.set(x)):"COLOR"===C&&(g.colors=new Float32Array(x.length),g.colors.set(x));if(T=r.accessors[b.indices],T)x=Sn.GetBufferFromAccessor(r,T),g.indices=new Int32Array(x.length),g.indices.set(x),h.push(g.indices.length);else{const C=[];for(let D=0;D<g.positions.length/3;D++)C.push(D);g.indices=new Int32Array(C),h.push(g.indices.length)}o?o.merge(g):o=g;const S=r.scene.getMaterialById(b.material);n.push(null===S?Sn.GetDefaultMaterial(r.scene):S),a.push(0===a.length?0:a[a.length-1]+l[l.length-2]),c.push(0===c.length?0:c[c.length-1]+h[h.length-2])}}let u;r.scene._blockEntityCollection=!!r.assetContainer,n.length>1?(u=new el("multimat"+i,r.scene),u.subMaterials=n):u=new fe("multimat"+i,r.scene),1===n.length&&(u=n[0]),u._parentContainer=r.assetContainer,s.material||(s.material=u),new rr(i,r.scene,o,!1,s),s.computeWorldMatrix(!0),r.scene._blockEntityCollection=!1,s.subMeshes=[];let d=0;for(let f=0;f<t.length;f++){const _=r.meshes[t[f]];if(_)for(let m=0;m<_.primitives.length;m++)fr.AddToMesh(d,a[d],l[d],c[d],h[d],s,s,!0),d++}return s},R0=(r,e,t,i)=>{r.position&&(r.position=e),(r.rotationQuaternion||r.rotation)&&(r.rotationQuaternion=t),r.scaling&&(r.scaling=i)},Bce=(r,e,t)=>{let i=null;if(r.importOnlyMeshes&&(e.skin||e.meshes)&&r.importMeshesNames&&r.importMeshesNames.length>0&&-1===r.importMeshesNames.indexOf(e.name||""))return null;if(e.skin){if(e.meshes){const s=r.skins[e.skin],n=qW(r,e,e.meshes,t,e.babylonNode);n.skeleton=r.scene.getLastSkeletonById(e.skin),null===n.skeleton&&(n.skeleton=((r,e,t,i)=>{if(i||(i=new Jl(e.name||"","",r.scene)),!e.babylonSkeleton)return i;const s=[],n=[];((r,e,t,i)=>{for(const s in r.nodes){const n=r.nodes[s],o=s;if(!n.jointName||Oce(t,n.jointName))continue;const a=C0(n),l=new Ht(n.name||"",e,null,a);l.id=o,i.push({bone:l,node:n,id:o})}for(let s=0;s<i.length;s++){const n=i[s],o=n.node.children;for(let a=0;a<o.length;a++){let l=null;for(let c=0;c<i.length;c++)if(i[c].id===o[a]){l=i[c];break}l&&(l.bone._parent=n.bone,n.bone.children.push(l.bone))}}})(r,i,e,s),i.bones=[];for(let a=0;a<e.jointNames.length;a++){const l=A0(r,e.jointNames[a]);if(!l)continue;const c=l.node;if(!c){q.Warn("Joint named "+e.jointNames[a]+" does not exist");continue}const h=l.id,u=r.scene.getBoneById(h);if(u){i.bones.push(u);continue}let d=!1,f=null;for(let m=0;m<a;m++){const g=A0(r,e.jointNames[m]);if(!g)continue;const b=g.node;if(!b){q.Warn("Joint named "+e.jointNames[m]+" does not exist when looking for parent");continue}const y=b.children;if(y){d=!1;for(let T=0;T<y.length;T++)if(y[T]===h){f=YW(r,e,e.jointNames[m],i),d=!0;break}if(d)break}}const p=C0(c);!f&&s.length>0&&(f=wce(s,h),f&&-1===n.indexOf(f)&&n.push(f)),new Ht(c.jointName||"",i,f,p).id=h}const o=i.bones;i.bones=[];for(let a=0;a<e.jointNames.length;a++){const l=A0(r,e.jointNames[a]);if(l)for(let c=0;c<o.length;c++)if(o[c].id===l.id){i.bones.push(o[c]);break}}i.prepare();for(let a=0;a<n.length;a++)i.bones.push(n[a]);return i})(r,s,0,s.babylonSkeleton),s.babylonSkeleton||(s.babylonSkeleton=n.skeleton)),i=n}}else if(e.meshes)i=qW(r,e,e.mesh?[e.mesh]:e.meshes,t,e.babylonNode);else if(!e.light||e.babylonNode||r.importOnlyMeshes){if(e.camera&&!e.babylonNode&&!r.importOnlyMeshes){const s=r.cameras[e.camera];if(s){if(r.scene._blockEntityCollection=!!r.assetContainer,"orthographic"===s.type){const n=new lr(e.camera,v.Zero(),r.scene,!1);n.name=e.name||"",n.mode=ve.ORTHOGRAPHIC_CAMERA,n.attachControl(),i=n,n._parentContainer=r.assetContainer}else if("perspective"===s.type){const n=s[s.type],o=new lr(e.camera,v.Zero(),r.scene,!1);o.name=e.name||"",o.attachControl(),n.aspectRatio||(n.aspectRatio=r.scene.getEngine().getRenderWidth()/r.scene.getEngine().getRenderHeight()),n.znear&&n.zfar&&(o.maxZ=n.zfar,o.minZ=n.znear),i=o,o._parentContainer=r.assetContainer}r.scene._blockEntityCollection=!1}}}else{const s=r.lights[e.light];if(s)if("ambient"===s.type){const n=s[s.type],o=new jn(e.light,v.Zero(),r.scene);o.name=e.name||"",n.color&&(o.diffuse=re.FromArray(n.color)),i=o}else if("directional"===s.type){const n=s[s.type],o=new qn(e.light,v.Zero(),r.scene);o.name=e.name||"",n.color&&(o.diffuse=re.FromArray(n.color)),i=o}else if("point"===s.type){const n=s[s.type],o=new od(e.light,v.Zero(),r.scene);o.name=e.name||"",n.color&&(o.diffuse=re.FromArray(n.color)),i=o}else if("spot"===s.type){const n=s[s.type],o=new rn(e.light,v.Zero(),v.Zero(),0,0,r.scene);o.name=e.name||"",n.color&&(o.diffuse=re.FromArray(n.color)),n.fallOfAngle&&(o.angle=n.fallOfAngle),n.fallOffExponent&&(o.exponent=n.fallOffExponent),i=o}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(null===i){r.scene._blockEntityCollection=!!r.assetContainer;const s=new G(e.name||"",r.scene);s._parentContainer=r.assetContainer,r.scene._blockEntityCollection=!1,e.babylonNode=s,i=s}}if(null!==i){if(e.matrix&&i instanceof G)((r,e)=>{if(e.matrix){const t=new v(0,0,0),i=new Z,s=new v(0,0,0);F.FromArray(e.matrix).decompose(s,i,t),R0(r,t,i,s)}else e.translation&&e.rotation&&e.scale&&R0(r,v.FromArray(e.translation),Z.FromArray(e.rotation),v.FromArray(e.scale));r.computeWorldMatrix(!0)})(i,e);else{const n=e.rotation||[0,0,0,1],o=e.scale||[1,1,1];R0(i,v.FromArray(e.translation||[0,0,0]),Z.FromArray(n),v.FromArray(o))}i.updateCache(!0),e.babylonNode=i}return i},m_=(r,e,t,i=!1)=>{const s=r.nodes[e];let n=null;if(i=!(r.importOnlyMeshes&&!i&&r.importMeshesNames)||-1!==r.importMeshesNames.indexOf(s.name||"")||0===r.importMeshesNames.length,!s.jointName&&i&&(n=Bce(r,s,e),null!==n&&(n.id=e,n.parent=t)),s.children)for(let o=0;o<s.children.length;o++)m_(r,s.children[o],n,i)},$W=r=>{let e=r.currentScene;if(e)for(let t=0;t<e.nodes.length;t++)m_(r,e.nodes[t],null);else for(const t in r.scenes){e=r.scenes[t];for(let i=0;i<e.nodes.length;i++)m_(r,e.nodes[i],null)}(r=>{for(const e in r.animations){const t=r.animations[e];if(!t.channels||!t.samplers)continue;let i=null;for(let s=0;s<t.channels.length;s++){const n=t.channels[s],o=t.samplers[n.sampler];if(!o)continue;let a=null,l=null;t.parameters?(a=t.parameters[o.input],l=t.parameters[o.output]):(a=o.input,l=o.output);const c=Sn.GetBufferFromAccessor(r,r.accessors[a]),h=Sn.GetBufferFromAccessor(r,r.accessors[l]),u=n.target.id;let d=r.scene.getNodeById(u);if(null===d&&(d=r.scene.getNodeByName(u)),null===d){q.Warn("Creating animation named "+e+". But cannot find node named "+u+" to attach to");continue}const f=d instanceof Ht;let p=n.target.path;const _=Ace.indexOf(p);-1!==_&&(p=Rce[_]);let m=$.ANIMATIONTYPE_MATRIX;f||("rotationQuaternion"===p?(m=$.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new Z):m=$.ANIMATIONTYPE_VECTOR3);let g=null;const b=[];let y=0,T=!1;f&&i&&i.getKeys().length===c.length&&(g=i,T=!0),T||(r.scene._blockEntityCollection=!!r.assetContainer,g=new $(e,f?"_matrix":p,1,m,$.ANIMATIONLOOPMODE_CYCLE),r.scene._blockEntityCollection=!1);for(let x=0;x<c.length;x++){let S=null;if("rotationQuaternion"===p?(S=Z.FromArray([h[y],h[y+1],h[y+2],h[y+3]]),y+=4):(S=v.FromArray([h[y],h[y+1],h[y+2]]),y+=3),f){const C=d;let D=v.Zero(),P=new Z,M=v.Zero(),w=C.getBaseMatrix();T&&i&&(w=i.getKeys()[x].value),w.decompose(M,P,D),"position"===p?D=S:"rotationQuaternion"===p?P=S:M=S,S=F.Compose(M,P,D)}T?i&&(i.getKeys()[x].value=S):b.push({frame:c[x],value:S})}!T&&g&&(g.setKeys(b),d.animations.push(g)),i=g,r.scene.stopAnimation(d),r.scene.beginAnimation(d,0,c[c.length-1],!0,1)}}})(r);for(let t=0;t<r.scene.skeletons.length;t++)r.scene.beginAnimation(r.scene.skeletons[t],0,Number.MAX_VALUE,!0,1)},KW=(r,e,t)=>{for(const i in e.uniforms){const n=e.parameters[e.uniforms[i]];if(r.currentIdentifier===i&&n.semantic&&!n.source&&!n.node){const o=WW.indexOf(n.semantic);if(-1!==o)return delete t[i],XW[o]}}return r.currentIdentifier},QW=r=>{for(const e in r.materials)hr.LoadMaterialAsync(r,e,()=>{},()=>{})};class Sl{static CreateRuntime(e,t,i){const s={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:i,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&Lr(e.extensions,"extensions",s),e.extensionsUsed&&Lr(e.extensionsUsed,"extensionsUsed",s),e.buffers&&((r,e)=>{for(const t in r)e.buffers[t]=r[t],e.buffersCount++})(e.buffers,s),e.bufferViews&&Lr(e.bufferViews,"bufferViews",s),e.accessors&&Lr(e.accessors,"accessors",s),e.meshes&&Lr(e.meshes,"meshes",s),e.lights&&Lr(e.lights,"lights",s),e.cameras&&Lr(e.cameras,"cameras",s),e.nodes&&Lr(e.nodes,"nodes",s),e.images&&Lr(e.images,"images",s),e.textures&&Lr(e.textures,"textures",s),e.shaders&&((r,e)=>{for(const t in r)e.shaders[t]=r[t],e.shaderscount++})(e.shaders,s),e.programs&&Lr(e.programs,"programs",s),e.samplers&&Lr(e.samplers,"samplers",s),e.techniques&&Lr(e.techniques,"techniques",s),e.materials&&Lr(e.materials,"materials",s),e.animations&&Lr(e.animations,"animations",s),e.skins&&Lr(e.skins,"skins",s),e.scenes&&(s.scenes=e.scenes),e.scene&&e.scenes&&(s.currentScene=e.scenes[e.scene]),s}static LoadBufferAsync(e,t,i,s,n){const o=e.buffers[t];q.IsBase64(o.uri)?setTimeout(()=>i(new Uint8Array(q.DecodeBase64(o.uri)))):q.LoadFile(e.rootUrl+o.uri,a=>i(new Uint8Array(a)),n,void 0,!0,a=>{a&&s(a.status+" "+a.statusText)})}static LoadTextureBufferAsync(e,t,i,s){const n=e.textures[t];if(!n||!n.source)return void s("");if(n.babylonTexture)return void i(null);const o=e.images[n.source];q.IsBase64(o.uri)?setTimeout(()=>i(new Uint8Array(q.DecodeBase64(o.uri)))):q.LoadFile(e.rootUrl+o.uri,a=>i(new Uint8Array(a)),void 0,void 0,!0,a=>{a&&s(a.status+" "+a.statusText)})}static CreateTextureAsync(e,t,i,s){const n=e.textures[t];if(n.babylonTexture)return void s(n.babylonTexture);const o=e.samplers[n.sampler],a=o.minFilter===vo.NEAREST_MIPMAP_NEAREST||o.minFilter===vo.NEAREST_MIPMAP_LINEAR||o.minFilter===vo.LINEAR_MIPMAP_NEAREST||o.minFilter===vo.LINEAR_MIPMAP_LINEAR,l=U.BILINEAR_SAMPLINGMODE,c=null==i?new Blob:new Blob([i]),h=URL.createObjectURL(c),u=()=>URL.revokeObjectURL(h),d=new U(h,e.scene,!a,!0,l,u,u);void 0!==o.wrapS&&(d.wrapU=Sn.GetWrapMode(o.wrapS)),void 0!==o.wrapT&&(d.wrapV=Sn.GetWrapMode(o.wrapT)),d.name=t,n.babylonTexture=d,s(d)}static LoadShaderStringAsync(e,t,i,s){const n=e.shaders[t];if(q.IsBase64(n.uri)){const o=atob(n.uri.split(",")[1]);i&&i(o)}else q.LoadFile(e.rootUrl+n.uri,i,void 0,void 0,!1,o=>{o&&s&&s(o.status+" "+o.statusText)})}static LoadMaterialAsync(e,t,i,s){const n=e.materials[t];if(!n.technique)return void(s&&s("No technique found."));const o=e.techniques[n.technique];if(!o){e.scene._blockEntityCollection=!!e.assetContainer;const S=new fe(t,e.scene);return S._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,S.diffuseColor=new re(.5,.5,.5),S.sideOrientation=ie.CounterClockWiseSideOrientation,void i(S)}const a=e.programs[o.program],l=o.states,h=Ot.ShadersStore[a.fragmentShader+"PixelShader"];let u="",d="";const f=new HW(Ot.ShadersStore[a.vertexShader+"VertexShader"]),p=new HW(h),_={},m=[],g=[],b=[];for(const S in o.uniforms){const D=o.parameters[o.uniforms[S]];if(_[S]=D,!D.semantic||D.node||D.source)D.type===Fr.SAMPLER_2D?b.push(S):m.push(S);else{const P=WW.indexOf(D.semantic);-1!==P?(m.push(XW[P]),delete _[S]):m.push(S)}}for(const S in o.attributes){const D=o.parameters[o.attributes[S]];if(D.semantic){const P=jW(D);P&&g.push(P)}}for(;!f.isEnd()&&f.getNextToken();){if(f.currentToken!==Tl.IDENTIFIER){u+=f.currentString;continue}let C=!1;for(const D in o.attributes){const M=o.parameters[o.attributes[D]];if(f.currentIdentifier===D&&M.semantic){u+=jW(M),C=!0;break}}C||(u+=KW(f,o,_))}for(;!p.isEnd()&&p.getNextToken();)d+=p.currentToken===Tl.IDENTIFIER?KW(p,o,_):p.currentString;const y={vertex:a.vertexShader+t,fragment:a.fragmentShader+t},T={attributes:g,uniforms:m,samplers:b,needAlphaBlending:l&&l.enable&&-1!==l.enable.indexOf(3042)};Ot.ShadersStore[a.vertexShader+t+"VertexShader"]=u,Ot.ShadersStore[a.fragmentShader+t+"PixelShader"]=d;const x=new mn(t,e.scene,y,T);if(x.onError=((r,e,t)=>(i,s)=>{e.dispose(!0),t("Cannot compile program named "+r.name+". Error: "+s+". Default material will be applied")})(a,x,s),x.onCompiled=((r,e,t,i,s,n)=>o=>{((r,e,t,i,s)=>{const n=i.values||t.parameters,o=t.uniforms;for(const a in s){const l=s[a],c=l.type;let h=n[o[a]];if(void 0===h&&(h=l.value),!h)continue;const u=d=>f=>{l.value&&d&&(e.setTexture(d,f),delete s[d])};c===Fr.SAMPLER_2D?hr.LoadTextureAsync(r,i.values?h:l.value,u(a),()=>u(null)):l.value&&Sn.SetUniform(e,a,i.values?h:l.value,c)&&delete s[a]}})(r,e,t,i,s),e.onBind=a=>{((r,e,t,i,s,n,o)=>{const a=n.values||s.parameters;for(const l in t){const c=t[l],h=c.type;if(h===Fr.FLOAT_MAT2||h===Fr.FLOAT_MAT3||h===Fr.FLOAT_MAT4)if(!c.semantic||c.source||c.node){if(c.semantic&&(c.source||c.node)){let u=e.scene.getNodeByName(c.source||c.node||"");if(null===u&&(u=e.scene.getNodeById(c.source||c.node||"")),null===u)continue;Sn.SetMatrix(e.scene,u,c,l,i.getEffect())}}else Sn.SetMatrix(e.scene,r,c,l,i.getEffect());else{const u=a[s.uniforms[l]];if(!u)continue;if(h===Fr.SAMPLER_2D){const d=e.textures[n.values?u:c.value].babylonTexture;if(null==d)continue;i.getEffect().setTexture(l,d)}else Sn.SetUniform(i.getEffect(),l,u,h)}}o(i)})(a,r,s,e,t,i,n)}})(e,x,o,n,_,i),x.sideOrientation=ie.CounterClockWiseSideOrientation,l&&l.functions){const S=l.functions;S.cullFace&&S.cullFace[0]!==Db.BACK&&(x.backFaceCulling=!1);const C=S.blendFuncSeparate;C&&(C[0]===Ni.SRC_ALPHA&&C[1]===Ni.ONE_MINUS_SRC_ALPHA&&C[2]===Ni.ONE&&C[3]===Ni.ONE?x.alphaMode=gh.ALPHA_COMBINE:C[0]===Ni.ONE&&C[1]===Ni.ONE&&C[2]===Ni.ZERO&&C[3]===Ni.ONE?x.alphaMode=gh.ALPHA_ONEONE:C[0]===Ni.SRC_ALPHA&&C[1]===Ni.ONE&&C[2]===Ni.ZERO&&C[3]===Ni.ONE?x.alphaMode=gh.ALPHA_ADD:C[0]===Ni.ZERO&&C[1]===Ni.ONE_MINUS_SRC_COLOR&&C[2]===Ni.ONE&&C[3]===Ni.ONE?x.alphaMode=gh.ALPHA_SUBTRACT:C[0]===Ni.DST_COLOR&&C[1]===Ni.ZERO&&C[2]===Ni.ONE&&C[3]===Ni.ONE?x.alphaMode=gh.ALPHA_MULTIPLY:C[0]===Ni.SRC_ALPHA&&C[1]===Ni.ONE_MINUS_SRC_COLOR&&C[2]===Ni.ONE&&C[3]===Ni.ONE&&(x.alphaMode=gh.ALPHA_MAXIMIZED))}}}let g_=(()=>{class r{static RegisterExtension(t){r.Extensions[t.name]?q.Error('Tool with the same name "'+t.name+'" already exists'):r.Extensions[t.name]=t}dispose(){}_importMeshAsync(t,i,s,n,o,a,l,c){return i.useRightHandedSystem=!0,hr.LoadRuntimeAsync(i,s,n,h=>{h.assetContainer=o,h.importOnlyMeshes=!0,""===t?h.importMeshesNames=[]:"string"==typeof t?h.importMeshesNames=[t]:!t||t instanceof Array?(h.importMeshesNames=[],q.Warn("Argument meshesNames must be of type string or string[]")):h.importMeshesNames=[t],this._createNodes(h);const u=new Array,d=new Array;for(const f in h.nodes){const p=h.nodes[f];p.babylonNode instanceof Zt&&u.push(p.babylonNode)}for(const f in h.skins){const p=h.skins[f];p.babylonSkeleton instanceof Jl&&d.push(p.babylonSkeleton)}this._loadBuffersAsync(h,()=>{this._loadShadersAsync(h,()=>{QW(h),$W(h),!yc.IncrementalLoading&&a&&a(u,d)})}),yc.IncrementalLoading&&a&&a(u,d)},c),!0}importMeshAsync(t,i,s,n,o,a){return new Promise((l,c)=>{this._importMeshAsync(t,i,n,o,s,(h,u)=>{l({meshes:h,particleSystems:[],skeletons:u,animationGroups:[],lights:[],transformNodes:[],geometries:[]})},a,h=>{c(new Error(h))})})}_loadAsync(t,i,s,n,o,a){t.useRightHandedSystem=!0,hr.LoadRuntimeAsync(t,i,s,l=>{hr.LoadRuntimeExtensionsAsync(l,()=>{this._createNodes(l),this._loadBuffersAsync(l,()=>{this._loadShadersAsync(l,()=>{QW(l),$W(l),yc.IncrementalLoading||n()})}),yc.IncrementalLoading&&n()},a)},a)}loadAsync(t,i,s,n){return new Promise((o,a)=>{this._loadAsync(t,i,s,()=>{o()},n,l=>{a(new Error(l))})})}_loadShadersAsync(t,i){let s=!1;const n=(o,a)=>{hr.LoadShaderStringAsync(t,o,l=>{l instanceof ArrayBuffer||(t.loadedShaderCount++,l&&(Ot.ShadersStore[o+(a.type===Pb.VERTEX?"VertexShader":"PixelShader")]=l),t.loadedShaderCount===t.shaderscount&&i())},()=>{q.Error("Error when loading shader program named "+o+" located at "+a.uri)})};for(const o in t.shaders){s=!0;const a=t.shaders[o];a?n.bind(this,o,a)():q.Error("No shader named: "+o)}s||i()}_loadBuffersAsync(t,i){let s=!1;const n=(o,a)=>{hr.LoadBufferAsync(t,o,l=>{t.loadedBufferCount++,l&&(l.byteLength!=t.buffers[o].byteLength&&q.Error("Buffer named "+o+" is length "+l.byteLength+". Expected: "+a.byteLength),t.loadedBufferViews[o]=l),t.loadedBufferCount===t.buffersCount&&i()},()=>{q.Error("Error when loading buffer named "+o+" located at "+a.uri)})};for(const o in t.buffers){s=!0;const a=t.buffers[o];a?n.bind(this,o,a)():q.Error("No buffer named: "+o)}s||i()}_createNodes(t){let i=t.currentScene;if(i)for(let s=0;s<i.nodes.length;s++)m_(t,i.nodes[s],null);else for(const s in t.scenes){i=t.scenes[s];for(let n=0;n<i.nodes.length;n++)m_(t,i.nodes[n],null)}}}return r.Extensions={},r})();class hr{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,i,s,n){return!1}loadRuntimeExtensionsAsync(e,t,i){return!1}loadBufferAsync(e,t,i,s,n){return!1}loadTextureBufferAsync(e,t,i,s){return!1}createTextureAsync(e,t,i,s,n){return!1}loadShaderStringAsync(e,t,i,s){return!1}loadMaterialAsync(e,t,i,s){return!1}static LoadRuntimeAsync(e,t,i,s,n){hr._ApplyExtensions(o=>o.loadRuntimeAsync(e,t,i,s,n),()=>{setTimeout(()=>{!s||s(Sl.CreateRuntime(t.json,e,i))})})}static LoadRuntimeExtensionsAsync(e,t,i){hr._ApplyExtensions(s=>s.loadRuntimeExtensionsAsync(e,t,i),()=>{setTimeout(()=>{t()})})}static LoadBufferAsync(e,t,i,s,n){hr._ApplyExtensions(o=>o.loadBufferAsync(e,t,i,s,n),()=>{Sl.LoadBufferAsync(e,t,i,s,n)})}static LoadTextureAsync(e,t,i,s){hr._LoadTextureBufferAsync(e,t,n=>{n&&hr._CreateTextureAsync(e,t,n,i,s)},s)}static LoadShaderStringAsync(e,t,i,s){hr._ApplyExtensions(n=>n.loadShaderStringAsync(e,t,i,s),()=>{Sl.LoadShaderStringAsync(e,t,i,s)})}static LoadMaterialAsync(e,t,i,s){hr._ApplyExtensions(n=>n.loadMaterialAsync(e,t,i,s),()=>{Sl.LoadMaterialAsync(e,t,i,s)})}static _LoadTextureBufferAsync(e,t,i,s){hr._ApplyExtensions(n=>n.loadTextureBufferAsync(e,t,i,s),()=>{Sl.LoadTextureBufferAsync(e,t,i,s)})}static _CreateTextureAsync(e,t,i,s,n){hr._ApplyExtensions(o=>o.createTextureAsync(e,t,i,s,n),()=>{Sl.CreateTextureAsync(e,t,i,s)})}static _ApplyExtensions(e,t){for(const i in g_.Extensions)if(e(g_.Extensions[i]))return;t()}}function ZW(r,e,t,i){return v.FromArray(e,t).scaleInPlace(i)}yc._CreateGLTF1Loader=()=>new g_,g_.RegisterExtension(new class Hce extends hr{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,i,s){const n=t.json.extensionsUsed;return!(!n||-1===n.indexOf(this.name)||!t.bin||(this._bin=t.bin,s(Sl.CreateRuntime(t.json,e,i)),0))}loadBufferAsync(e,t,i,s){return-1!==e.extensionsUsed.indexOf(this.name)&&"binary_glTF"===t&&(this._bin.readAsync(0,this._bin.byteLength).then(i,n=>s(n.message)),!0)}loadTextureBufferAsync(e,t,i){const n=e.images[e.textures[t].source];if(!n.extensions||!(this.name in n.extensions))return!1;const a=e.bufferViews[n.extensions[this.name].bufferView];return i(Sn.GetBufferFromBufferView(e,a,0,a.byteLength,xl.UNSIGNED_BYTE)),!0}loadShaderStringAsync(e,t,i){const s=e.shaders[t];if(!s.extensions||!(this.name in s.extensions))return!1;const o=e.bufferViews[s.extensions[this.name].bufferView],a=Sn.GetBufferFromBufferView(e,o,0,o.byteLength,xl.UNSIGNED_BYTE);return setTimeout(()=>{const l=Sn.DecodeBufferToText(a);i(l)}),!0}}),g_.RegisterExtension(new class Wce extends hr{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;const t=e.extensions[this.name];if(!t)return!1;const i=t.lights;if(i)for(const s in i){const n=i[s];switch(n.type){case"ambient":{const o=new jn(n.name,new v(0,1,0),e.scene),a=n.ambient;a&&(o.diffuse=re.FromArray(a.color||[1,1,1]));break}case"point":{const o=new od(n.name,new v(10,10,10),e.scene),a=n.point;a&&(o.diffuse=re.FromArray(a.color||[1,1,1]));break}case"directional":{const o=new qn(n.name,new v(0,-1,0),e.scene),a=n.directional;a&&(o.diffuse=re.FromArray(a.color||[1,1,1]));break}case"spot":{const o=n.spot;o&&(new rn(n.name,new v(0,10,0),new v(0,-1,0),o.fallOffAngle||Math.PI,o.fallOffExponent||0,e.scene).diffuse=re.FromArray(o.color||[1,1,1]));break}default:q.Warn('GLTF Material Common extension: light type "'+n.type+"\u201d not supported")}}return!1}loadMaterialAsync(e,t,i,s){const n=e.materials[t];if(!n||!n.extensions)return!1;const o=n.extensions[this.name];if(!o)return!1;const a=new fe(t,e.scene);return a.sideOrientation=ie.CounterClockWiseSideOrientation,"CONSTANT"===o.technique&&(a.disableLighting=!0),a.backFaceCulling=void 0!==o.doubleSided&&!o.doubleSided,a.alpha=void 0===o.values.transparency?1:o.values.transparency,a.specularPower=void 0===o.values.shininess?0:o.values.shininess,"string"==typeof o.values.ambient?this._loadTexture(e,o.values.ambient,a,"ambientTexture",s):a.ambientColor=re.FromArray(o.values.ambient||[0,0,0]),"string"==typeof o.values.diffuse?this._loadTexture(e,o.values.diffuse,a,"diffuseTexture",s):a.diffuseColor=re.FromArray(o.values.diffuse||[0,0,0]),"string"==typeof o.values.emission?this._loadTexture(e,o.values.emission,a,"emissiveTexture",s):a.emissiveColor=re.FromArray(o.values.emission||[0,0,0]),"string"==typeof o.values.specular?this._loadTexture(e,o.values.specular,a,"specularTexture",s):a.specularColor=re.FromArray(o.values.specular||[0,0,0]),!0}_loadTexture(e,t,i,s,n){Sl.LoadTextureBufferAsync(e,t,o=>{Sl.CreateTextureAsync(e,t,o,a=>i[s]=a)},n)}});class v_{constructor(e,t,i,s){this.type=e,this.name=t,this.getValue=i,this.getStride=s}_buildAnimation(e,t,i){const s=new $(e,this.name,t,this.type);return s.setKeys(i),s}}class I0 extends v_{buildAnimations(e,t,i,s,n){n(e._babylonTransformNode,this._buildAnimation(t,i,s))}}const b_={translation:[new I0($.ANIMATIONTYPE_VECTOR3,"position",ZW,()=>3)],rotation:[new I0($.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",function Xce(r,e,t,i){return Z.FromArray(e,t).scaleInPlace(i)},()=>4)],scale:[new I0($.ANIMATIONTYPE_VECTOR3,"scaling",ZW,()=>3)],weights:[new class Yce extends v_{buildAnimations(e,t,i,s,n){if(e._numMorphTargets)for(let o=0;o<e._numMorphTargets;o++){const a=new $(`${t}_${o}`,this.name,i,this.type);if(a.setKeys(s.map(l=>({frame:l.frame,inTangent:l.inTangent?l.inTangent[o]:void 0,value:l.value[o],outTangent:l.outTangent?l.outTangent[o]:void 0,interpolation:l.interpolation}))),e._primitiveBabylonMeshes)for(const l of e._primitiveBabylonMeshes)if(l.morphTargetManager){const c=l.morphTargetManager.getTarget(o),h=a.clone();c.animations.push(h),n(c,h)}}}}($.ANIMATIONTYPE_FLOAT,"influence",function jce(r,e,t,i){const s=new Array(r._numMorphTargets);for(let n=0;n<s.length;n++)s[n]=e[t++]*i;return s},r=>r._numMorphTargets)]};function JW(...r){const e=t=>t&&"object"==typeof t;return r.reduce((t,i)=>(Object.keys(i).forEach(s=>{const n=t[s],o=i[s];t[s]=Array.isArray(n)&&Array.isArray(o)?n.concat(...o):e(n)&&e(o)?JW(n,o):o}),t),{})}class Xe{static Get(e,t,i){if(!t||null==i||!t[i])throw new Error(`${e}: Failed to find index (${i})`);return t[i]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}let st=(()=>{class r{static RegisterExtension(t,i){r.UnregisterExtension(t)&&V.Warn(`Extension with the name '${t}' already exists`),r._RegisteredExtensions[t]={factory:i}}static UnregisterExtension(t){return!!r._RegisteredExtensions[t]&&(delete r._RegisteredExtensions[t],!0)}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}constructor(t){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=t}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(t=>t.dispose&&t.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(t,i,s,n,o,a,l=""){return Promise.resolve().then(()=>{this._babylonScene=i,this._assetContainer=s,this._loadData(n);let c=null;if(t){const h={};if(this._gltf.nodes)for(const d of this._gltf.nodes)d.name&&(h[d.name]=d.index);c=(t instanceof Array?t:[t]).map(d=>{const f=h[d];if(void 0===f)throw new Error(`Failed to find node '${d}'`);return f})}return this._loadAsync(o,l,c,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries()}))})}loadAsync(t,i,s,n,o=""){return Promise.resolve().then(()=>(this._babylonScene=t,this._loadData(i),this._loadAsync(s,o,null,()=>{})))}_loadAsync(t,i,s,n){return Promise.resolve().then(()=>{this._rootUrl=t,this._uniqueRootUrl=!t.startsWith("file:")&&i?t:`${t}${Date.now()}/`,this._fileName=i,this._loadExtensions(),this._checkExtensions();const o=`${an[an.LOADING]} => ${an[an.READY]}`,a=`${an[an.LOADING]} => ${an[an.COMPLETE]}`;this._parent._startPerformanceCounter(o),this._parent._startPerformanceCounter(a),this._parent._setState(an.LOADING),this._extensionsOnLoading();const l=new Array,c=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials)if(s)l.push(this.loadSceneAsync("/nodes",{nodes:s,index:-1}));else if(null!=this._gltf.scene||this._gltf.scenes&&this._gltf.scenes[0]){const u=Xe.Get("/scene",this._gltf.scenes,this._gltf.scene||0);l.push(this.loadSceneAsync(`/scenes/${u.index}`,u))}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let u=0;u<this._gltf.materials.length;++u)l.push(this._loadMaterialAsync("/materials/"+u,this._gltf.materials[u],null,ie.TriangleFillMode,()=>{}));return this._babylonScene.blockMaterialDirtyMechanism=c,this._parent.compileMaterials&&l.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&l.push(this._compileShadowGeneratorsAsync()),Promise.all(l).then(()=>(this._rootBabylonMesh&&this._rootBabylonMesh.setEnabled(!0),this._extensionsOnReady(),this._parent._setState(an.READY),this._startAnimations(),n())).then(u=>(this._parent._endPerformanceCounter(o),q.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(a),this._parent._setState(an.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},d=>{this._parent.onErrorObservable.notifyObservers(d),this._parent.onErrorObservable.clear(),this.dispose()})}),u))}).catch(o=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(o),this._parent.onErrorObservable.clear(),this.dispose()),o})}_loadData(t){if(this._gltf=t.json,this._setupData(),t.bin){const i=this._gltf.buffers;if(i&&i[0]&&!i[0].uri){const s=i[0];(s.byteLength<t.bin.byteLength-3||s.byteLength>t.bin.byteLength)&&V.Warn(`Binary buffer length (${s.byteLength}) from JSON does not match chunk length (${t.bin.byteLength})`),this._bin=t.bin}else V.Warn("Unexpected BIN chunk")}}_setupData(){if(Xe.Assign(this._gltf.accessors),Xe.Assign(this._gltf.animations),Xe.Assign(this._gltf.buffers),Xe.Assign(this._gltf.bufferViews),Xe.Assign(this._gltf.cameras),Xe.Assign(this._gltf.images),Xe.Assign(this._gltf.materials),Xe.Assign(this._gltf.meshes),Xe.Assign(this._gltf.nodes),Xe.Assign(this._gltf.samplers),Xe.Assign(this._gltf.scenes),Xe.Assign(this._gltf.skins),Xe.Assign(this._gltf.textures),this._gltf.nodes){const t={};for(const s of this._gltf.nodes)if(s.children)for(const n of s.children)t[n]=s.index;const i=this._createRootNode();for(const s of this._gltf.nodes){const n=t[s.index];s.parent=void 0===n?i:this._gltf.nodes[n]}}}_loadExtensions(){for(const t in r._RegisteredExtensions){const i=r._RegisteredExtensions[t].factory(this);i.name!==t&&V.Warn(`The name of the glTF loader extension instance does not match the registered name: ${i.name} !== ${t}`),this._extensions.push(i),this._parent.onExtensionLoadedObservable.notifyObservers(i)}this._extensions.sort((t,i)=>(t.order||Number.MAX_VALUE)-(i.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear()}_checkExtensions(){if(this._gltf.extensionsRequired)for(const t of this._gltf.extensionsRequired)if(!this._extensions.some(s=>s.name===t&&s.enabled))throw new Error(`Require extension ${t} is not available`)}_createRootNode(){this._babylonScene._blockEntityCollection=!!this._assetContainer,this._rootBabylonMesh=new G("__root__",this._babylonScene),this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const t={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case Ed.AUTO:this._babylonScene.useRightHandedSystem||(t.rotation=[0,1,0,0],t.scale=[1,1,-1],r._LoadTransform(t,this._rootBabylonMesh));break;case Ed.FORCE_RIGHT_HANDED:this._babylonScene.useRightHandedSystem=!0;break;default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),t}loadSceneAsync(t,i){const s=this._extensionsLoadSceneAsync(t,i);if(s)return s;const n=new Array;if(this.logOpen(`${t} ${i.name||""}`),i.nodes)for(const o of i.nodes){const a=Xe.Get(`${t}/nodes/${o}`,this._gltf.nodes,o);n.push(this.loadNodeAsync(`/nodes/${a.index}`,a,l=>{l.parent=this._rootBabylonMesh}))}for(const o of this._postSceneLoadActions)o();return n.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(n).then(()=>{})}_forEachPrimitive(t,i){if(t._primitiveBabylonMeshes)for(const s of t._primitiveBabylonMeshes)i(s)}_getGeometries(){const t=new Array,i=this._gltf.nodes;if(i)for(const s of i)this._forEachPrimitive(s,n=>{const o=n.geometry;o&&-1===t.indexOf(o)&&t.push(o)});return t}_getMeshes(){const t=new Array;this._rootBabylonMesh&&t.push(this._rootBabylonMesh);const i=this._gltf.nodes;if(i)for(const s of i)this._forEachPrimitive(s,n=>{t.push(n)});return t}_getTransformNodes(){const t=new Array,i=this._gltf.nodes;if(i)for(const s of i)s._babylonTransformNode&&"TransformNode"===s._babylonTransformNode.getClassName()&&t.push(s._babylonTransformNode),s._babylonTransformNodeForSkin&&t.push(s._babylonTransformNodeForSkin);return t}_getSkeletons(){const t=new Array,i=this._gltf.skins;if(i)for(const s of i)s._data&&t.push(s._data.babylonSkeleton);return t}_getAnimationGroups(){const t=new Array,i=this._gltf.animations;if(i)for(const s of i)s._babylonAnimationGroup&&t.push(s._babylonAnimationGroup);return t}_startAnimations(){switch(this._parent.animationStartMode){case Lh.NONE:break;case Lh.FIRST:{const t=this._getAnimationGroups();0!==t.length&&t[0].start(!0);break}case Lh.ALL:{const t=this._getAnimationGroups();for(const i of t)i.start(!0);break}default:return void V.Error(`Invalid animation start mode (${this._parent.animationStartMode})`)}}loadNodeAsync(t,i,s=(()=>{})){const n=this._extensionsLoadNodeAsync(t,i,s);if(n)return n;if(i._babylonTransformNode)throw new Error(`${t}: Invalid recursive node hierarchy`);const o=new Array;this.logOpen(`${t} ${i.name||""}`);const a=l=>{if(r.AddPointerMetadata(l,t),r._LoadTransform(i,l),null!=i.camera){const c=Xe.Get(`${t}/camera`,this._gltf.cameras,i.camera);o.push(this.loadCameraAsync(`/cameras/${c.index}`,c,h=>{h.parent=l}))}if(i.children)for(const c of i.children){const h=Xe.Get(`${t}/children/${c}`,this._gltf.nodes,c);o.push(this.loadNodeAsync(`/nodes/${h.index}`,h,u=>{u.parent=l}))}s(l)};if(null==i.mesh||null!=i.skin){const l=i.name||`node${i.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const c=new We(l,this._babylonScene);c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,null==i.mesh?i._babylonTransformNode=c:i._babylonTransformNodeForSkin=c,a(c)}if(null!=i.mesh)if(null==i.skin){const l=Xe.Get(`${t}/mesh`,this._gltf.meshes,i.mesh);o.push(this._loadMeshAsync(`/meshes/${l.index}`,i,l,a))}else{const l=Xe.Get(`${t}/mesh`,this._gltf.meshes,i.mesh);o.push(this._loadMeshAsync(`/meshes/${l.index}`,i,l,c=>{const h=i._babylonTransformNodeForSkin;c.metadata=JW(h.metadata,c.metadata||{});const u=Xe.Get(`${t}/skin`,this._gltf.skins,i.skin);o.push(this._loadSkinAsync(`/skins/${u.index}`,i,u,d=>{this._forEachPrimitive(i,f=>{f.skeleton=d}),this._postSceneLoadActions.push(()=>{if(null!=u.skeleton){const f=Xe.Get(`/skins/${u.index}/skeleton`,this._gltf.nodes,u.skeleton).parent;c.parent=i.index===f.index?h.parent:f._babylonTransformNode}else c.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:h,skinnedNode:c})})}))}))}return this.logClose(),Promise.all(o).then(()=>(this._forEachPrimitive(i,l=>{l.geometry&&l.geometry.useBoundingInfoFromGeometry?l._updateBoundingInfo():l.refreshBoundingInfo(!0)}),i._babylonTransformNode))}_loadMeshAsync(t,i,s,n){const o=s.primitives;if(!o||!o.length)throw new Error(`${t}: Primitives are missing`);null==o[0].index&&Xe.Assign(o);const a=new Array;this.logOpen(`${t} ${s.name||""}`);const l=i.name||`node${i.index}`;if(1===o.length){const c=s.primitives[0];a.push(this._loadMeshPrimitiveAsync(`${t}/primitives/${c.index}`,l,i,s,c,h=>{i._babylonTransformNode=h,i._primitiveBabylonMeshes=[h]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,i._babylonTransformNode=new We(l,this._babylonScene),i._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i._primitiveBabylonMeshes=[];for(const c of o)a.push(this._loadMeshPrimitiveAsync(`${t}/primitives/${c.index}`,`${l}_primitive${c.index}`,i,s,c,h=>{h.parent=i._babylonTransformNode,i._primitiveBabylonMeshes.push(h)}))}return n(i._babylonTransformNode),this.logClose(),Promise.all(a).then(()=>i._babylonTransformNode)}_loadMeshPrimitiveAsync(t,i,s,n,o,a){const l=this._extensionsLoadMeshPrimitiveAsync(t,i,s,n,o,a);if(l)return l;this.logOpen(`${t}`);const c=0===this._disableInstancedMesh&&this._parent.createInstances&&null==s.skin&&!n.primitives[0].targets;let h,u;if(c&&o._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,h=o._instanceData.babylonSourceMesh.createInstance(i),h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,u=o._instanceData.promise;else{const d=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const f=new G(i,this._babylonScene);f._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,f.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?ie.CounterClockWiseSideOrientation:ie.ClockWiseSideOrientation,this._createMorphTargets(t,s,n,o,f),d.push(this._loadVertexDataAsync(t,o,f).then(_=>this._loadMorphTargetsAsync(t,o,f,_).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,_.applyToMesh(f),_._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})));const p=r._GetDrawMode(t,o.mode);if(null==o.material){let _=this._defaultBabylonMaterialData[p];_||(_=this._createDefaultMaterial("__GLTFLoader._default",p),this._parent.onMaterialLoadedObservable.notifyObservers(_),this._defaultBabylonMaterialData[p]=_),f.material=_}else if(!this.parent.skipMaterials){const _=Xe.Get(`${t}/material`,this._gltf.materials,o.material);d.push(this._loadMaterialAsync(`/materials/${_.index}`,_,f,p,m=>{f.material=m}))}u=Promise.all(d),c&&(o._instanceData={babylonSourceMesh:f,promise:u}),h=f}return r.AddPointerMetadata(h,t),this._parent.onMeshLoadedObservable.notifyObservers(h),a(h),this.logClose(),u.then(()=>h)}_loadVertexDataAsync(t,i,s){const n=this._extensionsLoadVertexDataAsync(t,i,s);if(n)return n;const o=i.attributes;if(!o)throw new Error(`${t}: Attributes are missing`);const a=new Array,l=new rr(s.name,this._babylonScene);if(null==i.indices)s.isUnIndexed=!0;else{const h=Xe.Get(`${t}/indices`,this._gltf.accessors,i.indices);a.push(this._loadIndicesAccessorAsync(`/accessors/${h.index}`,h).then(u=>{l.setIndices(u)}))}const c=(h,u,d)=>{if(null==o[h])return;s._delayInfo=s._delayInfo||[],-1===s._delayInfo.indexOf(u)&&s._delayInfo.push(u);const f=Xe.Get(`${t}/attributes/${h}`,this._gltf.accessors,o[h]);a.push(this._loadVertexAccessorAsync(`/accessors/${f.index}`,f,u).then(p=>{if(p.getKind()===A.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!s.skeleton){const _=f.min,m=f.max;if(void 0!==_&&void 0!==m){if(f.normalized&&5126!==f.componentType){let y=1;switch(f.componentType){case 5120:y=127;break;case 5121:y=255;break;case 5122:y=32767;break;case 5123:y=65535}for(let T=0;T<3;++T)_[T]=Math.max(_[T]/y,-1),m[T]=Math.max(m[T]/y,-1)}const g=L.Vector3[0],b=L.Vector3[1];g.copyFromFloats(..._),b.copyFromFloats(...m),l._boundingInfo=new pn(g,b),l.useBoundingInfoFromGeometry=!0}}l.setVerticesBuffer(p,f.count)})),u==A.MatricesIndicesExtraKind&&(s.numBoneInfluencers=8),d&&d(f)};return c("POSITION",A.PositionKind),c("NORMAL",A.NormalKind),c("TANGENT",A.TangentKind),c("TEXCOORD_0",A.UVKind),c("TEXCOORD_1",A.UV2Kind),c("TEXCOORD_2",A.UV3Kind),c("TEXCOORD_3",A.UV4Kind),c("TEXCOORD_4",A.UV5Kind),c("TEXCOORD_5",A.UV6Kind),c("JOINTS_0",A.MatricesIndicesKind),c("WEIGHTS_0",A.MatricesWeightsKind),c("JOINTS_1",A.MatricesIndicesExtraKind),c("WEIGHTS_1",A.MatricesWeightsExtraKind),c("COLOR_0",A.ColorKind,h=>{"VEC4"===h.type&&(s.hasVertexAlpha=!0)}),Promise.all(a).then(()=>l)}_createMorphTargets(t,i,s,n,o){if(!n.targets)return;if(null==i._numMorphTargets)i._numMorphTargets=n.targets.length;else if(n.targets.length!==i._numMorphTargets)throw new Error(`${t}: Primitives do not have the same number of targets`);const a=s.extras?s.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,o.morphTargetManager=new BC(this._babylonScene),o.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,o.morphTargetManager.areUpdatesFrozen=!0;for(let l=0;l<n.targets.length;l++)o.morphTargetManager.addTarget(new Ch(a?a[l]:`morphTarget${l}`,i.weights?i.weights[l]:s.weights?s.weights[l]:0,o.getScene()))}_loadMorphTargetsAsync(t,i,s,n){if(!i.targets)return Promise.resolve();const o=new Array,a=s.morphTargetManager;for(let l=0;l<a.numTargets;l++){const c=a.getTarget(l);o.push(this._loadMorphTargetVertexDataAsync(`${t}/targets/${l}`,n,i.targets[l],c))}return Promise.all(o).then(()=>{a.areUpdatesFrozen=!1})}_loadMorphTargetVertexDataAsync(t,i,s,n){const o=new Array,a=(l,c,h)=>{if(null==s[l])return;const u=i.getVertexBuffer(c);if(!u)return;const d=Xe.Get(`${t}/${l}`,this._gltf.accessors,s[l]);o.push(this._loadFloatAccessorAsync(`/accessors/${d.index}`,d).then(f=>{h(u,f)}))};return a("POSITION",A.PositionKind,(l,c)=>{const h=new Float32Array(c.length);l.forEach(c.length,(u,d)=>{h[d]=c[d]+u}),n.setPositions(h)}),a("NORMAL",A.NormalKind,(l,c)=>{const h=new Float32Array(c.length);l.forEach(h.length,(u,d)=>{h[d]=c[d]+u}),n.setNormals(h)}),a("TANGENT",A.TangentKind,(l,c)=>{const h=new Float32Array(c.length/3*4);let u=0;l.forEach(c.length/3*4,(d,f)=>{(f+1)%4!=0&&(h[u]=c[u]+d,u++)}),n.setTangents(h)}),Promise.all(o).then(()=>{})}static _LoadTransform(t,i){if(null!=t.skin)return;let s=v.Zero(),n=Z.Identity(),o=v.One();t.matrix?F.FromArray(t.matrix).decompose(o,n,s):(t.translation&&(s=v.FromArray(t.translation)),t.rotation&&(n=Z.FromArray(t.rotation)),t.scale&&(o=v.FromArray(t.scale))),i.position=s,i.rotationQuaternion=n,i.scaling=o}_loadSkinAsync(t,i,s,n){const o=this._extensionsLoadSkinAsync(t,i,s);if(o)return o;if(s._data)return n(s._data.babylonSkeleton),s._data.promise;const a=`skeleton${s.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const l=new Jl(s.name||a,a,this._babylonScene);l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(t,s,l);const c=this._loadSkinInverseBindMatricesDataAsync(t,s).then(h=>{this._updateBoneMatrices(l,h)});return s._data={babylonSkeleton:l,promise:c},n(l),c}_loadBones(t,i,s){if(null==i.skeleton||this._parent.alwaysComputeSkeletonRootNode){const o=this._findSkeletonRootNode(`${t}/joints`,i.joints);if(o)if(void 0===i.skeleton)i.skeleton=o.index;else{const a=(c,h)=>{for(;h.parent;h=h.parent)if(h.parent===c)return!0;return!1},l=Xe.Get(`${t}/skeleton`,this._gltf.nodes,i.skeleton);l!==o&&!a(l,o)&&(V.Warn(`${t}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),i.skeleton=o.index)}else V.Warn(`${t}: Failed to find common root`)}const n={};for(const o of i.joints){const a=Xe.Get(`${t}/joints/${o}`,this._gltf.nodes,o);this._loadBone(a,i,s,n)}}_findSkeletonRootNode(t,i){if(0===i.length)return null;const s={};for(const o of i){const a=new Array;let l=Xe.Get(`${t}/${o}`,this._gltf.nodes,o);for(;-1!==l.index;)a.unshift(l),l=l.parent;s[o]=a}let n=null;for(let o=0;;++o){let a=s[i[0]];if(o>=a.length)return n;const l=a[o];for(let c=1;c<i.length;++c)if(a=s[i[c]],o>=a.length||l!==a[o])return n;n=l}}_loadBone(t,i,s,n){let o=n[t.index];if(o)return o;let a=null;t.index!==i.skeleton&&(t.parent&&-1!==t.parent.index?a=this._loadBone(t.parent,i,s,n):void 0!==i.skeleton&&V.Warn(`/skins/${i.index}/skeleton: Skeleton node is not a common root`));const l=i.joints.indexOf(t.index);return o=new Ht(t.name||`joint${t.index}`,s,a,this._getNodeMatrix(t),null,null,l),n[t.index]=o,this._postSceneLoadActions.push(()=>{o.linkTransformNode(t._babylonTransformNode)}),o}_loadSkinInverseBindMatricesDataAsync(t,i){if(null==i.inverseBindMatrices)return Promise.resolve(null);const s=Xe.Get(`${t}/inverseBindMatrices`,this._gltf.accessors,i.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${s.index}`,s)}_updateBoneMatrices(t,i){for(const s of t.bones){const n=F.Identity(),o=s._index;i&&-1!==o&&(F.FromArrayToRef(i,16*o,n),n.invertToRef(n));const a=s.getParent();a&&n.multiplyToRef(a.getInvertedAbsoluteTransform(),n),s.updateMatrix(n,!1,!1),s._updateDifferenceMatrix(void 0,!1)}}_getNodeMatrix(t){return t.matrix?F.FromArray(t.matrix):F.Compose(t.scale?v.FromArray(t.scale):v.One(),t.rotation?Z.FromArray(t.rotation):Z.Identity(),t.translation?v.FromArray(t.translation):v.Zero())}loadCameraAsync(t,i,s=(()=>{})){const n=this._extensionsLoadCameraAsync(t,i,s);if(n)return n;const o=new Array;this.logOpen(`${t} ${i.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new lr(i.name||`camera${i.index}`,v.Zero(),this._babylonScene,!1);switch(a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.ignoreParentScaling=!0,i._babylonCamera=a,a.rotation=new v(0,Math.PI,0),i.type){case"perspective":{const l=i.perspective;if(!l)throw new Error(`${t}: Camera perspective properties are missing`);a.fov=l.yfov,a.minZ=l.znear,a.maxZ=l.zfar||0;break}case"orthographic":if(!i.orthographic)throw new Error(`${t}: Camera orthographic properties are missing`);a.mode=ve.ORTHOGRAPHIC_CAMERA,a.orthoLeft=-i.orthographic.xmag,a.orthoRight=i.orthographic.xmag,a.orthoBottom=-i.orthographic.ymag,a.orthoTop=i.orthographic.ymag,a.minZ=i.orthographic.znear,a.maxZ=i.orthographic.zfar;break;default:throw new Error(`${t}: Invalid camera type (${i.type})`)}return r.AddPointerMetadata(a,t),this._parent.onCameraLoadedObservable.notifyObservers(a),s(a),this.logClose(),Promise.all(o).then(()=>a)}_loadAnimationsAsync(){const t=this._gltf.animations;if(!t)return Promise.resolve();const i=new Array;for(let s=0;s<t.length;s++){const n=t[s];i.push(this.loadAnimationAsync(`/animations/${n.index}`,n).then(o=>{0===o.targetedAnimations.length&&o.dispose()}))}return Promise.all(i).then(()=>{})}loadAnimationAsync(t,i){const s=this._extensionsLoadAnimationAsync(t,i);if(s)return s;this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new _p(i.name||`animation${i.index}`,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i._babylonAnimationGroup=n;const o=new Array;Xe.Assign(i.channels),Xe.Assign(i.samplers);for(const a of i.channels)o.push(this._loadAnimationChannelAsync(`${t}/channels/${a.index}`,t,i,a,(l,c)=>{l.animations=l.animations||[],l.animations.push(c),n.addTargetedAnimation(c,l)}));return Promise.all(o).then(()=>(n.normalize(0),n))}_loadAnimationChannelAsync(t,i,s,n,o){const a=this._extensionsLoadAnimationChannelAsync(t,i,s,n,o);if(a)return a;if(null==n.target.node)return Promise.resolve();const l=Xe.Get(`${t}/target/node`,this._gltf.nodes,n.target.node);if("weights"===n.target.path&&!l._numMorphTargets||"weights"!==n.target.path&&!l._babylonTransformNode)return Promise.resolve();let c;switch(n.target.path){case"translation":c=b_.translation;break;case"rotation":c=b_.rotation;break;case"scale":c=b_.scale;break;case"weights":c=b_.weights;break;default:throw new Error(`${t}/target/path: Invalid value (${n.target.path})`)}return this._loadAnimationChannelFromTargetInfoAsync(t,i,s,n,{target:l,properties:c},o)}_loadAnimationChannelFromTargetInfoAsync(t,i,s,n,o,a){const l=this.parent.targetFps,c=1/l,h=Xe.Get(`${t}/sampler`,s.samplers,n.sampler);return this._loadAnimationSamplerAsync(`${i}/samplers/${n.sampler}`,h).then(u=>{let d=0;for(const f of o.properties){const p=f.getStride(o.target),_=u.input,m=u.output,g=new Array(_.length);let b=0;switch(u.interpolation){case"STEP":for(let y=0;y<_.length;y++){const T=f.getValue(o.target,m,b,1);b+=p,g[y]={frame:_[y]*l,value:T,interpolation:sp.STEP}}break;case"CUBICSPLINE":for(let y=0;y<_.length;y++){const T=f.getValue(o.target,m,b,c);b+=p;const x=f.getValue(o.target,m,b,1);b+=p;const S=f.getValue(o.target,m,b,c);b+=p,g[y]={frame:_[y]*l,inTangent:T,value:x,outTangent:S}}break;case"LINEAR":for(let y=0;y<_.length;y++){const T=f.getValue(o.target,m,b,1);b+=p,g[y]={frame:_[y]*l,value:T}}}b>0&&f.buildAnimations(o.target,`${s.name||`animation${s.index}`}_channel${n.index}_${d}`,l,g,(T,x)=>{++d,a(T,x)})}})}_loadAnimationSamplerAsync(t,i){if(i._data)return i._data;const s=i.interpolation||"LINEAR";switch(s){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${t}/interpolation: Invalid value (${i.interpolation})`)}const n=Xe.Get(`${t}/input`,this._gltf.accessors,i.input),o=Xe.Get(`${t}/output`,this._gltf.accessors,i.output);return i._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${n.index}`,n),this._loadFloatAccessorAsync(`/accessors/${o.index}`,o)]).then(([a,l])=>({input:a,interpolation:s,output:l})),i._data}loadBufferAsync(t,i,s,n){const o=this._extensionsLoadBufferAsync(t,i,s,n);if(o)return o;if(!i._data)if(i.uri)i._data=this.loadUriAsync(`${t}/uri`,i,i.uri);else{if(!this._bin)throw new Error(`${t}: Uri is missing or the binary glTF is missing its binary chunk`);i._data=this._bin.readAsync(0,i.byteLength)}return i._data.then(a=>{try{return new Uint8Array(a.buffer,a.byteOffset+s,n)}catch(l){throw new Error(`${t}: ${l.message}`)}})}loadBufferViewAsync(t,i){const s=this._extensionsLoadBufferViewAsync(t,i);if(s)return s;if(i._data)return i._data;const n=Xe.Get(`${t}/buffer`,this._gltf.buffers,i.buffer);return i._data=this.loadBufferAsync(`/buffers/${n.index}`,n,i.byteOffset||0,i.byteLength),i._data}_loadAccessorAsync(t,i,s){if(i._data)return i._data;const n=r._GetNumComponents(t,i.type),o=n*A.GetTypeByteLength(i.componentType),a=n*i.count;if(null==i.bufferView)i._data=Promise.resolve(new s(a));else{const l=Xe.Get(`${t}/bufferView`,this._gltf.bufferViews,i.bufferView);i._data=this.loadBufferViewAsync(`/bufferViews/${l.index}`,l).then(c=>{if(!(5126!==i.componentType||i.normalized||l.byteStride&&l.byteStride!==o))return r._GetTypedArray(t,i.componentType,c,i.byteOffset,a);{const h=new s(a);return A.ForEach(c,i.byteOffset||0,l.byteStride||o,n,i.componentType,h.length,i.normalized||!1,(u,d)=>{h[d]=u}),h}})}if(i.sparse){const l=i.sparse;i._data=i._data.then(c=>{const h=c,u=Xe.Get(`${t}/sparse/indices/bufferView`,this._gltf.bufferViews,l.indices.bufferView),d=Xe.Get(`${t}/sparse/values/bufferView`,this._gltf.bufferViews,l.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${u.index}`,u),this.loadBufferViewAsync(`/bufferViews/${d.index}`,d)]).then(([f,p])=>{const _=r._GetTypedArray(`${t}/sparse/indices`,l.indices.componentType,f,l.indices.byteOffset,l.count),m=n*l.count;let g;if(5126!==i.componentType||i.normalized){const y=r._GetTypedArray(`${t}/sparse/values`,i.componentType,p,l.values.byteOffset,m);g=new s(m),A.ForEach(y,0,o,n,i.componentType,g.length,i.normalized||!1,(T,x)=>{g[x]=T})}else g=r._GetTypedArray(`${t}/sparse/values`,i.componentType,p,l.values.byteOffset,m);let b=0;for(let y=0;y<_.length;y++){let T=_[y]*n;for(let x=0;x<n;x++)h[T++]=g[b++]}return h})})}return i._data}_loadFloatAccessorAsync(t,i){return this._loadAccessorAsync(t,i,Float32Array)}_loadIndicesAccessorAsync(t,i){if("SCALAR"!==i.type)throw new Error(`${t}/type: Invalid value ${i.type}`);if(5121!==i.componentType&&5123!==i.componentType&&5125!==i.componentType)throw new Error(`${t}/componentType: Invalid value ${i.componentType}`);if(i._data)return i._data;if(i.sparse){const s=r._GetTypedArrayConstructor(`${t}/componentType`,i.componentType);i._data=this._loadAccessorAsync(t,i,s)}else{const s=Xe.Get(`${t}/bufferView`,this._gltf.bufferViews,i.bufferView);i._data=this.loadBufferViewAsync(`/bufferViews/${s.index}`,s).then(n=>r._GetTypedArray(t,i.componentType,n,i.byteOffset,i.count))}return i._data}_loadVertexBufferViewAsync(t){if(t._babylonBuffer)return t._babylonBuffer;const i=this._babylonScene.getEngine();return t._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${t.index}`,t).then(s=>new kn(i,s,!1)),t._babylonBuffer}_loadVertexAccessorAsync(t,i,s){var n;if(null!==(n=i._babylonVertexBuffer)&&void 0!==n&&n[s])return i._babylonVertexBuffer[s];i._babylonVertexBuffer||(i._babylonVertexBuffer={});const o=this._babylonScene.getEngine();if(i.sparse)i._babylonVertexBuffer[s]=this._loadFloatAccessorAsync(t,i).then(a=>new A(o,a,s,!1));else if(s===A.MatricesIndicesKind||s===A.MatricesIndicesExtraKind)i._babylonVertexBuffer[s]=this._loadFloatAccessorAsync(t,i).then(a=>new A(o,a,s,!1));else{const a=Xe.Get(`${t}/bufferView`,this._gltf.bufferViews,i.bufferView);i._babylonVertexBuffer[s]=this._loadVertexBufferViewAsync(a).then(l=>{const c=r._GetNumComponents(t,i.type);return new A(o,l,s,!1,!1,a.byteStride,!1,i.byteOffset,c,i.componentType,i.normalized,!0,1,!0)})}return i._babylonVertexBuffer[s]}_loadMaterialMetallicRoughnessPropertiesAsync(t,i,s){if(!(s instanceof Ee))throw new Error(`${t}: Material type not supported`);const n=new Array;return i&&(i.baseColorFactor?(s.albedoColor=re.FromArray(i.baseColorFactor),s.alpha=i.baseColorFactor[3]):s.albedoColor=re.White(),s.metallic=i.metallicFactor??1,s.roughness=i.roughnessFactor??1,i.baseColorTexture&&n.push(this.loadTextureInfoAsync(`${t}/baseColorTexture`,i.baseColorTexture,o=>{o.name=`${s.name} (Base Color)`,s.albedoTexture=o})),i.metallicRoughnessTexture&&(i.metallicRoughnessTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${t}/metallicRoughnessTexture`,i.metallicRoughnessTexture,o=>{o.name=`${s.name} (Metallic Roughness)`,s.metallicTexture=o})),s.useMetallnessFromMetallicTextureBlue=!0,s.useRoughnessFromMetallicTextureGreen=!0,s.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(n).then(()=>{})}_loadMaterialAsync(t,i,s,n,o=(()=>{})){const a=this._extensionsLoadMaterialAsync(t,i,s,n,o);if(a)return a;i._data=i._data||{};let l=i._data[n];if(!l){this.logOpen(`${t} ${i.name||""}`);const c=this.createMaterial(t,i,n);l={babylonMaterial:c,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(t,i,c)},i._data[n]=l,r.AddPointerMetadata(c,t),this._parent.onMaterialLoadedObservable.notifyObservers(c),this.logClose()}return s&&(l.babylonMeshes.push(s),s.onDisposeObservable.addOnce(()=>{const c=l.babylonMeshes.indexOf(s);-1!==c&&l.babylonMeshes.splice(c,1)})),o(l.babylonMaterial),l.promise.then(()=>l.babylonMaterial)}_createDefaultMaterial(t,i){this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new Ee(t,this._babylonScene);return s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,s.fillMode=i,s.enableSpecularAntiAliasing=!0,s.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,s.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,s.transparencyMode=Ee.PBRMATERIAL_OPAQUE,s.metallic=1,s.roughness=1,s}createMaterial(t,i,s){const n=this._extensionsCreateMaterial(t,i,s);return n||this._createDefaultMaterial(i.name||`material${i.index}`,s)}loadMaterialPropertiesAsync(t,i,s){const n=this._extensionsLoadMaterialPropertiesAsync(t,i,s);if(n)return n;const o=new Array;return o.push(this.loadMaterialBasePropertiesAsync(t,i,s)),i.pbrMetallicRoughness&&o.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${t}/pbrMetallicRoughness`,i.pbrMetallicRoughness,s)),this.loadMaterialAlphaProperties(t,i,s),Promise.all(o).then(()=>{})}loadMaterialBasePropertiesAsync(t,i,s){if(!(s instanceof Ee))throw new Error(`${t}: Material type not supported`);const n=new Array;return s.emissiveColor=i.emissiveFactor?re.FromArray(i.emissiveFactor):new re(0,0,0),i.doubleSided&&(s.backFaceCulling=!1,s.twoSidedLighting=!0),i.normalTexture&&(i.normalTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${t}/normalTexture`,i.normalTexture,o=>{o.name=`${s.name} (Normal)`,s.bumpTexture=o})),s.invertNormalMapX=!this._babylonScene.useRightHandedSystem,s.invertNormalMapY=this._babylonScene.useRightHandedSystem,null!=i.normalTexture.scale&&s.bumpTexture&&(s.bumpTexture.level=i.normalTexture.scale),s.forceIrradianceInFragment=!0),i.occlusionTexture&&(i.occlusionTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${t}/occlusionTexture`,i.occlusionTexture,o=>{o.name=`${s.name} (Occlusion)`,s.ambientTexture=o})),s.useAmbientInGrayScale=!0,null!=i.occlusionTexture.strength&&(s.ambientTextureStrength=i.occlusionTexture.strength)),i.emissiveTexture&&n.push(this.loadTextureInfoAsync(`${t}/emissiveTexture`,i.emissiveTexture,o=>{o.name=`${s.name} (Emissive)`,s.emissiveTexture=o})),Promise.all(n).then(()=>{})}loadMaterialAlphaProperties(t,i,s){if(!(s instanceof Ee))throw new Error(`${t}: Material type not supported`);switch(i.alphaMode||"OPAQUE"){case"OPAQUE":s.transparencyMode=Ee.PBRMATERIAL_OPAQUE;break;case"MASK":s.transparencyMode=Ee.PBRMATERIAL_ALPHATEST,s.alphaCutOff=i.alphaCutoff??.5,s.albedoTexture&&(s.albedoTexture.hasAlpha=!0);break;case"BLEND":s.transparencyMode=Ee.PBRMATERIAL_ALPHABLEND,s.albedoTexture&&(s.albedoTexture.hasAlpha=!0,s.useAlphaFromAlbedoTexture=!0);break;default:throw new Error(`${t}/alphaMode: Invalid value (${i.alphaMode})`)}}loadTextureInfoAsync(t,i,s=(()=>{})){const n=this._extensionsLoadTextureInfoAsync(t,i,s);if(n)return n;if(this.logOpen(`${t}`),i.texCoord>=6)throw new Error(`${t}/texCoord: Invalid value (${i.texCoord})`);const o=Xe.Get(`${t}/index`,this._gltf.textures,i.index);o._textureInfo=i;const a=this._loadTextureAsync(`/textures/${i.index}`,o,l=>{l.coordinatesIndex=i.texCoord||0,r.AddPointerMetadata(l,t),this._parent.onTextureLoadedObservable.notifyObservers(l),s(l)});return this.logClose(),a}_loadTextureAsync(t,i,s=(()=>{})){const n=this._extensionsLoadTextureAsync(t,i,s);if(n)return n;this.logOpen(`${t} ${i.name||""}`);const o=null==i.sampler?r.DefaultSampler:Xe.Get(`${t}/sampler`,this._gltf.samplers,i.sampler),a=Xe.Get(`${t}/source`,this._gltf.images,i.source),l=this._createTextureAsync(t,o,a,s,void 0,!i._textureInfo.nonColorData);return this.logClose(),l}_createTextureAsync(t,i,s,n=(()=>{}),o,a){const l=this._loadSampler(`/samplers/${i.index}`,i),c=new Array,h=new Jp;this._babylonScene._blockEntityCollection=!!this._assetContainer;const d=new U(null,this._babylonScene,{noMipmap:l.noMipMaps,invertY:!1,samplingMode:l.samplingMode,onLoad:()=>{this._disposed||h.resolve()},onError:(f,p)=>{this._disposed||h.reject(new Error(`${t}: ${p&&p.message?p.message:f||"Failed to load texture"}`))},mimeType:s.mimeType,loaderOptions:o,useSRGBBuffer:!!a&&this._parent.useSRGBBuffers});return d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,c.push(h.promise),c.push(this.loadImageAsync(`/images/${s.index}`,s).then(f=>{d.updateURL(`data:${this._uniqueRootUrl}${s.uri||`${this._fileName}#image${s.index}`}`,f)})),d.wrapU=l.wrapU,d.wrapV=l.wrapV,n(d),Promise.all(c).then(()=>d)}_loadSampler(t,i){return i._data||(i._data={noMipMaps:9728===i.minFilter||9729===i.minFilter,samplingMode:r._GetTextureSamplingMode(t,i),wrapU:r._GetTextureWrapMode(`${t}/wrapS`,i.wrapS),wrapV:r._GetTextureWrapMode(`${t}/wrapT`,i.wrapT)}),i._data}loadImageAsync(t,i){if(!i._data){if(this.logOpen(`${t} ${i.name||""}`),i.uri)i._data=this.loadUriAsync(`${t}/uri`,i,i.uri);else{const s=Xe.Get(`${t}/bufferView`,this._gltf.bufferViews,i.bufferView);i._data=this.loadBufferViewAsync(`/bufferViews/${s.index}`,s)}this.logClose()}return i._data}loadUriAsync(t,i,s){const n=this._extensionsLoadUriAsync(t,i,s);if(n)return n;if(!r._ValidateUri(s))throw new Error(`${t}: '${s}' is invalid`);if($g(s)){const o=new Uint8Array(up(s));return this.log(`${t}: Decoded ${s.substr(0,64)}... (${o.length} bytes)`),Promise.resolve(o)}return this.log(`${t}: Loading ${s}`),this._parent.preprocessUrlAsync(this._rootUrl+s).then(o=>new Promise((a,l)=>{this._parent._loadFile(this._babylonScene,o,c=>{this._disposed||(this.log(`${t}: Loaded ${s} (${c.byteLength} bytes)`),a(new Uint8Array(c)))},!0,c=>{l(new cp(`${t}: Failed to load '${s}'${c?": "+c.status+" "+c.statusText:""}`,c))})}))}static AddPointerMetadata(t,i){t.metadata=t.metadata||{};const s=t._internalMetadata=t._internalMetadata||{},n=s.gltf=s.gltf||{};(n.pointers=n.pointers||[]).push(i)}static _GetTextureWrapMode(t,i){switch(i=i??10497){case 33071:return U.CLAMP_ADDRESSMODE;case 33648:return U.MIRROR_ADDRESSMODE;case 10497:return U.WRAP_ADDRESSMODE;default:return V.Warn(`${t}: Invalid value (${i})`),U.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(t,i){const s=i.magFilter??9729,n=i.minFilter??9987;if(9729===s)switch(n){case 9728:return U.LINEAR_NEAREST;case 9729:return U.LINEAR_LINEAR;case 9984:return U.LINEAR_NEAREST_MIPNEAREST;case 9985:return U.LINEAR_LINEAR_MIPNEAREST;case 9986:return U.LINEAR_NEAREST_MIPLINEAR;case 9987:return U.LINEAR_LINEAR_MIPLINEAR;default:return V.Warn(`${t}/minFilter: Invalid value (${n})`),U.LINEAR_LINEAR_MIPLINEAR}else switch(9728!==s&&V.Warn(`${t}/magFilter: Invalid value (${s})`),n){case 9728:return U.NEAREST_NEAREST;case 9729:return U.NEAREST_LINEAR;case 9984:return U.NEAREST_NEAREST_MIPNEAREST;case 9985:return U.NEAREST_LINEAR_MIPNEAREST;case 9986:return U.NEAREST_NEAREST_MIPLINEAR;case 9987:return U.NEAREST_LINEAR_MIPLINEAR;default:return V.Warn(`${t}/minFilter: Invalid value (${n})`),U.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(t,i){switch(i){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`${t}: Invalid component type ${i}`)}}static _GetTypedArray(t,i,s,n,o){const a=s.buffer;n=s.byteOffset+(n||0);const l=r._GetTypedArrayConstructor(`${t}/componentType`,i),c=A.GetTypeByteLength(i);return n%c!=0?(V.Warn(`${t}: Copying buffer as byte offset (${n}) is not a multiple of component type byte length (${c})`),new l(a.slice(n,n+o*c),0)):new l(a,n,o)}static _GetNumComponents(t,i){switch(i){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${t}: Invalid type (${i})`)}static _ValidateUri(t){return q.IsBase64(t)||-1===t.indexOf("..")}static _GetDrawMode(t,i){switch(null==i&&(i=4),i){case 0:return ie.PointListDrawMode;case 1:return ie.LineListDrawMode;case 2:return ie.LineLoopDrawMode;case 3:return ie.LineStripDrawMode;case 4:return ie.TriangleFillMode;case 5:return ie.TriangleStripDrawMode;case 6:return ie.TriangleFanDrawMode}throw new Error(`${t}: Invalid mesh primitive mode (${i})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const t=new Array;if(this._gltf.materials)for(const i of this._gltf.materials)if(i._data)for(const s in i._data){const n=i._data[s];for(const o of n.babylonMeshes){o.computeWorldMatrix(!0);const a=n.babylonMaterial;t.push(a.forceCompilationAsync(o)),t.push(a.forceCompilationAsync(o,{useInstances:!0})),this._parent.useClipPlane&&(t.push(a.forceCompilationAsync(o,{clipPlane:!0})),t.push(a.forceCompilationAsync(o,{clipPlane:!0,useInstances:!0})))}}return Promise.all(t).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const t=new Array,i=this._babylonScene.lights;for(const s of i){const n=s.getShadowGenerator();n&&t.push(n.forceCompilationAsync())}return Promise.all(t).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(t){for(const i of this._extensions)i.enabled&&t(i)}_applyExtensions(t,i,s){for(const n of this._extensions)if(n.enabled){const o=`${n.name}.${i}`,a=t;a._activeLoaderExtensionFunctions=a._activeLoaderExtensionFunctions||{};const l=a._activeLoaderExtensionFunctions;if(!l[o]){l[o]=!0;try{const c=s(n);if(c)return c}finally{delete l[o]}}}return null}_extensionsOnLoading(){this._forEachExtensions(t=>t.onLoading&&t.onLoading())}_extensionsOnReady(){this._forEachExtensions(t=>t.onReady&&t.onReady())}_extensionsLoadSceneAsync(t,i){return this._applyExtensions(i,"loadScene",s=>s.loadSceneAsync&&s.loadSceneAsync(t,i))}_extensionsLoadNodeAsync(t,i,s){return this._applyExtensions(i,"loadNode",n=>n.loadNodeAsync&&n.loadNodeAsync(t,i,s))}_extensionsLoadCameraAsync(t,i,s){return this._applyExtensions(i,"loadCamera",n=>n.loadCameraAsync&&n.loadCameraAsync(t,i,s))}_extensionsLoadVertexDataAsync(t,i,s){return this._applyExtensions(i,"loadVertexData",n=>n._loadVertexDataAsync&&n._loadVertexDataAsync(t,i,s))}_extensionsLoadMeshPrimitiveAsync(t,i,s,n,o,a){return this._applyExtensions(o,"loadMeshPrimitive",l=>l._loadMeshPrimitiveAsync&&l._loadMeshPrimitiveAsync(t,i,s,n,o,a))}_extensionsLoadMaterialAsync(t,i,s,n,o){return this._applyExtensions(i,"loadMaterial",a=>a._loadMaterialAsync&&a._loadMaterialAsync(t,i,s,n,o))}_extensionsCreateMaterial(t,i,s){return this._applyExtensions(i,"createMaterial",n=>n.createMaterial&&n.createMaterial(t,i,s))}_extensionsLoadMaterialPropertiesAsync(t,i,s){return this._applyExtensions(i,"loadMaterialProperties",n=>n.loadMaterialPropertiesAsync&&n.loadMaterialPropertiesAsync(t,i,s))}_extensionsLoadTextureInfoAsync(t,i,s){return this._applyExtensions(i,"loadTextureInfo",n=>n.loadTextureInfoAsync&&n.loadTextureInfoAsync(t,i,s))}_extensionsLoadTextureAsync(t,i,s){return this._applyExtensions(i,"loadTexture",n=>n._loadTextureAsync&&n._loadTextureAsync(t,i,s))}_extensionsLoadAnimationAsync(t,i){return this._applyExtensions(i,"loadAnimation",s=>s.loadAnimationAsync&&s.loadAnimationAsync(t,i))}_extensionsLoadAnimationChannelAsync(t,i,s,n,o){return this._applyExtensions(s,"loadAnimationChannel",a=>a._loadAnimationChannelAsync&&a._loadAnimationChannelAsync(t,i,s,n,o))}_extensionsLoadSkinAsync(t,i,s){return this._applyExtensions(s,"loadSkin",n=>n._loadSkinAsync&&n._loadSkinAsync(t,i,s))}_extensionsLoadUriAsync(t,i,s){return this._applyExtensions(i,"loadUri",n=>n._loadUriAsync&&n._loadUriAsync(t,i,s))}_extensionsLoadBufferViewAsync(t,i){return this._applyExtensions(i,"loadBufferView",s=>s.loadBufferViewAsync&&s.loadBufferViewAsync(t,i))}_extensionsLoadBufferAsync(t,i,s,n){return this._applyExtensions(i,"loadBuffer",o=>o.loadBufferAsync&&o.loadBufferAsync(t,i,s,n))}static LoadExtensionAsync(t,i,s,n){if(!i.extensions)return null;const a=i.extensions[s];return a?n(`${t}/extensions/${s}`,a):null}static LoadExtraAsync(t,i,s,n){if(!i.extras)return null;const a=i.extras[s];return a?n(`${t}/extras/${s}`,a):null}isExtensionUsed(t){return!!this._gltf.extensionsUsed&&-1!==this._gltf.extensionsUsed.indexOf(t)}logOpen(t){this._parent._logOpen(t)}logClose(){this._parent._logClose()}log(t){this._parent._log(t)}startPerformanceCounter(t){this._parent._startPerformanceCounter(t)}endPerformanceCounter(t){this._parent._endPerformanceCounter(t)}}return r._RegisteredExtensions={},r.DefaultSampler={index:-1},r})();yc._CreateGLTF2Loader=r=>new st(r);const M0="EXT_lights_image_based";class qce{constructor(e){this.name=M0,this._loader=e,this.enabled=this._loader.isExtensionUsed(M0)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;e&&e[this.name]&&(this._lights=e[this.name].lights)}loadSceneAsync(e,t){return st.LoadExtensionAsync(e,t,this.name,(i,s)=>{const n=new Array;n.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${i}`);const o=Xe.Get(`${i}/light`,this._lights,s.light);return n.push(this._loadLightAsync(`/extensions/${this.name}/lights/${s.light}`,o).then(a=>{this._loader.babylonScene.environmentTexture=a})),this._loader.logClose(),Promise.all(n).then(()=>{})})}_loadLightAsync(e,t){if(!t._loaded){const i=new Array;this._loader.logOpen(`${e}`);const s=new Array(t.specularImages.length);for(let n=0;n<t.specularImages.length;n++){const o=t.specularImages[n];s[n]=new Array(o.length);for(let a=0;a<o.length;a++){const l=`${e}/specularImages/${n}/${a}`;this._loader.logOpen(`${l}`);const c=o[a],h=Xe.Get(l,this._loader.gltf.images,c);i.push(this._loader.loadImageAsync(`/images/${c}`,h).then(u=>{s[n][a]=u})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(i).then(()=>{const n=new HC(this._loader.babylonScene,null,t.specularImageSize);if(n.name=t.name||"environment",t._babylonTexture=n,null!=t.intensity&&(n.level=t.intensity),t.rotation){let c=Z.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(c=Z.Inverse(c)),F.FromQuaternionToRef(c,n.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const o=vh.FromArray(t.irradianceCoefficients);o.scaleInPlace(t.intensity),o.convertIrradianceToLambertianRadiance();const a=ll.FromHarmonics(o),l=(s.length-1)/oe.Log2(t.specularImageSize);return n.updateRGBDAsync(s,a,l)})}return t._loaded.then(()=>t._babylonTexture)}}st.RegisterExtension(M0,r=>new qce(r));const P0="EXT_mesh_gpu_instancing";class $ce{constructor(e){this.name=P0,this._loader=e,this.enabled=this._loader.isExtensionUsed(P0)}dispose(){this._loader=null}loadNodeAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>{this._loader._disableInstancedMesh++;const o=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,i);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return o;const a=new Array;let l=0;const c=h=>{if(null==n.attributes[h])return void a.push(Promise.resolve(null));const u=Xe.Get(`${s}/attributes/${h}`,this._loader.gltf.accessors,n.attributes[h]);if(a.push(this._loader._loadFloatAccessorAsync(`/accessors/${u.bufferView}`,u)),0===l)l=u.count;else if(l!==u.count)throw new Error(`${s}/attributes: Instance buffer accessors do not have the same count.`)};return c("TRANSLATION"),c("ROTATION"),c("SCALE"),o.then(h=>Promise.all(a).then(([u,d,f])=>{const p=new Float32Array(16*l);L.Vector3[0].copyFromFloats(0,0,0),L.Quaternion[0].copyFromFloats(0,0,0,1),L.Vector3[1].copyFromFloats(1,1,1);for(let _=0;_<l;++_)u&&v.FromArrayToRef(u,3*_,L.Vector3[0]),d&&Z.FromArrayToRef(d,4*_,L.Quaternion[0]),f&&v.FromArrayToRef(f,3*_,L.Vector3[1]),F.ComposeToRef(L.Vector3[1],L.Quaternion[0],L.Vector3[0],L.Matrix[0]),L.Matrix[0].copyToArray(p,16*_);for(const _ of t._primitiveBabylonMeshes)_.thinInstanceSetBuffer("matrix",p,16,!0);return h}))})}}st.RegisterExtension(P0,r=>new $ce(r));const D0="EXT_meshopt_compression";class Kce{constructor(e){this.name=D0,this.enabled=e.isExtensionUsed(D0),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return st.LoadExtensionAsync(e,t,this.name,(i,s)=>{const n=t;if(n._meshOptData)return n._meshOptData;const o=Xe.Get(`${e}/buffer`,this._loader.gltf.buffers,s.buffer);return n._meshOptData=this._loader.loadBufferAsync(`/buffers/${o.index}`,o,s.byteOffset||0,s.byteLength).then(a=>Vae.Default.decodeGltfBufferAsync(a,s.count,s.byteStride,s.mode,s.filter)),n._meshOptData})}}st.RegisterExtension(D0,r=>new Kce(r));const w0="EXT_texture_webp";class Qce{constructor(e){this.name=w0,this._loader=e,this.enabled=e.isExtensionUsed(w0)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>{const o=null==t.sampler?st.DefaultSampler:Xe.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=Xe.Get(`${s}/source`,this._loader.gltf.images,n.source);return this._loader._createTextureAsync(e,o,a,l=>{i(l)},void 0,!t._textureInfo.nonColorData)})}}st.RegisterExtension(w0,r=>new Qce(r));const O0="KHR_draco_mesh_compression";class Zce{constructor(e){this.name=O0,this._loader=e,this.enabled=bn.DecoderAvailable&&this._loader.isExtensionUsed(O0)}dispose(){delete this.dracoCompression,this._loader=null}_loadVertexDataAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>{if(null!=t.mode){if(5!==t.mode&&4!==t.mode)throw new Error(`${e}: Unsupported mode ${t.mode}`);if(5===t.mode)throw new Error(`${e}: Mode ${t.mode} is not currently supported`)}const o={},a={},l=(h,u)=>{const d=n.attributes[h];if(void 0===d||void 0===t.attributes[h])return;o[u]=d;const f=Xe.Get(`${e}/attributes/${h}`,this._loader.gltf.accessors,t.attributes[h]);if(f.normalized&&5126!==f.componentType){let p=1;switch(f.componentType){case 5120:p=127;break;case 5121:p=255;break;case 5122:p=32767;break;case 5123:p=65535}a[u]=p}i._delayInfo=i._delayInfo||[],-1===i._delayInfo.indexOf(u)&&i._delayInfo.push(u)};l("POSITION",A.PositionKind),l("NORMAL",A.NormalKind),l("TANGENT",A.TangentKind),l("TEXCOORD_0",A.UVKind),l("TEXCOORD_1",A.UV2Kind),l("TEXCOORD_2",A.UV3Kind),l("TEXCOORD_3",A.UV4Kind),l("TEXCOORD_4",A.UV5Kind),l("TEXCOORD_5",A.UV6Kind),l("JOINTS_0",A.MatricesIndicesKind),l("WEIGHTS_0",A.MatricesWeightsKind),l("COLOR_0",A.ColorKind);const c=Xe.Get(s,this._loader.gltf.bufferViews,n.bufferView);return c._dracoBabylonGeometry||(c._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${c.index}`,c).then(h=>(this.dracoCompression||bn.Default).decodeMeshAsync(h,o,a).then(d=>{const f=new rr(i.name,this._loader.babylonScene);return d.applyToGeometry(f),f}).catch(d=>{throw new Error(`${e}: ${d.message}`)}))),c._dracoBabylonGeometry})}}st.RegisterExtension(O0,r=>new Zce(r));const N0="KHR_lights_punctual";class Jce{constructor(e){this.name=N0,this._loader=e,this.enabled=this._loader.isExtensionUsed(N0)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;e&&e[this.name]&&(this._lights=e[this.name].lights,Xe.Assign(this._lights))}loadNodeAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>this._loader.loadNodeAsync(e,t,o=>{let a;const l=Xe.Get(s,this._lights,n.light),c=l.name||o.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l.type){case"directional":a=new qn(c,v.Backward(),this._loader.babylonScene);break;case"point":a=new od(c,v.Zero(),this._loader.babylonScene);break;case"spot":{const h=new rn(c,v.Zero(),v.Backward(),0,1,this._loader.babylonScene);h.angle=2*(l.spot&&l.spot.outerConeAngle||Math.PI/4),h.innerAngle=2*(l.spot&&l.spot.innerConeAngle||0),a=h;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${s}: Invalid light type (${l.type})`)}a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=a,a.falloffType=Je.FALLOFF_GLTF,a.diffuse=l.color?re.FromArray(l.color):re.White(),a.intensity=l.intensity??1,a.range=l.range??Number.MAX_VALUE,a.parent=o,this._loader._babylonLights.push(a),st.AddPointerMetadata(a,s),i(o)}))}}st.RegisterExtension(N0,r=>new Jce(r));const F0="KHR_materials_pbrSpecularGlossiness";class ehe{constructor(e){this.name=F0,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(F0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),o.push(this._loadSpecularGlossinessPropertiesAsync(s,t,n,i)),this._loader.loadMaterialAlphaProperties(e,t,i),Promise.all(o).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,t,i,s){if(!(s instanceof Ee))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.metallic=null,s.roughness=null,i.diffuseFactor?(s.albedoColor=re.FromArray(i.diffuseFactor),s.alpha=i.diffuseFactor[3]):s.albedoColor=re.White(),s.reflectivityColor=i.specularFactor?re.FromArray(i.specularFactor):re.White(),s.microSurface=i.glossinessFactor??1,i.diffuseTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,i.diffuseTexture,o=>{o.name=`${s.name} (Diffuse)`,s.albedoTexture=o})),i.specularGlossinessTexture&&(n.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,i.specularGlossinessTexture,o=>{o.name=`${s.name} (Specular Glossiness)`,s.reflectivityTexture=o,s.reflectivityTexture.hasAlpha=!0})),s.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(n).then(()=>{})}}st.RegisterExtension(F0,r=>new ehe(r));const L0="KHR_materials_unlit";class the{constructor(e){this.name=L0,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(L0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,()=>this._loadUnlitPropertiesAsync(e,t,i))}_loadUnlitPropertiesAsync(e,t,i){if(!(i instanceof Ee))throw new Error(`${e}: Material type not supported`);const s=new Array;i.unlit=!0;const n=t.pbrMetallicRoughness;return n&&(n.baseColorFactor?(i.albedoColor=re.FromArray(n.baseColorFactor),i.alpha=n.baseColorFactor[3]):i.albedoColor=re.White(),n.baseColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,n.baseColorTexture,o=>{o.name=`${i.name} (Base Color)`,i.albedoTexture=o}))),t.doubleSided&&(i.backFaceCulling=!1,i.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,i),Promise.all(s).then(()=>{})}}st.RegisterExtension(L0,r=>new the(r));const B0="KHR_materials_clearcoat";class ihe{constructor(e){this.name=B0,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(B0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadClearCoatPropertiesAsync(s,n,i)),Promise.all(o).then(()=>{})})}_loadClearCoatPropertiesAsync(e,t,i){if(!(i instanceof Ee))throw new Error(`${e}: Material type not supported`);const s=new Array;return i.clearCoat.isEnabled=!0,i.clearCoat.useRoughnessFromMainTexture=!1,i.clearCoat.remapF0OnInterfaceChange=!1,i.clearCoat.intensity=null!=t.clearcoatFactor?t.clearcoatFactor:0,t.clearcoatTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,n=>{n.name=`${i.name} (ClearCoat Intensity)`,i.clearCoat.texture=n})),i.clearCoat.roughness=null!=t.clearcoatRoughnessFactor?t.clearcoatRoughnessFactor:0,t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,n=>{n.name=`${i.name} (ClearCoat Roughness)`,i.clearCoat.textureRoughness=n}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,n=>{n.name=`${i.name} (ClearCoat Normal)`,i.clearCoat.bumpTexture=n})),i.invertNormalMapX=!i.getScene().useRightHandedSystem,i.invertNormalMapY=i.getScene().useRightHandedSystem,null!=t.clearcoatNormalTexture.scale&&(i.clearCoat.bumpTexture.level=t.clearcoatNormalTexture.scale)),Promise.all(s).then(()=>{})}}st.RegisterExtension(B0,r=>new ihe(r));const V0="KHR_materials_iridescence";class she{constructor(e){this.name=V0,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(V0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadIridescencePropertiesAsync(s,n,i)),Promise.all(o).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,i){var s,n,o,a,l;if(!(i instanceof Ee))throw new Error(`${e}: Material type not supported`);const c=new Array;return i.iridescence.isEnabled=!0,i.iridescence.intensity=null!==(s=t.iridescenceFactor)&&void 0!==s?s:0,i.iridescence.indexOfRefraction=null!==(o=null!==(n=t.iridescenceIor)&&void 0!==n?n:t.iridescenceIOR)&&void 0!==o?o:1.3,i.iridescence.minimumThickness=null!==(a=t.iridescenceThicknessMinimum)&&void 0!==a?a:100,i.iridescence.maximumThickness=null!==(l=t.iridescenceThicknessMaximum)&&void 0!==l?l:400,t.iridescenceTexture&&c.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,h=>{h.name=`${i.name} (Iridescence Intensity)`,i.iridescence.texture=h})),t.iridescenceThicknessTexture&&c.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,h=>{h.name=`${i.name} (Iridescence Thickness)`,i.iridescence.thicknessTexture=h})),Promise.all(c).then(()=>{})}}st.RegisterExtension(V0,r=>new she(r));const U0="KHR_materials_emissive_strength";class rhe{constructor(e){this.name=U0,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(U0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>this._loader.loadMaterialPropertiesAsync(e,t,i).then(()=>{this._loadEmissiveProperties(s,n,i)}))}_loadEmissiveProperties(e,t,i){if(!(i instanceof Ee))throw new Error(`${e}: Material type not supported`);void 0!==t.emissiveStrength&&i.emissiveColor.scaleToRef(t.emissiveStrength,i.emissiveColor)}}st.RegisterExtension(U0,r=>new rhe(r));const k0="KHR_materials_sheen";class nhe{constructor(e){this.name=k0,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(k0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadSheenPropertiesAsync(s,n,i)),Promise.all(o).then(()=>{})})}_loadSheenPropertiesAsync(e,t,i){if(!(i instanceof Ee))throw new Error(`${e}: Material type not supported`);const s=new Array;return i.sheen.isEnabled=!0,i.sheen.intensity=1,i.sheen.color=null!=t.sheenColorFactor?re.FromArray(t.sheenColorFactor):re.Black(),t.sheenColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,n=>{n.name=`${i.name} (Sheen Color)`,i.sheen.texture=n})),i.sheen.roughness=void 0!==t.sheenRoughnessFactor?t.sheenRoughnessFactor:0,t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,n=>{n.name=`${i.name} (Sheen Roughness)`,i.sheen.textureRoughness=n}))),i.sheen.albedoScaling=!0,i.sheen.useRoughnessFromMainTexture=!1,Promise.all(s).then(()=>{})}}st.RegisterExtension(k0,r=>new nhe(r));const G0="KHR_materials_specular";class ohe{constructor(e){this.name=G0,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(G0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadSpecularPropertiesAsync(s,n,i)),Promise.all(o).then(()=>{})})}_loadSpecularPropertiesAsync(e,t,i){if(!(i instanceof Ee))throw new Error(`${e}: Material type not supported`);const s=new Array;return void 0!==t.specularFactor&&(i.metallicF0Factor=t.specularFactor),void 0!==t.specularColorFactor&&(i.metallicReflectanceColor=re.FromArray(t.specularColorFactor)),t.specularTexture&&(t.specularTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,n=>{n.name=`${i.name} (Specular F0 Strength)`,i.metallicReflectanceTexture=n,i.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),t.specularColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,n=>{n.name=`${i.name} (Specular F0 Color)`,i.reflectanceTexture=n})),Promise.all(s).then(()=>{})}}st.RegisterExtension(G0,r=>new ohe(r));const z0="KHR_materials_ior";let ahe=(()=>{class r{constructor(t){this.name=z0,this.order=180,this._loader=t,this.enabled=this._loader.isExtensionUsed(z0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(t,i,s){return st.LoadExtensionAsync(t,i,this.name,(n,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(t,i,s)),a.push(this._loadIorPropertiesAsync(n,o,s)),Promise.all(a).then(()=>{})})}_loadIorPropertiesAsync(t,i,s){if(!(s instanceof Ee))throw new Error(`${t}: Material type not supported`);return s.indexOfRefraction=void 0!==i.ior?i.ior:r._DEFAULT_IOR,Promise.resolve()}}return r._DEFAULT_IOR=1.5,r})();st.RegisterExtension(z0,r=>new ahe(r));const ln="KHR_materials_variants";class xc{constructor(e){this.name=ln,this._loader=e,this.enabled=this._loader.isExtensionUsed(ln)}dispose(){this._loader=null}static GetAvailableVariants(e){const t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return xc.GetAvailableVariants(e)}static SelectVariant(e,t){const i=this._GetExtensionMetadata(e);if(!i)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${ln} extension`);const s=n=>{const o=i.variants[n];if(o)for(const a of o)a.mesh.material=a.material};if(t instanceof Array)for(const n of t)s(n);else s(t);i.lastSelected=t}selectVariant(e,t){return xc.SelectVariant(e,t)}static Reset(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot reset on a glTF mesh that does not have the ${ln} extension`);for(const i of t.original)i.mesh.material=i.material;t.lastSelected=null}reset(e){return xc.Reset(e)}static GetLastSelectedVariant(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${ln} extension`);return t.lastSelected}getLastSelectedVariant(e){return xc.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){var t,i;return(null===(i=null===(t=e?._internalMetadata)||void 0===t?void 0:t.gltf)||void 0===i?void 0:i[ln])||null}onLoading(){const e=this._loader.gltf.extensions;e&&e[this.name]&&(this._variants=e[this.name].variants)}_loadMeshPrimitiveAsync(e,t,i,s,n,o){return st.LoadExtensionAsync(e,n,this.name,(a,l)=>{const c=new Array;return c.push(this._loader._loadMeshPrimitiveAsync(e,t,i,s,n,h=>{if(o(h),h instanceof G){const u=st._GetDrawMode(e,n.mode),d=this._loader.rootBabylonMesh,f=d?d._internalMetadata=d._internalMetadata||{}:{},p=f.gltf=f.gltf||{},_=p[ln]=p[ln]||{lastSelected:null,original:[],variants:{}};_.original.push({mesh:h,material:h.material});for(let m=0;m<l.mappings.length;++m){const g=l.mappings[m],b=Xe.Get(`${a}/mappings/${m}/material`,this._loader.gltf.materials,g.material);c.push(this._loader._loadMaterialAsync(`#/materials/${g.material}`,b,h,u,y=>{for(let T=0;T<g.variants.length;++T){const x=g.variants[T],S=Xe.Get(`/extensions/${ln}/variants/${x}`,this._variants,x);_.variants[S.name]=_.variants[S.name]||[],_.variants[S.name].push({mesh:h,material:y}),h.onClonedObservable.add(C=>{const D=C;let P=null,M=D;do{if(M=M.parent,!M)return;P=xc._GetExtensionMetadata(M)}while(null===P);if(d&&P===xc._GetExtensionMetadata(d)){M._internalMetadata={};for(const w in d._internalMetadata)M._internalMetadata[w]=d._internalMetadata[w];M._internalMetadata.gltf=[];for(const w in d._internalMetadata.gltf)M._internalMetadata.gltf[w]=d._internalMetadata.gltf[w];M._internalMetadata.gltf[ln]={lastSelected:null,original:[],variants:{}};for(const w of P.original)M._internalMetadata.gltf[ln].original.push({mesh:w.mesh,material:w.material});for(const w in P.variants)if(Object.prototype.hasOwnProperty.call(P.variants,w)){M._internalMetadata.gltf[ln].variants[w]=[];for(const k of P.variants[w])M._internalMetadata.gltf[ln].variants[w].push({mesh:k.mesh,material:k.material})}P=M._internalMetadata.gltf[ln]}for(const w of P.original)w.mesh===h&&(w.mesh=D);for(const w of P.variants[S.name])w.mesh===h&&(w.mesh=D)})}}))}}})),Promise.all(c).then(([h])=>h)})}}st.RegisterExtension(ln,r=>new xc(r));class H0{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:gh.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...H0._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new z,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(n=>this._options[n]!==e[n]).length)return;const i={...this._options,...e},s=this._options;this._options=i,i.renderSize===s.renderSize&&i.renderTargetTextureType===s.renderTargetTextureType&&i.generateMipmaps===s.generateMipmaps&&this._opaqueRenderTarget?(this._opaqueRenderTarget.samples=i.samples,this._opaqueRenderTarget.lodGenerationScale=i.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=i.lodGenerationOffset):this._setupRenderTargets()}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return!!e&&!!(e instanceof Ee&&e.subSurface.isRefractionEnabled)}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),q.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);-1!==t&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),-1!==t&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const t=this._transparentMeshesCache.indexOf(e),i=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof Ee&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),-1!==i?(this._opaqueMeshesCache.splice(i,1),this._transparentMeshesCache.push(e)):-1===t&&this._transparentMeshesCache.push(e)):-1!==t?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):-1===i&&this._opaqueMeshesCache.push(e)}_setupRenderTargets(){var e,t;let i,s;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new Ss("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=null!==(t=null===(e=this._options.clearColor)||void 0===e?void 0:e.clone())&&void 0!==t?t:this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.onBeforeBindObservable.add(n=>{s=this._scene.environmentIntensity,this._scene.environmentIntensity=1,i=this._scene.imageProcessingConfiguration.applyByPostProcess,this._options.clearColor?n.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(n.clearColor,this._scene.getEngine().useExactSrgbConversions),this._scene.imageProcessingConfiguration._applyByPostProcess=!0}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=s,this._scene.imageProcessingConfiguration._applyByPostProcess=i}),this._transparentMeshesCache.forEach(n=>{this._shouldRenderAsTransmission(n.material)&&(n.material.refractionTexture=this._opaqueRenderTarget)})}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const W0="KHR_materials_transmission";class lhe{constructor(e){this.name=W0,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(W0),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadTransparentPropertiesAsync(s,t,i,n)),Promise.all(o).then(()=>{})})}_loadTransparentPropertiesAsync(e,t,i,s){if(!(i instanceof Ee))throw new Error(`${e}: Material type not supported`);const n=i;if(n.subSurface.isRefractionEnabled=!0,n.subSurface.volumeIndexOfRefraction=1,n.subSurface.useAlbedoToTintRefraction=!0,void 0===s.transmissionFactor)return n.subSurface.refractionIntensity=0,n.subSurface.isRefractionEnabled=!1,Promise.resolve();{n.subSurface.refractionIntensity=s.transmissionFactor;const o=n.getScene();n.subSurface.refractionIntensity&&!o._transmissionHelper&&new H0({},n.getScene())}return n.subSurface.minimumThickness=0,n.subSurface.maximumThickness=0,s.transmissionTexture?(s.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,s.transmissionTexture,void 0).then(o=>{n.subSurface.refractionIntensityTexture=o,n.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}st.RegisterExtension(W0,r=>new lhe(r));const X0="KHR_materials_translucency";class che{constructor(e){this.name=X0,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(X0),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadTranslucentPropertiesAsync(s,t,i,n)),Promise.all(o).then(()=>{})})}_loadTranslucentPropertiesAsync(e,t,i,s){if(!(i instanceof Ee))throw new Error(`${e}: Material type not supported`);const n=i;return n.subSurface.isTranslucencyEnabled=!0,n.subSurface.volumeIndexOfRefraction=1,n.subSurface.minimumThickness=0,n.subSurface.maximumThickness=0,n.subSurface.useAlbedoToTintTranslucency=!0,void 0===s.translucencyFactor?(n.subSurface.translucencyIntensity=0,n.subSurface.isTranslucencyEnabled=!1,Promise.resolve()):(n.subSurface.translucencyIntensity=s.translucencyFactor,s.translucencyTexture?(s.translucencyTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/translucencyTexture`,s.translucencyTexture).then(o=>{n.subSurface.translucencyIntensityTexture=o})):Promise.resolve())}}st.RegisterExtension(X0,r=>new che(r));const j0="KHR_materials_volume";class hhe{constructor(e){this.name=j0,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(j0),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadVolumePropertiesAsync(s,t,i,n)),Promise.all(o).then(()=>{})})}_loadVolumePropertiesAsync(e,t,i,s){if(!(i instanceof Ee))throw new Error(`${e}: Material type not supported`);return(i.subSurface.isRefractionEnabled||i.subSurface.isTranslucencyEnabled)&&s.thicknessFactor?(i.subSurface.volumeIndexOfRefraction=i.indexOfRefraction,i.subSurface.tintColorAtDistance=void 0!==s.attenuationDistance?s.attenuationDistance:Number.MAX_VALUE,void 0!==s.attenuationColor&&3==s.attenuationColor.length&&i.subSurface.tintColor.copyFromFloats(s.attenuationColor[0],s.attenuationColor[1],s.attenuationColor[2]),i.subSurface.minimumThickness=0,i.subSurface.maximumThickness=s.thicknessFactor,i.subSurface.useThicknessAsDepth=!0,s.thicknessTexture?(s.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,s.thicknessTexture).then(o=>{i.subSurface.thicknessTexture=o,i.subSurface.useGltfStyleTextures=!0})):Promise.resolve()):Promise.resolve()}}st.RegisterExtension(j0,r=>new hhe(r));const Y0="KHR_mesh_quantization";class uhe{constructor(e){this.name=Y0,this.enabled=e.isExtensionUsed(Y0)}dispose(){}}st.RegisterExtension(Y0,r=>new uhe(r));const q0="KHR_texture_basisu";class dhe{constructor(e){this.name=q0,this._loader=e,this.enabled=e.isExtensionUsed(q0)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>{const o=null==t.sampler?st.DefaultSampler:Xe.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=Xe.Get(`${s}/source`,this._loader.gltf.images,n.source);return this._loader._createTextureAsync(e,o,a,l=>{i(l)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)})}}st.RegisterExtension(q0,r=>new dhe(r));const $0="KHR_texture_transform";class fhe{constructor(e){this.name=$0,this._loader=e,this.enabled=this._loader.isExtensionUsed($0)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>this._loader.loadTextureInfoAsync(e,t,o=>{if(!(o instanceof U))throw new Error(`${s}: Texture type not supported`);n.offset&&(o.uOffset=n.offset[0],o.vOffset=n.offset[1]),o.uRotationCenter=0,o.vRotationCenter=0,n.rotation&&(o.wAng=-n.rotation),n.scale&&(o.uScale=n.scale[0],o.vScale=n.scale[1]),null!=n.texCoord&&(o.coordinatesIndex=n.texCoord),i(o)}))}}st.RegisterExtension($0,r=>new fhe(r));const K0="KHR_xmp_json_ld";class phe{constructor(e){this.name=K0,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(K0)}dispose(){this._loader=null}onLoading(){var e,t,i;if(null===this._loader.rootBabylonMesh)return;const s=null===(e=this._loader.gltf.extensions)||void 0===e?void 0:e.KHR_xmp_json_ld,n=null===(i=null===(t=this._loader.gltf.asset)||void 0===t?void 0:t.extensions)||void 0===i?void 0:i.KHR_xmp_json_ld;if(s&&n){const o=+n.packet;s.packets&&o<s.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=s.packets[o])}}}function Ad(r,e,t,i){return re.FromArray(e,t).scale(i)}function Wi(r,e,t,i){return e[t]*i}function Q0(r,e,t,i){return-e[t]*i}function wb(r,e,t,i){return e[t+1]*i}function e5(r,e,t,i){return e[t]*i*2}function Z0(r){return{scale:[new Pi($.ANIMATIONTYPE_FLOAT,`${r}.uScale`,Wi,()=>2),new Pi($.ANIMATIONTYPE_FLOAT,`${r}.vScale`,wb,()=>2)],offset:[new Pi($.ANIMATIONTYPE_FLOAT,`${r}.uOffset`,Wi,()=>2),new Pi($.ANIMATIONTYPE_FLOAT,`${r}.vOffset`,wb,()=>2)],rotation:[new Pi($.ANIMATIONTYPE_FLOAT,`${r}.wAng`,Q0,()=>1)]}}st.RegisterExtension(K0,r=>new phe(r));class El extends v_{buildAnimations(e,t,i,s,n){n(e._babylonCamera,this._buildAnimation(t,i,s))}}class Pi extends v_{buildAnimations(e,t,i,s,n){for(const o in e._data)n(e._data[o].babylonMaterial,this._buildAnimation(t,i,s))}}class y_ extends v_{buildAnimations(e,t,i,s,n){n(e._babylonLight,this._buildAnimation(t,i,s))}}const mhe={__array__:{__target__:!0,...b_}},ghe={__array__:{__target__:!0,orthographic:{xmag:[new El($.ANIMATIONTYPE_FLOAT,"orthoLeft",Q0,()=>1),new El($.ANIMATIONTYPE_FLOAT,"orthoRight",wb,()=>1)],ymag:[new El($.ANIMATIONTYPE_FLOAT,"orthoBottom",Q0,()=>1),new El($.ANIMATIONTYPE_FLOAT,"orthoTop",wb,()=>1)],zfar:[new El($.ANIMATIONTYPE_FLOAT,"maxZ",Wi,()=>1)],znear:[new El($.ANIMATIONTYPE_FLOAT,"minZ",Wi,()=>1)]},perspective:{yfov:[new El($.ANIMATIONTYPE_FLOAT,"fov",Wi,()=>1)],zfar:[new El($.ANIMATIONTYPE_FLOAT,"maxZ",Wi,()=>1)],znear:[new El($.ANIMATIONTYPE_FLOAT,"minZ",Wi,()=>1)]}}},vhe={__array__:{__target__:!0,pbrMetallicRoughness:{baseColorFactor:[new Pi($.ANIMATIONTYPE_COLOR3,"albedoColor",Ad,()=>4),new Pi($.ANIMATIONTYPE_FLOAT,"alpha",function _he(r,e,t,i){return e[t+3]*i},()=>4)],metallicFactor:[new Pi($.ANIMATIONTYPE_FLOAT,"metallic",Wi,()=>1)],roughnessFactor:[new Pi($.ANIMATIONTYPE_FLOAT,"roughness",Wi,()=>1)],baseColorTexture:{extensions:{KHR_texture_transform:Z0("albedoTexture")}}},emissiveFactor:[new Pi($.ANIMATIONTYPE_COLOR3,"emissiveColor",Ad,()=>3)],normalTexture:{scale:[new Pi($.ANIMATIONTYPE_FLOAT,"bumpTexture.level",Wi,()=>1)]},occlusionTexture:{strength:[new Pi($.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",Wi,()=>1)],extensions:{KHR_texture_transform:Z0("ambientTexture")}},emissiveTexture:{extensions:{KHR_texture_transform:Z0("emissiveTexture")}},extensions:{KHR_materials_ior:{ior:[new Pi($.ANIMATIONTYPE_FLOAT,"indexOfRefraction",Wi,()=>1)]},KHR_materials_clearcoat:{clearcoatFactor:[new Pi($.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",Wi,()=>1)],clearcoatRoughnessFactor:[new Pi($.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",Wi,()=>1)]},KHR_materials_sheen:{sheenColorFactor:[new Pi($.ANIMATIONTYPE_COLOR3,"sheen.color",Ad,()=>3)],sheenRoughnessFactor:[new Pi($.ANIMATIONTYPE_FLOAT,"sheen.roughness",Wi,()=>1)]},KHR_materials_specular:{specularFactor:[new Pi($.ANIMATIONTYPE_FLOAT,"metallicF0Factor",Wi,()=>1)],specularColorFactor:[new Pi($.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",Ad,()=>3)]},KHR_materials_emissive_strength:{emissiveStrength:[new Pi($.ANIMATIONTYPE_FLOAT,"emissiveIntensity",Wi,()=>1)]},KHR_materials_transmission:{transmissionFactor:[new Pi($.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",Wi,()=>1)]},KHR_materials_volume:{attenuationColor:[new Pi($.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",Ad,()=>3)],attenuationDistance:[new Pi($.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",Wi,()=>1)],thicknessFactor:[new Pi($.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",Wi,()=>1)]},KHR_materials_iridescence:{iridescenceFactor:[new Pi($.ANIMATIONTYPE_FLOAT,"iridescence.intensity",Wi,()=>1)],iridescenceIor:[new Pi($.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",Wi,()=>1)],iridescenceThicknessMinimum:[new Pi($.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",Wi,()=>1)],iridescenceThicknessMaximum:[new Pi($.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",Wi,()=>1)]}}}},yhe={nodes:mhe,materials:vhe,cameras:ghe,extensions:{KHR_lights_punctual:{lights:{__array__:{__target__:!0,color:[new y_($.ANIMATIONTYPE_COLOR3,"diffuse",Ad,()=>3)],intensity:[new y_($.ANIMATIONTYPE_FLOAT,"intensity",Wi,()=>1)],range:[new y_($.ANIMATIONTYPE_FLOAT,"range",Wi,()=>1)],spot:{innerConeAngle:[new y_($.ANIMATIONTYPE_FLOAT,"innerAngle",e5,()=>1)],outerConeAngle:[new y_($.ANIMATIONTYPE_FLOAT,"angle",e5,()=>1)]}}}}}},J0="KHR_animation_pointer";class xhe{constructor(e){this.name=J0,this._loader=e}get enabled(){return this._loader.isExtensionUsed(J0)}dispose(){this._loader=null}_loadAnimationChannelAsync(e,t,i,s,n){var o;const a=null===(o=s.target.extensions)||void 0===o?void 0:o.KHR_animation_pointer;if(!a)return null;"pointer"!==s.target.path&&V.Warn(`${e}/target/path: Value (${s.target.path}) must be (pointer) when using the ${this.name} extension`),null!=s.target.node&&V.Warn(`${e}/target/node: Value (${s.target.node}) must not be present when using the ${this.name} extension`);const l=`${e}/extensions/${this.name}`,c=a.pointer;if(!c)throw new Error(`${l}: Pointer is missing`);const h=this._parseAnimationPointer(`${l}/pointer`,c);return h?this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,i,s,h,n):(V.Warn(`${l}/pointer: Invalid pointer (${c}) skipped`),null)}_parseAnimationPointer(e,t){if(!t.startsWith("/"))return V.Warn(`${e}: Value (${t}) must start with a slash`),null;const i=t.split("/");i.shift();let o,s=yhe,n=this._loader.gltf;for(const a of i){if(s.__array__)s=s.__array__;else if(s=s[a],!s)return null;n=n&&n[a],s.__target__&&(o=n)}return o&&Array.isArray(s)?{target:o,properties:s}:null}}st.RegisterExtension(J0,r=>new xhe(r));const eA="MSFT_audio_emitter";class The{constructor(e){this.name=eA,this._loader=e,this.enabled=this._loader.isExtensionUsed(eA)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,Xe.Assign(this._clips),Xe.Assign(this._emitters)}}loadSceneAsync(e,t){return st.LoadExtensionAsync(e,t,this.name,(i,s)=>{const n=new Array;n.push(this._loader.loadSceneAsync(e,t));for(const o of s.emitters){const a=Xe.Get(`${i}/emitters`,this._emitters,o);if(null!=a.refDistance||null!=a.maxDistance||null!=a.rolloffFactor||null!=a.distanceModel||null!=a.innerAngle||null!=a.outerAngle)throw new Error(`${i}: Direction or Distance properties are not allowed on emitters attached to a scene`);n.push(this._loadEmitterAsync(`${i}/emitters/${a.index}`,a))}return Promise.all(n).then(()=>{})})}loadNodeAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>{const o=new Array;return this._loader.loadNodeAsync(s,t,a=>{for(const l of n.emitters){const c=Xe.Get(`${s}/emitters`,this._emitters,l);o.push(this._loadEmitterAsync(`${s}/emitters/${c.index}`,c).then(()=>{for(const h of c._babylonSounds)h.attachToMesh(a),(null!=c.innerAngle||null!=c.outerAngle)&&(h.setLocalDirectionToMesh(v.Forward()),h.setDirectionalCone(2*q.ToDegrees(c.innerAngle??Math.PI),2*q.ToDegrees(c.outerAngle??Math.PI),0))}))}i(a)}).then(a=>Promise.all(o).then(()=>a))})}loadAnimationAsync(e,t){return st.LoadExtensionAsync(e,t,this.name,(i,s)=>this._loader.loadAnimationAsync(e,t).then(n=>{const o=new Array;Xe.Assign(s.events);for(const a of s.events)o.push(this._loadAnimationEventAsync(`${i}/events/${a.index}`,e,t,a,n));return Promise.all(o).then(()=>n)}))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let i;if(t.uri)i=this._loader.loadUriAsync(e,t,t.uri);else{const s=Xe.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);i=this._loader.loadBufferViewAsync(`/bufferViews/${s.index}`,s)}return t._objectURL=i.then(s=>URL.createObjectURL(new Blob([s],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const i=new Array,s=t.name||`emitter${t.index}`,n={loop:!1,autoplay:!1,volume:t.volume??1};for(let a=0;a<t.clips.length;a++){const l=`/extensions/${this.name}/clips`,c=Xe.Get(l,this._clips,t.clips[a].clip);i.push(this._loadClipAsync(`${l}/${t.clips[a].clip}`,c).then(h=>{const u=t._babylonSounds[a]=new mp(s,h,this._loader.babylonScene,null,n);u.refDistance=t.refDistance||1,u.maxDistance=t.maxDistance||256,u.rolloffFactor=t.rolloffFactor||1,u.distanceModel=t.distanceModel||"exponential"}))}const o=Promise.all(i).then(()=>{const a=t.clips.map(c=>c.weight||1),l=new _se(t.loop||!1,t._babylonSounds,a);t.innerAngle&&(l.directionalConeInnerAngle=2*q.ToDegrees(t.innerAngle)),t.outerAngle&&(l.directionalConeOuterAngle=2*q.ToDegrees(t.outerAngle)),t.volume&&(l.volume=t.volume),t._babylonData.sound=l});t._babylonData={loaded:o}}return t._babylonData.loaded}_getEventAction(e,t,i,s,n){switch(i){case"play":return o=>{t.play((n||0)+(o-s))};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${i}`)}}_loadAnimationEventAsync(e,t,i,s,n){if(0==n.targetedAnimations.length)return Promise.resolve();const o=n.targetedAnimations[0],l=Xe.Get(`/extensions/${this.name}/emitters`,this._emitters,s.emitter);return this._loadEmitterAsync(e,l).then(()=>{const c=l._babylonData.sound;if(c){const h=new bE(s.time,this._getEventAction(e,c,s.action,s.time,s.startOffset));o.animation.addEvent(h),n.onAnimationGroupEndObservable.add(()=>{c.stop()}),n.onAnimationGroupPauseObservable.add(()=>{c.pause()})}})}}st.RegisterExtension(eA,r=>new The(r));const tA="MSFT_lod";class She{constructor(e){this.name=tA,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new z,this.onMaterialLODsLoadedObservable=new z,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed(tA)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const t=Promise.all(this._nodePromiseLODs[e]).then(()=>{0!==e&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){const t=Promise.all(this._materialPromiseLODs[e]).then(()=>{0!==e&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){const i=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),i}loadNodeAsync(e,t,i){return st.LoadExtensionAsync(e,t,this.name,(s,n)=>{let o;const a=this._getLODs(s,t,this._loader.gltf.nodes,n.ids);this._loader.logOpen(`${s}`);for(let l=0;l<a.length;l++){const c=a[l];0!==l&&(this._nodeIndexLOD=l,this._nodeSignalLODs[l]=this._nodeSignalLODs[l]||new Jp);const u=this._loader.loadNodeAsync(`/nodes/${c.index}`,c,d=>{i(d),d.setEnabled(!1)}).then(d=>{if(0!==l){const f=a[l-1];f._babylonTransformNode&&(this._disposeTransformNode(f._babylonTransformNode),delete f._babylonTransformNode)}return d.setEnabled(!0),d});this._nodePromiseLODs[l]=this._nodePromiseLODs[l]||[],0===l?o=u:(this._nodeIndexLOD=null,this._nodePromiseLODs[l].push(u))}return this._loader.logClose(),o})}_loadMaterialAsync(e,t,i,s,n){return this._nodeIndexLOD?null:st.LoadExtensionAsync(e,t,this.name,(o,a)=>{let l;const c=this._getLODs(o,t,this._loader.gltf.materials,a.ids);this._loader.logOpen(`${o}`);for(let h=0;h<c.length;h++){const u=c[h];0!==h&&(this._materialIndexLOD=h);const d=this._loader._loadMaterialAsync(`/materials/${u.index}`,u,i,s,f=>{0===h&&n(f)}).then(f=>{if(0!==h){n(f);const p=c[h-1]._data;p[s]&&(this._disposeMaterials([p[s].babylonMaterial]),delete p[s])}return f});this._materialPromiseLODs[h]=this._materialPromiseLODs[h]||[],0===h?l=d:(this._materialIndexLOD=null,this._materialPromiseLODs[h].push(d))}return this._loader.logClose(),l})}_loadUriAsync(e,t,i){if(null!==this._nodeIndexLOD){this._loader.log("deferred");const s=this._nodeIndexLOD-1;return this._nodeSignalLODs[s]=this._nodeSignalLODs[s]||new Jp,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(()=>this._loader.loadUriAsync(e,t,i))}if(null!==this._materialIndexLOD){this._loader.log("deferred");const s=this._materialIndexLOD-1;return this._materialSignalLODs[s]=this._materialSignalLODs[s]||new Jp,this._materialSignalLODs[s].promise.then(()=>this._loader.loadUriAsync(e,t,i))}return null}loadBufferAsync(e,t,i,s){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const n=(o,a)=>{const l=i,c=l+s-1;let h=o[a];return h?(h.start=Math.min(h.start,l),h.end=Math.max(h.end,c)):(h={start:l,end:c,loaded:new Jp},o[a]=h),h.loaded.promise.then(u=>new Uint8Array(u.buffer,u.byteOffset+i-h.start,s))};return this._loader.log("deferred"),null!==this._nodeIndexLOD?n(this._nodeBufferLODs,this._nodeIndexLOD):null!==this._materialIndexLOD?n(this._materialBufferLODs,this._materialIndexLOD):n(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){const i=e[t];i&&(this._loader.log(`Loading buffer range [${i.start}-${i.end}]`),this._loader.bin.readAsync(i.start,i.end-i.start+1).then(s=>{i.loaded.resolve(s)},s=>{i.loaded.reject(s)}))}_getLODs(e,t,i,s){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const n=new Array;for(let o=s.length-1;o>=0;o--)if(n.push(Xe.Get(`${e}/ids/${s[o]}`,i,s[o])),n.length===this.maxLODsToLoad)return n;return n.push(t),n}_disposeTransformNode(e){const t=new Array,i=e.material;i&&t.push(i);for(const n of e.getChildMeshes())n.material&&t.push(n.material);e.dispose();const s=t.filter(n=>this._loader.babylonScene.meshes.every(o=>o.material!=n));this._disposeMaterials(s)}_disposeMaterials(e){const t={};for(const i of e){for(const s of i.getActiveTextures())t[s.uniqueId]=s;i.dispose()}for(const i in t)for(const s of this._loader.babylonScene.materials)s.hasTexture(t[i])&&delete t[i];for(const i in t)t[i].dispose()}}st.RegisterExtension(tA,r=>new She(r));const iA="MSFT_minecraftMesh";class Ehe{constructor(e){this.name=iA,this._loader=e,this.enabled=this._loader.isExtensionUsed(iA)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return st.LoadExtraAsync(e,t,this.name,(s,n)=>{if(n){if(!(i instanceof Ee))throw new Error(`${s}: Material type not supported`);const o=this._loader.loadMaterialPropertiesAsync(e,t,i);return i.needAlphaBlending()&&(i.forceDepthWrite=!0,i.separateCullingPass=!0),i.backFaceCulling=i.forceDepthWrite,i.twoSidedLighting=!0,o}return null})}}st.RegisterExtension(iA,r=>new Ehe(r));const sA="MSFT_sRGBFactors";class Che{constructor(e){this.name=sA,this._loader=e,this.enabled=this._loader.isExtensionUsed(sA)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return st.LoadExtraAsync(e,t,this.name,(s,n)=>{if(n){if(!(i instanceof Ee))throw new Error(`${s}: Material type not supported`);const o=this._loader.loadMaterialPropertiesAsync(e,t,i),a=i.getScene().getEngine().useExactSrgbConversions;return i.albedoTexture||i.albedoColor.toLinearSpaceToRef(i.albedoColor,a),i.reflectivityTexture||i.reflectivityColor.toLinearSpaceToRef(i.reflectivityColor,a),o}return null})}}st.RegisterExtension(sA,r=>new Che(r));const t5="ExtrasAsMetadata";class Ahe{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){const i=e.metadata=e.metadata||{};(i.gltf=i.gltf||{}).extras=t.extras}}constructor(e){this.name=t5,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,i){return this._loader.loadNodeAsync(e,t,s=>{this._assignExtras(s,t),i(s)})}loadCameraAsync(e,t,i){return this._loader.loadCameraAsync(e,t,s=>{this._assignExtras(s,t),i(s)})}createMaterial(e,t,i){const s=this._loader.createMaterial(e,t,i);return this._assignExtras(s,t),s}}st.RegisterExtension(t5,r=>new Ahe(r));const Rhe=[{path:"",component:Gte},{path:"Rules",component:Uee},{path:"Model/Questions",component:Wte},{path:"Model",component:(()=>{class r{constructor(t,i,s){this.router=t,this.data=i,this.route=s,this.animating_1=!0,this.animating_2=!0}ngOnInit(){var t=this;return Qt(function*(){const i=document.querySelector("canvas");t.engine=new ee(i,!0),t.scene=yield t.CreateScene(),t.CreateGroud(),t.CreatePlayStarter(t.scene,1,.35,0),t.CreatePlayStarter2(t.scene,1.8,.35,1),t.CreatePlayStarter3(t.scene,2.6,.35,0),t.CreatePlayStarter4(t.scene,4,.35,1),t.CreatePlayStarter5(t.scene,4.5,.35,0),console.log(t.data.getNames()),t.player1nom=t.data.getName(0),t.player2nom=t.data.getName(1);const s=document.getElementById("joueur1"),n=document.getElementById("joueur2");t.majPoints(),s.innerHTML=t.player1nom+": "+t.data.getP1()+" points",n.innerHTML=t.player2nom+": "+t.data.getP2()+" points";const o=yield t.CreateCommbatant(t.scene);o.setPositionWithLocalVector(new v(.5,0,0));const a=yield t.CreateCommbatant2(t.scene),l=.03,c=t.scene.getAnimationGroupByName("walk"),h=t.scene.getAnimationGroupByName("doubleAttack"),u=t.scene.getAnimationGroupByName("Armature|mixamo.com|Layer0"),d=t.scene.getAnimationGroupByName("walking"),f=t.scene.getAnimationGroupByName("block"),p=t.scene.getAnimationGroupByName("run"),_=t.scene.getAnimationGroupByName("runback"),m=t.scene.getAnimationGroupByName("id"),g=t.scene.getAnimationGroupByName("coupDePiedAllonger"),y=(t.scene.getAnimationGroupByName("coupDePied"),t.scene.getAnimationGroupByName("coupDePointPuissant")),T={};t.scene.actionManager=new Qc(t.scene),t.scene.actionManager.registerAction(new Ug(Qc.OnKeyDownTrigger,function(M){T[M.sourceEvent.key]="keydown"==M.sourceEvent.type})),t.scene.actionManager.registerAction(new Ug(Qc.OnKeyUpTrigger,function(M){T[M.sourceEvent.key]="keydown"==M.sourceEvent.type})),t.scene.onBeforeRenderObservable.add(()=>{var M=!1;T.s&&(o.moveWithCollisions(o.forward.scaleInPlace(l)),M=!0),T.x&&(o.moveWithCollisions(o.forward.scaleInPlace(-l)),M=!0),T.w&&(o.rotate(v.Up(),-.1),M=!0),T.c&&(o.rotate(v.Up(),.1),M=!0),T.d&&h?.start(!1,1,h?.from,h.to,!1),T.g&&(a.moveWithCollisions(a.forward.scaleInPlace(l)),M=!0),T.b&&(a.moveWithCollisions(a.forward.scaleInPlace(-l)),M=!0),T.v&&(a.rotate(v.Up(),-.1),M=!0),T.n&&(a.rotate(v.Up(),.1),M=!0),T.h&&g?.start(!1,1,g?.from,g?.to,!1),T.j&&y?.start(!1,1,y?.from,y?.to,!1),M?t.animating_1||(t.animating_1=!0,T.s&&d?.start(!0,1,d.from,d.to,!1),T.g&&p?.start(!0,1,p.from,p.to,!1),T.b&&_?.start(!0,1,_.from,_.to,!1)):t.animating_1&&(g?.stop(),_?.stop(),p?.stop(),c?.stop(),d?.stop(),h?.stop(),u?.stop(),m?.start(),f?.start(),t.animating_1=!1)});const x=t.CreateBox("Niveau 1").setPositionWithLocalVector(new v(1,-.01,0)),S=t.CreateBox("Niveau 2").setPositionWithLocalVector(new v(1.8,0,1)),C=t.CreateBox("Niveau 3").setPositionWithLocalVector(new v(2.6,-.01,0)),D=t.CreateBox("Niveau 4").setPositionWithLocalVector(new v(4,0,1)),P=t.CreateBox("Niveau 5").setPositionWithLocalVector(new v(4.5,-.01,0));console.log(t.data.getP1(),t.data.getP1()),t.data.getP1()+t.data.getP2()==0?(x.setEnabled(!0),S.setEnabled(!1),C.setEnabled(!1),D.setEnabled(!1),P.setEnabled(!1)):t.data.getP1()+t.data.getP2()==1?(x.setEnabled(!1),S.setEnabled(!0),C.setEnabled(!1),D.setEnabled(!1),P.setEnabled(!1)):t.data.getP1()+t.data.getP2()==2?(x.setEnabled(!1),S.setEnabled(!1),C.setEnabled(!0),D.setEnabled(!1),P.setEnabled(!1)):t.data.getP1()+t.data.getP2()==3?(x.setEnabled(!1),S.setEnabled(!1),C.setEnabled(!1),D.setEnabled(!0),P.setEnabled(!1)):t.data.getP1()+t.data.getP2()==4?(x.setEnabled(!1),S.setEnabled(!1),C.setEnabled(!1),D.setEnabled(!1),P.setEnabled(!0)):t.data.getP1()+t.data.getP2()==5&&(x.setEnabled(!1),S.setEnabled(!1),C.setEnabled(!1),D.setEnabled(!1),P.setEnabled(!1),t.data.getP1()>t.data.getP2()?(console.log(t.data.getP1(),t.data.getP2()),t.partieTermine("Fin de la partie "+t.player1nom+" a gagne!")):(console.log(t.pointsJ1,t.pointsJ2),t.partieTermine("Fin de la partie "+t.player2nom+" a gagne!")))})()}majPoints(){this.data.getGagnantBox()==this.player1nom?this.data.setP1():this.data.getGagnantBox()==this.player2nom&&this.data.setP2(),this.data.viderGagnantBox()}CreateBox(t){const i=Dh.CreateBox("box",{size:.3},this.scene),s=new fe("material",this.scene);s.diffuseColor=new re(.5,.5,1),i.material=s;const n=new ic("dynamicTexture",{width:490,height:240},this.scene);return s.diffuseTexture=n,n.drawText(t,20,80,"bold 60px Arial","white","transparent",!0),i.actionManager=new Qc(this.scene),i.actionManager.registerAction(new Ug(Qc.OnLeftPickTrigger,c=>{this.router.navigate(["Model","Questions"])})),i}ChangePageDialogBox(){this.router.navigate(["Model","Questions"])}partieTermine(t){const i=document.getElementById("endPartie"),s=document.querySelector("#acc");document.getElementById("phraseFin").innerHTML=t,i.style.display="block",s.addEventListener("click",()=>{this.router.navigate([""])})}CreateScene(){var t=this;return Qt(function*(){t.engine.enableOfflineSupport=!1;const i=new ge(t.engine),s=new lr("camera",new v(2.2,.75,-3.2),t.scene);s.attachControl(),s.speed=.25;const n=os.CreateFromPrefilteredData("../../assets/env/sky.env",i);return i.environmentTexture=n,i.createDefaultSkybox(n,!0),i.environmentIntensity=1,i})()}CreatePlayStarter(t,i,s,n){this.octahedron1=Dh.CreatePolyhedron("octahedron",{type:1,size:.14},this.scene),this.octahedron1.setPositionWithLocalVector(new v(i,s,n));let o=new Ee("material",t);o.metallic=.8,o.roughness=.5;var a=new fe("material",t);return a.diffuseTexture=new U("assets/textures/painted_concrete_diff_4k.jpg",this.scene),this.octahedron1.material=a,new jn("light",new v(0,1,-1),this.scene).specular=new re(0,.5,0),this.engine.runRenderLoop(()=>{this.scene.render(),this.octahedron1.rotation.y+=.01}),t}CreatePlayStarter2(t,i,s,n){this.octahedron2=Dh.CreatePolyhedron("octahedron",{type:1,size:.14},this.scene),this.octahedron2.setPositionWithLocalVector(new v(i,s,n));let o=new Ee("material",t);o.metallic=.8,o.roughness=.5;var a=new fe("material",t);return a.diffuseTexture=new U("assets/textures/painted_concrete_diff_4k.jpg",this.scene),this.octahedron2.material=a,new jn("light",new v(0,1,-1),this.scene).specular=new re(0,.5,0),this.engine.runRenderLoop(()=>{this.scene.render(),this.octahedron2.rotation.y+=.01}),t}CreatePlayStarter3(t,i,s,n){this.octahedron3=Dh.CreatePolyhedron("octahedron",{type:1,size:.14},this.scene),this.octahedron3.setPositionWithLocalVector(new v(i,s,n));let o=new Ee("material",t);o.metallic=.8,o.roughness=.5;var a=new fe("material",t);return a.diffuseTexture=new U("assets/textures/painted_concrete_diff_4k.jpg",this.scene),this.octahedron3.material=a,new jn("light",new v(0,1,-1),this.scene).specular=new re(0,.5,0),this.engine.runRenderLoop(()=>{this.scene.render(),this.octahedron3.rotation.y+=.01}),t}CreatePlayStarter4(t,i,s,n){this.octahedron4=Dh.CreatePolyhedron("octahedron",{type:1,size:.14},this.scene),this.octahedron4.setPositionWithLocalVector(new v(i,s,n));let o=new Ee("material",t);o.metallic=.8,o.roughness=.5;var a=new fe("material",t);return a.diffuseTexture=new U("assets/textures/painted_concrete_diff_4k.jpg",this.scene),this.octahedron4.material=a,new jn("light",new v(0,1,-1),this.scene).specular=new re(0,.5,0),this.engine.runRenderLoop(()=>{this.scene.render(),this.octahedron4.rotation.y+=.01}),t}CreatePlayStarter5(t,i,s,n){this.octahedron5=Dh.CreatePolyhedron("octahedron",{type:1,size:.14},this.scene),this.octahedron5.setPositionWithLocalVector(new v(i,s,n));let o=new Ee("material",t);o.metallic=.8,o.roughness=.5;var a=new fe("material",t);return a.diffuseTexture=new U("assets/textures/painted_concrete_diff_4k.jpg",this.scene),this.octahedron5.material=a,new jn("light",new v(0,1,-1),this.scene).specular=new re(0,.5,0),this.engine.runRenderLoop(()=>{this.scene.render(),this.octahedron5.rotation.y+=.01}),t}CreateGroud(){Dh.CreateGround("groud",{width:100,height:10},this.scene).material=this.CreateAsphalt()}CreateAsphalt(){const t=new Ee("pbr",this.scene);return t.albedoTexture=new U("/assets/textures/asphalt_diffuse.jpg",this.scene),t.bumpTexture=new U("/assets/textures/asphalt_normal.jpg",this.scene),t.invertNormalMapX=!0,t.invertNormalMapY=!0,t.roughness=1,t.useAmbientOcclusionFromMetallicTextureRed=!0,t.useRoughnessFromMetallicTextureGreen=!0,t.useMetallnessFromMetallicTextureBlue=!0,t.metallicTexture=new U("/assets/textures/asphalt_ao_rough_metal.jpg",this.scene),t}CreateBarrel(){return Qt(function*(){const{meshes:t}=yield ke.ImportMeshAsync("","/assets/models/","Barrel.glb");console.log("meshes",t)})()}intersectsBox(t,i){return!(t.maximum.x<i.minimum.x||t.minimum.x>i.maximum.x||t.maximum.y<i.minimum.y||t.minimum.y>i.maximum.y||t.maximum.z<i.minimum.z||t.minimum.z>i.maximum.z)}CreateCommbatant(t){return Qt(function*(){const{meshes:i,animationGroups:s,skeletons:n}=yield ke.ImportMeshAsync("","/assets/models/","combattant5.glb",t);console.log("meshes",i),console.log(s),console.log(n),s[0].stop();const o=i[0];return o.scaling.scaleInPlace(.5),o})()}CreateCommbatant2(t){return Qt(function*(){const{meshes:i,animationGroups:s,skeletons:n}=yield ke.ImportMeshAsync("","/assets/models/","guerrier.glb",t);console.log("meshes",i),console.log(s),console.log(n),s[0].stop();const o=i[0];o.scaling.scaleInPlace(.5),t.getAnimationGroupByName("walk"),t.getAnimationGroupByName("doubleAttack"),t.getAnimationGroupByName("Armature|mixamo.com|Layer0");const d=t.getAnimationGroupByName("walking");return console.log(d),o})()}}return r.\u0275fac=function(t){return new(t||r)(xe(Hs),xe(Ag),xe(zl))},r.\u0275cmp=Il({type:r,selectors:[["app-model"]],decls:11,vars:0,consts:[[2,"position","relative"],["id","renderCanvas"],["type","text","id","joueur1",2,"position","absolute","top","10%","left","10%","background-color","white","border","2px solid black","border-radius","4px"],["type","text","id","joueur2",2,"position","absolute","top","10%","right","10%","background-color","white","border","2px solid black","border-radius","4px"],["id","endPartie",1,"modal"],[1,"modal-content"],["id","phraseFin"],["id","acc",2,"top","-180pt","left","150pt"]],template:function(t,i){1&t&&(ut(0,"div",0),oi(1,"canvas",1),ut(2,"div",2),oi(3,"h2"),bt(),ut(4,"div",3),oi(5,"h2"),bt()(),ut(6,"div",4)(7,"div",5),oi(8,"p",6),ut(9,"button",7),ii(10,"Rejouer"),bt()()())},styles:["canvas[_ngcontent-%COMP%]{width:100%;height:100%;position:relative;bottom:0}divgauche[_ngcontent-%COMP%]{border:2px solid black;border-radius:4px;position:absolute;top:10%;left:10%;background-color:#fff}divdroit[_ngcontent-%COMP%]{border:2px solid black;border-radius:4px;position:absolute;top:10%;right:10%;background-color:#fff}.modal[_ngcontent-%COMP%]{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:#0006}.modal-content[_ngcontent-%COMP%]{background-color:#fefefe;margin:15% auto;padding:20px;border:1px solid #888;width:80%;max-width:400px;text-align:center}"]}),r})()}];let Ihe=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=io({type:r}),r.\u0275inj=Rn({imports:[IN.forRoot(Rhe),IN]}),r})();class i5{}class s5{}class Cl{constructor(e){this.normalizedNames=new Map,this.lazyUpdate=null,e?this.lazyInit="string"==typeof e?()=>{this.headers=new Map,e.split("\n").forEach(t=>{const i=t.indexOf(":");if(i>0){const s=t.slice(0,i),n=s.toLowerCase(),o=t.slice(i+1).trim();this.maybeSetNormalizedName(s,n),this.headers.has(n)?this.headers.get(n).push(o):this.headers.set(n,[o])}})}:()=>{this.headers=new Map,Object.keys(e).forEach(t=>{let i=e[t];const s=t.toLowerCase();"string"==typeof i&&(i=[i]),i.length>0&&(this.headers.set(s,i),this.maybeSetNormalizedName(t,s))})}:this.headers=new Map}has(e){return this.init(),this.headers.has(e.toLowerCase())}get(e){this.init();const t=this.headers.get(e.toLowerCase());return t&&t.length>0?t[0]:null}keys(){return this.init(),Array.from(this.normalizedNames.values())}getAll(e){return this.init(),this.headers.get(e.toLowerCase())||null}append(e,t){return this.clone({name:e,value:t,op:"a"})}set(e,t){return this.clone({name:e,value:t,op:"s"})}delete(e,t){return this.clone({name:e,value:t,op:"d"})}maybeSetNormalizedName(e,t){this.normalizedNames.has(t)||this.normalizedNames.set(t,e)}init(){this.lazyInit&&(this.lazyInit instanceof Cl?this.copyFrom(this.lazyInit):this.lazyInit(),this.lazyInit=null,this.lazyUpdate&&(this.lazyUpdate.forEach(e=>this.applyUpdate(e)),this.lazyUpdate=null))}copyFrom(e){e.init(),Array.from(e.headers.keys()).forEach(t=>{this.headers.set(t,e.headers.get(t)),this.normalizedNames.set(t,e.normalizedNames.get(t))})}clone(e){const t=new Cl;return t.lazyInit=this.lazyInit&&this.lazyInit instanceof Cl?this.lazyInit:this,t.lazyUpdate=(this.lazyUpdate||[]).concat([e]),t}applyUpdate(e){const t=e.name.toLowerCase();switch(e.op){case"a":case"s":let i=e.value;if("string"==typeof i&&(i=[i]),0===i.length)return;this.maybeSetNormalizedName(e.name,t);const s=("a"===e.op?this.headers.get(t):void 0)||[];s.push(...i),this.headers.set(t,s);break;case"d":const n=e.value;if(n){let o=this.headers.get(t);if(!o)return;o=o.filter(a=>-1===n.indexOf(a)),0===o.length?(this.headers.delete(t),this.normalizedNames.delete(t)):this.headers.set(t,o)}else this.headers.delete(t),this.normalizedNames.delete(t)}}forEach(e){this.init(),Array.from(this.normalizedNames.keys()).forEach(t=>e(this.normalizedNames.get(t),this.headers.get(t)))}}class Mhe{encodeKey(e){return r5(e)}encodeValue(e){return r5(e)}decodeKey(e){return decodeURIComponent(e)}decodeValue(e){return decodeURIComponent(e)}}const Dhe=/%(\d[a-f0-9])/gi,whe={40:"@","3A":":",24:"$","2C":",","3B":";","3D":"=","3F":"?","2F":"/"};function r5(r){return encodeURIComponent(r).replace(Dhe,(e,t)=>whe[t]??e)}function Ob(r){return`${r}`}class Tc{constructor(e={}){if(this.updates=null,this.cloneFrom=null,this.encoder=e.encoder||new Mhe,e.fromString){if(e.fromObject)throw new Error("Cannot specify both fromString and fromObject.");this.map=function Phe(r,e){const t=new Map;return r.length>0&&r.replace(/^\?/,"").split("&").forEach(s=>{const n=s.indexOf("="),[o,a]=-1==n?[e.decodeKey(s),""]:[e.decodeKey(s.slice(0,n)),e.decodeValue(s.slice(n+1))],l=t.get(o)||[];l.push(a),t.set(o,l)}),t}(e.fromString,this.encoder)}else e.fromObject?(this.map=new Map,Object.keys(e.fromObject).forEach(t=>{const i=e.fromObject[t],s=Array.isArray(i)?i.map(Ob):[Ob(i)];this.map.set(t,s)})):this.map=null}has(e){return this.init(),this.map.has(e)}get(e){this.init();const t=this.map.get(e);return t?t[0]:null}getAll(e){return this.init(),this.map.get(e)||null}keys(){return this.init(),Array.from(this.map.keys())}append(e,t){return this.clone({param:e,value:t,op:"a"})}appendAll(e){const t=[];return Object.keys(e).forEach(i=>{const s=e[i];Array.isArray(s)?s.forEach(n=>{t.push({param:i,value:n,op:"a"})}):t.push({param:i,value:s,op:"a"})}),this.clone(t)}set(e,t){return this.clone({param:e,value:t,op:"s"})}delete(e,t){return this.clone({param:e,value:t,op:"d"})}toString(){return this.init(),this.keys().map(e=>{const t=this.encoder.encodeKey(e);return this.map.get(e).map(i=>t+"="+this.encoder.encodeValue(i)).join("&")}).filter(e=>""!==e).join("&")}clone(e){const t=new Tc({encoder:this.encoder});return t.cloneFrom=this.cloneFrom||this,t.updates=(this.updates||[]).concat(e),t}init(){null===this.map&&(this.map=new Map),null!==this.cloneFrom&&(this.cloneFrom.init(),this.cloneFrom.keys().forEach(e=>this.map.set(e,this.cloneFrom.map.get(e))),this.updates.forEach(e=>{switch(e.op){case"a":case"s":const t=("a"===e.op?this.map.get(e.param):void 0)||[];t.push(Ob(e.value)),this.map.set(e.param,t);break;case"d":if(void 0===e.value){this.map.delete(e.param);break}{let i=this.map.get(e.param)||[];const s=i.indexOf(Ob(e.value));-1!==s&&i.splice(s,1),i.length>0?this.map.set(e.param,i):this.map.delete(e.param)}}}),this.cloneFrom=this.updates=null)}}class Ohe{constructor(){this.map=new Map}set(e,t){return this.map.set(e,t),this}get(e){return this.map.has(e)||this.map.set(e,e.defaultValue()),this.map.get(e)}delete(e){return this.map.delete(e),this}has(e){return this.map.has(e)}keys(){return this.map.keys()}}function n5(r){return typeof ArrayBuffer<"u"&&r instanceof ArrayBuffer}function o5(r){return typeof Blob<"u"&&r instanceof Blob}function a5(r){return typeof FormData<"u"&&r instanceof FormData}class x_{constructor(e,t,i,s){let n;if(this.url=t,this.body=null,this.reportProgress=!1,this.withCredentials=!1,this.responseType="json",this.method=e.toUpperCase(),function Nhe(r){switch(r){case"DELETE":case"GET":case"HEAD":case"OPTIONS":case"JSONP":return!1;default:return!0}}(this.method)||s?(this.body=void 0!==i?i:null,n=s):n=i,n&&(this.reportProgress=!!n.reportProgress,this.withCredentials=!!n.withCredentials,n.responseType&&(this.responseType=n.responseType),n.headers&&(this.headers=n.headers),n.context&&(this.context=n.context),n.params&&(this.params=n.params)),this.headers||(this.headers=new Cl),this.context||(this.context=new Ohe),this.params){const o=this.params.toString();if(0===o.length)this.urlWithParams=t;else{const a=t.indexOf("?");this.urlWithParams=t+(-1===a?"?":a<t.length-1?"&":"")+o}}else this.params=new Tc,this.urlWithParams=t}serializeBody(){return null===this.body?null:n5(this.body)||o5(this.body)||a5(this.body)||function Fhe(r){return typeof URLSearchParams<"u"&&r instanceof URLSearchParams}(this.body)||"string"==typeof this.body?this.body:this.body instanceof Tc?this.body.toString():"object"==typeof this.body||"boolean"==typeof this.body||Array.isArray(this.body)?JSON.stringify(this.body):this.body.toString()}detectContentTypeHeader(){return null===this.body||a5(this.body)?null:o5(this.body)?this.body.type||null:n5(this.body)?null:"string"==typeof this.body?"text/plain":this.body instanceof Tc?"application/x-www-form-urlencoded;charset=UTF-8":"object"==typeof this.body||"number"==typeof this.body||"boolean"==typeof this.body?"application/json":null}clone(e={}){const t=e.method||this.method,i=e.url||this.url,s=e.responseType||this.responseType,n=void 0!==e.body?e.body:this.body,o=void 0!==e.withCredentials?e.withCredentials:this.withCredentials,a=void 0!==e.reportProgress?e.reportProgress:this.reportProgress;let l=e.headers||this.headers,c=e.params||this.params;const h=e.context??this.context;return void 0!==e.setHeaders&&(l=Object.keys(e.setHeaders).reduce((u,d)=>u.set(d,e.setHeaders[d]),l)),e.setParams&&(c=Object.keys(e.setParams).reduce((u,d)=>u.set(d,e.setParams[d]),c)),new x_(t,i,n,{params:c,headers:l,context:h,reportProgress:a,responseType:s,withCredentials:o})}}var $s=(()=>(($s=$s||{})[$s.Sent=0]="Sent",$s[$s.UploadProgress=1]="UploadProgress",$s[$s.ResponseHeader=2]="ResponseHeader",$s[$s.DownloadProgress=3]="DownloadProgress",$s[$s.Response=4]="Response",$s[$s.User=5]="User",$s))();class rA{constructor(e,t=200,i="OK"){this.headers=e.headers||new Cl,this.status=void 0!==e.status?e.status:t,this.statusText=e.statusText||i,this.url=e.url||null,this.ok=this.status>=200&&this.status<300}}class nA extends rA{constructor(e={}){super(e),this.type=$s.ResponseHeader}clone(e={}){return new nA({headers:e.headers||this.headers,status:void 0!==e.status?e.status:this.status,statusText:e.statusText||this.statusText,url:e.url||this.url||void 0})}}class Nb extends rA{constructor(e={}){super(e),this.type=$s.Response,this.body=void 0!==e.body?e.body:null}clone(e={}){return new Nb({body:void 0!==e.body?e.body:this.body,headers:e.headers||this.headers,status:void 0!==e.status?e.status:this.status,statusText:e.statusText||this.statusText,url:e.url||this.url||void 0})}}class l5 extends rA{constructor(e){super(e,0,"Unknown Error"),this.name="HttpErrorResponse",this.ok=!1,this.message=this.status>=200&&this.status<300?`Http failure during parsing for ${e.url||"(unknown url)"}`:`Http failure response for ${e.url||"(unknown url)"}: ${e.status} ${e.statusText}`,this.error=e.error||null}}function oA(r,e){return{body:e,headers:r.headers,context:r.context,observe:r.observe,params:r.params,reportProgress:r.reportProgress,responseType:r.responseType,withCredentials:r.withCredentials}}let Lhe=(()=>{class r{constructor(t){this.handler=t}request(t,i,s={}){let n;if(t instanceof x_)n=t;else{let l,c;l=s.headers instanceof Cl?s.headers:new Cl(s.headers),s.params&&(c=s.params instanceof Tc?s.params:new Tc({fromObject:s.params})),n=new x_(t,i,void 0!==s.body?s.body:null,{headers:l,context:s.context,params:c,reportProgress:s.reportProgress,responseType:s.responseType||"json",withCredentials:s.withCredentials})}const o=dt(n).pipe(Ul(l=>this.handler.handle(l)));if(t instanceof x_||"events"===s.observe)return o;const a=o.pipe(Xa(l=>l instanceof Nb));switch(s.observe||"body"){case"body":switch(n.responseType){case"arraybuffer":return a.pipe(Wt(l=>{if(null!==l.body&&!(l.body instanceof ArrayBuffer))throw new Error("Response is not an ArrayBuffer.");return l.body}));case"blob":return a.pipe(Wt(l=>{if(null!==l.body&&!(l.body instanceof Blob))throw new Error("Response is not a Blob.");return l.body}));case"text":return a.pipe(Wt(l=>{if(null!==l.body&&"string"!=typeof l.body)throw new Error("Response is not a string.");return l.body}));default:return a.pipe(Wt(l=>l.body))}case"response":return a;default:throw new Error(`Unreachable: unhandled observe type ${s.observe}}`)}}delete(t,i={}){return this.request("DELETE",t,i)}get(t,i={}){return this.request("GET",t,i)}head(t,i={}){return this.request("HEAD",t,i)}jsonp(t,i){return this.request("JSONP",t,{params:(new Tc).append(i,"JSONP_CALLBACK"),observe:"body",responseType:"json"})}options(t,i={}){return this.request("OPTIONS",t,i)}patch(t,i,s={}){return this.request("PATCH",t,oA(s,i))}post(t,i,s={}){return this.request("POST",t,oA(s,i))}put(t,i,s={}){return this.request("PUT",t,oA(s,i))}}return r.\u0275fac=function(t){return new(t||r)(tt(i5))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})();class c5{constructor(e,t){this.next=e,this.interceptor=t}handle(e){return this.interceptor.intercept(e,this.next)}}const h5=new nt("HTTP_INTERCEPTORS");let Bhe=(()=>{class r{intercept(t,i){return i.handle(t)}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})();const Vhe=/^\)\]\}',?\n/;let u5=(()=>{class r{constructor(t){this.xhrFactory=t}handle(t){if("JSONP"===t.method)throw new Error("Attempted to construct Jsonp request without HttpClientJsonpModule installed.");return new Rs(i=>{const s=this.xhrFactory.build();if(s.open(t.method,t.urlWithParams),t.withCredentials&&(s.withCredentials=!0),t.headers.forEach((f,p)=>s.setRequestHeader(f,p.join(","))),t.headers.has("Accept")||s.setRequestHeader("Accept","application/json, text/plain, */*"),!t.headers.has("Content-Type")){const f=t.detectContentTypeHeader();null!==f&&s.setRequestHeader("Content-Type",f)}if(t.responseType){const f=t.responseType.toLowerCase();s.responseType="json"!==f?f:"text"}const n=t.serializeBody();let o=null;const a=()=>{if(null!==o)return o;const f=s.statusText||"OK",p=new Cl(s.getAllResponseHeaders()),_=function Uhe(r){return"responseURL"in r&&r.responseURL?r.responseURL:/^X-Request-URL:/m.test(r.getAllResponseHeaders())?r.getResponseHeader("X-Request-URL"):null}(s)||t.url;return o=new nA({headers:p,status:s.status,statusText:f,url:_}),o},l=()=>{let{headers:f,status:p,statusText:_,url:m}=a(),g=null;204!==p&&(g=typeof s.response>"u"?s.responseText:s.response),0===p&&(p=g?200:0);let b=p>=200&&p<300;if("json"===t.responseType&&"string"==typeof g){const y=g;g=g.replace(Vhe,"");try{g=""!==g?JSON.parse(g):null}catch(T){g=y,b&&(b=!1,g={error:T,text:g})}}b?(i.next(new Nb({body:g,headers:f,status:p,statusText:_,url:m||void 0})),i.complete()):i.error(new l5({error:g,headers:f,status:p,statusText:_,url:m||void 0}))},c=f=>{const{url:p}=a(),_=new l5({error:f,status:s.status||0,statusText:s.statusText||"Unknown Error",url:p||void 0});i.error(_)};let h=!1;const u=f=>{h||(i.next(a()),h=!0);let p={type:$s.DownloadProgress,loaded:f.loaded};f.lengthComputable&&(p.total=f.total),"text"===t.responseType&&!!s.responseText&&(p.partialText=s.responseText),i.next(p)},d=f=>{let p={type:$s.UploadProgress,loaded:f.loaded};f.lengthComputable&&(p.total=f.total),i.next(p)};return s.addEventListener("load",l),s.addEventListener("error",c),s.addEventListener("timeout",c),s.addEventListener("abort",c),t.reportProgress&&(s.addEventListener("progress",u),null!==n&&s.upload&&s.upload.addEventListener("progress",d)),s.send(n),i.next({type:$s.Sent}),()=>{s.removeEventListener("error",c),s.removeEventListener("abort",c),s.removeEventListener("load",l),s.removeEventListener("timeout",c),t.reportProgress&&(s.removeEventListener("progress",u),null!==n&&s.upload&&s.upload.removeEventListener("progress",d)),s.readyState!==s.DONE&&s.abort()}})}}return r.\u0275fac=function(t){return new(t||r)(tt(Xw))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})();const aA=new nt("XSRF_COOKIE_NAME"),lA=new nt("XSRF_HEADER_NAME");class d5{}let khe=(()=>{class r{constructor(t,i,s){this.doc=t,this.platform=i,this.cookieName=s,this.lastCookieString="",this.lastToken=null,this.parseCount=0}getToken(){if("server"===this.platform)return null;const t=this.doc.cookie||"";return t!==this.lastCookieString&&(this.parseCount++,this.lastToken=Lw(t,this.cookieName),this.lastCookieString=t),this.lastToken}}return r.\u0275fac=function(t){return new(t||r)(tt(Xr),tt(vT),tt(aA))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})(),cA=(()=>{class r{constructor(t,i){this.tokenService=t,this.headerName=i}intercept(t,i){const s=t.url.toLowerCase();if("GET"===t.method||"HEAD"===t.method||s.startsWith("http://")||s.startsWith("https://"))return i.handle(t);const n=this.tokenService.getToken();return null!==n&&!t.headers.has(this.headerName)&&(t=t.clone({headers:t.headers.set(this.headerName,n)})),i.handle(t)}}return r.\u0275fac=function(t){return new(t||r)(tt(d5),tt(lA))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})(),Ghe=(()=>{class r{constructor(t,i){this.backend=t,this.injector=i,this.chain=null}handle(t){if(null===this.chain){const i=this.injector.get(h5,[]);this.chain=i.reduceRight((s,n)=>new c5(s,n),this.backend)}return this.chain.handle(t)}}return r.\u0275fac=function(t){return new(t||r)(tt(s5),tt(Fn))},r.\u0275prov=Tt({token:r,factory:r.\u0275fac}),r})(),zhe=(()=>{class r{static disable(){return{ngModule:r,providers:[{provide:cA,useClass:Bhe}]}}static withOptions(t={}){return{ngModule:r,providers:[t.cookieName?{provide:aA,useValue:t.cookieName}:[],t.headerName?{provide:lA,useValue:t.headerName}:[]]}}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=io({type:r}),r.\u0275inj=Rn({providers:[cA,{provide:h5,useExisting:cA,multi:!0},{provide:d5,useClass:khe},{provide:aA,useValue:"XSRF-TOKEN"},{provide:lA,useValue:"X-XSRF-TOKEN"}]}),r})(),Hhe=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=io({type:r}),r.\u0275inj=Rn({providers:[Lhe,{provide:i5,useClass:Ghe},u5,{provide:s5,useExisting:u5}],imports:[zhe.withOptions({cookieName:"XSRF-TOKEN",headerName:"X-XSRF-TOKEN"})]}),r})(),Whe=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=io({type:r,bootstrap:[Vee]}),r.\u0275inj=Rn({providers:[Ag],imports:[Z9,Ihe,Hhe,Ute]}),r})();(function hQ(){uw=!1})(),Q9().bootstrapModule(Whe).catch(r=>console.error(r))}},Fi=>{Fi(Fi.s=263)}]);